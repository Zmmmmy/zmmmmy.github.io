<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>MCP工具列表获取机制</title>
    <link href="/2026/01/22/MCP%E5%B7%A5%E5%85%B7%E5%88%97%E8%A1%A8%E8%8E%B7%E5%8F%96%E6%9C%BA%E5%88%B6/"/>
    <url>/2026/01/22/MCP%E5%B7%A5%E5%85%B7%E5%88%97%E8%A1%A8%E8%8E%B7%E5%8F%96%E6%9C%BA%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="MCP-工具列表获取机制"><a href="#MCP-工具列表获取机制" class="headerlink" title="MCP 工具列表获取机制"></a>MCP 工具列表获取机制</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>MCP（Model Context Protocol，模型上下文协议）是一个开放协议，标准化了应用程序如何向大语言模型（LLM）提供上下文，使 AI 应用能够以一致的方式连接各种数据源和工具。</p><p>本文重点讲解 <strong>MCP 工具列表是如何获取的，以及获取的时机</strong>。</p><h2 id="MCP-协议生命周期"><a href="#MCP-协议生命周期" class="headerlink" title="MCP 协议生命周期"></a>MCP 协议生命周期</h2><p>MCP 定义了客户端-服务器交互的 <strong>三阶段生命周期</strong>：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs autoit">┌─────────────┐    ┌─────────────┐    ┌─────────────┐<br>│ Initialization │ → │  Operation  │ → │  <span class="hljs-built_in">Shutdown</span>   │<br>│   初始化阶段    │    │   操作阶段   │    │   关闭阶段   │<br>└─────────────┘    └─────────────┘    └─────────────┘<br></code></pre></td></tr></table></figure><h2 id="初始化阶段详解"><a href="#初始化阶段详解" class="headerlink" title="初始化阶段详解"></a>初始化阶段详解</h2><h3 id="1-建立底层连接"><a href="#1-建立底层连接" class="headerlink" title="1. 建立底层连接"></a>1. 建立底层连接</h3><p>首先建立传输层连接，MCP 支持两种传输方式：</p><table><thead><tr><th>传输类型</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><strong>StdIO</strong></td><td>CLI 工具、本地进程</td><td>通过标准输入&#x2F;输出通信</td></tr><tr><td><strong>HTTP</strong></td><td>远程访问、Web 服务</td><td>支持网络访问</td></tr></tbody></table><h3 id="2-协议版本协商"><a href="#2-协议版本协商" class="headerlink" title="2. 协议版本协商"></a>2. 协议版本协商</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 客户端发送 initialize 请求</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;initialize&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;params&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;protocolVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-06-18&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;clientInfo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Claude Code&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;capabilities&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;sampling&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;roots&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;listChanged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>⚠️ 重要: 版本协商规则</strong></p><ul><li>客户端发送它支持的协议版本（通常是最新版本）</li><li>如果服务器支持该版本，则响应相同版本</li><li>双方必须就单一版本达成一致才能继续会话</li></ul></blockquote><h3 id="3-能力协商（Capability-Negotiation）"><a href="#3-能力协商（Capability-Negotiation）" class="headerlink" title="3. 能力协商（Capability Negotiation）"></a>3. 能力协商（Capability Negotiation）</h3><p>这是 MCP 协议的<strong>核心特性</strong>，实现了协议的前向兼容。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 服务器响应，声明自己的能力</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;protocolVersion&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2025-06-18&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;serverInfo&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Azure MCP Server&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;capabilities&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;tools&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;listChanged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;resources&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;subscribe&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;listChanged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;prompts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;listChanged&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;logging&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>能力类型说明</strong>：</p><table><thead><tr><th>能力</th><th>含义</th></tr></thead><tbody><tr><td><code>tools</code></td><td>服务器提供可调用的工具</td></tr><tr><td><code>resources</code></td><td>服务器提供可读取的资源</td></tr><tr><td><code>prompts</code></td><td>服务器提供预定义的提示模板</td></tr><tr><td><code>logging</code></td><td>支持日志功能</td></tr><tr><td><code>listChanged</code></td><td>支持列表变更通知</td></tr></tbody></table><h3 id="4-发送-initialized-通知"><a href="#4-发送-initialized-通知" class="headerlink" title="4. 发送 initialized 通知"></a>4. 发送 initialized 通知</h3><p>客户端收到服务器响应后，发送 <code>initialized</code> 通知，<strong>标志初始化阶段完成</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;notifications/initialized&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="工具列表获取时机"><a href="#工具列表获取时机" class="headerlink" title="工具列表获取时机"></a>工具列表获取时机</h2><blockquote><p><strong>⚠️ 警告: 关键点</strong><br><strong>工具列表只能在初始化完成后获取！</strong> 在握手完成之前，不允许发送 <code>tools/list</code> 等功能性请求。</p></blockquote><h3 id="完整的时序图"><a href="#完整的时序图" class="headerlink" title="完整的时序图"></a>完整的时序图</h3><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs vbscript">Client                                <span class="hljs-built_in">Server</span><br>   │                                     │<br>   │  ──────── 建立连接 ────────&gt;        │<br>   │                                     │<br>   │  ──── initialize <span class="hljs-built_in">request</span> ────&gt;      │  ① 发送初始化请求<br>   │                                     │     (协议版本 + 客户端能力)<br>   │                                     │<br>   │  &lt;─── initialize <span class="hljs-built_in">response</span> ────      │  ② 返回服务器能力<br>   │                                     │     (包含 tools 能力声明)<br>   │                                     │<br>   │  ─── initialized notification ─&gt;    │  ③ 确认初始化完成<br>   │                                     │<br>   │  ════════ 会话就绪 ════════         │<br>   │                                     │<br>   │  ──── tools/list <span class="hljs-built_in">request</span> ────&gt;      │  ④ 请求工具列表<br>   │                                     │<br>   │  &lt;──── tools/list <span class="hljs-built_in">response</span> ────     │  ⑤ 返回工具定义<br>   │                                     │<br></code></pre></td></tr></table></figure><h3 id="tools-list-请求与响应"><a href="#tools-list-请求与响应" class="headerlink" title="tools&#x2F;list 请求与响应"></a>tools&#x2F;list 请求与响应</h3><p><strong>请求</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;tools/list&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>响应</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;result&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;tools&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;storage_blob_get&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;获取 Azure Blob 存储内容&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;inputSchema&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;object&quot;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;account&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;container&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;string&quot;</span> <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>          <span class="hljs-attr">&quot;required&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;account&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;container&quot;</span><span class="hljs-punctuation">]</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="工具列表动态更新"><a href="#工具列表动态更新" class="headerlink" title="工具列表动态更新"></a>工具列表动态更新</h2><p>如果服务器声明了 <code>tools: { listChanged: true }</code>，则支持<strong>工具列表变更通知</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// 服务器主动推送通知</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;jsonrpc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;method&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;notifications/tools/list_changed&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>客户端收到此通知后，应重新调用 <code>tools/list</code> 获取最新的工具列表。</p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="C-实现（Azure-MCP）"><a href="#C-实现（Azure-MCP）" class="headerlink" title="C# 实现（Azure MCP）"></a>C# 实现（Azure MCP）</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">// MCP 运行时接口定义</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">IMcpRuntime</span> : <span class="hljs-title">IAsyncDisposable</span><br>&#123;<br>    <span class="hljs-comment">// 列出所有可用工具</span><br>    <span class="hljs-function">ValueTask&lt;ListToolsResult&gt; <span class="hljs-title">ListToolsHandler</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        RequestContext&lt;ListToolsRequestParams&gt; request,</span></span><br><span class="hljs-params"><span class="hljs-function">        CancellationToken cancellationToken</span></span><br><span class="hljs-params"><span class="hljs-function">    </span>)</span>;<br><br>    <span class="hljs-comment">// 调用指定工具</span><br>    <span class="hljs-function">ValueTask&lt;CallToolResult&gt; <span class="hljs-title">CallToolHandler</span>(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">        RequestContext&lt;CallToolRequestParams&gt; request,</span></span><br><span class="hljs-params"><span class="hljs-function">        CancellationToken cancellationToken</span></span><br><span class="hljs-params"><span class="hljs-function">    </span>)</span>;<br>&#125;<br><br><span class="hljs-comment">// 获取工具列表示例</span><br><span class="hljs-keyword">var</span> listToolsResult = <span class="hljs-keyword">await</span> mcpRuntime.ListToolsHandler(request, cancellationToken);<br><span class="hljs-comment">// 返回: 工具定义列表，包含名称、描述、参数</span><br></code></pre></td></tr></table></figure><h3 id="服务器启动模式"><a href="#服务器启动模式" class="headerlink" title="服务器启动模式"></a>服务器启动模式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 命名空间代理模式（默认）</span><br>azmcp server start --mode namespace --namespaces storage,keyvault<br><br><span class="hljs-comment"># 暴露所有工具</span><br>azmcp server start --mode all<br><br><span class="hljs-comment"># 单工具代理模式</span><br>azmcp server start --mode single --namespace storage<br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th>阶段</th><th>操作</th><th>说明</th></tr></thead><tbody><tr><td>连接建立</td><td>建立传输层</td><td>StdIO 或 HTTP</td></tr><tr><td>初始化</td><td><code>initialize</code> 请求</td><td>版本协商 + 能力声明</td></tr><tr><td>确认</td><td><code>initialized</code> 通知</td><td>握手完成</td></tr><tr><td><strong>工具发现</strong></td><td><code>tools/list</code> 请求</td><td><strong>此时才能获取工具列表</strong></td></tr><tr><td>运行时</td><td>工具调用 + 变更监听</td><td>支持动态更新</td></tr></tbody></table><blockquote><p><strong>💡 提示: 记忆口诀</strong><br><strong>先握手，后取工具；能力先谈，功能后用</strong></p></blockquote><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Claude Code Skills 详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>编程工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI工具</tag>
      
      <tag>MCP</tag>
      
      <tag>协议</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基础概念</title>
    <link href="/2026/01/21/%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/"/>
    <url>/2026/01/21/%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/</url>
    
    <content type="html"><![CDATA[<h1 id="WebRTC-基础概念"><a href="#WebRTC-基础概念" class="headerlink" title="WebRTC 基础概念"></a>WebRTC 基础概念</h1><h2 id="什么是-WebRTC？"><a href="#什么是-WebRTC？" class="headerlink" title="什么是 WebRTC？"></a>什么是 WebRTC？</h2><p><strong>WebRTC（Web Real-Time Communication）</strong> 是一项开源技术，允许 Web 浏览器和移动应用进行<strong>实时通信</strong>，无需中介服务器或插件。</p><h3 id="核心定义"><a href="#核心定义" class="headerlink" title="核心定义"></a>核心定义</h3><ul><li><strong>Web</strong> - 在浏览器中运行，基于 JavaScript API</li><li><strong>Real-Time</strong> - 低延迟通信（通常在毫秒级）</li><li><strong>Communication</strong> - 支持音频、视频和任意数据传输</li></ul><h2 id="为什么需要-WebRTC？"><a href="#为什么需要-WebRTC？" class="headerlink" title="为什么需要 WebRTC？"></a>为什么需要 WebRTC？</h2><h3 id="传统方案的问题"><a href="#传统方案的问题" class="headerlink" title="传统方案的问题"></a>传统方案的问题</h3><table><thead><tr><th>问题</th><th>影响</th></tr></thead><tbody><tr><td>浏览器无法直接访问摄像头&#x2F;麦克风</td><td>需要第三方插件（Flash、ActiveX等）</td></tr><tr><td>跨域通信困难</td><td>必须通过服务器中转</td></tr><tr><td>服务器中转</td><td>增加延迟、增加成本、难以扩展</td></tr><tr><td>信息安全</td><td>所有数据都经过服务器</td></tr></tbody></table><h3 id="WebRTC-的优势"><a href="#WebRTC-的优势" class="headerlink" title="WebRTC 的优势"></a>WebRTC 的优势</h3><p>✅ <strong>原生浏览器 API</strong> - 无需插件，所有现代浏览器支持<br>✅ <strong>点对点直连</strong> - 降低延迟和服务器成本<br>✅ <strong>内置 NAT 穿透</strong> - 自动处理防火墙和内网问题<br>✅ <strong>端到端加密</strong> - 数据安全性高<br>✅ <strong>跨平台</strong> - Chrome、Firefox、Safari、Edge 等</p><h2 id="WebRTC-架构中的服务器角色"><a href="#WebRTC-架构中的服务器角色" class="headerlink" title="WebRTC 架构中的服务器角色"></a>WebRTC 架构中的服务器角色</h2><blockquote><p><strong>⚠️ 警告: 重要澄清</strong><br>WebRTC <strong>不需要服务器转发媒体数据</strong>，但<strong>仍然需要服务器处理信令和控制</strong></p></blockquote><h3 id="架构对比"><a href="#架构对比" class="headerlink" title="架构对比"></a>架构对比</h3><p><strong>传统项目（如 Java 后端视频服务）</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">浏览器<span class="hljs-selector-tag">A</span> → 服务器 ← 浏览器<span class="hljs-selector-tag">B</span><br>          ↓<br>    所有数据都转发<br>  (音频、视频、控制都经过服务器)<br>   成本高，延迟大，扩展性差<br></code></pre></td></tr></table></figure><p><strong>WebRTC 项目</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs css">浏览器<span class="hljs-selector-tag">A</span> ←→ 信令服务器 ←→ 浏览器<span class="hljs-selector-tag">B</span><br>  ↓                          ↓<br>  └──────────直连通道──────────┘<br>       (仅媒体数据点对点)<br>    成本低，延迟小，扩展性好<br></code></pre></td></tr></table></figure><h3 id="服务器需要处理的内容"><a href="#服务器需要处理的内容" class="headerlink" title="服务器需要处理的内容"></a>服务器需要处理的内容</h3><table><thead><tr><th>内容</th><th>是否需要服务器</th><th>说明</th></tr></thead><tbody><tr><td><strong>音视频数据</strong></td><td>❌ 不需要</td><td>直接点对点传输</td></tr><tr><td><strong>Offer&#x2F;Answer</strong></td><td>✅ 需要</td><td>连接协商信息需要中介转发</td></tr><tr><td><strong>ICE 候选</strong></td><td>✅ 需要</td><td>网络地址信息需要交换</td></tr><tr><td><strong>用户认证</strong></td><td>✅ 需要</td><td>验证用户身份</td></tr><tr><td><strong>在线状态</strong></td><td>✅ 需要</td><td>维护用户列表、房间状态</td></tr><tr><td><strong>权限控制</strong></td><td>✅ 需要</td><td>谁可以和谁通话</td></tr><tr><td><strong>日志记录</strong></td><td>✅ 需要</td><td>通话记录、问题诊断</td></tr><tr><td><strong>录制&#x2F;转码</strong></td><td>⚠️ 可选</td><td>需要时才接收并处理媒体</td></tr></tbody></table><h3 id="完整的-WebRTC-项目架构"><a href="#完整的-WebRTC-项目架构" class="headerlink" title="完整的 WebRTC 项目架构"></a>完整的 WebRTC 项目架构</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs awk">┌──────────────────────────────────┐<br>│ 前端应用（浏览器）               │<br>│ - HTML<span class="hljs-regexp">/CSS/</span>JavaScript            │<br>│ - WebRTC API 调用                │<br>│ - 用户界面                       │<br>└──────────────────────────────────┘<br>         ↕ WebSocket/HTTP<br>┌──────────────────────────────────────────────────────┐<br>│ 后端服务器（Java<span class="hljs-regexp">/Node.js/</span>Go/Python等）               │<br>│                                                     │<br>│ 核心模块：                                          │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">1</span>. 用户管理                            │         │<br>│ │    - 用户注册、登录、认证              │         │<br>│ │    - 在线状态维护                      │         │<br>│ │    - 好友列表管理                      │         │<br>│ └────────────────────────────────────────┘         │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">2</span>. 信令控制                            │         │<br>│ │    - Offer/Answer 转发                 │         │<br>│ │    - ICE 候选交换                      │         │<br>│ │    - 连接状态管理                      │         │<br>│ └────────────────────────────────────────┘         │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">3</span>. 房间/会议管理                       │         │<br>│ │    - 创建<span class="hljs-regexp">/加入/</span>离开房间                │         │<br>│ │    - 参与者管理                        │         │<br>│ │    - 权限控制（谁能说话、共享等）      │         │<br>│ └────────────────────────────────────────┘         │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">4</span>. 业务逻辑                            │         │<br>│ │    - 计费/统计                         │         │<br>│ │    - 内容审核                          │         │<br>│ │    - 异常处理、心跳检测                │         │<br>│ └────────────────────────────────────────┘         │<br>│                                                     │<br>│ 可选模块：                                          │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">5</span>. 媒体处理                            │         │<br>│ │    - 录制媒体流                        │         │<br>│ │    - 转码处理                          │         │<br>│ │    - AI 分析（人脸识别等）             │         │<br>│ └────────────────────────────────────────┘         │<br>│ ┌────────────────────────────────────────┐         │<br>│ │ <span class="hljs-number">6</span>. NAT 穿透辅助                        │         │<br>│ │    - STUN 服务器                       │         │<br>│ │    - TURN 中继服务器                   │         │<br>│ └────────────────────────────────────────┘         │<br>└──────────────────────────────────────────────────────┘<br>         ↕ 仅在 NAT 穿透失败时<br>┌──────────────────────────────────┐<br>│ TURN 中继服务器（可选）          │<br>│ - 当直连失败时中继媒体数据       │<br>│ - 带宽成本较高                   │<br>└──────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="实际代码示例"><a href="#实际代码示例" class="headerlink" title="实际代码示例"></a>实际代码示例</h3><p><strong>前端：发送 Offer（需要经过服务器）</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 用户 A 创建 Offer</span><br><span class="hljs-keyword">const</span> offer = <span class="hljs-keyword">await</span> peerConnection.<span class="hljs-title function_">createOffer</span>();<br><span class="hljs-keyword">await</span> peerConnection.<span class="hljs-title function_">setLocalDescription</span>(offer);<br><br><span class="hljs-comment">// ❌ 错误：不能直接发送</span><br><span class="hljs-comment">// webSocket.send(offer);  // 对端接收不到！</span><br><br><span class="hljs-comment">// ✅ 正确：通过服务器转发</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/signaling/send-offer&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">headers</span>: &#123; <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> &#125;,<br>  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<br>    <span class="hljs-attr">targetUserId</span>: <span class="hljs-string">&#x27;user-b&#x27;</span>,<br>    <span class="hljs-attr">offer</span>: offer<br>  &#125;)<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>后端：处理 Offer（Java 示例）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/api/signaling/send-offer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendOffer</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SignalingRequest req)</span> &#123;<br>    <span class="hljs-comment">// 1️⃣ 认证用户</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">sender</span> <span class="hljs-operator">=</span> authService.getCurrentUser();<br>    <span class="hljs-keyword">if</span> (sender == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">&quot;未登录&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 2️⃣ 验证目标用户存在且在线</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">receiver</span> <span class="hljs-operator">=</span> userService.findById(req.getTargetUserId());<br>    <span class="hljs-keyword">if</span> (receiver == <span class="hljs-literal">null</span> || !receiver.isOnline()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BadRequestException</span>(<span class="hljs-string">&quot;用户不存在或离线&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 3️⃣ 检查权限（是否被屏蔽等）</span><br>    <span class="hljs-keyword">if</span> (blockService.isBlocked(sender.getId(), receiver.getId())) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForbiddenException</span>(<span class="hljs-string">&quot;该用户已将你屏蔽&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 4️⃣ 转发 Offer 给对方（通过 WebSocket）</span><br>    <span class="hljs-type">WebSocketMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketMessage</span>()<br>        .setType(<span class="hljs-string">&quot;offer-received&quot;</span>)<br>        .setFrom(sender.getId())<br>        .setData(req.getOffer());<br><br>    webSocketService.sendToUser(receiver.getId(), msg);<br><br>    <span class="hljs-comment">// 5️⃣ 记录日志</span><br>    loggingService.log(<span class="hljs-string">&quot;User &quot;</span> + sender.getId()<br>        + <span class="hljs-string">&quot; sent offer to &quot;</span> + receiver.getId());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>后端：接收 Answer 并转发</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/api/signaling/send-answer&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendAnswer</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SignalingRequest req)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">sender</span> <span class="hljs-operator">=</span> authService.getCurrentUser();<br><br>    <span class="hljs-comment">// 转发 Answer</span><br>    <span class="hljs-type">WebSocketMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketMessage</span>()<br>        .setType(<span class="hljs-string">&quot;answer-received&quot;</span>)<br>        .setFrom(sender.getId())<br>        .setData(req.getAnswer());<br><br>    webSocketService.sendToUser(req.getTargetUserId(), msg);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>前端：接收 Answer 并建立连接</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 监听来自服务器的 Answer</span><br>webSocket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> msg = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);<br><br>    <span class="hljs-keyword">if</span> (msg.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;answer-received&#x27;</span>) &#123;<br>        <span class="hljs-comment">// 收到对方的 Answer</span><br>        <span class="hljs-keyword">const</span> remoteDescription = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RTCSessionDescription</span>(msg.<span class="hljs-property">data</span>);<br>        <span class="hljs-keyword">await</span> peerConnection.<span class="hljs-title function_">setRemoteDescription</span>(remoteDescription);<br><br>        <span class="hljs-comment">// 此时媒体通道开始建立</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Answer received, connection negotiating...&#x27;</span>);<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="成本对比"><a href="#成本对比" class="headerlink" title="成本对比"></a>成本对比</h3><p><strong>传统流媒体（服务器转发所有数据）</strong></p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs excel">参与人数    服务器带宽消耗<br><span class="hljs-number">1</span> 对 <span class="hljs-number">1</span>     <span class="hljs-number">1</span>x 基准<br><span class="hljs-number">1</span> 对 <span class="hljs-built_in">N</span>     (<span class="hljs-built_in">N</span>-<span class="hljs-number">1</span>)x 基准 × 通话人数<br>           成本呈指数增长<br></code></pre></td></tr></table></figure><p><strong>WebRTC（只转发信令）</strong></p><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gml">参与人数    服务器带宽消耗<br><span class="hljs-number">1</span> 对 <span class="hljs-number">1</span>     <span class="hljs-number">0.1</span><span class="hljs-variable language_">x</span> 基准（只有信令）<br><span class="hljs-number">1</span> 对 N     <span class="hljs-number">0.1</span><span class="hljs-variable language_">x</span> 基准（几乎不增加）<br>           成本基本保持不变<br></code></pre></td></tr></table></figure><h3 id="关键结论"><a href="#关键结论" class="headerlink" title="关键结论"></a>关键结论</h3><p>✅ WebRTC <strong>大幅降低</strong>了服务器的<strong>数据处理负担</strong><br>❌ WebRTC <strong>不能消除</strong>对服务器的<strong>需求</strong><br>⚠️ 服务器角色从”<strong>媒体中转者</strong>“变为”<strong>控制协调者</strong>“</p><h2 id="主要应用场景"><a href="#主要应用场景" class="headerlink" title="主要应用场景"></a>主要应用场景</h2><table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td>📹 <strong>视频会议</strong></td><td>Zoom、Google Meet、Teams</td></tr><tr><td>💬 <strong>实时通讯</strong></td><td>语音通话、文字聊天</td></tr><tr><td>🎮 <strong>多人游戏</strong></td><td>低延迟的实时交互</td></tr><tr><td>📺 <strong>直播</strong></td><td>低延迟的媒体流传输</td></tr><tr><td>🔄 <strong>文件共享</strong></td><td>点对点文件传输</td></tr><tr><td>📊 <strong>屏幕共享</strong></td><td>协作工具中的屏幕演示</td></tr><tr><td>🤖 <strong>IoT 通信</strong></td><td>设备间的实时数据交互</td></tr></tbody></table><h2 id="WebRTC-的三大技术支柱"><a href="#WebRTC-的三大技术支柱" class="headerlink" title="WebRTC 的三大技术支柱"></a>WebRTC 的三大技术支柱</h2><h3 id="1-MediaStream-获取媒体"><a href="#1-MediaStream-获取媒体" class="headerlink" title="1. MediaStream - 获取媒体"></a>1. MediaStream - 获取媒体</h3><blockquote><p><strong>ℹ️ 信息: 作用</strong><br>获取本地摄像头、麦克风等设备的媒体流</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 获取摄像头和麦克风</span><br><span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">mediaDevices</span>.<span class="hljs-title function_">getUserMedia</span>(&#123;<br>  <span class="hljs-attr">audio</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">video</span>: <span class="hljs-literal">true</span><br>&#125;);<br><br><span class="hljs-comment">// 在视频元素中展示</span><br>videoElement.<span class="hljs-property">srcObject</span> = stream;<br></code></pre></td></tr></table></figure><h3 id="2-RTCPeerConnection-建立连接"><a href="#2-RTCPeerConnection-建立连接" class="headerlink" title="2. RTCPeerConnection - 建立连接"></a>2. RTCPeerConnection - 建立连接</h3><blockquote><p><strong>ℹ️ 信息: 作用</strong><br>在两个浏览器间建立点对点的媒体连接</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 创建对等连接</span><br><span class="hljs-keyword">const</span> peerConnection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RTCPeerConnection</span>(&#123;<br>  <span class="hljs-attr">iceServers</span>: [&#123; <span class="hljs-attr">urls</span>: [<span class="hljs-string">&#x27;stun:stun.l.google.com:19302&#x27;</span>] &#125;]<br>&#125;);<br><br><span class="hljs-comment">// 添加媒体流</span><br>stream.<span class="hljs-title function_">getTracks</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">track</span> =&gt;</span> &#123;<br>  peerConnection.<span class="hljs-title function_">addTrack</span>(track, stream);<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="3-RTCDataChannel-传输数据"><a href="#3-RTCDataChannel-传输数据" class="headerlink" title="3. RTCDataChannel - 传输数据"></a>3. RTCDataChannel - 传输数据</h3><blockquote><p><strong>ℹ️ 信息: 作用</strong><br>建立数据通道，传输任意类型数据（不仅仅是媒体）</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 创建数据通道</span><br><span class="hljs-keyword">const</span> dataChannel = peerConnection.<span class="hljs-title function_">createDataChannel</span>(<span class="hljs-string">&#x27;chat&#x27;</span>);<br><br><span class="hljs-comment">// 发送数据</span><br>dataChannel.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Hello, WebRTC!&#x27;</span>);<br><br><span class="hljs-comment">// 接收数据</span><br>dataChannel.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received:&#x27;</span>, event.<span class="hljs-property">data</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="WebRTC-的工作流程"><a href="#WebRTC-的工作流程" class="headerlink" title="WebRTC 的工作流程"></a>WebRTC 的工作流程</h2><h3 id="简化流程图"><a href="#简化流程图" class="headerlink" title="简化流程图"></a>简化流程图</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">1</span>. 获取媒体流                                            │<br>│    ↓                                                    │<br>│    navigator<span class="hljs-selector-class">.mediaDevices</span><span class="hljs-selector-class">.getUserMedia</span>()               │<br>│    (获取摄像头/麦克风)                                   │<br>└─────────────────────────────────────────────────────────┘<br>                        ↓<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">2</span>. 创建对等连接                                          │<br>│    ↓                                                    │<br>│    new <span class="hljs-built_in">RTCPeerConnection</span>()                             │<br>│    (建立连接对象，配置 ICE 服务器)                      │<br>└─────────────────────────────────────────────────────────┘<br>                        ↓<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">3</span>. 交换会话信息（通过信令服务器）                        │<br>│    ↓                                                    │<br>│    Offer (主动方) ↔ Answer (被动方)                     │<br>│    (SDP 协议描述媒体能力)                                │<br>└─────────────────────────────────────────────────────────┘<br>                        ↓<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">4</span>. 交换 ICE 候选                                        │<br>│    ↓                                                    │<br>│    peerConnection<span class="hljs-selector-class">.onicecandidate</span>                       │<br>│    (发现网络地址，寻找可通路径)                          │<br>└─────────────────────────────────────────────────────────┘<br>                        ↓<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">5</span>. 建立直连通道                                          │<br>│    ↓                                                    │<br>│    连接状态: new → checking → connected → completed    │<br>│    (使用 RTP/SRTP 传输媒体)                            │<br>└─────────────────────────────────────────────────────────┘<br>                        ↓<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-number">6</span>. 实时数据流动                                          │<br>│    ↓                                                    │<br>│    音频/视频/数据 → 对端浏览器                          │<br>└─────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="详细步骤说明"><a href="#详细步骤说明" class="headerlink" title="详细步骤说明"></a>详细步骤说明</h3><ol><li><strong>媒体采集</strong> - 获取本地摄像头和麦克风</li><li><strong>连接创建</strong> - 实例化 RTCPeerConnection</li><li><strong>能力协商</strong> - 主动方生成 Offer，被动方生成 Answer（描述支持的编码格式等）</li><li><strong>地址发现</strong> - ICE 收集所有可用的网络地址组合</li><li><strong>连接建立</strong> - 双方尝试可用地址，建立最优路径</li><li><strong>数据传输</strong> - 通过直连通道实时传输媒体</li></ol><h2 id="核心概念解释"><a href="#核心概念解释" class="headerlink" title="核心概念解释"></a>核心概念解释</h2><h3 id="SDP（会话描述协议）"><a href="#SDP（会话描述协议）" class="headerlink" title="SDP（会话描述协议）"></a>SDP（会话描述协议）</h3><blockquote><p><strong>📝 注意: 定义</strong><br>SDP 是描述多媒体会话的协议，用于双方交换媒体能力信息</p></blockquote><p><strong>包含信息</strong>：</p><ul><li>支持的媒体类型（音频、视频）</li><li>支持的编码格式（H.264、VP8 等）</li><li>支持的码率、分辨率等参数</li><li>网络传输信息（端口、协议等）</li></ul><p><strong>示例</strong>：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">v</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">o</span>=alice <span class="hljs-number">2890844526</span> <span class="hljs-number">2890844527</span> IN IP4 host.atlanta.com<br><span class="hljs-attr">s</span>=Session SDP<br><span class="hljs-attr">c</span>=IN IP4 host.atlanta.com<br><span class="hljs-attr">t</span>=<span class="hljs-number">0</span> <span class="hljs-number">0</span><br><span class="hljs-attr">m</span>=audio <span class="hljs-number">49172</span> RTP/AVP <span class="hljs-number">0</span><br><span class="hljs-attr">a</span>=rtpmap:<span class="hljs-number">0</span> PCMU/<span class="hljs-number">8000</span><br><span class="hljs-attr">m</span>=video <span class="hljs-number">49170</span> RTP/AVP <span class="hljs-number">31</span><br><span class="hljs-attr">a</span>=rtpmap:<span class="hljs-number">31</span> H261/<span class="hljs-number">90000</span><br></code></pre></td></tr></table></figure><h3 id="ICE（交互式连接建立）"><a href="#ICE（交互式连接建立）" class="headerlink" title="ICE（交互式连接建立）"></a>ICE（交互式连接建立）</h3><blockquote><p><strong>📝 注意: 定义</strong><br>ICE 是一种协议技术，用于发现通信双方之间可用的网络路径</p></blockquote><p><strong>解决的问题</strong>：</p><ul><li>浏览器位于 NAT&#x2F;防火墙后</li><li>无法直接被外网访问</li><li>需要找到能互通的地址组合</li></ul><p><strong>工作方式</strong>：</p><ol><li>收集所有可能的候选地址（本地 IP、公网 IP 等）</li><li>通过 STUN&#x2F;TURN 服务器辅助地址发现</li><li>双方交换候选地址</li><li>尝试建立连接</li><li>使用第一条成功的路径</li></ol><h3 id="NAT-穿透"><a href="#NAT-穿透" class="headerlink" title="NAT 穿透"></a>NAT 穿透</h3><blockquote><p><strong>example: 示例场景</strong></p><p><strong>问题</strong>：局域网内的设备想与互联网上的设备通信</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dns">内网设备 <span class="hljs-number">192.168.1.100</span> → NAT 设备 → 互联网<br>        ↑<br>   无法被外界直接访问<br></code></pre></td></tr></table></figure><p><strong>解决方案</strong>：</p><ul><li><strong>STUN</strong> - 帮助设备发现自己的公网 IP</li><li><strong>TURN</strong> - 当直连失败时，作为中继服务器转发数据</li></ul></blockquote><h2 id="传输协议栈"><a href="#传输协议栈" class="headerlink" title="传输协议栈"></a>传输协议栈</h2><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs isbl">┌────────────────────────────────────────┐<br>│ 应用层 - <span class="hljs-variable">JavaScript</span> <span class="hljs-variable">WebRTC</span> <span class="hljs-variable">API</span>          │<br>├────────────────────────────────────────┤<br>│ 编码层 - <span class="hljs-variable">VP8</span>/<span class="hljs-variable">VP9</span>/<span class="hljs-function"><span class="hljs-title">H264</span>(视频)            │</span><br><span class="hljs-function">│        - <span class="hljs-variable">Opus</span>/<span class="hljs-title">PCM</span>(音频)               │</span><br><span class="hljs-function">├────────────────────────────────────────┤</span><br><span class="hljs-function">│ 传输层 - <span class="hljs-title">RTP</span>(媒体数据)                  │</span><br><span class="hljs-function">│        - <span class="hljs-title">SRTP</span>(加密媒体)                │</span><br><span class="hljs-function">│        - <span class="hljs-title">SCTP</span>(数据通道)                │</span><br><span class="hljs-function">├────────────────────────────────────────┤</span><br><span class="hljs-function">│ 安全层 - <span class="hljs-title">DTLS</span>(加密握手)                 │</span><br><span class="hljs-function">│        - <span class="hljs-title">SRTP</span>(媒体加密)                │</span><br><span class="hljs-function">├────────────────────────────────────────┤</span><br><span class="hljs-function">│ 网络层 - <span class="hljs-title">UDP</span>(不可靠但低延迟)            │</span><br><span class="hljs-function">├────────────────────────────────────────┤</span><br><span class="hljs-function">│ 物理层 - 网络传输                       │</span><br><span class="hljs-function">└────────────────────────────────────────┘</span><br></code></pre></td></tr></table></figure><p><strong>关键特点</strong>：</p><ul><li>基于 <strong>UDP</strong>，而非 TCP（优先速度而非可靠性）</li><li>使用 <strong>SRTP</strong> 加密媒体数据</li><li>使用 <strong>DTLS</strong> 加密密钥交换</li><li>支持自适应比特率</li></ul><h2 id="关键优势总结"><a href="#关键优势总结" class="headerlink" title="关键优势总结"></a>关键优势总结</h2><table><thead><tr><th>方面</th><th>优势</th></tr></thead><tbody><tr><td><strong>延迟</strong></td><td>毫秒级，远低于服务器中转</td></tr><tr><td><strong>成本</strong></td><td>减少服务器带宽压力</td></tr><tr><td><strong>安全</strong></td><td>端到端加密，数据不过服务器</td></tr><tr><td><strong>可用性</strong></td><td>自动穿越 NAT 和防火墙</td></tr><tr><td><strong>标准化</strong></td><td>开放标准，所有浏览器统一实现</td></tr><tr><td><strong>易用性</strong></td><td>JavaScript API 简洁易用</td></tr></tbody></table><h2 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h2><p>⚠️ <strong>信令服务器仍需要</strong> - 虽然媒体点对点，但控制信息仍需服务器中转（通常用 WebSocket）<br>⚠️ <strong>TURN 服务器成本</strong> - NAT 穿透失败时需要 TURN 中继，产生额外成本<br>⚠️ <strong>浏览器兼容性</strong> - 某些旧浏览器不支持<br>⚠️ <strong>学习曲线</strong> - 概念众多（SDP、ICE、STUN&#x2F;TURN），初学者需要理解</p><h2 id="下一步学习"><a href="#下一步学习" class="headerlink" title="下一步学习"></a>下一步学习</h2><ul><li>MediaStream&#x2F;RTCPeerConnection&#x2F;RTCDataChannel API - 深入 API 使用</li><li>信令服务器实现 - 学习如何交换连接信息</li><li>ICE&#x2F;STUN&#x2F;TURN - 理解网络穿透原理</li><li>RTP&#x2F;SRTP&#x2F;媒体编码 - 了解媒体传输细节</li></ul>]]></content>
    
    
    <categories>
      
      <category>前端</category>
      
      <category>WebRTC</category>
      
    </categories>
    
    
    <tags>
      
      <tag>WebRTC</tag>
      
      <tag>实时通信</tag>
      
      <tag>前端</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Jackson依赖详解</title>
    <link href="/2026/01/15/Jackson%E4%BE%9D%E8%B5%96%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/15/Jackson%E4%BE%9D%E8%B5%96%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Jackson-依赖详解"><a href="#Jackson-依赖详解" class="headerlink" title="Jackson 依赖详解"></a>Jackson 依赖详解</h1><p>Jackson 是 Java 生态中最流行的 JSON 处理库，由多个模块组成。本文详细介绍各个依赖的作用。</p><h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><p>Jackson 采用<strong>模块化设计</strong>，分为三层：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">┌─────────────────────────────────────────────────────┐<br>│                   数据格式模块                        │<br>│  (<span class="hljs-keyword">jackson-dataformat-xml, </span>yaml, csv, properties...) │<br>├─────────────────────────────────────────────────────┤<br>│                   数据绑定层                          │<br>│              (<span class="hljs-keyword">jackson-databind) </span>                     │<br>├─────────────────────────────────────────────────────┤<br>│                    核心层                            │<br>│      (<span class="hljs-keyword">jackson-core </span>+ <span class="hljs-keyword">jackson-annotations) </span>          │<br>└─────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="核心模块（必需）"><a href="#核心模块（必需）" class="headerlink" title="核心模块（必需）"></a>核心模块（必需）</h2><h3 id="1-jackson-core"><a href="#1-jackson-core" class="headerlink" title="1. jackson-core"></a>1. jackson-core</h3><p><strong>作用</strong>：Jackson 的基础模块，提供底层流式 API。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>核心类</strong>：</p><table><thead><tr><th>类名</th><th>作用</th></tr></thead><tbody><tr><td><code>JsonFactory</code></td><td>创建解析器和生成器的工厂</td></tr><tr><td><code>JsonParser</code></td><td>流式读取 JSON（拉模式）</td></tr><tr><td><code>JsonGenerator</code></td><td>流式写入 JSON</td></tr><tr><td><code>JsonToken</code></td><td>JSON 令牌类型枚举</td></tr></tbody></table><p><strong>使用场景</strong>：</p><ul><li>需要极致性能的场景</li><li>处理超大 JSON 文件（流式处理，内存占用低）</li><li>自定义底层解析逻辑</li></ul><hr><h3 id="2-jackson-annotations"><a href="#2-jackson-annotations" class="headerlink" title="2. jackson-annotations"></a>2. jackson-annotations</h3><p><strong>作用</strong>：提供注解定义，用于控制序列化&#x2F;反序列化行为。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-annotations<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>常用注解</strong>：</p><table><thead><tr><th>注解</th><th>作用</th></tr></thead><tbody><tr><td><code>@JsonProperty</code></td><td>指定 JSON 字段名</td></tr><tr><td><code>@JsonIgnore</code></td><td>忽略字段</td></tr><tr><td><code>@JsonFormat</code></td><td>格式化日期&#x2F;数字</td></tr><tr><td><code>@JsonInclude</code></td><td>控制空值是否序列化</td></tr><tr><td><code>@JsonCreator</code></td><td>指定反序列化构造器</td></tr><tr><td><code>@JsonValue</code></td><td>指定序列化时使用的值</td></tr><tr><td><code>@JsonAlias</code></td><td>反序列化时的别名</td></tr></tbody></table><blockquote><p><strong>💡 提示: 提示</strong><br>此模块无任何依赖，可单独使用于 DTO 定义</p></blockquote><hr><h3 id="3-jackson-databind"><a href="#3-jackson-databind" class="headerlink" title="3. jackson-databind"></a>3. jackson-databind</h3><p><strong>作用</strong>：数据绑定模块，提供 <code>ObjectMapper</code>，是最常用的模块。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>依赖关系</strong>：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jackson-databind</span><br><span class="hljs-keyword"></span>├── <span class="hljs-keyword">jackson-core</span><br><span class="hljs-keyword"></span>└── <span class="hljs-keyword">jackson-annotations</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>📝 注意: 说明</strong><br>引入 <code>jackson-databind</code> 会自动传递依赖 <code>jackson-core</code> 和 <code>jackson-annotations</code></p></blockquote><p><strong>核心类</strong>：</p><table><thead><tr><th>类名</th><th>作用</th></tr></thead><tbody><tr><td><code>ObjectMapper</code></td><td>核心类，JSON 与对象互转</td></tr><tr><td><code>JsonNode</code></td><td>树模型，动态解析 JSON</td></tr><tr><td><code>TypeReference</code></td><td>处理泛型类型</td></tr></tbody></table><hr><h2 id="数据格式模块"><a href="#数据格式模块" class="headerlink" title="数据格式模块"></a>数据格式模块</h2><p>用于支持 JSON 以外的数据格式。</p><h3 id="jackson-dataformat-xml"><a href="#jackson-dataformat-xml" class="headerlink" title="jackson-dataformat-xml"></a>jackson-dataformat-xml</h3><p><strong>作用</strong>：支持 XML 格式的序列化&#x2F;反序列化。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="jackson-dataformat-yaml"><a href="#jackson-dataformat-yaml" class="headerlink" title="jackson-dataformat-yaml"></a>jackson-dataformat-yaml</h3><p><strong>作用</strong>：支持 YAML 格式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-yaml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="jackson-dataformat-csv"><a href="#jackson-dataformat-csv" class="headerlink" title="jackson-dataformat-csv"></a>jackson-dataformat-csv</h3><p><strong>作用</strong>：支持 CSV 格式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-csv<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="jackson-dataformat-properties"><a href="#jackson-dataformat-properties" class="headerlink" title="jackson-dataformat-properties"></a>jackson-dataformat-properties</h3><p><strong>作用</strong>：支持 Java Properties 格式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-properties<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="数据类型模块"><a href="#数据类型模块" class="headerlink" title="数据类型模块"></a>数据类型模块</h2><p>用于支持特定 Java 类型的序列化。</p><h3 id="jackson-datatype-jsr310"><a href="#jackson-datatype-jsr310" class="headerlink" title="jackson-datatype-jsr310"></a>jackson-datatype-jsr310</h3><p><strong>作用</strong>：支持 Java 8 日期时间 API（<code>LocalDate</code>、<code>LocalDateTime</code> 等）。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>使用方式</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br>mapper.registerModule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaTimeModule</span>());<br></code></pre></td></tr></table></figure><blockquote><p><strong>⚠️ 警告: 注意</strong><br>不注册此模块时，Java 8 日期类型会序列化为复杂对象而非字符串</p></blockquote><h3 id="jackson-datatype-jdk8"><a href="#jackson-datatype-jdk8" class="headerlink" title="jackson-datatype-jdk8"></a>jackson-datatype-jdk8</h3><p><strong>作用</strong>：支持 Java 8 新类型（<code>Optional</code>、<code>Stream</code> 等）。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jdk8<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="jackson-datatype-guava"><a href="#jackson-datatype-guava" class="headerlink" title="jackson-datatype-guava"></a>jackson-datatype-guava</h3><p><strong>作用</strong>：支持 Guava 集合类型。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="框架集成模块"><a href="#框架集成模块" class="headerlink" title="框架集成模块"></a>框架集成模块</h2><h3 id="jackson-module-kotlin"><a href="#jackson-module-kotlin" class="headerlink" title="jackson-module-kotlin"></a>jackson-module-kotlin</h3><p><strong>作用</strong>：Kotlin 支持，处理 data class、默认参数等。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-kotlin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="jackson-module-parameter-names"><a href="#jackson-module-parameter-names" class="headerlink" title="jackson-module-parameter-names"></a>jackson-module-parameter-names</h3><p><strong>作用</strong>：使用 Java 8 参数名反射，无需 <code>@JsonProperty</code>。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-parameter-names<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>📝 注意: 前提条件</strong><br>需要编译时添加 <code>-parameters</code> 参数</p></blockquote><h3 id="jackson-jaxrs-json-provider"><a href="#jackson-jaxrs-json-provider" class="headerlink" title="jackson-jaxrs-json-provider"></a>jackson-jaxrs-json-provider</h3><p><strong>作用</strong>：JAX-RS（Jersey、RESTEasy）集成。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.jaxrs<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-jaxrs-json-provider<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="依赖汇总表"><a href="#依赖汇总表" class="headerlink" title="依赖汇总表"></a>依赖汇总表</h2><table><thead><tr><th>模块</th><th>ArtifactId</th><th>用途说明</th></tr></thead><tbody><tr><td>核心</td><td>jackson-core</td><td>底层解析器，逐字符读写 JSON（性能最优）</td></tr><tr><td>核心</td><td>jackson-annotations</td><td>提供 @JsonProperty 等注解</td></tr><tr><td>核心</td><td>jackson-databind</td><td>提供 ObjectMapper，JSON ↔ 对象互转</td></tr><tr><td>格式</td><td>jackson-dataformat-xml</td><td>支持 XML 格式读写</td></tr><tr><td>格式</td><td>jackson-dataformat-yaml</td><td>支持 YAML 格式读写</td></tr><tr><td>格式</td><td>jackson-dataformat-csv</td><td>支持 CSV 格式读写</td></tr><tr><td>类型</td><td>jackson-datatype-jsr310</td><td>支持 LocalDate&#x2F;LocalDateTime 等</td></tr><tr><td>类型</td><td>jackson-datatype-jdk8</td><td>支持 Optional&#x2F;Stream 等</td></tr><tr><td>集成</td><td>jackson-module-kotlin</td><td>支持 Kotlin data class</td></tr></tbody></table><hr><h2 id="常见组合推荐"><a href="#常见组合推荐" class="headerlink" title="常见组合推荐"></a>常见组合推荐</h2><h3 id="Spring-Boot-项目（推荐）"><a href="#Spring-Boot-项目（推荐）" class="headerlink" title="Spring Boot 项目（推荐）"></a>Spring Boot 项目（推荐）</h3><p>Spring Boot 已内置 Jackson，通常只需添加：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- Java 8 日期支持（Spring Boot 已自动配置） --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="普通-Java-项目"><a href="#普通-Java-项目" class="headerlink" title="普通 Java 项目"></a>普通 Java 项目</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 基础：数据绑定（自动包含 core 和 annotations） --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- Java 8 日期支持 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-datatype-jsr310<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Kotlin-项目"><a href="#Kotlin-项目" class="headerlink" title="Kotlin 项目"></a>Kotlin 项目</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.module<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-module-kotlin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="使用-BOM-统一版本"><a href="#使用-BOM-统一版本" class="headerlink" title="使用 BOM 统一版本"></a>使用 BOM 统一版本</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.17.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><blockquote><p><strong>⚠️ 警告: 版本一致性</strong><br>所有 Jackson 模块必须使用相同版本，否则可能出现兼容性问题</p></blockquote><hr><h2 id="核心-API-详解"><a href="#核心-API-详解" class="headerlink" title="核心 API 详解"></a>核心 API 详解</h2><h3 id="ObjectMapper"><a href="#ObjectMapper" class="headerlink" title="ObjectMapper"></a>ObjectMapper</h3><p><code>ObjectMapper</code> 是 Jackson 最核心的类，负责 JSON 与 Java 对象的互转。</p><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-comment">// 对象 → JSON 字符串</span><br><span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(user);<br><br><span class="hljs-comment">// JSON 字符串 → 对象</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.readValue(json, User.class);<br><br><span class="hljs-comment">// JSON 字符串 → List</span><br>List&lt;User&gt; users = mapper.readValue(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;User&gt;&gt;() &#123;&#125;);<br><br><span class="hljs-comment">// JSON 字符串 → Map</span><br>Map&lt;String, Object&gt; map = mapper.readValue(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;&gt;() &#123;&#125;);<br></code></pre></td></tr></table></figure><h4 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 写入文件</span><br>mapper.writeValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;user.json&quot;</span>), user);<br><br><span class="hljs-comment">// 从文件读取</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.readValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;user.json&quot;</span>), User.class);<br><br><span class="hljs-comment">// 从 InputStream 读取</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.readValue(inputStream, User.class);<br><br><span class="hljs-comment">// 从 URL 读取</span><br><span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> mapper.readValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://api.example.com/user&quot;</span>), User.class);<br></code></pre></td></tr></table></figure><h4 id="常用配置"><a href="#常用配置" class="headerlink" title="常用配置"></a>常用配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-comment">// 格式化输出（美化 JSON）</span><br>mapper.enable(SerializationFeature.INDENT_OUTPUT);<br><br><span class="hljs-comment">// 忽略未知字段（反序列化时）</span><br>mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);<br><br><span class="hljs-comment">// 空对象不报错</span><br>mapper.disable(SerializationFeature.FAIL_ON_EMPTY_BEANS);<br><br><span class="hljs-comment">// null 值不序列化</span><br>mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);<br><br><span class="hljs-comment">// 日期格式化</span><br>mapper.setDateFormat(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));<br></code></pre></td></tr></table></figure><hr><h3 id="JsonNode-树模型"><a href="#JsonNode-树模型" class="headerlink" title="JsonNode 树模型"></a>JsonNode 树模型</h3><p>当 JSON 结构不固定或只需要部分字段时，使用树模型更灵活。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 解析为树</span><br><span class="hljs-type">JsonNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> mapper.readTree(json);<br><br><span class="hljs-comment">// 获取字段值</span><br><span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> root.get(<span class="hljs-string">&quot;name&quot;</span>).asText();<br><span class="hljs-type">int</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> root.get(<span class="hljs-string">&quot;age&quot;</span>).asInt();<br><span class="hljs-type">boolean</span> <span class="hljs-variable">active</span> <span class="hljs-operator">=</span> root.get(<span class="hljs-string">&quot;active&quot;</span>).asBoolean();<br><br><span class="hljs-comment">// 嵌套访问</span><br><span class="hljs-type">String</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> root.get(<span class="hljs-string">&quot;address&quot;</span>).get(<span class="hljs-string">&quot;city&quot;</span>).asText();<br><br><span class="hljs-comment">// 安全访问（避免 NPE）</span><br><span class="hljs-type">String</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> root.path(<span class="hljs-string">&quot;address&quot;</span>).path(<span class="hljs-string">&quot;city&quot;</span>).asText(<span class="hljs-string">&quot;默认值&quot;</span>);<br><br><span class="hljs-comment">// 遍历数组</span><br><span class="hljs-keyword">for</span> (JsonNode item : root.get(<span class="hljs-string">&quot;items&quot;</span>)) &#123;<br>    System.out.println(item.get(<span class="hljs-string">&quot;id&quot;</span>).asInt());<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p><strong>💡 提示: get vs path</strong></p><ul><li><code>get()</code> 字段不存在时返回 <code>null</code></li><li><code>path()</code> 字段不存在时返回 <code>MissingNode</code>，可链式调用不会 NPE</li></ul></blockquote><hr><h3 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h3><h4 id="字段映射"><a href="#字段映射" class="headerlink" title="字段映射"></a>字段映射</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-meta">@JsonProperty(&quot;user_name&quot;)</span>  <span class="hljs-comment">// JSON 字段名映射</span><br>    <span class="hljs-keyword">private</span> String name;<br><br>    <span class="hljs-meta">@JsonIgnore</span>  <span class="hljs-comment">// 忽略此字段</span><br>    <span class="hljs-keyword">private</span> String password;<br><br>    <span class="hljs-meta">@JsonAlias(&#123;&quot;phone&quot;, &quot;mobile&quot;&#125;)</span>  <span class="hljs-comment">// 反序列化时接受多个名称</span><br>    <span class="hljs-keyword">private</span> String telephone;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> &#123;<br>    <span class="hljs-meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;GMT+8&quot;)</span><br>    <span class="hljs-keyword">private</span> LocalDateTime createTime;<br><br>    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING)</span>  <span class="hljs-comment">// 数字转字符串</span><br>    <span class="hljs-keyword">private</span> Long orderId;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="空值处理"><a href="#空值处理" class="headerlink" title="空值处理"></a>空值处理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span>  <span class="hljs-comment">// 类级别：null 不序列化</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Response</span> &#123;<br><br>    <span class="hljs-meta">@JsonInclude(JsonInclude.Include.NON_EMPTY)</span>  <span class="hljs-comment">// 字段级别：空集合不序列化</span><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; tags;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="构造器与工厂方法"><a href="#构造器与工厂方法" class="headerlink" title="构造器与工厂方法"></a>构造器与工厂方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> age;<br><br>    <span class="hljs-meta">@JsonCreator</span>  <span class="hljs-comment">// 指定反序列化使用的构造器</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@JsonProperty(&quot;name&quot;)</span> String name,</span><br><span class="hljs-params">        <span class="hljs-meta">@JsonProperty(&quot;age&quot;)</span> <span class="hljs-type">int</span> age</span><br><span class="hljs-params">    )</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="注解汇总"><a href="#注解汇总" class="headerlink" title="注解汇总"></a>注解汇总</h4><table><thead><tr><th>注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>@JsonProperty</code></td><td>字段名映射</td><td><code>@JsonProperty(&quot;user_name&quot;)</code></td></tr><tr><td><code>@JsonIgnore</code></td><td>忽略字段</td><td>密码等敏感字段</td></tr><tr><td><code>@JsonFormat</code></td><td>格式化</td><td>日期、数字格式</td></tr><tr><td><code>@JsonInclude</code></td><td>空值策略</td><td>NON_NULL、NON_EMPTY</td></tr><tr><td><code>@JsonCreator</code></td><td>构造器</td><td>不可变对象</td></tr><tr><td><code>@JsonAlias</code></td><td>别名</td><td>兼容多种字段名</td></tr><tr><td><code>@JsonValue</code></td><td>序列化值</td><td>枚举自定义输出</td></tr></tbody></table><hr><h3 id="TypeReference-泛型处理"><a href="#TypeReference-泛型处理" class="headerlink" title="TypeReference 泛型处理"></a>TypeReference 泛型处理</h3><p>Java 泛型在运行时会被擦除，需要 <code>TypeReference</code> 保留类型信息。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 错误：泛型被擦除，无法正确反序列化</span><br>List&lt;User&gt; users = mapper.readValue(json, List.class);  <span class="hljs-comment">// 得到 List&lt;LinkedHashMap&gt;</span><br><br><span class="hljs-comment">// 正确：使用 TypeReference</span><br>List&lt;User&gt; users = mapper.readValue(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;User&gt;&gt;() &#123;&#125;);<br><br><span class="hljs-comment">// 嵌套泛型</span><br>Map&lt;String, List&lt;User&gt;&gt; data = mapper.readValue(<br>    json,<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, List&lt;User&gt;&gt;&gt;() &#123;&#125;<br>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Jackson</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Jackson</tag>
      
      <tag>JSON</tag>
      
      <tag>序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Claude-Code-Skills详解</title>
    <link href="/2026/01/14/Claude-Code-Skills%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/14/Claude-Code-Skills%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Claude-Code-Skills-详解"><a href="#Claude-Code-Skills-详解" class="headerlink" title="Claude Code Skills 详解"></a>Claude Code Skills 详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Skills 是 Claude Code 中的<strong>模块化、可发现的知识单元</strong>，用于教导 Claude 如何以可重复的方式完成特定任务。它们是独立的软件包，包含指令、元数据和可选的资源文件。</p><h3 id="核心特性"><a href="#核心特性" class="headerlink" title="核心特性"></a>核心特性</h3><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>模块化和可重用性</td><td>独立的软件包，可跨项目重复使用</td></tr><tr><td>自动调用机制</td><td>Claude 根据用户请求自动判断何时触发</td></tr><tr><td>渐进式披露</td><td>仅预加载元数据，按需加载完整内容</td></tr><tr><td>跨平台兼容</td><td>支持 Claude.ai、Claude Code 和 API</td></tr><tr><td>可执行代码支持</td><td>可包含 Python、Shell 等脚本</td></tr></tbody></table><h2 id="Skills-vs-Slash-Commands"><a href="#Skills-vs-Slash-Commands" class="headerlink" title="Skills vs Slash Commands"></a>Skills vs Slash Commands</h2><p>👉Skills与MCP、Tools的区别详解 ^skills-vs-others</p><table><thead><tr><th>对比项</th><th>Skills</th><th>Slash Commands</th></tr></thead><tbody><tr><td>触发方式</td><td><strong>自动触发</strong>（基于语义匹配）</td><td><strong>手动触发</strong>（输入 <code>/command</code>）</td></tr><tr><td>适用场景</td><td>复杂多文件工作流、专业领域知识</td><td>简单重复任务、用户触发的快捷操作</td></tr><tr><td>配置文件</td><td><code>SKILL.md</code></td><td><code>.claude/commands/*.md</code></td></tr><tr><td>复杂度</td><td>高（可含脚本、模板、资源）</td><td>低（单个 Markdown 文件）</td></tr></tbody></table><h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><h3 id="技能存储位置"><a href="#技能存储位置" class="headerlink" title="技能存储位置"></a>技能存储位置</h3><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment"># 个人技能（所有项目通用）</span><br>~<span class="hljs-regexp">/.claude/skills</span><span class="hljs-regexp">/</span><br><span class="hljs-regexp">    └── my-skill/</span><br>        └── SKILL.md<br><br><span class="hljs-comment"># 项目技能（团队共享）</span><br>&lt;项目根目录&gt;<span class="hljs-regexp">/.claude/skills</span><span class="hljs-regexp">/</span><br><span class="hljs-regexp">    └── team-skill/</span><br>        └── SKILL.md<br></code></pre></td></tr></table></figure><h3 id="技能目录结构"><a href="#技能目录结构" class="headerlink" title="技能目录结构"></a>技能目录结构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix">my-skill<span class="hljs-symbol">/</span><br>├── SKILL.md          <span class="hljs-comment"># 核心文件（必需）</span><br>├── reference.md      <span class="hljs-comment"># 参考文档（可选）</span><br>├── examples.md       <span class="hljs-comment"># 示例集合（可选）</span><br>├── scripts<span class="hljs-symbol">/</span>          <span class="hljs-comment"># 可执行脚本（可选）</span><br>│   └── helper.py<br>└── templates<span class="hljs-symbol">/</span>        <span class="hljs-comment"># 文件模板（可选）</span><br>    └── template.txt<br></code></pre></td></tr></table></figure><h2 id="SKILL-md-配置格式"><a href="#SKILL-md-配置格式" class="headerlink" title="SKILL.md 配置格式"></a>SKILL.md 配置格式</h2><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">skill-name</span><br><span class="hljs-attr">description:</span> <span class="hljs-string">技能描述，Claude</span> <span class="hljs-string">依靠此描述判断何时触发</span><br><span class="hljs-attr">allowed-tools:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Tool1</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Tool2</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># 以下是 Markdown 格式的指令内容</span><br></code></pre></td></tr></table></figure><h3 id="必需字段"><a href="#必需字段" class="headerlink" title="必需字段"></a>必需字段</h3><table><thead><tr><th>字段</th><th>要求</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>最多 64 字符</td><td>只能包含小写字母、数字和连字符</td></tr><tr><td><code>description</code></td><td>最多 1024 字符</td><td><strong>最关键字段</strong>，决定触发时机</td></tr></tbody></table><h3 id="Description-编写要点"><a href="#Description-编写要点" class="headerlink" title="Description 编写要点"></a>Description 编写要点</h3><p>Description 是 Claude 判断是否触发技能的核心依据，应包含：</p><ol><li><strong>功能定义</strong> - 技能做什么</li><li><strong>适用场景</strong> - 什么情况下使用</li><li><strong>触发关键词</strong> - 用户可能使用的词汇</li></ol><blockquote><p><strong>💡 提示: 最佳实践</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">公众号文章写作助手。根据用户提供的主题、大纲或参考内容，</span><br>  <span class="hljs-string">自动生成符合公众号风格的原创文章。当用户提到&quot;写公众号&quot;&quot;生成文章&quot;等关键词时触发。</span><br></code></pre></td></tr></table></figure></blockquote><blockquote><p><strong>⚠️ 警告: 反面示例</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">写作助手Skill.</span><br></code></pre></td></tr></table></figure><p>过于宽泛，Claude 难以判断何时触发。</p></blockquote><h3 id="可选字段"><a href="#可选字段" class="headerlink" title="可选字段"></a>可选字段</h3><table><thead><tr><th>字段</th><th>说明</th></tr></thead><tbody><tr><td><code>allowed-tools</code></td><td>限制可使用的工具（如 <code>Bash</code>、<code>Read</code>、<code>Grep</code>）</td></tr><tr><td><code>user-invocable</code></td><td>是否显示在斜杠命令菜单，默认 <code>true</code></td></tr><tr><td><code>model</code></td><td>指定使用的 Claude 模型</td></tr><tr><td><code>context</code></td><td>设为 <code>fork</code> 时在隔离子代理中运行</td></tr><tr><td><code>agent</code></td><td>与 <code>context: fork</code> 配合，指定代理类型</td></tr><tr><td><code>hooks</code></td><td>定义生命周期钩子</td></tr><tr><td><code>dependencies</code></td><td>声明依赖包</td></tr></tbody></table><h3 id="可选字段详解"><a href="#可选字段详解" class="headerlink" title="可选字段详解"></a>可选字段详解</h3><h4 id="allowed-tools-工具权限控制"><a href="#allowed-tools-工具权限控制" class="headerlink" title="allowed-tools - 工具权限控制"></a>allowed-tools - 工具权限控制</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 方式一：逗号分隔</span><br><span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Write,</span> <span class="hljs-string">Bash</span><br><br><span class="hljs-comment"># 方式二：YAML 列表</span><br><span class="hljs-attr">allowed-tools:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Read</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Write</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">Bash(python:*)</span>  <span class="hljs-comment"># 支持 glob 模式</span><br></code></pre></td></tr></table></figure><h4 id="model-指定模型"><a href="#model-指定模型" class="headerlink" title="model - 指定模型"></a>model - 指定模型</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">model:</span> <span class="hljs-string">claude-sonnet-4-20250514</span><br></code></pre></td></tr></table></figure><p>未指定时使用当前对话的活动模型。</p><h4 id="context-agent-子代理模式"><a href="#context-agent-子代理模式" class="headerlink" title="context + agent - 子代理模式"></a>context + agent - 子代理模式</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">context:</span> <span class="hljs-string">fork</span><br><span class="hljs-attr">agent:</span> <span class="hljs-string">Explore</span>  <span class="hljs-comment"># 可选: Explore, Plan, general-purpose 或自定义代理</span><br></code></pre></td></tr></table></figure><p>在隔离环境中执行，拥有独立的对话历史。适用于需要独立上下文的复杂任务。</p><h4 id="hooks-生命周期钩子"><a href="#hooks-生命周期钩子" class="headerlink" title="hooks - 生命周期钩子"></a>hooks - 生命周期钩子</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">hooks:</span><br>  <span class="hljs-attr">PreToolUse:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">&quot;echo &#x27;Before tool execution&#x27;&quot;</span><br>  <span class="hljs-attr">PostToolUse:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">&quot;echo &#x27;After tool execution&#x27;&quot;</span><br>  <span class="hljs-attr">Stop:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">command:</span> <span class="hljs-string">&quot;echo &#x27;Skill completed&#x27;&quot;</span><br></code></pre></td></tr></table></figure><p>支持的钩子事件：</p><ul><li><code>PreToolUse</code> - 工具执行前</li><li><code>PostToolUse</code> - 工具执行后</li><li><code>Stop</code> - 技能完成时</li></ul><h4 id="dependencies-依赖声明"><a href="#dependencies-依赖声明" class="headerlink" title="dependencies - 依赖声明"></a>dependencies - 依赖声明</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">dependencies:</span> <span class="hljs-string">python&gt;=3.8,</span> <span class="hljs-string">pandas&gt;=1.5.0,</span> <span class="hljs-string">openpyxl</span><br></code></pre></td></tr></table></figure><p>声明技能所需的软件包和版本要求。</p><h2 id="创建自定义-Skill-步骤"><a href="#创建自定义-Skill-步骤" class="headerlink" title="创建自定义 Skill 步骤"></a>创建自定义 Skill 步骤</h2><h3 id="步骤-1：创建技能目录"><a href="#步骤-1：创建技能目录" class="headerlink" title="步骤 1：创建技能目录"></a>步骤 1：创建技能目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 个人技能</span><br><span class="hljs-built_in">mkdir</span> -p ~/.claude/skills/my-reporting-skill<br><br><span class="hljs-comment"># 项目技能</span><br><span class="hljs-built_in">mkdir</span> -p .claude/skills/team-reporting-skill<br></code></pre></td></tr></table></figure><h3 id="步骤-2：创建-SKILL-md"><a href="#步骤-2：创建-SKILL-md" class="headerlink" title="步骤 2：创建 SKILL.md"></a>步骤 2：创建 SKILL.md</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs markdown">---<br>name: quarterly-reporting-assistant<br>description: 季度报告生成助手。当用户要求生成季度销售、财务或运营报告时触发。<br>  可根据提供的数据或模板生成结构化报告。<br><span class="hljs-section">  触发关键词：生成季度报告、创建销售报告、财务报告。</span><br><span class="hljs-section">---</span><br><br><span class="hljs-section"># 季度报告生成助手</span><br><br><span class="hljs-section">## 工作流程</span><br><br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**理解报告类型**</span> - 确定用户需要的报告类型（销售、财务、运营等）<br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**获取必要数据**</span> - 读取用户提供的数据文件或询问数据来源<br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**选择报告模板**</span> - 从 <span class="hljs-code">`templates/`</span> 目录选择合适模板<br><span class="hljs-bullet">4.</span> <span class="hljs-strong">**填充报告内容**</span> - 将数据填充到模板中<br><span class="hljs-bullet">5.</span> <span class="hljs-strong">**审查与优化**</span> - 检查报告逻辑和格式<br><span class="hljs-bullet">6.</span> <span class="hljs-strong">**输出报告**</span> - 以 Markdown 或指定格式输出<br><br><span class="hljs-section">## 示例对话</span><br><br>用户输入: &quot;请帮我生成一份关于Q3销售数据的季度报告。&quot;<br><br>Claude 动作:<br><span class="hljs-bullet">1.</span> 识别到用户请求&quot;季度报告&quot;和&quot;销售数据&quot;<br><span class="hljs-bullet">2.</span> 询问用户提供Q3销售数据<br><span class="hljs-bullet">3.</span> 使用 <span class="hljs-code">`templates/sales-report.md`</span> 模板<br><span class="hljs-bullet">4.</span> 生成并展示销售报告草稿<br></code></pre></td></tr></table></figure><h3 id="步骤-3：添加资源文件（可选）"><a href="#步骤-3：添加资源文件（可选）" class="headerlink" title="步骤 3：添加资源文件（可选）"></a>步骤 3：添加资源文件（可选）</h3><p><strong>模板文件 <code>templates/sales-report.md</code></strong></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section"># &#123;&#123;Quarter&#125;&#125; 销售数据报告</span><br><br><span class="hljs-section">## 概述</span><br>本报告总结了 &#123;&#123;Quarter&#125;&#125; 的销售表现。<br><br><span class="hljs-section">## 关键指标</span><br><span class="hljs-bullet">-</span> 总销售额: &#123;&#123;TotalSales&#125;&#125;<br><span class="hljs-bullet">-</span> 订单数量: &#123;&#123;OrderCount&#125;&#125;<br><span class="hljs-bullet">-</span> 平均订单价值: &#123;&#123;AOV&#125;&#125;<br><br><span class="hljs-section">## 销售趋势</span><br>（插入销售趋势图或详细数据）<br><br><span class="hljs-section">## 总结与展望</span><br></code></pre></td></tr></table></figure><p><strong>处理脚本 <code>scripts/data_processor.py</code></strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">process_sales_data</span>(<span class="hljs-params">data</span>):<br>    total_sales = <span class="hljs-built_in">sum</span>(item[<span class="hljs-string">&#x27;amount&#x27;</span>] <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data)<br>    order_count = <span class="hljs-built_in">len</span>(data)<br>    aov = total_sales / order_count <span class="hljs-keyword">if</span> order_count &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-string">&quot;TotalSales&quot;</span>: <span class="hljs-string">f&quot;$<span class="hljs-subst">&#123;total_sales:,<span class="hljs-number">.2</span>f&#125;</span>&quot;</span>,<br>        <span class="hljs-string">&quot;OrderCount&quot;</span>: order_count,<br>        <span class="hljs-string">&quot;AOV&quot;</span>: <span class="hljs-string">f&quot;$<span class="hljs-subst">&#123;aov:,<span class="hljs-number">.2</span>f&#125;</span>&quot;</span><br>    &#125;<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    sample_data = [<br>        &#123;<span class="hljs-string">&quot;item&quot;</span>: <span class="hljs-string">&quot;Product A&quot;</span>, <span class="hljs-string">&quot;amount&quot;</span>: <span class="hljs-number">120.50</span>&#125;,<br>        &#123;<span class="hljs-string">&quot;item&quot;</span>: <span class="hljs-string">&quot;Product B&quot;</span>, <span class="hljs-string">&quot;amount&quot;</span>: <span class="hljs-number">80.00</span>&#125;,<br>    ]<br>    <span class="hljs-built_in">print</span>(json.dumps(process_sales_data(sample_data)))<br></code></pre></td></tr></table></figure><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><pre><code class=" mermaid">sequenceDiagram    participant User as 用户    participant Claude as Claude    participant Manager as Skill Manager    participant Skill as SKILL.md    User-&gt;&gt;Claude: 发送请求    Claude-&gt;&gt;Manager: 检查技能元数据    Manager--&gt;&gt;Claude: 返回匹配的技能描述    Claude-&gt;&gt;Claude: 判断是否需要技能    alt 需要技能        Claude-&gt;&gt;User: 请求确认加载技能        User--&gt;&gt;Claude: 确认        Claude-&gt;&gt;Skill: 加载完整 SKILL.md        Skill--&gt;&gt;Claude: 返回指令内容        Claude-&gt;&gt;Claude: 按指令执行任务    else 不需要技能        Claude-&gt;&gt;Claude: 正常处理请求    end    Claude-&gt;&gt;User: 返回结果</code></pre><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="编写高质量-Skill"><a href="#编写高质量-Skill" class="headerlink" title="编写高质量 Skill"></a>编写高质量 Skill</h3><ol><li><strong>Description 足够具体</strong> - 直接影响 Claude 能否准确触发</li><li><strong>指令清晰分步</strong> - 提供明确的操作指导</li><li><strong>工作流明确</strong> - 定义清晰的执行流程</li><li><strong>从小任务开始</strong> - 逐步掌握技能创建</li></ol><h3 id="安全注意事项"><a href="#安全注意事项" class="headerlink" title="安全注意事项"></a>安全注意事项</h3><blockquote><p><strong>⚠️ 警告: 安全提醒</strong><br>技能可以包含可执行代码，加载第三方技能时务必评估来源可靠性。</p></blockquote><h3 id="调试技巧"><a href="#调试技巧" class="headerlink" title="调试技巧"></a>调试技巧</h3><ol><li>使用 <code>/skills</code> 命令查看已加载的技能</li><li>检查 description 是否包含足够的触发关键词</li><li>确保 SKILL.md 语法正确（YAML frontmatter 格式）</li></ol><h2 id="API-集成"><a href="#API-集成" class="headerlink" title="API 集成"></a>API 集成</h2><p>通过 Messages API 使用 Skills：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;container&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;skill_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-skill-id&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;skill&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>需要启用的 Beta 头：</p><ul><li><code>code-execution-2025-08-25</code></li><li><code>skills-2025-10-02</code></li><li><code>files-api-2025-04-14</code></li></ul><h2 id="参考资源"><a href="#参考资源" class="headerlink" title="参考资源"></a>参考资源</h2><ul><li><a href="https://anthropic.com/">Claude Code 官方文档</a></li><li><a href="https://github.com/anthropics/claude-code">Claude Code GitHub</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>编程工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Claude-Code</tag>
      
      <tag>AI工具</tag>
      
      <tag>Skills</tag>
      
      <tag>自动化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Agent工具调用技术详解</title>
    <link href="/2026/01/14/Agent%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/14/Agent%E5%B7%A5%E5%85%B7%E8%B0%83%E7%94%A8%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Agent-工具调用技术详解"><a href="#Agent-工具调用技术详解" class="headerlink" title="Agent 工具调用技术详解"></a>Agent 工具调用技术详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>现代 AI Agent 需要与外部世界交互才能完成实际任务。本文详细介绍三种核心技术：<strong>Function Calling</strong>、<strong>MCP</strong> 和 <strong>Agent Skills</strong>，它们构成了 Agent 工具调用的完整技术栈。</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ada">┌─────────────────────────────────────────────────────────┐<br>│                    Agent Skills                         │<br>│    （高层封装：工作流指令 + 脚本 + 参考文档）           │<br>├─────────────────────────────────────────────────────────┤<br>│                         MCP                             │<br>│       （协议层：标准化连接外部工具/数据源）             │<br>├─────────────────────────────────────────────────────────┤<br>│                  <span class="hljs-keyword">Function</span> <span class="hljs-title">Calling</span>                       │<br>│          （底层能力：模型生成结构化调用参数）           │<br>└─────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="一、Function-Calling（函数调用）"><a href="#一、Function-Calling（函数调用）" class="headerlink" title="一、Function Calling（函数调用）"></a>一、Function Calling（函数调用）</h2><h3 id="1-1-定义"><a href="#1-1-定义" class="headerlink" title="1.1 定义"></a>1.1 定义</h3><p>Function Calling 是大模型的一种<strong>原生能力</strong>，允许模型：</p><ul><li>识别何时需要调用外部工具</li><li>生成结构化的函数调用参数（JSON 格式）</li><li>理解函数返回结果并继续对话</li></ul><h3 id="1-2-工作流程"><a href="#1-2-工作流程" class="headerlink" title="1.2 工作流程"></a>1.2 工作流程</h3><pre><code class=" mermaid">sequenceDiagram    participant U as 用户    participant M as 大模型    participant T as 外部工具        U-&gt;&gt;M: 发送请求    M-&gt;&gt;M: 判断需要调用工具    M-&gt;&gt;T: 输出函数名 + 参数（JSON）    T-&gt;&gt;T: 执行函数    T-&gt;&gt;M: 返回执行结果    M-&gt;&gt;U: 整合结果并回复</code></pre><h3 id="1-3-示例"><a href="#1-3-示例" class="headerlink" title="1.3 示例"></a>1.3 示例</h3><p>用户请求：<em>“北京今天天气怎么样？”</em></p><p>模型输出：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;function&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;get_weather&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;parameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;city&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;北京&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;date&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2026-01-14&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="1-4-主流平台支持"><a href="#1-4-主流平台支持" class="headerlink" title="1.4 主流平台支持"></a>1.4 主流平台支持</h3><table><thead><tr><th>平台</th><th>支持情况</th></tr></thead><tbody><tr><td>OpenAI</td><td>✅ 原生支持（2023年6月推出）</td></tr><tr><td>Anthropic Claude</td><td>✅ Tool Use</td></tr><tr><td>通义千问</td><td>✅ Function Calling</td></tr><tr><td>文心一言</td><td>✅ 函数调用</td></tr></tbody></table><h3 id="1-5-特点"><a href="#1-5-特点" class="headerlink" title="1.5 特点"></a>1.5 特点</h3><ul><li><strong>底层能力</strong>：是其他工具调用技术的基础</li><li><strong>结构化输出</strong>：强制模型输出符合 JSON Schema 的参数</li><li><strong>各厂商不统一</strong>：每个平台的实现细节略有差异</li></ul><hr><h2 id="二、MCP（Model-Context-Protocol）"><a href="#二、MCP（Model-Context-Protocol）" class="headerlink" title="二、MCP（Model Context Protocol）"></a>二、MCP（Model Context Protocol）</h2><h3 id="2-1-定义"><a href="#2-1-定义" class="headerlink" title="2.1 定义"></a>2.1 定义</h3><p>MCP 是 Anthropic 于 2024 年推出的<strong>开放协议标准</strong>，用于统一 AI 应用与外部数据源&#x2F;工具的连接方式。</p><blockquote><p><strong>核心理念</strong>：一次适配，多处复用——解决”每个工具都要单独适配”的问题。</p></blockquote><h3 id="2-2-架构"><a href="#2-2-架构" class="headerlink" title="2.2 架构"></a>2.2 架构</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌──────────────┐      ┌──────────────┐      ┌──────────────┐<br>│   MCP Host   │◄────►│  MCP Client  │◄────►│  MCP Server  │<br>│  (AI 应用)   │      │   (连接器)   │     │  (工具提供方)│<br>└──────────────┘      └──────────────┘      └──────────────┘<br>        │                                          │<br>        │            标准化协议通信                  │<br>        └──────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="2-3-三种能力类型"><a href="#2-3-三种能力类型" class="headerlink" title="2.3 三种能力类型"></a>2.3 三种能力类型</h3><table><thead><tr><th>类型</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td><strong>Resources</strong></td><td>静态数据资源</td><td>文件、数据库记录、API 响应</td></tr><tr><td><strong>Tools</strong></td><td>可执行的操作</td><td>发送邮件、执行代码、调用 API</td></tr><tr><td><strong>Prompts</strong></td><td>预定义的提示词模板</td><td>代码审查模板、翻译模板</td></tr></tbody></table><h3 id="2-4-类比理解"><a href="#2-4-类比理解" class="headerlink" title="2.4 类比理解"></a>2.4 类比理解</h3><blockquote><p>MCP 就像 AI 领域的 <strong>USB 接口标准</strong>：</p><ul><li>USB 出现前：每种设备需要专用接口</li><li>USB 出现后：统一接口，即插即用</li><li>MCP：统一 AI 与工具的连接标准</li></ul></blockquote><h3 id="2-5-与-Function-Calling-的关系"><a href="#2-5-与-Function-Calling-的关系" class="headerlink" title="2.5 与 Function Calling 的关系"></a>2.5 与 Function Calling 的关系</h3><ul><li>Function Calling 是模型<strong>输出调用意图</strong>的能力</li><li>MCP 是<strong>执行调用</strong>的标准化协议</li><li>MCP Server 内部可能使用 Function Calling 来触发工具</li></ul><hr><h2 id="三、Agent-Skills"><a href="#三、Agent-Skills" class="headerlink" title="三、Agent Skills"></a>三、Agent Skills</h2><h3 id="3-1-定义"><a href="#3-1-定义" class="headerlink" title="3.1 定义"></a>3.1 定义</h3><p>Agent Skills 是 Anthropic 于 2025 年 10 月推出的一种新方式，用于<strong>将专业知识封装成可复用的能力模块</strong>。</p><blockquote><p><strong>核心理念</strong>：为 Agent 准备”入职指南”——不是构建定制化 Agent，而是让通用 Agent 具备专业能力。</p></blockquote><h3 id="3-2-Skill-的结构"><a href="#3-2-Skill-的结构" class="headerlink" title="3.2 Skill 的结构"></a>3.2 Skill 的结构</h3><p>一个 Skill 是一个包含 <code>SKILL.md</code> 文件的目录：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">my</span>-skill/<br>├── SKILL.md          <span class="hljs-comment"># 必需：核心文件（YAML 元数据 + 指令）</span><br>├── <span class="hljs-keyword">reference</span>.md      <span class="hljs-comment"># 可选：详细参考文档</span><br>├── examples.md       <span class="hljs-comment"># 可选：使用示例</span><br>└── scripts/<br>    └── helper.py     <span class="hljs-comment"># 可选：可执行脚本</span><br></code></pre></td></tr></table></figure><h3 id="3-3-SKILL-md-格式"><a href="#3-3-SKILL-md-格式" class="headerlink" title="3.3 SKILL.md 格式"></a>3.3 SKILL.md 格式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">name:</span> <span class="hljs-string">pdf-processing</span><br><span class="hljs-attr">description:</span> <span class="hljs-string">Extract</span> <span class="hljs-string">text,</span> <span class="hljs-string">fill</span> <span class="hljs-string">forms,</span> <span class="hljs-string">merge</span> <span class="hljs-string">PDFs.</span> <span class="hljs-string">Use</span> <span class="hljs-string">when</span> <span class="hljs-string">working</span> <span class="hljs-string">with</span> <span class="hljs-string">PDF</span> <span class="hljs-string">files.</span><br><span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Bash(python:*)</span><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment"># PDF Processing</span><br><br><span class="hljs-comment">## Quick start</span><br><span class="hljs-attr">Extract text:</span><br><span class="hljs-string">```python</span><br><span class="hljs-string">import</span> <span class="hljs-string">pdfplumber</span><br><span class="hljs-string">with</span> <span class="hljs-string">pdfplumber.open(&quot;doc.pdf&quot;)</span> <span class="hljs-attr">as pdf:</span><br>    <span class="hljs-string">text</span> <span class="hljs-string">=</span> <span class="hljs-string">pdf.pages[0].extract_text()</span><br></code></pre></td></tr></table></figure><p>For form filling, see <a href="FORMS.md">FORMS.md</a>.</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><br><span class="hljs-comment">### 3.4 元数据字段详解</span><br><br>|<span class="hljs-string"> 字段 </span>|<span class="hljs-string"> 必需 </span>|<span class="hljs-string"> 作用 </span>|<br>|<span class="hljs-string">------</span>|<span class="hljs-string">------</span>|<span class="hljs-string">------</span>|<br>|<span class="hljs-string"> `name` </span>|<span class="hljs-string"> ✅ </span>|<span class="hljs-string"> Skill 的唯一标识名 </span>|<br>|<span class="hljs-string"> `description` </span>|<span class="hljs-string"> ✅ </span>|<span class="hljs-string"> 描述何时触发该 Skill </span>|<br>|<span class="hljs-string"> `allowed-tools` </span>|<span class="hljs-string"> ❌ </span>|<span class="hljs-string"> 限制可用工具（安全考虑） </span>|<br>|<span class="hljs-string"> `model` </span>|<span class="hljs-string"> ❌ </span>|<span class="hljs-string"> 指定使用的模型版本 </span>|<br>|<span class="hljs-string"> `context: fork` </span>|<span class="hljs-string"> ❌ </span>|<span class="hljs-string"> 在独立上下文中运行 </span>|<br>|<span class="hljs-string"> `hooks` </span>|<span class="hljs-string"> ❌ </span>|<span class="hljs-string"> 定义工具调用前后的钩子 </span>|<br>|<span class="hljs-string"> `user-invocable` </span>|<span class="hljs-string"> ❌ </span>|<span class="hljs-string"> 是否允许用户通过 `/skill-name` 调用 </span>|<br><br><span class="hljs-comment">### 3.5 渐进式披露（Progressive Disclosure）</span><br><br>这是 Skills 的<span class="hljs-symbol">*</span><span class="hljs-symbol">*</span>核心设计原则<span class="hljs-symbol">*</span><span class="hljs-symbol">*</span>：<br><br>```mermaid<br>flowchart TD<br>    A[启动] --&gt; B[加载 name + description 到系统提示词]<br>    B --&gt; C&#123;用户请求与 Skill 相关?&#125;<br>    C --&gt;|<span class="hljs-string">是</span>|<span class="hljs-string"> D[读取完整 SKILL.md]</span><br><span class="hljs-string">    C --&gt;</span>|<span class="hljs-string">否</span>|<span class="hljs-string"> E[继续正常对话]</span><br><span class="hljs-string">    D --&gt; F&#123;需要更多细节?&#125;</span><br><span class="hljs-string">    F --&gt;</span>|<span class="hljs-string">是</span>|<span class="hljs-string"> G[按需读取 reference.md 等]</span><br><span class="hljs-string">    F --&gt;</span>|<span class="hljs-string">否</span>|<span class="hljs-string"> H[执行任务]</span><br><span class="hljs-string">    G --&gt; I&#123;需要执行脚本?&#125;</span><br><span class="hljs-string">    I --&gt;</span>|<span class="hljs-string">是</span>|<span class="hljs-string"> J[运行 scripts/ 中的脚本]</span><br><span class="hljs-string">    I --&gt;</span>|<span class="hljs-string">否</span>|<span class="hljs-string"> H</span><br></code></pre></td></tr></table></figure><p><strong>优势</strong>：上下文窗口使用量<strong>可无限扩展</strong>，只加载真正需要的内容。</p><h3 id="3-6-Skills-存放位置"><a href="#3-6-Skills-存放位置" class="headerlink" title="3.6 Skills 存放位置"></a>3.6 Skills 存放位置</h3><table><thead><tr><th>位置</th><th>作用域</th><th>适用场景</th></tr></thead><tbody><tr><td><code>~/.claude/skills/</code></td><td>用户级</td><td>个人通用 Skills</td></tr><tr><td><code>.claude/skills/</code></td><td>项目级</td><td>项目专用 Skills</td></tr><tr><td>插件中的 <code>skills/</code></td><td>可分发</td><td>通过插件市场共享</td></tr></tbody></table><h3 id="3-7-与-MCP-的关系"><a href="#3-7-与-MCP-的关系" class="headerlink" title="3.7 与 MCP 的关系"></a>3.7 与 MCP 的关系</h3><p>官方明确指出 Skills 和 MCP 是<strong>互补关系</strong>：</p><blockquote><p>“We’ll also explore how Skills can <strong>complement</strong> MCP servers by teaching agents more complex workflows that involve external tools and software.”</p></blockquote><ul><li><strong>MCP</strong>：提供工具连接的标准协议（”有什么工具”）</li><li><strong>Skills</strong>：教会 Agent 如何使用这些工具完成复杂工作流（”怎么用工具”）</li></ul><hr><h2 id="四、三者对比"><a href="#四、三者对比" class="headerlink" title="四、三者对比"></a>四、三者对比</h2><h3 id="4-1-定位对比"><a href="#4-1-定位对比" class="headerlink" title="4.1 定位对比"></a>4.1 定位对比</h3><table><thead><tr><th>维度</th><th>Function Calling</th><th>MCP</th><th>Agent Skills</th></tr></thead><tbody><tr><td><strong>层级</strong></td><td>底层能力</td><td>协议标准</td><td>高层封装</td></tr><tr><td><strong>粒度</strong></td><td>单个函数调用</td><td>工具连接规范</td><td>完整工作流</td></tr><tr><td><strong>标准化</strong></td><td>各厂商不统一</td><td>统一协议</td><td>Anthropic 标准</td></tr><tr><td><strong>复用性</strong></td><td>低（需重复定义）</td><td>高（一次适配）</td><td>高（文件夹共享）</td></tr><tr><td><strong>推出时间</strong></td><td>2023 年</td><td>2024 年</td><td>2025 年</td></tr></tbody></table><h3 id="4-2-协作关系"><a href="#4-2-协作关系" class="headerlink" title="4.2 协作关系"></a>4.2 协作关系</h3><figure class="highlight nim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nim">用户请求: <span class="hljs-string">&quot;帮我填写这个 PDF 表单&quot;</span><br>     │<br>     ▼<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-type">Agent</span> <span class="hljs-type">Skills</span>: pdf-processing                            │<br>│ ├─ 读取 <span class="hljs-type">SKILL</span>.md 获取处理指令                            │<br>│ ├─ 按需加载 <span class="hljs-type">FORMS</span>.md 获取表单填写规范                     │<br>│ └─ 调用 scripts/fill_form.py 执行填写                   │<br>└─────────────────────────────────────────────────────────┘<br>     │<br>     ▼ 通过 <span class="hljs-type">MCP</span> 协议连接<br>┌─────────────────────────────────────────────────────────┐<br>│ <span class="hljs-type">MCP</span> <span class="hljs-type">Server</span>: pdf-tools                                   │<br>│ └─ 提供 <span class="hljs-type">PDF</span> 读写工具                                     │<br>└─────────────────────────────────────────────────────────┘<br>     │<br>     ▼ 基于 <span class="hljs-type">Function</span> <span class="hljs-type">Calling</span><br>┌─────────────────────────────────────────────────────────┐<br>│ 大模型: 生成工具调用参数                                  │<br>│ └─ &#123;<span class="hljs-string">&quot;function&quot;</span>: <span class="hljs-string">&quot;fill_pdf_form&quot;</span>, <span class="hljs-string">&quot;params&quot;</span>: <span class="hljs-meta">&#123;...&#125;</span>&#125;      │<br>└─────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="4-3-使用场景选择"><a href="#4-3-使用场景选择" class="headerlink" title="4.3 使用场景选择"></a>4.3 使用场景选择</h3><table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>简单的单次工具调用</td><td>Function Calling</td></tr><tr><td>连接多个外部服务</td><td>MCP</td></tr><tr><td>复杂的多步骤工作流</td><td>Agent Skills</td></tr><tr><td>需要团队共享的专业能力</td><td>Agent Skills + 插件分发</td></tr><tr><td>需要动态上下文加载</td><td>Agent Skills（渐进式披露）</td></tr></tbody></table><hr><h2 id="五、实践建议"><a href="#五、实践建议" class="headerlink" title="五、实践建议"></a>五、实践建议</h2><h3 id="5-1-何时使用-Skills-vs-其他方式"><a href="#5-1-何时使用-Skills-vs-其他方式" class="headerlink" title="5.1 何时使用 Skills vs 其他方式"></a>5.1 何时使用 Skills vs 其他方式</h3><table><thead><tr><th>方式</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Skills</strong></td><td>复杂的多步骤工作流，需要动态加载上下文</td></tr><tr><td><strong>CLAUDE.md</strong></td><td>项目级通用规则（始终加载）</td></tr><tr><td><strong>斜杠命令</strong></td><td>用户主动触发的快捷操作（如 <code>/deploy</code>）</td></tr><tr><td><strong>MCP 服务器</strong></td><td>连接外部工具和数据源</td></tr><tr><td><strong>Hooks</strong></td><td>工具调用前后的自动化脚本</td></tr></tbody></table><h3 id="5-2-Skills-开发最佳实践"><a href="#5-2-Skills-开发最佳实践" class="headerlink" title="5.2 Skills 开发最佳实践"></a>5.2 Skills 开发最佳实践</h3><ol><li><strong>从评估开始</strong>：先观察 Agent 在哪些任务上表现不佳，再针对性开发 Skill</li><li><strong>结构化扩展</strong>：当 SKILL.md 变得臃肿时，拆分到多个文件</li><li><strong>从 Claude 视角思考</strong>：关注 name 和 description 的编写，这决定了触发时机</li><li><strong>与 Claude 迭代</strong>：让 Claude 帮助总结成功模式和常见错误</li></ol><h3 id="5-3-安全考虑"><a href="#5-3-安全考虑" class="headerlink" title="5.3 安全考虑"></a>5.3 安全考虑</h3><ul><li><strong>仅安装受信任来源的 Skills</strong></li><li>审查 Skill 中的脚本和外部连接</li><li>使用 <code>allowed-tools</code> 限制工具访问范围</li></ul><hr><h2 id="六、参考资料"><a href="#六、参考资料" class="headerlink" title="六、参考资料"></a>六、参考资料</h2><ul><li><a href="https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills">Anthropic Engineering Blog: Equipping Agents for the Real World with Agent Skills</a></li><li><a href="https://agentskills.io/">Agent Skills 开放标准</a></li><li><a href="https://code.claude.com/docs/zh-CN/skills">Claude Code Skills 文档</a></li><li><a href="https://modelcontextprotocol.io/">Model Context Protocol 官网</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Skills</tag>
      
      <tag>Agent</tag>
      
      <tag>FunctionCalling</tag>
      
      <tag>MCP</tag>
      
      <tag>工具调用</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Advanced-RAG详解</title>
    <link href="/2026/01/13/Advanced-RAG%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/13/Advanced-RAG%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Advanced-RAG-详解"><a href="#Advanced-RAG-详解" class="headerlink" title="Advanced RAG 详解"></a>Advanced RAG 详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>RAG（Retrieval-Augmented Generation，检索增强生成）</strong> 是一种将外部知识检索与大语言模型生成能力相结合的技术架构。</p><p><strong>Advanced RAG（高级 RAG）</strong> 是对基础 RAG（也称 Naive RAG）的系统性优化，通过在检索前、检索中、检索后引入多种优化技术，显著提升检索质量和生成准确性。</p><h3 id="为什么需要-Advanced-RAG？"><a href="#为什么需要-Advanced-RAG？" class="headerlink" title="为什么需要 Advanced RAG？"></a>为什么需要 Advanced RAG？</h3><p>Naive RAG 存在以下问题：</p><table><thead><tr><th>问题类型</th><th>具体表现</th></tr></thead><tbody><tr><td><strong>检索质量差</strong></td><td>召回的文档与问题不相关</td></tr><tr><td><strong>上下文丢失</strong></td><td>分块切断了语义完整性</td></tr><tr><td><strong>幻觉问题</strong></td><td>模型生成与检索内容不符的答案</td></tr><tr><td><strong>效率低下</strong></td><td>检索大量无关内容浪费 Token</td></tr></tbody></table><hr><h2 id="RAG-演进路线"><a href="#RAG-演进路线" class="headerlink" title="RAG 演进路线"></a>RAG 演进路线</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────┐    ┌─────────────┐    ┌─────────────┐<br>│  Naive RAG  │ ─→ │ Advanced RAG│ ─→ │ Modular RAG │<br>│  (基础版)    │    │  (进阶版)    │    │  (模块化版)  │<br>└─────────────┘    └─────────────┘    └─────────────┘<br>       ↓                  ↓                  ↓<br>  简单流程           优化流程            灵活组合<br>  问题多             质量提升            高度定制<br></code></pre></td></tr></table></figure><h3 id="三代-RAG-对比"><a href="#三代-RAG-对比" class="headerlink" title="三代 RAG 对比"></a>三代 RAG 对比</h3><table><thead><tr><th>特性</th><th>Naive RAG</th><th>Advanced RAG</th><th>Modular RAG</th></tr></thead><tbody><tr><td>检索方式</td><td>单一向量检索</td><td>混合检索 + 重排序</td><td>可插拔检索模块</td></tr><tr><td>查询处理</td><td>直接使用原始查询</td><td>查询改写&#x2F;扩展</td><td>自适应查询路由</td></tr><tr><td>上下文处理</td><td>简单拼接</td><td>压缩&#x2F;过滤&#x2F;去重</td><td>动态上下文管理</td></tr><tr><td>索引策略</td><td>固定分块</td><td>多粒度索引</td><td>自定义索引管道</td></tr></tbody></table><hr><h2 id="Advanced-RAG-核心架构"><a href="#Advanced-RAG-核心架构" class="headerlink" title="Advanced RAG 核心架构"></a>Advanced RAG 核心架构</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">用户查询<br>    │<br>    ▼<br>┌───────────────────────────────────────────────────────┐<br>│                    预检索阶段                          │<br>│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │<br>│  │查询改写  │  │查询扩展  │  │查询路由  │  │  HyDE   │  │<br>│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │<br>└───────────────────────────────────────────────────────┘<br>    │<br>    ▼<br>┌───────────────────────────────────────────────────────┐<br>│                     检索阶段                           │<br>│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │<br>│  │混合检索  │  │多路召回  │  │ 重排序  │  │元数据过滤│  │<br>│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │<br>└───────────────────────────────────────────────────────┘<br>    │<br>    ▼<br>┌───────────────────────────────────────────────────────┐<br>│                    后检索阶段                          │<br>│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │<br>│  │上下文压缩│  │ 去重过滤 │  │相关性校验│  │内容重组  │  │<br>│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │<br>└───────────────────────────────────────────────────────┘<br>    │<br>    ▼<br>┌───────────────────────────────────────────────────────┐<br>│                     生成阶段                           │<br>│  ┌─────────────────────────────────────────────────┐  │<br>│  │   <span class="hljs-keyword">LLM </span>根据优化后的上下文生成高质量答案            │  │<br>│  └─────────────────────────────────────────────────┘  │<br>└───────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="预检索优化技术"><a href="#预检索优化技术" class="headerlink" title="预检索优化技术"></a>预检索优化技术</h2><p>预检索阶段的目标是<strong>优化用户查询</strong>，使其更适合检索系统。</p><h3 id="1-查询改写（Query-Rewriting）"><a href="#1-查询改写（Query-Rewriting）" class="headerlink" title="1. 查询改写（Query Rewriting）"></a>1. 查询改写（Query Rewriting）</h3><p>将用户的原始查询改写为更适合检索的形式。</p><p><strong>为什么需要？</strong></p><ul><li>用户查询可能口语化、模糊、有歧义</li><li>检索系统需要精确、明确的查询</li></ul><p><strong>示例：</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs 1c">原始查询<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;那个东西怎么用啊&quot;</span><br>改写后<span class="hljs-punctuation">:</span>   <span class="hljs-string">&quot;请解释该工具的使用方法和操作步骤&quot;</span><br><br>原始查询<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Python 爬虫报错了&quot;</span>  <br>改写后<span class="hljs-punctuation">:</span>   <span class="hljs-string">&quot;Python 爬虫常见错误类型及解决方案&quot;</span><br></code></pre></td></tr></table></figure><p><strong>实现方式：</strong></p><ul><li>使用 LLM 进行查询改写</li><li>基于规则的改写（去停用词、纠错等）</li></ul><h3 id="2-查询扩展（Query-Expansion）"><a href="#2-查询扩展（Query-Expansion）" class="headerlink" title="2. 查询扩展（Query Expansion）"></a>2. 查询扩展（Query Expansion）</h3><p>将单个查询扩展为多个相关查询，增加召回覆盖面。</p><p><strong>技术方案：</strong></p><table><thead><tr><th>方法</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>同义词扩展</strong></td><td>添加同义词</td><td>“机器学习” → “ML”、”Machine Learning”</td></tr><tr><td><strong>上下位词扩展</strong></td><td>添加上位&#x2F;下位概念</td><td>“Python” → “编程语言”、”Python3”</td></tr><tr><td><strong>多角度扩展</strong></td><td>从不同角度生成查询</td><td>原因、方法、比较、应用</td></tr></tbody></table><p><strong>Multi-Query 示例：</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">原始: &quot;如何优化 RAG 系统？&quot;</span><br><br><span class="hljs-section">扩展为:</span><br>1. <span class="hljs-string">&quot;RAG 系统性能优化方法&quot;</span><br>2. <span class="hljs-string">&quot;提升 RAG 检索准确率的技术&quot;</span><br>3. <span class="hljs-string">&quot;RAG 系统常见问题及解决方案&quot;</span><br>4. <span class="hljs-string">&quot;Advanced RAG 最佳实践&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-HyDE（Hypothetical-Document-Embeddings）"><a href="#3-HyDE（Hypothetical-Document-Embeddings）" class="headerlink" title="3. HyDE（Hypothetical Document Embeddings）"></a>3. HyDE（Hypothetical Document Embeddings）</h3><p><strong>核心思想</strong>：先让 LLM 生成一个「假设性答案文档」，再用这个文档去检索。</p><p><strong>为什么有效？</strong></p><ul><li>问题和答案的语义空间不同</li><li>用「答案」检索比用「问题」检索更精准</li></ul><p><strong>流程图：</strong></p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">用户问题<br>    │<br>    ▼<br>┌─────────────────┐<br>│ <span class="hljs-keyword">LLM </span>生成假设答案 │<br>└─────────────────┘<br>    │<br>    ▼<br>┌─────────────────┐<br>│ 对假设答案做嵌入 │<br>└─────────────────┘<br>    │<br>    ▼<br>┌─────────────────┐<br>│ 用嵌入向量检索   │<br>└─────────────────┘<br>    │<br>    ▼<br>  检索结果<br></code></pre></td></tr></table></figure><p><strong>示例：</strong></p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs 1c">问题<span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;什么是向量数据库？&quot;</span><br><br>假设答案（LLM 生成）<span class="hljs-punctuation">:</span><br><span class="hljs-string">&quot;向量数据库是一种专门用于存储和检索高维向量数据的数据库系统。</span><br>它支持相似性搜索，常用于推荐系统、图像搜索、语义搜索等场景。<br>常见的向量数据库包括 Milvus、Pinecone、Weaviate 等。<span class="hljs-string">&quot;</span><br><br>→ 用这段文本的嵌入向量去检索，比直接用问题检索效果更好<br></code></pre></td></tr></table></figure><h3 id="4-查询路由（Query-Routing）"><a href="#4-查询路由（Query-Routing）" class="headerlink" title="4. 查询路由（Query Routing）"></a>4. 查询路由（Query Routing）</h3><p>根据查询类型，将其路由到最合适的检索源或处理流程。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sql">                 用户查询<br>                     │<br>                     ▼<br>              ┌─────────────┐<br>              │  路由判断器  │<br>              └─────────────┘<br>                     │<br>     ┌───────────────┼───────────────┐<br>     ▼               ▼               ▼<br>┌─────────┐    ┌─────────┐    ┌─────────┐<br>│ 向量库  │    │ 知识图谱 │    │ <span class="hljs-keyword">SQL</span>数据库│<br>└─────────┘    └─────────┘    └─────────┘<br></code></pre></td></tr></table></figure><p><strong>路由策略：</strong></p><ul><li><strong>基于关键词</strong>：包含特定关键词走特定通道</li><li><strong>基于 LLM 分类</strong>：让 LLM 判断查询类型</li><li><strong>基于嵌入相似度</strong>：与预设类别嵌入比较</li></ul><hr><h2 id="检索优化技术"><a href="#检索优化技术" class="headerlink" title="检索优化技术"></a>检索优化技术</h2><h3 id="1-混合检索（Hybrid-Search）"><a href="#1-混合检索（Hybrid-Search）" class="headerlink" title="1. 混合检索（Hybrid Search）"></a>1. 混合检索（Hybrid Search）</h3><p>结合<strong>关键词检索</strong>和<strong>向量检索</strong>的优势。</p><table><thead><tr><th>检索方式</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td><strong>关键词检索</strong> (BM25)</td><td>精确匹配、可解释</td><td>无法理解语义</td></tr><tr><td><strong>向量检索</strong> (Embedding)</td><td>语义理解、模糊匹配</td><td>可能丢失关键词</td></tr><tr><td><strong>混合检索</strong></td><td>兼顾精确与语义</td><td>需要融合策略</td></tr></tbody></table><p><strong>融合策略示例（RRF - Reciprocal Rank Fusion）：</strong></p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">RRF_score = Σ 1 / (k + rank_i)<br><br>其中：<br><span class="hljs-bullet">- </span>k 为常数（通常为 60）<br><span class="hljs-bullet">- </span>rank_i 为文档在第 i 个检索结果中的排名<br></code></pre></td></tr></table></figure><h3 id="2-重排序（Reranking）"><a href="#2-重排序（Reranking）" class="headerlink" title="2. 重排序（Reranking）"></a>2. 重排序（Reranking）</h3><p>对初步检索结果进行二次排序，提升相关性。</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">检索结果（<span class="hljs-built_in">Top</span> <span class="hljs-number">100</span>）<br>        │<br>        ▼<br>┌─────────────────┐<br>│   <span class="hljs-variable">Reranker</span> 模型  │<br>│  <span class="hljs-punctuation">(</span><span class="hljs-built_in">Cross</span><span class="hljs-operator">-</span><span class="hljs-variable">Encoder</span><span class="hljs-punctuation">)</span> │<br>└─────────────────┘<br>        │<br>        ▼<br>重排序结果（<span class="hljs-built_in">Top</span> <span class="hljs-number">10</span>）<br></code></pre></td></tr></table></figure><p><strong>常用 Reranker 模型：</strong></p><ul><li><strong>Cohere Rerank</strong></li><li><strong>BGE Reranker</strong></li><li><strong>Jina Reranker</strong></li><li><strong>Cross-Encoder 模型</strong></li></ul><p><strong>Bi-Encoder vs Cross-Encoder：</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Bi-Encoder（用于初检索，快但不够精确）:<br>  Query  →  <span class="hljs-selector-attr">[Encoder]</span>  →  向量<br>  Doc    →  <span class="hljs-selector-attr">[Encoder]</span>  →  向量<br>  相似度 = <span class="hljs-built_in">cosine</span>(Query向量, Doc向量)<br><br>Cross-Encoder（用于重排序，慢但精确）:<br>  <span class="hljs-selector-attr">[Query, Doc]</span> → <span class="hljs-selector-attr">[Encoder]</span> → 相关性分数<br>  直接输出相关性，更准确<br></code></pre></td></tr></table></figure><h3 id="3-多路召回（Multi-way-Retrieval）"><a href="#3-多路召回（Multi-way-Retrieval）" class="headerlink" title="3. 多路召回（Multi-way Retrieval）"></a>3. 多路召回（Multi-way Retrieval）</h3><p>从多个维度同时检索，扩大召回范围。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs">          用户查询<br>              │<br>    ┌─────────┼─────────┐<br>    ▼         ▼         ▼<br>┌───────┐ ┌───────┐ ┌───────┐<br>│语义检索│ │关键词 │ │知识图谱│<br>└───────┘ └───────┘ └───────┘<br>    │         │         │<br>    └─────────┼─────────┘<br>              ▼<br>        ┌─────────┐<br>        │结果融合  │<br>        └─────────┘<br>              │<br>              ▼<br>          最终结果<br></code></pre></td></tr></table></figure><hr><h2 id="索引优化技术"><a href="#索引优化技术" class="headerlink" title="索引优化技术"></a>索引优化技术</h2><h3 id="1-分块策略优化"><a href="#1-分块策略优化" class="headerlink" title="1. 分块策略优化"></a>1. 分块策略优化</h3><p><strong>常见分块方法：</strong></p><table><thead><tr><th>方法</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>固定大小分块</strong></td><td>按字符&#x2F;Token 数切分</td><td>通用场景</td></tr><tr><td><strong>语义分块</strong></td><td>按语义边界切分</td><td>文章、报告</td></tr><tr><td><strong>递归分块</strong></td><td>按标题层级递归切分</td><td>结构化文档</td></tr><tr><td><strong>句子窗口</strong></td><td>检索句子 + 返回周围窗口</td><td>精确定位</td></tr></tbody></table><p><strong>句子窗口（Sentence Window）示例：</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">原始文档:</span><br><span class="hljs-string">&quot;句子1。句子2。句子3。句子4。句子5。&quot;</span><br><br><span class="hljs-section">索引单位: 句子3</span><br><span class="hljs-section">返回内容: 句子2 + 句子3 + 句子4（窗口大小=1）</span><br><br><span class="hljs-section">优势: 索引粒度细，返回上下文完整</span><br></code></pre></td></tr></table></figure><h3 id="2-层次化索引（Hierarchical-Indexing）"><a href="#2-层次化索引（Hierarchical-Indexing）" class="headerlink" title="2. 层次化索引（Hierarchical Indexing）"></a>2. 层次化索引（Hierarchical Indexing）</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs css">                  ┌─────────────┐<br>                  │   文档摘要   │  ← 粗粒度检索<br>                  └─────────────┘<br>                        │<br>        ┌───────────────┼───────────────┐<br>        ▼               ▼               ▼<br>   ┌─────────┐    ┌─────────┐    ┌─────────┐<br>   │ 章节摘要 │    │ 章节摘要 │    │ 章节摘要 │  ← 中粒度<br>   └─────────┘    └─────────┘    └─────────┘<br>        │<br>  ┌─────┼─────┐<br>  ▼     ▼     ▼<br><span class="hljs-selector-attr">[段落]</span> <span class="hljs-selector-attr">[段落]</span> <span class="hljs-selector-attr">[段落]</span>  ← 细粒度检索<br></code></pre></td></tr></table></figure><p><strong>检索流程：</strong></p><ol><li>先用摘要快速定位相关文档</li><li>再深入检索具体段落</li></ol><h3 id="3-父子文档索引（Parent-Child-Indexing）"><a href="#3-父子文档索引（Parent-Child-Indexing）" class="headerlink" title="3. 父子文档索引（Parent-Child Indexing）"></a>3. 父子文档索引（Parent-Child Indexing）</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs makefile">父文档（用于返回，包含完整上下文）<br>├── 子块1（用于检索，精确匹配）<br>├── 子块2<br>└── 子块3<br><br><span class="hljs-section">检索时: 匹配子块</span><br><span class="hljs-section">返回时: 返回父文档</span><br></code></pre></td></tr></table></figure><p><strong>优势：</strong></p><ul><li>检索精确（小块匹配度高）</li><li>上下文完整（返回大块内容）</li></ul><hr><h2 id="后检索优化技术"><a href="#后检索优化技术" class="headerlink" title="后检索优化技术"></a>后检索优化技术</h2><h3 id="1-上下文压缩（Context-Compression）"><a href="#1-上下文压缩（Context-Compression）" class="headerlink" title="1. 上下文压缩（Context Compression）"></a>1. 上下文压缩（Context Compression）</h3><p>移除检索结果中与问题无关的内容，节省 Token。</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs 1c">原始检索结果（<span class="hljs-number">1000</span> Token）<span class="hljs-punctuation">:</span><br><span class="hljs-string">&quot;本文介绍了机器学习的基础知识...（大量背景信息）...</span><br>其中，向量数据库是...（相关内容）...<br>参考文献：...<span class="hljs-string">&quot;</span><br><br>压缩后（<span class="hljs-number">200</span> Token）<span class="hljs-punctuation">:</span><br><span class="hljs-string">&quot;向量数据库是一种专门存储高维向量的数据库...&quot;</span><br><br>压缩率<span class="hljs-punctuation">:</span> <span class="hljs-number">80</span>%<br></code></pre></td></tr></table></figure><p><strong>实现方式：</strong></p><ul><li><strong>LLM 压缩</strong>：让 LLM 提取相关内容</li><li><strong>LLMLingua</strong>：基于困惑度的压缩</li><li><strong>Recomp</strong>：抽取式&#x2F;生成式压缩</li></ul><h3 id="2-去重与过滤"><a href="#2-去重与过滤" class="headerlink" title="2. 去重与过滤"></a>2. 去重与过滤</h3><ul><li><strong>语义去重</strong>：合并语义相似的检索结果</li><li><strong>相关性过滤</strong>：移除相关性低于阈值的结果</li><li><strong>元数据过滤</strong>：按时间、来源等条件过滤</li></ul><h3 id="3-上下文重组"><a href="#3-上下文重组" class="headerlink" title="3. 上下文重组"></a>3. 上下文重组</h3><p>将检索结果按逻辑顺序重组，提升生成质量。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">检索顺序（按相关性）:<br><span class="hljs-bullet">1.</span> 结论段落<br><span class="hljs-bullet">2.</span> 背景段落<br><span class="hljs-bullet">3.</span> 方法段落<br><br>重组顺序（按逻辑）:<br><span class="hljs-bullet">1.</span> 背景段落<br><span class="hljs-bullet">2.</span> 方法段落<br><span class="hljs-bullet">3.</span> 结论段落<br></code></pre></td></tr></table></figure><hr><h2 id="高级-RAG-范式"><a href="#高级-RAG-范式" class="headerlink" title="高级 RAG 范式"></a>高级 RAG 范式</h2><h3 id="1-Self-RAG（自反思-RAG）"><a href="#1-Self-RAG（自反思-RAG）" class="headerlink" title="1. Self-RAG（自反思 RAG）"></a>1. Self-RAG（自反思 RAG）</h3><p>模型在生成过程中<strong>自我评估</strong>是否需要检索、检索结果是否相关、生成是否符合事实。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs css">┌─────────────────────────────────────────────────────┐<br>│                    Self-RAG 流程                     │<br>├─────────────────────────────────────────────────────┤<br>│  <span class="hljs-number">1</span>. <span class="hljs-selector-attr">[Retrieve]</span> 是否需要检索？                        │<br>│     → Yes/No                                        │<br>│                                                     │<br>│  <span class="hljs-number">2</span>. <span class="hljs-selector-attr">[IsRel]</span> 检索结果是否相关？                       │<br>│     → Relevant/Irrelevant                           │<br>│                                                     │<br>│  <span class="hljs-number">3</span>. <span class="hljs-selector-attr">[IsSup]</span> 生成内容是否有检索支持？                 │<br>│     → Fully/Partially/No Support                    │<br>│                                                     │<br>│  <span class="hljs-number">4</span>. <span class="hljs-selector-attr">[IsUse]</span> 生成内容是否有用？                       │<br>│     → <span class="hljs-number">1</span>-<span class="hljs-number">5</span> 分                                        │<br>└─────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="2-CRAG（Corrective-RAG）"><a href="#2-CRAG（Corrective-RAG）" class="headerlink" title="2. CRAG（Corrective RAG）"></a>2. CRAG（Corrective RAG）</h3><p>带有<strong>纠错机制</strong>的 RAG，能够识别并修正检索错误。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs">用户查询<br>    │<br>    ▼<br>┌─────────────┐<br>│   初次检索   │<br>└─────────────┘<br>    │<br>    ▼<br>┌─────────────┐<br>│ 相关性评估  │<br>└─────────────┘<br>    │<br>    ├── 相关 → 直接使用<br>    │<br>    ├── 模糊 → 知识精炼（提取关键信息）<br>    │<br>    └── 不相关 → 触发网络搜索<br>              │<br>              ▼<br>        ┌─────────────┐<br>        │  知识重获取  │<br>        └─────────────┘<br></code></pre></td></tr></table></figure><h3 id="3-RAG-Fusion"><a href="#3-RAG-Fusion" class="headerlink" title="3. RAG Fusion"></a>3. RAG Fusion</h3><p>执行多个改写查询的检索，然后融合结果。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs tap">原始查询<br>    │<br>    ▼<br>┌─────────────┐<br>│ 生成多个改写 │<br>└─────────────┘<br>    │<br>    ├── 改写查询<span class="hljs-number"> 1 </span>→ 检索结果 1<br>    ├── 改写查询<span class="hljs-number"> 2 </span>→ 检索结果 2<br>    ├── 改写查询<span class="hljs-number"> 3 </span>→ 检索结果 3<br>    └── 改写查询<span class="hljs-number"> 4 </span>→ 检索结果 4<br>              │<br>              ▼<br>        ┌─────────────┐<br>        │  RRF 融合   │<br>        └─────────────┘<br>              │<br>              ▼<br>          最终结果<br></code></pre></td></tr></table></figure><hr><h2 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h2><h3 id="检索质量评估"><a href="#检索质量评估" class="headerlink" title="检索质量评估"></a>检索质量评估</h3><table><thead><tr><th>指标</th><th>说明</th><th>公式</th></tr></thead><tbody><tr><td><strong>Recall@K</strong></td><td>Top-K 中包含正确答案的比例</td><td>相关文档数 &#x2F; 总相关文档数</td></tr><tr><td><strong>Precision@K</strong></td><td>Top-K 中相关文档的比例</td><td>相关文档数 &#x2F; K</td></tr><tr><td><strong>MRR</strong></td><td>第一个正确结果的排名倒数</td><td>1 &#x2F; rank</td></tr><tr><td><strong>NDCG</strong></td><td>归一化折损累积增益</td><td>考虑位置的相关性评分</td></tr></tbody></table><h3 id="生成质量评估"><a href="#生成质量评估" class="headerlink" title="生成质量评估"></a>生成质量评估</h3><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td><strong>Faithfulness</strong></td><td>生成内容是否忠于检索结果</td></tr><tr><td><strong>Answer Relevancy</strong></td><td>答案与问题的相关性</td></tr><tr><td><strong>Context Relevancy</strong></td><td>上下文与问题的相关性</td></tr><tr><td><strong>Hallucination Rate</strong></td><td>幻觉比例</td></tr></tbody></table><h3 id="常用评估框架"><a href="#常用评估框架" class="headerlink" title="常用评估框架"></a>常用评估框架</h3><ul><li><strong>RAGAS</strong>：专门用于 RAG 评估的框架</li><li><strong>TruLens</strong>：LLM 应用评估工具</li><li><strong>LangSmith</strong>：LangChain 的评估追踪工具</li></ul><hr><h2 id="技术选型建议"><a href="#技术选型建议" class="headerlink" title="技术选型建议"></a>技术选型建议</h2><h3 id="场景对应方案"><a href="#场景对应方案" class="headerlink" title="场景对应方案"></a>场景对应方案</h3><table><thead><tr><th>场景</th><th>推荐技术</th></tr></thead><tbody><tr><td><strong>精确匹配重要</strong></td><td>混合检索（BM25 + Vector）</td></tr><tr><td><strong>长文档理解</strong></td><td>层次化索引 + 父子文档</td></tr><tr><td><strong>多源数据</strong></td><td>查询路由 + 多路召回</td></tr><tr><td><strong>Token 受限</strong></td><td>上下文压缩 + 重排序</td></tr><tr><td><strong>高准确性要求</strong></td><td>Self-RAG &#x2F; CRAG</td></tr></tbody></table><h3 id="技术栈推荐"><a href="#技术栈推荐" class="headerlink" title="技术栈推荐"></a>技术栈推荐</h3><table><thead><tr><th>组件</th><th>推荐工具</th></tr></thead><tbody><tr><td><strong>向量数据库</strong></td><td>Milvus、Qdrant、Weaviate、Chroma</td></tr><tr><td><strong>Embedding 模型</strong></td><td>BGE、GTE、Jina、OpenAI Embedding</td></tr><tr><td><strong>Reranker</strong></td><td>BGE Reranker、Cohere Rerank</td></tr><tr><td><strong>框架</strong></td><td>LangChain、LlamaIndex、Haystack</td></tr></tbody></table><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Advanced RAG 通过在 RAG 管道的各个阶段引入优化技术，系统性地提升了检索增强生成的效果：</p><ol><li><strong>预检索</strong>：查询改写、扩展、路由、HyDE</li><li><strong>检索</strong>：混合检索、多路召回、重排序</li><li><strong>索引</strong>：分块优化、层次索引、父子文档</li><li><strong>后检索</strong>：上下文压缩、去重、重组</li><li><strong>高级范式</strong>：Self-RAG、CRAG、RAG Fusion</li></ol><p>选择合适的技术组合需要根据具体场景权衡<strong>准确性、延迟、成本</strong>三者的关系。</p><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>RAG 基础</li><li>Agent 架构</li><li>Prompt Engineering</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>LLM</tag>
      
      <tag>RAG</tag>
      
      <tag>Advanced-RAG</tag>
      
      <tag>检索增强生成</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RAG技术详解</title>
    <link href="/2026/01/13/RAG%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/13/RAG%E6%8A%80%E6%9C%AF%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="RAG-技术详解"><a href="#RAG-技术详解" class="headerlink" title="RAG 技术详解"></a>RAG 技术详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>RAG（Retrieval-Augmented Generation，检索增强生成）</strong> 是一种结合信息检索与大语言模型生成能力的技术架构，通过从外部知识库检索相关信息来增强 LLM 的回答质量。</p><h3 id="为什么需要-RAG？"><a href="#为什么需要-RAG？" class="headerlink" title="为什么需要 RAG？"></a>为什么需要 RAG？</h3><table><thead><tr><th>问题</th><th>说明</th><th>RAG 解决方案</th></tr></thead><tbody><tr><td>知识时效性</td><td>LLM 训练数据有截止日期</td><td>实时检索最新文档</td></tr><tr><td>幻觉问题</td><td>LLM 可能编造事实</td><td>基于真实文档生成</td></tr><tr><td>私有知识</td><td>LLM 不了解企业内部数据</td><td>接入私有知识库</td></tr><tr><td>可追溯性</td><td>无法验证答案来源</td><td>提供引用来源</td></tr></tbody></table><h2 id="RAG-学习路线"><a href="#RAG-学习路线" class="headerlink" title="RAG 学习路线"></a>RAG 学习路线</h2><pre><code class=" mermaid">graph TD    A[RAG基础概念] --&gt; B[文档处理]    A --&gt; C[Embedding原理]    B --&gt; D[文本分割策略]    C --&gt; E[向量数据库]    D --&gt; F[检索策略]    E --&gt; F    F --&gt; G[Naive RAG]    G --&gt; H[Advanced RAG]    H --&gt; I[Modular RAG]    I --&gt; J[企业级RAG]        style G fill:#e1f5fe    style H fill:#fff3e0    style I fill:#f3e5f5</code></pre><h3 id="阶段一：基础概念（3-5天）"><a href="#阶段一：基础概念（3-5天）" class="headerlink" title="阶段一：基础概念（3-5天）"></a>阶段一：基础概念（3-5天）</h3><table><thead><tr><th>学习内容</th><th>时间</th><th>优先级</th><th>产出</th></tr></thead><tbody><tr><td>RAG 核心原理</td><td>1天</td><td>⭐⭐⭐</td><td>理解检索+生成流程</td></tr><tr><td>Embedding 模型选型</td><td>1天</td><td>⭐⭐⭐</td><td>掌握主流模型差异</td></tr><tr><td>向量相似度计算</td><td>1天</td><td>⭐⭐</td><td>余弦相似度、欧氏距离</td></tr><tr><td>向量数据库入门</td><td>2天</td><td>⭐⭐⭐</td><td>完成 Milvus&#x2F;Chroma 部署</td></tr></tbody></table><h3 id="阶段二：核心流程实现（1-2周）"><a href="#阶段二：核心流程实现（1-2周）" class="headerlink" title="阶段二：核心流程实现（1-2周）"></a>阶段二：核心流程实现（1-2周）</h3><table><thead><tr><th>学习内容</th><th>时间</th><th>优先级</th><th>产出</th></tr></thead><tbody><tr><td>文档加载器</td><td>2天</td><td>⭐⭐⭐</td><td>PDF&#x2F;Word&#x2F;网页解析</td></tr><tr><td>文本分割策略</td><td>2天</td><td>⭐⭐⭐</td><td>理解 Chunk 策略</td></tr><tr><td>索引构建</td><td>2天</td><td>⭐⭐⭐</td><td>完成文档向量化</td></tr><tr><td>检索实现</td><td>2天</td><td>⭐⭐⭐</td><td>实现相似度搜索</td></tr><tr><td>Prompt 模板设计</td><td>1天</td><td>⭐⭐</td><td>设计 RAG 专用模板</td></tr></tbody></table><h3 id="阶段三：进阶优化（2-3周）"><a href="#阶段三：进阶优化（2-3周）" class="headerlink" title="阶段三：进阶优化（2-3周）"></a>阶段三：进阶优化（2-3周）</h3><table><thead><tr><th>学习内容</th><th>时间</th><th>优先级</th><th>产出</th></tr></thead><tbody><tr><td>混合检索</td><td>3天</td><td>⭐⭐⭐</td><td>向量+关键词检索</td></tr><tr><td>重排序（Rerank）</td><td>2天</td><td>⭐⭐⭐</td><td>提升检索精度</td></tr><tr><td>查询改写</td><td>2天</td><td>⭐⭐</td><td>HyDE、Query Expansion</td></tr><tr><td>多轮对话管理</td><td>2天</td><td>⭐⭐</td><td>对话历史处理</td></tr><tr><td>评估指标</td><td>2天</td><td>⭐⭐⭐</td><td>Recall、MRR、RAGAS</td></tr></tbody></table><h3 id="阶段四：生产级实践（持续）"><a href="#阶段四：生产级实践（持续）" class="headerlink" title="阶段四：生产级实践（持续）"></a>阶段四：生产级实践（持续）</h3><ul><li>分布式向量存储</li><li>增量索引更新</li><li>多租户隔离</li><li>缓存策略</li><li>监控与可观测性</li></ul><h2 id="RAG-核心架构"><a href="#RAG-核心架构" class="headerlink" title="RAG 核心架构"></a>RAG 核心架构</h2><h3 id="标准流程"><a href="#标准流程" class="headerlink" title="标准流程"></a>标准流程</h3><pre><code class=" mermaid">graph LR    subgraph 离线索引        A[原始文档] --&gt; B[文档加载]        B --&gt; C[文本分割]        C --&gt; D[Embedding]        D --&gt; E[(向量数据库)]    end        subgraph 在线查询        F[用户问题] --&gt; G[Query Embedding]        G --&gt; H[向量检索]        E --&gt; H        H --&gt; I[相关文档]        I --&gt; J[Prompt构建]        F --&gt; J        J --&gt; K[LLM生成]        K --&gt; L[回答]    end</code></pre><h3 id="核心组件说明"><a href="#核心组件说明" class="headerlink" title="核心组件说明"></a>核心组件说明</h3><table><thead><tr><th>组件</th><th>作用</th><th>常用工具</th></tr></thead><tbody><tr><td>Document Loader</td><td>加载多种格式文档</td><td>LangChain Loaders, Unstructured</td></tr><tr><td>Text Splitter</td><td>文本分块</td><td>RecursiveCharacterTextSplitter</td></tr><tr><td>Embedding Model</td><td>文本向量化</td><td>OpenAI Ada, BGE, M3E</td></tr><tr><td>Vector Store</td><td>向量存储与检索</td><td>Milvus, Pinecone, Chroma</td></tr><tr><td>Retriever</td><td>检索策略封装</td><td>MultiQueryRetriever, SelfQueryRetriever</td></tr><tr><td>LLM</td><td>答案生成</td><td>GPT-4, Claude, 通义千问</td></tr></tbody></table><h2 id="RAG-技术演进对比"><a href="#RAG-技术演进对比" class="headerlink" title="RAG 技术演进对比"></a>RAG 技术演进对比</h2><h3 id="三代-RAG-架构对比"><a href="#三代-RAG-架构对比" class="headerlink" title="三代 RAG 架构对比"></a>三代 RAG 架构对比</h3><table><thead><tr><th>维度</th><th>Naive RAG</th><th>Advanced RAG</th><th>Modular RAG</th></tr></thead><tbody><tr><td><strong>架构</strong></td><td>线性流水线</td><td>优化流水线</td><td>模块化组合</td></tr><tr><td><strong>索引</strong></td><td>简单分块</td><td>层次索引、父子块</td><td>多种索引策略</td></tr><tr><td><strong>检索</strong></td><td>单次向量检索</td><td>混合检索 + 重排</td><td>多路召回 + 融合</td></tr><tr><td><strong>生成</strong></td><td>直接拼接上下文</td><td>压缩&#x2F;筛选上下文</td><td>自适应生成</td></tr><tr><td><strong>适用场景</strong></td><td>原型验证</td><td>生产环境</td><td>复杂企业场景</td></tr></tbody></table><h3 id="Naive-RAG"><a href="#Naive-RAG" class="headerlink" title="Naive RAG"></a>Naive RAG</h3><p>最基础的 RAG 实现，流程简单但存在明显缺陷：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">用户问题 → <span class="hljs-variable">Embedding</span> → 向量检索 → <span class="hljs-built_in">Top</span><span class="hljs-operator">-</span><span class="hljs-built_in">K</span> 文档 → 拼接 <span class="hljs-variable">Prompt</span> → <span class="hljs-variable">LLM</span> 回答<br></code></pre></td></tr></table></figure><p><strong>优点</strong>：实现简单、快速上手<br><strong>缺点</strong>：</p><ul><li>检索质量依赖分块策略</li><li>无法处理复杂查询</li><li>上下文利用率低</li></ul><h3 id="Advanced-RAG"><a href="#Advanced-RAG" class="headerlink" title="Advanced RAG"></a>Advanced RAG</h3><p>在 Naive RAG 基础上增加预处理和后处理优化：</p><pre><code class=" mermaid">graph TD    subgraph 预检索优化        A[用户问题] --&gt; B[查询改写]        B --&gt; C[查询扩展]    end        subgraph 检索优化        C --&gt; D[多路召回]        D --&gt; E[重排序Rerank]    end        subgraph 后处理优化        E --&gt; F[上下文压缩]        F --&gt; G[LLM生成]    end</code></pre><p><strong>核心优化点</strong>：</p><table><thead><tr><th>优化阶段</th><th>技术</th><th>说明</th></tr></thead><tbody><tr><td>预检索</td><td>Query Rewriting</td><td>重写用户问题提升检索效果</td></tr><tr><td>预检索</td><td>HyDE</td><td>生成假设文档进行检索</td></tr><tr><td>检索</td><td>Hybrid Search</td><td>向量 + BM25 混合检索</td></tr><tr><td>检索</td><td>Reranking</td><td>使用交叉编码器重排</td></tr><tr><td>后检索</td><td>Context Compression</td><td>压缩冗余上下文</td></tr><tr><td>后检索</td><td>Self-RAG</td><td>自我反思与校验</td></tr></tbody></table><h3 id="Modular-RAG"><a href="#Modular-RAG" class="headerlink" title="Modular RAG"></a>Modular RAG</h3><p>将 RAG 拆解为可插拔模块，支持灵活组合：</p><table><thead><tr><th>模块类型</th><th>可选组件</th></tr></thead><tbody><tr><td>索引模块</td><td>层次索引、知识图谱索引、摘要索引</td></tr><tr><td>检索模块</td><td>稀疏检索、稠密检索、混合检索</td></tr><tr><td>重排模块</td><td>Cross-Encoder、ColBERT、LLM Rerank</td></tr><tr><td>生成模块</td><td>单次生成、迭代优化、多步推理</td></tr></tbody></table><h2 id="主流-RAG-框架对比"><a href="#主流-RAG-框架对比" class="headerlink" title="主流 RAG 框架对比"></a>主流 RAG 框架对比</h2><h3 id="Python-生态"><a href="#Python-生态" class="headerlink" title="Python 生态"></a>Python 生态</h3><table><thead><tr><th>框架</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>LangChain</strong></td><td>功能全面、生态丰富</td><td>通用 RAG 开发</td></tr><tr><td><strong>LlamaIndex</strong></td><td>专注数据索引与检索</td><td>复杂文档场景</td></tr><tr><td><strong>Haystack</strong></td><td>模块化设计、企业级</td><td>生产环境</td></tr><tr><td><strong>RAGFlow</strong></td><td>开箱即用、可视化</td><td>快速部署</td></tr></tbody></table><h3 id="Java-生态"><a href="#Java-生态" class="headerlink" title="Java 生态"></a>Java 生态</h3><table><thead><tr><th>框架</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Spring AI</strong></td><td>Spring 生态集成</td><td>Spring Boot 项目</td></tr><tr><td><strong>LangChain4j</strong></td><td>功能对标 LangChain</td><td>Java 全栈开发</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Spring AI RAG 示例</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagService</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VectorStore vectorStore;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">query</span><span class="hljs-params">(String question)</span> &#123;<br>        <span class="hljs-comment">// 1. 向量检索</span><br>        List&lt;Document&gt; docs = vectorStore.similaritySearch(<br>            SearchRequest.query(question).withTopK(<span class="hljs-number">5</span>)<br>        );<br>        <br>        <span class="hljs-comment">// 2. 构建上下文</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> docs.stream()<br>            .map(Document::getContent)<br>            .collect(Collectors.joining(<span class="hljs-string">&quot;\n\n&quot;</span>));<br>        <br>        <span class="hljs-comment">// 3. 调用 LLM</span><br>        <span class="hljs-keyword">return</span> chatClient.prompt()<br>            .system(<span class="hljs-string">&quot;基于以下上下文回答问题：\n&quot;</span> + context)<br>            .user(question)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Embedding-模型对比"><a href="#Embedding-模型对比" class="headerlink" title="Embedding 模型对比"></a>Embedding 模型对比</h2><table><thead><tr><th>模型</th><th>厂商</th><th>维度</th><th>中文支持</th><th>特点</th></tr></thead><tbody><tr><td>text-embedding-3-large</td><td>OpenAI</td><td>3072</td><td>一般</td><td>综合能力强</td></tr><tr><td>text-embedding-3-small</td><td>OpenAI</td><td>1536</td><td>一般</td><td>性价比高</td></tr><tr><td>BGE-large-zh</td><td>BAAI</td><td>1024</td><td>⭐⭐⭐</td><td>中文首选</td></tr><tr><td>M3E-base</td><td>Moka</td><td>768</td><td>⭐⭐⭐</td><td>轻量中文模型</td></tr><tr><td>bge-m3</td><td>BAAI</td><td>1024</td><td>⭐⭐⭐</td><td>多语言、多粒度</td></tr><tr><td>jina-embeddings-v2</td><td>Jina AI</td><td>768</td><td>⭐⭐</td><td>长文本支持</td></tr></tbody></table><blockquote><p><strong>💡 提示: 选型建议</strong></p><ul><li>中文场景优先使用 <strong>BGE</strong> 或 <strong>M3E</strong></li><li>多语言场景使用 <strong>bge-m3</strong></li><li>追求效果使用 <strong>OpenAI text-embedding-3-large</strong></li></ul></blockquote><h2 id="向量数据库对比"><a href="#向量数据库对比" class="headerlink" title="向量数据库对比"></a>向量数据库对比</h2><table><thead><tr><th>数据库</th><th>类型</th><th>特点</th><th>推荐场景</th></tr></thead><tbody><tr><td><strong>Milvus</strong></td><td>开源</td><td>高性能、分布式、功能全面</td><td>生产环境首选</td></tr><tr><td><strong>Pinecone</strong></td><td>托管</td><td>零运维、简单易用</td><td>快速原型、小团队</td></tr><tr><td><strong>Chroma</strong></td><td>开源</td><td>轻量嵌入式、开发友好</td><td>本地开发、测试</td></tr><tr><td><strong>Weaviate</strong></td><td>开源</td><td>GraphQL、模块化</td><td>复杂查询场景</td></tr><tr><td><strong>Qdrant</strong></td><td>开源</td><td>Rust 实现、高性能</td><td>高并发场景</td></tr><tr><td><strong>pgvector</strong></td><td>插件</td><td>PostgreSQL 扩展</td><td>已有 PG 环境</td></tr></tbody></table><h2 id="检索策略对比"><a href="#检索策略对比" class="headerlink" title="检索策略对比"></a>检索策略对比</h2><table><thead><tr><th>策略</th><th>原理</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>稀疏检索（BM25）</strong></td><td>词频统计</td><td>精确匹配、可解释</td><td>语义理解弱</td></tr><tr><td><strong>稠密检索（向量）</strong></td><td>语义相似度</td><td>语义理解强</td><td>可能丢失关键词</td></tr><tr><td><strong>混合检索</strong></td><td>两者融合</td><td>兼顾精确与语义</td><td>需要调权重</td></tr><tr><td><strong>多向量检索</strong></td><td>段落+摘要多向量</td><td>多粒度匹配</td><td>索引膨胀</td></tr></tbody></table><h3 id="混合检索示例"><a href="#混合检索示例" class="headerlink" title="混合检索示例"></a>混合检索示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> langchain.retrievers <span class="hljs-keyword">import</span> EnsembleRetriever<br><span class="hljs-keyword">from</span> langchain_community.retrievers <span class="hljs-keyword">import</span> BM25Retriever<br><br><span class="hljs-comment"># BM25 稀疏检索</span><br>bm25_retriever = BM25Retriever.from_documents(documents)<br>bm25_retriever.k = <span class="hljs-number">5</span><br><br><span class="hljs-comment"># 向量稠密检索</span><br>vector_retriever = vectorstore.as_retriever(search_kwargs=&#123;<span class="hljs-string">&quot;k&quot;</span>: <span class="hljs-number">5</span>&#125;)<br><br><span class="hljs-comment"># 混合检索（权重 0.5:0.5）</span><br>ensemble_retriever = EnsembleRetriever(<br>    retrievers=[bm25_retriever, vector_retriever],<br>    weights=[<span class="hljs-number">0.5</span>, <span class="hljs-number">0.5</span>]<br>)<br></code></pre></td></tr></table></figure><h2 id="文本分割策略"><a href="#文本分割策略" class="headerlink" title="文本分割策略"></a>文本分割策略</h2><table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td>固定长度分割</td><td>按字符数切分</td><td>简单文本</td></tr><tr><td>递归字符分割</td><td>按分隔符层次切分</td><td>通用文档</td></tr><tr><td>语义分割</td><td>按语义边界切分</td><td>高质量要求</td></tr><tr><td>文档结构分割</td><td>按标题&#x2F;章节切分</td><td>结构化文档</td></tr><tr><td>父子块策略</td><td>小块检索、大块返回</td><td>上下文完整性</td></tr></tbody></table><blockquote><p><strong>⚠️ 重要: 分块要点</strong></p><ul><li><strong>Chunk Size</strong>：通常 500-1000 字符</li><li><strong>Overlap</strong>：建议 10%-20% 重叠</li><li><strong>保持语义完整</strong>：避免句子被切断</li></ul></blockquote><h2 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h2><h3 id="检索质量"><a href="#检索质量" class="headerlink" title="检索质量"></a>检索质量</h3><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>Recall@K</td><td>Top-K 中包含正确文档的比例</td></tr><tr><td>MRR</td><td>正确文档排名的倒数均值</td></tr><tr><td>NDCG</td><td>归一化折损累积增益</td></tr></tbody></table><h3 id="生成质量"><a href="#生成质量" class="headerlink" title="生成质量"></a>生成质量</h3><table><thead><tr><th>指标</th><th>说明</th></tr></thead><tbody><tr><td>Faithfulness</td><td>答案是否忠于检索内容</td></tr><tr><td>Answer Relevancy</td><td>答案与问题的相关性</td></tr><tr><td>Context Precision</td><td>上下文的精确率</td></tr><tr><td>Context Recall</td><td>上下文的召回率</td></tr></tbody></table><blockquote><p><strong>📝 注意: RAGAS 框架</strong><br>推荐使用 <strong>RAGAS</strong> 进行端到端 RAG 评估，支持自动化评估上述指标</p></blockquote><h2 id="常见问题与优化"><a href="#常见问题与优化" class="headerlink" title="常见问题与优化"></a>常见问题与优化</h2><table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>检索不到相关文档</td><td>查询与文档语义差距大</td><td>查询改写、HyDE</td></tr><tr><td>检索到但排名低</td><td>向量相似度不准</td><td>添加 Reranker</td></tr><tr><td>上下文超长</td><td>检索文档过多</td><td>上下文压缩、摘要</td></tr><tr><td>回答不准确</td><td>噪声文档干扰</td><td>提高检索阈值、过滤</td></tr><tr><td>无法回答最新问题</td><td>知识库未更新</td><td>增量索引更新</td></tr></tbody></table><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>大模型学习路线</li><li>LLM应用开发</li><li>Prompt Engineering详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>RAG</tag>
      
      <tag>检索增强生成</tag>
      
      <tag>向量数据库</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AQS原理详解</title>
    <link href="/2026/01/12/AQS%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/AQS%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="AQS-原理详解"><a href="#AQS-原理详解" class="headerlink" title="AQS 原理详解"></a>AQS 原理详解</h1><blockquote><p><strong>💡 提示: 知识图谱</strong><br>查看 AQS知识图谱 获取可视化知识结构</p></blockquote><h2 id="什么是-AQS？"><a href="#什么是-AQS？" class="headerlink" title="什么是 AQS？"></a>什么是 AQS？</h2><p><strong>AQS</strong>（AbstractQueuedSynchronizer，抽象队列同步器）是 Java 并发包 <code>java.util.concurrent.locks</code> 中的核心基础框架。</p><h3 id="一句话理解"><a href="#一句话理解" class="headerlink" title="一句话理解"></a>一句话理解</h3><blockquote><p>AQS 就像一个<strong>排队系统</strong>：想要获取资源的线程，如果资源被占用，就乖乖排队等待；资源释放后，排在最前面的线程被唤醒去获取资源。</p></blockquote><h3 id="为什么需要-AQS？"><a href="#为什么需要-AQS？" class="headerlink" title="为什么需要 AQS？"></a>为什么需要 AQS？</h3><p>在 AQS 出现之前，如果我们想实现一个锁或者同步器，需要自己处理：</p><ul><li>线程的阻塞与唤醒</li><li>等待队列的维护</li><li>状态的管理</li></ul><p>AQS 把这些<strong>通用逻辑</strong>抽取出来，我们只需要关注<strong>资源的获取和释放规则</strong>即可。</p><hr><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="1-State（同步状态）"><a href="#1-State（同步状态）" class="headerlink" title="1. State（同步状态）"></a>1. State（同步状态）</h3><p>AQS 使用一个 <code>int</code> 类型的变量 <code>state</code> 来表示同步状态：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> state;<br></code></pre></td></tr></table></figure><table><thead><tr><th>同步器类型</th><th>state 含义</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>0 表示未锁定，&gt;0 表示锁定次数（可重入）</td></tr><tr><td>Semaphore</td><td>表示可用的许可数量</td></tr><tr><td>CountDownLatch</td><td>表示需要等待的计数</td></tr></tbody></table><h3 id="2-CLH-队列（等待队列）"><a href="#2-CLH-队列（等待队列）" class="headerlink" title="2. CLH 队列（等待队列）"></a>2. CLH 队列（等待队列）</h3><p>当线程获取资源失败时，会被包装成一个 <strong>Node 节点</strong>，加入到一个 <strong>FIFO 双向队列</strong> 中等待。</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">     +------+  prev +------+  prev +------+<br>head |<span class="hljs-string">      </span>|<span class="hljs-string"> &lt;---- </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> &lt;---- </span>|<span class="hljs-string">      </span>|<span class="hljs-string">  tail</span><br><span class="hljs-string">     </span>|<span class="hljs-string"> Node </span>|<span class="hljs-string">       </span>|<span class="hljs-string"> Node </span>|<span class="hljs-string">       </span>|<span class="hljs-string"> Node </span>|<br>     |<span class="hljs-string">      </span>|<span class="hljs-string"> ----&gt; </span>|<span class="hljs-string">      </span>|<span class="hljs-string"> ----&gt; </span>|<span class="hljs-string">      </span>|<br>     +------+  next +------+  next +------+<br></code></pre></td></tr></table></figure><h3 id="3-Node-节点"><a href="#3-Node-节点" class="headerlink" title="3. Node 节点"></a>3. Node 节点</h3><p>每个等待的线程都被封装成一个 Node：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Node</span> &#123;<br>    <span class="hljs-comment">// 等待状态</span><br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> waitStatus;<br>    <span class="hljs-comment">// 前驱节点</span><br>    <span class="hljs-keyword">volatile</span> Node prev;<br>    <span class="hljs-comment">// 后继节点</span><br>    <span class="hljs-keyword">volatile</span> Node next;<br>    <span class="hljs-comment">// 等待的线程</span><br>    <span class="hljs-keyword">volatile</span> Thread thread;<br>    <span class="hljs-comment">// 共享模式 or 独占模式</span><br>    Node nextWaiter;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>waitStatus 的取值：</strong></p><table><thead><tr><th>值</th><th>常量名</th><th>含义</th></tr></thead><tbody><tr><td>0</td><td>-</td><td>初始状态</td></tr><tr><td>1</td><td>CANCELLED</td><td>线程已取消</td></tr><tr><td>-1</td><td>SIGNAL</td><td>后继节点需要被唤醒</td></tr><tr><td>-2</td><td>CONDITION</td><td>在条件队列中等待</td></tr><tr><td>-3</td><td>PROPAGATE</td><td>共享模式下传播唤醒</td></tr></tbody></table><hr><h2 id="两种资源共享模式"><a href="#两种资源共享模式" class="headerlink" title="两种资源共享模式"></a>两种资源共享模式</h2><h3 id="独占模式（Exclusive）"><a href="#独占模式（Exclusive）" class="headerlink" title="独占模式（Exclusive）"></a>独占模式（Exclusive）</h3><p><strong>同一时刻只有一个线程能获取资源</strong></p><p>典型实现：<code>ReentrantLock</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">线程<span class="hljs-selector-tag">A</span>获取锁 → 成功，执行业务<br>线程<span class="hljs-selector-tag">B</span>获取锁 → 失败，进入队列等待<br>线程C获取锁 → 失败，进入队列等待<br>线程<span class="hljs-selector-tag">A</span>释放锁 → 唤醒线程<span class="hljs-selector-tag">B</span><br></code></pre></td></tr></table></figure><h3 id="共享模式（Shared）"><a href="#共享模式（Shared）" class="headerlink" title="共享模式（Shared）"></a>共享模式（Shared）</h3><p><strong>同一时刻可以有多个线程获取资源</strong></p><p>典型实现：<code>Semaphore</code>、<code>CountDownLatch</code>、<code>ReadWriteLock</code>（读锁）</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">Semaphore</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span> - 允许<span class="hljs-number">3</span>个线程同时访问<br>线程A获取 → 成功，剩余<span class="hljs-number">2</span>个许可<br>线程B获取 → 成功，剩余<span class="hljs-number">1</span>个许可<br>线程C获取 → 成功，剩余<span class="hljs-number">0</span>个许可<br>线程D获取 → 失败，进入队列等待<br></code></pre></td></tr></table></figure><hr><h2 id="核心方法解析"><a href="#核心方法解析" class="headerlink" title="核心方法解析"></a>核心方法解析</h2><h3 id="需要子类实现的方法"><a href="#需要子类实现的方法" class="headerlink" title="需要子类实现的方法"></a>需要子类实现的方法</h3><p>AQS 采用<strong>模板方法模式</strong>，子类需要实现以下方法：</p><table><thead><tr><th>方法</th><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>tryAcquire(int)</code></td><td>独占</td><td>尝试获取资源</td></tr><tr><td><code>tryRelease(int)</code></td><td>独占</td><td>尝试释放资源</td></tr><tr><td><code>tryAcquireShared(int)</code></td><td>共享</td><td>尝试获取共享资源</td></tr><tr><td><code>tryReleaseShared(int)</code></td><td>共享</td><td>尝试释放共享资源</td></tr><tr><td><code>isHeldExclusively()</code></td><td>-</td><td>是否独占持有</td></tr></tbody></table><h3 id="AQS-提供的模板方法"><a href="#AQS-提供的模板方法" class="headerlink" title="AQS 提供的模板方法"></a>AQS 提供的模板方法</h3><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>acquire(int)</code></td><td>独占式获取（会阻塞）</td></tr><tr><td><code>acquireInterruptibly(int)</code></td><td>独占式获取（可中断）</td></tr><tr><td><code>tryAcquireNanos(int, long)</code></td><td>独占式获取（带超时）</td></tr><tr><td><code>release(int)</code></td><td>独占式释放</td></tr><tr><td><code>acquireShared(int)</code></td><td>共享式获取</td></tr><tr><td><code>releaseShared(int)</code></td><td>共享式释放</td></tr></tbody></table><hr><h2 id="独占模式源码分析"><a href="#独占模式源码分析" class="headerlink" title="独占模式源码分析"></a>独占模式源码分析</h2><h3 id="acquire-获取资源"><a href="#acquire-获取资源" class="headerlink" title="acquire() - 获取资源"></a>acquire() - 获取资源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">acquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!tryAcquire(arg) &amp;&amp;<br>        acquireQueued(addWaiter(Node.EXCLUSIVE), arg))<br>        selfInterrupt();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>执行流程：</strong></p><pre><code class=" mermaid">flowchart TD    A[调用 acquire] --&gt; B&#123;tryAcquire 尝试获取&#125;    B --&gt;|成功| C[直接返回，获取到资源]    B --&gt;|失败| D[addWaiter 创建节点加入队列]    D --&gt; E[acquireQueued 在队列中自旋等待]    E --&gt; F&#123;是否被中断过&#125;    F --&gt;|是| G[selfInterrupt 补上中断]    F --&gt;|否| H[返回]</code></pre><h3 id="addWaiter-加入等待队列"><a href="#addWaiter-加入等待队列" class="headerlink" title="addWaiter() - 加入等待队列"></a>addWaiter() - 加入等待队列</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Node <span class="hljs-title function_">addWaiter</span><span class="hljs-params">(Node mode)</span> &#123;<br>    <span class="hljs-type">Node</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>(Thread.currentThread(), mode);<br>    <span class="hljs-comment">// 快速尝试在尾部添加</span><br>    <span class="hljs-type">Node</span> <span class="hljs-variable">pred</span> <span class="hljs-operator">=</span> tail;<br>    <span class="hljs-keyword">if</span> (pred != <span class="hljs-literal">null</span>) &#123;<br>        node.prev = pred;<br>        <span class="hljs-keyword">if</span> (compareAndSetTail(pred, node)) &#123;<br>            pred.next = node;<br>            <span class="hljs-keyword">return</span> node;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 快速添加失败，进入完整入队流程</span><br>    enq(node);<br>    <span class="hljs-keyword">return</span> node;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="acquireQueued-队列中等待获取"><a href="#acquireQueued-队列中等待获取" class="headerlink" title="acquireQueued() - 队列中等待获取"></a>acquireQueued() - 队列中等待获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">acquireQueued</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Node node, <span class="hljs-type">int</span> arg)</span> &#123;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">failed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">interrupted</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (;;) &#123;  <span class="hljs-comment">// 自旋</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Node</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> node.predecessor();<br>            <span class="hljs-comment">// 只有前驱是head才有资格尝试获取</span><br>            <span class="hljs-keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;<br>                setHead(node);<br>                p.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// help GC</span><br>                failed = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">return</span> interrupted;<br>            &#125;<br>            <span class="hljs-comment">// 判断是否需要阻塞</span><br>            <span class="hljs-keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;<br>                parkAndCheckInterrupt())<br>                interrupted = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (failed)<br>            cancelAcquire(node);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>关键点：</strong></p><ol><li>只有<strong>前驱节点是 head</strong> 的节点才有资格尝试获取资源</li><li>获取失败后会调用 <code>LockSupport.park()</code> 阻塞线程</li><li>被唤醒后继续自旋尝试获取</li></ol><h3 id="release-释放资源"><a href="#release-释放资源" class="headerlink" title="release() - 释放资源"></a>release() - 释放资源</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">release</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>    <span class="hljs-keyword">if</span> (tryRelease(arg)) &#123;<br>        <span class="hljs-type">Node</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> head;<br>        <span class="hljs-keyword">if</span> (h != <span class="hljs-literal">null</span> &amp;&amp; h.waitStatus != <span class="hljs-number">0</span>)<br>            unparkSuccessor(h);  <span class="hljs-comment">// 唤醒后继节点</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="图解：完整的获取-释放流程"><a href="#图解：完整的获取-释放流程" class="headerlink" title="图解：完整的获取-释放流程"></a>图解：完整的获取-释放流程</h2><h3 id="场景：三个线程竞争一把锁"><a href="#场景：三个线程竞争一把锁" class="headerlink" title="场景：三个线程竞争一把锁"></a>场景：三个线程竞争一把锁</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">初始状态：state = 0，队列为空<br><br><span class="hljs-section">=== 线程A 获取锁 ===</span><br>1. tryAcquire(1) → CAS(0, 1) 成功<br>2. state = 1，线程A持有锁<br>3. 队列仍为空<br><br><span class="hljs-section">=== 线程B 获取锁 ===</span><br>1. tryAcquire(1) → 失败（state=1）<br>2. addWaiter() → 创建Node(B)，初始化队列<br><span class="hljs-code">   </span><br><span class="hljs-code">   +------+      +------+</span><br><span class="hljs-code">   | head | ---&gt; | B    |</span><br><span class="hljs-code">   | 空   |      | 等待 |</span><br><span class="hljs-code">   +------+      +------+</span><br><span class="hljs-code">   </span><br>3. acquireQueued() → park阻塞<br><br><span class="hljs-section">=== 线程C 获取锁 ===</span><br>1. tryAcquire(1) → 失败<br>2. addWaiter() → 创建Node(C)加入队尾<br><span class="hljs-code">   </span><br><span class="hljs-code">   +------+      +------+      +------+</span><br><span class="hljs-code">   | head | ---&gt; | B    | ---&gt; | C    |</span><br><span class="hljs-code">   | 空   |      | 等待 |      | 等待 |</span><br><span class="hljs-code">   +------+      +------+      +------+</span><br><span class="hljs-code">   </span><br>3. acquireQueued() → park阻塞<br><br><span class="hljs-section">=== 线程A 释放锁 ===</span><br>1. tryRelease(1) → state = 0<br>2. unparkSuccessor(head) → 唤醒线程B<br>3. 线程B被唤醒，tryAcquire成功<br>4. 线程B成为新的head<br><span class="hljs-code">   </span><br><span class="hljs-code">   +------+      +------+</span><br><span class="hljs-code">   | B    | ---&gt; | C    |</span><br><span class="hljs-code">   | head |      | 等待 |</span><br><span class="hljs-code">   +------+      +------+</span><br></code></pre></td></tr></table></figure><hr><h2 id="实战：手写一个简单的互斥锁"><a href="#实战：手写一个简单的互斥锁" class="headerlink" title="实战：手写一个简单的互斥锁"></a>实战：手写一个简单的互斥锁</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLock</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Sync</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sync</span>();<br>    <br>    <span class="hljs-comment">// 继承AQS</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Sync</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractQueuedSynchronizer</span> &#123;<br>        <br>        <span class="hljs-comment">// 尝试获取锁</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>            <span class="hljs-comment">// CAS 将 state 从 0 改为 1</span><br>            <span class="hljs-keyword">if</span> (compareAndSetState(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-comment">// 设置当前线程为独占线程</span><br>                setExclusiveOwnerThread(Thread.currentThread());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 尝试释放锁</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryRelease</span><span class="hljs-params">(<span class="hljs-type">int</span> arg)</span> &#123;<br>            <span class="hljs-keyword">if</span> (getState() == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalMonitorStateException</span>();<br>            &#125;<br>            <span class="hljs-comment">// 清除独占线程</span><br>            setExclusiveOwnerThread(<span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">// 释放锁</span><br>            setState(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 是否独占持有</span><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHeldExclusively</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> getExclusiveOwnerThread() == Thread.currentThread();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lock</span><span class="hljs-params">()</span> &#123;<br>        sync.acquire(<span class="hljs-number">1</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>        sync.release(<span class="hljs-number">1</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> sync.tryAcquire(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>使用示例：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">SimpleLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleLock</span>();<br><br>lock.lock();<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 临界区代码</span><br>    System.out.println(<span class="hljs-string">&quot;获取到锁，执行业务逻辑&quot;</span>);<br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    lock.unlock();<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="AQS-的经典实现类"><a href="#AQS-的经典实现类" class="headerlink" title="AQS 的经典实现类"></a>AQS 的经典实现类</h2><table><thead><tr><th>实现类</th><th>模式</th><th>说明</th></tr></thead><tbody><tr><td>ReentrantLock</td><td>独占</td><td>可重入互斥锁</td></tr><tr><td>ReentrantReadWriteLock</td><td>共享+独占</td><td>读写锁</td></tr><tr><td>CountDownLatch</td><td>共享</td><td>倒计时门闩</td></tr><tr><td>Semaphore</td><td>共享</td><td>信号量</td></tr><tr><td>CyclicBarrier</td><td>-</td><td>循环栅栏（内部用ReentrantLock）</td></tr></tbody></table><hr><h2 id="核心要点总结"><a href="#核心要点总结" class="headerlink" title="核心要点总结"></a>核心要点总结</h2><h3 id="AQS-的设计精髓"><a href="#AQS-的设计精髓" class="headerlink" title="AQS 的设计精髓"></a>AQS 的设计精髓</h3><ol><li><strong>模板方法模式</strong>：AQS 定义算法骨架，子类实现具体逻辑</li><li><strong>CLH 队列变体</strong>：高效的 FIFO 等待队列</li><li><strong>CAS + volatile</strong>：保证线程安全的无锁操作</li><li><strong>LockSupport</strong>：精确的线程阻塞&#x2F;唤醒控制</li></ol><h3 id="记忆口诀"><a href="#记忆口诀" class="headerlink" title="记忆口诀"></a>记忆口诀</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs erlang">AQS三要素：状态、队列、CAS<br>独占看<span class="hljs-keyword">try</span>Acquire，共享看<span class="hljs-keyword">try</span>AcquireShared<br>获取失败进队列，前驱是head才能抢<br>释放资源唤后继，FIFO保公平<br></code></pre></td></tr></table></figure><hr><h2 id="常见面试题"><a href="#常见面试题" class="headerlink" title="常见面试题"></a>常见面试题</h2><h3 id="Q1：AQS-为什么使用双向链表？"><a href="#Q1：AQS-为什么使用双向链表？" class="headerlink" title="Q1：AQS 为什么使用双向链表？"></a>Q1：AQS 为什么使用双向链表？</h3><ul><li><strong>方便取消操作</strong>：取消节点时需要修改前驱的 next 指针</li><li><strong>方便判断前驱状态</strong>：只有前驱是 head 才能尝试获取资源</li><li><strong>方便从尾部遍历</strong>：某些场景需要从后向前遍历</li></ul><h3 id="Q2：为什么-head-节点是虚节点？"><a href="#Q2：为什么-head-节点是虚节点？" class="headerlink" title="Q2：为什么 head 节点是虚节点？"></a>Q2：为什么 head 节点是虚节点？</h3><ul><li>head 代表<strong>当前持有资源的线程</strong>（或初始空节点）</li><li>真正等待的线程从 head.next 开始</li><li>这样设计简化了边界条件处理</li></ul><h3 id="Q3：公平锁和非公平锁的区别？"><a href="#Q3：公平锁和非公平锁的区别？" class="headerlink" title="Q3：公平锁和非公平锁的区别？"></a>Q3：公平锁和非公平锁的区别？</h3><table><thead><tr><th>类型</th><th>实现方式</th><th>特点</th></tr></thead><tbody><tr><td>公平锁</td><td>tryAcquire 时先检查队列</td><td>严格 FIFO，吞吐量较低</td></tr><tr><td>非公平锁</td><td>tryAcquire 时直接 CAS 抢锁</td><td>可能插队，吞吐量较高</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 非公平锁的 tryAcquire（简化版）</span><br><span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span> &amp;&amp; CAS(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">// 公平锁的 tryAcquire（简化版）</span><br><span class="hljs-keyword">if</span> (state == <span class="hljs-number">0</span> &amp;&amp; !hasQueuedPredecessors() &amp;&amp; CAS(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br></code></pre></td></tr></table></figure><hr><h2 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h2><ul><li>ReentrantLock 原理 - AQS 的典型独占实现</li><li>CountDownLatch 原理 - AQS 的典型共享实现</li><li>CAS 原理 - AQS 的底层原子操作</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>同步工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>AQS</tag>
      
      <tag>同步器</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Agent架构模式详解</title>
    <link href="/2026/01/12/Agent%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/Agent%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Agent-架构模式详解"><a href="#Agent-架构模式详解" class="headerlink" title="Agent 架构模式详解"></a>Agent 架构模式详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>AI Agent（智能体）</strong> 是能够自主感知环境、做出决策并执行行动的 AI 系统。与普通的 LLM 对话不同，Agent 能够调用外部工具、访问数据库、执行代码，真正完成任务。</p><blockquote><p><strong>💡 提示: 核心区别</strong><br><strong>普通 LLM</strong>：只能生成文本<br><strong>Agent</strong>：能思考 + 行动 + 获取反馈 + 继续思考</p></blockquote><h2 id="Agent-核心组件"><a href="#Agent-核心组件" class="headerlink" title="Agent 核心组件"></a>Agent 核心组件</h2><pre><code class=" mermaid">graph TB    subgraph Agent        A[LLM 大脑] --&gt; B[规划模块]        A --&gt; C[记忆模块]        A --&gt; D[工具模块]    end        D --&gt; E[搜索工具]    D --&gt; F[代码执行]    D --&gt; G[数据库]    D --&gt; H[API调用]        C --&gt; I[短期记忆]    C --&gt; J[长期记忆]</code></pre><table><thead><tr><th>组件</th><th>功能</th><th>技术实现</th></tr></thead><tbody><tr><td><strong>LLM 大脑</strong></td><td>理解、推理、决策</td><td>GPT-4、Claude、通义千问</td></tr><tr><td><strong>规划模块</strong></td><td>任务分解、执行策略</td><td>ReAct、Plan-and-Execute</td></tr><tr><td><strong>记忆模块</strong></td><td>存储上下文、历史经验</td><td>向量数据库、Redis</td></tr><tr><td><strong>工具模块</strong></td><td>与外部世界交互</td><td>Function Calling</td></tr></tbody></table><hr><h2 id="一、ReAct-模式"><a href="#一、ReAct-模式" class="headerlink" title="一、ReAct 模式"></a>一、ReAct 模式</h2><h3 id="1-1-核心思想"><a href="#1-1-核心思想" class="headerlink" title="1.1 核心思想"></a>1.1 核心思想</h3><p><strong>ReAct &#x3D; Reasoning（推理） + Acting（行动）</strong></p><p>交替进行思考和行动，每一步都根据上一步的结果决定下一步。</p><h3 id="1-2-执行流程"><a href="#1-2-执行流程" class="headerlink" title="1.2 执行流程"></a>1.2 执行流程</h3><pre><code class=" mermaid">graph TD    A[用户问题] --&gt; B[Thought: 我需要做什么?]    B --&gt; C[Action: 调用工具]    C --&gt; D[Observation: 观察结果]    D --&gt; E&#123;任务完成?&#125;    E --&gt;|否| B    E --&gt;|是| F[Final Answer: 最终回答]</code></pre><h3 id="1-3-Prompt-模板"><a href="#1-3-Prompt-模板" class="headerlink" title="1.3 Prompt 模板"></a>1.3 Prompt 模板</h3><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">你是一个能使用工具的 AI 助手。</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">可用工具：</span><br><span class="hljs-attribute">1. search(query) - 搜索网络信息</span><br><span class="hljs-attribute">2. calculator(expression) - 计算数学表达式</span><br><span class="hljs-attribute">3. get_weather(city) - 获取城市天气</span><br><span class="hljs-attribute">4. run_code(code) - 执行 Python 代码</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">请严格按照以下格式回答：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Thought</span><span class="hljs-punctuation">:</span> <span class="hljs-string">思考当前应该做什么</span><br><span class="hljs-attribute">Action</span><span class="hljs-punctuation">:</span> <span class="hljs-string">工具名称</span><br><span class="hljs-attribute">Action Input</span><span class="hljs-punctuation">:</span> <span class="hljs-string">工具参数（JSON格式）</span><br><span class="hljs-attribute">Observation</span><span class="hljs-punctuation">:</span> <span class="hljs-string">[系统返回工具执行结果]</span><br><br><span class="hljs-attribute">...（重复 Thought/Action/Observation 直到任务完成）</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Thought</span><span class="hljs-punctuation">:</span> <span class="hljs-string">我已经获得了足够的信息</span><br><span class="hljs-attribute">Final Answer</span><span class="hljs-punctuation">:</span> <span class="hljs-string">最终答案</span><br><br>注意：<br><span class="hljs-bullet">-</span> <span class="hljs-string">每次只能调用一个工具</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">必须等待 Observation 后再继续思考</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">不要编造 Observation，等待系统返回</span><br><br>用户问题：&#123;question&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-执行示例"><a href="#1-4-执行示例" class="headerlink" title="1.4 执行示例"></a>1.4 执行示例</h3><p><strong>用户问</strong>：”帮我查一下上海今天的天气，如果气温超过30度，帮我计算需要喝多少水（体重70kg，每公斤40ml）”</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Thought</span>: 我需要先查询上海的天气，获取温度信息<br><span class="hljs-attribute">Action</span>: get_weather<br><span class="hljs-attribute">Action</span> Input: &#123;<span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;上海&quot;</span>&#125;<br><span class="hljs-attribute">Observation</span>: &#123;<span class="hljs-string">&quot;city&quot;</span>: <span class="hljs-string">&quot;上海&quot;</span>, <span class="hljs-string">&quot;temperature&quot;</span>: <span class="hljs-number">35</span>, <span class="hljs-string">&quot;humidity&quot;</span>: <span class="hljs-number">75</span>, <span class="hljs-string">&quot;condition&quot;</span>: <span class="hljs-string">&quot;晴&quot;</span>&#125;<br><br><span class="hljs-attribute">Thought</span>: 上海气温<span class="hljs-number">35</span>度，超过<span class="hljs-number">30</span>度了。现在我需要计算喝水量：<span class="hljs-number">70</span>kg × <span class="hljs-number">40</span>ml = <span class="hljs-number">2800</span>ml<br><span class="hljs-attribute">Action</span>: calculator<br><span class="hljs-attribute">Action</span> Input: &#123;<span class="hljs-string">&quot;expression&quot;</span>: <span class="hljs-string">&quot;70 * 40&quot;</span>&#125;<br><span class="hljs-attribute">Observation</span>: <span class="hljs-number">2800</span><br><br><span class="hljs-attribute">Thought</span>: 我已经获得了所有需要的信息<br><span class="hljs-attribute">Final</span> Answer: 上海今天天气晴朗，气温<span class="hljs-number">35</span>°C，湿度<span class="hljs-number">75</span>%。由于气温超过<span class="hljs-number">30</span>度，建议您多补充水分。按照您的体重<span class="hljs-number">70</span>kg计算，今天建议饮水量为<span class="hljs-number">2800</span>ml（约<span class="hljs-number">2</span>.<span class="hljs-number">8</span>升）。<br></code></pre></td></tr></table></figure><h3 id="1-5-Spring-AI-实现"><a href="#1-5-Spring-AI-实现" class="headerlink" title="1.5 Spring AI 实现"></a>1.5 Spring AI 实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentConfig</span> &#123;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ChatClient <span class="hljs-title function_">chatClient</span><span class="hljs-params">(ChatClient.Builder builder,</span><br><span class="hljs-params">                                  WeatherTool weatherTool,</span><br><span class="hljs-params">                                  CalculatorTool calculatorTool)</span> &#123;<br>        <span class="hljs-keyword">return</span> builder<br>            .defaultSystem(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                你是一个智能助手，可以使用工具来帮助用户。</span><br><span class="hljs-string">                请仔细分析用户的问题，选择合适的工具来获取信息。</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br>            .defaultTools(weatherTool, calculatorTool)<br>            .build();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeatherTool</span> &#123;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;获取指定城市的天气信息，返回温度、湿度等&quot;)</span><br>    <span class="hljs-keyword">public</span> WeatherInfo <span class="hljs-title function_">getWeather</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@ToolParam(description = &quot;城市名称，如：北京、上海&quot;)</span> String city</span><br><span class="hljs-params">    )</span> &#123;<br>        <span class="hljs-comment">// 调用天气 API</span><br>        <span class="hljs-keyword">return</span> weatherApi.query(city);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CalculatorTool</span> &#123;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;计算数学表达式，支持加减乘除&quot;)</span><br>    <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">calculator</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@ToolParam(description = &quot;数学表达式，如：70 * 40&quot;)</span> String expression</span><br><span class="hljs-params">    )</span> &#123;<br>        <span class="hljs-type">ScriptEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>()<br>            .getEngineByName(<span class="hljs-string">&quot;JavaScript&quot;</span>);<br>        <span class="hljs-keyword">return</span> ((Number) engine.eval(expression)).doubleValue();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-meta">@PostMapping(&quot;/agent/chat&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String question)</span> &#123;<br>        <span class="hljs-keyword">return</span> chatClient.prompt()<br>            .user(question)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-6-ReAct-优缺点"><a href="#1-6-ReAct-优缺点" class="headerlink" title="1.6 ReAct 优缺点"></a>1.6 ReAct 优缺点</h3><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>实现简单直观</td><td>可能走弯路，效率不高</td></tr><tr><td>灵活性高，可随时调整</td><td>复杂任务容易迷失方向</td></tr><tr><td>适合探索性任务</td><td>Token 消耗较多</td></tr><tr><td>中间过程可观察</td><td>长任务容易超出上下文</td></tr></tbody></table><hr><h2 id="二、Plan-and-Execute-模式"><a href="#二、Plan-and-Execute-模式" class="headerlink" title="二、Plan-and-Execute 模式"></a>二、Plan-and-Execute 模式</h2><h3 id="2-1-核心思想"><a href="#2-1-核心思想" class="headerlink" title="2.1 核心思想"></a>2.1 核心思想</h3><p><strong>先规划，后执行</strong>。将复杂任务分解为多个子任务，然后按计划逐步执行。</p><h3 id="2-2-执行流程"><a href="#2-2-执行流程" class="headerlink" title="2.2 执行流程"></a>2.2 执行流程</h3><pre><code class=" mermaid">graph TD    A[用户问题] --&gt; B[Planner: 分析任务]    B --&gt; C[生成执行计划]    C --&gt; D[Executor: 执行步骤1]    D --&gt; E[Executor: 执行步骤2]    E --&gt; F[Executor: 执行步骤N]    F --&gt; G&#123;执行结果符合预期?&#125;    G --&gt;|否| H[Replanner: 调整计划]    H --&gt; C    G --&gt;|是| I[汇总结果]    I --&gt; J[Final Answer]</code></pre><h3 id="2-3-双-Agent-架构"><a href="#2-3-双-Agent-架构" class="headerlink" title="2.3 双 Agent 架构"></a>2.3 双 Agent 架构</h3><pre><code class=" mermaid">graph LR    subgraph Planner Agent        A[任务分析] --&gt; B[计划生成]        B --&gt; C[计划优化]    end        subgraph Executor Agent        D[接收步骤] --&gt; E[执行工具]        E --&gt; F[返回结果]    end        C --&gt; D    F --&gt; G&#123;需要重新规划?&#125;    G --&gt;|是| A    G --&gt;|否| H[完成]</code></pre><h3 id="2-4-Planner-Prompt-模板"><a href="#2-4-Planner-Prompt-模板" class="headerlink" title="2.4 Planner Prompt 模板"></a>2.4 Planner Prompt 模板</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs perl">你是一个任务规划专家。请根据用户的问题，制定详细的执行计划。<br><br><span class="hljs-comment">## 规划原则</span><br><span class="hljs-number">1</span>. 将复杂任务分解为简单的子步骤<br><span class="hljs-number">2</span>. 每个步骤应该是原子性的、可执行的<br><span class="hljs-number">3</span>. 步骤之间要有清晰的依赖关系<br><span class="hljs-number">4</span>. 考虑可能的失败情况和备选方案<br><br><span class="hljs-comment">## 可用工具</span><br>- search(query): 搜索网络信息<br>- read_file(path): 读取文件内容<br>- write_file(path, content): 写入文件<br>- run_code(language, code): 执行代码<br>- api_call(url, <span class="hljs-function"><span class="hljs-keyword">method</span>, <span class="hljs-title">data</span>): 调用 <span class="hljs-title">API</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">## 输出格式</span><br><span class="hljs-function">请以 <span class="hljs-title">JSON</span> 格式输出计划：</span><br><span class="hljs-function">```<span class="hljs-title">json</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-string">&quot;goal&quot;</span>: <span class="hljs-string">&quot;任务目标描述&quot;</span>,<br>  <span class="hljs-string">&quot;steps&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;步骤描述&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;工具名称&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;参数&quot;</span>: <span class="hljs-string">&quot;值&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;预期输出&quot;</span><br>    &#125;<br>  ],<br>  <span class="hljs-string">&quot;success_criteria&quot;</span>: <span class="hljs-string">&quot;成功标准&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>用户问题：{question}</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs clean"><br>### <span class="hljs-number">2.5</span> 执行示例<br><br>**用户问**：<span class="hljs-string">&quot;帮我调研 Spring AI 框架，写一份技术选型报告&quot;</span><br><br>#### Planner 输出<br><br>```json<br>&#123;<br>  <span class="hljs-string">&quot;goal&quot;</span>: <span class="hljs-string">&quot;完成 Spring AI 框架技术选型报告&quot;</span>,<br>  <span class="hljs-string">&quot;steps&quot;</span>: [<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;搜索 Spring AI 官方文档和基本介绍&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;search&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Spring AI official documentation introduction&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;Spring AI 基本概念和特性&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">2</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;搜索 Spring AI 最新版本和更新内容&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;search&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Spring AI latest version features 2024&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;版本信息和新特性&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">3</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;搜索 Spring AI 与 LangChain4j 对比&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;search&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Spring AI vs LangChain4j comparison&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;框架对比分析&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">4</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;搜索 Spring AI 实际应用案例&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;search&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;query&quot;</span>: <span class="hljs-string">&quot;Spring AI production use cases&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;企业应用案例&quot;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-string">&quot;id&quot;</span>: <span class="hljs-number">5</span>,<br>      <span class="hljs-string">&quot;description&quot;</span>: <span class="hljs-string">&quot;整合所有信息，生成技术选型报告&quot;</span>,<br>      <span class="hljs-string">&quot;tool&quot;</span>: <span class="hljs-string">&quot;generate_report&quot;</span>,<br>      <span class="hljs-string">&quot;params&quot;</span>: &#123;<span class="hljs-string">&quot;template&quot;</span>: <span class="hljs-string">&quot;tech_selection&quot;</span>&#125;,<br>      <span class="hljs-string">&quot;depends_on&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],<br>      <span class="hljs-string">&quot;expected_output&quot;</span>: <span class="hljs-string">&quot;完整的技术选型报告&quot;</span><br>    &#125;<br>  ],<br>  <span class="hljs-string">&quot;success_criteria&quot;</span>: <span class="hljs-string">&quot;报告包含框架介绍、特性分析、对比评估、应用建议&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Executor-执行"><a href="#Executor-执行" class="headerlink" title="Executor 执行"></a>Executor 执行</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-section">=== 执行步骤 1-4（可并行）===</span><br>Step 1 结果: Spring AI 是 Spring 官方的 AI 集成框架...<br>Step 2 结果: 最新版本 1.0.0，支持多种模型提供商...<br>Step 3 结果: Spring AI 更注重 Spring 生态集成...<br>Step 4 结果: 某电商公司使用 Spring AI 构建智能客服...<br><br><span class="hljs-section">=== 执行步骤 5 ===</span><br><span class="hljs-meta">[生成完整报告]</span><br></code></pre></td></tr></table></figure><h3 id="2-6-Java-实现框架"><a href="#2-6-Java-实现框架" class="headerlink" title="2.6 Java 实现框架"></a>2.6 Java 实现框架</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlanAndExecuteAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient plannerClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient executorClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ToolRegistry toolRegistry;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">(String question)</span> &#123;<br>        <span class="hljs-comment">// 1. 生成计划</span><br>        <span class="hljs-type">Plan</span> <span class="hljs-variable">plan</span> <span class="hljs-operator">=</span> generatePlan(question);<br>        <br>        <span class="hljs-comment">// 2. 执行计划</span><br>        Map&lt;Integer, StepResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">for</span> (Step step : plan.getSteps()) &#123;<br>            <span class="hljs-comment">// 检查依赖是否完成</span><br>            <span class="hljs-keyword">if</span> (!checkDependencies(step, results)) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <br>            <span class="hljs-comment">// 执行步骤</span><br>            <span class="hljs-type">StepResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeStep(step, results);<br>            results.put(step.getId(), result);<br>            <br>            <span class="hljs-comment">// 检查是否需要重新规划</span><br>            <span class="hljs-keyword">if</span> (result.needsReplan()) &#123;<br>                plan = replan(question, plan, results);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 3. 汇总结果</span><br>        <span class="hljs-keyword">return</span> summarize(question, results);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> Plan <span class="hljs-title function_">generatePlan</span><span class="hljs-params">(String question)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> plannerClient.prompt()<br>            .system(PLANNER_PROMPT)<br>            .user(question)<br>            .call()<br>            .content();<br>        <span class="hljs-keyword">return</span> parseJson(response, Plan.class);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> StepResult <span class="hljs-title function_">executeStep</span><span class="hljs-params">(Step step, Map&lt;Integer, StepResult&gt; context)</span> &#123;<br>        <span class="hljs-type">Tool</span> <span class="hljs-variable">tool</span> <span class="hljs-operator">=</span> toolRegistry.get(step.getTool());<br>        <span class="hljs-keyword">return</span> tool.execute(step.getParams(), context);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plan</span> &#123;<br>    <span class="hljs-keyword">private</span> String goal;<br>    <span class="hljs-keyword">private</span> List&lt;Step&gt; steps;<br>    <span class="hljs-keyword">private</span> String successCriteria;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Step</span> &#123;<br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String description;<br>    <span class="hljs-keyword">private</span> String tool;<br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; params;<br>    <span class="hljs-keyword">private</span> List&lt;Integer&gt; dependsOn;<br>    <span class="hljs-keyword">private</span> String expectedOutput;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-7-Plan-and-Execute-优缺点"><a href="#2-7-Plan-and-Execute-优缺点" class="headerlink" title="2.7 Plan-and-Execute 优缺点"></a>2.7 Plan-and-Execute 优缺点</h3><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>全局视角，不易迷失</td><td>初始规划可能不够准确</td></tr><tr><td>可并行执行独立步骤</td><td>需要额外的规划开销</td></tr><tr><td>复杂任务效率高</td><td>灵活性相对较低</td></tr><tr><td>易于追踪和调试</td><td>实现复杂度较高</td></tr></tbody></table><hr><h2 id="三、其他-Agent-模式"><a href="#三、其他-Agent-模式" class="headerlink" title="三、其他 Agent 模式"></a>三、其他 Agent 模式</h2><h3 id="3-1-Reflexion（反思模式）"><a href="#3-1-Reflexion（反思模式）" class="headerlink" title="3.1 Reflexion（反思模式）"></a>3.1 Reflexion（反思模式）</h3><p><strong>核心思想</strong>：执行后进行自我反思，从错误中学习。</p><pre><code class=" mermaid">graph TD    A[执行任务] --&gt; B[评估结果]    B --&gt; C&#123;成功?&#125;    C --&gt;|是| D[完成]    C --&gt;|否| E[反思: 为什么失败?]    E --&gt; F[总结经验教训]    F --&gt; G[改进策略]    G --&gt; A</code></pre><p><strong>Prompt 示例</strong>：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs clean">## 任务<br>&#123;task&#125;<br><br>## 上次尝试<br>&#123;previous_attempt&#125;<br><br>## 执行结果<br>&#123;result&#125;<br><br>## 反思<br>请分析上次尝试为什么没有达到预期效果：<br><span class="hljs-number">1.</span> 哪些步骤是正确的？<br><span class="hljs-number">2.</span> 哪些步骤需要改进？<br><span class="hljs-number">3.</span> 有什么遗漏的信息？<br><br>## 改进计划<br>基于反思，制定新的执行计划：<br></code></pre></td></tr></table></figure><h3 id="3-2-LATS（Language-Agent-Tree-Search）"><a href="#3-2-LATS（Language-Agent-Tree-Search）" class="headerlink" title="3.2 LATS（Language Agent Tree Search）"></a>3.2 LATS（Language Agent Tree Search）</h3><p><strong>核心思想</strong>：结合蒙特卡洛树搜索（MCTS），探索多个执行路径。</p><pre><code class=" mermaid">graph TD    A[根节点: 问题] --&gt; B[方案A]    A --&gt; C[方案B]    A --&gt; D[方案C]    B --&gt; E[A1]    B --&gt; F[A2]    C --&gt; G[B1]    C --&gt; H[B2]        style E fill:#90EE90    style H fill:#90EE90</code></pre><p><strong>执行流程</strong>：</p><ol><li><strong>选择</strong>：选择最有希望的节点</li><li><strong>扩展</strong>：生成可能的下一步</li><li><strong>模拟</strong>：模拟执行到结束</li><li><strong>回溯</strong>：更新路径上节点的评分</li></ol><h3 id="3-3-Multi-Agent（多智能体）"><a href="#3-3-Multi-Agent（多智能体）" class="headerlink" title="3.3 Multi-Agent（多智能体）"></a>3.3 Multi-Agent（多智能体）</h3><p><strong>核心思想</strong>：多个专业 Agent 协作完成任务。</p><pre><code class=" mermaid">graph TB    A[用户问题] --&gt; B[Orchestrator]    B --&gt; C[Research Agent]    B --&gt; D[Coding Agent]    B --&gt; E[Review Agent]    C --&gt; F[搜索/阅读]    D --&gt; G[编写代码]    E --&gt; H[代码审查]    F --&gt; B    G --&gt; B    H --&gt; B    B --&gt; I[最终结果]</code></pre><p><strong>角色分工示例</strong>：</p><table><thead><tr><th>Agent</th><th>职责</th><th>工具</th></tr></thead><tbody><tr><td>Orchestrator</td><td>任务分发、结果汇总</td><td>无</td></tr><tr><td>Research Agent</td><td>信息收集、调研</td><td>search、read_url</td></tr><tr><td>Coding Agent</td><td>代码编写</td><td>code_interpreter</td></tr><tr><td>Review Agent</td><td>代码审查、质量检查</td><td>static_analysis</td></tr><tr><td>Test Agent</td><td>编写和运行测试</td><td>test_runner</td></tr></tbody></table><p><strong>Spring AI 多 Agent 实现</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiAgentOrchestrator</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Agent&gt; agents;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">orchestrate</span><span class="hljs-params">(String task)</span> &#123;<br>        <span class="hljs-comment">// 1. 分析任务，确定需要哪些 Agent</span><br>        List&lt;AgentTask&gt; agentTasks = analyzeTask(task);<br>        <br>        <span class="hljs-comment">// 2. 分发任务给各 Agent</span><br>        Map&lt;String, CompletableFuture&lt;String&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (AgentTask agentTask : agentTasks) &#123;<br>            <span class="hljs-type">Agent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> agents.get(agentTask.getAgentType());<br>            futures.put(agentTask.getId(), <br>                CompletableFuture.supplyAsync(() -&gt; <br>                    agent.execute(agentTask.getPrompt())<br>                )<br>            );<br>        &#125;<br>        <br>        <span class="hljs-comment">// 3. 收集结果</span><br>        Map&lt;String, String&gt; results = futures.entrySet().stream()<br>            .collect(Collectors.toMap(<br>                Map.Entry::getKey,<br>                e -&gt; e.getValue().join()<br>            ));<br>        <br>        <span class="hljs-comment">// 4. 汇总生成最终答案</span><br>        <span class="hljs-keyword">return</span> synthesize(task, results);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Agent</span> &#123;<br>    String <span class="hljs-title function_">execute</span><span class="hljs-params">(String prompt)</span>;<br>&#125;<br><br><span class="hljs-meta">@Component(&quot;research&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResearchAgent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Agent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SearchTool searchTool;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">(String prompt)</span> &#123;<br>        <span class="hljs-keyword">return</span> chatClient.prompt()<br>            .system(<span class="hljs-string">&quot;你是一个研究专家，善于收集和整理信息&quot;</span>)<br>            .user(prompt)<br>            .tools(searchTool)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-4-AutoGPT-模式"><a href="#3-4-AutoGPT-模式" class="headerlink" title="3.4 AutoGPT 模式"></a>3.4 AutoGPT 模式</h3><p><strong>核心思想</strong>：全自动任务执行，最少人工干预。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs markdown">目标：&#123;goal&#125;<br><br>约束：<br><span class="hljs-bullet">1.</span> 每次只能执行一个动作<br><span class="hljs-bullet">2.</span> 必须在 10 步内完成<br><span class="hljs-bullet">3.</span> 遇到不确定时询问用户<br><br>当前状态：&#123;current<span class="hljs-emphasis">_state&#125;</span><br><span class="hljs-emphasis">已完成步骤：&#123;completed_</span>steps&#125;<br>可用工具：&#123;tools&#125;<br><br>请决定下一步动作：<br><span class="hljs-bullet">1.</span> 思考当前进度<br><span class="hljs-bullet">2.</span> 选择下一个动作<br><span class="hljs-bullet">3.</span> 执行并观察结果<br><span class="hljs-bullet">4.</span> 判断是否完成目标<br></code></pre></td></tr></table></figure><hr><h2 id="四、模式选择指南"><a href="#四、模式选择指南" class="headerlink" title="四、模式选择指南"></a>四、模式选择指南</h2><h3 id="4-1-场景匹配"><a href="#4-1-场景匹配" class="headerlink" title="4.1 场景匹配"></a>4.1 场景匹配</h3><table><thead><tr><th>场景</th><th>推荐模式</th><th>原因</th></tr></thead><tbody><tr><td>简单问答 + 单工具</td><td>ReAct</td><td>直接高效</td></tr><tr><td>多步骤复杂任务</td><td>Plan-and-Execute</td><td>需要全局规划</td></tr><tr><td>需要试错的任务</td><td>Reflexion</td><td>从错误中学习</td></tr><tr><td>有多种解决方案</td><td>LATS</td><td>探索最优路径</td></tr><tr><td>大型复杂项目</td><td>Multi-Agent</td><td>专业分工协作</td></tr></tbody></table><h3 id="4-2-决策流程图"><a href="#4-2-决策流程图" class="headerlink" title="4.2 决策流程图"></a>4.2 决策流程图</h3><pre><code class=" mermaid">graph TD    A[任务类型?] --&gt; B&#123;单步骤?&#125;    B --&gt;|是| C[直接调用 LLM]    B --&gt;|否| D&#123;步骤数量?&#125;    D --&gt;|2-5步| E[ReAct]    D --&gt;|5+步| F&#123;需要并行?&#125;    F --&gt;|是| G[Plan-and-Execute]    F --&gt;|否| H&#123;可能失败?&#125;    H --&gt;|是| I[Reflexion]    H --&gt;|否| E</code></pre><hr><h2 id="五、最佳实践"><a href="#五、最佳实践" class="headerlink" title="五、最佳实践"></a>五、最佳实践</h2><h3 id="5-1-工具设计原则"><a href="#5-1-工具设计原则" class="headerlink" title="5.1 工具设计原则"></a>5.1 工具设计原则</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ✅ 好的工具设计</span><br><span class="hljs-meta">@Tool(description = &quot;搜索指定城市的天气信息，返回温度（摄氏度）、湿度、天气状况&quot;)</span><br><span class="hljs-keyword">public</span> WeatherInfo <span class="hljs-title function_">getWeather</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-meta">@ToolParam(description = &quot;城市名称，支持中文，如：北京、上海&quot;)</span> </span><br><span class="hljs-params">    String city</span><br><span class="hljs-params">)</span> &#123; ... &#125;<br><br><span class="hljs-comment">// ❌ 不好的工具设计</span><br><span class="hljs-meta">@Tool(description = &quot;获取天气&quot;)</span>  <span class="hljs-comment">// 描述太模糊</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">weather</span><span class="hljs-params">(String c)</span> &#123; ... &#125;  <span class="hljs-comment">// 参数名不清晰</span><br></code></pre></td></tr></table></figure><p><strong>工具设计要点</strong>：</p><ul><li>描述清晰，包含输入输出说明</li><li>参数命名有意义</li><li>返回类型明确</li><li>单一职责</li></ul><h3 id="5-2-记忆管理"><a href="#5-2-记忆管理" class="headerlink" title="5.2 记忆管理"></a>5.2 记忆管理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentMemory</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VectorStore vectorStore;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Message&gt; shortTermMemory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 短期记忆：当前对话</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToShortTerm</span><span class="hljs-params">(Message message)</span> &#123;<br>        shortTermMemory.add(message);<br>        <span class="hljs-comment">// 保持最近 N 条</span><br>        <span class="hljs-keyword">if</span> (shortTermMemory.size() &gt; MAX_SHORT_TERM) &#123;<br>            summarizeAndArchive();<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 长期记忆：向量存储</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToLongTerm</span><span class="hljs-params">(String content, Map&lt;String, Object&gt; metadata)</span> &#123;<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(content, metadata);<br>        vectorStore.add(List.of(doc));<br>    &#125;<br>    <br>    <span class="hljs-comment">// 检索相关记忆</span><br>    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">recall</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> &#123;<br>        <span class="hljs-keyword">return</span> vectorStore.similaritySearch(<br>            SearchRequest.query(query).withTopK(topK)<br>        );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-3-错误处理"><a href="#5-3-错误处理" class="headerlink" title="5.3 错误处理"></a>5.3 错误处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Tool(description = &quot;执行网络搜索&quot;)</span><br><span class="hljs-keyword">public</span> SearchResult <span class="hljs-title function_">search</span><span class="hljs-params">(String query)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> searchApi.search(query);<br>    &#125; <span class="hljs-keyword">catch</span> (RateLimitException e) &#123;<br>        <span class="hljs-keyword">return</span> SearchResult.error(<span class="hljs-string">&quot;搜索服务繁忙，请稍后重试&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NetworkException e) &#123;<br>        <span class="hljs-keyword">return</span> SearchResult.error(<span class="hljs-string">&quot;网络连接失败，请检查网络&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        log.error(<span class="hljs-string">&quot;搜索异常&quot;</span>, e);<br>        <span class="hljs-keyword">return</span> SearchResult.error(<span class="hljs-string">&quot;搜索失败：&quot;</span> + e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-4-监控与追踪"><a href="#5-4-监控与追踪" class="headerlink" title="5.4 监控与追踪"></a>5.4 监控与追踪</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentTracingAspect</span> &#123;<br>    <br>    <span class="hljs-meta">@Around(&quot;@annotation(Tool)&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">traceToolCall</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">toolName</span> <span class="hljs-operator">=</span> pjp.getSignature().getName();<br>        Object[] args = pjp.getArgs();<br>        <br>        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pjp.proceed();<br>            log.info(<span class="hljs-string">&quot;Tool: &#123;&#125;, Args: &#123;&#125;, Result: &#123;&#125;, Time: &#123;&#125;ms&quot;</span>,<br>                toolName, args, result, System.currentTimeMillis() - start);<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;Tool: &#123;&#125; failed&quot;</span>, toolName, e);<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="六、实战项目"><a href="#六、实战项目" class="headerlink" title="六、实战项目"></a>六、实战项目</h2><h3 id="6-1-智能代码助手"><a href="#6-1-智能代码助手" class="headerlink" title="6.1 智能代码助手"></a>6.1 智能代码助手</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeAssistantAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;读取项目中的源代码文件&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">readCode</span><span class="hljs-params">(String filePath)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;在项目中搜索代码&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;SearchHit&gt; <span class="hljs-title function_">searchCode</span><span class="hljs-params">(String query)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;执行单元测试&quot;)</span><br>    <span class="hljs-keyword">public</span> TestResult <span class="hljs-title function_">runTests</span><span class="hljs-params">(String testClass)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;静态代码分析&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;Issue&gt; <span class="hljs-title function_">analyzeCode</span><span class="hljs-params">(String filePath)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">assist</span><span class="hljs-params">(String question)</span> &#123;<br>        <span class="hljs-keyword">return</span> chatClient.prompt()<br>            .system(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                你是一个专业的代码助手，可以：</span><br><span class="hljs-string">                1. 阅读和理解代码</span><br><span class="hljs-string">                2. 搜索相关代码片段</span><br><span class="hljs-string">                3. 运行测试验证</span><br><span class="hljs-string">                4. 分析代码质量</span><br><span class="hljs-string">                </span><br><span class="hljs-string">                请根据用户问题，合理使用工具来提供帮助。</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br>            .user(question)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-2-自动化运维-Agent"><a href="#6-2-自动化运维-Agent" class="headerlink" title="6.2 自动化运维 Agent"></a>6.2 自动化运维 Agent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OpsAgent</span> &#123;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;查询服务器指标：CPU、内存、磁盘使用率&quot;)</span><br>    <span class="hljs-keyword">public</span> ServerMetrics <span class="hljs-title function_">getMetrics</span><span class="hljs-params">(String serverIp)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;查看应用日志，支持时间范围和关键字过滤&quot;)</span><br>    <span class="hljs-keyword">public</span> List&lt;LogEntry&gt; <span class="hljs-title function_">getLogs</span><span class="hljs-params">(String app, String keyword, <span class="hljs-type">int</span> minutes)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;重启指定服务&quot;)</span><br>    <span class="hljs-keyword">public</span> RestartResult <span class="hljs-title function_">restartService</span><span class="hljs-params">(String serviceName)</span> &#123; ... &#125;<br>    <br>    <span class="hljs-meta">@Tool(description = &quot;执行 SQL 查询（只读）&quot;)</span><br>    <span class="hljs-keyword">public</span> QueryResult <span class="hljs-title function_">queryDatabase</span><span class="hljs-params">(String sql)</span> &#123; ... &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>大模型学习路线</li><li>Prompt Engineering详解</li><li>RAG技术详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>Agent</tag>
      
      <tag>ReAct</tag>
      
      <tag>LLM</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>RDF规范</title>
    <link href="/2026/01/12/RDF%E8%A7%84%E8%8C%83/"/>
    <url>/2026/01/12/RDF%E8%A7%84%E8%8C%83/</url>
    
    <content type="html"><![CDATA[<h1 id="RDF-规范"><a href="#RDF-规范" class="headerlink" title="RDF 规范"></a>RDF 规范</h1><blockquote><p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 三元组详解</p></blockquote><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>RDF（Resource Description Framework）</strong> 是 W3C 制定的资源描述框架，用于描述 Web 资源的标准模型。RDF 基于三元组模型，是语义网和知识图谱的基础技术。</p><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="资源（Resource）"><a href="#资源（Resource）" class="headerlink" title="资源（Resource）"></a>资源（Resource）</h3><ul><li>一切可被描述的事物都是资源</li><li>使用 <strong>URI（统一资源标识符）</strong> 唯一标识</li><li>示例：<code>http://example.org/person/张三</code></li></ul><h3 id="属性（Property）"><a href="#属性（Property）" class="headerlink" title="属性（Property）"></a>属性（Property）</h3><ul><li>描述资源特征或关系的谓语</li><li>也使用 URI 标识</li><li>示例：<code>http://xmlns.com/foaf/0.1/name</code></li></ul><h3 id="字面量（Literal）"><a href="#字面量（Literal）" class="headerlink" title="字面量（Literal）"></a>字面量（Literal）</h3><ul><li>属性的具体值</li><li>可带数据类型或语言标签</li><li>示例：<code>&quot;25&quot;^^xsd:integer</code>、<code>&quot;北京&quot;@zh</code></li></ul><h2 id="RDF-序列化格式"><a href="#RDF-序列化格式" class="headerlink" title="RDF 序列化格式"></a>RDF 序列化格式</h2><table><thead><tr><th>格式</th><th>扩展名</th><th>特点</th></tr></thead><tbody><tr><td><strong>N-Triples</strong></td><td><code>.nt</code></td><td>最简单，每行一个三元组</td></tr><tr><td><strong>Turtle</strong></td><td><code>.ttl</code></td><td>可读性强，支持前缀</td></tr><tr><td><strong>RDF&#x2F;XML</strong></td><td><code>.rdf</code></td><td>XML 格式，较冗长</td></tr><tr><td><strong>JSON-LD</strong></td><td><code>.jsonld</code></td><td>JSON 兼容，Web 友好</td></tr><tr><td><strong>N-Quads</strong></td><td><code>.nq</code></td><td>四元组，支持命名图</td></tr></tbody></table><h2 id="N-Triples-格式"><a href="#N-Triples-格式" class="headerlink" title="N-Triples 格式"></a>N-Triples 格式</h2><p>最简单的 RDF 序列化格式，每行一个三元组：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">&lt;http:<span class="hljs-regexp">//</span>example.org<span class="hljs-regexp">/张三&gt; &lt;http:/</span><span class="hljs-regexp">/example.org/</span>认识&gt; &lt;http:<span class="hljs-regexp">//</span>example.org/李四&gt; .<br>&lt;http:<span class="hljs-regexp">//</span>example.org<span class="hljs-regexp">/张三&gt; &lt;http:/</span><span class="hljs-regexp">/example.org/</span>年龄&gt; <span class="hljs-string">&quot;25&quot;</span>^^&lt;http:<span class="hljs-regexp">//</span>www.w3.org<span class="hljs-regexp">/2001/</span>XMLSchema<span class="hljs-comment">#integer&gt; .</span><br>&lt;http:<span class="hljs-regexp">//</span>example.org<span class="hljs-regexp">/张三&gt; &lt;http:/</span><span class="hljs-regexp">/xmlns.com/</span>foaf<span class="hljs-regexp">/0.1/</span>name&gt; <span class="hljs-string">&quot;张三&quot;</span>@zh .<br></code></pre></td></tr></table></figure><h3 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h3><ul><li>URI 用 <code>&lt; &gt;</code> 包围</li><li>字面量用 <code>&quot; &quot;</code> 包围</li><li>数据类型用 <code>^^&lt;type&gt;</code> 标注</li><li>语言标签用 <code>@lang</code> 标注</li><li>每个三元组以 <code>.</code> 结尾</li></ul><h2 id="Turtle-格式"><a href="#Turtle-格式" class="headerlink" title="Turtle 格式"></a>Turtle 格式</h2><p>更易读的格式，支持前缀和简写：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs turtle">@prefix ex: &lt;http://example.org/&gt; .<br>@prefix foaf: &lt;http://xmlns.com/foaf/0.1/&gt; .<br>@prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt; .<br><br>ex:张三 <br>    foaf:name &quot;张三&quot;@zh ;<br>    ex:年龄 &quot;25&quot;^^xsd:integer ;<br>    ex:认识 ex:李四 .<br><br>ex:李四<br>    foaf:name &quot;李四&quot;@zh ;<br>    ex:工作于 ex:腾讯 .<br></code></pre></td></tr></table></figure><h3 id="Turtle-语法特点"><a href="#Turtle-语法特点" class="headerlink" title="Turtle 语法特点"></a>Turtle 语法特点</h3><table><thead><tr><th>符号</th><th>含义</th></tr></thead><tbody><tr><td><code>@prefix</code></td><td>定义命名空间前缀</td></tr><tr><td><code>;</code></td><td>同一主语的多个谓语-宾语</td></tr><tr><td><code>,</code></td><td>同一谓语的多个宾语</td></tr><tr><td><code>.</code></td><td>三元组结束</td></tr><tr><td><code>a</code></td><td><code>rdf:type</code> 的简写</td></tr></tbody></table><h2 id="JSON-LD-格式"><a href="#JSON-LD-格式" class="headerlink" title="JSON-LD 格式"></a>JSON-LD 格式</h2><p>JSON 兼容格式，适合 Web 开发：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;@context&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;ex&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://example.org/&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;foaf&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;http://xmlns.com/foaf/0.1/&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;foaf:name&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;knows&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;@id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ex:认识&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;@id&quot;</span> <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;@id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ex:张三&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;张三&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;knows&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ex:李四&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h2 id="常用词汇表"><a href="#常用词汇表" class="headerlink" title="常用词汇表"></a>常用词汇表</h2><table><thead><tr><th>词汇表</th><th>前缀</th><th>用途</th></tr></thead><tbody><tr><td>RDF</td><td><code>rdf:</code></td><td>基础 RDF 词汇</td></tr><tr><td>RDFS</td><td><code>rdfs:</code></td><td>RDF Schema，类和属性定义</td></tr><tr><td>OWL</td><td><code>owl:</code></td><td>本体描述语言</td></tr><tr><td>FOAF</td><td><code>foaf:</code></td><td>人物关系描述</td></tr><tr><td>DC</td><td><code>dc:</code></td><td>都柏林核心元数据</td></tr><tr><td>SKOS</td><td><code>skos:</code></td><td>概念和分类体系</td></tr></tbody></table><h2 id="RDF-Schema（RDFS）"><a href="#RDF-Schema（RDFS）" class="headerlink" title="RDF Schema（RDFS）"></a>RDF Schema（RDFS）</h2><p>RDFS 提供了定义类和属性的机制：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs turtle">@prefix rdfs: &lt;http://www.w3.org/2000/01/rdf-schema#&gt; .<br>@prefix ex: &lt;http://example.org/&gt; .<br><br># 定义类<br>ex:Person a rdfs:Class ;<br>    rdfs:label &quot;人&quot;@zh .<br><br># 定义属性<br>ex:认识 a rdf:Property ;<br>    rdfs:domain ex:Person ;<br>    rdfs:range ex:Person ;<br>    rdfs:label &quot;认识&quot;@zh .<br><br># 定义实例<br>ex:张三 a ex:Person ;<br>    ex:认识 ex:李四 .<br></code></pre></td></tr></table></figure><h2 id="空白节点（Blank-Node）"><a href="#空白节点（Blank-Node）" class="headerlink" title="空白节点（Blank Node）"></a>空白节点（Blank Node）</h2><p>表示匿名资源：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs turtle">ex:张三 ex:住址 [<br>    ex:城市 &quot;北京&quot; ;<br>    ex:区 &quot;海淀区&quot; ;<br>    ex:街道 &quot;中关村大街&quot;<br>] .<br></code></pre></td></tr></table></figure><h2 id="RDF-验证"><a href="#RDF-验证" class="headerlink" title="RDF 验证"></a>RDF 验证</h2><p>使用 <strong>SHACL（Shapes Constraint Language）</strong> 验证 RDF 数据：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs turtle">@prefix sh: &lt;http://www.w3.org/ns/shacl#&gt; .<br><br>ex:PersonShape a sh:NodeShape ;<br>    sh:targetClass ex:Person ;<br>    sh:property [<br>        sh:path foaf:name ;<br>        sh:minCount 1 ;<br>        sh:datatype xsd:string<br>    ] .<br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>三元组详解 - 衍生来源</li><li>SPARQL详解 - RDF 查询语言</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>图数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>图数据库</tag>
      
      <tag>RDF</tag>
      
      <tag>语义网</tag>
      
      <tag>全文引用</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Prompt Engineering详解</title>
    <link href="/2026/01/12/Prompt%20Engineering%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/Prompt%20Engineering%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Prompt-Engineering-详解"><a href="#Prompt-Engineering-详解" class="headerlink" title="Prompt Engineering 详解"></a>Prompt Engineering 详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Prompt Engineering（提示词工程）</strong> 是设计和优化输入给大语言模型（LLM）的提示词，以获得更准确、更符合预期输出的技术。</p><blockquote><p><strong>💡 提示: 核心思想</strong><br>大模型的输出质量很大程度上取决于输入的质量。好的 Prompt &#x3D; 好的结果。</p></blockquote><h2 id="为什么需要-Prompt-Engineering"><a href="#为什么需要-Prompt-Engineering" class="headerlink" title="为什么需要 Prompt Engineering"></a>为什么需要 Prompt Engineering</h2><table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td>输出不准确</td><td>问题描述模糊</td><td>明确任务目标</td></tr><tr><td>格式混乱</td><td>缺少格式约束</td><td>指定输出格式</td></tr><tr><td>缺少深度</td><td>上下文不足</td><td>提供背景信息</td></tr><tr><td>推理错误</td><td>一步到位太难</td><td>引导逐步思考</td></tr></tbody></table><hr><h2 id="一、基础提示技术"><a href="#一、基础提示技术" class="headerlink" title="一、基础提示技术"></a>一、基础提示技术</h2><h3 id="1-1-Zero-shot-Prompting"><a href="#1-1-Zero-shot-Prompting" class="headerlink" title="1.1 Zero-shot Prompting"></a>1.1 Zero-shot Prompting</h3><p><strong>定义</strong>：不提供任何示例，直接向模型提问。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">将以下文本翻译成英文：<br>今天天气真好，适合出去散步。<br></code></pre></td></tr></table></figure><p><strong>适用场景</strong>：简单任务、模型已经训练过的常见任务。</p><p><strong>优点</strong>：简单直接<br><strong>缺点</strong>：复杂任务效果差</p><hr><h3 id="1-2-One-shot-Prompting"><a href="#1-2-One-shot-Prompting" class="headerlink" title="1.2 One-shot Prompting"></a>1.2 One-shot Prompting</h3><p><strong>定义</strong>：提供 1 个示例，引导模型理解任务格式。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs">请将中文翻译成英文：<br><br>示例：<br>中文：苹果<br>英文：Apple<br><br>请翻译：<br>中文：香蕉<br>英文：<br></code></pre></td></tr></table></figure><hr><h3 id="1-3-Few-shot-Prompting"><a href="#1-3-Few-shot-Prompting" class="headerlink" title="1.3 Few-shot Prompting"></a>1.3 Few-shot Prompting</h3><p><strong>定义</strong>：提供多个（通常 3-5 个）示例，让模型学习模式。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs">请根据以下示例，对用户评论进行情感分类：<br><br>评论：这个产品太棒了，物超所值！<br>情感：正面<br><br>评论：质量一般，不推荐购买。<br>情感：负面<br><br>评论：还行吧，中规中矩。<br>情感：中性<br><br>评论：快递超快，包装也很好，非常满意！<br>情感：<br></code></pre></td></tr></table></figure><blockquote><p><strong>📝 注意: 最佳实践</strong></p><ul><li>示例要多样化，覆盖不同情况</li><li>示例格式要与期望输出一致</li><li>3-5 个示例通常足够，太多可能造成干扰</li></ul></blockquote><hr><h2 id="二、推理增强技术"><a href="#二、推理增强技术" class="headerlink" title="二、推理增强技术"></a>二、推理增强技术</h2><h3 id="2-1-Chain-of-Thought-CoT-思维链"><a href="#2-1-Chain-of-Thought-CoT-思维链" class="headerlink" title="2.1 Chain of Thought (CoT) - 思维链"></a>2.1 Chain of Thought (CoT) - 思维链</h3><p><strong>定义</strong>：引导模型展示推理过程，逐步得出答案。</p><h4 id="基础-CoT"><a href="#基础-CoT" class="headerlink" title="基础 CoT"></a>基础 CoT</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tap">问题：一个商店有<span class="hljs-number"> 23 </span>个苹果，卖掉了<span class="hljs-number"> 7 </span>个，又进货了<span class="hljs-number"> 12 </span>个，现在有多少个苹果？<br><br>请一步一步思考：<br></code></pre></td></tr></table></figure><p><strong>模型输出</strong>：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs tap">让我一步一步计算：<br>1. 初始苹果数量：23 个<br>2. 卖掉后：23 -<span class="hljs-number"> 7 </span>=<span class="hljs-number"> 16 </span>个<br>3. 进货后：16 +<span class="hljs-number"> 12 </span>=<span class="hljs-number"> 28 </span>个<br><br>答案：现在有<span class="hljs-number"> 28 </span>个苹果。<br></code></pre></td></tr></table></figure><h4 id="Few-shot-CoT"><a href="#Few-shot-CoT" class="headerlink" title="Few-shot CoT"></a>Few-shot CoT</h4><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs tap">问题：小明有<span class="hljs-number"> 5 </span>个苹果，小红给了他<span class="hljs-number"> 3 </span>个，他又吃了<span class="hljs-number"> 2 </span>个，还剩几个？<br>思考过程：<br>- 初始：5 个<br>- 小红给了<span class="hljs-number"> 3 </span>个：5 +<span class="hljs-number"> 3 </span>=<span class="hljs-number"> 8 </span>个<br>- 吃了<span class="hljs-number"> 2 </span>个：8 -<span class="hljs-number"> 2 </span>=<span class="hljs-number"> 6 </span>个<br>答案：6 个<br><br>问题：一个农场有<span class="hljs-number"> 15 </span>只鸡，卖掉了<span class="hljs-number"> 6 </span>只，又买了<span class="hljs-number"> 8 </span>只，现在有多少只？<br>思考过程：<br></code></pre></td></tr></table></figure><blockquote><p><strong>⚠️ 重要: CoT 适用场景</strong></p><ul><li>数学计算</li><li>逻辑推理</li><li>多步骤问题</li><li>需要解释过程的任务</li></ul></blockquote><hr><h3 id="2-2-Zero-shot-CoT"><a href="#2-2-Zero-shot-CoT" class="headerlink" title="2.2 Zero-shot CoT"></a>2.2 Zero-shot CoT</h3><p><strong>定义</strong>：不提供示例，仅通过魔法短语触发推理。</p><p><strong>魔法短语</strong>：</p><ul><li>“Let’s think step by step”（让我们一步一步思考）</li><li>“请逐步分析”</li><li>“让我们仔细推理”</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs armasm">问题：一列火车从 A 站出发，每小时行驶 <span class="hljs-number">60</span> 公里，<span class="hljs-number">2</span> 小时后到达 <span class="hljs-keyword">B</span> 站。<br>另一列火车同时从 <span class="hljs-keyword">B</span> 站出发，每小时 <span class="hljs-number">80</span> 公里。两车何时相遇？<br><br><span class="hljs-symbol">Let</span><span class="hljs-string">&#x27;s think step by step.</span><br></code></pre></td></tr></table></figure><hr><h3 id="2-3-Tree-of-Thought-ToT-思维树"><a href="#2-3-Tree-of-Thought-ToT-思维树" class="headerlink" title="2.3 Tree of Thought (ToT) - 思维树"></a>2.3 Tree of Thought (ToT) - 思维树</h3><p><strong>定义</strong>：探索多个推理路径，自我评估选择最优解。</p><pre><code class=" mermaid">graph TD    A[问题] --&gt; B[思路1]    A --&gt; C[思路2]    A --&gt; D[思路3]    B --&gt; E[评估: 可行]    C --&gt; F[评估: 不可行]    D --&gt; G[评估: 可行但复杂]    E --&gt; H[深入探索]    H --&gt; I[最终答案]</code></pre><p><strong>Prompt 示例</strong>：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">问题：如何设计一个高并发的秒杀系统？<br><br>请用以下思维框架分析：<br><br><span class="hljs-section">## 思路探索</span><br><span class="hljs-bullet">1.</span> 思路 A：[描述方案]<br><span class="hljs-bullet">   -</span> 优点：<br><span class="hljs-bullet">   -</span> 缺点：<br><span class="hljs-bullet">   -</span> 可行性评分：1-10<br><br><span class="hljs-bullet">2.</span> 思路 B：[描述方案]<br><span class="hljs-bullet">   -</span> 优点：<br><span class="hljs-bullet">   -</span> 缺点：<br><span class="hljs-bullet">   -</span> 可行性评分：1-10<br><br><span class="hljs-bullet">3.</span> 思路 C：[描述方案]<br><span class="hljs-bullet">   -</span> 优点：<br><span class="hljs-bullet">   -</span> 缺点：<br><span class="hljs-bullet">   -</span> 可行性评分：1-10<br><br><span class="hljs-section">## 最优方案选择</span><br>基于以上分析，选择并详细阐述最佳方案。<br></code></pre></td></tr></table></figure><hr><h3 id="2-4-Self-Consistency（自一致性）"><a href="#2-4-Self-Consistency（自一致性）" class="headerlink" title="2.4 Self-Consistency（自一致性）"></a>2.4 Self-Consistency（自一致性）</h3><p><strong>定义</strong>：多次采样答案，选择出现频率最高的结果。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs css">请对以下问题给出 <span class="hljs-number">3</span> 个独立的推理过程和答案：<br><br>问题：<span class="hljs-selector-attr">[复杂问题]</span><br><br>推理 <span class="hljs-number">1</span>：<br>推理 <span class="hljs-number">2</span>：<br>推理 <span class="hljs-number">3</span>：<br><br>最终答案（选择出现最多的答案）：<br></code></pre></td></tr></table></figure><hr><h2 id="三、角色与上下文设定"><a href="#三、角色与上下文设定" class="headerlink" title="三、角色与上下文设定"></a>三、角色与上下文设定</h2><h3 id="3-1-角色设定（Role-Prompting）"><a href="#3-1-角色设定（Role-Prompting）" class="headerlink" title="3.1 角色设定（Role Prompting）"></a>3.1 角色设定（Role Prompting）</h3><p><strong>定义</strong>：指定 AI 扮演特定角色，影响其回答风格和专业度。</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">你是一位拥有 <span class="hljs-number">15</span> 年经验的 Java 架构师，精通分布式系统设计、微服务架构和性能优化。<br><br>请以你的专业视角，分析以下代码的潜在问题：<br><span class="hljs-string"></span><br><span class="hljs-string">[代码内容]</span><br></code></pre></td></tr></table></figure><p><strong>常用角色模板</strong>：</p><table><thead><tr><th>角色</th><th>描述</th></tr></thead><tbody><tr><td>技术专家</td><td>“你是一位资深的 [领域] 专家”</td></tr><tr><td>代码审查员</td><td>“你是一位严格的代码审查员”</td></tr><tr><td>产品经理</td><td>“你是一位用户导向的产品经理”</td></tr><tr><td>教师</td><td>“你是一位耐心的编程教师”</td></tr></tbody></table><hr><h3 id="3-2-系统提示（System-Prompt）"><a href="#3-2-系统提示（System-Prompt）" class="headerlink" title="3.2 系统提示（System Prompt）"></a>3.2 系统提示（System Prompt）</h3><p><strong>定义</strong>：设置模型的行为准则和约束条件（API 调用时的 system 角色）。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;messages&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;system&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;你是一个专业的技术文档助手。规则：1. 只回答技术相关问题 2. 使用 Markdown 格式 3. 代码示例使用 Java&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;role&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;user&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;content&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;如何实现线程安全的单例模式？&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><hr><h3 id="3-3-上下文注入"><a href="#3-3-上下文注入" class="headerlink" title="3.3 上下文注入"></a>3.3 上下文注入</h3><p><strong>定义</strong>：在 Prompt 中提供相关背景知识（RAG 场景的核心）。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">## 背景知识</span><br><span class="hljs-string">以下是关于</span> <span class="hljs-string">Spring</span> <span class="hljs-string">AI</span> <span class="hljs-string">的官方文档摘要：</span><br><span class="hljs-meta">---</span><br>[<span class="hljs-string">检索到的文档内容</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment">## 用户问题</span><br><span class="hljs-string">如何在</span> <span class="hljs-string">Spring</span> <span class="hljs-string">AI</span> <span class="hljs-string">中配置</span> <span class="hljs-string">OpenAI</span> <span class="hljs-string">的</span> <span class="hljs-string">API</span> <span class="hljs-string">Key？</span><br><br><span class="hljs-comment">## 要求</span><br><span class="hljs-string">请根据背景知识回答问题，如果背景知识中没有相关信息，请明确说明。</span><br></code></pre></td></tr></table></figure><hr><h2 id="四、输出控制技术"><a href="#四、输出控制技术" class="headerlink" title="四、输出控制技术"></a>四、输出控制技术</h2><h3 id="4-1-格式约束"><a href="#4-1-格式约束" class="headerlink" title="4.1 格式约束"></a>4.1 格式约束</h3><h4 id="JSON-格式"><a href="#JSON-格式" class="headerlink" title="JSON 格式"></a>JSON 格式</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">请分析以下用户评论，以 <span class="hljs-built_in">JSON</span> 格式输出结果：<br><br>评论：这款手机拍照效果很好，但电池续航太差了。<br><br>输出格式：<br>&#123;<br>  <span class="hljs-string">&quot;sentiment&quot;</span>: <span class="hljs-string">&quot;正面/负面/中性&quot;</span>,<br>  <span class="hljs-string">&quot;aspects&quot;</span>: [<br>    &#123;<span class="hljs-string">&quot;aspect&quot;</span>: <span class="hljs-string">&quot;方面名&quot;</span>, <span class="hljs-string">&quot;sentiment&quot;</span>: <span class="hljs-string">&quot;正面/负面&quot;</span>, <span class="hljs-string">&quot;comment&quot;</span>: <span class="hljs-string">&quot;具体评价&quot;</span>&#125;<br>  ],<br>  <span class="hljs-string">&quot;summary&quot;</span>: <span class="hljs-string">&quot;一句话总结&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Markdown-格式"><a href="#Markdown-格式" class="headerlink" title="Markdown 格式"></a>Markdown 格式</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown">请用 Markdown 格式输出技术方案文档：<br><br><span class="hljs-section">## 要求</span><br><span class="hljs-bullet">-</span> 使用多级标题组织内容<br><span class="hljs-bullet">-</span> 代码块使用正确的语言标识<br><span class="hljs-bullet">-</span> 重点内容使用粗体<br><span class="hljs-bullet">-</span> 包含流程图（Mermaid）<br></code></pre></td></tr></table></figure><hr><h3 id="4-2-长度控制"><a href="#4-2-长度控制" class="headerlink" title="4.2 长度控制"></a>4.2 长度控制</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">请用不超过</span> <span class="hljs-number">100</span> <span class="hljs-string">字总结这篇文章的核心观点。</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-string">请详细解释这个概念，包括：</span><br><span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">定义（50字）</span><br><span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">工作原理（200字）</span><br><span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">应用场景（100字）</span><br><span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">代码示例（完整可运行）</span><br></code></pre></td></tr></table></figure><hr><h3 id="4-3-分隔符使用"><a href="#4-3-分隔符使用" class="headerlink" title="4.3 分隔符使用"></a>4.3 分隔符使用</h3><p>使用明确的分隔符避免 Prompt 注入和内容混淆：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs clean">请翻译以下文本，文本用 ### 包裹：<br><br>###<br>用户输入的内容<br>###<br><br>翻译结果：<br></code></pre></td></tr></table></figure><p>常用分隔符：</p><ul><li><code>###</code></li><li><code>---</code></li><li><code>&quot;&quot;&quot;</code> </li><li><code>&lt;text&gt;&lt;/text&gt;</code></li><li><code>[START][END]</code></li></ul><hr><h2 id="五、高级技术"><a href="#五、高级技术" class="headerlink" title="五、高级技术"></a>五、高级技术</h2><h3 id="5-1-ReAct（Reasoning-Acting）"><a href="#5-1-ReAct（Reasoning-Acting）" class="headerlink" title="5.1 ReAct（Reasoning + Acting）"></a>5.1 ReAct（Reasoning + Acting）</h3><p><strong>定义</strong>：推理与行动交替进行，适合 Agent 场景。</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">你是一个能够使用工具的 AI 助手。</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">可用工具：</span><br><span class="hljs-attribute">1. search(query) - 搜索信息</span><br><span class="hljs-attribute">2. calculator(expression) - 计算数学表达式</span><br><span class="hljs-attribute">3. get_weather(city) - 获取天气</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">请用以下格式回答问题：</span><br><span class="hljs-attribute"></span><br><span class="hljs-attribute">Thought</span><span class="hljs-punctuation">:</span> <span class="hljs-string">思考下一步该做什么</span><br><span class="hljs-attribute">Action</span><span class="hljs-punctuation">:</span> <span class="hljs-string">工具名称</span><br><span class="hljs-attribute">Action Input</span><span class="hljs-punctuation">:</span> <span class="hljs-string">工具输入</span><br><span class="hljs-attribute">Observation</span><span class="hljs-punctuation">:</span> <span class="hljs-string">工具返回结果</span><br><span class="hljs-attribute">... (重复直到得出答案)</span><br><span class="hljs-attribute">Thought</span><span class="hljs-punctuation">:</span> <span class="hljs-string">我现在知道最终答案了</span><br><span class="hljs-attribute">Final Answer</span><span class="hljs-punctuation">:</span> <span class="hljs-string">最终答案</span><br><br>问题：北京今天的气温是多少摄氏度？换算成华氏度是多少？<br></code></pre></td></tr></table></figure><hr><h3 id="5-2-Generated-Knowledge-Prompting"><a href="#5-2-Generated-Knowledge-Prompting" class="headerlink" title="5.2 Generated Knowledge Prompting"></a>5.2 Generated Knowledge Prompting</h3><p><strong>定义</strong>：让模型先生成相关知识，再基于知识回答问题。</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs clean">## 第一步：生成知识<br>请列出关于 Java 线程池的 <span class="hljs-number">5</span> 个关键知识点。<br><br>## 第二步：回答问题<br>基于以上知识，解释为什么不建议使用 Executors.newFixedThreadPool()？<br></code></pre></td></tr></table></figure><hr><h3 id="5-3-Directional-Stimulus-Prompting"><a href="#5-3-Directional-Stimulus-Prompting" class="headerlink" title="5.3 Directional Stimulus Prompting"></a>5.3 Directional Stimulus Prompting</h3><p><strong>定义</strong>：提供提示词暗示，引导模型输出方向。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">请写一首关于春天的诗。<br><br>提示词：花开、暖风、希望、新生<br></code></pre></td></tr></table></figure><hr><h2 id="六、Prompt-模板库"><a href="#六、Prompt-模板库" class="headerlink" title="六、Prompt 模板库"></a>六、Prompt 模板库</h2><h3 id="6-1-代码审查模板"><a href="#6-1-代码审查模板" class="headerlink" title="6.1 代码审查模板"></a>6.1 代码审查模板</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">你是一位资深的 Java 代码审查专家。<br><br>请审查以下代码，从以下维度分析：<br><span class="hljs-bullet">1.</span> <span class="hljs-strong">**代码规范**</span>：命名、格式、注释<br><span class="hljs-bullet">2.</span> <span class="hljs-strong">**潜在 Bug**</span>：空指针、并发问题、资源泄露<br><span class="hljs-bullet">3.</span> <span class="hljs-strong">**性能问题**</span>：时间复杂度、内存使用<br><span class="hljs-bullet">4.</span> <span class="hljs-strong">**安全风险**</span>：SQL 注入、XSS 等<br><span class="hljs-bullet">5.</span> <span class="hljs-strong">**可维护性**</span>：代码复杂度、可测试性<br><br>代码：<br><span class="hljs-code">```java</span><br><span class="hljs-code">[代码内容]</span><br></code></pre></td></tr></table></figure><p>输出格式：</p><table><thead><tr><th>问题</th><th>严重程度</th><th>位置</th><th>修改建议</th></tr></thead></table><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment">### 6.2 技术方案模板</span><br><br></code></pre></td></tr></table></figure><p>请设计一个技术方案，要求：</p><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>[问题描述]</p><h2 id="输出要求"><a href="#输出要求" class="headerlink" title="输出要求"></a>输出要求</h2><ol><li><strong>需求分析</strong>：明确功能和非功能需求</li><li><strong>架构设计</strong>：整体架构图（Mermaid）</li><li><strong>技术选型</strong>：框架、中间件选择及理由</li><li><strong>核心流程</strong>：关键流程时序图</li><li><strong>数据设计</strong>：核心表结构</li><li><strong>风险评估</strong>：潜在风险及应对策略</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-comment">### 6.3 Debug 助手模板</span><br><br></code></pre></td></tr></table></figure><p>你是一位经验丰富的 Debug 专家。</p><h2 id="错误信息"><a href="#错误信息" class="headerlink" title="错误信息"></a>错误信息</h2><p>[错误日志]</p><h2 id="相关代码"><a href="#相关代码" class="headerlink" title="相关代码"></a>相关代码</h2><p>[代码片段]</p><h2 id="请分析"><a href="#请分析" class="headerlink" title="请分析"></a>请分析</h2><ol><li>错误的直接原因</li><li>根本原因分析</li><li>解决方案（给出具体代码）</li><li>如何避免类似问题</li></ol><pre><code class="hljs">---## 七、最佳实践### 7.1 Prompt 设计原则| 原则 | 说明 ||------|------|| **明确具体** | 避免模糊表述，明确任务目标 || **结构清晰** | 使用分隔符、编号组织内容 || **提供示例** | 复杂任务用 Few-shot 引导 || **迭代优化** | 根据输出效果不断调整 || **控制长度** | 避免过长导致信息丢失 |### 7.2 常见错误| 错误 | 示例 | 改进 ||------|------|------|| 过于模糊 | &quot;帮我写代码&quot; | &quot;用 Java 实现一个线程安全的 LRU 缓存&quot; || 缺少上下文 | &quot;这个报错怎么解决&quot; | &quot;Spring Boot 3.x 启动报错：[具体错误]&quot; || 期望过高 | &quot;写一个完整的电商系统&quot; | 拆分为多个小任务逐步实现 |### 7.3 调试技巧1. **打印思考过程**：加入 &quot;请展示你的推理过程&quot;2. **要求自我检查**：加入 &quot;请检查答案是否正确&quot;3. **分步验证**：复杂任务拆分为多轮对话---## 八、工具与资源### 在线工具| 工具 | 用途 ||------|------|| [PromptPerfect](https://promptperfect.jina.ai/) | Prompt 优化 || [OpenAI Playground](https://platform.openai.com/playground) | 在线测试 || [LangSmith](https://smith.langchain.com/) | Prompt 管理与追踪 |### 学习资源- [Prompt Engineering Guide](https://www.promptingguide.ai/)- [OpenAI Prompt Engineering](https://platform.openai.com/docs/guides/prompt-engineering)- [Learn Prompting](https://learnprompting.org/)---## 相关笔记- 大模型学习路线- LLM应用开发- RAG技术详解</code></pre>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>大模型</tag>
      
      <tag>Prompt</tag>
      
      <tag>提示词工程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SPARQL详解</title>
    <link href="/2026/01/12/SPARQL%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/SPARQL%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="SPARQL-详解"><a href="#SPARQL-详解" class="headerlink" title="SPARQL 详解"></a>SPARQL 详解</h1><blockquote><p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 三元组详解</p></blockquote><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>SPARQL（SPARQL Protocol and RDF Query Language）</strong> 是 W3C 标准的 RDF 查询语言，类似于关系数据库的 SQL，用于查询和操作 RDF 数据。</p><h2 id="查询类型"><a href="#查询类型" class="headerlink" title="查询类型"></a>查询类型</h2><table><thead><tr><th>类型</th><th>用途</th></tr></thead><tbody><tr><td><code>SELECT</code></td><td>返回匹配的变量绑定</td></tr><tr><td><code>CONSTRUCT</code></td><td>构造新的 RDF 图</td></tr><tr><td><code>ASK</code></td><td>返回布尔值（是否存在匹配）</td></tr><tr><td><code>DESCRIBE</code></td><td>返回资源的描述信息</td></tr></tbody></table><h2 id="基本语法结构"><a href="#基本语法结构" class="headerlink" title="基本语法结构"></a>基本语法结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sparql">PREFIX ex: &lt;http://example.org/&gt;<br>PREFIX foaf: &lt;http://xmlns.com/foaf/0.1/&gt;<br><br>SELECT ?name ?age<br>WHERE &#123;<br>    ?person foaf:name ?name .<br>    ?person ex:年龄 ?age .<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="语法要素"><a href="#语法要素" class="headerlink" title="语法要素"></a>语法要素</h3><table><thead><tr><th>要素</th><th>说明</th></tr></thead><tbody><tr><td><code>PREFIX</code></td><td>定义命名空间前缀</td></tr><tr><td><code>SELECT</code></td><td>指定返回的变量</td></tr><tr><td><code>WHERE</code></td><td>定义图模式（匹配条件）</td></tr><tr><td><code>?var</code></td><td>变量，以 <code>?</code> 或 <code>$</code> 开头</td></tr><tr><td><code>.</code></td><td>三元组模式分隔符</td></tr></tbody></table><h2 id="基础查询示例"><a href="#基础查询示例" class="headerlink" title="基础查询示例"></a>基础查询示例</h2><h3 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询所有人的名字<br>SELECT ?name<br>WHERE &#123;<br>    ?person a ex:Person .<br>    ?person foaf:name ?name .<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="可选匹配（OPTIONAL）"><a href="#可选匹配（OPTIONAL）" class="headerlink" title="可选匹配（OPTIONAL）"></a>可选匹配（OPTIONAL）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询人名，年龄可选<br>SELECT ?name ?age<br>WHERE &#123;<br>    ?person foaf:name ?name .<br>    OPTIONAL &#123; ?person ex:年龄 ?age &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="过滤条件（FILTER）"><a href="#过滤条件（FILTER）" class="headerlink" title="过滤条件（FILTER）"></a>过滤条件（FILTER）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询年龄大于 20 的人<br>SELECT ?name ?age<br>WHERE &#123;<br>    ?person foaf:name ?name .<br>    ?person ex:年龄 ?age .<br>    FILTER (?age &gt; 20)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="常用过滤函数"><a href="#常用过滤函数" class="headerlink" title="常用过滤函数"></a>常用过滤函数</h2><table><thead><tr><th>函数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>FILTER</code></td><td>条件过滤</td><td><code>FILTER (?age &gt; 20)</code></td></tr><tr><td><code>REGEX</code></td><td>正则匹配</td><td><code>FILTER REGEX(?name, &quot;^张&quot;)</code></td></tr><tr><td><code>BOUND</code></td><td>检查变量是否绑定</td><td><code>FILTER BOUND(?age)</code></td></tr><tr><td><code>LANG</code></td><td>获取语言标签</td><td><code>FILTER (LANG(?name) = &quot;zh&quot;)</code></td></tr><tr><td><code>STR</code></td><td>转换为字符串</td><td><code>STR(?uri)</code></td></tr></tbody></table><h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 统计每个城市的人数<br>SELECT ?city (COUNT(?person) AS ?count)<br>WHERE &#123;<br>    ?person ex:居住于 ?city .<br>&#125;<br>GROUP BY ?city<br>HAVING (COUNT(?person) &gt; 10)<br>ORDER BY DESC(?count)<br>LIMIT 10<br></code></pre></td></tr></table></figure><h3 id="聚合函数列表"><a href="#聚合函数列表" class="headerlink" title="聚合函数列表"></a>聚合函数列表</h3><table><thead><tr><th>函数</th><th>说明</th></tr></thead><tbody><tr><td><code>COUNT</code></td><td>计数</td></tr><tr><td><code>SUM</code></td><td>求和</td></tr><tr><td><code>AVG</code></td><td>平均值</td></tr><tr><td><code>MIN</code> &#x2F; <code>MAX</code></td><td>最小&#x2F;最大值</td></tr><tr><td><code>GROUP_CONCAT</code></td><td>字符串连接</td></tr><tr><td><code>SAMPLE</code></td><td>随机取样</td></tr></tbody></table><h2 id="高级查询"><a href="#高级查询" class="headerlink" title="高级查询"></a>高级查询</h2><h3 id="UNION（联合查询）"><a href="#UNION（联合查询）" class="headerlink" title="UNION（联合查询）"></a>UNION（联合查询）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询认识或喜欢李四的人<br>SELECT ?person<br>WHERE &#123;<br>    &#123; ?person ex:认识 ex:李四 &#125;<br>    UNION<br>    &#123; ?person ex:喜欢 ex:李四 &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="MINUS（差集）"><a href="#MINUS（差集）" class="headerlink" title="MINUS（差集）"></a>MINUS（差集）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询没有年龄信息的人<br>SELECT ?person<br>WHERE &#123;<br>    ?person a ex:Person .<br>    MINUS &#123; ?person ex:年龄 ?age &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询好友数最多的人<br>SELECT ?person ?friendCount<br>WHERE &#123;<br>    &#123;<br>        SELECT ?person (COUNT(?friend) AS ?friendCount)<br>        WHERE &#123;<br>            ?person ex:认识 ?friend .<br>        &#125;<br>        GROUP BY ?person<br>    &#125;<br>&#125;<br>ORDER BY DESC(?friendCount)<br>LIMIT 1<br></code></pre></td></tr></table></figure><h2 id="属性路径"><a href="#属性路径" class="headerlink" title="属性路径"></a>属性路径</h2><p>SPARQL 1.1 支持属性路径表达式：</p><table><thead><tr><th>语法</th><th>含义</th></tr></thead><tbody><tr><td><code>ex:a/ex:b</code></td><td>路径连接（a 然后 b）</td></tr><tr><td><code>ex:a|ex:b</code></td><td>路径选择（a 或 b）</td></tr><tr><td><code>ex:a*</code></td><td>零或多次</td></tr><tr><td><code>ex:a+</code></td><td>一或多次</td></tr><tr><td><code>ex:a?</code></td><td>零或一次</td></tr><tr><td><code>^ex:a</code></td><td>反向路径</td></tr></tbody></table><h3 id="属性路径示例"><a href="#属性路径示例" class="headerlink" title="属性路径示例"></a>属性路径示例</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询张三直接或间接认识的人（传递闭包）<br>SELECT ?person<br>WHERE &#123;<br>    ex:张三 ex:认识+ ?person .<br>&#125;<br><br># 查询张三的朋友的朋友<br>SELECT ?fof<br>WHERE &#123;<br>    ex:张三 ex:认识/ex:认识 ?fof .<br>    FILTER (?fof != ex:张三)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="CONSTRUCT-构造查询"><a href="#CONSTRUCT-构造查询" class="headerlink" title="CONSTRUCT 构造查询"></a>CONSTRUCT 构造查询</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 构造新的 RDF 图<br>CONSTRUCT &#123;<br>    ?person ex:is_adult true .<br>&#125;<br>WHERE &#123;<br>    ?person ex:年龄 ?age .<br>    FILTER (?age &gt;= 18)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="更新操作（SPARQL-Update）"><a href="#更新操作（SPARQL-Update）" class="headerlink" title="更新操作（SPARQL Update）"></a>更新操作（SPARQL Update）</h2><h3 id="INSERT-DATA"><a href="#INSERT-DATA" class="headerlink" title="INSERT DATA"></a>INSERT DATA</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sparql">INSERT DATA &#123;<br>    ex:王五 a ex:Person ;<br>           foaf:name &quot;王五&quot; ;<br>           ex:年龄 30 .<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DELETE-DATA"><a href="#DELETE-DATA" class="headerlink" title="DELETE DATA"></a>DELETE DATA</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sparql">DELETE DATA &#123;<br>    ex:张三 ex:年龄 25 .<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="DELETE-INSERT"><a href="#DELETE-INSERT" class="headerlink" title="DELETE&#x2F;INSERT"></a>DELETE&#x2F;INSERT</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sparql">DELETE &#123; ?person ex:年龄 ?oldAge &#125;<br>INSERT &#123; ?person ex:年龄 ?newAge &#125;<br>WHERE &#123;<br>    ?person ex:年龄 ?oldAge .<br>    BIND (?oldAge + 1 AS ?newAge)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="常用-SPARQL-端点"><a href="#常用-SPARQL-端点" class="headerlink" title="常用 SPARQL 端点"></a>常用 SPARQL 端点</h2><table><thead><tr><th>端点</th><th>URL</th></tr></thead><tbody><tr><td>DBpedia</td><td><code>https://dbpedia.org/sparql</code></td></tr><tr><td>Wikidata</td><td><code>https://query.wikidata.org/sparql</code></td></tr><tr><td>UniProt</td><td><code>https://sparql.uniprot.org/sparql</code></td></tr></tbody></table><h2 id="查询示例：Wikidata"><a href="#查询示例：Wikidata" class="headerlink" title="查询示例：Wikidata"></a>查询示例：Wikidata</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询所有中国城市<br>SELECT ?city ?cityLabel ?population<br>WHERE &#123;<br>    ?city wdt:P31 wd:Q515 .        # 实例类型：城市<br>    ?city wdt:P17 wd:Q148 .        # 所属国家：中国<br>    OPTIONAL &#123; ?city wdt:P1082 ?population &#125;<br>    SERVICE wikibase:label &#123; bd:serviceParam wikibase:language &quot;zh,en&quot; &#125;<br>&#125;<br>ORDER BY DESC(?population)<br>LIMIT 20<br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>三元组详解 - 衍生来源</li><li>RDF规范 - SPARQL 查询的数据格式</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>图数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>图数据库</tag>
      
      <tag>RDF</tag>
      
      <tag>全文引用</tag>
      
      <tag>SPARQL</tag>
      
      <tag>查询语言</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>三元组详解</title>
    <link href="/2026/01/12/%E4%B8%89%E5%85%83%E7%BB%84%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/%E4%B8%89%E5%85%83%E7%BB%84%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="三元组详解"><a href="#三元组详解" class="headerlink" title="三元组详解"></a>三元组详解</h1><h2 id="什么是三元组"><a href="#什么是三元组" class="headerlink" title="什么是三元组"></a>什么是三元组</h2><p>三元组（Triple）是 <strong>RDF 图数据库</strong> 中的基本数据存储单元，用于表达一个完整的事实陈述。</p><h3 id="三元组组成"><a href="#三元组组成" class="headerlink" title="三元组组成"></a>三元组组成</h3><table><thead><tr><th>组成部分</th><th>英文</th><th>说明</th></tr></thead><tbody><tr><td><strong>主语</strong></td><td>Subject</td><td>被描述的实体或资源</td></tr><tr><td><strong>谓语</strong></td><td>Predicate</td><td>关系或属性</td></tr><tr><td><strong>宾语</strong></td><td>Object</td><td>属性值或关联的另一个实体</td></tr></tbody></table><h3 id="基本形式"><a href="#基本形式" class="headerlink" title="基本形式"></a>基本形式</h3><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clojure">(<span class="hljs-name">Subject</span><span class="hljs-punctuation">,</span> Predicate<span class="hljs-punctuation">,</span> Object)<br></code></pre></td></tr></table></figure><h2 id="三元组示例"><a href="#三元组示例" class="headerlink" title="三元组示例"></a>三元组示例</h2><h3 id="表示关系"><a href="#表示关系" class="headerlink" title="表示关系"></a>表示关系</h3><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clojure">(张三<span class="hljs-punctuation">,</span> 认识<span class="hljs-punctuation">,</span> 李四)<br>(北京<span class="hljs-punctuation">,</span> 是首都<span class="hljs-punctuation">,</span> 中国)<br>(<span class="hljs-name">Java</span><span class="hljs-punctuation">,</span> 属于<span class="hljs-punctuation">,</span> 编程语言)<br></code></pre></td></tr></table></figure><h3 id="表示属性"><a href="#表示属性" class="headerlink" title="表示属性"></a>表示属性</h3><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clojure">(张三<span class="hljs-punctuation">,</span> 年龄<span class="hljs-punctuation">,</span> <span class="hljs-number">25</span>)<br>(张三<span class="hljs-punctuation">,</span> 职业<span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;软件工程师&quot;</span>)<br>(北京<span class="hljs-punctuation">,</span> 人口<span class="hljs-punctuation">,</span> <span class="hljs-number">21540000</span>)<br></code></pre></td></tr></table></figure><h2 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h2><ul><li><strong>原子性</strong>：每个三元组表达一个独立、不可分割的事实</li><li><strong>可组合</strong>：多个三元组通过共享节点形成复杂的知识图谱</li><li><strong>语义明确</strong>：谓语精确定义了主语和宾语之间的关系</li><li><strong>标准化</strong>：遵循 W3C RDF 标准，具有良好的互操作性</li></ul><h2 id="三元组-vs-属性图"><a href="#三元组-vs-属性图" class="headerlink" title="三元组 vs 属性图"></a>三元组 vs 属性图</h2><p>图数据库分为两大流派：<strong>RDF 图数据库</strong>和<strong>属性图数据库</strong>，虽然都是图数据库，但数据模型不同。👉详解 ^model-comparison</p><table><thead><tr><th>特性</th><th>三元组模型（RDF）</th><th>属性图模型</th></tr></thead><tbody><tr><td>代表数据库</td><td>Apache Jena、Stardog</td><td>Neo4j、JanusGraph</td></tr><tr><td>边的属性</td><td>需要额外三元组表示（具体化）</td><td>边可直接附加属性</td></tr><tr><td>查询语言</td><td>SPARQL</td><td>Cypher、Gremlin</td></tr><tr><td>标准化程度</td><td>W3C 标准</td><td>无统一标准</td></tr><tr><td>适用场景</td><td>语义网、本体建模</td><td>社交网络、推荐系统</td></tr></tbody></table><h2 id="RDF-三元组表示法"><a href="#RDF-三元组表示法" class="headerlink" title="RDF 三元组表示法"></a>RDF 三元组表示法</h2><h3 id="N-Triples-格式"><a href="#N-Triples-格式" class="headerlink" title="N-Triples 格式"></a>N-Triples 格式</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">&lt;http:<span class="hljs-regexp">//</span>example.org<span class="hljs-regexp">/张三&gt; &lt;http:/</span><span class="hljs-regexp">/example.org/</span>认识&gt; &lt;http:<span class="hljs-regexp">//</span>example.org/李四&gt; .<br>&lt;http:<span class="hljs-regexp">//</span>example.org<span class="hljs-regexp">/张三&gt; &lt;http:/</span><span class="hljs-regexp">/example.org/</span>年龄&gt; <span class="hljs-string">&quot;25&quot;</span>^^&lt;http:<span class="hljs-regexp">//</span>www.w3.org<span class="hljs-regexp">/2001/</span>XMLSchema<span class="hljs-comment">#integer&gt; .</span><br></code></pre></td></tr></table></figure><h3 id="Turtle-格式"><a href="#Turtle-格式" class="headerlink" title="Turtle 格式"></a>Turtle 格式</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs turtle">@prefix ex: &lt;http://example.org/&gt; .<br>@prefix xsd: &lt;http://www.w3.org/2001/XMLSchema#&gt; .<br><br>ex:张三 ex:认识 ex:李四 ;<br>        ex:年龄 &quot;25&quot;^^xsd:integer .<br></code></pre></td></tr></table></figure><h2 id="SPARQL-查询示例"><a href="#SPARQL-查询示例" class="headerlink" title="SPARQL 查询示例"></a>SPARQL 查询示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sparql"># 查询张三认识的所有人<br>SELECT ?person<br>WHERE &#123;<br>    ex:张三 ex:认识 ?person .<br>&#125;<br><br># 查询所有年龄大于20的人<br>SELECT ?person ?age<br>WHERE &#123;<br>    ?person ex:年龄 ?age .<br>    FILTER (?age &gt; 20)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="三元组在知识图谱中的应用"><a href="#三元组在知识图谱中的应用" class="headerlink" title="三元组在知识图谱中的应用"></a>三元组在知识图谱中的应用</h2><pre><code class=" mermaid">graph LR    A[张三] --&gt;|认识| B[李四]    A --&gt;|工作于| C[阿里巴巴]    B --&gt;|工作于| D[腾讯]    C --&gt;|位于| E[杭州]    D --&gt;|位于| F[深圳]</code></pre><h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><ul><li><strong>知识图谱</strong>：Google Knowledge Graph、百度知识图谱</li><li><strong>语义网</strong>：Linked Open Data</li><li><strong>本体建模</strong>：OWL 本体描述</li><li><strong>智能问答</strong>：基于知识图谱的问答系统</li><li><strong>推荐系统</strong>：基于知识图谱的推荐</li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>三元组是图数据库的基础数据结构，通过 <code>(主语, 谓语, 宾语)</code> 的形式表达事实。它是构建知识图谱的基石，广泛应用于语义网、智能问答等领域。</p>]]></content>
    
    
    <categories>
      
      <category>数据库</category>
      
      <category>图数据库</category>
      
    </categories>
    
    
    <tags>
      
      <tag>图数据库</tag>
      
      <tag>RDF</tag>
      
      <tag>三元组</tag>
      
      <tag>知识图谱</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reflexion自反思Agent详解</title>
    <link href="/2026/01/12/Reflexion%E8%87%AA%E5%8F%8D%E6%80%9DAgent%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/Reflexion%E8%87%AA%E5%8F%8D%E6%80%9DAgent%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Reflexion-自反思-Agent-详解"><a href="#Reflexion-自反思-Agent-详解" class="headerlink" title="Reflexion 自反思 Agent 详解"></a>Reflexion 自反思 Agent 详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>Reflexion</strong> 是一种让 Agent 具备”从错误中学习”能力的架构模式。核心思想是：执行任务后进行自我评估和反思，将经验教训存入记忆，在后续尝试中避免重复错误。</p><blockquote><p><strong>💡 提示: 核心价值</strong><br>传统 Agent 每次都是”从零开始”，而 Reflexion Agent 能够<strong>积累经验、持续改进</strong>。</p></blockquote><h2 id="与传统-Agent-的对比"><a href="#与传统-Agent-的对比" class="headerlink" title="与传统 Agent 的对比"></a>与传统 Agent 的对比</h2><table><thead><tr><th>维度</th><th>传统 Agent</th><th>Reflexion Agent</th></tr></thead><tbody><tr><td>失败处理</td><td>简单重试</td><td>反思后改进再试</td></tr><tr><td>经验积累</td><td>无</td><td>有（记忆模块）</td></tr><tr><td>学习能力</td><td>无</td><td>从错误中学习</td></tr><tr><td>成功率</td><td>随机</td><td>逐次提升</td></tr></tbody></table><hr><h2 id="一、核心架构"><a href="#一、核心架构" class="headerlink" title="一、核心架构"></a>一、核心架构</h2><h3 id="1-1-三大组件"><a href="#1-1-三大组件" class="headerlink" title="1.1 三大组件"></a>1.1 三大组件</h3><pre><code class=" mermaid">graph TB    subgraph Reflexion Agent        A[Actor&lt;br/&gt;执行者] --&gt; B[Evaluator&lt;br/&gt;评估者]        B --&gt; C&#123;成功?&#125;        C --&gt;|是| D[返回结果]        C --&gt;|否| E[Self-Reflection&lt;br/&gt;自反思]        E --&gt; F[Memory&lt;br/&gt;经验记忆]        F --&gt; A    end</code></pre><table><thead><tr><th>组件</th><th>职责</th><th>输入</th><th>输出</th></tr></thead><tbody><tr><td><strong>Actor</strong></td><td>执行任务</td><td>任务 + 历史经验</td><td>执行结果</td></tr><tr><td><strong>Evaluator</strong></td><td>评估结果质量</td><td>任务 + 结果</td><td>成功&#x2F;失败 + 反馈</td></tr><tr><td><strong>Self-Reflection</strong></td><td>分析失败原因</td><td>执行历史 + 评估反馈</td><td>经验教训</td></tr><tr><td><strong>Memory</strong></td><td>存储经验</td><td>反思结果</td><td>历史经验列表</td></tr></tbody></table><h3 id="1-2-执行流程"><a href="#1-2-执行流程" class="headerlink" title="1.2 执行流程"></a>1.2 执行流程</h3><pre><code class=" mermaid">sequenceDiagram    participant U as 用户    participant A as Actor    participant E as Evaluator    participant R as Self-Reflection    participant M as Memory        U-&gt;&gt;A: 任务    M-&gt;&gt;A: 历史经验    A-&gt;&gt;E: 执行结果    E-&gt;&gt;E: 评估        alt 成功        E-&gt;&gt;U: 返回结果    else 失败        E-&gt;&gt;R: 评估反馈        R-&gt;&gt;R: 反思分析        R-&gt;&gt;M: 存储经验        M-&gt;&gt;A: 更新经验        Note over A: 重新尝试    end</code></pre><hr><h2 id="二、各组件详解"><a href="#二、各组件详解" class="headerlink" title="二、各组件详解"></a>二、各组件详解</h2><h3 id="2-1-Actor（执行者）"><a href="#2-1-Actor（执行者）" class="headerlink" title="2.1 Actor（执行者）"></a>2.1 Actor（执行者）</h3><p>Actor 负责实际执行任务，但会参考历史经验避免重复错误。</p><h4 id="Prompt-模板"><a href="#Prompt-模板" class="headerlink" title="Prompt 模板"></a>Prompt 模板</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs clean">你是一个智能助手，负责完成用户任务。<br><br>## 任务<br>&#123;task&#125;<br><br>## 历史经验教训（请务必参考，避免重复错误）<br>&#123;experiences&#125;<br><br>## 要求<br><span class="hljs-number">1.</span> 仔细阅读历史经验，避免犯同样的错误<br><span class="hljs-number">2.</span> 如果历史经验提到某种方法不可行，请尝试其他方法<br><span class="hljs-number">3.</span> 输出你的思考过程和最终结果<br><br>## 输出格式<br>### 思考<br>[分析任务，参考经验，规划方案]<br><br>### 执行<br>[具体执行步骤和结果]<br></code></pre></td></tr></table></figure><h4 id="Java-实现"><a href="#Java-实现" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Actor</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-keyword">public</span> ActorResult <span class="hljs-title function_">execute</span><span class="hljs-params">(String task, List&lt;String&gt; experiences)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">experienceText</span> <span class="hljs-operator">=</span> experiences.isEmpty() <br>            ? <span class="hljs-string">&quot;暂无历史经验&quot;</span><br>            : experiences.stream()<br>                .map(e -&gt; <span class="hljs-string">&quot;- &quot;</span> + e)<br>                .collect(Collectors.joining(<span class="hljs-string">&quot;\n&quot;</span>));<br>        <br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt()<br>            .system(ACTOR_PROMPT)<br>            .user(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                ## 任务</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                </span><br><span class="hljs-string">                ## 历史经验教训</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>.formatted(task, experienceText))<br>            .call()<br>            .content();<br>        <br>        <span class="hljs-keyword">return</span> parseActorResult(response);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ActorResult</span> &#123;<br>    <span class="hljs-keyword">private</span> String thinking;      <span class="hljs-comment">// 思考过程</span><br>    <span class="hljs-keyword">private</span> String execution;     <span class="hljs-comment">// 执行结果</span><br>    <span class="hljs-keyword">private</span> List&lt;String&gt; actions; <span class="hljs-comment">// 执行的动作列表</span><br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="2-2-Evaluator（评估者）"><a href="#2-2-Evaluator（评估者）" class="headerlink" title="2.2 Evaluator（评估者）"></a>2.2 Evaluator（评估者）</h3><p>Evaluator 负责判断执行结果是否达标，可以用 LLM 评估、规则评估或测试用例评估。</p><h4 id="评估方式对比"><a href="#评估方式对比" class="headerlink" title="评估方式对比"></a>评估方式对比</h4><table><thead><tr><th>评估方式</th><th>适用场景</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>LLM 评估</strong></td><td>开放性任务</td><td>灵活</td><td>可能不准确</td></tr><tr><td><strong>规则评估</strong></td><td>有明确标准的任务</td><td>准确</td><td>不够灵活</td></tr><tr><td><strong>测试用例</strong></td><td>代码生成任务</td><td>客观准确</td><td>需要预先准备</td></tr><tr><td><strong>人工评估</strong></td><td>高风险决策</td><td>最准确</td><td>成本高</td></tr></tbody></table><h4 id="LLM-评估-Prompt"><a href="#LLM-评估-Prompt" class="headerlink" title="LLM 评估 Prompt"></a>LLM 评估 Prompt</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs clean">你是一个严格的任务评估专家。<br><br>## 原始任务<br>&#123;task&#125;<br><br>## 执行结果<br>&#123;result&#125;<br><br>## 评估维度<br><span class="hljs-number">1.</span> **正确性**：结果是否正确完成了任务要求<br><span class="hljs-number">2.</span> **完整性**：是否覆盖了所有要求<br><span class="hljs-number">3.</span> **质量**：结果的质量如何<br><br>## 输出格式（JSON）<br>&#123;<br>  <span class="hljs-string">&quot;success&quot;</span>: true/false,<br>  <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0</span><span class="hljs-number">-100</span>,<br>  <span class="hljs-string">&quot;dimensions&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;correctness&quot;</span>: &#123;<span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0</span><span class="hljs-number">-100</span>, <span class="hljs-string">&quot;feedback&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>&#125;,<br>    <span class="hljs-string">&quot;completeness&quot;</span>: &#123;<span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0</span><span class="hljs-number">-100</span>, <span class="hljs-string">&quot;feedback&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>&#125;,<br>    <span class="hljs-string">&quot;quality&quot;</span>: &#123;<span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">0</span><span class="hljs-number">-100</span>, <span class="hljs-string">&quot;feedback&quot;</span>: <span class="hljs-string">&quot;...&quot;</span>&#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;overall_feedback&quot;</span>: <span class="hljs-string">&quot;总体评价&quot;</span>,<br>  <span class="hljs-string">&quot;specific_issues&quot;</span>: [<span class="hljs-string">&quot;问题1&quot;</span>, <span class="hljs-string">&quot;问题2&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Java-实现-1"><a href="#Java-实现-1" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Evaluator</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-comment">// LLM 评估</span><br>    <span class="hljs-keyword">public</span> EvaluationResult <span class="hljs-title function_">evaluateWithLLM</span><span class="hljs-params">(String task, String result)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt()<br>            .system(EVALUATOR_PROMPT)<br>            .user(<span class="hljs-string">&quot;任务：%s\n\n结果：%s&quot;</span>.formatted(task, result))<br>            .call()<br>            .content();<br>        <br>        <span class="hljs-keyword">return</span> parseJson(response, EvaluationResult.class);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 代码任务：测试用例评估</span><br>    <span class="hljs-keyword">public</span> EvaluationResult <span class="hljs-title function_">evaluateCode</span><span class="hljs-params">(String code, List&lt;TestCase&gt; testCases)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">passed</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        List&lt;String&gt; failures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">for</span> (TestCase tc : testCases) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> executeCode(code, tc.getInput());<br>                <span class="hljs-keyword">if</span> (tc.getExpected().equals(result)) &#123;<br>                    passed++;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    failures.add(<span class="hljs-string">&quot;输入 %s 期望 %s 实际 %s&quot;</span><br>                        .formatted(tc.getInput(), tc.getExpected(), result));<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                failures.add(<span class="hljs-string">&quot;输入 %s 执行异常：%s&quot;</span><br>                    .formatted(tc.getInput(), e.getMessage()));<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-type">int</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> passed * <span class="hljs-number">100</span> / testCases.size();<br>        <span class="hljs-keyword">return</span> EvaluationResult.builder()<br>            .success(score &gt;= <span class="hljs-number">100</span>)<br>            .score(score)<br>            .specificIssues(failures)<br>            .build();<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvaluationResult</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> success;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> score;<br>    <span class="hljs-keyword">private</span> Map&lt;String, DimensionScore&gt; dimensions;<br>    <span class="hljs-keyword">private</span> String overallFeedback;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; specificIssues;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="2-3-Self-Reflection（自反思）"><a href="#2-3-Self-Reflection（自反思）" class="headerlink" title="2.3 Self-Reflection（自反思）"></a>2.3 Self-Reflection（自反思）</h3><p>Self-Reflection 是 Reflexion 的核心，负责深度分析失败原因并总结经验。</p><h4 id="反思-Prompt"><a href="#反思-Prompt" class="headerlink" title="反思 Prompt"></a>反思 Prompt</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs clean">你是一个善于反思和总结的分析专家。<br><br>## 任务目标<br>&#123;task&#125;<br><br>## 执行过程<br>&#123;execution_trace&#125;<br><br>## 执行结果<br>&#123;result&#125;<br><br>## 评估反馈<br>&#123;evaluation_feedback&#125;<br><br>## 请进行深度反思<br><br>### <span class="hljs-number">1.</span> 问题诊断<br>- 这次尝试具体哪里出了问题？<br>- 是理解错误、方法错误还是执行错误？<br><br>### <span class="hljs-number">2.</span> 根因分析<br>- 问题的根本原因是什么？<br>- 是否有错误的假设？<br><br>### <span class="hljs-number">3.</span> 经验总结<br>- 从这次失败中学到了什么？<br>- 下次遇到类似问题应该如何处理？<br><br>### <span class="hljs-number">4.</span> 改进方案<br>- 具体的改进措施是什么？<br>- 下一次尝试应该怎么做？<br><br>## 输出格式（JSON）<br>&#123;<br>  <span class="hljs-string">&quot;problem_diagnosis&quot;</span>: <span class="hljs-string">&quot;问题诊断&quot;</span>,<br>  <span class="hljs-string">&quot;root_cause&quot;</span>: <span class="hljs-string">&quot;根本原因&quot;</span>,<br>  <span class="hljs-string">&quot;lessons_learned&quot;</span>: [<br>    <span class="hljs-string">&quot;经验1：...&quot;</span>,<br>    <span class="hljs-string">&quot;经验2：...&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;improvement_plan&quot;</span>: <span class="hljs-string">&quot;改进方案&quot;</span>,<br>  <span class="hljs-string">&quot;confidence&quot;</span>: <span class="hljs-number">0</span><span class="hljs-number">-100</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Java-实现-2"><a href="#Java-实现-2" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfReflection</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-keyword">public</span> ReflectionResult <span class="hljs-title function_">reflect</span><span class="hljs-params">(ReflectionInput input)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt()<br>            .system(REFLECTION_PROMPT)<br>            .user(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                ## 任务目标</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                </span><br><span class="hljs-string">                ## 执行过程</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                </span><br><span class="hljs-string">                ## 执行结果</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                </span><br><span class="hljs-string">                ## 评估反馈</span><br><span class="hljs-string">                %s</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>.formatted(<br>                    input.getTask(),<br>                    input.getExecutionTrace(),<br>                    input.getResult(),<br>                    input.getEvaluationFeedback()<br>                ))<br>            .call()<br>            .content();<br>        <br>        <span class="hljs-keyword">return</span> parseJson(response, ReflectionResult.class);<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionInput</span> &#123;<br>    <span class="hljs-keyword">private</span> String task;<br>    <span class="hljs-keyword">private</span> String executionTrace;<br>    <span class="hljs-keyword">private</span> String result;<br>    <span class="hljs-keyword">private</span> String evaluationFeedback;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflectionResult</span> &#123;<br>    <span class="hljs-keyword">private</span> String problemDiagnosis;<br>    <span class="hljs-keyword">private</span> String rootCause;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; lessonsLearned;<br>    <span class="hljs-keyword">private</span> String improvementPlan;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> confidence;<br>    <br>    <span class="hljs-comment">// 转换为可存储的经验文本</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toExperienceText</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            问题：%s</span><br><span class="hljs-string">            原因：%s</span><br><span class="hljs-string">            教训：%s</span><br><span class="hljs-string">            改进：%s</span><br><span class="hljs-string">            &quot;&quot;&quot;</span>.formatted(<br>                problemDiagnosis,<br>                rootCause,<br>                String.join(<span class="hljs-string">&quot;；&quot;</span>, lessonsLearned),<br>                improvementPlan<br>            );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="2-4-Memory（记忆模块）"><a href="#2-4-Memory（记忆模块）" class="headerlink" title="2.4 Memory（记忆模块）"></a>2.4 Memory（记忆模块）</h3><p>Memory 负责存储和检索经验，支持短期记忆（当前任务）和长期记忆（跨任务）。</p><h4 id="记忆架构"><a href="#记忆架构" class="headerlink" title="记忆架构"></a>记忆架构</h4><pre><code class=" mermaid">graph TB    subgraph Memory        A[短期记忆] --&gt; C[经验检索]        B[长期记忆] --&gt; C    end        D[当前任务经验] --&gt; A    E[历史任务经验] --&gt; B    C --&gt; F[相关经验]</code></pre><h4 id="Java-实现-3"><a href="#Java-实现-3" class="headerlink" title="Java 实现"></a>Java 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflexionMemory</span> &#123;<br>    <br>    <span class="hljs-comment">// 短期记忆：当前任务的尝试历史</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; shortTermMemory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <br>    <span class="hljs-comment">// 长期记忆：向量数据库</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VectorStore vectorStore;<br>    <br>    <span class="hljs-comment">// 添加短期记忆</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addShortTerm</span><span class="hljs-params">(String experience)</span> &#123;<br>        shortTermMemory.add(experience);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 清空短期记忆（任务完成后）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearShortTerm</span><span class="hljs-params">()</span> &#123;<br>        shortTermMemory.clear();<br>    &#125;<br>    <br>    <span class="hljs-comment">// 添加长期记忆</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addLongTerm</span><span class="hljs-params">(String experience, String taskType)</span> &#123;<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(<br>            experience,<br>            Map.of(<br>                <span class="hljs-string">&quot;task_type&quot;</span>, taskType,<br>                <span class="hljs-string">&quot;timestamp&quot;</span>, System.currentTimeMillis(),<br>                <span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;reflexion&quot;</span><br>            )<br>        );<br>        vectorStore.add(List.of(doc));<br>    &#125;<br>    <br>    <span class="hljs-comment">// 检索相关经验</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">recall</span><span class="hljs-params">(String task, <span class="hljs-type">int</span> topK)</span> &#123;<br>        List&lt;String&gt; experiences = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-comment">// 1. 添加短期记忆（当前任务的所有尝试）</span><br>        experiences.addAll(shortTermMemory);<br>        <br>        <span class="hljs-comment">// 2. 检索长期记忆中的相关经验</span><br>        List&lt;Document&gt; docs = vectorStore.similaritySearch(<br>            SearchRequest.query(task).withTopK(topK)<br>        );<br>        <br>        <span class="hljs-keyword">for</span> (Document doc : docs) &#123;<br>            experiences.add(doc.getContent());<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> experiences;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 获取短期记忆</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getShortTermMemory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(shortTermMemory);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="三、完整实现"><a href="#三、完整实现" class="headerlink" title="三、完整实现"></a>三、完整实现</h2><h3 id="3-1-Reflexion-Agent-主类"><a href="#3-1-Reflexion-Agent-主类" class="headerlink" title="3.1 Reflexion Agent 主类"></a>3.1 Reflexion Agent 主类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Actor actor;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Evaluator evaluator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SelfReflection selfReflection;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReflexionMemory memory;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;<br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;开始执行任务: &#123;&#125;&quot;</span>, task);<br>        <br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>            log.info(<span class="hljs-string">&quot;=== 第 &#123;&#125; 次尝试 ===&quot;</span>, attempt);<br>            <br>            <span class="hljs-comment">// 1. 检索相关经验</span><br>            List&lt;String&gt; experiences = memory.recall(task, <span class="hljs-number">5</span>);<br>            log.info(<span class="hljs-string">&quot;检索到 &#123;&#125; 条相关经验&quot;</span>, experiences.size());<br>            <br>            <span class="hljs-comment">// 2. Actor 执行</span><br>            <span class="hljs-type">ActorResult</span> <span class="hljs-variable">actorResult</span> <span class="hljs-operator">=</span> actor.execute(task, experiences);<br>            log.info(<span class="hljs-string">&quot;执行完成&quot;</span>);<br>            <br>            <span class="hljs-comment">// 3. Evaluator 评估</span><br>            <span class="hljs-type">EvaluationResult</span> <span class="hljs-variable">evalResult</span> <span class="hljs-operator">=</span> evaluator.evaluateWithLLM(<br>                task, actorResult.getExecution()<br>            );<br>            log.info(<span class="hljs-string">&quot;评估得分: &#123;&#125;&quot;</span>, evalResult.getScore());<br>            <br>            <span class="hljs-comment">// 记录本次尝试</span><br>            attempts.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AttemptRecord</span>(attempt, actorResult, evalResult));<br>            <br>            <span class="hljs-comment">// 4. 检查是否成功</span><br>            <span class="hljs-keyword">if</span> (evalResult.isSuccess() || evalResult.getScore() &gt;= SUCCESS_THRESHOLD) &#123;<br>                log.info(<span class="hljs-string">&quot;✅ 任务成功完成&quot;</span>);<br>                <br>                <span class="hljs-comment">// 成功也可以总结经验（可选）</span><br>                <span class="hljs-keyword">if</span> (evalResult.getScore() == <span class="hljs-number">100</span>) &#123;<br>                    saveSuccessExperience(task, actorResult);<br>                &#125;<br>                <br>                memory.clearShortTerm();<br>                <span class="hljs-keyword">return</span> ReflexionResponse.success(<br>                    actorResult.getExecution(), attempts<br>                );<br>            &#125;<br>            <br>            <span class="hljs-comment">// 5. Self-Reflection 反思</span><br>            log.info(<span class="hljs-string">&quot;开始反思...&quot;</span>);<br>            <span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">reflection</span> <span class="hljs-operator">=</span> selfReflection.reflect(<br>                ReflectionInput.builder()<br>                    .task(task)<br>                    .executionTrace(actorResult.getThinking())<br>                    .result(actorResult.getExecution())<br>                    .evaluationFeedback(evalResult.getOverallFeedback())<br>                    .build()<br>            );<br>            <br>            log.info(<span class="hljs-string">&quot;反思结果: &#123;&#125;&quot;</span>, reflection.getLessonsLearned());<br>            <br>            <span class="hljs-comment">// 6. 存储经验</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">experience</span> <span class="hljs-operator">=</span> reflection.toExperienceText();<br>            memory.addShortTerm(experience);<br>            <br>            <span class="hljs-comment">// 如果是有价值的经验，存入长期记忆</span><br>            <span class="hljs-keyword">if</span> (reflection.getConfidence() &gt; <span class="hljs-number">70</span>) &#123;<br>                memory.addLongTerm(experience, classifyTask(task));<br>            &#125;<br>        &#125;<br>        <br>        log.warn(<span class="hljs-string">&quot;❌ 达到最大重试次数，任务未能成功完成&quot;</span>);<br>        memory.clearShortTerm();<br>        <br>        <span class="hljs-keyword">return</span> ReflexionResponse.failure(<br>            attempts.get(attempts.size() - <span class="hljs-number">1</span>).getActorResult().getExecution(),<br>            attempts<br>        );<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">classifyTask</span><span class="hljs-params">(String task)</span> &#123;<br>        <span class="hljs-comment">// 简单的任务分类逻辑</span><br>        <span class="hljs-keyword">if</span> (task.contains(<span class="hljs-string">&quot;代码&quot;</span>) || task.contains(<span class="hljs-string">&quot;实现&quot;</span>) || task.contains(<span class="hljs-string">&quot;函数&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;coding&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (task.contains(<span class="hljs-string">&quot;分析&quot;</span>) || task.contains(<span class="hljs-string">&quot;解释&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;analysis&quot;</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;general&quot;</span>;<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveSuccessExperience</span><span class="hljs-params">(String task, ActorResult result)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">experience</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;成功经验：任务「%s」的有效解决方案是：%s&quot;</span><br>            .formatted(task, result.getThinking());<br>        memory.addLongTerm(experience, classifyTask(task));<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AttemptRecord</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> attemptNumber;<br>    <span class="hljs-keyword">private</span> ActorResult actorResult;<br>    <span class="hljs-keyword">private</span> EvaluationResult evaluationResult;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflexionResponse</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> success;<br>    <span class="hljs-keyword">private</span> String result;<br>    <span class="hljs-keyword">private</span> List&lt;AttemptRecord&gt; attempts;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> totalAttempts;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ReflexionResponse <span class="hljs-title function_">success</span><span class="hljs-params">(String result, List&lt;AttemptRecord&gt; attempts)</span> &#123;<br>        <span class="hljs-type">ReflexionResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflexionResponse</span>();<br>        response.success = <span class="hljs-literal">true</span>;<br>        response.result = result;<br>        response.attempts = attempts;<br>        response.totalAttempts = attempts.size();<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ReflexionResponse <span class="hljs-title function_">failure</span><span class="hljs-params">(String result, List&lt;AttemptRecord&gt; attempts)</span> &#123;<br>        <span class="hljs-type">ReflexionResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReflexionResponse</span>();<br>        response.success = <span class="hljs-literal">false</span>;<br>        response.result = result;<br>        response.attempts = attempts;<br>        response.totalAttempts = attempts.size();<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-Controller-层"><a href="#3-2-Controller-层" class="headerlink" title="3.2 Controller 层"></a>3.2 Controller 层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/reflexion&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflexionController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReflexionAgent reflexionAgent;<br>    <br>    <span class="hljs-meta">@PostMapping(&quot;/execute&quot;)</span><br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> TaskRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> reflexionAgent.execute(request.getTask());<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/memory/stats&quot;)</span><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getMemoryStats</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 返回记忆统计信息</span><br>        <span class="hljs-keyword">return</span> Map.of(<br>            <span class="hljs-string">&quot;shortTermCount&quot;</span>, memory.getShortTermMemory().size(),<br>            <span class="hljs-string">&quot;longTermCount&quot;</span>, memory.getLongTermCount()<br>        );<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskRequest</span> &#123;<br>    <span class="hljs-keyword">private</span> String task;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="四、实战案例"><a href="#四、实战案例" class="headerlink" title="四、实战案例"></a>四、实战案例</h2><h3 id="4-1-代码生成任务"><a href="#4-1-代码生成任务" class="headerlink" title="4.1 代码生成任务"></a>4.1 代码生成任务</h3><p><strong>任务</strong>：”用 Java 实现一个 LRU 缓存，支持 get 和 put 操作，时间复杂度 O(1)”</p><h4 id="第-1-次尝试"><a href="#第-1-次尝试" class="headerlink" title="第 1 次尝试"></a>第 1 次尝试</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs processing">Actor 输出:<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LRUCache</span> &#123;<br>    <span class="hljs-keyword">private</span> Map&lt;Integer, Integer&gt; cache;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> capacity;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">LRUCache</span>(<span class="hljs-type">int</span> capacity) &#123;<br>        <span class="hljs-variable">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new </span><span class="hljs-class title_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-variable">this</span>.<span class="hljs-property">capacity</span> = capacity;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-built_in">get</span>(<span class="hljs-type">int</span> <span class="hljs-built_in">key</span>) &#123;<br>        <span class="hljs-keyword">return</span> cache.<span class="hljs-property">getOrDefault</span>(<span class="hljs-built_in">key</span>, <span class="hljs-number">-1</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">put</span>(<span class="hljs-type">int</span> <span class="hljs-built_in">key</span>, <span class="hljs-type">int</span> value) &#123;<br>        <span class="hljs-keyword">if</span> (cache.<span class="hljs-property">size</span>() &gt;= capacity) &#123;<br>            <span class="hljs-comment">// 删除最旧的？但 HashMap 无序...</span><br>            cache.<span class="hljs-property">remove</span>(cache.<span class="hljs-property">keySet</span>().<span class="hljs-property">iterator</span>().<span class="hljs-property">next</span>());<br>        &#125;<br>        cache.<span class="hljs-property">put</span>(<span class="hljs-built_in">key</span>, value);<br>    &#125;<br>&#125;<br><br>Evaluator 反馈:<br>&#123;<br>  <span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-string">&quot;score&quot;</span>: <span class="hljs-number">40</span>,<br>  <span class="hljs-string">&quot;specific_issues&quot;</span>: [<br>    <span class="hljs-string">&quot;HashMap 无法保证 LRU 顺序&quot;</span>,<br>    <span class="hljs-string">&quot;删除的不一定是最久未使用的元素&quot;</span>,<br>    <span class="hljs-string">&quot;get 操作没有更新访问顺序&quot;</span><br>  ]<br>&#125;<br><br>Self-Reflection:<br>&#123;<br>  <span class="hljs-string">&quot;problem_diagnosis&quot;</span>: <span class="hljs-string">&quot;使用了普通 HashMap，无法维护访问顺序&quot;</span>,<br>  <span class="hljs-string">&quot;root_cause&quot;</span>: <span class="hljs-string">&quot;没有考虑 LRU 需要记录访问顺序的特性&quot;</span>,<br>  <span class="hljs-string">&quot;lessons_learned&quot;</span>: [<br>    <span class="hljs-string">&quot;LRU 缓存需要能记录访问顺序的数据结构&quot;</span>,<br>    <span class="hljs-string">&quot;可以使用 LinkedHashMap 或自己实现双向链表 + HashMap&quot;</span><br>  ],<br>  <span class="hljs-string">&quot;improvement_plan&quot;</span>: <span class="hljs-string">&quot;使用 LinkedHashMap 并重写 removeEldestEntry 方法&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="第-2-次尝试"><a href="#第-2-次尝试" class="headerlink" title="第 2 次尝试"></a>第 2 次尝试</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">Actor 输出（带经验）:<br><span class="hljs-keyword">public</span> class LRUCache <span class="hljs-keyword">extends</span> LinkedHashMap&lt;Integer, Integer&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> capacity;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">LRUCache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> capacity)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(capacity, <span class="hljs-number">0.75</span>f, <span class="hljs-keyword">true</span>); <span class="hljs-comment">// true 表示按访问顺序</span><br>        <span class="hljs-keyword">this</span>.capacity = capacity;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key)</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.<span class="hljs-title">getOrDefault</span><span class="hljs-params">(key, <span class="hljs-number">-1</span>)</span></span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-keyword">int</span> key, <span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>.put(key, value);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">removeEldestEntry</span><span class="hljs-params">(Map.Entry eldest)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> size() &gt; capacity;<br>    &#125;<br>&#125;<br><br>Evaluator 反馈:<br>&#123;<br>  <span class="hljs-string">&quot;success&quot;</span>: <span class="hljs-keyword">true</span>,<br>  <span class="hljs-string">&quot;score&quot;</span>: 95,<br>  <span class="hljs-string">&quot;overall_feedback&quot;</span>: <span class="hljs-string">&quot;正确实现了 LRU 缓存，使用 LinkedHashMap 简洁高效&quot;</span><br>&#125;<br><br>✅ 成功完成<br></code></pre></td></tr></table></figure><h3 id="4-2-数据分析任务"><a href="#4-2-数据分析任务" class="headerlink" title="4.2 数据分析任务"></a>4.2 数据分析任务</h3><p><strong>任务</strong>：”分析这段 SQL 的性能问题并给出优化建议”</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders o<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id<br><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> products p <span class="hljs-keyword">ON</span> o.product_id <span class="hljs-operator">=</span> p.id<br><span class="hljs-keyword">WHERE</span> o.created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">&#x27;2024-01-01&#x27;</span><br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.created_at <span class="hljs-keyword">DESC</span>;<br></code></pre></td></tr></table></figure><h4 id="反思改进过程"><a href="#反思改进过程" class="headerlink" title="反思改进过程"></a>反思改进过程</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql">第 <span class="hljs-number">1</span> 次：只关注了索引问题<br>经验：<span class="hljs-keyword">SQL</span> 优化要全面考虑索引、查询字段、连接方式等<br><br>第 <span class="hljs-number">2</span> 次：增加了字段选择建议<br>经验：<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> 是常见性能问题，应明确指出<br><br>第 <span class="hljs-number">3</span> 次：完整分析<br><span class="hljs-operator">-</span> 索引建议：created_at, user_id, product_id<br><span class="hljs-operator">-</span> 查询优化：避免 <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span><br><span class="hljs-operator">-</span> 连接优化：考虑是否需要 <span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span><br><span class="hljs-operator">-</span> 分页建议：大数据量需要分页<br><br>✅ 成功<br></code></pre></td></tr></table></figure><hr><h2 id="五、进阶优化"><a href="#五、进阶优化" class="headerlink" title="五、进阶优化"></a>五、进阶优化</h2><h3 id="5-1-分层反思"><a href="#5-1-分层反思" class="headerlink" title="5.1 分层反思"></a>5.1 分层反思</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HierarchicalReflection</span> &#123;<br>    <br>    <span class="hljs-comment">// 浅层反思：快速修复</span><br>    <span class="hljs-keyword">public</span> QuickFix <span class="hljs-title function_">shallowReflect</span><span class="hljs-params">(EvaluationResult eval)</span> &#123;<br>        <span class="hljs-comment">// 针对具体错误的快速修复建议</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 深层反思：根因分析</span><br>    <span class="hljs-keyword">public</span> DeepAnalysis <span class="hljs-title function_">deepReflect</span><span class="hljs-params">(List&lt;AttemptRecord&gt; attempts)</span> &#123;<br>        <span class="hljs-comment">// 多次失败后的深度分析</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 元反思：反思策略本身</span><br>    <span class="hljs-keyword">public</span> MetaReflection <span class="hljs-title function_">metaReflect</span><span class="hljs-params">(List&lt;ReflectionResult&gt; reflections)</span> &#123;<br>        <span class="hljs-comment">// 反思的反思：反思策略是否有效</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-经验蒸馏"><a href="#5-2-经验蒸馏" class="headerlink" title="5.2 经验蒸馏"></a>5.2 经验蒸馏</h3><p>定期将碎片化经验整合为结构化知识：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Scheduled(cron = &quot;0 0 2 * * ?&quot;)</span> <span class="hljs-comment">// 每天凌晨2点</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">distillExperiences</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1. 获取最近的经验</span><br>    List&lt;Document&gt; recentExperiences = memory.getRecentExperiences(<span class="hljs-number">100</span>);<br>    <br>    <span class="hljs-comment">// 2. 聚类相似经验</span><br>    Map&lt;String, List&lt;Document&gt;&gt; clusters = clusterExperiences(recentExperiences);<br>    <br>    <span class="hljs-comment">// 3. 为每个聚类生成总结</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;Document&gt;&gt; entry : clusters.entrySet()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">summary</span> <span class="hljs-operator">=</span> llm.summarize(entry.getValue());<br>        memory.addDistilledKnowledge(entry.getKey(), summary);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-3-经验迁移"><a href="#5-3-经验迁移" class="headerlink" title="5.3 经验迁移"></a>5.3 经验迁移</h3><p>跨任务类型迁移通用经验：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">transferExperiences</span><span class="hljs-params">(String newTask)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">taskType</span> <span class="hljs-operator">=</span> classifyTask(newTask);<br>    <br>    <span class="hljs-comment">// 获取同类型任务经验</span><br>    List&lt;String&gt; sameTypeExp = memory.getByTaskType(taskType);<br>    <br>    <span class="hljs-comment">// 获取通用经验（适用于所有任务）</span><br>    List&lt;String&gt; universalExp = memory.getUniversalExperiences();<br>    <br>    <span class="hljs-comment">// 智能筛选可迁移的经验</span><br>    <span class="hljs-keyword">return</span> filterTransferableExperiences(newTask, sameTypeExp, universalExp);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="六、最佳实践"><a href="#六、最佳实践" class="headerlink" title="六、最佳实践"></a>六、最佳实践</h2><h3 id="6-1-评估器设计"><a href="#6-1-评估器设计" class="headerlink" title="6.1 评估器设计"></a>6.1 评估器设计</h3><table><thead><tr><th>任务类型</th><th>推荐评估方式</th></tr></thead><tbody><tr><td>代码生成</td><td>测试用例 + 静态分析</td></tr><tr><td>文本写作</td><td>LLM 评估 + 规则检查</td></tr><tr><td>数学计算</td><td>结果验证</td></tr><tr><td>信息检索</td><td>人工抽检 + LLM 评估</td></tr></tbody></table><h3 id="6-2-反思深度控制"><a href="#6-2-反思深度控制" class="headerlink" title="6.2 反思深度控制"></a>6.2 反思深度控制</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 根据失败次数调整反思深度</span><br><span class="hljs-keyword">public</span> ReflectionResult <span class="hljs-title function_">adaptiveReflect</span><span class="hljs-params">(<span class="hljs-type">int</span> attemptCount, ...)</span> &#123;<br>    <span class="hljs-keyword">if</span> (attemptCount == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> quickReflect(...);  <span class="hljs-comment">// 快速反思</span><br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attemptCount == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">return</span> normalReflect(...); <span class="hljs-comment">// 标准反思</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> deepReflect(...);   <span class="hljs-comment">// 深度反思</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-3-避免过度反思"><a href="#6-3-避免过度反思" class="headerlink" title="6.3 避免过度反思"></a>6.3 避免过度反思</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 检测是否陷入无效循环</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStuck</span><span class="hljs-params">(List&lt;ReflectionResult&gt; reflections)</span> &#123;<br>    <span class="hljs-keyword">if</span> (reflections.size() &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <br>    <span class="hljs-comment">// 检查最近两次反思是否相似度过高</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">1</span>).toExperienceText();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">2</span>).toExperienceText();<br>    <br>    <span class="hljs-keyword">return</span> calculateSimilarity(last, prev) &gt; <span class="hljs-number">0.8</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="七、迭代控制与循环避免"><a href="#七、迭代控制与循环避免" class="headerlink" title="七、迭代控制与循环避免"></a>七、迭代控制与循环避免</h2><h3 id="7-1-迭代次数控制机制"><a href="#7-1-迭代次数控制机制" class="headerlink" title="7.1 迭代次数控制机制"></a>7.1 迭代次数控制机制</h3><h4 id="基础控制：最大重试次数"><a href="#基础控制：最大重试次数" class="headerlink" title="基础控制：最大重试次数"></a>基础控制：最大重试次数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-comment">// 核心控制参数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;           <span class="hljs-comment">// 最多重试 3 次</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;    <span class="hljs-comment">// 成功阈值 80 分</span><br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-comment">// 关键：for 循环限制迭代次数</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>            log.info(<span class="hljs-string">&quot;=== 第 &#123;&#125; 次尝试 ===&quot;</span>, attempt);<br>            <br>            <span class="hljs-comment">// ... 执行逻辑 ...</span><br>            <br>            <span class="hljs-comment">// 成功则立即返回，不继续迭代</span><br>            <span class="hljs-keyword">if</span> (evalResult.isSuccess() || evalResult.getScore() &gt;= SUCCESS_THRESHOLD) &#123;<br>                log.info(<span class="hljs-string">&quot;✅ 任务成功完成&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.success(result, attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 失败则继续下一次迭代</span><br>        &#125;<br>        <br>        <span class="hljs-comment">// 达到最大次数后返回失败</span><br>        log.warn(<span class="hljs-string">&quot;❌ 达到最大重试次数，任务未能成功完成&quot;</span>);<br>        <span class="hljs-keyword">return</span> ReflexionResponse.failure(lastResult, attempts);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(MAX_RETRIES)</span><br><span class="hljs-comment">// 空间复杂度：O(MAX_RETRIES)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>使用 <code>for</code> 循环而不是 <code>while</code>，明确限制迭代次数</li><li>成功时立即返回，不浪费资源</li><li>达到最大次数自动停止，不会无限循环</li></ul><h4 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h4><table><thead><tr><th>参数</th><th>说明</th><th>建议值</th><th>影响</th></tr></thead><tbody><tr><td><strong>MAX_RETRIES</strong></td><td>最大重试次数</td><td>3-5</td><td>次数越多，成功率越高但成本越高</td></tr><tr><td><strong>SUCCESS_THRESHOLD</strong></td><td>成功评分阈值</td><td>80-90</td><td>阈值越高，要求越严格</td></tr><tr><td><strong>MAX_REFLECTION_DEPTH</strong></td><td>最大反思深度</td><td>2-3</td><td>控制反思的详细程度</td></tr></tbody></table><h3 id="7-2-多层次的循环控制"><a href="#7-2-多层次的循环控制" class="headerlink" title="7.2 多层次的循环控制"></a>7.2 多层次的循环控制</h3><h4 id="方式1：基于成功率的动态控制"><a href="#方式1：基于成功率的动态控制" class="headerlink" title="方式1：基于成功率的动态控制"></a>方式1：基于成功率的动态控制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdaptiveReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">MIN_IMPROVEMENT_RATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.05</span>;  <span class="hljs-comment">// 最小改进率 5%</span><br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">lastScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>            <span class="hljs-comment">// ... 执行逻辑 ...</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">currentScore</span> <span class="hljs-operator">=</span> evalResult.getScore();<br>            <br>            <span class="hljs-comment">// 1. 成功则返回</span><br>            <span class="hljs-keyword">if</span> (currentScore &gt;= SUCCESS_THRESHOLD) &#123;<br>                log.info(<span class="hljs-string">&quot;✅ 任务成功&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.success(result, attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 2. 检查是否有改进</span><br>            <span class="hljs-type">double</span> <span class="hljs-variable">improvementRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>)(currentScore - lastScore) / lastScore;<br>            <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">2</span> &amp;&amp; improvementRate &lt; MIN_IMPROVEMENT_RATE) &#123;<br>                log.warn(<span class="hljs-string">&quot;⚠️ 改进不足 &#123;&#125;%，停止迭代&quot;</span>, MIN_IMPROVEMENT_RATE * <span class="hljs-number">100</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.failure(result, attempts);<br>            &#125;<br>            <br>            lastScore = currentScore;<br>        &#125;<br>        <br>        log.warn(<span class="hljs-string">&quot;❌ 达到最大重试次数&quot;</span>);<br>        <span class="hljs-keyword">return</span> ReflexionResponse.failure(lastResult, attempts);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 思路：</span><br><span class="hljs-comment">// 第1次：得分 40</span><br><span class="hljs-comment">// 第2次：得分 60（改进 50%，继续）</span><br><span class="hljs-comment">// 第3次：得分 65（改进 8%，继续）</span><br><span class="hljs-comment">// 第4次：得分 66（改进 1.5% &lt; 5%，停止）</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>不仅限制次数，还检查改进幅度</li><li>如果连续改进不足，提前停止</li><li>避免在无效循环中浪费资源</li></ul><h4 id="方式2：基于反思相似度的控制"><a href="#方式2：基于反思相似度的控制" class="headerlink" title="方式2：基于反思相似度的控制"></a>方式2：基于反思相似度的控制</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">SIMILARITY_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span>;  <span class="hljs-comment">// 相似度阈值</span><br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;ReflectionResult&gt; reflections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>            <span class="hljs-comment">// ... 执行逻辑 ...</span><br>            <br>            <span class="hljs-keyword">if</span> (evalResult.isSuccess()) &#123;<br>                <span class="hljs-keyword">return</span> ReflexionResponse.success(result, attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 反思</span><br>            <span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">reflection</span> <span class="hljs-operator">=</span> selfReflection.reflect(input);<br>            reflections.add(reflection);<br>            <br>            <span class="hljs-comment">// 检测是否陷入循环</span><br>            <span class="hljs-keyword">if</span> (isStuckInLoop(reflections)) &#123;<br>                log.warn(<span class="hljs-string">&quot;⚠️ 检测到无效循环，停止迭代&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.failure(result, attempts);<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> ReflexionResponse.failure(lastResult, attempts);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 检测是否陷入循环</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStuckInLoop</span><span class="hljs-params">(List&lt;ReflectionResult&gt; reflections)</span> &#123;<br>        <span class="hljs-keyword">if</span> (reflections.size() &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <br>        <span class="hljs-comment">// 获取最近两次反思</span><br>        <span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">1</span>);<br>        <span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">2</span>);<br>        <br>        <span class="hljs-comment">// 计算相似度</span><br>        <span class="hljs-type">double</span> <span class="hljs-variable">similarity</span> <span class="hljs-operator">=</span> calculateSimilarity(<br>            last.toExperienceText(),<br>            prev.toExperienceText()<br>        );<br>        <br>        log.info(<span class="hljs-string">&quot;反思相似度: &#123;&#125;&quot;</span>, similarity);<br>        <br>        <span class="hljs-comment">// 如果相似度过高，说明陷入循环</span><br>        <span class="hljs-keyword">return</span> similarity &gt; SIMILARITY_THRESHOLD;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSimilarity</span><span class="hljs-params">(String text1, String text2)</span> &#123;<br>        <span class="hljs-comment">// 使用余弦相似度或编辑距离</span><br>        <span class="hljs-comment">// 这里简化处理</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">commonChars</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">maxLen</span> <span class="hljs-operator">=</span> Math.max(text1.length(), text2.length());<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span> c : text1.toCharArray()) &#123;<br>            <span class="hljs-keyword">if</span> (text2.contains(String.valueOf(c))) &#123;<br>                commonChars++;<br>            &#125;<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">double</span>) commonChars / maxLen;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 思路：</span><br><span class="hljs-comment">// 第1次反思：问题是&quot;没有考虑边界情况&quot;</span><br><span class="hljs-comment">// 第2次反思：问题是&quot;没有考虑边界情况&quot;（相似度 95%）</span><br><span class="hljs-comment">// → 检测到循环，停止迭代</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>监测反思内容的相似度</li><li>如果反思重复，说明陷入死循环</li><li>提前停止避免浪费资源</li></ul><h3 id="7-3-循环风险识别"><a href="#7-3-循环风险识别" class="headerlink" title="7.3 循环风险识别"></a>7.3 循环风险识别</h3><h4 id="常见的无限循环场景"><a href="#常见的无限循环场景" class="headerlink" title="常见的无限循环场景"></a>常见的无限循环场景</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 场景1：评估标准过高</span><br><span class="hljs-comment">// 问题：SUCCESS_THRESHOLD = 100（完美）</span><br><span class="hljs-comment">// 结果：永远无法满足，陷入循环</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;  <span class="hljs-comment">// 不现实</span><br><br><span class="hljs-comment">// ✅ 解决：设置合理的阈值</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;   <span class="hljs-comment">// 80% 就认为成功</span><br><br><span class="hljs-comment">// ❌ 场景2：反思没有产生新的改进方案</span><br><span class="hljs-comment">// 问题：每次反思都说&quot;需要更仔细&quot;，但没有具体改进</span><br><span class="hljs-comment">// 结果：Actor 重复同样的错误</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">reflect</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 反思结果：需要更仔细地处理</span><br>    <span class="hljs-comment">// 改进方案：无（空）</span><br>    <span class="hljs-comment">// → 下次还是同样的错误</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 解决：要求反思必须产生具体的改进方案</span><br><span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">reflection</span> <span class="hljs-operator">=</span> selfReflection.reflect(input);<br><span class="hljs-keyword">if</span> (reflection.getImprovementPlan() == <span class="hljs-literal">null</span> || <br>    reflection.getImprovementPlan().isEmpty()) &#123;<br>    log.warn(<span class="hljs-string">&quot;反思未产生改进方案，停止迭代&quot;</span>);<br>    <span class="hljs-keyword">return</span> ReflexionResponse.failure(result, attempts);<br>&#125;<br><br><span class="hljs-comment">// ❌ 场景3：经验没有被正确应用</span><br><span class="hljs-comment">// 问题：Actor 收到经验但没有真正应用</span><br><span class="hljs-comment">// 结果：每次都犯同样的错误</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String task, List&lt;String&gt; experiences)</span> &#123;<br>    <span class="hljs-comment">// 虽然收到了经验，但在 Prompt 中没有强调</span><br>    <span class="hljs-comment">// → Actor 忽视了经验</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 解决：在 Prompt 中强调经验的重要性</span><br><span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    ## 历史经验教训（必须参考！）</span><br><span class="hljs-string">    %s</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    ## 重要提示</span><br><span class="hljs-string">    上次失败的原因是：%s</span><br><span class="hljs-string">    请务必避免重复这个错误！</span><br><span class="hljs-string">    &quot;&quot;&quot;</span>.formatted(experiences, lastFailureReason);<br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>识别循环的根本原因</li><li>在设计阶段就预防循环</li><li>不是简单地增加重试次数</li></ul><h3 id="7-4-完整的循环控制实现"><a href="#7-4-完整的循环控制实现" class="headerlink" title="7.4 完整的循环控制实现"></a>7.4 完整的循环控制实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RobustReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-comment">// 多层次的控制参数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_RETRIES</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SUCCESS_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">MIN_IMPROVEMENT_RATE</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.05</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> <span class="hljs-variable">SIMILARITY_THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.8</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MAX_CONSECUTIVE_FAILURES</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        List&lt;ReflectionResult&gt; reflections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">lastScore</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">consecutiveFailures</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>            log.info(<span class="hljs-string">&quot;=== 第 &#123;&#125; 次尝试 ===&quot;</span>, attempt);<br>            <br>            <span class="hljs-comment">// 1. 执行</span><br>            <span class="hljs-type">ActorResult</span> <span class="hljs-variable">actorResult</span> <span class="hljs-operator">=</span> actor.execute(task, memory.recall(task, <span class="hljs-number">5</span>));<br>            <span class="hljs-type">EvaluationResult</span> <span class="hljs-variable">evalResult</span> <span class="hljs-operator">=</span> evaluator.evaluateWithLLM(task, actorResult.getExecution());<br>            <span class="hljs-type">int</span> <span class="hljs-variable">currentScore</span> <span class="hljs-operator">=</span> evalResult.getScore();<br>            <br>            attempts.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AttemptRecord</span>(attempt, actorResult, evalResult));<br>            <br>            <span class="hljs-comment">// 2. 检查成功</span><br>            <span class="hljs-keyword">if</span> (currentScore &gt;= SUCCESS_THRESHOLD) &#123;<br>                log.info(<span class="hljs-string">&quot;✅ 任务成功完成&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.success(actorResult.getExecution(), attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 3. 检查改进率（从第2次开始）</span><br>            <span class="hljs-keyword">if</span> (attempt &gt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">double</span> <span class="hljs-variable">improvementRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>)(currentScore - lastScore) / Math.max(lastScore, <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (improvementRate &lt; MIN_IMPROVEMENT_RATE) &#123;<br>                    consecutiveFailures++;<br>                    log.warn(<span class="hljs-string">&quot;改进不足: &#123;&#125;%&quot;</span>, improvementRate * <span class="hljs-number">100</span>);<br>                    <br>                    <span class="hljs-keyword">if</span> (consecutiveFailures &gt;= MAX_CONSECUTIVE_FAILURES) &#123;<br>                        log.warn(<span class="hljs-string">&quot;⚠️ 连续 &#123;&#125; 次改进不足，停止迭代&quot;</span>, MAX_CONSECUTIVE_FAILURES);<br>                        <span class="hljs-keyword">return</span> ReflexionResponse.failure(actorResult.getExecution(), attempts);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    consecutiveFailures = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 重置计数器</span><br>                &#125;<br>            &#125;<br>            <br>            <span class="hljs-comment">// 4. 反思</span><br>            <span class="hljs-type">ReflectionResult</span> <span class="hljs-variable">reflection</span> <span class="hljs-operator">=</span> selfReflection.reflect(<br>                ReflectionInput.builder()<br>                    .task(task)<br>                    .executionTrace(actorResult.getThinking())<br>                    .result(actorResult.getExecution())<br>                    .evaluationFeedback(evalResult.getOverallFeedback())<br>                    .build()<br>            );<br>            reflections.add(reflection);<br>            <br>            <span class="hljs-comment">// 5. 检查是否陷入循环</span><br>            <span class="hljs-keyword">if</span> (isStuckInLoop(reflections)) &#123;<br>                log.warn(<span class="hljs-string">&quot;⚠️ 检测到无效循环，停止迭代&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.failure(actorResult.getExecution(), attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 6. 检查反思质量</span><br>            <span class="hljs-keyword">if</span> (reflection.getImprovementPlan() == <span class="hljs-literal">null</span> || <br>                reflection.getImprovementPlan().isEmpty()) &#123;<br>                log.warn(<span class="hljs-string">&quot;⚠️ 反思未产生改进方案，停止迭代&quot;</span>);<br>                <span class="hljs-keyword">return</span> ReflexionResponse.failure(actorResult.getExecution(), attempts);<br>            &#125;<br>            <br>            <span class="hljs-comment">// 7. 存储经验</span><br>            memory.addShortTerm(reflection.toExperienceText());<br>            <span class="hljs-keyword">if</span> (reflection.getConfidence() &gt; <span class="hljs-number">70</span>) &#123;<br>                memory.addLongTerm(reflection.toExperienceText(), classifyTask(task));<br>            &#125;<br>            <br>            lastScore = currentScore;<br>        &#125;<br>        <br>        log.warn(<span class="hljs-string">&quot;❌ 达到最大重试次数&quot;</span>);<br>        <span class="hljs-keyword">return</span> ReflexionResponse.failure(attempts.get(attempts.size() - <span class="hljs-number">1</span>).getActorResult().getExecution(), attempts);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStuckInLoop</span><span class="hljs-params">(List&lt;ReflectionResult&gt; reflections)</span> &#123;<br>        <span class="hljs-keyword">if</span> (reflections.size() &lt; <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        <br>        <span class="hljs-type">String</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">1</span>).toExperienceText();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> reflections.get(reflections.size() - <span class="hljs-number">2</span>).toExperienceText();<br>        <br>        <span class="hljs-type">double</span> <span class="hljs-variable">similarity</span> <span class="hljs-operator">=</span> calculateSimilarity(last, prev);<br>        <span class="hljs-keyword">return</span> similarity &gt; SIMILARITY_THRESHOLD;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">calculateSimilarity</span><span class="hljs-params">(String text1, String text2)</span> &#123;<br>        <span class="hljs-comment">// 实现相似度计算</span><br>        <span class="hljs-comment">// 可以使用 Levenshtein 距离、余弦相似度等</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0.0</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 控制流程：</span><br><span class="hljs-comment">// 第1次：得分 40 → 继续</span><br><span class="hljs-comment">// 第2次：得分 60（改进 50%）→ 继续</span><br><span class="hljs-comment">// 第3次：得分 62（改进 3% &lt; 5%）→ 计数器 +1</span><br><span class="hljs-comment">// 第4次：得分 63（改进 1.6% &lt; 5%）→ 计数器 +1（达到 2）→ 停止</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li><strong>多层次防护</strong>：次数限制 + 改进率检查 + 循环检测 + 反思质量检查</li><li><strong>连续失败计数</strong>：允许偶尔的改进不足，但连续多次就停止</li><li><strong>综合判断</strong>：不依赖单一指标，多个条件共同决定是否继续</li></ul><h3 id="7-5-监控和日志"><a href="#7-5-监控和日志" class="headerlink" title="7.5 监控和日志"></a>7.5 监控和日志</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredReflexionAgent</span> &#123;<br>    <br>    <span class="hljs-keyword">public</span> ReflexionResponse <span class="hljs-title function_">execute</span><span class="hljs-params">(String task)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        List&lt;AttemptRecord&gt; attempts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">attempt</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; attempt &lt;= MAX_RETRIES; attempt++) &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">attemptStart</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>                <br>                <span class="hljs-comment">// ... 执行逻辑 ...</span><br>                <br>                <span class="hljs-type">long</span> <span class="hljs-variable">attemptDuration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - attemptStart;<br>                log.info(<span class="hljs-string">&quot;第 &#123;&#125; 次尝试耗时: &#123;&#125;ms，得分: &#123;&#125;&quot;</span>, <br>                    attempt, attemptDuration, evalResult.getScore());<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">totalDuration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;<br>            log.info(<span class="hljs-string">&quot;任务总耗时: &#123;&#125;ms，总尝试次数: &#123;&#125;&quot;</span>, totalDuration, attempts.size());<br>            <br>            <span class="hljs-comment">// 记录统计信息</span><br>            logStatistics(attempts);<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStatistics</span><span class="hljs-params">(List&lt;AttemptRecord&gt; attempts)</span> &#123;<br>        <span class="hljs-keyword">if</span> (attempts.isEmpty()) <span class="hljs-keyword">return</span>;<br>        <br>        <span class="hljs-type">int</span> <span class="hljs-variable">maxScore</span> <span class="hljs-operator">=</span> attempts.stream()<br>            .mapToInt(a -&gt; a.getEvaluationResult().getScore())<br>            .max()<br>            .orElse(<span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-type">double</span> <span class="hljs-variable">avgScore</span> <span class="hljs-operator">=</span> attempts.stream()<br>            .mapToInt(a -&gt; a.getEvaluationResult().getScore())<br>            .average()<br>            .orElse(<span class="hljs-number">0</span>);<br>        <br>        log.info(<span class="hljs-string">&quot;统计信息 - 最高分: &#123;&#125;，平均分: &#123;:.2f&#125;，总次数: &#123;&#125;&quot;</span>, <br>            maxScore, avgScore, attempts.size());<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 日志输出示例：</span><br><span class="hljs-comment">// === 第 1 次尝试 ===</span><br><span class="hljs-comment">// 第 1 次尝试耗时: 2341ms，得分: 40</span><br><span class="hljs-comment">// === 第 2 次尝试 ===</span><br><span class="hljs-comment">// 第 2 次尝试耗时: 2156ms，得分: 65</span><br><span class="hljs-comment">// === 第 3 次尝试 ===</span><br><span class="hljs-comment">// 第 3 次尝试耗时: 2089ms，得分: 68</span><br><span class="hljs-comment">// ⚠️ 改进不足: 4.6%，停止迭代</span><br><span class="hljs-comment">// 统计信息 - 最高分: 68，平均分: 57.67，总次数: 3</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>记录每次尝试的耗时和得分</li><li>便于分析性能和改进效果</li><li>帮助调整控制参数</li></ul><hr><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>Agent架构模式详解</li><li>Prompt Engineering详解</li><li>大模型学习路线</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>Agent</tag>
      
      <tag>Reflexion</tag>
      
      <tag>自反思</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>大模型学习路线</title>
    <link href="/2026/01/12/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/"/>
    <url>/2026/01/12/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/</url>
    
    <content type="html"><![CDATA[<h1 id="大模型学习路线（Java工程师版）"><a href="#大模型学习路线（Java工程师版）" class="headerlink" title="大模型学习路线（Java工程师版）"></a>大模型学习路线（Java工程师版）</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本笔记专为 <strong>Java 工程师转型 AI&#x2F;大模型方向</strong> 设计，充分利用已有的编程基础，以最高效的路径切入大模型领域。</p><h2 id="学习路线总览"><a href="#学习路线总览" class="headerlink" title="学习路线总览"></a>学习路线总览</h2><pre><code class=" mermaid">graph TD    A[Java工程师] --&gt; B[Python基础]    A --&gt; C[Java生态AI工具]    B --&gt; D[LLM应用开发]    C --&gt; D    D --&gt; E[RAG技术]    D --&gt; F[Prompt Engineering]    E --&gt; G[向量数据库]    F --&gt; H[Agent开发]    G --&gt; I[企业级应用]    H --&gt; I    I --&gt; J[模型微调]</code></pre><h2 id="阶段一：基础准备（1-2周）"><a href="#阶段一：基础准备（1-2周）" class="headerlink" title="阶段一：基础准备（1-2周）"></a>阶段一：基础准备（1-2周）</h2><h3 id="1-1-Python-快速入门"><a href="#1-1-Python-快速入门" class="headerlink" title="1.1 Python 快速入门"></a>1.1 Python 快速入门</h3><table><thead><tr><th>学习内容</th><th>时间</th><th>优先级</th></tr></thead><tbody><tr><td>基础语法（变量、函数、类）</td><td>3天</td><td>⭐⭐⭐</td></tr><tr><td>常用库（requests, json）</td><td>2天</td><td>⭐⭐⭐</td></tr><tr><td>异步编程（asyncio）</td><td>2天</td><td>⭐⭐</td></tr><tr><td>虚拟环境与包管理</td><td>1天</td><td>⭐⭐⭐</td></tr></tbody></table><blockquote><p><strong>💡 提示: Java 工程师优势</strong><br>Python 语法比 Java 简单很多，有 Java 基础 2-3 周可熟练使用</p></blockquote><h3 id="1-2-数学基础（按需补充）"><a href="#1-2-数学基础（按需补充）" class="headerlink" title="1.2 数学基础（按需补充）"></a>1.2 数学基础（按需补充）</h3><ul><li><strong>线性代数</strong> — 向量、矩阵运算（理解 Embedding 原理）</li><li><strong>概率统计</strong> — 概率分布、贝叶斯定理</li><li><strong>微积分</strong> — 梯度、导数（理解模型训练原理）</li></ul><blockquote><p><strong>📝 注意: 建议</strong><br>先跳过深入数学，遇到不懂的概念再回来补充</p></blockquote><h2 id="阶段二：LLM-应用开发（2-4周）"><a href="#阶段二：LLM-应用开发（2-4周）" class="headerlink" title="阶段二：LLM 应用开发（2-4周）"></a>阶段二：LLM 应用开发（2-4周）</h2><h3 id="2-1-核心概念"><a href="#2-1-核心概念" class="headerlink" title="2.1 核心概念"></a>2.1 核心概念</h3><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td>Token</td><td>文本的最小处理单位</td></tr><tr><td>Embedding</td><td>文本的向量表示</td></tr><tr><td>Prompt</td><td>给模型的输入指令</td></tr><tr><td>Context Window</td><td>模型能处理的最大上下文长度</td></tr><tr><td>Temperature</td><td>控制输出随机性的参数</td></tr></tbody></table><h3 id="2-2-主流大模型-API"><a href="#2-2-主流大模型-API" class="headerlink" title="2.2 主流大模型 API"></a>2.2 主流大模型 API</h3><table><thead><tr><th>模型</th><th>厂商</th><th>特点</th></tr></thead><tbody><tr><td>GPT-4 &#x2F; GPT-4o</td><td>OpenAI</td><td>综合能力最强</td></tr><tr><td>Claude 3.5</td><td>Anthropic</td><td>长文本、代码能力强</td></tr><tr><td>通义千问</td><td>阿里巴巴</td><td>国内首选，中文能力好</td></tr><tr><td>文心一言</td><td>百度</td><td>国内主流</td></tr><tr><td>GLM-4</td><td>智谱AI</td><td>开源友好</td></tr></tbody></table><h3 id="2-3-开发框架选择"><a href="#2-3-开发框架选择" class="headerlink" title="2.3 开发框架选择"></a>2.3 开发框架选择</h3><h4 id="Python-生态"><a href="#Python-生态" class="headerlink" title="Python 生态"></a>Python 生态</h4><ul><li><strong>LangChain</strong> — 最流行的 LLM 应用框架</li><li><strong>LlamaIndex</strong> — 专注于 RAG 场景</li></ul><h4 id="Java-生态（推荐优先掌握）"><a href="#Java-生态（推荐优先掌握）" class="headerlink" title="Java 生态（推荐优先掌握）"></a>Java 生态（推荐优先掌握）</h4><ul><li><strong>Spring AI</strong> — Spring 官方 AI 框架，与 Spring Boot 无缝集成</li><li><strong>LangChain4j</strong> — LangChain 的 Java 版本</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Spring AI 示例</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(ChatClient.Builder builder)</span> &#123;<br>        <span class="hljs-built_in">this</span>.chatClient = builder.build();<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/chat&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String message)</span> &#123;<br>        <span class="hljs-keyword">return</span> chatClient.prompt()<br>            .user(message)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="阶段三：RAG-技术（2-3周）"><a href="#阶段三：RAG-技术（2-3周）" class="headerlink" title="阶段三：RAG 技术（2-3周）"></a>阶段三：RAG 技术（2-3周）</h2><h3 id="3-1-RAG-原理"><a href="#3-1-RAG-原理" class="headerlink" title="3.1 RAG 原理"></a>3.1 RAG 原理</h3><p><strong>RAG（Retrieval-Augmented Generation）</strong> &#x3D; 检索 + 生成</p><pre><code class=" mermaid">graph LR    A[用户问题] --&gt; B[Embedding]    B --&gt; C[向量检索]    C --&gt; D[相关文档]    D --&gt; E[构建Prompt]    A --&gt; E    E --&gt; F[LLM生成]    F --&gt; G[回答]</code></pre><h3 id="3-2-向量数据库"><a href="#3-2-向量数据库" class="headerlink" title="3.2 向量数据库"></a>3.2 向量数据库</h3><table><thead><tr><th>数据库</th><th>特点</th><th>推荐场景</th></tr></thead><tbody><tr><td>Milvus</td><td>开源、高性能</td><td>生产环境首选</td></tr><tr><td>Pinecone</td><td>托管服务、易用</td><td>快速原型</td></tr><tr><td>Chroma</td><td>轻量、嵌入式</td><td>本地开发</td></tr><tr><td>Weaviate</td><td>GraphQL 支持</td><td>复杂查询</td></tr><tr><td>pgvector</td><td>PostgreSQL 插件</td><td>已有 PG 环境</td></tr></tbody></table><h3 id="3-3-核心流程"><a href="#3-3-核心流程" class="headerlink" title="3.3 核心流程"></a>3.3 核心流程</h3><ol><li><strong>文档加载</strong> — 读取 PDF、Word、网页等</li><li><strong>文本分割</strong> — 按 chunk 切分文档</li><li><strong>向量化</strong> — 调用 Embedding 模型</li><li><strong>存储</strong> — 写入向量数据库</li><li><strong>检索</strong> — 相似度搜索</li><li><strong>生成</strong> — 构建 Prompt 调用 LLM</li></ol><h2 id="阶段四：Prompt-Engineering（1-2周）"><a href="#阶段四：Prompt-Engineering（1-2周）" class="headerlink" title="阶段四：Prompt Engineering（1-2周）"></a>阶段四：Prompt Engineering（1-2周）</h2><h3 id="4-1-核心技巧"><a href="#4-1-核心技巧" class="headerlink" title="4.1 核心技巧"></a>4.1 核心技巧</h3><ul><li><strong>角色设定</strong> — 指定 AI 扮演的角色</li><li><strong>Few-shot</strong> — 提供示例引导输出格式</li><li><strong>Chain of Thought</strong> — 引导逐步推理</li><li><strong>结构化输出</strong> — 要求 JSON&#x2F;Markdown 格式</li></ul><h3 id="4-2-示例模板"><a href="#4-2-示例模板" class="headerlink" title="4.2 示例模板"></a>4.2 示例模板</h3><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs clean">你是一位资深的 Java 架构师。请根据以下代码分析潜在问题：<br><br>## 代码<br>&#123;<span class="hljs-keyword">code</span>&#125;<br><br>## 输出要求<br><span class="hljs-number">1.</span> 问题列表（严重程度：高/中/低）<br><span class="hljs-number">2.</span> 修改建议<br><span class="hljs-number">3.</span> 最佳实践参考<br></code></pre></td></tr></table></figure><h2 id="阶段五：进阶方向"><a href="#阶段五：进阶方向" class="headerlink" title="阶段五：进阶方向"></a>阶段五：进阶方向</h2><h3 id="5-1-Agent-开发"><a href="#5-1-Agent-开发" class="headerlink" title="5.1 Agent 开发"></a>5.1 Agent 开发</h3><ul><li><strong>Function Calling</strong> — 让 LLM 调用外部工具</li><li><strong>ReAct 模式</strong> — 推理 + 行动循环</li><li><strong>Multi-Agent</strong> — 多智能体协作</li></ul><h3 id="5-2-模型微调"><a href="#5-2-模型微调" class="headerlink" title="5.2 模型微调"></a>5.2 模型微调</h3><table><thead><tr><th>技术</th><th>说明</th><th>资源需求</th></tr></thead><tbody><tr><td>Full Fine-tuning</td><td>全参数微调</td><td>极高（多卡A100）</td></tr><tr><td>LoRA</td><td>低秩适应</td><td>中等（单卡可行）</td></tr><tr><td>QLoRA</td><td>量化 + LoRA</td><td>低（消费级显卡）</td></tr><tr><td>Prompt Tuning</td><td>软提示微调</td><td>低</td></tr></tbody></table><h3 id="5-3-开源模型部署"><a href="#5-3-开源模型部署" class="headerlink" title="5.3 开源模型部署"></a>5.3 开源模型部署</h3><ul><li><strong>Ollama</strong> — 本地运行开源模型</li><li><strong>vLLM</strong> — 高性能推理引擎</li><li><strong>Text Generation Inference</strong> — HuggingFace 官方方案</li></ul><h2 id="推荐学习资源"><a href="#推荐学习资源" class="headerlink" title="推荐学习资源"></a>推荐学习资源</h2><h3 id="课程"><a href="#课程" class="headerlink" title="课程"></a>课程</h3><table><thead><tr><th>资源</th><th>说明</th></tr></thead><tbody><tr><td>吴恩达《Generative AI for Everyone》</td><td>入门概念</td></tr><tr><td>DeepLearning.AI 短课程系列</td><td>LangChain、RAG 等专题</td></tr><tr><td>李沐《动手学深度学习》</td><td>深入原理</td></tr></tbody></table><h3 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h3><ul><li><a href="https://python.langchain.com/">LangChain 官方文档</a></li><li><a href="https://docs.spring.io/spring-ai/reference/">Spring AI 官方文档</a></li><li><a href="https://huggingface.co/learn">HuggingFace 教程</a></li></ul><h3 id="实践平台"><a href="#实践平台" class="headerlink" title="实践平台"></a>实践平台</h3><ul><li><strong>Colab</strong> — 免费 GPU 环境</li><li><strong>Kaggle</strong> — 数据集 + GPU</li><li><strong>魔搭社区</strong> — 国内模型平台</li></ul><h2 id="实战项目建议"><a href="#实战项目建议" class="headerlink" title="实战项目建议"></a>实战项目建议</h2><h3 id="入门项目"><a href="#入门项目" class="headerlink" title="入门项目"></a>入门项目</h3><ol><li><strong>智能客服</strong> — 基于 RAG 的问答系统</li><li><strong>文档助手</strong> — PDF&#x2F;文档智能问答</li><li><strong>代码助手</strong> — 代码解释、Review 工具</li></ol><h3 id="进阶项目"><a href="#进阶项目" class="headerlink" title="进阶项目"></a>进阶项目</h3><ol><li><strong>企业知识库</strong> — 多数据源、权限控制</li><li><strong>AI Agent</strong> — 自动化任务执行</li><li><strong>垂直领域模型</strong> — 行业微调模型</li></ol><h2 id="时间规划建议"><a href="#时间规划建议" class="headerlink" title="时间规划建议"></a>时间规划建议</h2><table><thead><tr><th>阶段</th><th>时间</th><th>产出</th></tr></thead><tbody><tr><td>基础准备</td><td>2周</td><td>Python 熟练使用</td></tr><tr><td>LLM 应用</td><td>3周</td><td>完成第一个 AI 应用</td></tr><tr><td>RAG 技术</td><td>3周</td><td>构建知识库问答系统</td></tr><tr><td>进阶方向</td><td>持续</td><td>根据兴趣深入</td></tr></tbody></table><blockquote><p><strong>⚠️ 重要: 核心建议</strong><br>从 <strong>Spring AI + 大模型 API</strong> 切入最快见效，边做项目边学习理论</p></blockquote><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>Python快速入门</li><li>LLM应用开发</li><li>RAG技术详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>AI</category>
      
      <category>大模型</category>
      
    </categories>
    
    
    <tags>
      
      <tag>AI</tag>
      
      <tag>大模型</tag>
      
      <tag>学习路线</tag>
      
      <tag>Java转型</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>分模块打包实战</title>
    <link href="/2026/01/12/%E5%88%86%E6%A8%A1%E5%9D%97%E6%89%93%E5%8C%85%E5%AE%9E%E6%88%98/"/>
    <url>/2026/01/12/%E5%88%86%E6%A8%A1%E5%9D%97%E6%89%93%E5%8C%85%E5%AE%9E%E6%88%98/</url>
    
    <content type="html"><![CDATA[<h1 id="Maven-分模块打包实战"><a href="#Maven-分模块打包实战" class="headerlink" title="Maven 分模块打包实战"></a>Maven 分模块打包实战</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p>在多模块项目中，不同模块的打包方式和目标不同：</p><ul><li><strong>父模块</strong>：不打包，仅用于聚合</li><li><strong>公共模块</strong>：打包成普通 JAR，供其他模块依赖</li><li><strong>服务模块</strong>：打包成普通 JAR 或可执行 JAR</li><li><strong>启动模块</strong>：打包成可执行 JAR，包含所有依赖</li></ul><hr><h2 id="打包类型对比"><a href="#打包类型对比" class="headerlink" title="打包类型对比"></a>打包类型对比</h2><table><thead><tr><th>打包类型</th><th>packaging</th><th>产物</th><th>适用场景</th><th>大小</th></tr></thead><tbody><tr><td><strong>POM</strong></td><td><code>pom</code></td><td>无 JAR</td><td>父模块、聚合模块</td><td>-</td></tr><tr><td><strong>普通 JAR</strong></td><td><code>jar</code></td><td>仅包含本模块代码</td><td>公共模块、被依赖模块</td><td>小（几十 KB - 几 MB）</td></tr><tr><td><strong>可执行 JAR</strong></td><td><code>jar</code></td><td>包含所有依赖</td><td>启动模块、独立应用</td><td>大（几十 MB - 几百 MB）</td></tr><tr><td><strong>WAR</strong></td><td><code>war</code></td><td>Web 应用包</td><td>部署到 Tomcat 等容器</td><td>中等</td></tr></tbody></table><hr><h2 id="父模块打包配置"><a href="#父模块打包配置" class="headerlink" title="父模块打包配置"></a>父模块打包配置</h2><h3 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 父模块 pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 必须是 pom --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-service<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-app<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li><code>packaging</code> 必须是 <code>pom</code></li><li>不会生成 JAR 文件</li><li>执行 <code>mvn package</code> 时会构建所有子模块</li></ul><hr><h2 id="公共模块打包配置"><a href="#公共模块打包配置" class="headerlink" title="公共模块打包配置"></a>公共模块打包配置</h2><p>公共模块（如 common、domain、repository）被其他模块依赖，只需打包成普通 JAR。</p><h3 id="基本配置-1"><a href="#基本配置-1" class="headerlink" title="基本配置"></a>基本配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- my-common/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 默认就是 jar，可省略 --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- Maven JAR 插件（默认已配置） --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">addDefaultImplementationEntries</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addDefaultImplementationEntries</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="打包产物"><a href="#打包产物" class="headerlink" title="打包产物"></a>打包产物</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">my-common/target/<br>└── my-common-1.0.0.jar      <span class="hljs-comment"># 只包含本模块编译的 class 文件</span><br></code></pre></td></tr></table></figure><p><strong>使用方式</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 打包并安装到本地仓库</span><br>mvn clean install<br><br><span class="hljs-comment"># 其他模块通过依赖引用</span><br>&lt;dependency&gt;<br>    &lt;groupId&gt;com.example&lt;/groupId&gt;<br>    &lt;artifactId&gt;my-common&lt;/artifactId&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></table></figure><hr><h2 id="启动模块打包配置"><a href="#启动模块打包配置" class="headerlink" title="启动模块打包配置"></a>启动模块打包配置</h2><p>启动模块需要打包成<strong>可执行 JAR</strong>，包含所有依赖，可独立运行。</p><h3 id="方式一：Spring-Boot-Maven-Plugin（推荐）"><a href="#方式一：Spring-Boot-Maven-Plugin（推荐）" class="headerlink" title="方式一：Spring Boot Maven Plugin（推荐）"></a>方式一：Spring Boot Maven Plugin（推荐）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- my-app/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-app<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 依赖其他模块 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- Spring Boot --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- Spring Boot 打包插件 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 指定主类（可选，自动检测） --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.MyApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 排除某些依赖（可选） --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>关键配置</strong>：</p><ul><li><code>repackage</code> goal：将依赖打包到 JAR 中</li><li>自动配置 MANIFEST.MF 中的 Main-Class</li><li>使用 Spring Boot 的类加载器</li></ul><p><strong>打包产物</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">my-app/target/<br>├── my-app-1.0.0.jar          <span class="hljs-comment"># 可执行 JAR（50-100 MB）</span><br>└── my-app-1.0.0.jar.original <span class="hljs-comment"># 原始 JAR（只有本模块代码）</span><br></code></pre></td></tr></table></figure><p><strong>运行</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar target/my-app-1.0.0.jar<br></code></pre></td></tr></table></figure><hr><h3 id="方式二：Maven-Assembly-Plugin（自定义打包）"><a href="#方式二：Maven-Assembly-Plugin（自定义打包）" class="headerlink" title="方式二：Maven Assembly Plugin（自定义打包）"></a>方式二：Maven Assembly Plugin（自定义打包）</h3><p>适用于非 Spring Boot 项目或需要自定义打包结构。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Assembly 插件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRefs</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 预定义的打包方式 --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRef</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">descriptorRefs</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>make-assembly<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>single<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>打包产物</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">target/my-app-1.0.0-jar-with-dependencies.jar<br></code></pre></td></tr></table></figure><p><strong>运行</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -jar target/my-app-1.0.0-jar-with-dependencies.jar<br></code></pre></td></tr></table></figure><hr><h3 id="方式三：Maven-Shade-Plugin（合并依赖）"><a href="#方式三：Maven-Shade-Plugin（合并依赖）" class="headerlink" title="方式三：Maven Shade Plugin（合并依赖）"></a>方式三：Maven Shade Plugin（合并依赖）</h3><p>适用于需要解决依赖冲突或重命名包的场景。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Shade 插件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-shade-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">transformers</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 指定主类 --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span> <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransformer&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 合并 Spring 配置文件 --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span> <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>META-INF/spring.handlers<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">transformer</span> <span class="hljs-attr">implementation</span>=<span class="hljs-string">&quot;org.apache.maven.plugins.shade.resource.AppendingTransformer&quot;</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>META-INF/spring.schemas<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">transformer</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">transformers</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 排除签名文件 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filters</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">artifact</span>&gt;</span>*:*<span class="hljs-tag">&lt;/<span class="hljs-name">artifact</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">excludes</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span>META-INF/*.SF<span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span>META-INF/*.DSA<span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">exclude</span>&gt;</span>META-INF/*.RSA<span class="hljs-tag">&lt;/<span class="hljs-name">exclude</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">excludes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">filters</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>shade<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>可以重命名包（relocate）避免冲突</li><li>可以合并 META-INF 下的配置文件</li><li>生成的 JAR 替换原始 JAR</li></ul><hr><h2 id="瘦-JAR-lib-目录方式"><a href="#瘦-JAR-lib-目录方式" class="headerlink" title="瘦 JAR + lib 目录方式"></a>瘦 JAR + lib 目录方式</h2><p>有些场景下不希望所有依赖打包到一个 JAR 中，可以采用瘦 JAR + lib 目录的方式。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 复制依赖到 lib 目录 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-dependency-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>copy-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>copy-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">outputDirectory</span>&gt;</span>$&#123;project.build.directory&#125;/lib<span class="hljs-tag">&lt;/<span class="hljs-name">outputDirectory</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">includeScope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">includeScope</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- JAR 插件配置 classpath --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">addClasspath</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">addClasspath</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">classpathPrefix</span>&gt;</span>lib/<span class="hljs-tag">&lt;/<span class="hljs-name">classpathPrefix</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.Main<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="打包产物-1"><a href="#打包产物-1" class="headerlink" title="打包产物"></a>打包产物</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">target/<br>├── my-app-1.0.0.jar          <span class="hljs-comment"># 瘦 JAR（只有本模块代码，几百 KB）</span><br>└── lib/                      <span class="hljs-comment"># 依赖目录</span><br>    ├── my-common-1.0.0.jar<br>    ├── my-service-1.0.0.jar<br>    ├── spring-boot-3.2.0.jar<br>    └── ...<br></code></pre></td></tr></table></figure><h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 方式 1：直接运行（MANIFEST.MF 已配置 classpath）</span><br>java -jar target/my-app-1.0.0.jar<br><br><span class="hljs-comment"># 方式 2：手动指定 classpath</span><br>java -<span class="hljs-built_in">cp</span> <span class="hljs-string">&quot;target/my-app-1.0.0.jar:target/lib/*&quot;</span> com.example.Main<br></code></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>更新单个模块时，只需替换对应的 JAR</li><li>依赖可复用，多个应用共享</li><li>JAR 文件小，传输快</li></ul><p><strong>缺点</strong>：</p><ul><li>部署时需要保持目录结构</li><li>不如单 JAR 方便</li></ul><hr><h2 id="常用打包命令"><a href="#常用打包命令" class="headerlink" title="常用打包命令"></a>常用打包命令</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 清理 + 打包（跳过测试）</span><br>mvn clean package -DskipTests<br><br><span class="hljs-comment"># 清理 + 打包 + 安装到本地仓库</span><br>mvn clean install<br><br><span class="hljs-comment"># 只打包特定模块</span><br>mvn clean package -pl my-app<br><br><span class="hljs-comment"># 打包模块及其依赖</span><br>mvn clean package -pl my-app -am<br><br><span class="hljs-comment"># 打包多个模块</span><br>mvn clean package -pl my-common,my-service<br><br><span class="hljs-comment"># 跳过某个模块</span><br>mvn clean package -pl !my-test<br><br><span class="hljs-comment"># 并行构建（加速）</span><br>mvn clean package -T 4<br></code></pre></td></tr></table></figure><h3 id="多环境打包"><a href="#多环境打包" class="headerlink" title="多环境打包"></a>多环境打包</h3><p>使用 Maven Profile 实现多环境打包：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 父 POM 中定义 profiles --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 开发环境 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">activeByDefault</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">activeByDefault</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">spring.profiles.active</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">spring.profiles.active</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 测试环境 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">spring.profiles.active</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">spring.profiles.active</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 生产环境 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">spring.profiles.active</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">spring.profiles.active</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>打包命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 开发环境（默认）</span><br>mvn clean package<br><br><span class="hljs-comment"># 测试环境</span><br>mvn clean package -Ptest<br><br><span class="hljs-comment"># 生产环境</span><br>mvn clean package -Pprod<br><br><span class="hljs-comment"># 同时激活多个 profile</span><br>mvn clean package -Ptest,docker<br></code></pre></td></tr></table></figure><p><strong>资源过滤</strong>：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>application.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>application-$&#123;env&#125;.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="打包优化"><a href="#打包优化" class="headerlink" title="打包优化"></a>打包优化</h2><h3 id="1-排除不必要的依赖"><a href="#1-排除不必要的依赖" class="headerlink" title="1. 排除不必要的依赖"></a>1. 排除不必要的依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 排除 provided scope 的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 编译时需要，运行时不需要 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 排除传递依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="2-依赖分析"><a href="#2-依赖分析" class="headerlink" title="2. 依赖分析"></a>2. 依赖分析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 查看依赖树</span><br>mvn dependency:tree<br><br><span class="hljs-comment"># 分析依赖冲突</span><br>mvn dependency:tree -Dverbose<br><br><span class="hljs-comment"># 查看直接依赖</span><br>mvn dependency:list<br><br><span class="hljs-comment"># 分析未使用的依赖</span><br>mvn dependency:analyze<br></code></pre></td></tr></table></figure><h3 id="3-压缩-JAR-包"><a href="#3-压缩-JAR-包" class="headerlink" title="3. 压缩 JAR 包"></a>3. 压缩 JAR 包</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">archive</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">compress</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">compress</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">index</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">index</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">archive</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="4-跳过不必要的步骤"><a href="#4-跳过不必要的步骤" class="headerlink" title="4. 跳过不必要的步骤"></a>4. 跳过不必要的步骤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 跳过测试</span><br>mvn clean package -DskipTests<br><br><span class="hljs-comment"># 跳过测试编译和执行</span><br>mvn clean package -Dmaven.test.skip=<span class="hljs-literal">true</span><br><br><span class="hljs-comment"># 跳过 Javadoc 生成</span><br>mvn clean package -Dmaven.javadoc.skip=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><hr><h2 id="Docker-镜像打包"><a href="#Docker-镜像打包" class="headerlink" title="Docker 镜像打包"></a>Docker 镜像打包</h2><h3 id="方式一：Dockerfile-Maven-打包"><a href="#方式一：Dockerfile-Maven-打包" class="headerlink" title="方式一：Dockerfile + Maven 打包"></a>方式一：Dockerfile + Maven 打包</h3><h4 id="1-Maven-打包可执行-JAR"><a href="#1-Maven-打包可执行-JAR" class="headerlink" title="1. Maven 打包可执行 JAR"></a>1. Maven 打包可执行 JAR</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn clean package -DskipTests<br></code></pre></td></tr></table></figure><h4 id="2-编写-Dockerfile"><a href="#2-编写-Dockerfile" class="headerlink" title="2. 编写 Dockerfile"></a>2. 编写 Dockerfile</h4><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-comment"># 多阶段构建（推荐）</span><br><span class="hljs-keyword">FROM</span> eclipse-temurin:<span class="hljs-number">17</span>-jdk-alpine AS builder<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><br><span class="hljs-comment"># 复制 Maven 配置和源码</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> pom.xml .</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-common ./my-common</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-service ./my-service</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-app ./my-app</span><br><br><span class="hljs-comment"># Maven 打包</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> ./mvnw clean package -DskipTests</span><br><br><span class="hljs-comment"># 运行阶段</span><br><span class="hljs-keyword">FROM</span> eclipse-temurin:<span class="hljs-number">17</span>-jre-alpine<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><br><span class="hljs-comment"># 复制构建产物</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> --from=builder /app/my-app/target/my-app-1.0.0.jar app.jar</span><br><br><span class="hljs-comment"># 暴露端口</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><br><span class="hljs-comment"># 启动命令</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;app.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><p><strong>简化版（本地已打包）</strong>：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> eclipse-temurin:<span class="hljs-number">17</span>-jre-alpine<br><span class="hljs-keyword">WORKDIR</span><span class="language-bash"> /app</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> my-app/target/my-app-1.0.0.jar app.jar</span><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">8080</span><br><span class="hljs-keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;app.jar&quot;</span>]</span><br></code></pre></td></tr></table></figure><h4 id="3-构建镜像"><a href="#3-构建镜像" class="headerlink" title="3. 构建镜像"></a>3. 构建镜像</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建镜像</span><br>docker build -t my-app:1.0.0 .<br><br><span class="hljs-comment"># 运行容器</span><br>docker run -d -p 8080:8080 my-app:1.0.0<br></code></pre></td></tr></table></figure><hr><h3 id="方式二：Jib-Maven-Plugin（无需-Dockerfile）"><a href="#方式二：Jib-Maven-Plugin（无需-Dockerfile）" class="headerlink" title="方式二：Jib Maven Plugin（无需 Dockerfile）"></a>方式二：Jib Maven Plugin（无需 Dockerfile）</h3><p>Jib 是 Google 开源的 Maven&#x2F;Gradle 插件，无需 Dockerfile 即可构建 Docker 镜像。</p><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- Jib 插件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.cloud.tools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jib-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 基础镜像 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">image</span>&gt;</span>eclipse-temurin:17-jre-alpine<span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 目标镜像 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">image</span>&gt;</span>my-app<span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">tags</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">tag</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">tag</span>&gt;</span>latest<span class="hljs-tag">&lt;/<span class="hljs-name">tag</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">tags</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 容器配置 --&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">container</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">jvmFlags</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">jvmFlag</span>&gt;</span>-Xms512m<span class="hljs-tag">&lt;/<span class="hljs-name">jvmFlag</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">jvmFlag</span>&gt;</span>-Xmx1024m<span class="hljs-tag">&lt;/<span class="hljs-name">jvmFlag</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">jvmFlags</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">ports</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">port</span>&gt;</span>8080<span class="hljs-tag">&lt;/<span class="hljs-name">port</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">ports</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">mainClass</span>&gt;</span>com.example.MyApplication<span class="hljs-tag">&lt;/<span class="hljs-name">mainClass</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">creationTime</span>&gt;</span>USE_CURRENT_TIMESTAMP<span class="hljs-tag">&lt;/<span class="hljs-name">creationTime</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="构建命令"><a href="#构建命令" class="headerlink" title="构建命令"></a>构建命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建到本地 Docker</span><br>mvn compile jib:dockerBuild<br><br><span class="hljs-comment"># 构建并推送到 Docker Hub</span><br>mvn compile jib:build<br><br><span class="hljs-comment"># 构建到 tar 文件</span><br>mvn compile jib:buildTar<br></code></pre></td></tr></table></figure><p><strong>优点</strong>：</p><ul><li>无需安装 Docker</li><li>无需编写 Dockerfile</li><li>构建速度快（增量构建）</li><li>自动优化镜像分层</li></ul><hr><h3 id="方式三：Spring-Boot-Maven-Plugin-构建镜像"><a href="#方式三：Spring-Boot-Maven-Plugin-构建镜像" class="headerlink" title="方式三：Spring Boot Maven Plugin 构建镜像"></a>方式三：Spring Boot Maven Plugin 构建镜像</h3><p>Spring Boot 2.3+ 内置了镜像构建功能（使用 Cloud Native Buildpacks）。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">image</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>my-app:$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">env</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">BP_JVM_VERSION</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">BP_JVM_VERSION</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">env</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">image</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>构建命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建镜像</span><br>mvn spring-boot:build-image<br><br><span class="hljs-comment"># 推送镜像</span><br>mvn spring-boot:build-image -Dspring-boot.build-image.publish=<span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><hr><h2 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h2><h3 id="场景-1：微服务项目打包"><a href="#场景-1：微服务项目打包" class="headerlink" title="场景 1：微服务项目打包"></a>场景 1：微服务项目打包</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nix">microservices-project<span class="hljs-symbol">/</span><br>├── pom.xml                    <span class="hljs-comment"># 父 POM</span><br>├── common<span class="hljs-symbol">/</span>                    <span class="hljs-comment"># 公共模块（普通 JAR）</span><br>├── user-service<span class="hljs-symbol">/</span>              <span class="hljs-comment"># 用户服务（可执行 JAR）</span><br>├── order-service<span class="hljs-symbol">/</span>             <span class="hljs-comment"># 订单服务（可执行 JAR）</span><br>└── gateway<span class="hljs-symbol">/</span>                   <span class="hljs-comment"># 网关（可执行 JAR）</span><br></code></pre></td></tr></table></figure><h4 id="父-POM"><a href="#父-POM" class="headerlink" title="父 POM"></a>父 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">pluginManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 统一配置 Spring Boot 插件 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">pluginManagement</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="公共模块-POM（common）"><a href="#公共模块-POM（common）" class="headerlink" title="公共模块 POM（common）"></a>公共模块 POM（common）</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 不需要任何打包插件，默认打包成普通 JAR --&gt;</span><br></code></pre></td></tr></table></figure><h4 id="服务模块-POM（user-service）"><a href="#服务模块-POM（user-service）" class="headerlink" title="服务模块 POM（user-service）"></a>服务模块 POM（user-service）</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>user-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 使用父 POM 中配置的 Spring Boot 插件 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="打包命令"><a href="#打包命令" class="headerlink" title="打包命令"></a>打包命令</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 打包所有服务</span><br>mvn clean package -DskipTests<br><br><span class="hljs-comment"># 只打包用户服务</span><br>mvn clean package -pl user-service -am -DskipTests<br><br><span class="hljs-comment"># 生产环境打包</span><br>mvn clean package -Pprod -DskipTests<br></code></pre></td></tr></table></figure><h4 id="产物"><a href="#产物" class="headerlink" title="产物"></a>产物</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">common/target/common-1.0.0.jar                     <span class="hljs-comment"># 普通 JAR</span><br>user-service/target/user-service-1.0.0.jar         <span class="hljs-comment"># 可执行 JAR</span><br>order-service/target/order-service-1.0.0.jar       <span class="hljs-comment"># 可执行 JAR</span><br>gateway/target/gateway-1.0.0.jar                   <span class="hljs-comment"># 可执行 JAR</span><br></code></pre></td></tr></table></figure><hr><h3 id="场景-2：框架项目打包（供第三方使用）"><a href="#场景-2：框架项目打包（供第三方使用）" class="headerlink" title="场景 2：框架项目打包（供第三方使用）"></a>场景 2：框架项目打包（供第三方使用）</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag-framework<span class="hljs-symbol">/</span><br>├── pom.xml                    <span class="hljs-comment"># 父 POM</span><br>├── rag-core<span class="hljs-symbol">/</span>                  <span class="hljs-comment"># 核心模块（普通 JAR）</span><br>├── rag-store-pgvector<span class="hljs-symbol">/</span>        <span class="hljs-comment"># 实现模块（普通 JAR）</span><br>├── rag-spring-boot-starter<span class="hljs-symbol">/</span>   <span class="hljs-comment"># Starter（普通 JAR）</span><br>└── rag-app<span class="hljs-symbol">/</span>                   <span class="hljs-comment"># 示例应用（可执行 JAR）</span><br></code></pre></td></tr></table></figure><h4 id="核心模块和实现模块"><a href="#核心模块和实现模块" class="headerlink" title="核心模块和实现模块"></a>核心模块和实现模块</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-core/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 不需要特殊配置，打包成普通 JAR --&gt;</span><br><br><span class="hljs-comment">&lt;!-- rag-store-pgvector/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 打包成普通 JAR，供用户按需引入 --&gt;</span><br></code></pre></td></tr></table></figure><h4 id="发布到-Maven-仓库"><a href="#发布到-Maven-仓库" class="headerlink" title="发布到 Maven 仓库"></a>发布到 Maven 仓库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建并安装到本地</span><br>mvn clean install<br><br><span class="hljs-comment"># 部署到私有仓库（需配置 distributionManagement）</span><br>mvn clean deploy<br><br><span class="hljs-comment"># 发布到 Maven 中央仓库（需配置 GPG 签名等）</span><br>mvn clean deploy -P release<br></code></pre></td></tr></table></figure><h4 id="用户使用"><a href="#用户使用" class="headerlink" title="用户使用"></a>用户使用</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 用户项目 pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 引入核心 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 按需引入实现 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q1-Spring-Boot-打包后-JAR-很大怎么办？"><a href="#Q1-Spring-Boot-打包后-JAR-很大怎么办？" class="headerlink" title="Q1: Spring Boot 打包后 JAR 很大怎么办？"></a>Q1: Spring Boot 打包后 JAR 很大怎么办？</h3><p><strong>A</strong>: 几种优化方式：</p><ol><li><p><strong>排除不必要的依赖</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>使用瘦 JAR + lib 目录</strong></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>ZIP<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br></code></pre></td></tr></table></figure></li><li><p><strong>使用 Docker 分层构建</strong></p><ul><li>依赖层单独缓存，不需要每次都打包</li></ul></li></ol><hr><h3 id="Q2-多模块打包时出现-“Could-not-resolve-dependencies”-错误？"><a href="#Q2-多模块打包时出现-“Could-not-resolve-dependencies”-错误？" class="headerlink" title="Q2: 多模块打包时出现 “Could not resolve dependencies” 错误？"></a>Q2: 多模块打包时出现 “Could not resolve dependencies” 错误？</h3><p><strong>A</strong>: 原因和解决方法：</p><ol><li><p><strong>模块未安装到本地仓库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 先 install 依赖的模块</span><br>mvn clean install -pl common -am<br></code></pre></td></tr></table></figure></li><li><p><strong>版本不一致</strong></p><ul><li>检查子模块版本是否与父 POM 一致</li><li>使用 <code>${project.version}</code> 引用</li></ul></li><li><p><strong>构建顺序错误</strong></p><ul><li>Maven 会自动计算依赖顺序</li><li>使用 <code>-am</code> 参数构建依赖模块</li></ul></li></ol><hr><h3 id="Q3-如何在打包时指定不同的配置文件？"><a href="#Q3-如何在打包时指定不同的配置文件？" class="headerlink" title="Q3: 如何在打包时指定不同的配置文件？"></a>Q3: 如何在打包时指定不同的配置文件？</h3><p><strong>A</strong>: 使用 Maven Profile + 资源过滤：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">config.file</span>&gt;</span>application-dev.yml<span class="hljs-tag">&lt;/<span class="hljs-name">config.file</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">config.file</span>&gt;</span>application-prod.yml<span class="hljs-tag">&lt;/<span class="hljs-name">config.file</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><p>打包：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn clean package -Pprod<br></code></pre></td></tr></table></figure><hr><h3 id="Q4-如何生成源码-JAR-和-Javadoc-JAR？"><a href="#Q4-如何生成源码-JAR-和-Javadoc-JAR？" class="headerlink" title="Q4: 如何生成源码 JAR 和 Javadoc JAR？"></a>Q4: 如何生成源码 JAR 和 Javadoc JAR？</h3><p><strong>A</strong>: 用于发布到 Maven 仓库：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 源码 JAR --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-source-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-sources<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- Javadoc JAR --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-javadoc-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>attach-javadocs<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span><br>                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span><br>                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h3 id="Q5-打包时如何跳过某些模块？"><a href="#Q5-打包时如何跳过某些模块？" class="headerlink" title="Q5: 打包时如何跳过某些模块？"></a>Q5: 打包时如何跳过某些模块？</h3><p><strong>A</strong>: 使用 <code>-pl</code> 和 <code>!</code> 排除：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 跳过测试模块</span><br>mvn clean package -pl !test-module<br><br><span class="hljs-comment"># 只打包指定模块</span><br>mvn clean package -pl user-service,order-service<br></code></pre></td></tr></table></figure><hr><h2 id="打包最佳实践"><a href="#打包最佳实践" class="headerlink" title="打包最佳实践"></a>打包最佳实践</h2><h3 id="1-模块职责清晰"><a href="#1-模块职责清晰" class="headerlink" title="1. 模块职责清晰"></a>1. 模块职责清晰</h3><table><thead><tr><th>模块类型</th><th>打包方式</th><th>发布</th></tr></thead><tbody><tr><td><strong>公共模块</strong></td><td>普通 JAR</td><td>install 到本地仓库</td></tr><tr><td><strong>服务模块</strong></td><td>普通 JAR 或可执行 JAR</td><td>看是否独立运行</td></tr><tr><td><strong>启动模块</strong></td><td>可执行 JAR</td><td>部署</td></tr></tbody></table><h3 id="2-统一管理插件版本"><a href="#2-统一管理插件版本" class="headerlink" title="2. 统一管理插件版本"></a>2. 统一管理插件版本</h3><p>在父 POM 的 <code>pluginManagement</code> 中统一配置：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">pluginManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-jar-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">pluginManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-使用-Profile-管理多环境"><a href="#3-使用-Profile-管理多环境" class="headerlink" title="3. 使用 Profile 管理多环境"></a>3. 使用 Profile 管理多环境</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">activation</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">activeByDefault</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">activeByDefault</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">activation</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="4-优化构建速度"><a href="#4-优化构建速度" class="headerlink" title="4. 优化构建速度"></a>4. 优化构建速度</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 并行构建</span><br>mvn clean package -T 4<br><br><span class="hljs-comment"># 跳过测试</span><br>mvn clean package -DskipTests<br><br><span class="hljs-comment"># 离线模式（使用本地缓存）</span><br>mvn clean package -o<br></code></pre></td></tr></table></figure><h3 id="5-依赖管理"><a href="#5-依赖管理" class="headerlink" title="5. 依赖管理"></a>5. 依赖管理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 定期分析依赖</span><br>mvn dependency:analyze<br><br><span class="hljs-comment"># 检查版本冲突</span><br>mvn dependency:tree -Dverbose<br><br><span class="hljs-comment"># 清理未使用的依赖</span><br>mvn dependency:purge-local-repository<br></code></pre></td></tr></table></figure><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th>打包方式</th><th>适用场景</th><th>命令</th><th>产物大小</th></tr></thead><tbody><tr><td><strong>普通 JAR</strong></td><td>公共模块、被依赖模块</td><td><code>mvn package</code></td><td>小</td></tr><tr><td><strong>可执行 JAR（Spring Boot）</strong></td><td>启动模块、微服务</td><td><code>mvn package</code></td><td>大</td></tr><tr><td><strong>瘦 JAR + lib</strong></td><td>需要分离依赖的场景</td><td><code>mvn package</code></td><td>小 + lib 目录</td></tr><tr><td><strong>Docker 镜像</strong></td><td>容器化部署</td><td><code>mvn jib:dockerBuild</code></td><td>镜像</td></tr></tbody></table><p><strong>关键点</strong>：</p><ul><li>父模块 <code>packaging=pom</code>，不打包</li><li>公共模块打包成普通 JAR，<code>install</code> 到本地仓库</li><li>启动模块使用 Spring Boot Maven Plugin 打包成可执行 JAR</li><li>使用 Profile 管理多环境配置</li><li>使用 <code>-pl</code> 和 <code>-am</code> 精确控制打包范围</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Maven</tag>
      
      <tag>打包</tag>
      
      <tag>多模块</tag>
      
      <tag>部署</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>多模块项目设计</title>
    <link href="/2026/01/12/%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1/"/>
    <url>/2026/01/12/%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="Maven-多模块项目设计"><a href="#Maven-多模块项目设计" class="headerlink" title="Maven 多模块项目设计"></a>Maven 多模块项目设计</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p>Maven 多模块项目是一个<strong>父项目</strong>包含多个<strong>子模块</strong>的结构，通过统一的 POM 文件管理依赖版本、编译配置等，实现代码复用和项目解耦。</p><h3 id="为什么使用多模块？"><a href="#为什么使用多模块？" class="headerlink" title="为什么使用多模块？"></a>为什么使用多模块？</h3><table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>依赖管理</strong></td><td>统一管理版本号，避免版本冲突</td></tr><tr><td><strong>代码复用</strong></td><td>公共代码提取到独立模块</td></tr><tr><td><strong>模块解耦</strong></td><td>各模块职责清晰，便于维护</td></tr><tr><td><strong>构建优化</strong></td><td>支持增量构建，提高效率</td></tr><tr><td><strong>团队协作</strong></td><td>不同团队可独立开发不同模块</td></tr></tbody></table><hr><h2 id="典型的多模块结构"><a href="#典型的多模块结构" class="headerlink" title="典型的多模块结构"></a>典型的多模块结构</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">my-project/                    <span class="hljs-comment"># 父项目</span><br>├── pom.<span class="hljs-keyword">xml</span>                    <span class="hljs-title"># 父 POM</span>（聚合和依赖管理）<br>├── my-common/                 <span class="hljs-comment"># 公共模块</span><br>│   ├── pom.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│   └── src</span>/<br>├── my-service/                <span class="hljs-comment"># 业务服务模块</span><br>│   ├── pom.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│   └── src</span>/<br>├── my-web/                    <span class="hljs-comment"># Web 模块</span><br>│   ├── pom.<span class="hljs-keyword">xml</span><br><span class="hljs-title">│   └── src</span>/<br>└── my-app/                    <span class="hljs-comment"># 应用启动模块</span><br>    ├── pom.<span class="hljs-keyword">xml</span><br>    <span class="hljs-title">└── src</span>/<br></code></pre></td></tr></table></figure><h3 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h3><ul><li><strong>父模块</strong>：只包含 POM，不含源代码</li><li><strong>公共模块</strong>：提供通用工具、常量、基类等</li><li><strong>业务模块</strong>：核心业务逻辑</li><li><strong>Web&#x2F;API 模块</strong>：对外接口层</li><li><strong>启动模块</strong>：应用入口</li></ul><hr><h2 id="父-POM-配置"><a href="#父-POM-配置" class="headerlink" title="父 POM 配置"></a>父 POM 配置</h2><h3 id="1-聚合配置（Aggregation）"><a href="#1-聚合配置（Aggregation）" class="headerlink" title="1. 聚合配置（Aggregation）"></a>1. 聚合配置（Aggregation）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 父模块必须是 pom --&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 聚合子模块 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-service<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-web<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>my-app<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>作用</strong>：执行 <code>mvn clean install</code> 时，会自动构建所有子模块</p><h3 id="2-依赖管理（Dependency-Management）"><a href="#2-依赖管理（Dependency-Management）" class="headerlink" title="2. 依赖管理（Dependency Management）"></a>2. 依赖管理（Dependency Management）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 定义版本，子模块不需要指定版本 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>关键点</strong>：</p><ul><li>只声明版本，不引入依赖</li><li>子模块可选择是否使用</li><li>避免版本冲突</li></ul><h3 id="3-插件管理（Plugin-Management）"><a href="#3-插件管理（Plugin-Management）" class="headerlink" title="3. 插件管理（Plugin Management）"></a>3. 插件管理（Plugin Management）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">pluginManagement</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">source</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">target</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">pluginManagement</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="子模块-POM-配置"><a href="#子模块-POM-配置" class="headerlink" title="子模块 POM 配置"></a>子模块 POM 配置</h2><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 继承父模块 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-project<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>&gt;</span>../pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">relativePath</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Common Module<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 依赖（版本从父 POM 继承） --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不需要指定版本 --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="模块间依赖"><a href="#模块间依赖" class="headerlink" title="模块间依赖"></a>模块间依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- my-service 模块依赖 my-common --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 版本从 dependencyManagement 继承 --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h2 id="设计最佳实践"><a href="#设计最佳实践" class="headerlink" title="设计最佳实践"></a>设计最佳实践</h2><h3 id="1-模块职责划分"><a href="#1-模块职责划分" class="headerlink" title="1. 模块职责划分"></a>1. 模块职责划分</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-keyword">my</span>-project/<br>├── <span class="hljs-keyword">my</span>-common/           <span class="hljs-comment"># 工具类、常量、基类</span><br>├── <span class="hljs-keyword">my</span>-domain/           <span class="hljs-comment"># 领域模型、实体</span><br>├── <span class="hljs-keyword">my</span>-repository/       <span class="hljs-comment"># 数据访问层</span><br>├── <span class="hljs-keyword">my</span>-service/          <span class="hljs-comment"># 业务逻辑层</span><br>├── <span class="hljs-keyword">my</span>-controller/       <span class="hljs-comment"># 控制层</span><br>└── <span class="hljs-keyword">my</span>-app/              <span class="hljs-comment"># 启动模块</span><br></code></pre></td></tr></table></figure><p><strong>依赖流向</strong>：<code>app → controller → service → repository → domain ← common</code></p><h3 id="2-版本管理策略"><a href="#2-版本管理策略" class="headerlink" title="2. 版本管理策略"></a>2. 版本管理策略</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 父 POM 中定义版本变量 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">project.version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">project.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 子模块引用 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-避免循环依赖"><a href="#3-避免循环依赖" class="headerlink" title="3. 避免循环依赖"></a>3. 避免循环依赖</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs css">❌ 错误：<span class="hljs-selector-tag">A</span> → <span class="hljs-selector-tag">B</span> → <span class="hljs-selector-tag">A</span><br>✅ 正确：<span class="hljs-selector-tag">A</span> → <span class="hljs-selector-tag">B</span> → C（单向依赖）<br></code></pre></td></tr></table></figure><p><strong>检查命令</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn dependency:tree<br></code></pre></td></tr></table></figure><h3 id="4-模块粒度控制"><a href="#4-模块粒度控制" class="headerlink" title="4. 模块粒度控制"></a>4. 模块粒度控制</h3><table><thead><tr><th>粒度</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>粗粒度</strong></td><td>构建快，管理简单</td><td>模块职责混乱</td></tr><tr><td><strong>细粒度</strong></td><td>职责清晰，复用性好</td><td>构建复杂，依赖管理困难</td></tr></tbody></table><p><strong>建议</strong>：根据团队规模和项目复杂度平衡</p><hr><h2 id="常用-Maven-命令"><a href="#常用-Maven-命令" class="headerlink" title="常用 Maven 命令"></a>常用 Maven 命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 构建所有模块</span><br>mvn clean install<br><br><span class="hljs-comment"># 构建特定模块</span><br>mvn clean install -pl my-common<br><br><span class="hljs-comment"># 构建模块及其依赖</span><br>mvn clean install -pl my-service -am<br><br><span class="hljs-comment"># 跳过测试</span><br>mvn clean install -DskipTests<br><br><span class="hljs-comment"># 查看依赖树</span><br>mvn dependency:tree<br><br><span class="hljs-comment"># 检查循环依赖</span><br>mvn dependency:tree | grep <span class="hljs-string">&quot;CIRCULAR&quot;</span><br></code></pre></td></tr></table></figure><hr><h2 id="实战示例：电商系统"><a href="#实战示例：电商系统" class="headerlink" title="实战示例：电商系统"></a>实战示例：电商系统</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nix">ecommerce-platform<span class="hljs-symbol">/</span><br>├── pom.xml                    <span class="hljs-comment"># 父 POM</span><br>├── ecommerce-common<span class="hljs-symbol">/</span>          <span class="hljs-comment"># 通用工具、常量</span><br>├── ecommerce-domain<span class="hljs-symbol">/</span>          <span class="hljs-comment"># 领域模型</span><br>├── ecommerce-repository<span class="hljs-symbol">/</span>      <span class="hljs-comment"># 数据访问</span><br>├── ecommerce-service<span class="hljs-symbol">/</span>         <span class="hljs-comment"># 业务逻辑</span><br>├── ecommerce-api<span class="hljs-symbol">/</span>             <span class="hljs-comment"># REST API</span><br>└── ecommerce-app<span class="hljs-symbol">/</span>             <span class="hljs-comment"># Spring Boot 启动类</span><br></code></pre></td></tr></table></figure><h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">ecommerce</span>-app<br>  ├── ecommerce-api<br>  │   ├── ecommerce-service<br>  │   │   ├── ecommerce-repository<br>  │   │   │   └── ecommerce-domain<br>  │   │   └── ecommerce-<span class="hljs-meta">common</span><br>  │   └── ecommerce-<span class="hljs-meta">common</span><br>  └── ...<br></code></pre></td></tr></table></figure><hr><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q1-子模块如何访问其他子模块的资源？"><a href="#Q1-子模块如何访问其他子模块的资源？" class="headerlink" title="Q1: 子模块如何访问其他子模块的资源？"></a>Q1: 子模块如何访问其他子模块的资源？</h3><p><strong>A</strong>: 通过依赖声明，不要直接引用文件路径</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- ✅ 正确 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>my-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- ❌ 错误 --&gt;</span><br><span class="hljs-comment">&lt;!-- 不要使用相对路径 --&gt;</span><br></code></pre></td></tr></table></figure><h3 id="Q2-如何只构建某个模块？"><a href="#Q2-如何只构建某个模块？" class="headerlink" title="Q2: 如何只构建某个模块？"></a>Q2: 如何只构建某个模块？</h3><p><strong>A</strong>: 使用 <code>-pl</code> 参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mvn clean install -pl my-service<br></code></pre></td></tr></table></figure><h3 id="Q3-子模块版本与父模块不同可以吗？"><a href="#Q3-子模块版本与父模块不同可以吗？" class="headerlink" title="Q3: 子模块版本与父模块不同可以吗？"></a>Q3: 子模块版本与父模块不同可以吗？</h3><p><strong>A</strong>: 不建议。应该保持一致，使用 <code>${project.version}</code></p><h3 id="Q4-如何处理模块间的版本冲突？"><a href="#Q4-如何处理模块间的版本冲突？" class="headerlink" title="Q4: 如何处理模块间的版本冲突？"></a>Q4: 如何处理模块间的版本冲突？</h3><p><strong>A</strong>: 在父 POM 的 <code>dependencyManagement</code> 中统一定义</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td><strong>聚合</strong></td><td>父 POM 通过 <code>&lt;modules&gt;</code> 统一构建</td></tr><tr><td><strong>继承</strong></td><td>子模块通过 <code>&lt;parent&gt;</code> 继承配置</td></tr><tr><td><strong>依赖管理</strong></td><td>使用 <code>&lt;dependencyManagement&gt;</code> 统一版本</td></tr><tr><td><strong>模块划分</strong></td><td>按职责清晰划分，避免循环依赖</td></tr><tr><td><strong>版本策略</strong></td><td>统一版本号，便于维护和发布</td></tr></tbody></table><hr><h2 id="框架类型项目设计（SPI-模式）"><a href="#框架类型项目设计（SPI-模式）" class="headerlink" title="框架类型项目设计（SPI 模式）"></a>框架类型项目设计（SPI 模式）</h2><p>框架类型项目与普通业务系统不同，需要支持<strong>可插拔</strong>和<strong>扩展性</strong>。典型场景：</p><ul><li>RAG 系统：多种向量数据库（ES、PG、Neo4j、Milvus）</li><li>ORM 框架：多种数据库方言（MySQL、PostgreSQL、Oracle）</li><li>消息队列：多种实现（Kafka、RabbitMQ、RocketMQ）</li></ul><h3 id="核心设计思想"><a href="#核心设计思想" class="headerlink" title="核心设计思想"></a>核心设计思想</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────────────────────────────────────────────────┐<br>│                      用户应用层                              │<br>│                  (只依赖 API + 需要的实现)                    │<br>└─────────────────────────────────────────────────────────────┘<br>                              │<br>                              ▼<br>┌─────────────────────────────────────────────────────────────┐<br>│                    rag-core (核心模块)                       │<br>│              定义接口 + 默认实现 + SPI 加载机制               │<br>└─────────────────────────────────────────────────────────────┘<br>                              │<br>          ┌───────────────────┼───────────────────┐<br>          ▼                   ▼                   ▼<br>┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐<br>│  rag-store-es   │ │  rag-store-pg   │ │ rag-store-neo4j │<br>│   (ES 实现)      │ │  (PgVector)     │ │   (Neo4j 实现)   │<br>└─────────────────┘ └─────────────────┘ └─────────────────┘<br></code></pre></td></tr></table></figure><p><strong>关键原则</strong>：</p><ul><li><strong>依赖倒置</strong>：核心模块定义接口，实现模块依赖核心</li><li><strong>按需引入</strong>：用户只引入需要的实现模块</li><li><strong>SPI 发现</strong>：运行时自动发现并加载实现</li></ul><hr><h3 id="实战示例：RAG-系统模块结构"><a href="#实战示例：RAG-系统模块结构" class="headerlink" title="实战示例：RAG 系统模块结构"></a>实战示例：RAG 系统模块结构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag-framework<span class="hljs-symbol">/</span><br>├── pom.xml                        <span class="hljs-comment"># 父 POM</span><br>│<br>├── rag-core<span class="hljs-symbol">/</span>                      <span class="hljs-comment"># 核心模块</span><br>│   ├── pom.xml<br>│   └── src<span class="hljs-operator">/</span>main<span class="hljs-operator">/</span>java<span class="hljs-symbol">/</span><br>│       └── com<span class="hljs-operator">/</span>example<span class="hljs-operator">/</span>rag<span class="hljs-symbol">/</span><br>│           ├── api<span class="hljs-symbol">/</span>               <span class="hljs-comment"># 核心接口定义</span><br>│           │   ├── VectorStore.java<br>│           │   └── DocumentSplitter.java<br>│           ├── spi<span class="hljs-symbol">/</span>               <span class="hljs-comment"># SPI 加载机制</span><br>│           │   └── SpiLoader.java<br>│           └── model<span class="hljs-symbol">/</span>             <span class="hljs-comment"># 领域模型</span><br>│               └── Document.java<br>│<br>├── rag-store-elasticsearch<span class="hljs-symbol">/</span>       <span class="hljs-comment"># ES 实现</span><br>│   ├── pom.xml<br>│   └── src<span class="hljs-operator">/</span>main<span class="hljs-symbol">/</span><br>│       ├── java<span class="hljs-symbol">/.../ElasticsearchVectorStore.java</span><br>│       └── resources<span class="hljs-operator">/</span>META-INF<span class="hljs-operator">/</span>services<span class="hljs-symbol">/</span><br>│           └── com.example.rag.api.VectorStore<br>│<br>├── rag-store-pgvector<span class="hljs-symbol">/</span>            <span class="hljs-comment"># PgVector 实现</span><br>│   ├── pom.xml<br>│   └── src<span class="hljs-operator">/</span>main<span class="hljs-symbol">/</span><br>│       ├── java<span class="hljs-symbol">/.../PgVectorStore.java</span><br>│       └── resources<span class="hljs-operator">/</span>META-INF<span class="hljs-operator">/</span>services<span class="hljs-symbol">/</span><br>│           └── com.example.rag.api.VectorStore<br>│<br>├── rag-store-neo4j<span class="hljs-symbol">/</span>               <span class="hljs-comment"># Neo4j 实现</span><br>│   └── ...<br>│<br>├── rag-splitter-fixed<span class="hljs-symbol">/</span>            <span class="hljs-comment"># 固定长度切片</span><br>│   └── ...<br>│<br>├── rag-splitter-sentence<span class="hljs-symbol">/</span>         <span class="hljs-comment"># 按句子切片</span><br>│   └── ...<br>│<br>├── rag-splitter-semantic<span class="hljs-symbol">/</span>         <span class="hljs-comment"># 语义切片</span><br>│   └── ...<br>│<br>└── rag-spring-boot-starter<span class="hljs-symbol">/</span>       <span class="hljs-comment"># Spring Boot 自动配置</span><br>    └── ...<br></code></pre></td></tr></table></figure><hr><h3 id="核心模块设计（rag-core）"><a href="#核心模块设计（rag-core）" class="headerlink" title="核心模块设计（rag-core）"></a>核心模块设计（rag-core）</h3><h4 id="1-定义-SPI-接口"><a href="#1-定义-SPI-接口" class="headerlink" title="1. 定义 SPI 接口"></a>1. 定义 SPI 接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// VectorStore.java - 向量存储接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">VectorStore</span> &#123;<br>    <br>    <span class="hljs-comment">/** SPI 扩展点标识 */</span><br>    String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span>;<br>    <br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">store</span><span class="hljs-params">(List&lt;Document&gt; documents)</span>;<br>    <br>    List&lt;Document&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span>;<br>&#125;<br><br><span class="hljs-comment">// DocumentSplitter.java - 文档切片接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DocumentSplitter</span> &#123;<br>    <br>    String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span>;<br>    <br>    List&lt;Document&gt; <span class="hljs-title function_">split</span><span class="hljs-params">(Document document)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-SPI-加载器"><a href="#2-SPI-加载器" class="headerlink" title="2. SPI 加载器"></a>2. SPI 加载器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpiLoader</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;Class&lt;?&gt;, Map&lt;String, Object&gt;&gt; CACHE = <br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">load</span><span class="hljs-params">(Class&lt;T&gt; clazz, String type)</span> &#123;<br>        Map&lt;String, Object&gt; implementations = CACHE.computeIfAbsent(<br>            clazz, <br>            k -&gt; loadImplementations(clazz)<br>        );<br>        <br>        <span class="hljs-type">T</span> <span class="hljs-variable">impl</span> <span class="hljs-operator">=</span> (T) implementations.get(type);<br>        <span class="hljs-keyword">if</span> (impl == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<br>                <span class="hljs-string">&quot;No implementation found for type: &quot;</span> + type<br>            );<br>        &#125;<br>        <span class="hljs-keyword">return</span> impl;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; Map&lt;String, Object&gt; <span class="hljs-title function_">loadImplementations</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> &#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        ServiceLoader&lt;T&gt; loader = ServiceLoader.load(clazz);<br>        <br>        <span class="hljs-keyword">for</span> (T impl : loader) &#123;<br>            <span class="hljs-comment">// 假设接口有 getType() 方法</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> getType(impl);<br>            map.put(type, impl);<br>        &#125;<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-核心模块-POM"><a href="#3-核心模块-POM" class="headerlink" title="3. 核心模块 POM"></a>3. 核心模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-core/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>RAG Core<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 只放最基础的依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h3 id="实现模块设计"><a href="#实现模块设计" class="headerlink" title="实现模块设计"></a>实现模块设计</h3><h4 id="1-ES-实现模块"><a href="#1-ES-实现模块" class="headerlink" title="1. ES 实现模块"></a>1. ES 实现模块</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ElasticsearchVectorStore.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElasticsearchVectorStore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VectorStore</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;elasticsearch&quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">store</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> &#123;<br>        <span class="hljs-comment">// ES 特定实现</span><br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> &#123;<br>        <span class="hljs-comment">// ES 特定实现</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-SPI-配置文件"><a href="#2-SPI-配置文件" class="headerlink" title="2. SPI 配置文件"></a>2. SPI 配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">src/main/resources/META-INF/services/com.example.rag.api.VectorStore</span><br>com.example.rag.store.es.ElasticsearchVectorStore<br></code></pre></td></tr></table></figure><h4 id="3-实现模块-POM"><a href="#3-实现模块-POM" class="headerlink" title="3. 实现模块 POM"></a>3. 实现模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-store-elasticsearch/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 依赖核心模块 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- ES 特定依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>co.elastic.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.10.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h3 id="用户使用方式"><a href="#用户使用方式" class="headerlink" title="用户使用方式"></a>用户使用方式</h3><h4 id="按需引入"><a href="#按需引入" class="headerlink" title="按需引入"></a>按需引入</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 用户项目 pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 核心（必需） --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 只引入需要的实现 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-splitter-semantic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="代码使用"><a href="#代码使用" class="headerlink" title="代码使用"></a>代码使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 通过 SPI 自动加载</span><br><span class="hljs-type">VectorStore</span> <span class="hljs-variable">store</span> <span class="hljs-operator">=</span> SpiLoader.load(VectorStore.class, <span class="hljs-string">&quot;pgvector&quot;</span>);<br><span class="hljs-type">DocumentSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> SpiLoader.load(DocumentSplitter.class, <span class="hljs-string">&quot;semantic&quot;</span>);<br><br><span class="hljs-comment">// 或通过配置文件指定</span><br><span class="hljs-meta">@Value(&quot;$&#123;rag.store.type&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String storeType;<br><br><span class="hljs-type">VectorStore</span> <span class="hljs-variable">store</span> <span class="hljs-operator">=</span> SpiLoader.load(VectorStore.class, storeType);<br></code></pre></td></tr></table></figure><hr><h3 id="依赖关系图"><a href="#依赖关系图" class="headerlink" title="依赖关系图"></a>依赖关系图</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">用户项目<br>    │<br>    ├── rag-core (必需)<br>    │<br>    ├── rag-store-xxx (选一个)<br>    │   └── rag-core<br>    │<br>    └── rag-splitter-xxx (选一个)<br>        └── rag-core<br></code></pre></td></tr></table></figure><p><strong>关键点</strong>：</p><ul><li>用户<strong>不需要</strong>同时引入所有实现</li><li>运行时通过 SPI 自动发现引入的实现</li><li>新增实现只需要添加新模块，不修改核心代码</li></ul><hr><h3 id="Spring-Boot-Starter-封装"><a href="#Spring-Boot-Starter-封装" class="headerlink" title="Spring Boot Starter 封装"></a>Spring Boot Starter 封装</h3><p>为了更好的集成体验，可以提供 Starter：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-spring-boot-starter/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RagAutoConfiguration.java</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(RagProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagAutoConfiguration</span> &#123;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> VectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(RagProperties props)</span> &#123;<br>        <span class="hljs-keyword">return</span> SpiLoader.load(VectorStore.class, props.getStore().getType());<br>    &#125;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> DocumentSplitter <span class="hljs-title function_">documentSplitter</span><span class="hljs-params">(RagProperties props)</span> &#123;<br>        <span class="hljs-keyword">return</span> SpiLoader.load(DocumentSplitter.class, props.getSplitter().getType());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 用户配置 application.yml</span><br><span class="hljs-attr">rag:</span><br>  <span class="hljs-attr">store:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">pgvector</span><br>  <span class="hljs-attr">splitter:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">semantic</span><br>    <span class="hljs-attr">chunk-size:</span> <span class="hljs-number">500</span><br></code></pre></td></tr></table></figure><hr><h3 id="框架设计对比"><a href="#框架设计对比" class="headerlink" title="框架设计对比"></a>框架设计对比</h3><table><thead><tr><th>设计模式</th><th>适用场景</th><th>典型框架</th></tr></thead><tbody><tr><td><strong>SPI + 多实现模块</strong></td><td>同一接口多种实现</td><td>JDBC、SLF4J</td></tr><tr><td><strong>策略模式</strong></td><td>算法&#x2F;行为可替换</td><td>切片方式、嵌入模型</td></tr><tr><td><strong>模板方法</strong></td><td>固定流程可扩展步骤</td><td>Spring Template</td></tr><tr><td><strong>工厂模式</strong></td><td>对象创建解耦</td><td>各种 Factory</td></tr></tbody></table><hr><h3 id="扩展性设计要点"><a href="#扩展性设计要点" class="headerlink" title="扩展性设计要点"></a>扩展性设计要点</h3><ol><li><strong>接口隔离</strong>：核心接口放在独立模块，无第三方依赖</li><li><strong>可选依赖</strong>：使用 <code>&lt;optional&gt;true&lt;/optional&gt;</code> 避免传递依赖</li><li><strong>默认实现</strong>：核心模块提供简单默认实现</li><li><strong>配置驱动</strong>：通过配置切换实现，而非代码修改</li><li><strong>版本兼容</strong>：接口变更需考虑向后兼容</li></ol><hr><h2 id="完整框架结构（含应用层）"><a href="#完整框架结构（含应用层）" class="headerlink" title="完整框架结构（含应用层）"></a>完整框架结构（含应用层）</h2><p>实际项目中，除了可插拔的底层模块，还需要<strong>应用层</strong>来组合这些模块并对外提供服务。</p><h3 id="完整模块结构"><a href="#完整模块结构" class="headerlink" title="完整模块结构"></a>完整模块结构</h3><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag-framework<span class="hljs-symbol">/</span><br>├── pom.xml                        <span class="hljs-comment"># 父 POM</span><br>│<br>│  <span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">=</span> 框架层（可独立发布给第三方使用）<span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">=</span><br>│<br>├── rag-core<span class="hljs-symbol">/</span>                      <span class="hljs-comment"># 核心接口 + SPI</span><br>│   └── 无外部依赖，纯接口定义<br>│<br>├── rag-stores<span class="hljs-symbol">/</span>                    <span class="hljs-comment"># 向量存储实现（聚合模块）</span><br>│   ├── pom.xml                    <span class="hljs-comment"># packaging=pom，聚合子模块</span><br>│   ├── rag-store-core<span class="hljs-symbol">/</span>            <span class="hljs-comment"># 🔑 抽象层：基类 + 公共工具</span><br>│   ├── rag-store-elasticsearch<span class="hljs-symbol">/</span>   <span class="hljs-comment"># 继承抽象层</span><br>│   ├── rag-store-pgvector<span class="hljs-symbol">/</span><br>│   └── rag-store-neo4j<span class="hljs-symbol">/</span><br>│<br>├── rag-splitters<span class="hljs-symbol">/</span>                 <span class="hljs-comment"># 切片策略实现（聚合模块）</span><br>│   ├── pom.xml<br>│   ├── rag-splitter-core<span class="hljs-symbol">/</span>         <span class="hljs-comment"># 🔑 抽象层</span><br>│   ├── rag-splitter-fixed<span class="hljs-symbol">/</span><br>│   ├── rag-splitter-sentence<span class="hljs-symbol">/</span><br>│   └── rag-splitter-semantic<span class="hljs-symbol">/</span><br>│<br>├── rag-embeddings<span class="hljs-symbol">/</span>                <span class="hljs-comment"># 嵌入模型实现（聚合模块）</span><br>│   ├── pom.xml<br>│   ├── rag-embedding-core<span class="hljs-symbol">/</span>        <span class="hljs-comment"># 🔑 抽象层</span><br>│   ├── rag-embedding-openai<span class="hljs-symbol">/</span><br>│   └── rag-embedding-local<span class="hljs-symbol">/</span><br>│<br>├── rag-spring-boot-starter<span class="hljs-symbol">/</span>       <span class="hljs-comment"># Spring Boot 自动配置</span><br>│<br>│  <span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">=</span> 应用层（组合模块，对外提供服务）<span class="hljs-operator">==</span><span class="hljs-operator">==</span><span class="hljs-operator">=</span><br>│<br>├── rag-service<span class="hljs-symbol">/</span>                   <span class="hljs-comment"># 业务服务层</span><br>├── rag-api<span class="hljs-symbol">/</span>                       <span class="hljs-comment"># Controller 层（REST API）</span><br>└── rag-server<span class="hljs-symbol">/</span>                    <span class="hljs-comment"># 启动模块</span><br></code></pre></td></tr></table></figure><h3 id="抽象层设计（rag-store-core）"><a href="#抽象层设计（rag-store-core）" class="headerlink" title="抽象层设计（rag-store-core）"></a>抽象层设计（rag-store-core）</h3><p>抽象层的职责：</p><ul><li><strong>抽象基类</strong>：实现公共逻辑，子类只需实现差异部分</li><li><strong>工具类</strong>：连接池管理、序列化、重试机制等</li><li><strong>配置基类</strong>：公共配置项</li></ul><h4 id="依赖关系-1"><a href="#依赖关系-1" class="headerlink" title="依赖关系"></a>依赖关系</h4><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs llvm">rag-<span class="hljs-keyword">store</span>-elasticsearch<br>        │<br>        ▼<br>rag-<span class="hljs-keyword">store</span>-core (抽象层)<br>        │<br>        ▼<br>   rag-core (接口)<br></code></pre></td></tr></table></figure><h4 id="抽象层代码示例"><a href="#抽象层代码示例" class="headerlink" title="抽象层代码示例"></a>抽象层代码示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// rag-store-core 模块</span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * VectorStore 抽象基类</span><br><span class="hljs-comment"> * 实现公共逻辑，子类只需关注特定数据库操作</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractVectorStore</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">VectorStore</span> &#123;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> VectorStoreConfig config;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">AbstractVectorStore</span><span class="hljs-params">(VectorStoreConfig config)</span> &#123;<br>        <span class="hljs-built_in">this</span>.config = config;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">store</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> &#123;<br>        <span class="hljs-comment">// 1. 公共逻辑：参数校验</span><br>        validateDocuments(documents);<br>        <br>        <span class="hljs-comment">// 2. 公共逻辑：批量处理</span><br>        List&lt;List&lt;Document&gt;&gt; batches = partition(documents, config.getBatchSize());<br>        <br>        <span class="hljs-keyword">for</span> (List&lt;Document&gt; batch : batches) &#123;<br>            <span class="hljs-comment">// 3. 调用子类实现的具体存储逻辑</span><br>            doStore(batch);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> &#123;<br>        <span class="hljs-comment">// 公共逻辑：参数校验</span><br>        <span class="hljs-keyword">if</span> (topK &lt;= <span class="hljs-number">0</span> || topK &gt; config.getMaxTopK()) &#123;<br>            topK = config.getDefaultTopK();<br>        &#125;<br>        <br>        <span class="hljs-comment">// 调用子类实现</span><br>        <span class="hljs-keyword">return</span> doSearch(query, topK);<br>    &#125;<br>    <br>    <span class="hljs-comment">// ===== 子类必须实现的抽象方法 =====</span><br>    <br>    <span class="hljs-comment">/** 具体的存储实现 */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStore</span><span class="hljs-params">(List&lt;Document&gt; documents)</span>;<br>    <br>    <span class="hljs-comment">/** 具体的搜索实现 */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> List&lt;Document&gt; <span class="hljs-title function_">doSearch</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span>;<br>    <br>    <span class="hljs-comment">// ===== 公共工具方法 =====</span><br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateDocuments</span><span class="hljs-params">(List&lt;Document&gt; docs)</span> &#123;<br>        <span class="hljs-keyword">if</span> (docs == <span class="hljs-literal">null</span> || docs.isEmpty()) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Documents cannot be empty&quot;</span>);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> &lt;T&gt; List&lt;List&lt;T&gt;&gt; <span class="hljs-title function_">partition</span><span class="hljs-params">(List&lt;T&gt; list, <span class="hljs-type">int</span> size)</span> &#123;<br>        <span class="hljs-comment">// 分批工具方法</span><br>        List&lt;List&lt;T&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i += size) &#123;<br>            result.add(list.subList(i, Math.min(i + size, list.size())));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 公共配置基类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VectorStoreConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">batchSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">defaultTopK</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxTopK</span> <span class="hljs-operator">=</span> <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">connectTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">5000</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">readTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="具体实现（继承抽象层）"><a href="#具体实现（继承抽象层）" class="headerlink" title="具体实现（继承抽象层）"></a>具体实现（继承抽象层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// rag-store-pgvector 模块</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PgVectorStore</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractVectorStore</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> JdbcTemplate jdbcTemplate;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PgVectorStore</span><span class="hljs-params">(PgVectorConfig config, JdbcTemplate jdbcTemplate)</span> &#123;<br>        <span class="hljs-built_in">super</span>(config);  <span class="hljs-comment">// 调用父类构造器</span><br>        <span class="hljs-built_in">this</span>.jdbcTemplate = jdbcTemplate;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;pgvector&quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doStore</span><span class="hljs-params">(List&lt;Document&gt; documents)</span> &#123;<br>        <span class="hljs-comment">// 只需实现 PgVector 特定的存储逻辑</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;INSERT INTO documents (content, embedding) VALUES (?, ?::vector)&quot;</span>;<br>        jdbcTemplate.batchUpdate(sql, documents, documents.size(), <br>            (ps, doc) -&gt; &#123;<br>                ps.setString(<span class="hljs-number">1</span>, doc.getContent());<br>                ps.setArray(<span class="hljs-number">2</span>, toSqlArray(doc.getEmbedding()));<br>            &#125;);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> List&lt;Document&gt; <span class="hljs-title function_">doSearch</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> &#123;<br>        <span class="hljs-comment">// 只需实现 PgVector 特定的搜索逻辑</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">            SELECT content, 1 - (embedding &lt;=&gt; ?::vector) as score</span><br><span class="hljs-string">            FROM documents</span><br><span class="hljs-string">            ORDER BY embedding &lt;=&gt; ?::vector</span><br><span class="hljs-string">            LIMIT ?</span><br><span class="hljs-string">            &quot;&quot;&quot;</span>;<br>        <span class="hljs-keyword">return</span> jdbcTemplate.query(sql, documentRowMapper, queryVector, queryVector, topK);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 继承公共配置，添加特定配置</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@EqualsAndHashCode(callSuper = true)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PgVectorConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">VectorStoreConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">tableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;documents&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">dimension</span> <span class="hljs-operator">=</span> <span class="hljs-number">1536</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">indexType</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ivfflat&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="聚合模块-POM-示例"><a href="#聚合模块-POM-示例" class="headerlink" title="聚合模块 POM 示例"></a>聚合模块 POM 示例</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-stores/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-stores<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>RAG Vector Stores<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-store-core<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>        <span class="hljs-comment">&lt;!-- 抽象层优先构建 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-store-elasticsearch<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-store-neo4j<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-stores/rag-store-core/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-stores<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 只依赖核心接口 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-stores/rag-store-pgvector/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-stores<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 依赖抽象层（会传递 rag-core） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- PgVector 特定依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="父-POM-聚合配置"><a href="#父-POM-聚合配置" class="headerlink" title="父 POM 聚合配置"></a>父 POM 聚合配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 根 pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-stores<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>       <span class="hljs-comment">&lt;!-- 聚合目录 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-splitters<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>    <span class="hljs-comment">&lt;!-- 聚合目录 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-embeddings<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>   <span class="hljs-comment">&lt;!-- 聚合目录 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-service<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-api<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag-server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="模块依赖全景图"><a href="#模块依赖全景图" class="headerlink" title="模块依赖全景图"></a>模块依赖全景图</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs scss">         ┌─────────────────────────────────┐<br>         │         rag-server              │<br>         │   (启动类 + 配置 + 打包)         │<br>         └─────────────────────────────────┘<br>                         │<br>         ┌───────────────┼───────────────┐<br>         ▼               ▼               ▼<br>┌──────────────┐  ┌──────────────┐  ┌──────────────┐<br>│   rag-api    │  │rag-store-pg  │  │rag-splitter- │<br>│ (Controller) │  │  (选择的实现) │  │  semantic    │<br>└──────────────┘  └──────────────┘  └──────────────┘<br>         │               │               │<br>         ▼               ▼               ▼<br>┌──────────────┐        │               │<br>│ rag-service  │        │               │<br>│  (业务逻辑)   │◄───────┴───────────────┘<br>└──────────────┘<br>         │<br>         ▼<br>┌──────────────┐<br>│   rag-core   │<br>│  (核心接口)   │<br>└──────────────┘<br></code></pre></td></tr></table></figure><hr><h3 id="Service-层设计（rag-service）"><a href="#Service-层设计（rag-service）" class="headerlink" title="Service 层设计（rag-service）"></a>Service 层设计（rag-service）</h3><p>Service 层负责<strong>组合</strong>底层组件，实现具体业务逻辑。</p><h4 id="模块-POM"><a href="#模块-POM" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-service/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 依赖核心模块 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- Spring 依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="Service-实现"><a href="#Service-实现" class="headerlink" title="Service 实现"></a>Service 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RagService.java - 组合底层组件</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagService</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VectorStore vectorStore;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DocumentSplitter splitter;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingModel embeddingModel;<br>    <br>    <span class="hljs-comment">// 通过构造器注入（具体实现由 Starter 自动配置）</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RagService</span><span class="hljs-params">(VectorStore vectorStore, </span><br><span class="hljs-params">                      DocumentSplitter splitter,</span><br><span class="hljs-params">                      EmbeddingModel embeddingModel)</span> &#123;<br>        <span class="hljs-built_in">this</span>.vectorStore = vectorStore;<br>        <span class="hljs-built_in">this</span>.splitter = splitter;<br>        <span class="hljs-built_in">this</span>.embeddingModel = embeddingModel;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文档入库流程</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ingest</span><span class="hljs-params">(Document document)</span> &#123;<br>        <span class="hljs-comment">// 1. 切片</span><br>        List&lt;Document&gt; chunks = splitter.split(document);<br>        <br>        <span class="hljs-comment">// 2. 生成向量</span><br>        <span class="hljs-keyword">for</span> (Document chunk : chunks) &#123;<br>            <span class="hljs-type">float</span>[] embedding = embeddingModel.embed(chunk.getContent());<br>            chunk.setEmbedding(embedding);<br>        &#125;<br>        <br>        <span class="hljs-comment">// 3. 存储</span><br>        vectorStore.store(chunks);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检索流程</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;Document&gt; <span class="hljs-title function_">retrieve</span><span class="hljs-params">(String query, <span class="hljs-type">int</span> topK)</span> &#123;<br>        <span class="hljs-keyword">return</span> vectorStore.search(query, topK);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * RAG 完整流程</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(String question)</span> &#123;<br>        <span class="hljs-comment">// 1. 检索相关文档</span><br>        List&lt;Document&gt; contexts = retrieve(question, <span class="hljs-number">5</span>);<br>        <br>        <span class="hljs-comment">// 2. 构建 Prompt</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> buildPrompt(question, contexts);<br>        <br>        <span class="hljs-comment">// 3. 调用 LLM（这里可以再抽象一个 LLM 接口）</span><br>        <span class="hljs-keyword">return</span> llmClient.generate(prompt);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="Controller-层设计（rag-api）"><a href="#Controller-层设计（rag-api）" class="headerlink" title="Controller 层设计（rag-api）"></a>Controller 层设计（rag-api）</h3><p>Controller 层负责<strong>对外暴露 HTTP 接口</strong>。</p><h4 id="模块-POM-1"><a href="#模块-POM-1" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-api/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 依赖 service 层 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-service<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- Web 依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="Controller-实现"><a href="#Controller-实现" class="headerlink" title="Controller 实现"></a>Controller 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RagController.java</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/rag&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RagService ragService;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RagController</span><span class="hljs-params">(RagService ragService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.ragService = ragService;<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 文档入库</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/ingest&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">ingest</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> IngestRequest request)</span> &#123;<br>        <span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>(request.getContent(), request.getMetadata());<br>        ragService.ingest(doc);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok().build();<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 检索</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/retrieve&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;DocumentVO&gt;&gt; <span class="hljs-title function_">retrieve</span><span class="hljs-params">(</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam</span> String query,</span><br><span class="hljs-params">            <span class="hljs-meta">@RequestParam(defaultValue = &quot;5&quot;)</span> <span class="hljs-type">int</span> topK)</span> &#123;<br>        List&lt;Document&gt; docs = ragService.retrieve(query, topK);<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(DocumentVO.from(docs));<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 问答</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/chat&quot;)</span><br>    <span class="hljs-keyword">public</span> ResponseEntity&lt;ChatResponse&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> ChatRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> ragService.chat(request.getQuestion());<br>        <span class="hljs-keyword">return</span> ResponseEntity.ok(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatResponse</span>(answer));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="DTO-定义"><a href="#DTO-定义" class="headerlink" title="DTO 定义"></a>DTO 定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 请求/响应对象放在 api 模块</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">IngestRequest</span><span class="hljs-params">(String content, Map&lt;String, Object&gt; metadata)</span> &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">ChatRequest</span><span class="hljs-params">(String question)</span> &#123;&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">ChatResponse</span><span class="hljs-params">(String answer)</span> &#123;&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="启动模块设计（rag-server）"><a href="#启动模块设计（rag-server）" class="headerlink" title="启动模块设计（rag-server）"></a>启动模块设计（rag-server）</h3><p>启动模块负责<strong>选择具体实现 + 打包部署</strong>。</p><h4 id="模块-POM-2"><a href="#模块-POM-2" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag-server/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-server<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- API 层（包含 Controller） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 自动配置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- ===== 选择具体实现 ===== --&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 向量存储：选择 PgVector --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 切片方式：选择语义切片 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag-splitter-semantic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- Spring Boot --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 打包成可执行 JAR --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// RagServerApplication.java</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagServerApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(RagServerApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># application.yml</span><br><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><br><span class="hljs-attr">rag:</span><br>  <span class="hljs-attr">store:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">pgvector</span><br>    <span class="hljs-attr">datasource:</span><br>      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:postgresql://localhost:5432/rag</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">secret</span><br>  <span class="hljs-attr">splitter:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">semantic</span><br>    <span class="hljs-attr">chunk-size:</span> <span class="hljs-number">500</span><br>    <span class="hljs-attr">overlap:</span> <span class="hljs-number">50</span><br>  <span class="hljs-attr">embedding:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">openai</span><br>    <span class="hljs-attr">api-key:</span> <span class="hljs-string">$&#123;OPENAI_API_KEY&#125;</span><br></code></pre></td></tr></table></figure><hr><h3 id="多种部署方式"><a href="#多种部署方式" class="headerlink" title="多种部署方式"></a>多种部署方式</h3><p>通过不同的 server 模块，可以灵活组合：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">rag-server-pg/          <span class="hljs-comment"># PgVector + 语义切片</span><br>├── pom.<span class="hljs-keyword">xml</span>             <span class="hljs-title"># 引入 pgvector</span> + semantic<br>└── application.yml<br><br>rag-server-es/          <span class="hljs-comment"># ES + 固定切片</span><br>├── pom.<span class="hljs-keyword">xml</span>             <span class="hljs-title"># 引入 elasticsearch</span> + fixed<br>└── application.yml<br><br>rag-server-all/         <span class="hljs-comment"># 全部实现（通过配置切换）</span><br>├── pom.<span class="hljs-keyword">xml</span>             <span class="hljs-title"># 引入所有实现</span><br><span class="hljs-title">└── application</span>.yml     <span class="hljs-comment"># 配置指定使用哪个</span><br></code></pre></td></tr></table></figure><hr><h3 id="模块职责总结"><a href="#模块职责总结" class="headerlink" title="模块职责总结"></a>模块职责总结</h3><table><thead><tr><th>模块</th><th>职责</th><th>依赖</th></tr></thead><tbody><tr><td><strong>rag-core</strong></td><td>核心接口定义</td><td>无</td></tr><tr><td><strong>rag-store-xxx</strong></td><td>向量存储实现</td><td>core</td></tr><tr><td><strong>rag-splitter-xxx</strong></td><td>切片策略实现</td><td>core</td></tr><tr><td><strong>rag-spring-boot-starter</strong></td><td>自动配置</td><td>core</td></tr><tr><td><strong>rag-service</strong></td><td>业务逻辑，组合组件</td><td>core</td></tr><tr><td><strong>rag-api</strong></td><td>REST Controller</td><td>service</td></tr><tr><td><strong>rag-server</strong></td><td>启动模块，选择实现</td><td>api + starter + 具体实现</td></tr></tbody></table><h3 id="框架使用者-vs-框架开发者"><a href="#框架使用者-vs-框架开发者" class="headerlink" title="框架使用者 vs 框架开发者"></a>框架使用者 vs 框架开发者</h3><table><thead><tr><th>角色</th><th>使用模块</th><th>说明</th></tr></thead><tbody><tr><td><strong>框架使用者</strong></td><td>core + starter + 实现模块</td><td>集成到自己项目</td></tr><tr><td><strong>框架开发者</strong></td><td>全部模块</td><td>开发和维护框架</td></tr><tr><td><strong>独立部署</strong></td><td>server</td><td>直接运行服务</td></tr></tbody></table><hr><h2 id="简化三层结构（推荐）"><a href="#简化三层结构（推荐）" class="headerlink" title="简化三层结构（推荐）"></a>简化三层结构（推荐）</h2><p>对于中小型项目，可以采用更简洁的三层结构：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag4j<span class="hljs-symbol">/</span><br>├── pom.xml                       <span class="hljs-comment"># 父 POM</span><br>├── rag4j-framework<span class="hljs-symbol">/</span>              <span class="hljs-comment"># 框架层 - 核心抽象与通用能力</span><br>├── rag4j-project<span class="hljs-symbol">/</span>                <span class="hljs-comment"># 实现层 - 具体技术实现</span><br>├── rag4j-app<span class="hljs-symbol">/</span>                    <span class="hljs-comment"># 应用层 - Web服务入口</span><br>└── test<span class="hljs-symbol">/</span>                         <span class="hljs-comment"># 测试模块</span><br></code></pre></td></tr></table></figure><h3 id="各层详细结构"><a href="#各层详细结构" class="headerlink" title="各层详细结构"></a>各层详细结构</h3><h4 id="1-框架层（rag4j-framework）"><a href="#1-框架层（rag4j-framework）" class="headerlink" title="1. 框架层（rag4j-framework）"></a>1. 框架层（rag4j-framework）</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag4j-framework<span class="hljs-symbol">/</span><br>├── pom.xml<br>└── src<span class="hljs-operator">/</span>main<span class="hljs-operator">/</span>java<span class="hljs-operator">/</span>com<span class="hljs-operator">/</span>example<span class="hljs-operator">/</span>rag4j<span class="hljs-operator">/</span>framework<span class="hljs-symbol">/</span><br>    │<br>    ├── core<span class="hljs-symbol">/</span>                     <span class="hljs-comment"># 核心接口定义</span><br>    │   ├── VectorStore.java<br>    │   ├── DocumentSplitter.java<br>    │   ├── EmbeddingModel.java<br>    │   └── Document.java<br>    │<br>    ├── store<span class="hljs-symbol">/</span>                    <span class="hljs-comment"># 向量存储抽象</span><br>    │   ├── AbstractVectorStore.java<br>    │   └── VectorStoreConfig.java<br>    │<br>    ├── splitter<span class="hljs-symbol">/</span>                 <span class="hljs-comment"># 切片器抽象</span><br>    │   ├── AbstractSplitter.java<br>    │   └── SplitterConfig.java<br>    │<br>    ├── embedding<span class="hljs-symbol">/</span>                <span class="hljs-comment"># 嵌入模型抽象</span><br>    │   └── AbstractEmbeddingModel.java<br>    │<br>    ├── spi<span class="hljs-symbol">/</span>                      <span class="hljs-comment"># SPI 加载机制</span><br>    │   └── SpiLoader.java<br>    │<br>    └── util<span class="hljs-symbol">/</span>                     <span class="hljs-comment"># 通用工具</span><br>        ├── RetryUtil.java<br>        └── BatchUtil.java<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：纯抽象，无第三方依赖（或最小依赖）</p><h4 id="2-实现层（rag4j-project）"><a href="#2-实现层（rag4j-project）" class="headerlink" title="2. 实现层（rag4j-project）"></a>2. 实现层（rag4j-project）</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag4j-project<span class="hljs-symbol">/</span><br>├── pom.xml                       <span class="hljs-comment"># 聚合模块</span><br>│<br>├── rag4j-store-pgvector<span class="hljs-symbol">/</span>         <span class="hljs-comment"># PgVector 实现</span><br>│   ├── pom.xml<br>│   └── src<span class="hljs-symbol">/.../PgVectorStore.java</span><br>│<br>├── rag4j-store-elasticsearch<span class="hljs-symbol">/</span>    <span class="hljs-comment"># ES 实现</span><br>│   └── ...<br>│<br>├── rag4j-store-neo4j<span class="hljs-symbol">/</span>            <span class="hljs-comment"># Neo4j 实现</span><br>│   └── ...<br>│<br>├── rag4j-splitter-fixed<span class="hljs-symbol">/</span>         <span class="hljs-comment"># 固定切片</span><br>│   └── ...<br>│<br>├── rag4j-splitter-semantic<span class="hljs-symbol">/</span>      <span class="hljs-comment"># 语义切片</span><br>│   └── ...<br>│<br>├── rag4j-embedding-openai<span class="hljs-symbol">/</span>       <span class="hljs-comment"># OpenAI 嵌入</span><br>│   └── ...<br>│<br>└── rag4j-spring-boot-starter<span class="hljs-symbol">/</span>    <span class="hljs-comment"># Spring Boot 自动配置</span><br>    └── ...<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：每个实现独立模块，按需引入</p><h4 id="3-应用层（rag4j-app）"><a href="#3-应用层（rag4j-app）" class="headerlink" title="3. 应用层（rag4j-app）"></a>3. 应用层（rag4j-app）</h4><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nix">rag4j-app<span class="hljs-symbol">/</span><br>├── pom.xml<br>└── src<span class="hljs-operator">/</span>main<span class="hljs-symbol">/</span><br>    ├── java<span class="hljs-operator">/</span>com<span class="hljs-operator">/</span>example<span class="hljs-operator">/</span>rag4j<span class="hljs-operator">/</span>app<span class="hljs-symbol">/</span><br>    │   ├── Rag4jApplication.java     <span class="hljs-comment"># 启动类</span><br>    │   ├── config<span class="hljs-symbol">/</span>                   <span class="hljs-comment"># 配置类</span><br>    │   │   └── Rag4jConfig.java<br>    │   ├── service<span class="hljs-symbol">/</span>                  <span class="hljs-comment"># 业务服务</span><br>    │   │   └── RagService.java<br>    │   ├── controller<span class="hljs-symbol">/</span>               <span class="hljs-comment"># REST API</span><br>    │   │   └── RagController.java<br>    │   └── dto<span class="hljs-symbol">/</span>                      <span class="hljs-comment"># 请求/响应对象</span><br>    │       ├── ChatRequest.java<br>    │       └── ChatResponse.java<br>    └── resources<span class="hljs-symbol">/</span><br>        └── application.yml<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：组合框架层和实现层，对外提供服务</p><hr><h3 id="依赖关系-2"><a href="#依赖关系-2" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arduino">┌─────────────────────────────────────────────────────────────┐<br>│                      rag4j-app                               │<br>│            (Controller + Service + 启动配置)                  │<br>│                                                              │<br>│   依赖: framework + 选择的实现模块 + starter                   │<br>└─────────────────────────────────────────────────────────────┘<br>                              │<br>          ┌───────────────────┼───────────────────┐<br>          ▼                   ▼                   ▼<br>┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐<br>│ rag4j-store-pg  │ │rag4j-splitter-  │ │ rag4j-embedding │<br>│                 │ │   semantic      │ │    -openai      │<br>└─────────────────┘ └─────────────────┘ └─────────────────┘<br>          │                   │                   │<br>          └───────────────────┼───────────────────┘<br>                              ▼<br>              ┌───────────────────────────┐<br>              │      rag4j-framework      │<br>              │   (接口 + 抽象类 + <span class="hljs-built_in">SPI</span>)    │<br>              └───────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h3 id="POM-配置示例"><a href="#POM-配置示例" class="headerlink" title="POM 配置示例"></a>POM 配置示例</h3><h4 id="父-POM"><a href="#父-POM" class="headerlink" title="父 POM"></a>父 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag4j/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag4j-framework<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag4j-project<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>rag4j-app<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 内部模块版本管理 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;project.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 其他模块... --&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h4 id="应用层-POM"><a href="#应用层-POM" class="headerlink" title="应用层 POM"></a>应用层 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- rag4j-app/pom.xml --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-app<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 框架层 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-framework<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 选择具体实现 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-store-pgvector<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-splitter-semantic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-embedding-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 自动配置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rag4j-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- Spring Boot --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><hr><h3 id="两种结构对比"><a href="#两种结构对比" class="headerlink" title="两种结构对比"></a>两种结构对比</h3><table><thead><tr><th>对比项</th><th>细粒度结构</th><th>三层简化结构</th></tr></thead><tbody><tr><td><strong>模块数量</strong></td><td>多（10+）</td><td>少（3-4 + 实现）</td></tr><tr><td><strong>适用规模</strong></td><td>大型框架</td><td>中小型项目</td></tr><tr><td><strong>灵活性</strong></td><td>高</td><td>适中</td></tr><tr><td><strong>维护成本</strong></td><td>高</td><td>低</td></tr><tr><td><strong>学习曲线</strong></td><td>陡</td><td>平缓</td></tr><tr><td><strong>典型案例</strong></td><td>Spring Framework</td><td>业务系统</td></tr></tbody></table><p><strong>建议</strong>：</p><ul><li><strong>对外发布的框架</strong> → 细粒度结构，方便用户按需引入</li><li><strong>内部项目&#x2F;业务系统</strong> → 三层简化结构，开发效率高</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Maven</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Maven</tag>
      
      <tag>多模块</tag>
      
      <tag>项目架构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>属性数据结构遍历详解</title>
    <link href="/2026/01/12/%E5%B1%9E%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%81%8D%E5%8E%86%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/12/%E5%B1%9E%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%81%8D%E5%8E%86%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="属性数据结构遍历详解"><a href="#属性数据结构遍历详解" class="headerlink" title="属性数据结构遍历详解"></a>属性数据结构遍历详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>属性数据结构</strong> 是指具有特定属性或特征的数据结构，如有序性、层级性、连通性等。遍历是访问数据结构中所有元素的基本操作，不同的数据结构有不同的遍历策略。</p><blockquote><p><strong>💡 提示: 核心思想</strong><br>遍历的本质是：<strong>按照数据结构的特性，用合适的方式访问每个元素一次，且仅一次</strong>。</p></blockquote><hr><h2 id="一、数组遍历"><a href="#一、数组遍历" class="headerlink" title="一、数组遍历"></a>一、数组遍历</h2><h3 id="1-1-基本特性"><a href="#1-1-基本特性" class="headerlink" title="1.1 基本特性"></a>1.1 基本特性</h3><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>存储方式</strong></td><td>连续内存，随机访问</td></tr><tr><td><strong>访问复杂度</strong></td><td>O(1)</td></tr><tr><td><strong>遍历复杂度</strong></td><td>O(n)</td></tr><tr><td><strong>属性</strong></td><td>有序、固定大小、可重复</td></tr></tbody></table><h3 id="1-2-遍历思路"><a href="#1-2-遍历思路" class="headerlink" title="1.2 遍历思路"></a>1.2 遍历思路</h3><p>数组遍历的核心思路是<strong>线性扫描</strong>：从第一个元素开始，依次访问每个元素，直到最后一个元素。</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs markdown">思路流程：<br><span class="hljs-bullet">1.</span> 初始化指针/索引 i = 0<br><span class="hljs-bullet">2.</span> 检查 i &lt; 数组长度<br><span class="hljs-bullet">3.</span> 访问 array[i]<br><span class="hljs-bullet">4.</span> i++<br><span class="hljs-bullet">5.</span> 回到步骤2<br></code></pre></td></tr></table></figure><h3 id="1-3-实现方式"><a href="#1-3-实现方式" class="headerlink" title="1.3 实现方式"></a>1.3 实现方式</h3><h4 id="方式1：传统-for-循环（最直接）"><a href="#方式1：传统-for-循环（最直接）" class="headerlink" title="方式1：传统 for 循环（最直接）"></a>方式1：传统 for 循环（最直接）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要索引值，需要提前知道数组大小</span><br><span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>    System.out.println(arr[i]);  <span class="hljs-comment">// 访问元素</span><br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>显式控制索引，可以随意访问任何位置</li><li>适合需要索引的场景（如修改元素、计算位置等）</li></ul><h4 id="方式2：增强-for-循环（简洁）"><a href="#方式2：增强-for-循环（简洁）" class="headerlink" title="方式2：增强 for 循环（简洁）"></a>方式2：增强 for 循环（简洁）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：只需要元素值，不需要索引</span><br><span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : arr) &#123;<br>    System.out.println(num);  <span class="hljs-comment">// 访问元素</span><br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>隐藏索引细节，代码更简洁</li><li>本质上还是顺序访问</li><li>不能修改数组元素（对基本类型）</li></ul><h4 id="方式3：迭代器遍历（通用）"><a href="#方式3：迭代器遍历（通用）" class="headerlink" title="方式3：迭代器遍历（通用）"></a>方式3：迭代器遍历（通用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要在遍历中删除元素</span><br>List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);<br><br>Iterator&lt;Integer&gt; iterator = list.iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    <span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> iterator.next();<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-number">3</span>) &#123;<br>        iterator.remove();  <span class="hljs-comment">// 安全删除</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>迭代器维护遍历状态</li><li>支持在遍历中安全删除</li><li>适合集合框架</li></ul><h4 id="方式4：流式遍历（函数式）"><a href="#方式4：流式遍历（函数式）" class="headerlink" title="方式4：流式遍历（函数式）"></a>方式4：流式遍历（函数式）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要函数式编程风格</span><br><span class="hljs-type">int</span>[] arr = &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>&#125;;<br><br>Arrays.stream(arr)<br>    .forEach(System.out::println);<br><br><span class="hljs-comment">// 或者带索引</span><br>IntStream.range(<span class="hljs-number">0</span>, arr.length)<br>    .forEach(i -&gt; System.out.println(arr[i]));<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>声明式编程，表达意图清晰</li><li>支持链式操作和函数组合</li><li>可能有额外开销</li></ul><h3 id="1-4-二维数组遍历"><a href="#1-4-二维数组遍历" class="headerlink" title="1.4 二维数组遍历"></a>1.4 二维数组遍历</h3><h4 id="按行遍历（最常用）"><a href="#按行遍历（最常用）" class="headerlink" title="按行遍历（最常用）"></a>按行遍历（最常用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span>[][] matrix = &#123;<br>    &#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;,<br>    &#123;<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>&#125;,<br>    &#123;<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>&#125;<br>&#125;;<br><br><span class="hljs-comment">// 思路：外层循环遍历行，内层循环遍历列</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; matrix.length; i++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; matrix[i].length; j++) &#123;<br>        System.out.println(matrix[i][j]);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 访问顺序：1 2 3 4 5 6 7 8 9</span><br><span class="hljs-comment">// 时间复杂度：O(m*n)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>外层控制行，内层控制列</li><li>按行优先顺序访问（cache 友好）</li><li>适合大多数矩阵操作</li></ul><h4 id="按列遍历"><a href="#按列遍历" class="headerlink" title="按列遍历"></a>按列遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 思路：外层循环遍历列，内层循环遍历行</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; matrix[<span class="hljs-number">0</span>].length; j++) &#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; matrix.length; i++) &#123;<br>        System.out.println(matrix[i][j]);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 访问顺序：1 4 7 2 5 8 3 6 9</span><br><span class="hljs-comment">// 时间复杂度：O(m*n)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>适合需要按列处理的场景</li><li>可能导致 cache miss（不如按行遍历高效）</li></ul><h4 id="对角线遍历"><a href="#对角线遍历" class="headerlink" title="对角线遍历"></a>对角线遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 思路：按对角线方向遍历</span><br><span class="hljs-comment">// 第一条对角线：(0,0)</span><br><span class="hljs-comment">// 第二条对角线：(0,1), (1,0)</span><br><span class="hljs-comment">// 第三条对角线：(0,2), (1,1), (2,0)</span><br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">diag</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; diag &lt; matrix.length + matrix[<span class="hljs-number">0</span>].length - <span class="hljs-number">1</span>; diag++) &#123;<br>    <span class="hljs-comment">// 对于第 diag 条对角线</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">startRow</span> <span class="hljs-operator">=</span> Math.max(<span class="hljs-number">0</span>, diag - matrix[<span class="hljs-number">0</span>].length + <span class="hljs-number">1</span>);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">endRow</span> <span class="hljs-operator">=</span> Math.min(diag, matrix.length - <span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startRow; i &lt;= endRow; i++) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> diag - i;<br>        System.out.println(matrix[i][j]);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 访问顺序：1 2 4 3 5 7 6 8 9</span><br><span class="hljs-comment">// 时间复杂度：O(m*n)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>对角线编号：i + j &#x3D; diag</li><li>需要计算每条对角线的起点和终点</li><li>适合特定的矩阵问题</li></ul><h3 id="1-5-遍历变种"><a href="#1-5-遍历变种" class="headerlink" title="1.5 遍历变种"></a>1.5 遍历变种</h3><h4 id="反向遍历"><a href="#反向遍历" class="headerlink" title="反向遍历"></a>反向遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 从后往前遍历</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> arr.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>    System.out.println(arr[i]);<br>&#125;<br><br><span class="hljs-comment">// 适用场景：</span><br><span class="hljs-comment">// 1. 需要从后往前处理</span><br><span class="hljs-comment">// 2. 删除元素时避免索引混乱</span><br></code></pre></td></tr></table></figure><h4 id="跳跃遍历"><a href="#跳跃遍历" class="headerlink" title="跳跃遍历"></a>跳跃遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 每隔 k 个元素访问一个</span><br><span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i += k) &#123;<br>    System.out.println(arr[i]);<br>&#125;<br><br><span class="hljs-comment">// 适用场景：</span><br><span class="hljs-comment">// 1. 采样</span><br><span class="hljs-comment">// 2. 步长遍历</span><br></code></pre></td></tr></table></figure><h4 id="条件遍历"><a href="#条件遍历" class="headerlink" title="条件遍历"></a>条件遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 只遍历满足条件的元素</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>    <span class="hljs-keyword">if</span> (arr[i] &gt; <span class="hljs-number">5</span>) &#123;<br>        System.out.println(arr[i]);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 或使用流</span><br>Arrays.stream(arr)<br>    .filter(x -&gt; x &gt; <span class="hljs-number">5</span>)<br>    .forEach(System.out::println);<br></code></pre></td></tr></table></figure><hr><h2 id="二、链表遍历"><a href="#二、链表遍历" class="headerlink" title="二、链表遍历"></a>二、链表遍历</h2><h3 id="2-1-基本特性"><a href="#2-1-基本特性" class="headerlink" title="2.1 基本特性"></a>2.1 基本特性</h3><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>存储方式</strong></td><td>离散内存，通过指针连接</td></tr><tr><td><strong>访问复杂度</strong></td><td>O(n)</td></tr><tr><td><strong>遍历复杂度</strong></td><td>O(n)</td></tr><tr><td><strong>属性</strong></td><td>有序、动态大小、可重复</td></tr></tbody></table><h3 id="2-2-链表节点定义"><a href="#2-2-链表节点定义" class="headerlink" title="2.2 链表节点定义"></a>2.2 链表节点定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> &#123;<br>    <span class="hljs-type">int</span> val;           <span class="hljs-comment">// 数据</span><br>    ListNode next;     <span class="hljs-comment">// 指向下一个节点</span><br>    <br>    ListNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>        <span class="hljs-built_in">this</span>.next = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-遍历思路"><a href="#2-3-遍历思路" class="headerlink" title="2.3 遍历思路"></a>2.3 遍历思路</h3><p>链表遍历的核心思路是<strong>指针跟踪</strong>：从头节点开始，通过 next 指针逐个访问每个节点。</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">思路流程：<br><span class="hljs-number">1.</span> 初始化指针 <span class="hljs-keyword">current</span> = head<br><span class="hljs-number">2.</span> 检查 <span class="hljs-keyword">current</span> != <span class="hljs-keyword">null</span><br><span class="hljs-number">3.</span> 访问 <span class="hljs-keyword">current</span>.val<br><span class="hljs-number">4.</span> <span class="hljs-keyword">current</span> = <span class="hljs-keyword">current</span>.next<br><span class="hljs-number">5.</span> 回到步骤<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><h3 id="2-4-实现方式"><a href="#2-4-实现方式" class="headerlink" title="2.4 实现方式"></a>2.4 实现方式</h3><h4 id="方式1：while-循环（最常用）"><a href="#方式1：while-循环（最常用）" class="headerlink" title="方式1：while 循环（最常用）"></a>方式1：while 循环（最常用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要逐个访问节点</span><br><span class="hljs-type">ListNode</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">1</span>);<br>head.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">2</span>);<br>head.next.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">3</span>);<br><br><span class="hljs-type">ListNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>    System.out.println(current.val);  <span class="hljs-comment">// 访问节点</span><br>    current = current.next;            <span class="hljs-comment">// 移动指针</span><br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>最直接的遍历方式</li><li>通过 null 检查确定遍历结束</li><li>不修改链表结构</li></ul><h4 id="方式2：递归遍历"><a href="#方式2：递归遍历" class="headerlink" title="方式2：递归遍历"></a>方式2：递归遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要递归处理或反向遍历</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(ListNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 递归终止条件</span><br>    &#125;<br>    <br>    System.out.println(node.val);      <span class="hljs-comment">// 前序处理</span><br>    traverse(node.next);               <span class="hljs-comment">// 递归访问下一个</span><br>&#125;<br><br><span class="hljs-comment">// 调用</span><br>traverse(head);<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(n)（递归栈）</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>递归天然适合链表结构</li><li>空间复杂度较高（栈深度）</li><li>适合需要反向处理的场景</li></ul><h4 id="方式3：反向遍历（递归）"><a href="#方式3：反向遍历（递归）" class="headerlink" title="方式3：反向遍历（递归）"></a>方式3：反向遍历（递归）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要从后往前访问</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">reverseTraverse</span><span class="hljs-params">(ListNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    reverseTraverse(node.next);        <span class="hljs-comment">// 先递归到末尾</span><br>    System.out.println(node.val);      <span class="hljs-comment">// 后序处理（反向）</span><br>&#125;<br><br><span class="hljs-comment">// 调用</span><br>reverseTraverse(head);<br><br><span class="hljs-comment">// 输出顺序：3 2 1（如果链表是 1-&gt;2-&gt;3）</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>利用递归栈实现反向遍历</li><li>不需要额外的反向链表</li><li>空间复杂度 O(n)</li></ul><h4 id="方式4：快慢指针遍历"><a href="#方式4：快慢指针遍历" class="headerlink" title="方式4：快慢指针遍历"></a>方式4：快慢指针遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：需要找到中点、检测环等</span><br><span class="hljs-type">ListNode</span> <span class="hljs-variable">slow</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-type">ListNode</span> <span class="hljs-variable">fast</span> <span class="hljs-operator">=</span> head;<br><br><span class="hljs-comment">// 思路：slow 每次走一步，fast 每次走两步</span><br><span class="hljs-keyword">while</span> (fast != <span class="hljs-literal">null</span> &amp;&amp; fast.next != <span class="hljs-literal">null</span>) &#123;<br>    slow = slow.next;<br>    fast = fast.next.next;<br>&#125;<br><br><span class="hljs-comment">// slow 现在指向中点</span><br>System.out.println(<span class="hljs-string">&quot;中点值：&quot;</span> + slow.val);<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>快指针速度是慢指针的两倍</li><li>当快指针到达末尾时，慢指针在中点</li><li>适合检测环、找中点等</li></ul><h4 id="方式5：迭代器遍历"><a href="#方式5：迭代器遍历" class="headerlink" title="方式5：迭代器遍历"></a>方式5：迭代器遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：使用集合框架</span><br>List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>list.add(<span class="hljs-number">1</span>);<br>list.add(<span class="hljs-number">2</span>);<br>list.add(<span class="hljs-number">3</span>);<br><br>Iterator&lt;Integer&gt; iterator = list.iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    System.out.println(iterator.next());<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>隐藏指针细节</li><li>支持在遍历中删除</li><li>更安全的遍历方式</li></ul><h3 id="2-5-双向链表遍历"><a href="#2-5-双向链表遍历" class="headerlink" title="2.5 双向链表遍历"></a>2.5 双向链表遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DoublyListNode</span> &#123;<br>    <span class="hljs-type">int</span> val;<br>    DoublyListNode prev;  <span class="hljs-comment">// 前驱指针</span><br>    DoublyListNode next;  <span class="hljs-comment">// 后继指针</span><br>    <br>    DoublyListNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 正向遍历</span><br><span class="hljs-type">DoublyListNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>    System.out.println(current.val);<br>    current = current.next;<br>&#125;<br><br><span class="hljs-comment">// 反向遍历（利用 prev 指针）</span><br>current = tail;<br><span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>    System.out.println(current.val);<br>    current = current.prev;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>双向链表支持双向遍历</li><li>反向遍历不需要递归</li><li>适合需要双向访问的场景</li></ul><hr><h2 id="三、树的遍历"><a href="#三、树的遍历" class="headerlink" title="三、树的遍历"></a>三、树的遍历</h2><h3 id="3-1-基本特性"><a href="#3-1-基本特性" class="headerlink" title="3.1 基本特性"></a>3.1 基本特性</h3><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>存储方式</strong></td><td>层级结构，父子关系</td></tr><tr><td><strong>访问复杂度</strong></td><td>O(n)</td></tr><tr><td><strong>遍历复杂度</strong></td><td>O(n)</td></tr><tr><td><strong>属性</strong></td><td>有序、非线性、无环</td></tr></tbody></table><h3 id="3-2-树节点定义"><a href="#3-2-树节点定义" class="headerlink" title="3.2 树节点定义"></a>3.2 树节点定义</h3><h4 id="二叉树节点"><a href="#二叉树节点" class="headerlink" title="二叉树节点"></a>二叉树节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span> &#123;<br>    <span class="hljs-type">int</span> val;              <span class="hljs-comment">// 数据</span><br>    TreeNode left;        <span class="hljs-comment">// 左子树</span><br>    TreeNode right;       <span class="hljs-comment">// 右子树</span><br>    <br>    TreeNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>        <span class="hljs-built_in">this</span>.left = <span class="hljs-literal">null</span>;<br>        <span class="hljs-built_in">this</span>.right = <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="多叉树节点"><a href="#多叉树节点" class="headerlink" title="多叉树节点"></a>多叉树节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NaryTreeNode</span> &#123;<br>    <span class="hljs-type">int</span> val;                          <span class="hljs-comment">// 数据</span><br>    List&lt;NaryTreeNode&gt; children;      <span class="hljs-comment">// 子节点列表</span><br>    <br>    NaryTreeNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>        <span class="hljs-built_in">this</span>.children = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>每个节点可以有任意数量的子节点</li><li>适合表示文件系统、组织结构等</li><li>遍历逻辑更通用</li></ul><h3 id="3-3-深度优先遍历（DFS）"><a href="#3-3-深度优先遍历（DFS）" class="headerlink" title="3.3 深度优先遍历（DFS）"></a>3.3 深度优先遍历（DFS）</h3><h4 id="前序遍历（Pre-order）"><a href="#前序遍历（Pre-order）" class="headerlink" title="前序遍历（Pre-order）"></a>前序遍历（Pre-order）</h4><p><strong>遍历顺序</strong>：根 → 左子树 → 右子树</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">思路流程：<br><span class="hljs-bullet">1.</span> 访问当前节点<br><span class="hljs-bullet">2.</span> 递归遍历左子树<br><span class="hljs-bullet">3.</span> 递归遍历右子树<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    System.out.println(node.val);      <span class="hljs-comment">// 1. 访问根</span><br>    preorder(node.left);               <span class="hljs-comment">// 2. 遍历左子树</span><br>    preorder(node.right);              <span class="hljs-comment">// 3. 遍历右子树</span><br>&#125;<br><br><span class="hljs-comment">// 示例树：</span><br><span class="hljs-comment">//       1</span><br><span class="hljs-comment">//      / \</span><br><span class="hljs-comment">//     2   3</span><br><span class="hljs-comment">// 输出：1 2 3</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>最先访问根节点</li><li>适合需要先处理父节点的场景</li><li>如：复制树、序列化树</li></ul><p><strong>迭代实现</strong>（使用栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorderIterative</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    stack.push(root);<br>    <br>    <span class="hljs-keyword">while</span> (!stack.isEmpty()) &#123;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack.pop();<br>        System.out.println(node.val);<br>        <br>        <span class="hljs-comment">// 注意：先压右子树，后压左子树</span><br>        <span class="hljs-comment">// 这样弹出时左子树先出</span><br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node.right);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node.left);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(h)，h 是树的高度</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>栈模拟递归调用</li><li>压栈顺序很关键（右先压，左后压）</li><li>避免递归栈溢出</li></ul><h4 id="中序遍历（In-order）"><a href="#中序遍历（In-order）" class="headerlink" title="中序遍历（In-order）"></a>中序遍历（In-order）</h4><p><strong>遍历顺序</strong>：左子树 → 根 → 右子树</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">思路流程：<br><span class="hljs-bullet">1.</span> 递归遍历左子树<br><span class="hljs-bullet">2.</span> 访问当前节点<br><span class="hljs-bullet">3.</span> 递归遍历右子树<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">inorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    inorder(node.left);                <span class="hljs-comment">// 1. 遍历左子树</span><br>    System.out.println(node.val);      <span class="hljs-comment">// 2. 访问根</span><br>    inorder(node.right);               <span class="hljs-comment">// 3. 遍历右子树</span><br>&#125;<br><br><span class="hljs-comment">// 示例树：</span><br><span class="hljs-comment">//       2</span><br><span class="hljs-comment">//      / \</span><br><span class="hljs-comment">//     1   3</span><br><span class="hljs-comment">// 输出：1 2 3</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>对于二叉搜索树，中序遍历得到有序序列</li><li>适合需要有序处理的场景</li><li>最常用的遍历方式</li></ul><p><strong>迭代实现</strong>（使用栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">inorderIterative</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    <span class="hljs-type">TreeNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> root;<br>    <br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span> || !stack.isEmpty()) &#123;<br>        <span class="hljs-comment">// 1. 一直向左走，压栈所有左节点</span><br>        <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(current);<br>            current = current.left;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 2. 左子树遍历完，弹出栈顶（根）</span><br>        current = stack.pop();<br>        System.out.println(current.val);<br>        <br>        <span class="hljs-comment">// 3. 遍历右子树</span><br>        current = current.right;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(h)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>关键：先一直向左，直到 null</li><li>然后处理栈顶，再向右</li><li>比前序遍历更复杂</li></ul><h4 id="后序遍历（Post-order）"><a href="#后序遍历（Post-order）" class="headerlink" title="后序遍历（Post-order）"></a>后序遍历（Post-order）</h4><p><strong>遍历顺序</strong>：左子树 → 右子树 → 根</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown">思路流程：<br><span class="hljs-bullet">1.</span> 递归遍历左子树<br><span class="hljs-bullet">2.</span> 递归遍历右子树<br><span class="hljs-bullet">3.</span> 访问当前节点<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">postorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    postorder(node.left);              <span class="hljs-comment">// 1. 遍历左子树</span><br>    postorder(node.right);             <span class="hljs-comment">// 2. 遍历右子树</span><br>    System.out.println(node.val);      <span class="hljs-comment">// 3. 访问根</span><br>&#125;<br><br><span class="hljs-comment">// 示例树：</span><br><span class="hljs-comment">//       3</span><br><span class="hljs-comment">//      / \</span><br><span class="hljs-comment">//     1   2</span><br><span class="hljs-comment">// 输出：1 2 3</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>最后访问根节点</li><li>适合需要先处理子节点的场景</li><li>如：删除树、计算树的高度</li></ul><p><strong>迭代实现</strong>（使用两个栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">postorderIterative</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Stack&lt;TreeNode&gt; stack1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    Stack&lt;TreeNode&gt; stack2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    <br>    stack1.push(root);<br>    <br>    <span class="hljs-comment">// 第一次遍历：根 → 右 → 左（反向的后序）</span><br>    <span class="hljs-keyword">while</span> (!stack1.isEmpty()) &#123;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack1.pop();<br>        stack2.push(node);<br>        <br>        <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) &#123;<br>            stack1.push(node.left);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) &#123;<br>            stack1.push(node.right);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 第二次遍历：弹出 stack2（得到正确的后序）</span><br>    <span class="hljs-keyword">while</span> (!stack2.isEmpty()) &#123;<br>        System.out.println(stack2.pop().val);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(n)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>使用两个栈实现</li><li>第一个栈生成反向后序</li><li>第二个栈反转得到正确顺序</li></ul><h3 id="3-4-多叉树遍历"><a href="#3-4-多叉树遍历" class="headerlink" title="3.4 多叉树遍历"></a>3.4 多叉树遍历</h3><h4 id="多叉树前序遍历"><a href="#多叉树前序遍历" class="headerlink" title="多叉树前序遍历"></a>多叉树前序遍历</h4><p><strong>遍历顺序</strong>：根 → 所有子节点</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorderNary</span><span class="hljs-params">(NaryTreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    System.out.println(node.val);      <span class="hljs-comment">// 1. 访问根</span><br>    <br>    <span class="hljs-comment">// 2. 遍历所有子节点</span><br>    <span class="hljs-keyword">for</span> (NaryTreeNode child : node.children) &#123;<br>        preorderNary(child);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 示例树：</span><br><span class="hljs-comment">//         1</span><br><span class="hljs-comment">//      /  |  \</span><br><span class="hljs-comment">//     2   3   4</span><br><span class="hljs-comment">//    / \</span><br><span class="hljs-comment">//   5   6</span><br><span class="hljs-comment">// 输出：1 2 5 6 3 4</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>与二叉树前序类似，先访问根</li><li>遍历所有子节点而不是只有左右</li><li>时间复杂度 O(n)，空间复杂度 O(h)</li></ul><p><strong>迭代实现</strong>（使用栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorderNaryIterative</span><span class="hljs-params">(NaryTreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Stack&lt;NaryTreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    stack.push(root);<br>    <br>    <span class="hljs-keyword">while</span> (!stack.isEmpty()) &#123;<br>        <span class="hljs-type">NaryTreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack.pop();<br>        System.out.println(node.val);<br>        <br>        <span class="hljs-comment">// 关键：反向压栈子节点，保证正确的访问顺序</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> node.children.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>            stack.push(node.children.get(i));<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(h)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>反向压栈是关键（从最后一个子节点开始）</li><li>这样弹出时，第一个子节点先出</li><li>保证了正确的前序遍历顺序</li></ul><h4 id="多叉树后序遍历"><a href="#多叉树后序遍历" class="headerlink" title="多叉树后序遍历"></a>多叉树后序遍历</h4><p><strong>遍历顺序</strong>：所有子节点 → 根</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">postorderNary</span><span class="hljs-params">(NaryTreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// 1. 遍历所有子节点</span><br>    <span class="hljs-keyword">for</span> (NaryTreeNode child : node.children) &#123;<br>        postorderNary(child);<br>    &#125;<br>    <br>    System.out.println(node.val);      <span class="hljs-comment">// 2. 访问根</span><br>&#125;<br><br><span class="hljs-comment">// 示例树同上</span><br><span class="hljs-comment">// 输出：5 6 2 3 4 1</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>先处理所有子节点，最后处理根</li><li>适合需要先处理子树的场景（如删除树）</li><li>时间复杂度 O(n)，空间复杂度 O(h)</li></ul><p><strong>迭代实现</strong>（使用两个栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">postorderNaryIterative</span><span class="hljs-params">(NaryTreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Stack&lt;NaryTreeNode&gt; stack1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    Stack&lt;NaryTreeNode&gt; stack2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    <br>    stack1.push(root);<br>    <br>    <span class="hljs-comment">// 第一次遍历：生成反向的后序</span><br>    <span class="hljs-keyword">while</span> (!stack1.isEmpty()) &#123;<br>        <span class="hljs-type">NaryTreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack1.pop();<br>        stack2.push(node);<br>        <br>        <span class="hljs-comment">// 正向压栈子节点</span><br>        <span class="hljs-keyword">for</span> (NaryTreeNode child : node.children) &#123;<br>            stack1.push(child);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 第二次遍历：弹出 stack2</span><br>    <span class="hljs-keyword">while</span> (!stack2.isEmpty()) &#123;<br>        System.out.println(stack2.pop().val);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(n)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>与二叉树后序类似，使用两个栈</li><li>第一个栈生成反向后序</li><li>第二个栈反转得到正确顺序</li></ul><h4 id="多叉树层序遍历"><a href="#多叉树层序遍历" class="headerlink" title="多叉树层序遍历"></a>多叉树层序遍历</h4><p><strong>遍历顺序</strong>：按层从上到下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">levelorderNary</span><span class="hljs-params">(NaryTreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Queue&lt;NaryTreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    queue.add(root);<br>    <br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        <span class="hljs-type">NaryTreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();<br>        System.out.println(node.val);<br>        <br>        <span class="hljs-comment">// 将所有子节点加入队列</span><br>        <span class="hljs-keyword">for</span> (NaryTreeNode child : node.children) &#123;<br>            queue.add(child);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 输出：1 2 3 4 5 6</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>队列保证层序访问</li><li>遍历所有子节点而不是只有左右</li><li>时间复杂度 O(n)，空间复杂度 O(w)</li></ul><h4 id="分层遍历（返回每层的列表）"><a href="#分层遍历（返回每层的列表）" class="headerlink" title="分层遍历（返回每层的列表）"></a>分层遍历（返回每层的列表）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">levelorderNaryList</span><span class="hljs-params">(NaryTreeNode root)</span> &#123;<br>    List&lt;List&lt;Integer&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> result;<br>    <br>    Queue&lt;NaryTreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    queue.add(root);<br>    <br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">levelSize</span> <span class="hljs-operator">=</span> queue.size();  <span class="hljs-comment">// 记录当前层的节点数</span><br>        List&lt;Integer&gt; currentLevel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-comment">// 处理当前层的所有节点</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; levelSize; i++) &#123;<br>            <span class="hljs-type">NaryTreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();<br>            currentLevel.add(node.val);<br>            <br>            <span class="hljs-comment">// 将所有子节点加入队列</span><br>            <span class="hljs-keyword">for</span> (NaryTreeNode child : node.children) &#123;<br>                queue.add(child);<br>            &#125;<br>        &#125;<br>        <br>        result.add(currentLevel);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// 输出：[[1], [2, 3, 4], [5, 6]]</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>关键：记录每层的节点数</li><li>在处理当前层时，只处理 levelSize 个节点</li><li>这样可以清晰地分离各层</li></ul><h3 id="3-5-多叉树-vs-二叉树对比"><a href="#3-5-多叉树-vs-二叉树对比" class="headerlink" title="3.5 多叉树 vs 二叉树对比"></a>3.5 多叉树 vs 二叉树对比</h3><table><thead><tr><th>维度</th><th>二叉树</th><th>多叉树</th></tr></thead><tbody><tr><td><strong>子节点数</strong></td><td>最多 2 个</td><td>任意个</td></tr><tr><td><strong>前序遍历</strong></td><td>根→左→右</td><td>根→所有子</td></tr><tr><td><strong>后序遍历</strong></td><td>左→右→根</td><td>所有子→根</td></tr><tr><td><strong>中序遍历</strong></td><td>左→根→右</td><td>不适用</td></tr><tr><td><strong>适用场景</strong></td><td>搜索树、堆</td><td>文件系统、组织结构</td></tr><tr><td><strong>实现复杂度</strong></td><td>简单</td><td>稍复杂（循环遍历子节点）</td></tr></tbody></table><hr><h3 id="3-6-广度优先遍历（BFS）"><a href="#3-6-广度优先遍历（BFS）" class="headerlink" title="3.6 广度优先遍历（BFS）"></a>3.6 广度优先遍历（BFS）</h3><h4 id="层序遍历（Level-order）"><a href="#层序遍历（Level-order）" class="headerlink" title="层序遍历（Level-order）"></a>层序遍历（Level-order）</h4><p><strong>遍历顺序</strong>：按层从上到下，同层从左到右</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs css">思路流程：<br><span class="hljs-number">1</span>. 初始化队列，放入根节点<br><span class="hljs-number">2</span>. 队列不为空时：<br>   <span class="hljs-selector-tag">a</span>. 弹出队列前端节点<br>   <span class="hljs-selector-tag">b</span>. 访问该节点<br>   c. 将其子节点加入队列<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 使用队列实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">levelorder</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Queue&lt;TreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    queue.add(root);<br>    <br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();<br>        System.out.println(node.val);<br>        <br>        <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) &#123;<br>            queue.add(node.left);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) &#123;<br>            queue.add(node.right);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 示例树：</span><br><span class="hljs-comment">//       1</span><br><span class="hljs-comment">//      / \</span><br><span class="hljs-comment">//     2   3</span><br><span class="hljs-comment">//    / \</span><br><span class="hljs-comment">//   4   5</span><br><span class="hljs-comment">// 输出：1 2 3 4 5</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>队列保证了层序访问</li><li>先进先出的特性很关键</li><li>适合需要按层处理的场景</li></ul><h4 id="分层遍历（返回每层的列表）-1"><a href="#分层遍历（返回每层的列表）-1" class="headerlink" title="分层遍历（返回每层的列表）"></a>分层遍历（返回每层的列表）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;List&lt;Integer&gt;&gt; <span class="hljs-title function_">levelOrderList</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    List&lt;List&lt;Integer&gt;&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> result;<br>    <br>    Queue&lt;TreeNode&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    queue.add(root);<br>    <br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">levelSize</span> <span class="hljs-operator">=</span> queue.size();  <span class="hljs-comment">// 关键：记录当前层的节点数</span><br>        List&lt;Integer&gt; currentLevel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <br>        <span class="hljs-comment">// 处理当前层的所有节点</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; levelSize; i++) &#123;<br>            <span class="hljs-type">TreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();<br>            currentLevel.add(node.val);<br>            <br>            <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) &#123;<br>                queue.add(node.left);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) &#123;<br>                queue.add(node.right);<br>            &#125;<br>        &#125;<br>        <br>        result.add(currentLevel);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// 输出：[[1], [2, 3], [4, 5]]</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>关键：记录每层的节点数</li><li>在处理当前层时，只处理 levelSize 个节点</li><li>这样可以清晰地分离各层</li></ul><h3 id="3-5-DFS-vs-BFS-对比"><a href="#3-5-DFS-vs-BFS-对比" class="headerlink" title="3.5 DFS vs BFS 对比"></a>3.5 DFS vs BFS 对比</h3><table><thead><tr><th>维度</th><th>DFS（递归&#x2F;栈）</th><th>BFS（队列）</th></tr></thead><tbody><tr><td><strong>实现</strong></td><td>递归或栈</td><td>队列</td></tr><tr><td><strong>空间复杂度</strong></td><td>O(h)（高度）</td><td>O(w)（最大宽度）</td></tr><tr><td><strong>适用场景</strong></td><td>路径问题、深度问题</td><td>最短路径、层级问题</td></tr><tr><td><strong>遍历顺序</strong></td><td>深度优先</td><td>广度优先</td></tr></tbody></table><hr><h2 id="四、图的遍历"><a href="#四、图的遍历" class="headerlink" title="四、图的遍历"></a>四、图的遍历</h2><h3 id="4-1-基本特性"><a href="#4-1-基本特性" class="headerlink" title="4.1 基本特性"></a>4.1 基本特性</h3><table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>存储方式</strong></td><td>邻接表或邻接矩阵</td></tr><tr><td><strong>访问复杂度</strong></td><td>O(V+E)</td></tr><tr><td><strong>遍历复杂度</strong></td><td>O(V+E)</td></tr><tr><td><strong>属性</strong></td><td>可能有环、可能不连通</td></tr></tbody></table><h3 id="4-2-图的表示"><a href="#4-2-图的表示" class="headerlink" title="4.2 图的表示"></a>4.2 图的表示</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 邻接表表示</span><br>Map&lt;Integer, List&lt;Integer&gt;&gt; graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>graph.put(<span class="hljs-number">1</span>, Arrays.asList(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>));<br>graph.put(<span class="hljs-number">2</span>, Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>));<br>graph.put(<span class="hljs-number">3</span>, Arrays.asList(<span class="hljs-number">1</span>));<br>graph.put(<span class="hljs-number">4</span>, Arrays.asList(<span class="hljs-number">2</span>));<br><br><span class="hljs-comment">// 邻接矩阵表示</span><br><span class="hljs-type">int</span>[][] adjMatrix = &#123;<br>    &#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>&#125;,  <span class="hljs-comment">// 节点 0 的邻接</span><br>    &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>&#125;,  <span class="hljs-comment">// 节点 1 的邻接</span><br>    &#123;<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;,  <span class="hljs-comment">// 节点 2 的邻接</span><br>    &#123;<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>&#125;   <span class="hljs-comment">// 节点 3 的邻接</span><br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="4-3-深度优先遍历（DFS）"><a href="#4-3-深度优先遍历（DFS）" class="headerlink" title="4.3 深度优先遍历（DFS）"></a>4.3 深度优先遍历（DFS）</h3><p><strong>思路</strong>：从起点开始，沿着一条路径尽可能深地探索，直到无法继续，然后回溯。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归实现</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">dfs</span><span class="hljs-params">(<span class="hljs-type">int</span> node, Map&lt;Integer, List&lt;Integer&gt;&gt; graph, Set&lt;Integer&gt; visited)</span> &#123;<br>    visited.add(node);<br>    System.out.println(node);<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> neighbor : graph.getOrDefault(node, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;())) &#123;<br>        <span class="hljs-keyword">if</span> (!visited.contains(neighbor)) &#123;<br>            dfs(neighbor, graph, visited);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 调用</span><br>Set&lt;Integer&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>dfs(<span class="hljs-number">1</span>, graph, visited);<br><br><span class="hljs-comment">// 时间复杂度：O(V+E)</span><br><span class="hljs-comment">// 空间复杂度：O(V)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>使用 visited 集合防止重复访问（处理环）</li><li>递归自然地实现了深度优先</li><li>适合检测环、拓扑排序等</li></ul><p><strong>迭代实现</strong>（使用栈）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">dfsIterative</span><span class="hljs-params">(<span class="hljs-type">int</span> start, Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;<br>    Set&lt;Integer&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    Stack&lt;Integer&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    <br>    stack.push(start);<br>    <br>    <span class="hljs-keyword">while</span> (!stack.isEmpty()) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack.pop();<br>        <br>        <span class="hljs-keyword">if</span> (visited.contains(node)) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <br>        visited.add(node);<br>        System.out.println(node);<br>        <br>        <span class="hljs-comment">// 压栈所有未访问的邻接节点</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> neighbor : graph.getOrDefault(node, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;())) &#123;<br>            <span class="hljs-keyword">if</span> (!visited.contains(neighbor)) &#123;<br>                stack.push(neighbor);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(V+E)</span><br><span class="hljs-comment">// 空间复杂度：O(V)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>栈模拟递归</li><li>需要检查是否已访问</li><li>避免重复处理</li></ul><h3 id="4-4-广度优先遍历（BFS）"><a href="#4-4-广度优先遍历（BFS）" class="headerlink" title="4.4 广度优先遍历（BFS）"></a>4.4 广度优先遍历（BFS）</h3><p><strong>思路</strong>：从起点开始，逐层探索所有邻接节点，然后探索下一层。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">bfs</span><span class="hljs-params">(<span class="hljs-type">int</span> start, Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;<br>    Set&lt;Integer&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    Queue&lt;Integer&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();<br>    <br>    queue.add(start);<br>    visited.add(start);<br>    <br>    <span class="hljs-keyword">while</span> (!queue.isEmpty()) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> queue.poll();<br>        System.out.println(node);<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> neighbor : graph.getOrDefault(node, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;())) &#123;<br>            <span class="hljs-keyword">if</span> (!visited.contains(neighbor)) &#123;<br>                visited.add(neighbor);<br>                queue.add(neighbor);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(V+E)</span><br><span class="hljs-comment">// 空间复杂度：O(V)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>队列保证了广度优先</li><li>访问时就标记，避免重复加入队列</li><li>适合最短路径问题</li></ul><h3 id="4-5-DFS-vs-BFS-对比"><a href="#4-5-DFS-vs-BFS-对比" class="headerlink" title="4.5 DFS vs BFS 对比"></a>4.5 DFS vs BFS 对比</h3><table><thead><tr><th>维度</th><th>DFS</th><th>BFS</th></tr></thead><tbody><tr><td><strong>数据结构</strong></td><td>栈</td><td>队列</td></tr><tr><td><strong>空间复杂度</strong></td><td>O(V)</td><td>O(V)</td></tr><tr><td><strong>适用场景</strong></td><td>连通性、环检测、拓扑排序</td><td>最短路径、分层</td></tr><tr><td><strong>遍历顺序</strong></td><td>深度优先</td><td>广度优先</td></tr></tbody></table><hr><h2 id="五、特殊数据结构遍历"><a href="#五、特殊数据结构遍历" class="headerlink" title="五、特殊数据结构遍历"></a>五、特殊数据结构遍历</h2><h3 id="5-1-二叉搜索树（BST）遍历"><a href="#5-1-二叉搜索树（BST）遍历" class="headerlink" title="5.1 二叉搜索树（BST）遍历"></a>5.1 二叉搜索树（BST）遍历</h3><p><strong>特性</strong>：左子树 &lt; 根 &lt; 右子树</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 中序遍历得到有序序列</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">inorderBST</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    inorderBST(node.left);<br>    System.out.println(node.val);  <span class="hljs-comment">// 输出有序</span><br>    inorderBST(node.right);<br>&#125;<br><br><span class="hljs-comment">// 示例：</span><br><span class="hljs-comment">//       5</span><br><span class="hljs-comment">//      / \</span><br><span class="hljs-comment">//     3   7</span><br><span class="hljs-comment">//    / \ / \</span><br><span class="hljs-comment">//   2  4 6  8</span><br><span class="hljs-comment">// 中序输出：2 3 4 5 6 7 8</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>中序遍历的特殊应用</li><li>利用 BST 的有序性</li><li>时间复杂度 O(n)</li></ul><h3 id="5-2-堆的遍历"><a href="#5-2-堆的遍历" class="headerlink" title="5.2 堆的遍历"></a>5.2 堆的遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 堆通常用数组表示</span><br><span class="hljs-type">int</span>[] heap = &#123;<span class="hljs-number">10</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>&#125;;<br><br><span class="hljs-comment">// 按数组顺序遍历（层序）</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; heap.length; i++) &#123;<br>    System.out.println(heap[i]);<br>&#125;<br><br><span class="hljs-comment">// 节点关系：</span><br><span class="hljs-comment">// 节点 i 的左子节点：2*i + 1</span><br><span class="hljs-comment">// 节点 i 的右子节点：2*i + 2</span><br><span class="hljs-comment">// 节点 i 的父节点：(i-1)/2</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>堆用数组表示，按层序存储</li><li>遍历就是按数组顺序访问</li><li>时间复杂度 O(n)</li></ul><h3 id="5-3-哈希表遍历"><a href="#5-3-哈希表遍历" class="headerlink" title="5.3 哈希表遍历"></a>5.3 哈希表遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>map.put(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">1</span>);<br>map.put(<span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-number">2</span>);<br>map.put(<span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-number">3</span>);<br><br><span class="hljs-comment">// 方式1：遍历 key</span><br><span class="hljs-keyword">for</span> (String key : map.keySet()) &#123;<br>    System.out.println(key);<br>&#125;<br><br><span class="hljs-comment">// 方式2：遍历 value</span><br><span class="hljs-keyword">for</span> (Integer value : map.values()) &#123;<br>    System.out.println(value);<br>&#125;<br><br><span class="hljs-comment">// 方式3：遍历 entry（最高效）</span><br><span class="hljs-keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;<br>    System.out.println(entry.getKey() + <span class="hljs-string">&quot;: &quot;</span> + entry.getValue());<br>&#125;<br><br><span class="hljs-comment">// 方式4：迭代器</span><br>Iterator&lt;Map.Entry&lt;String, Integer&gt;&gt; iterator = map.entrySet().iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    Map.Entry&lt;String, Integer&gt; entry = iterator.next();<br>    System.out.println(entry.getKey() + <span class="hljs-string">&quot;: &quot;</span> + entry.getValue());<br>&#125;<br><br><span class="hljs-comment">// 时间复杂度：O(n)</span><br><span class="hljs-comment">// 空间复杂度：O(1)</span><br></code></pre></td></tr></table></figure><p><strong>思路分析</strong>：</p><ul><li>遍历 entry 最高效（避免重复查询）</li><li>哈希表无序，遍历顺序不确定</li><li>遍历中删除需要用迭代器</li></ul><hr><h2 id="六、遍历的通用思路总结"><a href="#六、遍历的通用思路总结" class="headerlink" title="六、遍历的通用思路总结"></a>六、遍历的通用思路总结</h2><h3 id="6-1-遍历的三个核心要素"><a href="#6-1-遍历的三个核心要素" class="headerlink" title="6.1 遍历的三个核心要素"></a>6.1 遍历的三个核心要素</h3><table><thead><tr><th>要素</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>访问顺序</strong></td><td>按什么顺序访问元素</td><td>前序、中序、后序、层序</td></tr><tr><td><strong>状态管理</strong></td><td>如何跟踪已访问的元素</td><td>visited 集合、指针位置</td></tr><tr><td><strong>终止条件</strong></td><td>何时停止遍历</td><td>null、队列为空、visited 完全</td></tr></tbody></table><h3 id="6-2-选择遍历方式的决策树"><a href="#6-2-选择遍历方式的决策树" class="headerlink" title="6.2 选择遍历方式的决策树"></a>6.2 选择遍历方式的决策树</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">需要遍历数据结构<br>    ↓<br>是否需要特定顺序？<br>    ├─ 是 → 选择对应的遍历方式<br>    │       ├─ 前序：先处理父节点<br>    │       ├─ 中序：有序处理（<span class="hljs-keyword">BST）</span><br><span class="hljs-keyword"></span>    │       ├─ 后序：先处理子节点<br>    │       └─ 层序：按层处理<br>    │<br>    └─ 否 → 选择最简单的方式<br>            ├─ 线性结构 → for 循环<br>            ├─ 树 → DFS 或 <span class="hljs-keyword">BFS</span><br><span class="hljs-keyword"></span>            └─ 图 → DFS 或 <span class="hljs-keyword">BFS</span><br></code></pre></td></tr></table></figure><h3 id="6-3-递归-vs-迭代"><a href="#6-3-递归-vs-迭代" class="headerlink" title="6.3 递归 vs 迭代"></a>6.3 递归 vs 迭代</h3><table><thead><tr><th>维度</th><th>递归</th><th>迭代</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>简洁</td><td>复杂</td></tr><tr><td><strong>空间复杂度</strong></td><td>O(h)（栈）</td><td>O(h)（栈）</td></tr><tr><td><strong>栈溢出风险</strong></td><td>高（深度大）</td><td>低</td></tr><tr><td><strong>理解难度</strong></td><td>容易</td><td>较难</td></tr><tr><td><strong>性能</strong></td><td>略低（函数调用）</td><td>略高</td></tr></tbody></table><hr><h2 id="七、常见遍历问题"><a href="#七、常见遍历问题" class="headerlink" title="七、常见遍历问题"></a>七、常见遍历问题</h2><h3 id="7-1-如何在遍历中删除元素？"><a href="#7-1-如何在遍历中删除元素？" class="headerlink" title="7.1 如何在遍历中删除元素？"></a>7.1 如何在遍历中删除元素？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误方式：直接删除</span><br>List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>));<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; list.size(); i++) &#123;<br>    <span class="hljs-keyword">if</span> (list.get(i) == <span class="hljs-number">3</span>) &#123;<br>        list.remove(i);  <span class="hljs-comment">// 会导致索引混乱</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ✅ 正确方式1：使用迭代器</span><br>Iterator&lt;Integer&gt; iterator = list.iterator();<br><span class="hljs-keyword">while</span> (iterator.hasNext()) &#123;<br>    <span class="hljs-keyword">if</span> (iterator.next() == <span class="hljs-number">3</span>) &#123;<br>        iterator.remove();  <span class="hljs-comment">// 安全删除</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ✅ 正确方式2：反向遍历</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> list.size() - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) &#123;<br>    <span class="hljs-keyword">if</span> (list.get(i) == <span class="hljs-number">3</span>) &#123;<br>        list.remove(i);  <span class="hljs-comment">// 不影响后续索引</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// ✅ 正确方式3：收集要删除的元素</span><br>List&lt;Integer&gt; toRemove = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : list) &#123;<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-number">3</span>) &#123;<br>        toRemove.add(num);<br>    &#125;<br>&#125;<br>list.removeAll(toRemove);<br></code></pre></td></tr></table></figure><h3 id="7-2-如何处理环形结构？"><a href="#7-2-如何处理环形结构？" class="headerlink" title="7.2 如何处理环形结构？"></a>7.2 如何处理环形结构？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 问题：链表中可能有环</span><br><span class="hljs-comment">// 解决：使用 visited 集合或快慢指针</span><br><br><span class="hljs-comment">// 方式1：visited 集合</span><br>Set&lt;ListNode&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br><span class="hljs-type">ListNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (visited.contains(current)) &#123;<br>        System.out.println(<span class="hljs-string">&quot;检测到环&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>    visited.add(current);<br>    current = current.next;<br>&#125;<br><br><span class="hljs-comment">// 方式2：快慢指针（Floyd 算法）</span><br><span class="hljs-type">ListNode</span> <span class="hljs-variable">slow</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-type">ListNode</span> <span class="hljs-variable">fast</span> <span class="hljs-operator">=</span> head;<br><span class="hljs-keyword">while</span> (fast != <span class="hljs-literal">null</span> &amp;&amp; fast.next != <span class="hljs-literal">null</span>) &#123;<br>    slow = slow.next;<br>    fast = fast.next.next;<br>    <span class="hljs-keyword">if</span> (slow == fast) &#123;<br>        System.out.println(<span class="hljs-string">&quot;检测到环&quot;</span>);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="7-3-如何处理不连通的图？"><a href="#7-3-如何处理不连通的图？" class="headerlink" title="7.3 如何处理不连通的图？"></a>7.3 如何处理不连通的图？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 问题：图可能有多个连通分量</span><br><span class="hljs-comment">// 解决：对每个未访问的节点进行 DFS/BFS</span><br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverseAllComponents</span><span class="hljs-params">(Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;<br>    Set&lt;Integer&gt; visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> node : graph.keySet()) &#123;<br>        <span class="hljs-keyword">if</span> (!visited.contains(node)) &#123;<br>            System.out.println(<span class="hljs-string">&quot;--- 新的连通分量 ---&quot;</span>);<br>            dfs(node, graph, visited);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="八、性能对比总结"><a href="#八、性能对比总结" class="headerlink" title="八、性能对比总结"></a>八、性能对比总结</h2><table><thead><tr><th>数据结构</th><th>遍历方式</th><th>时间复杂度</th><th>空间复杂度</th><th>适用场景</th></tr></thead><tbody><tr><td>数组</td><td>for 循环</td><td>O(n)</td><td>O(1)</td><td>顺序访问</td></tr><tr><td>链表</td><td>while 循环</td><td>O(n)</td><td>O(1)</td><td>顺序访问</td></tr><tr><td>树</td><td>DFS（递归）</td><td>O(n)</td><td>O(h)</td><td>深度优先</td></tr><tr><td>树</td><td>BFS（队列）</td><td>O(n)</td><td>O(w)</td><td>广度优先</td></tr><tr><td>图</td><td>DFS</td><td>O(V+E)</td><td>O(V)</td><td>连通性检测</td></tr><tr><td>图</td><td>BFS</td><td>O(V+E)</td><td>O(V)</td><td>最短路径</td></tr><tr><td>哈希表</td><td>entry 遍历</td><td>O(n)</td><td>O(1)</td><td>键值对访问</td></tr></tbody></table><hr><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>数组操作详解</li><li>链表操作详解</li><li>树的操作详解</li><li>图的操作详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据结构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据结构</tag>
      
      <tag>遍历</tag>
      
      <tag>算法</tag>
      
      <tag>属性结构</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>递归详解与应用</title>
    <link href="/2026/01/12/%E9%80%92%E5%BD%92%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%BA%94%E7%94%A8/"/>
    <url>/2026/01/12/%E9%80%92%E5%BD%92%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%BA%94%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="递归详解与应用"><a href="#递归详解与应用" class="headerlink" title="递归详解与应用"></a>递归详解与应用</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>递归</strong> 是一种编程技巧，函数调用自身来解决问题。递归的核心思想是：<strong>将大问题分解为相同的小问题，直到问题足够小可以直接求解</strong>。</p><blockquote><p><strong>💡 提示: 核心思想</strong><br>递归 &#x3D; 自我调用 + 终止条件 + 问题分解</p></blockquote><hr><h2 id="一、递归的三个要素"><a href="#一、递归的三个要素" class="headerlink" title="一、递归的三个要素"></a>一、递归的三个要素</h2><h3 id="1-1-递归的本质"><a href="#1-1-递归的本质" class="headerlink" title="1.1 递归的本质"></a>1.1 递归的本质</h3><p>递归就是<strong>函数调用自己</strong>，但每次调用都在处理一个更小的问题。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs">大问题<br>  ↓<br>分解为更小的问题 + 调用自己<br>  ↓<br>继续分解<br>  ↓<br>直到问题足够小<br>  ↓<br>直接求解（返回结果）<br>  ↓<br>逐层返回结果<br></code></pre></td></tr></table></figure><h3 id="1-2-递归的三个必要条件"><a href="#1-2-递归的三个必要条件" class="headerlink" title="1.2 递归的三个必要条件"></a>1.2 递归的三个必要条件</h3><table><thead><tr><th>条件</th><th>说明</th><th>重要性</th></tr></thead><tbody><tr><td><strong>递归关系</strong></td><td>函数调用自身</td><td>必须</td></tr><tr><td><strong>终止条件</strong></td><td>何时停止递归</td><td><strong>必须</strong>（没有会无限循环）</td></tr><tr><td><strong>问题分解</strong></td><td>如何将大问题分解为小问题</td><td>必须</td></tr></tbody></table><h3 id="1-3-递归的通用模板"><a href="#1-3-递归的通用模板" class="headerlink" title="1.3 递归的通用模板"></a>1.3 递归的通用模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归函数的标准模板</span><br>返回值类型 recursiveFunction(参数) &#123;<br>    <span class="hljs-comment">// 1. 终止条件（基础情况）</span><br>    <span class="hljs-keyword">if</span> (终止条件) &#123;<br>        <span class="hljs-keyword">return</span> 基础情况的结果;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. 递归关系（递归情况）</span><br>    <span class="hljs-comment">// 调用自身处理更小的问题</span><br>    返回值 = recursiveFunction(更小的参数);<br>    <br>    <span class="hljs-comment">// 3. 处理结果</span><br>    <span class="hljs-keyword">return</span> 处理后的结果;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="二、递归的执行过程"><a href="#二、递归的执行过程" class="headerlink" title="二、递归的执行过程"></a>二、递归的执行过程</h2><h3 id="2-1-递归栈的概念"><a href="#2-1-递归栈的概念" class="headerlink" title="2.1 递归栈的概念"></a>2.1 递归栈的概念</h3><p>当函数调用自己时，每次调用都会在<strong>栈</strong>上创建一个新的函数执行环境。</p><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs isbl">递归调用过程：<br><span class="hljs-function"><span class="hljs-title">recursion</span>(<span class="hljs-number">5</span>)</span><br>  ↓ 调用<br><span class="hljs-function"><span class="hljs-title">recursion</span>(<span class="hljs-number">4</span>)</span><br>  ↓ 调用<br><span class="hljs-function"><span class="hljs-title">recursion</span>(<span class="hljs-number">3</span>)</span><br>  ↓ 调用<br><span class="hljs-function"><span class="hljs-title">recursion</span>(<span class="hljs-number">2</span>)</span><br>  ↓ 调用<br><span class="hljs-function"><span class="hljs-title">recursion</span>(<span class="hljs-number">1</span>)</span><br>  ↓ 到达终止条件<br><span class="hljs-variable">return</span> <span class="hljs-number">1</span><br>  ↑ 返回<br><span class="hljs-variable">return</span> <span class="hljs-number">2</span> * <span class="hljs-number">1</span> = <span class="hljs-number">2</span><br>  ↑ 返回<br><span class="hljs-variable">return</span> <span class="hljs-number">3</span> * <span class="hljs-number">2</span> = <span class="hljs-number">6</span><br>  ↑ 返回<br><span class="hljs-variable">return</span> <span class="hljs-number">4</span> * <span class="hljs-number">6</span> = <span class="hljs-number">24</span><br>  ↑ 返回<br><span class="hljs-variable">return</span> <span class="hljs-number">5</span> * <span class="hljs-number">24</span> = <span class="hljs-number">120</span><br></code></pre></td></tr></table></figure><h3 id="2-2-递归栈的内存占用"><a href="#2-2-递归栈的内存占用" class="headerlink" title="2.2 递归栈的内存占用"></a>2.2 递归栈的内存占用</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs routeros">栈内存：<br>┌─────────────────┐<br>│ recursion(1)    │ ← 最后入栈<br>│ 局部变量: <span class="hljs-attribute">n</span>=1   │<br>├─────────────────┤<br>│ recursion(2)    │<br>│ 局部变量: <span class="hljs-attribute">n</span>=2   │<br>├─────────────────┤<br>│ recursion(3)    │<br>│ 局部变量: <span class="hljs-attribute">n</span>=3   │<br>├─────────────────┤<br>│ recursion(4)    │<br>│ 局部变量: <span class="hljs-attribute">n</span>=4   │<br>├─────────────────┤<br>│ recursion(5)    │ ← 最先入栈<br>│ 局部变量: <span class="hljs-attribute">n</span>=5   │<br>└─────────────────┘<br><br>递归深度 = 5<br>栈空间 = 5 × 每个函数的空间<br></code></pre></td></tr></table></figure><p><strong>关键点</strong>：</p><ul><li>每次递归调用都会占用栈空间</li><li>递归深度越深，占用的栈空间越多</li><li>栈空间有限，过深的递归会导致栈溢出</li></ul><hr><h2 id="三、递归的实际例子"><a href="#三、递归的实际例子" class="headerlink" title="三、递归的实际例子"></a>三、递归的实际例子</h2><h3 id="3-1-例子1：计算阶乘"><a href="#3-1-例子1：计算阶乘" class="headerlink" title="3.1 例子1：计算阶乘"></a>3.1 例子1：计算阶乘</h3><h4 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">5</span>! = <span class="hljs-number">5</span> × <span class="hljs-number">4</span>!<br><span class="hljs-attribute">4</span>! = <span class="hljs-number">4</span> × <span class="hljs-number">3</span>!<br><span class="hljs-attribute">3</span>! = <span class="hljs-number">3</span> × <span class="hljs-number">2</span>!<br><span class="hljs-attribute">2</span>! = <span class="hljs-number">2</span> × <span class="hljs-number">1</span>!<br><span class="hljs-attribute">1</span>! = <span class="hljs-number">1</span>（基础情况）<br></code></pre></td></tr></table></figure><p><strong>递归关系</strong>：<code>n! = n × (n-1)!</code><br><strong>终止条件</strong>：<code>n == 1</code></p><h4 id="递归实现"><a href="#递归实现" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 递归方式</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">factorial</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-comment">// 1. 终止条件</span><br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// 基础情况</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. 递归关系</span><br>    <span class="hljs-comment">// 调用自身处理更小的问题</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> n * factorial(n - <span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-comment">// 3. 返回结果</span><br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// 调用</span><br><span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> factorial(<span class="hljs-number">5</span>);  <span class="hljs-comment">// 返回 120</span><br></code></pre></td></tr></table></figure><h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">5</span>)</span><br>  ↓ <span class="hljs-number">5</span> <span class="hljs-variable">!</span>= <span class="hljs-number">1</span>，继续递归<br>  ↓ 计算 <span class="hljs-number">5</span> * <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">4</span>)</span><br>    ↓ <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">4</span>)</span><br>    ↓ <span class="hljs-number">4</span> <span class="hljs-variable">!</span>= <span class="hljs-number">1</span>，继续递归<br>    ↓ 计算 <span class="hljs-number">4</span> * <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">3</span>)</span><br>      ↓ <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">3</span>)</span><br>      ↓ <span class="hljs-number">3</span> <span class="hljs-variable">!</span>= <span class="hljs-number">1</span>，继续递归<br>      ↓ 计算 <span class="hljs-number">3</span> * <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">2</span>)</span><br>        ↓ <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">2</span>)</span><br>        ↓ <span class="hljs-number">2</span> <span class="hljs-variable">!</span>= <span class="hljs-number">1</span>，继续递归<br>        ↓ 计算 <span class="hljs-number">2</span> * <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">1</span>)</span><br>          ↓ <span class="hljs-function"><span class="hljs-title">factorial</span>(<span class="hljs-number">1</span>)</span><br>          ↓ <span class="hljs-number">1</span> == <span class="hljs-number">1</span>，到达终止条件<br>          ↓ <span class="hljs-variable">return</span> <span class="hljs-number">1</span><br>        ↓ <span class="hljs-variable">return</span> <span class="hljs-number">2</span> * <span class="hljs-number">1</span> = <span class="hljs-number">2</span><br>      ↓ <span class="hljs-variable">return</span> <span class="hljs-number">3</span> * <span class="hljs-number">2</span> = <span class="hljs-number">6</span><br>    ↓ <span class="hljs-variable">return</span> <span class="hljs-number">4</span> * <span class="hljs-number">6</span> = <span class="hljs-number">24</span><br>  ↓ <span class="hljs-variable">return</span> <span class="hljs-number">5</span> * <span class="hljs-number">24</span> = <span class="hljs-number">120</span><br></code></pre></td></tr></table></figure><p><strong>时间复杂度</strong>：O(n)<br><strong>空间复杂度</strong>：O(n)（递归栈深度）</p><h3 id="3-2-例子2：链表遍历（树遍历的基础）"><a href="#3-2-例子2：链表遍历（树遍历的基础）" class="headerlink" title="3.2 例子2：链表遍历（树遍历的基础）"></a>3.2 例子2：链表遍历（树遍历的基础）</h3><h4 id="问题分析-1"><a href="#问题分析-1" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">链表：1 → 2 → 3 → null<br><br>遍历思路：<br><span class="hljs-bullet">- </span>访问当前节点<br><span class="hljs-bullet">- </span>递归遍历下一个节点<br><span class="hljs-bullet">- </span>终止条件：节点为 null<br></code></pre></td></tr></table></figure><h4 id="递归实现-1"><a href="#递归实现-1" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> &#123;<br>    <span class="hljs-type">int</span> val;<br>    ListNode next;<br>    <br>    ListNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 递归遍历链表</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(ListNode node)</span> &#123;<br>    <span class="hljs-comment">// 1. 终止条件</span><br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 到达链表末尾</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. 处理当前节点</span><br>    System.out.println(node.val);<br>    <br>    <span class="hljs-comment">// 3. 递归处理下一个节点</span><br>    traverse(node.next);<br>&#125;<br><br><span class="hljs-comment">// 调用</span><br><span class="hljs-type">ListNode</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">1</span>);<br>head.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">2</span>);<br>head.next.next = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListNode</span>(<span class="hljs-number">3</span>);<br><br>traverse(head);  <span class="hljs-comment">// 输出：1 2 3</span><br></code></pre></td></tr></table></figure><h4 id="执行过程-1"><a href="#执行过程-1" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs isbl"><span class="hljs-function"><span class="hljs-title">traverse</span>(<span class="hljs-variable">node1</span>)  <span class="hljs-comment">// node1.val = 1</span></span><br><span class="hljs-function">  ↓ <span class="hljs-variable">node1</span> <span class="hljs-variable">!</span>= <span class="hljs-variable"><span class="hljs-literal">null</span></span></span><br><span class="hljs-function">  ↓ 打印 <span class="hljs-number">1</span></span><br><span class="hljs-function">  ↓ 调用 <span class="hljs-title">traverse</span>(<span class="hljs-variable">node2</span>)</span><br>    ↓ <span class="hljs-function"><span class="hljs-title">traverse</span>(<span class="hljs-variable">node2</span>)  <span class="hljs-comment">// node2.val = 2</span></span><br><span class="hljs-function">    ↓ <span class="hljs-variable">node2</span> <span class="hljs-variable">!</span>= <span class="hljs-variable"><span class="hljs-literal">null</span></span></span><br><span class="hljs-function">    ↓ 打印 <span class="hljs-number">2</span></span><br><span class="hljs-function">    ↓ 调用 <span class="hljs-title">traverse</span>(<span class="hljs-variable">node3</span>)</span><br>      ↓ <span class="hljs-function"><span class="hljs-title">traverse</span>(<span class="hljs-variable">node3</span>)  <span class="hljs-comment">// node3.val = 3</span></span><br><span class="hljs-function">      ↓ <span class="hljs-variable">node3</span> <span class="hljs-variable">!</span>= <span class="hljs-variable"><span class="hljs-literal">null</span></span></span><br><span class="hljs-function">      ↓ 打印 <span class="hljs-number">3</span></span><br><span class="hljs-function">      ↓ 调用 <span class="hljs-title">traverse</span>(<span class="hljs-variable"><span class="hljs-literal">null</span></span>)</span><br>        ↓ <span class="hljs-function"><span class="hljs-title">traverse</span>(<span class="hljs-variable"><span class="hljs-literal">null</span></span>)</span><br>        ↓ <span class="hljs-variable"><span class="hljs-literal">null</span></span> == <span class="hljs-variable"><span class="hljs-literal">null</span></span>，到达终止条件<br>        ↓ <span class="hljs-variable">return</span><br>      ↓ <span class="hljs-variable">return</span><br>    ↓ <span class="hljs-variable">return</span><br>  ↓ <span class="hljs-variable">return</span><br></code></pre></td></tr></table></figure><p><strong>关键点</strong>：</p><ul><li>每次递归都处理一个节点</li><li>通过 <code>node.next</code> 将问题分解为更小的问题</li><li>当 <code>node == null</code> 时停止递归</li></ul><h3 id="3-3-例子3：二叉树前序遍历"><a href="#3-3-例子3：二叉树前序遍历" class="headerlink" title="3.3 例子3：二叉树前序遍历"></a>3.3 例子3：二叉树前序遍历</h3><h4 id="问题分析-2"><a href="#问题分析-2" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs markdown">树结构：<br><span class="hljs-code">      1</span><br><span class="hljs-code">     / \</span><br><span class="hljs-code">    2   3</span><br><span class="hljs-code"></span><br>前序遍历：根 → 左子树 → 右子树<br>输出：1 2 3<br><br>递归思路：<br><span class="hljs-bullet">1.</span> 访问根节点<br><span class="hljs-bullet">2.</span> 递归遍历左子树<br><span class="hljs-bullet">3.</span> 递归遍历右子树<br></code></pre></td></tr></table></figure><h4 id="递归实现-2"><a href="#递归实现-2" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span> &#123;<br>    <span class="hljs-type">int</span> val;<br>    TreeNode left;<br>    TreeNode right;<br>    <br>    TreeNode(<span class="hljs-type">int</span> val) &#123;<br>        <span class="hljs-built_in">this</span>.val = val;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 前序遍历</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-comment">// 1. 终止条件</span><br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// 2. 处理根节点</span><br>    System.out.println(node.val);<br>    <br>    <span class="hljs-comment">// 3. 递归处理左子树</span><br>    preorder(node.left);<br>    <br>    <span class="hljs-comment">// 4. 递归处理右子树</span><br>    preorder(node.right);<br>&#125;<br><br><span class="hljs-comment">// 调用</span><br><span class="hljs-type">TreeNode</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(<span class="hljs-number">1</span>);<br>root.left = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(<span class="hljs-number">2</span>);<br>root.right = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeNode</span>(<span class="hljs-number">3</span>);<br><br>preorder(root);  <span class="hljs-comment">// 输出：1 2 3</span><br></code></pre></td></tr></table></figure><h4 id="执行过程-2"><a href="#执行过程-2" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">preorder(node1)  <span class="hljs-comment">// node1.val = 1</span><br>  ↓ node1 != <span class="hljs-literal">null</span><br>  ↓ 打印 <span class="hljs-number">1</span><br>  ↓ 调用 preorder(node2)  <span class="hljs-comment">// 处理左子树</span><br>    ↓ preorder(node2)  <span class="hljs-comment">// node2.val = 2</span><br>    ↓ node2 != <span class="hljs-literal">null</span><br>    ↓ 打印 <span class="hljs-number">2</span><br>    ↓ 调用 preorder(<span class="hljs-literal">null</span>)  <span class="hljs-comment">// 左子树为 null</span><br>      ↓ <span class="hljs-keyword">return</span><br>    ↓ 调用 preorder(<span class="hljs-literal">null</span>)  <span class="hljs-comment">// 右子树为 null</span><br>      ↓ <span class="hljs-keyword">return</span><br>    ↓ <span class="hljs-keyword">return</span><br>  ↓ 调用 preorder(node3)  <span class="hljs-comment">// 处理右子树</span><br>    ↓ preorder(node3)  <span class="hljs-comment">// node3.val = 3</span><br>    ↓ node3 != <span class="hljs-literal">null</span><br>    ↓ 打印 <span class="hljs-number">3</span><br>    ↓ 调用 preorder(<span class="hljs-literal">null</span>)  <span class="hljs-comment">// 左子树为 null</span><br>      ↓ <span class="hljs-keyword">return</span><br>    ↓ 调用 preorder(<span class="hljs-literal">null</span>)  <span class="hljs-comment">// 右子树为 null</span><br>      ↓ <span class="hljs-keyword">return</span><br>    ↓ <span class="hljs-keyword">return</span><br>  ↓ <span class="hljs-keyword">return</span><br></code></pre></td></tr></table></figure><p><strong>关键点</strong>：</p><ul><li>递归处理三个部分：根、左子树、右子树</li><li>每个递归调用都是独立的，处理一个子树</li><li>通过 <code>node == null</code> 判断是否继续递归</li></ul><hr><h2 id="四、递归的三个关键概念"><a href="#四、递归的三个关键概念" class="headerlink" title="四、递归的三个关键概念"></a>四、递归的三个关键概念</h2><h3 id="4-1-递归的”信任”"><a href="#4-1-递归的”信任”" class="headerlink" title="4.1 递归的”信任”"></a>4.1 递归的”信任”</h3><p><strong>关键思想</strong>：不要试图追踪整个递归过程，而是<strong>相信递归函数能正确处理更小的问题</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误的思维方式</span><br><span class="hljs-comment">// 试图追踪整个递归过程</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(node.val);<br>    preorder(node.left);   <span class="hljs-comment">// 我需要知道这里发生了什么...</span><br>    preorder(node.right);  <span class="hljs-comment">// 还有这里...</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 正确的思维方式</span><br><span class="hljs-comment">// 相信递归函数能正确处理子树</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// 1. 处理当前节点</span><br>    System.out.println(node.val);<br>    <br>    <span class="hljs-comment">// 2. 相信 preorder 能正确处理左子树</span><br>    preorder(node.left);<br>    <br>    <span class="hljs-comment">// 3. 相信 preorder 能正确处理右子树</span><br>    preorder(node.right);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>关键</strong>：</p><ul><li>不要试图在脑子里模拟整个递归过程</li><li>只需要确保：终止条件正确 + 递归关系正确</li><li>相信递归函数能处理更小的问题</li></ul><h3 id="4-2-递归的”分治”"><a href="#4-2-递归的”分治”" class="headerlink" title="4.2 递归的”分治”"></a>4.2 递归的”分治”</h3><p><strong>分治思想</strong>：将大问题分解为相同的小问题。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs">大问题：遍历整个树<br>  ↓ 分解<br>小问题1：处理根节点<br>小问题2：遍历左子树（与大问题相同，但规模更小）<br>小问题3：遍历右子树（与大问题相同，但规模更小）<br>  ↓ 递归处理小问题<br>  ↓ 合并结果<br>完成<br></code></pre></td></tr></table></figure><p><strong>关键</strong>：</p><ul><li>每次递归都在处理一个更小的问题</li><li>问题的结构相同，只是规模不同</li><li>最终会到达基础情况（终止条件）</li></ul><h3 id="4-3-递归的”回溯”"><a href="#4-3-递归的”回溯”" class="headerlink" title="4.3 递归的”回溯”"></a>4.3 递归的”回溯”</h3><p><strong>回溯思想</strong>：递归会自动回溯，逐层返回结果。</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs tap">递归下降：<br>level<span class="hljs-number"> 1 </span>→ level<span class="hljs-number"> 2 </span>→ level<span class="hljs-number"> 3 </span>→ ... → 基础情况<br>                                      ↓<br>回溯上升：<br>level<span class="hljs-number"> 1 </span>← level<span class="hljs-number"> 2 </span>← level<span class="hljs-number"> 3 </span>← ... ← 返回结果<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 后序遍历（回溯的典型应用）</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">postorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    postorder(node.left);   <span class="hljs-comment">// 先处理左子树</span><br>    postorder(node.right);  <span class="hljs-comment">// 再处理右子树</span><br>    System.out.println(node.val);  <span class="hljs-comment">// 最后处理根节点（回溯时）</span><br>&#125;<br><br><span class="hljs-comment">// 执行过程：</span><br><span class="hljs-comment">// 1. 递归下降到叶子节点</span><br><span class="hljs-comment">// 2. 回溯时处理节点（后序）</span><br></code></pre></td></tr></table></figure><hr><h2 id="五、递归-vs-迭代"><a href="#五、递归-vs-迭代" class="headerlink" title="五、递归 vs 迭代"></a>五、递归 vs 迭代</h2><h3 id="5-1-对比表"><a href="#5-1-对比表" class="headerlink" title="5.1 对比表"></a>5.1 对比表</h3><table><thead><tr><th>维度</th><th>递归</th><th>迭代</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>简洁、易读</td><td>复杂、需要手动管理状态</td></tr><tr><td><strong>空间复杂度</strong></td><td>O(h)（递归栈）</td><td>O(1)（通常）</td></tr><tr><td><strong>时间复杂度</strong></td><td>相同</td><td>相同</td></tr><tr><td><strong>栈溢出风险</strong></td><td>高（深度大时）</td><td>无</td></tr><tr><td><strong>理解难度</strong></td><td>需要理解递归思想</td><td>相对直观</td></tr><tr><td><strong>性能</strong></td><td>略低（函数调用开销）</td><td>略高</td></tr></tbody></table><h3 id="5-2-递归-vs-迭代：链表遍历"><a href="#5-2-递归-vs-迭代：链表遍历" class="headerlink" title="5.2 递归 vs 迭代：链表遍历"></a>5.2 递归 vs 迭代：链表遍历</h3><h4 id="递归方式"><a href="#递归方式" class="headerlink" title="递归方式"></a>递归方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(ListNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(node.val);<br>    traverse(node.next);<br>&#125;<br><br><span class="hljs-comment">// 优点：简洁、易读</span><br><span class="hljs-comment">// 缺点：占用栈空间，链表很长时可能栈溢出</span><br></code></pre></td></tr></table></figure><h4 id="迭代方式"><a href="#迭代方式" class="headerlink" title="迭代方式"></a>迭代方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">traverse</span><span class="hljs-params">(ListNode node)</span> &#123;<br>    <span class="hljs-type">ListNode</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> node;<br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>        System.out.println(current.val);<br>        current = current.next;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 优点：不占用额外栈空间，效率高</span><br><span class="hljs-comment">// 缺点：需要手动管理指针</span><br></code></pre></td></tr></table></figure><h3 id="5-3-递归-vs-迭代：树遍历"><a href="#5-3-递归-vs-迭代：树遍历" class="headerlink" title="5.3 递归 vs 迭代：树遍历"></a>5.3 递归 vs 迭代：树遍历</h3><h4 id="递归方式（前序）"><a href="#递归方式（前序）" class="headerlink" title="递归方式（前序）"></a>递归方式（前序）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(node.val);<br>    preorder(node.left);<br>    preorder(node.right);<br>&#125;<br><br><span class="hljs-comment">// 代码简洁，逻辑清晰</span><br></code></pre></td></tr></table></figure><h4 id="迭代方式（前序）"><a href="#迭代方式（前序）" class="headerlink" title="迭代方式（前序）"></a>迭代方式（前序）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorderIterative</span><span class="hljs-params">(TreeNode root)</span> &#123;<br>    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    Stack&lt;TreeNode&gt; stack = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Stack</span>&lt;&gt;();<br>    stack.push(root);<br>    <br>    <span class="hljs-keyword">while</span> (!stack.isEmpty()) &#123;<br>        <span class="hljs-type">TreeNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> stack.pop();<br>        System.out.println(node.val);<br>        <br>        <span class="hljs-keyword">if</span> (node.right != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node.right);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (node.left != <span class="hljs-literal">null</span>) &#123;<br>            stack.push(node.left);<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 需要手动管理栈，逻辑复杂</span><br></code></pre></td></tr></table></figure><p><strong>关键观察</strong>：</p><ul><li>递归本质上是利用系统栈</li><li>迭代是手动管理栈</li><li>递归简洁，迭代高效</li></ul><hr><h2 id="六、递归的常见陷阱"><a href="#六、递归的常见陷阱" class="headerlink" title="六、递归的常见陷阱"></a>六、递归的常见陷阱</h2><h3 id="6-1-陷阱1：没有终止条件"><a href="#6-1-陷阱1：没有终止条件" class="headerlink" title="6.1 陷阱1：没有终止条件"></a>6.1 陷阱1：没有终止条件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误：无限递归</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    System.out.println(n);<br>    recursion(n + <span class="hljs-number">1</span>);  <span class="hljs-comment">// 永远不会停止</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 正确：有终止条件</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">10</span>) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 终止条件</span><br>    System.out.println(n);<br>    recursion(n + <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-2-陷阱2：终止条件永远不会到达"><a href="#6-2-陷阱2：终止条件永远不会到达" class="headerlink" title="6.2 陷阱2：终止条件永远不会到达"></a>6.2 陷阱2：终止条件永远不会到达</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误：终止条件错误</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(n);<br>    recursion(n - <span class="hljs-number">2</span>);  <span class="hljs-comment">// 如果 n 是奇数，永远不会等于 0</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 正确：终止条件正确</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 包含所有停止情况</span><br>    System.out.println(n);<br>    recursion(n - <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-3-陷阱3：问题没有真正分解"><a href="#6-3-陷阱3：问题没有真正分解" class="headerlink" title="6.3 陷阱3：问题没有真正分解"></a>6.3 陷阱3：问题没有真正分解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误：问题没有变小</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(n);<br>    recursion(n);  <span class="hljs-comment">// 问题大小没变，无限递归</span><br>&#125;<br><br><span class="hljs-comment">// ✅ 正确：问题逐步变小</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>    System.out.println(n);<br>    recursion(n - <span class="hljs-number">1</span>);  <span class="hljs-comment">// 问题逐步变小</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="6-4-陷阱4：栈溢出"><a href="#6-4-陷阱4：栈溢出" class="headerlink" title="6.4 陷阱4：栈溢出"></a>6.4 陷阱4：栈溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 危险：递归深度太大</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;<br>    recursion(n - <span class="hljs-number">1</span>);<br>&#125;<br><br>recursion(<span class="hljs-number">100000</span>);  <span class="hljs-comment">// 栈溢出！</span><br><br><span class="hljs-comment">// ✅ 解决：使用迭代或增加栈大小</span><br><span class="hljs-comment">// 方式1：使用迭代</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">100000</span>; i &gt; <span class="hljs-number">0</span>; i--) &#123;<br>    <span class="hljs-comment">// 处理</span><br>&#125;<br><br><span class="hljs-comment">// 方式2：增加栈大小（JVM 参数）</span><br><span class="hljs-comment">// java -Xss10m MyProgram</span><br></code></pre></td></tr></table></figure><hr><h2 id="七、递归的应用场景"><a href="#七、递归的应用场景" class="headerlink" title="七、递归的应用场景"></a>七、递归的应用场景</h2><h3 id="7-1-适合用递归的场景"><a href="#7-1-适合用递归的场景" class="headerlink" title="7.1 适合用递归的场景"></a>7.1 适合用递归的场景</h3><table><thead><tr><th>场景</th><th>原因</th><th>例子</th></tr></thead><tbody><tr><td><strong>树&#x2F;图遍历</strong></td><td>天然的递归结构</td><td>前序、中序、后序遍历</td></tr><tr><td><strong>分治算法</strong></td><td>问题可分解</td><td>快速排序、归并排序</td></tr><tr><td><strong>回溯算法</strong></td><td>需要尝试所有可能</td><td>N 皇后、组合问题</td></tr><tr><td><strong>动态规划</strong></td><td>有重叠子问题</td><td>斐波那契数列</td></tr></tbody></table><h3 id="7-2-不适合用递归的场景"><a href="#7-2-不适合用递归的场景" class="headerlink" title="7.2 不适合用递归的场景"></a>7.2 不适合用递归的场景</h3><table><thead><tr><th>场景</th><th>原因</th><th>替代方案</th></tr></thead><tbody><tr><td><strong>线性遍历</strong></td><td>迭代更高效</td><td>使用 while 循环</td></tr><tr><td><strong>深度很大</strong></td><td>容易栈溢出</td><td>使用迭代或增加栈大小</td></tr><tr><td><strong>性能关键</strong></td><td>函数调用开销大</td><td>使用迭代</td></tr></tbody></table><hr><h2 id="八、递归的调试技巧"><a href="#八、递归的调试技巧" class="headerlink" title="八、递归的调试技巧"></a>八、递归的调试技巧</h2><h3 id="8-1-打印递归栈"><a href="#8-1-打印递归栈" class="headerlink" title="8.1 打印递归栈"></a>8.1 打印递归栈</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">preorder</span><span class="hljs-params">(TreeNode node, <span class="hljs-type">int</span> depth)</span> &#123;<br>    <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// 打印缩进表示深度</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">indent</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;  &quot;</span>.repeat(depth);<br>    System.out.println(indent + <span class="hljs-string">&quot;进入: &quot;</span> + node.val);<br>    <br>    preorder(node.left, depth + <span class="hljs-number">1</span>);<br>    preorder(node.right, depth + <span class="hljs-number">1</span>);<br>    <br>    System.out.println(indent + <span class="hljs-string">&quot;返回: &quot;</span> + node.val);<br>&#125;<br><br><span class="hljs-comment">// 输出：</span><br><span class="hljs-comment">// 进入: 1</span><br><span class="hljs-comment">//   进入: 2</span><br><span class="hljs-comment">//   返回: 2</span><br><span class="hljs-comment">//   进入: 3</span><br><span class="hljs-comment">//   返回: 3</span><br><span class="hljs-comment">// 返回: 1</span><br></code></pre></td></tr></table></figure><h3 id="8-2-验证终止条件"><a href="#8-2-验证终止条件" class="headerlink" title="8.2 验证终止条件"></a>8.2 验证终止条件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    <span class="hljs-comment">// 添加日志验证终止条件</span><br>    System.out.println(<span class="hljs-string">&quot;递归调用: n = &quot;</span> + n);<br>    <br>    <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) &#123;<br>        System.out.println(<span class="hljs-string">&quot;到达终止条件&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    recursion(n - <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="8-3-检查问题分解"><a href="#8-3-检查问题分解" class="headerlink" title="8.3 检查问题分解"></a>8.3 检查问题分解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">recursion</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;处理问题大小: &quot;</span> + n);<br>    <br>    <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// 验证问题确实在变小</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">nextSize</span> <span class="hljs-operator">=</span> n - <span class="hljs-number">1</span>;<br>    System.out.println(<span class="hljs-string">&quot;下一个问题大小: &quot;</span> + nextSize);<br>    <br>    recursion(nextSize);<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="九、递归思维的培养"><a href="#九、递归思维的培养" class="headerlink" title="九、递归思维的培养"></a>九、递归思维的培养</h2><h3 id="9-1-三步法"><a href="#9-1-三步法" class="headerlink" title="9.1 三步法"></a>9.1 三步法</h3><p><strong>第1步</strong>：明确递归的三个要素</p><ul><li>终止条件是什么？</li><li>递归关系是什么？</li><li>如何分解问题？</li></ul><p><strong>第2步</strong>：相信递归</p><ul><li>不要试图追踪整个过程</li><li>只需确保逻辑正确</li><li>相信递归能处理更小的问题</li></ul><p><strong>第3步</strong>：验证</p><ul><li>测试基础情况</li><li>测试简单情况（n&#x3D;1, 2, 3）</li><li>测试复杂情况</li></ul><h3 id="9-2-练习建议"><a href="#9-2-练习建议" class="headerlink" title="9.2 练习建议"></a>9.2 练习建议</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 从简单到复杂</span><br><span class="hljs-number">1.</span> 阶乘：factorial(n)<br><span class="hljs-number">2.</span> 斐波那契：fib(n)<br><span class="hljs-number">3.</span> 链表遍历：traverse(node)<br><span class="hljs-number">4.</span> 树遍历：preorder(node)<br><span class="hljs-number">5.</span> 二分查找：binarySearch(arr, target)<br><span class="hljs-number">6.</span> 快速排序：quickSort(arr)<br><span class="hljs-number">7.</span> 回溯：permutation(arr)<br></code></pre></td></tr></table></figure><hr><h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul><li>属性数据结构遍历详解</li><li>链表操作详解</li><li>树的操作详解</li></ul>]]></content>
    
    
    <categories>
      
      <category>数据结构</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数据结构</tag>
      
      <tag>算法</tag>
      
      <tag>递归</tag>
      
      <tag>编程思想</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Flux是管道不是容器</title>
    <link href="/2026/01/10/Flux%E6%98%AF%E7%AE%A1%E9%81%93%E4%B8%8D%E6%98%AF%E5%AE%B9%E5%99%A8/"/>
    <url>/2026/01/10/Flux%E6%98%AF%E7%AE%A1%E9%81%93%E4%B8%8D%E6%98%AF%E5%AE%B9%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="Flux-是管道，不是容器"><a href="#Flux-是管道，不是容器" class="headerlink" title="Flux 是管道，不是容器"></a>Flux 是管道，不是容器</h1><h2 id="常见误解"><a href="#常见误解" class="headerlink" title="常见误解"></a>常见误解</h2><p>很多人初学 Reactor 时会有这样的误解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 错误理解：Flux 就像 List，是装数据的容器</span><br>List&lt;String&gt; list = Arrays.asList(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>);  <span class="hljs-comment">// 3个元素，确定的</span><br>Flux&lt;String&gt; flux = Flux.just(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>);      <span class="hljs-comment">// 也是3个元素，确定的？</span><br></code></pre></td></tr></table></figure><p>这种理解在简单场景下没问题，但会导致无法理解复杂场景。</p><hr><h2 id="正确理解：Flux-是数据管道"><a href="#正确理解：Flux-是数据管道" class="headerlink" title="正确理解：Flux 是数据管道"></a>正确理解：Flux 是数据管道</h2><h3 id="管道-vs-容器"><a href="#管道-vs-容器" class="headerlink" title="管道 vs 容器"></a>管道 vs 容器</h3><table><thead><tr><th>概念</th><th>容器（List）</th><th>管道（Flux）</th></tr></thead><tbody><tr><td><strong>数据存储</strong></td><td>数据存在内存中</td><td>数据流经管道</td></tr><tr><td><strong>数据时机</strong></td><td>创建时就有</td><td>订阅后才开始流动</td></tr><tr><td><strong>数据来源</strong></td><td>已知、固定</td><td>可以是任何源头</td></tr><tr><td><strong>数据数量</strong></td><td>确定的</td><td>可能不确定</td></tr><tr><td><strong>生命周期</strong></td><td>一直存在</td><td>流完就结束</td></tr></tbody></table><h3 id="形象比喻"><a href="#形象比喻" class="headerlink" title="形象比喻"></a>形象比喻</h3><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">容器（<span class="hljs-built_in">List</span>）像一个水桶：<br>┌─────────┐<br>│  水水水  │  ← 水已经在桶里了<br>│  水水水  │<br>└─────────┘<br><br>管道（<span class="hljs-variable">Flux</span>）像一根水管：<br>                    ┌─────────┐<br>水源 ════════════════│  水管   │════════════════▶ 出水口<br>（上游）              └─────────┘                 （下游）<br>                         ↑<br>                    水流经这里<br>                    但不存储在这里<br></code></pre></td></tr></table></figure><hr><h2 id="实际案例：调用大模型-API"><a href="#实际案例：调用大模型-API" class="headerlink" title="实际案例：调用大模型 API"></a>实际案例：调用大模型 API</h2><h3 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h3><p>调用 OpenAI&#x2F;Claude 等大模型 API，返回流式响应：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;String&gt; response = webClient.post()<br>    .uri(<span class="hljs-string">&quot;https://api.openai.com/v1/chat/completions&quot;</span>)<br>    .header(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Bearer &quot;</span> + apiKey)<br>    .bodyValue(Map.of(<br>        <span class="hljs-string">&quot;model&quot;</span>, <span class="hljs-string">&quot;gpt-4&quot;</span>,<br>        <span class="hljs-string">&quot;messages&quot;</span>, List.of(Map.of(<span class="hljs-string">&quot;role&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>, <span class="hljs-string">&quot;你好&quot;</span>)),<br>        <span class="hljs-string">&quot;stream&quot;</span>, <span class="hljs-literal">true</span><br>    ))<br>    .retrieve()<br>    .bodyToFlux(String.class);<br></code></pre></td></tr></table></figure><h3 id="问题：Flux-里有多少数据？"><a href="#问题：Flux-里有多少数据？" class="headerlink" title="问题：Flux 里有多少数据？"></a>问题：Flux 里有多少数据？</h3><p><strong>答案：不知道，也不需要知道！</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 这个 Flux 创建时，大模型还没开始回复</span><br><span class="hljs-comment">// 数据量完全取决于大模型要说多少话</span><br>Flux&lt;String&gt; response = callLLM(<span class="hljs-string">&quot;请介绍一下自己&quot;</span>);<br><br><span class="hljs-comment">// 可能返回 10 个 chunk，也可能返回 100 个</span><br><span class="hljs-comment">// Flux 不关心，它只负责把数据从上游传到下游</span><br></code></pre></td></tr></table></figure><h3 id="数据流动过程"><a href="#数据流动过程" class="headerlink" title="数据流动过程"></a>数据流动过程</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs css">┌─────────────────────────────────────────────────────────────────┐<br>│                        时间线                                    │<br>├─────────────────────────────────────────────────────────────────┤<br>│                                                                 │<br>│  T0: 创建 Flux                                                  │<br>│      Flux&lt;String&gt; flux = <span class="hljs-built_in">callLLM</span>(prompt);                       │<br>│      此时：管道已建立，但没有数据流动                              │<br>│                                                                 │<br>│  T1: 订阅 Flux                                                  │<br>│      flux.<span class="hljs-built_in">subscribe</span>(chunk -&gt; <span class="hljs-built_in">print</span>(chunk));                     │<br>│      此时：向上游发送请求，开始等待数据                            │<br>│                                                                 │<br>│  T2: 大模型开始回复                                              │<br>│      上游发送 <span class="hljs-built_in">onNext</span>(<span class="hljs-string">&quot;你&quot;</span>)                                       │<br>│      下游收到 <span class="hljs-string">&quot;你&quot;</span>，打印                                         │<br>│                                                                 │<br>│  T3: 大模型继续回复                                              │<br>│      上游发送 <span class="hljs-built_in">onNext</span>(<span class="hljs-string">&quot;好&quot;</span>)                                       │<br>│      下游收到 <span class="hljs-string">&quot;好&quot;</span>，打印                                         │<br>│                                                                 │<br>│  T4: 大模型继续回复                                              │<br>│      上游发送 <span class="hljs-built_in">onNext</span>(<span class="hljs-string">&quot;，我是AI助手&quot;</span>)                             │<br>│      下游收到，打印                                              │<br>│                                                                 │<br>│  T5: 大模型回复完毕                                              │<br>│      上游发送 <span class="hljs-built_in">onComplete</span>()                                       │<br>│      下游知道流结束了                                            │<br>│                                                                 │<br>└─────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(value = &quot;/chat&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br><span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String prompt)</span> &#123;<br>    <br>    <span class="hljs-comment">// 1. 创建 Flux（此时没有数据）</span><br>    Flux&lt;String&gt; response = webClient.post()<br>        .uri(<span class="hljs-string">&quot;/v1/chat/completions&quot;</span>)<br>        .bodyValue(buildRequest(prompt))<br>        .retrieve()<br>        .bodyToFlux(ChatResponse.class)<br>        .map(r -&gt; r.getChoices().get(<span class="hljs-number">0</span>).getDelta().getContent())<br>        .filter(Objects::nonNull);<br>    <br>    <span class="hljs-comment">// 2. 返回 Flux（Spring WebFlux 会自动订阅并流式返回给前端）</span><br>    <span class="hljs-keyword">return</span> response;<br>    <br>    <span class="hljs-comment">// 3. 前端会逐字收到大模型的回复</span><br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="Flux-的数据来源"><a href="#Flux-的数据来源" class="headerlink" title="Flux 的数据来源"></a>Flux 的数据来源</h2><p>Flux 的数据可以来自各种源头：</p><h3 id="1-静态数据（确定的）"><a href="#1-静态数据（确定的）" class="headerlink" title="1. 静态数据（确定的）"></a>1. 静态数据（确定的）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 数据在创建时就确定了</span><br>Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br>Flux.fromIterable(list);<br>Flux.fromArray(array);<br></code></pre></td></tr></table></figure><h3 id="2-生成规则（按规则产生）"><a href="#2-生成规则（按规则产生）" class="headerlink" title="2. 生成规则（按规则产生）"></a>2. 生成规则（按规则产生）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 按规则生成，数量可能无限</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>);                    <span class="hljs-comment">// 1到100</span><br>Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>));  <span class="hljs-comment">// 每秒一个，无限</span><br></code></pre></td></tr></table></figure><h3 id="3-外部数据源（不确定的）"><a href="#3-外部数据源（不确定的）" class="headerlink" title="3. 外部数据源（不确定的）"></a>3. 外部数据源（不确定的）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 数据来自外部，数量不确定</span><br>Flux&lt;String&gt; httpResponse = webClient.get().retrieve().bodyToFlux(String.class);<br>Flux&lt;Message&gt; kafkaMessages = kafkaReceiver.receive();<br>Flux&lt;String&gt; websocketMessages = session.receive().map(WebSocketMessage::getPayloadAsText);<br>Flux&lt;String&gt; fileLines = Flux.using(<br>    () -&gt; Files.lines(path),<br>    Flux::fromStream,<br>    Stream::close<br>);<br></code></pre></td></tr></table></figure><h3 id="4-手动推送（Sinks）"><a href="#4-手动推送（Sinks）" class="headerlink" title="4. 手动推送（Sinks）"></a>4. 手动推送（Sinks）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 你自己决定什么时候发送什么数据</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息1&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息2&quot;</span>);<br>Flux&lt;String&gt; flux = sink.asFlux();<br></code></pre></td></tr></table></figure><hr><h2 id="Flux-怎么知道数据结束？"><a href="#Flux-怎么知道数据结束？" class="headerlink" title="Flux 怎么知道数据结束？"></a>Flux 怎么知道数据结束？</h2><h3 id="三种终止信号"><a href="#三种终止信号" class="headerlink" title="三种终止信号"></a>三种终止信号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">flux.subscribe(<br>    data -&gt; &#123; &#125;,           <span class="hljs-comment">// onNext: 收到数据</span><br>    error -&gt; &#123; &#125;,          <span class="hljs-comment">// onError: 发生错误，流终止</span><br>    () -&gt; &#123; &#125;              <span class="hljs-comment">// onComplete: 正常完成，流终止</span><br>);<br></code></pre></td></tr></table></figure><h3 id="谁发送终止信号？"><a href="#谁发送终止信号？" class="headerlink" title="谁发送终止信号？"></a>谁发送终止信号？</h3><p><strong>上游（生产者）决定何时结束</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 示例1：静态数据 - 发完就结束</span><br>Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);<br><span class="hljs-comment">// 内部：onNext(1), onNext(2), onNext(3), onComplete()</span><br><br><span class="hljs-comment">// 示例2：HTTP 响应 - 服务端关闭连接时结束</span><br>webClient.get().retrieve().bodyToFlux(String.class);<br><span class="hljs-comment">// 内部：onNext(chunk1), onNext(chunk2), ..., onComplete()</span><br><br><span class="hljs-comment">// 示例3：无限流 - 永不结束（除非出错或取消）</span><br>Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>));<br><span class="hljs-comment">// 内部：onNext(0), onNext(1), onNext(2), ... (永远继续)</span><br><br><span class="hljs-comment">// 示例4：手动控制 - 你决定何时结束</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().unicast().onBackpressureBuffer();<br>sink.tryEmitNext(<span class="hljs-string">&quot;a&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;b&quot;</span>);<br>sink.tryEmitComplete();  <span class="hljs-comment">// 你决定结束</span><br></code></pre></td></tr></table></figure><hr><h2 id="对比：什么时候用-Flux，什么时候用-Sinks"><a href="#对比：什么时候用-Flux，什么时候用-Sinks" class="headerlink" title="对比：什么时候用 Flux，什么时候用 Sinks"></a>对比：什么时候用 Flux，什么时候用 Sinks</h2><h3 id="你是消费者-→-用-Flux"><a href="#你是消费者-→-用-Flux" class="headerlink" title="你是消费者 → 用 Flux"></a>你是消费者 → 用 Flux</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：调用别人的 API，接收数据</span><br>Flux&lt;String&gt; response = callExternalAPI();<br>response.subscribe(data -&gt; process(data));<br><br><span class="hljs-comment">// 场景：从数据库查询</span><br>Flux&lt;User&gt; users = userRepository.findAll();<br><br><span class="hljs-comment">// 场景：读取文件</span><br>Flux&lt;String&gt; lines = readFileLines(path);<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：数据由别人产生，你只需要接收和处理。</p><h3 id="你是生产者-→-用-Sinks"><a href="#你是生产者-→-用-Sinks" class="headerlink" title="你是生产者 → 用 Sinks"></a>你是生产者 → 用 Sinks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 场景：WebSocket 服务端，主动推送消息</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 在某个事件触发时发送数据</span><br><span class="hljs-meta">@EventListener</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onUserLogin</span><span class="hljs-params">(UserLoginEvent event)</span> &#123;<br>    sink.tryEmitNext(<span class="hljs-string">&quot;用户 &quot;</span> + event.getUsername() + <span class="hljs-string">&quot; 登录了&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">// 客户端订阅这个流</span><br><span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getNotifications</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> sink.asFlux();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>特点</strong>：数据由你产生，你需要主动推送。</p><h3 id="对比表"><a href="#对比表" class="headerlink" title="对比表"></a>对比表</h3><table><thead><tr><th>场景</th><th>角色</th><th>使用</th><th>数据来源</th></tr></thead><tbody><tr><td>调用 HTTP API</td><td>消费者</td><td>Flux</td><td>服务端返回</td></tr><tr><td>查询数据库</td><td>消费者</td><td>Flux</td><td>数据库返回</td></tr><tr><td>读取消息队列</td><td>消费者</td><td>Flux</td><td>队列推送</td></tr><tr><td>WebSocket 推送</td><td>生产者</td><td>Sinks</td><td>你主动发送</td></tr><tr><td>事件广播</td><td>生产者</td><td>Sinks</td><td>你主动发送</td></tr><tr><td>封装回调 API</td><td>生产者</td><td>Sinks</td><td>回调触发时发送</td></tr></tbody></table><hr><h2 id="深入理解：懒加载与订阅"><a href="#深入理解：懒加载与订阅" class="headerlink" title="深入理解：懒加载与订阅"></a>深入理解：懒加载与订阅</h2><h3 id="Flux-是懒加载的"><a href="#Flux-是懒加载的" class="headerlink" title="Flux 是懒加载的"></a>Flux 是懒加载的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 这行代码执行时，并没有真正调用 API</span><br>Flux&lt;String&gt; flux = webClient.get().uri(<span class="hljs-string">&quot;/api&quot;</span>).retrieve().bodyToFlux(String.class);<br>System.out.println(<span class="hljs-string">&quot;Flux 创建完成&quot;</span>);<br><br><span class="hljs-comment">// 只有订阅时，才真正发起请求</span><br>flux.subscribe(data -&gt; System.out.println(<span class="hljs-string">&quot;收到: &quot;</span> + data));<br>System.out.println(<span class="hljs-string">&quot;订阅完成&quot;</span>);<br><br><span class="hljs-comment">// 输出顺序：</span><br><span class="hljs-comment">// Flux 创建完成</span><br><span class="hljs-comment">// 订阅完成</span><br><span class="hljs-comment">// 收到: xxx（异步，稍后输出）</span><br></code></pre></td></tr></table></figure><h3 id="每次订阅都是独立的"><a href="#每次订阅都是独立的" class="headerlink" title="每次订阅都是独立的"></a>每次订阅都是独立的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;String&gt; flux = webClient.get().uri(<span class="hljs-string">&quot;/api/random&quot;</span>).retrieve().bodyToFlux(String.class);<br><br><span class="hljs-comment">// 第一次订阅 - 发起第一次请求</span><br>flux.subscribe(data -&gt; System.out.println(<span class="hljs-string">&quot;订阅1: &quot;</span> + data));<br><br><span class="hljs-comment">// 第二次订阅 - 发起第二次请求（独立的）</span><br>flux.subscribe(data -&gt; System.out.println(<span class="hljs-string">&quot;订阅2: &quot;</span> + data));<br><br><span class="hljs-comment">// 两次订阅可能收到不同的数据！</span><br></code></pre></td></tr></table></figure><h3 id="冷流-vs-热流"><a href="#冷流-vs-热流" class="headerlink" title="冷流 vs 热流"></a>冷流 vs 热流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 冷流：每个订阅者都从头开始</span><br>Flux&lt;Integer&gt; cold = Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);<br>cold.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;A: &quot;</span> + i));  <span class="hljs-comment">// A: 1, 2, 3</span><br>cold.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;B: &quot;</span> + i));  <span class="hljs-comment">// B: 1, 2, 3</span><br><br><span class="hljs-comment">// 热流：订阅者共享数据流</span><br>Sinks.Many&lt;Integer&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br>Flux&lt;Integer&gt; hot = sink.asFlux();<br><br>hot.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;A: &quot;</span> + i));<br>sink.tryEmitNext(<span class="hljs-number">1</span>);  <span class="hljs-comment">// A: 1</span><br>hot.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;B: &quot;</span> + i));<br>sink.tryEmitNext(<span class="hljs-number">2</span>);  <span class="hljs-comment">// A: 2, B: 2（B 没收到 1）</span><br></code></pre></td></tr></table></figure><hr><h2 id="实战：大模型流式调用完整示例"><a href="#实战：大模型流式调用完整示例" class="headerlink" title="实战：大模型流式调用完整示例"></a>实战：大模型流式调用完整示例</h2><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/chat&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WebClient webClient;<br>    <br>    <span class="hljs-meta">@GetMapping(produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String prompt)</span> &#123;<br>        <span class="hljs-keyword">return</span> webClient.post()<br>            .uri(<span class="hljs-string">&quot;https://api.openai.com/v1/chat/completions&quot;</span>)<br>            .header(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Bearer &quot;</span> + apiKey)<br>            .bodyValue(Map.of(<br>                <span class="hljs-string">&quot;model&quot;</span>, <span class="hljs-string">&quot;gpt-4&quot;</span>,<br>                <span class="hljs-string">&quot;messages&quot;</span>, List.of(Map.of(<span class="hljs-string">&quot;role&quot;</span>, <span class="hljs-string">&quot;user&quot;</span>, <span class="hljs-string">&quot;content&quot;</span>, prompt)),<br>                <span class="hljs-string">&quot;stream&quot;</span>, <span class="hljs-literal">true</span><br>            ))<br>            .retrieve()<br>            .bodyToFlux(String.class)<br>            .filter(line -&gt; !line.equals(<span class="hljs-string">&quot;[DONE]&quot;</span>))<br>            .map(<span class="hljs-built_in">this</span>::extractContent)<br>            .filter(Objects::nonNull)<br>            .doOnNext(chunk -&gt; log.debug(<span class="hljs-string">&quot;发送: &#123;&#125;&quot;</span>, chunk))<br>            .doOnComplete(() -&gt; log.info(<span class="hljs-string">&quot;流式响应完成&quot;</span>))<br>            .doOnError(e -&gt; log.error(<span class="hljs-string">&quot;流式响应错误&quot;</span>, e));<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractContent</span><span class="hljs-params">(String line)</span> &#123;<br>        <span class="hljs-comment">// 解析 SSE 数据，提取内容</span><br>        <span class="hljs-comment">// data: &#123;&quot;choices&quot;:[&#123;&quot;delta&quot;:&#123;&quot;content&quot;:&quot;你好&quot;&#125;&#125;]&#125;</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">JsonNode</span> <span class="hljs-variable">node</span> <span class="hljs-operator">=</span> objectMapper.readTree(line.substring(<span class="hljs-number">6</span>));<br>            <span class="hljs-keyword">return</span> node.at(<span class="hljs-string">&quot;/choices/0/delta/content&quot;</span>).asText(<span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="前端接收"><a href="#前端接收" class="headerlink" title="前端接收"></a>前端接收</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 使用 EventSource 接收 SSE</span><br><span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">&#x27;/api/chat?prompt=你好&#x27;</span>);<br><br>eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// 逐字显示</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;response&#x27;</span>).<span class="hljs-property">textContent</span> += event.<span class="hljs-property">data</span>;<br>&#125;;<br><br>eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>    eventSource.<span class="hljs-title function_">close</span>();<br>&#125;;<br><br><span class="hljs-comment">// 或者使用 fetch</span><br><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/chat?prompt=你好&#x27;</span>);<br><span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();<br><span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();<br><br><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; done, value &#125; = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();<br>    <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">const</span> chunk = decoder.<span class="hljs-title function_">decode</span>(value);<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;response&#x27;</span>).<span class="hljs-property">textContent</span> += chunk;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Flux 是管道</strong></td><td>数据流经管道，不存储在管道中</td></tr><tr><td><strong>数据何时确定</strong></td><td>取决于上游，可能创建时确定，也可能运行时才知道</td></tr><tr><td><strong>数据数量</strong></td><td>由上游决定，下游不需要提前知道</td></tr><tr><td><strong>流何时结束</strong></td><td>上游发送 <code>onComplete()</code> 或 <code>onError()</code></td></tr><tr><td><strong>懒加载</strong></td><td>创建 Flux 不执行，订阅时才执行</td></tr><tr><td><strong>Sinks 的作用</strong></td><td>让你成为上游，主动推送数据</td></tr></tbody></table><p><strong>核心理解</strong>：</p><ul><li>Flux 不是”装了多少数据”，而是”数据从哪来、往哪去”</li><li>你不需要知道 Flux 里有多少数据，只需要处理流过来的每一个数据</li><li>这就是响应式编程的核心思想：<strong>对数据流做出响应</strong></li></ul><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Sinks 详解</li><li>Project Reactor 实现</li><li>WebFlux - Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>Flux</tag>
      
      <tag>管道</tag>
      
      <tag>懒加载</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Java引用类型</title>
    <link href="/2026/01/10/Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/"/>
    <url>/2026/01/10/Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Java-引用类型"><a href="#Java-引用类型" class="headerlink" title="Java 引用类型"></a>Java 引用类型</h1><blockquote><p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 ThreadLocal原理-弱引用设计</p></blockquote><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java 从 JDK 1.2 开始提供了四种引用类型，用于更灵活地控制对象的生命周期和垃圾回收行为。</p><h2 id="四种引用类型"><a href="#四种引用类型" class="headerlink" title="四种引用类型"></a>四种引用类型</h2><table><thead><tr><th>引用类型</th><th>类</th><th>GC 回收时机</th><th>是否可获取对象</th></tr></thead><tbody><tr><td><strong>强引用</strong></td><td>直接引用</td><td>永不回收（除非不可达）</td><td>是</td></tr><tr><td><strong>软引用</strong></td><td><code>SoftReference</code></td><td>内存不足时回收</td><td>是（未回收前）</td></tr><tr><td><strong>弱引用</strong></td><td><code>WeakReference</code></td><td>下次 GC 时回收</td><td>是（未回收前）</td></tr><tr><td><strong>虚引用</strong></td><td><code>PhantomReference</code></td><td>随时可能回收</td><td>否</td></tr></tbody></table><p>^ref-types</p><pre><code class=" mermaid">graph TD    A[引用强度] --&gt; B[强引用 Strong]    B --&gt; C[软引用 Soft]    C --&gt; D[弱引用 Weak]    D --&gt; E[虚引用 Phantom]        style B fill:#ff6b6b    style C fill:#feca57    style D fill:#48dbfb    style E fill:#c8d6e5</code></pre><h2 id="详细说明"><a href="#详细说明" class="headerlink" title="详细说明"></a>详细说明</h2><h3 id="1-强引用（Strong-Reference）"><a href="#1-强引用（Strong-Reference）" class="headerlink" title="1. 强引用（Strong Reference）"></a>1. 强引用（Strong Reference）</h3><p>最常见的引用类型，只要强引用存在，对象就不会被 GC 回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();  <span class="hljs-comment">// 强引用</span><br>obj = <span class="hljs-literal">null</span>;                 <span class="hljs-comment">// 断开引用后才可能被回收</span><br></code></pre></td></tr></table></figure><p><strong>特点</strong>：</p><ul><li>默认的引用类型</li><li>即使 OOM 也不会回收强引用对象</li><li>需要手动置 null 才能让 GC 回收</li></ul><h3 id="2-软引用（Soft-Reference）"><a href="#2-软引用（Soft-Reference）" class="headerlink" title="2. 软引用（Soft Reference）"></a>2. 软引用（Soft Reference）</h3><p>内存充足时不会回收，内存不足时会被回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">SoftReference&lt;<span class="hljs-type">byte</span>[]&gt; softRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SoftReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>]);<br><br><span class="hljs-type">byte</span>[] data = softRef.get();  <span class="hljs-comment">// 获取对象，可能为 null</span><br><span class="hljs-keyword">if</span> (data == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// 对象已被回收，需要重新创建</span><br>    data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>应用场景</strong>：</p><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>缓存</strong></td><td>图片缓存、网页缓存</td></tr><tr><td><strong>内存敏感数据</strong></td><td>可重建的大对象</td></tr></tbody></table><h3 id="3-弱引用（Weak-Reference）"><a href="#3-弱引用（Weak-Reference）" class="headerlink" title="3. 弱引用（Weak Reference）"></a>3. 弱引用（Weak Reference）</h3><p>只要发生 GC，无论内存是否充足，都会被回收。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">WeakReference&lt;Object&gt; weakRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>());<br><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> weakRef.get();  <span class="hljs-comment">// 可能返回 null</span><br><span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// 对象已被 GC 回收</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>弱引用解决的问题</strong>：</p><blockquote><p><strong>⚠️ 重要: 核心价值</strong><br>弱引用允许对象在没有其他强引用时被 GC 回收，<strong>避免内存泄漏</strong>。</p></blockquote><p>以 ThreadLocal 为例：</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss">ThreadLocalMap.Entry 的 <span class="hljs-built_in">key</span> 使用弱引用<br><br>场景：ThreadLocal 变量不再使用<br>├── 如果 <span class="hljs-built_in">key</span> 是强引用 → ThreadLocal 对象无法回收 → 内存泄漏<br>└── 如果 <span class="hljs-built_in">key</span> 是弱引用 → ThreadLocal 对象可被 GC 回收 → 避免泄漏<br></code></pre></td></tr></table></figure><p><strong>应用场景</strong>：</p><table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td><strong>ThreadLocalMap</strong></td><td>Entry 的 key 使用弱引用</td></tr><tr><td><strong>WeakHashMap</strong></td><td>key 被回收后自动移除 entry</td></tr><tr><td><strong>监听器&#x2F;回调</strong></td><td>避免因注册监听器导致对象无法回收</td></tr></tbody></table><h3 id="4-虚引用（Phantom-Reference）"><a href="#4-虚引用（Phantom-Reference）" class="headerlink" title="4. 虚引用（Phantom Reference）"></a>4. 虚引用（Phantom Reference）</h3><p>最弱的引用，无法通过虚引用获取对象，主要用于跟踪对象被回收的状态。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">ReferenceQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br>PhantomReference&lt;Object&gt; phantomRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhantomReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(), queue);<br><br><span class="hljs-comment">// get() 永远返回 null</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> phantomRef.get();  <span class="hljs-comment">// null</span><br><br><span class="hljs-comment">// 对象被回收后，虚引用会被放入队列</span><br>Reference&lt;?&gt; ref = queue.poll();<br><span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// 对象已被回收，执行清理操作</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>应用场景</strong>：</p><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>资源清理</strong></td><td>替代 finalize() 进行资源释放</td></tr><tr><td><strong>堆外内存管理</strong></td><td>DirectByteBuffer 的 Cleaner 机制</td></tr><tr><td><strong>对象回收监控</strong></td><td>跟踪对象何时被 GC 回收</td></tr></tbody></table><h2 id="引用队列（ReferenceQueue）"><a href="#引用队列（ReferenceQueue）" class="headerlink" title="引用队列（ReferenceQueue）"></a>引用队列（ReferenceQueue）</h2><p>软引用、弱引用、虚引用都可以关联引用队列，当对象被回收时，引用对象会被放入队列。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">ReferenceQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceQueue</span>&lt;&gt;();<br>WeakReference&lt;Object&gt; weakRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>(), queue);<br><br><span class="hljs-comment">// GC 后检查队列</span><br>System.gc();<br>Reference&lt;?&gt; ref = queue.poll();<br><span class="hljs-keyword">if</span> (ref == weakRef) &#123;<br>    <span class="hljs-comment">// 弱引用指向的对象已被回收</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h2><table><thead><tr><th>特性</th><th>强引用</th><th>软引用</th><th>弱引用</th><th>虚引用</th></tr></thead><tbody><tr><td><strong>回收时机</strong></td><td>不可达时</td><td>内存不足时</td><td>GC 时</td><td>随时</td></tr><tr><td><strong>get() 返回</strong></td><td>对象</td><td>对象&#x2F;null</td><td>对象&#x2F;null</td><td>null</td></tr><tr><td><strong>典型用途</strong></td><td>普通对象</td><td>缓存</td><td>避免内存泄漏</td><td>回收跟踪</td></tr><tr><td><strong>是否需要队列</strong></td><td>-</td><td>可选</td><td>可选</td><td>必须</td></tr></tbody></table><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Java&#x2F;并发编程&#x2F;基础知识&#x2F;ThreadLocal原理 - 衍生来源，弱引用的典型应用</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>引用类型</tag>
      
      <tag>GC</tag>
      
      <tag>内存管理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ForkJoinPool</title>
    <link href="/2026/01/10/ForkJoinPool/"/>
    <url>/2026/01/10/ForkJoinPool/</url>
    
    <content type="html"><![CDATA[<h1 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h1><blockquote><p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 线程池类型-WorkStealingPool</p></blockquote><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>ForkJoinPool</code> 是 Java 7 引入的特殊线程池，专为<strong>分治算法</strong>和<strong>并行计算</strong>设计。它是 <code>ExecutorService</code> 的实现，但采用了完全不同的任务调度策略。</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">┌────────────────────────────────────────────────────────────────┐</span><br><span class="hljs-attribute">│                        ForkJoinPool                            │</span><br><span class="hljs-attribute">├────────────────────────────────────────────────────────────────┤</span><br><span class="hljs-attribute">│  核心思想</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Fork（拆分） + Join（合并）                          │</span><br><span class="hljs-attribute">│  调度策略</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Work-Stealing（工作窃取）                            │</span><br><span class="hljs-attribute">│  适用场景</span><span class="hljs-punctuation">:</span> <span class="hljs-string">递归任务、并行计算、分治算法                          │</span><br>└────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="Fork-与-Join"><a href="#Fork-与-Join" class="headerlink" title="Fork 与 Join"></a>Fork 与 Join</h3><table><thead><tr><th>操作</th><th>说明</th><th>方法</th></tr></thead><tbody><tr><td><strong>Fork</strong></td><td>将大任务拆分成小任务，异步执行</td><td><code>task.fork()</code></td></tr><tr><td><strong>Join</strong></td><td>等待子任务完成，获取结果</td><td><code>task.join()</code></td></tr></tbody></table><h3 id="分治思想图解"><a href="#分治思想图解" class="headerlink" title="分治思想图解"></a>分治思想图解</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl">            ┌─────────────┐<br>            │   大任务    │<br>            └──────┬──────┘<br>                   │ <span class="hljs-keyword">fork</span><br>      ┌────────────┼────────────┐<br>      ▼            ▼            ▼<br>┌─────────┐  ┌─────────┐  ┌─────────┐<br>│ 子任务<span class="hljs-number">1</span> │  │ 子任务<span class="hljs-number">2</span> │  │ 子任务<span class="hljs-number">3</span> │<br>└────┬────┘  └────┬────┘  └────┬────┘<br>     │            │            │<br>     ▼            ▼            ▼<br>┌─────────┐  ┌─────────┐  ┌─────────┐<br>│ 结果<span class="hljs-number">1</span>   │  │ 结果<span class="hljs-number">2</span>   │  │ 结果<span class="hljs-number">3</span>   │<br>└────┬────┘  └────┬────┘  └────┬────┘<br>     │            │            │<br>     └────────────┼────────────┘<br>                  │ <span class="hljs-keyword">join</span><br>            ┌─────┴─────┐<br>            │  合并结果  │<br>            └───────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="工作窃取算法（Work-Stealing）"><a href="#工作窃取算法（Work-Stealing）" class="headerlink" title="工作窃取算法（Work-Stealing）"></a>工作窃取算法（Work-Stealing）</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>每个工作线程维护一个<strong>双端队列（Deque）</strong>：</p><ul><li><strong>自己的任务</strong>：从队列<strong>头部</strong>取（LIFO）</li><li><strong>窃取他人任务</strong>：从队列<strong>尾部</strong>取（FIFO）</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs css">┌─────────────────────────────────────────────────────────────────┐<br>│                     ForkJoinPool                                │<br>│                                                                 │<br>│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │<br>│  │  Worker-<span class="hljs-number">1</span>   │    │  Worker-<span class="hljs-number">2</span>   │    │  Worker-<span class="hljs-number">3</span>   │         │<br>│  ├─────────────┤    ├─────────────┤    ├─────────────┤         │<br>│  │ 头 <span class="hljs-selector-attr">[T1]</span>     │    │ 头 <span class="hljs-selector-attr">[T4]</span>     │    │ 头 <span class="hljs-selector-attr">[空闲]</span>   │         │<br>│  │    <span class="hljs-selector-attr">[T2]</span>     │    │    <span class="hljs-selector-attr">[T5]</span>     │    │             │         │<br>│  │    <span class="hljs-selector-attr">[T3]</span>     │    │             │    │             │         │<br>│  │ 尾          │    │ 尾          │    │ 尾    ↑     │         │<br>│  └─────────────┘    └─────────────┘    └──────┼──────┘         │<br>│         │                  │                  │                │<br>│         │                  └──────────────────┘                │<br>│         │                    Worker-<span class="hljs-number">3</span> 从 Worker-<span class="hljs-number">2</span> 尾部窃取 T5   │<br>└─────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="为什么从尾部窃取？"><a href="#为什么从尾部窃取？" class="headerlink" title="为什么从尾部窃取？"></a>为什么从尾部窃取？</h3><table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>减少竞争</strong></td><td>工作线程从头部取，窃取从尾部，避免锁争用</td></tr><tr><td><strong>任务特性</strong></td><td>尾部通常是较大的任务（刚 fork 出来的），窃取后可继续拆分</td></tr><tr><td><strong>局部性</strong></td><td>头部任务是最近提交的，缓存友好</td></tr></tbody></table><hr><h2 id="核心类结构"><a href="#核心类结构" class="headerlink" title="核心类结构"></a>核心类结构</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌───────────────────────────────────────┐<br>│          ForkJoinTask&lt;V&gt;              │  抽象基类<br>│  ├── <span class="hljs-built_in">fork</span>()    异步执行               │<br>│  ├── <span class="hljs-built_in">join</span>()    等待结果               │<br>│  └── <span class="hljs-built_in">invoke</span>()  同步执行               │<br>└───────────────┬───────────────────────┘<br>                │<br>        ┌───────┴───────┐<br>        ▼               ▼<br>┌───────────────┐ ┌─────────────────┐<br>│RecursiveTask  │ │ RecursiveAction │<br>│   &lt;V&gt;         │ │                 │<br>├───────────────┤ ├─────────────────┤<br>│ 有返回值      │ │ 无返回值        │<br>│ <span class="hljs-built_in">compute</span>()→V   │ │ <span class="hljs-built_in">compute</span>()→void  │<br>└───────────────┘ └─────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><h3 id="1-RecursiveTask：有返回值（数组求和）"><a href="#1-RecursiveTask：有返回值（数组求和）" class="headerlink" title="1. RecursiveTask：有返回值（数组求和）"></a>1. RecursiveTask：有返回值（数组求和）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SumTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecursiveTask</span>&lt;Long&gt; &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 阈值</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span>[] array;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> start;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> end;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SumTask</span><span class="hljs-params">(<span class="hljs-type">long</span>[] array, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>        <span class="hljs-built_in">this</span>.array = array;<br>        <span class="hljs-built_in">this</span>.start = start;<br>        <span class="hljs-built_in">this</span>.end = end;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Long <span class="hljs-title function_">compute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> end - start;<br>        <br>        <span class="hljs-comment">// 任务足够小，直接计算</span><br>        <span class="hljs-keyword">if</span> (length &lt;= THRESHOLD) &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> start; i &lt; end; i++) &#123;<br>                sum += array[i];<br>            &#125;<br>            <span class="hljs-keyword">return</span> sum;<br>        &#125;<br>        <br>        <span class="hljs-comment">// 拆分任务</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> start + length / <span class="hljs-number">2</span>;<br>        <span class="hljs-type">SumTask</span> <span class="hljs-variable">leftTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SumTask</span>(array, start, mid);<br>        <span class="hljs-type">SumTask</span> <span class="hljs-variable">rightTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SumTask</span>(array, mid, end);<br>        <br>        <span class="hljs-comment">// 异步执行左半部分</span><br>        leftTask.fork();<br>        <br>        <span class="hljs-comment">// 同步执行右半部分（当前线程）</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">rightResult</span> <span class="hljs-operator">=</span> rightTask.compute();<br>        <br>        <span class="hljs-comment">// 等待左半部分完成并合并结果</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">leftResult</span> <span class="hljs-operator">=</span> leftTask.join();<br>        <br>        <span class="hljs-keyword">return</span> leftResult + rightResult;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 使用</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-type">long</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-title class_">long</span>[<span class="hljs-number">10000000</span>];<br>    Arrays.fill(array, <span class="hljs-number">1</span>);<br>    <br>    <span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ForkJoinPool.commonPool();<br>    <span class="hljs-type">SumTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SumTask</span>(array, <span class="hljs-number">0</span>, array.length);<br>    <br>    <span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pool.invoke(task);  <span class="hljs-comment">// 同步执行</span><br>    System.out.println(<span class="hljs-string">&quot;Sum: &quot;</span> + result);  <span class="hljs-comment">// 输出: Sum: 10000000</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-RecursiveAction：无返回值（并行排序）"><a href="#2-RecursiveAction：无返回值（并行排序）" class="headerlink" title="2. RecursiveAction：无返回值（并行排序）"></a>2. RecursiveAction：无返回值（并行排序）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelMergeSort</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecursiveAction</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] array;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> start;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> end;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ParallelMergeSort</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> end)</span> &#123;<br>        <span class="hljs-built_in">this</span>.array = array;<br>        <span class="hljs-built_in">this</span>.start = start;<br>        <span class="hljs-built_in">this</span>.end = end;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">compute</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (end - start &lt;= THRESHOLD) &#123;<br>            <span class="hljs-comment">// 小数组直接用 Arrays.sort</span><br>            Arrays.sort(array, start, end);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <br>        <span class="hljs-type">int</span> <span class="hljs-variable">mid</span> <span class="hljs-operator">=</span> (start + end) / <span class="hljs-number">2</span>;<br>        <br>        <span class="hljs-comment">// 并行排序两半</span><br>        <span class="hljs-type">ParallelMergeSort</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParallelMergeSort</span>(array, start, mid);<br>        <span class="hljs-type">ParallelMergeSort</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ParallelMergeSort</span>(array, mid, end);<br>        <br>        invokeAll(left, right);  <span class="hljs-comment">// 并行执行两个任务</span><br>        <br>        <span class="hljs-comment">// 合并已排序的两半</span><br>        merge(array, start, mid, end);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">(<span class="hljs-type">int</span>[] array, <span class="hljs-type">int</span> start, <span class="hljs-type">int</span> mid, <span class="hljs-type">int</span> end)</span> &#123;<br>        <span class="hljs-comment">// 合并逻辑...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="ForkJoinPool-创建方式"><a href="#ForkJoinPool-创建方式" class="headerlink" title="ForkJoinPool 创建方式"></a>ForkJoinPool 创建方式</h2><h3 id="1-公共池（推荐）"><a href="#1-公共池（推荐）" class="headerlink" title="1. 公共池（推荐）"></a>1. 公共池（推荐）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取公共池（JVM 共享，线程数 = CPU核心数 - 1）</span><br><span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">commonPool</span> <span class="hljs-operator">=</span> ForkJoinPool.commonPool();<br><br><span class="hljs-comment">// 直接使用</span><br><span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> commonPool.invoke(task);<br></code></pre></td></tr></table></figure><h3 id="2-自定义池"><a href="#2-自定义池" class="headerlink" title="2. 自定义池"></a>2. 自定义池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 自定义线程数</span><br><span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">customPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<span class="hljs-number">4</span>);<br><br><span class="hljs-comment">// 完整构造函数</span><br><span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<br>    <span class="hljs-number">4</span>,                                    <span class="hljs-comment">// 并行度</span><br>    ForkJoinPool.defaultForkJoinWorkerThreadFactory,  <span class="hljs-comment">// 线程工厂</span><br>    <span class="hljs-literal">null</span>,                                 <span class="hljs-comment">// 异常处理器</span><br>    <span class="hljs-literal">true</span>                                  <span class="hljs-comment">// asyncMode（true=FIFO，false=LIFO）</span><br>);<br></code></pre></td></tr></table></figure><h3 id="3-通过-Executors-工厂"><a href="#3-通过-Executors-工厂" class="headerlink" title="3. 通过 Executors 工厂"></a>3. 通过 Executors 工厂</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Java 8+ WorkStealingPool 底层就是 ForkJoinPool</span><br><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newWorkStealingPool();<br></code></pre></td></tr></table></figure><hr><h2 id="提交任务的方式"><a href="#提交任务的方式" class="headerlink" title="提交任务的方式"></a>提交任务的方式</h2><table><thead><tr><th>方法</th><th>说明</th><th>返回值</th></tr></thead><tbody><tr><td><code>invoke(task)</code></td><td>同步执行，阻塞直到完成</td><td>任务结果</td></tr><tr><td><code>execute(task)</code></td><td>异步执行，不等待结果</td><td>void</td></tr><tr><td><code>submit(task)</code></td><td>异步执行，返回 Future</td><td><code>ForkJoinTask&lt;V&gt;</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ForkJoinPool.commonPool();<br><span class="hljs-type">SumTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SumTask</span>(array, <span class="hljs-number">0</span>, array.length);<br><br><span class="hljs-comment">// 方式1：同步</span><br><span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pool.invoke(task);<br><br><span class="hljs-comment">// 方式2：异步提交</span><br>ForkJoinTask&lt;Long&gt; future = pool.submit(task);<br><span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get();  <span class="hljs-comment">// 阻塞等待</span><br><br><span class="hljs-comment">// 方式3：异步执行（不关心结果）</span><br>pool.execute(task);<br></code></pre></td></tr></table></figure><hr><h2 id="与普通线程池对比"><a href="#与普通线程池对比" class="headerlink" title="与普通线程池对比"></a>与普通线程池对比</h2><table><thead><tr><th>特性</th><th>ThreadPoolExecutor</th><th>ForkJoinPool</th></tr></thead><tbody><tr><td><strong>任务队列</strong></td><td>共享队列（单一）</td><td>每线程独立双端队列</td></tr><tr><td><strong>调度策略</strong></td><td>先进先出</td><td>工作窃取</td></tr><tr><td><strong>适用任务</strong></td><td>独立任务</td><td>可拆分的递归任务</td></tr><tr><td><strong>负载均衡</strong></td><td>依赖队列调度</td><td>工作窃取自动均衡</td></tr><tr><td><strong>CPU 利用</strong></td><td>可能有线程空闲</td><td>更高效（减少空闲）</td></tr><tr><td><strong>任务粒度</strong></td><td>任意</td><td>适合可拆分任务</td></tr></tbody></table><hr><h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><h3 id="1-Java-8-并行流"><a href="#1-Java-8-并行流" class="headerlink" title="1. Java 8 并行流"></a>1. Java 8 并行流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// parallelStream() 底层使用 ForkJoinPool.commonPool()</span><br>List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);<br><br><span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> numbers.parallelStream()<br>                 .mapToInt(Integer::intValue)<br>                 .sum();<br></code></pre></td></tr></table></figure><h3 id="2-CompletableFuture-默认执行器"><a href="#2-CompletableFuture-默认执行器" class="headerlink" title="2. CompletableFuture 默认执行器"></a>2. CompletableFuture 默认执行器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 默认使用 ForkJoinPool.commonPool()</span><br>CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello&quot;</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="3-大数据处理"><a href="#3-大数据处理" class="headerlink" title="3. 大数据处理"></a>3. 大数据处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 并行处理大量数据</span><br>Arrays.parallelSort(largeArray);<br>Arrays.parallelSetAll(array, i -&gt; i * <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><hr><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="1-阈值设置"><a href="#1-阈值设置" class="headerlink" title="1. 阈值设置"></a>1. 阈值设置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 阈值太小：拆分开销 &gt; 并行收益</span><br><span class="hljs-comment">// 阈值太大：无法充分利用多核</span><br><span class="hljs-comment">// 经验值：根据任务复杂度和数据量测试确定</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">THRESHOLD</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 需要根据实际情况调整</span><br></code></pre></td></tr></table></figure><h3 id="2-避免阻塞操作"><a href="#2-避免阻塞操作" class="headerlink" title="2. 避免阻塞操作"></a>2. 避免阻塞操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ❌ 错误：在 ForkJoinPool 中执行阻塞 IO</span><br><span class="hljs-keyword">protected</span> Long <span class="hljs-title function_">compute</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 不要在这里做 IO 操作！</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> httpClient.get(url);  <span class="hljs-comment">// 阻塞，浪费线程</span><br>    <span class="hljs-keyword">return</span> process(data);<br>&#125;<br><br><span class="hljs-comment">// ✅ 正确：ForkJoinPool 只用于 CPU 计算</span><br><span class="hljs-comment">// IO 操作使用其他线程池</span><br></code></pre></td></tr></table></figure><h3 id="3-公共池的风险"><a href="#3-公共池的风险" class="headerlink" title="3. 公共池的风险"></a>3. 公共池的风险</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 所有并行流共享 commonPool</span><br><span class="hljs-comment">// 如果某个任务阻塞，会影响其他任务</span><br><br><span class="hljs-comment">// 解决方案：为关键任务创建独立的 ForkJoinPool</span><br><span class="hljs-type">ForkJoinPool</span> <span class="hljs-variable">customPool</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<span class="hljs-number">8</span>);<br>customPool.submit(() -&gt; &#123;<br>    <span class="hljs-comment">// 独立执行，不影响 commonPool</span><br>    myParallelStream.forEach(...);<br>&#125;).get();<br></code></pre></td></tr></table></figure><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li><strong>上一篇</strong>：03-线程池类型</li><li><strong>线程池原理</strong>：02-线程池原理</li><li><strong>线程池简介</strong>：01-线程池简介</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>线程池</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>线程池</tag>
      
      <tag>ForkJoinPool</tag>
      
      <tag>分治算法</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactive Streams规范</title>
    <link href="/2026/01/10/Reactive%20Streams%E8%A7%84%E8%8C%83/"/>
    <url>/2026/01/10/Reactive%20Streams%E8%A7%84%E8%8C%83/</url>
    
    <content type="html"><![CDATA[<h1 id="Reactive-Streams-规范"><a href="#Reactive-Streams-规范" class="headerlink" title="Reactive Streams 规范"></a>Reactive Streams 规范</h1><h2 id="什么是-Reactive-Streams"><a href="#什么是-Reactive-Streams" class="headerlink" title="什么是 Reactive Streams"></a>什么是 Reactive Streams</h2><p>Reactive Streams 是 JVM 上<strong>响应式编程的标准规范</strong>，定义了异步流处理的接口和协议。</p><ul><li><strong>发起者</strong>：Netflix、Pivotal、Lightbend、Twitter 等公司联合制定</li><li><strong>目标</strong>：解决异步数据流处理中的背压问题</li><li><strong>Java 9</strong>：已纳入 JDK，位于 <code>java.util.concurrent.Flow</code></li></ul><h2 id="四个核心接口"><a href="#四个核心接口" class="headerlink" title="四个核心接口"></a>四个核心接口</h2><p>Reactive Streams 只定义了 4 个接口，非常简洁：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 1. 发布者 - 数据的生产者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Publisher</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(Subscriber&lt;? <span class="hljs-built_in">super</span> T&gt; s)</span>;<br>&#125;<br><br><span class="hljs-comment">// 2. 订阅者 - 数据的消费者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(Subscription s)</span>;  <span class="hljs-comment">// 订阅成功</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(T t)</span>;                   <span class="hljs-comment">// 接收数据</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable t)</span>;          <span class="hljs-comment">// 发生错误</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">()</span>;                  <span class="hljs-comment">// 数据流结束</span><br>&#125;<br><br><span class="hljs-comment">// 3. 订阅关系 - 连接发布者和订阅者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subscription</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span>;  <span class="hljs-comment">// 请求 n 个数据（背压核心）</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>;         <span class="hljs-comment">// 取消订阅</span><br>&#125;<br><br><span class="hljs-comment">// 4. 处理器 - 既是订阅者又是发布者</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Processor</span>&lt;T, R&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="交互流程"><a href="#交互流程" class="headerlink" title="交互流程"></a>交互流程</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌──────────────┐                      ┌──────────────┐<br>│   Publisher  │                      │  Subscriber  │<br>└──────────────┘                      └──────────────┘<br>       │                                     │<br>       │  <span class="hljs-number">1</span>. <span class="hljs-built_in">subscribe</span>(subscriber)           │<br>       │ ──────────────────────────────────▶ │<br>       │                                     │<br>       │  <span class="hljs-number">2</span>. <span class="hljs-built_in">onSubscribe</span>(subscription)       │<br>       │ ◀────────────────────────────────── │<br>       │                                     │<br>       │  <span class="hljs-number">3</span>. <span class="hljs-built_in">request</span>(n) 请求n个数据          │<br>       │ ◀────────────────────────────────── │<br>       │                                     │<br>       │  <span class="hljs-number">4</span>. <span class="hljs-built_in">onNext</span>(data) 发送数据（最多n个）│<br>       │ ──────────────────────────────────▶ │<br>       │         ... 重复 <span class="hljs-number">3</span>-<span class="hljs-number">4</span> ...            │<br>       │                                     │<br>       │  <span class="hljs-number">5</span>. <span class="hljs-built_in">onComplete</span>() 或 <span class="hljs-built_in">onError</span>()       │<br>       │ ──────────────────────────────────▶ │<br>       ▼                                     ▼<br></code></pre></td></tr></table></figure><h2 id="背压（Backpressure）"><a href="#背压（Backpressure）" class="headerlink" title="背压（Backpressure）"></a>背压（Backpressure）</h2><p>背压是 Reactive Streams 的<strong>核心特性</strong>，解决生产者速度快于消费者的问题。</p><h3 id="没有背压的问题"><a href="#没有背压的问题" class="headerlink" title="没有背压的问题"></a>没有背压的问题</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">生产者：<span class="hljs-number">1000</span>条<span class="hljs-regexp">/秒  ──────▶  消费者：100条/</span>秒<br>                              ↓<br>                         内存溢出！<br></code></pre></td></tr></table></figure><h3 id="有背压的解决方案"><a href="#有背压的解决方案" class="headerlink" title="有背压的解决方案"></a>有背压的解决方案</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 消费者控制速度</span><br>subscription.request(<span class="hljs-number">10</span>);  <span class="hljs-comment">// 我只要10条</span><br><span class="hljs-comment">// 生产者最多发10条，然后等待下一次 request</span><br></code></pre></td></tr></table></figure><h3 id="背压协议规则"><a href="#背压协议规则" class="headerlink" title="背压协议规则"></a>背压协议规则</h3><ol><li><strong>Subscriber 主动请求</strong>：通过 <code>request(n)</code> 告诉 Publisher 需要多少数据</li><li><strong>Publisher 遵守约定</strong>：最多发送 n 个数据，不能超发</li><li><strong>累积请求</strong>：多次 <code>request()</code> 的数量会累加</li><li><strong>无限请求</strong>：<code>request(Long.MAX_VALUE)</code> 表示不限制</li></ol><h2 id="规范的实现"><a href="#规范的实现" class="headerlink" title="规范的实现"></a>规范的实现</h2><table><thead><tr><th>实现</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>Project Reactor</strong></td><td>Spring 默认实现</td><td>Spring WebFlux</td></tr><tr><td><strong>RxJava</strong></td><td>Netflix 开源</td><td>Android、通用</td></tr><tr><td><strong>Akka Streams</strong></td><td>Lightbend 开源</td><td>Scala 生态</td></tr><tr><td><strong>Java 9 Flow</strong></td><td>JDK 内置</td><td>标准库</td></tr></tbody></table><p>Spring 生态使用的是 <strong>Project Reactor</strong>，下一篇详细介绍。</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>下一篇：Project Reactor 实现</li><li>WebFlux - 响应式编程基础</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>背压</tag>
      
      <tag>Publisher</tag>
      
      <tag>Subscriber</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactor核心API</title>
    <link href="/2026/01/10/Reactor%E6%A0%B8%E5%BF%83API/"/>
    <url>/2026/01/10/Reactor%E6%A0%B8%E5%BF%83API/</url>
    
    <content type="html"><![CDATA[<h1 id="Reactor-核心-API"><a href="#Reactor-核心-API" class="headerlink" title="Reactor 核心 API"></a>Reactor 核心 API</h1><h2 id="什么是-Project-Reactor"><a href="#什么是-Project-Reactor" class="headerlink" title="什么是 Project Reactor"></a>什么是 Project Reactor</h2><p>Project Reactor 是 Spring WebFlux 默认使用的响应式库，它实现了 Reactive Streams 规范，提供了两个核心类型：<strong>Mono</strong> 和 <strong>Flux</strong>。</p><h2 id="Mono-单值容器"><a href="#Mono-单值容器" class="headerlink" title="Mono - 单值容器"></a>Mono - 单值容器</h2><p><code>Mono&lt;T&gt;</code> 表示<strong>0个或1个</strong>元素的异步序列。</p><h3 id="创建-Mono"><a href="#创建-Mono" class="headerlink" title="创建 Mono"></a>创建 Mono</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建包含值的 Mono</span><br>Mono&lt;String&gt; mono1 = Mono.just(<span class="hljs-string">&quot;Hello&quot;</span>);<br><br><span class="hljs-comment">// 创建空的 Mono</span><br>Mono&lt;String&gt; mono2 = Mono.empty();<br><br><span class="hljs-comment">// 创建错误的 Mono</span><br>Mono&lt;String&gt; mono3 = Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Error&quot;</span>));<br><br><span class="hljs-comment">// 延迟创建</span><br>Mono&lt;String&gt; mono4 = Mono.fromSupplier(() -&gt; <span class="hljs-string">&quot;Lazy Value&quot;</span>);<br><br><span class="hljs-comment">// 从 Callable 创建</span><br>Mono&lt;String&gt; mono5 = Mono.fromCallable(() -&gt; blockingCall());<br><br><span class="hljs-comment">// 从 Future 创建</span><br>Mono&lt;String&gt; mono6 = Mono.fromFuture(completableFuture);<br></code></pre></td></tr></table></figure><h3 id="Mono-常用操作"><a href="#Mono-常用操作" class="headerlink" title="Mono 常用操作"></a>Mono 常用操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono.just(<span class="hljs-string">&quot;Hello&quot;</span>)<br>    .map(s -&gt; s + <span class="hljs-string">&quot; World&quot;</span>)           <span class="hljs-comment">// 转换</span><br>    .flatMap(s -&gt; anotherMono(s))     <span class="hljs-comment">// 异步转换</span><br>    .filter(s -&gt; s.length() &gt; <span class="hljs-number">5</span>)      <span class="hljs-comment">// 过滤</span><br>    .defaultIfEmpty(<span class="hljs-string">&quot;Default&quot;</span>)         <span class="hljs-comment">// 默认值</span><br>    .switchIfEmpty(anotherMono)        <span class="hljs-comment">// 空时切换</span><br>    .doOnNext(s -&gt; log.info(s))        <span class="hljs-comment">// 副作用</span><br>    .doOnError(e -&gt; log.error(e))      <span class="hljs-comment">// 错误处理</span><br>    .subscribe();                       <span class="hljs-comment">// 订阅触发执行</span><br></code></pre></td></tr></table></figure><h2 id="Flux-多值容器"><a href="#Flux-多值容器" class="headerlink" title="Flux - 多值容器"></a>Flux - 多值容器</h2><p><code>Flux&lt;T&gt;</code> 表示<strong>0到N个</strong>元素的异步序列。</p><h3 id="创建-Flux"><a href="#创建-Flux" class="headerlink" title="创建 Flux"></a>创建 Flux</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 从多个值创建</span><br>Flux&lt;String&gt; flux1 = Flux.just(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>);<br><br><span class="hljs-comment">// 从数组创建</span><br>Flux&lt;String&gt; flux2 = Flux.fromArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>&#125;);<br><br><span class="hljs-comment">// 从集合创建</span><br>Flux&lt;String&gt; flux3 = Flux.fromIterable(Arrays.asList(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>));<br><br><span class="hljs-comment">// 创建范围</span><br>Flux&lt;Integer&gt; flux4 = Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>);  <span class="hljs-comment">// 1到10</span><br><br><span class="hljs-comment">// 创建空 Flux</span><br>Flux&lt;String&gt; flux5 = Flux.empty();<br><br><span class="hljs-comment">// 定时发射</span><br>Flux&lt;Long&gt; flux6 = Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>));<br><br><span class="hljs-comment">// 从 Stream 创建</span><br>Flux&lt;String&gt; flux7 = Flux.fromStream(Stream.of(<span class="hljs-string">&quot;A&quot;</span>, <span class="hljs-string">&quot;B&quot;</span>, <span class="hljs-string">&quot;C&quot;</span>));<br></code></pre></td></tr></table></figure><h3 id="Flux-常用操作"><a href="#Flux-常用操作" class="headerlink" title="Flux 常用操作"></a>Flux 常用操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>    .map(i -&gt; i * <span class="hljs-number">2</span>)                   <span class="hljs-comment">// 转换每个元素</span><br>    .filter(i -&gt; i &gt; <span class="hljs-number">5</span>)                <span class="hljs-comment">// 过滤</span><br>    .take(<span class="hljs-number">5</span>)                           <span class="hljs-comment">// 只取前5个</span><br>    .skip(<span class="hljs-number">2</span>)                           <span class="hljs-comment">// 跳过前2个</span><br>    .distinct()                        <span class="hljs-comment">// 去重</span><br>    .sort()                            <span class="hljs-comment">// 排序</span><br>    .collectList()                     <span class="hljs-comment">// 收集为 Mono&lt;List&gt;</span><br>    .subscribe();<br></code></pre></td></tr></table></figure><h2 id="核心操作符分类"><a href="#核心操作符分类" class="headerlink" title="核心操作符分类"></a>核心操作符分类</h2><h3 id="转换操作符"><a href="#转换操作符" class="headerlink" title="转换操作符"></a>转换操作符</h3><table><thead><tr><th>操作符</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>map</code></td><td>同步转换</td><td><code>flux.map(i -&gt; i * 2)</code></td></tr><tr><td><code>flatMap</code></td><td>异步转换（不保序）</td><td><code>flux.flatMap(i -&gt; getMono(i))</code></td></tr><tr><td><code>flatMapSequential</code></td><td>异步转换（保序）</td><td><code>flux.flatMapSequential(...)</code></td></tr><tr><td><code>concatMap</code></td><td>顺序异步转换</td><td><code>flux.concatMap(...)</code></td></tr><tr><td><code>switchMap</code></td><td>切换到新流</td><td><code>flux.switchMap(...)</code></td></tr></tbody></table><h3 id="过滤操作符"><a href="#过滤操作符" class="headerlink" title="过滤操作符"></a>过滤操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br>    .filter(i -&gt; i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)      <span class="hljs-comment">// 过滤偶数</span><br>    .take(<span class="hljs-number">10</span>)                      <span class="hljs-comment">// 取前10个</span><br>    .takeLast(<span class="hljs-number">5</span>)                   <span class="hljs-comment">// 取后5个</span><br>    .takeWhile(i -&gt; i &lt; <span class="hljs-number">50</span>)        <span class="hljs-comment">// 满足条件时取</span><br>    .skip(<span class="hljs-number">5</span>)                       <span class="hljs-comment">// 跳过前5个</span><br>    .skipWhile(i -&gt; i &lt; <span class="hljs-number">10</span>)        <span class="hljs-comment">// 满足条件时跳过</span><br>    .distinct()                    <span class="hljs-comment">// 去重</span><br>    .distinctUntilChanged()        <span class="hljs-comment">// 相邻去重</span><br>    .elementAt(<span class="hljs-number">5</span>)                  <span class="hljs-comment">// 取第5个元素</span><br>    .single()                      <span class="hljs-comment">// 确保只有一个元素</span><br>    .subscribe();<br></code></pre></td></tr></table></figure><h3 id="组合操作符"><a href="#组合操作符" class="headerlink" title="组合操作符"></a>组合操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 合并多个 Flux（交错）</span><br>Flux.merge(flux1, flux2, flux3);<br><br><span class="hljs-comment">// 连接多个 Flux（顺序）</span><br>Flux.concat(flux1, flux2, flux3);<br><br><span class="hljs-comment">// 配对组合</span><br>Flux.zip(flux1, flux2, (a, b) -&gt; a + b);<br><br><span class="hljs-comment">// 合并最新值</span><br>Flux.combineLatest(flux1, flux2, (a, b) -&gt; a + b);<br></code></pre></td></tr></table></figure><h3 id="错误处理操作符"><a href="#错误处理操作符" class="headerlink" title="错误处理操作符"></a>错误处理操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>    .map(i -&gt; &#123;<br>        <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Error&quot;</span>);<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;)<br>    .onErrorReturn(-<span class="hljs-number">1</span>)                    <span class="hljs-comment">// 错误时返回默认值</span><br>    .onErrorResume(e -&gt; Flux.just(<span class="hljs-number">0</span>))     <span class="hljs-comment">// 错误时切换到备用流</span><br>    .onErrorMap(e -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomException</span>()) <span class="hljs-comment">// 转换异常</span><br>    .retry(<span class="hljs-number">3</span>)                              <span class="hljs-comment">// 重试3次</span><br>    .retryWhen(Retry.backoff(<span class="hljs-number">3</span>, Duration.ofSeconds(<span class="hljs-number">1</span>))) <span class="hljs-comment">// 退避重试</span><br>    .subscribe();<br></code></pre></td></tr></table></figure><h2 id="调度器（Scheduler）"><a href="#调度器（Scheduler）" class="headerlink" title="调度器（Scheduler）"></a>调度器（Scheduler）</h2><p>调度器用于控制操作在哪个线程上执行。</p><h3 id="常用调度器"><a href="#常用调度器" class="headerlink" title="常用调度器"></a>常用调度器</h3><table><thead><tr><th>调度器</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>Schedulers.immediate()</code></td><td>当前线程</td><td>默认</td></tr><tr><td><code>Schedulers.single()</code></td><td>单一线程</td><td>顺序执行</td></tr><tr><td><code>Schedulers.parallel()</code></td><td>并行线程池</td><td>CPU 密集型</td></tr><tr><td><code>Schedulers.boundedElastic()</code></td><td>弹性线程池</td><td>I&#x2F;O 密集型</td></tr></tbody></table><h3 id="切换线程"><a href="#切换线程" class="headerlink" title="切换线程"></a>切换线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>    .publishOn(Schedulers.parallel())    <span class="hljs-comment">// 后续操作在 parallel 线程</span><br>    .map(i -&gt; i * <span class="hljs-number">2</span>)<br>    .subscribeOn(Schedulers.boundedElastic()) <span class="hljs-comment">// 订阅在 elastic 线程</span><br>    .subscribe();<br></code></pre></td></tr></table></figure><ul><li><strong><code>subscribeOn</code></strong>：影响订阅和数据源的执行线程</li><li><strong><code>publishOn</code></strong>：影响后续操作符的执行线程</li></ul><h2 id="冷流与热流"><a href="#冷流与热流" class="headerlink" title="冷流与热流"></a>冷流与热流</h2><h3 id="冷流（Cold）"><a href="#冷流（Cold）" class="headerlink" title="冷流（Cold）"></a>冷流（Cold）</h3><ul><li>每个订阅者都会从头开始接收数据</li><li>数据是惰性生成的</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;Integer&gt; cold = Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>);<br>cold.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;Subscriber 1: &quot;</span> + i));<br>cold.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;Subscriber 2: &quot;</span> + i));<br><span class="hljs-comment">// 两个订阅者都会收到 1, 2, 3, 4, 5</span><br></code></pre></td></tr></table></figure><h3 id="热流（Hot）"><a href="#热流（Hot）" class="headerlink" title="热流（Hot）"></a>热流（Hot）</h3><ul><li>所有订阅者共享同一个数据流</li><li>订阅后只能收到之后发出的数据</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Many&lt;Integer&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br>Flux&lt;Integer&gt; hot = sink.asFlux();<br><br>hot.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;Subscriber 1: &quot;</span> + i));<br>sink.tryEmitNext(<span class="hljs-number">1</span>);<br>sink.tryEmitNext(<span class="hljs-number">2</span>);<br><br>hot.subscribe(i -&gt; System.out.println(<span class="hljs-string">&quot;Subscriber 2: &quot;</span> + i));<br>sink.tryEmitNext(<span class="hljs-number">3</span>);<br><span class="hljs-comment">// Subscriber 1 收到: 1, 2, 3</span><br><span class="hljs-comment">// Subscriber 2 收到: 3</span><br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：响应式编程基础</li><li>下一篇：WebFlux核心组件</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>Reactor</tag>
      
      <tag>Flux</tag>
      
      <tag>WebFlux</tag>
      
      <tag>Mono</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Reactor API参考</title>
    <link href="/2026/01/10/Reactor%20API%E5%8F%82%E8%80%83/"/>
    <url>/2026/01/10/Reactor%20API%E5%8F%82%E8%80%83/</url>
    
    <content type="html"><![CDATA[<h1 id="Reactor-API-参考"><a href="#Reactor-API-参考" class="headerlink" title="Reactor API 参考"></a>Reactor API 参考</h1><p>Project Reactor 提供了丰富的操作符，本文按功能分类整理。</p><hr><h2 id="一、创建操作符"><a href="#一、创建操作符" class="headerlink" title="一、创建操作符"></a>一、创建操作符</h2><h3 id="Mono-创建"><a href="#Mono-创建" class="headerlink" title="Mono 创建"></a>Mono 创建</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>Mono.just(T)</code></td><td>创建包含单个值的 Mono</td><td><code>Mono.just(&quot;hello&quot;)</code></td></tr><tr><td><code>Mono.empty()</code></td><td>创建空的 Mono</td><td><code>Mono.empty()</code></td></tr><tr><td><code>Mono.error(Throwable)</code></td><td>创建错误 Mono</td><td><code>Mono.error(new RuntimeException())</code></td></tr><tr><td><code>Mono.never()</code></td><td>永不发出信号的 Mono</td><td><code>Mono.never()</code></td></tr><tr><td><code>Mono.defer(Supplier)</code></td><td>延迟创建，每次订阅都执行</td><td><code>Mono.defer(() -&gt; Mono.just(getValue()))</code></td></tr><tr><td><code>Mono.fromCallable(Callable)</code></td><td>从 Callable 创建</td><td><code>Mono.fromCallable(() -&gt; compute())</code></td></tr><tr><td><code>Mono.fromSupplier(Supplier)</code></td><td>从 Supplier 创建</td><td><code>Mono.fromSupplier(() -&gt; getValue())</code></td></tr><tr><td><code>Mono.fromFuture(CompletableFuture)</code></td><td>从 Future 创建</td><td><code>Mono.fromFuture(future)</code></td></tr><tr><td><code>Mono.fromRunnable(Runnable)</code></td><td>从 Runnable 创建（无返回值）</td><td><code>Mono.fromRunnable(() -&gt; doSomething())</code></td></tr><tr><td><code>Mono.delay(Duration)</code></td><td>延迟后发出 0L</td><td><code>Mono.delay(Duration.ofSeconds(1))</code></td></tr><tr><td><code>Mono.create(Consumer&lt;MonoSink&gt;)</code></td><td>编程式创建</td><td>见下方示例</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mono.create 示例</span><br>Mono.create(sink -&gt; &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doAsyncWork();<br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) &#123;<br>        sink.success(result);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        sink.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;失败&quot;</span>));<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="Flux-创建"><a href="#Flux-创建" class="headerlink" title="Flux 创建"></a>Flux 创建</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>Flux.just(T...)</code></td><td>从多个值创建</td><td><code>Flux.just(1, 2, 3)</code></td></tr><tr><td><code>Flux.fromIterable(Iterable)</code></td><td>从集合创建</td><td><code>Flux.fromIterable(list)</code></td></tr><tr><td><code>Flux.fromArray(T[])</code></td><td>从数组创建</td><td><code>Flux.fromArray(array)</code></td></tr><tr><td><code>Flux.fromStream(Stream)</code></td><td>从 Stream 创建</td><td><code>Flux.fromStream(stream)</code></td></tr><tr><td><code>Flux.range(int, int)</code></td><td>创建整数序列</td><td><code>Flux.range(1, 10)</code></td></tr><tr><td><code>Flux.interval(Duration)</code></td><td>定时发出递增数字</td><td><code>Flux.interval(Duration.ofSeconds(1))</code></td></tr><tr><td><code>Flux.empty()</code></td><td>创建空 Flux</td><td><code>Flux.empty()</code></td></tr><tr><td><code>Flux.error(Throwable)</code></td><td>创建错误 Flux</td><td><code>Flux.error(new Exception())</code></td></tr><tr><td><code>Flux.never()</code></td><td>永不发出信号</td><td><code>Flux.never()</code></td></tr><tr><td><code>Flux.defer(Supplier)</code></td><td>延迟创建</td><td><code>Flux.defer(() -&gt; Flux.just(getData()))</code></td></tr><tr><td><code>Flux.generate(Consumer)</code></td><td>同步生成（一次一个）</td><td>见下方示例</td></tr><tr><td><code>Flux.create(Consumer)</code></td><td>异步生成（可多个）</td><td>见下方示例</td></tr><tr><td><code>Flux.push(Consumer)</code></td><td>单线程异步生成</td><td>类似 create</td></tr><tr><td><code>Flux.using(Callable, Function, Consumer)</code></td><td>资源管理</td><td>见下方示例</td></tr><tr><td><code>Flux.concat(Publisher...)</code></td><td>顺序连接多个流</td><td><code>Flux.concat(flux1, flux2)</code></td></tr><tr><td><code>Flux.merge(Publisher...)</code></td><td>并行合并多个流</td><td><code>Flux.merge(flux1, flux2)</code></td></tr><tr><td><code>Flux.zip(Publisher...)</code></td><td>组合多个流</td><td><code>Flux.zip(flux1, flux2)</code></td></tr><tr><td><code>Flux.combineLatest(Publisher...)</code></td><td>组合最新值</td><td>见下方示例</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Flux.generate 示例 - 同步生成</span><br>Flux.generate(<br>    () -&gt; <span class="hljs-number">0</span>,  <span class="hljs-comment">// 初始状态</span><br>    (state, sink) -&gt; &#123;<br>        sink.next(<span class="hljs-string">&quot;值: &quot;</span> + state);<br>        <span class="hljs-keyword">if</span> (state == <span class="hljs-number">10</span>) sink.complete();<br>        <span class="hljs-keyword">return</span> state + <span class="hljs-number">1</span>;<br>    &#125;<br>);<br><br><span class="hljs-comment">// Flux.create 示例 - 异步生成</span><br>Flux.create(sink -&gt; &#123;<br>    eventSource.onData(data -&gt; sink.next(data));<br>    eventSource.onError(e -&gt; sink.error(e));<br>    eventSource.onComplete(() -&gt; sink.complete());<br>&#125;);<br><br><span class="hljs-comment">// Flux.using 示例 - 资源管理</span><br>Flux.using(<br>    () -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;file.txt&quot;</span>),  <span class="hljs-comment">// 创建资源</span><br>    inputStream -&gt; Flux.just(readData(inputStream)),  <span class="hljs-comment">// 使用资源</span><br>    inputStream -&gt; inputStream.close()  <span class="hljs-comment">// 关闭资源</span><br>);<br></code></pre></td></tr></table></figure><hr><h2 id="二、转换操作符"><a href="#二、转换操作符" class="headerlink" title="二、转换操作符"></a>二、转换操作符</h2><h3 id="基本转换"><a href="#基本转换" class="headerlink" title="基本转换"></a>基本转换</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>map(Function)</code></td><td>同步转换每个元素</td><td><code>flux.map(i -&gt; i * 2)</code></td></tr><tr><td><code>flatMap(Function)</code></td><td>异步转换，结果合并（无序）</td><td><code>flux.flatMap(id -&gt; fetchUser(id))</code></td></tr><tr><td><code>flatMapSequential(Function)</code></td><td>异步转换，保持顺序</td><td><code>flux.flatMapSequential(id -&gt; fetchUser(id))</code></td></tr><tr><td><code>concatMap(Function)</code></td><td>异步转换，顺序执行</td><td><code>flux.concatMap(id -&gt; fetchUser(id))</code></td></tr><tr><td><code>switchMap(Function)</code></td><td>切换到新流，取消旧流</td><td><code>flux.switchMap(id -&gt; fetchUser(id))</code></td></tr><tr><td><code>cast(Class)</code></td><td>类型转换</td><td><code>flux.cast(String.class)</code></td></tr><tr><td><code>ofType(Class)</code></td><td>过滤并转换类型</td><td><code>flux.ofType(String.class)</code></td></tr><tr><td><code>index()</code></td><td>添加索引</td><td><code>flux.index()</code> → <code>Tuple2&lt;Long, T&gt;</code></td></tr><tr><td><code>timestamp()</code></td><td>添加时间戳</td><td><code>flux.timestamp()</code> → <code>Tuple2&lt;Long, T&gt;</code></td></tr><tr><td><code>elapsed()</code></td><td>添加时间间隔</td><td><code>flux.elapsed()</code></td></tr></tbody></table><h3 id="flatMap-变体对比"><a href="#flatMap-变体对比" class="headerlink" title="flatMap 变体对比"></a>flatMap 变体对比</h3><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">flatMap:</span>           并行执行，结果无序<br><span class="hljs-symbol">flatMapSequential:</span> 并行执行，结果有序<br><span class="hljs-symbol">concatMap:</span>         顺序执行，结果有序<br><span class="hljs-symbol">switchMap:</span>         切换新流，取消旧流<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// flatMap vs concatMap</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)<br>    .flatMap(i -&gt; Mono.just(i).delayElement(Duration.ofMillis(<span class="hljs-number">100</span> - i * <span class="hljs-number">30</span>)))<br>    .subscribe(System.out::println);  <span class="hljs-comment">// 可能输出: 3, 2, 1</span><br><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)<br>    .concatMap(i -&gt; Mono.just(i).delayElement(Duration.ofMillis(<span class="hljs-number">100</span>)))<br>    .subscribe(System.out::println);  <span class="hljs-comment">// 输出: 1, 2, 3</span><br></code></pre></td></tr></table></figure><hr><h2 id="三、过滤操作符"><a href="#三、过滤操作符" class="headerlink" title="三、过滤操作符"></a>三、过滤操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>filter(Predicate)</code></td><td>过滤元素</td><td><code>flux.filter(i -&gt; i &gt; 5)</code></td></tr><tr><td><code>filterWhen(Function)</code></td><td>异步过滤</td><td><code>flux.filterWhen(i -&gt; checkAsync(i))</code></td></tr><tr><td><code>distinct()</code></td><td>去重</td><td><code>flux.distinct()</code></td></tr><tr><td><code>distinctUntilChanged()</code></td><td>连续去重</td><td><code>flux.distinctUntilChanged()</code></td></tr><tr><td><code>take(long)</code></td><td>取前 n 个</td><td><code>flux.take(5)</code></td></tr><tr><td><code>takeLast(int)</code></td><td>取最后 n 个</td><td><code>flux.takeLast(3)</code></td></tr><tr><td><code>takeUntil(Predicate)</code></td><td>取直到条件满足</td><td><code>flux.takeUntil(i -&gt; i &gt; 10)</code></td></tr><tr><td><code>takeWhile(Predicate)</code></td><td>取当条件满足时</td><td><code>flux.takeWhile(i -&gt; i &lt; 10)</code></td></tr><tr><td><code>skip(long)</code></td><td>跳过前 n 个</td><td><code>flux.skip(5)</code></td></tr><tr><td><code>skipLast(int)</code></td><td>跳过最后 n 个</td><td><code>flux.skipLast(3)</code></td></tr><tr><td><code>skipUntil(Predicate)</code></td><td>跳过直到条件满足</td><td><code>flux.skipUntil(i -&gt; i &gt; 5)</code></td></tr><tr><td><code>skipWhile(Predicate)</code></td><td>跳过当条件满足时</td><td><code>flux.skipWhile(i -&gt; i &lt; 5)</code></td></tr><tr><td><code>first()</code></td><td>取第一个（已废弃）</td><td>使用 <code>next()</code></td></tr><tr><td><code>next()</code></td><td>取第一个，返回 Mono</td><td><code>flux.next()</code></td></tr><tr><td><code>last()</code></td><td>取最后一个</td><td><code>flux.last()</code></td></tr><tr><td><code>last(T)</code></td><td>取最后一个，有默认值</td><td><code>flux.last(defaultValue)</code></td></tr><tr><td><code>single()</code></td><td>期望只有一个元素</td><td><code>flux.single()</code></td></tr><tr><td><code>singleOrEmpty()</code></td><td>期望 0 或 1 个元素</td><td><code>flux.singleOrEmpty()</code></td></tr><tr><td><code>elementAt(int)</code></td><td>取指定位置元素</td><td><code>flux.elementAt(5)</code></td></tr><tr><td><code>ignoreElements()</code></td><td>忽略所有元素</td><td><code>flux.ignoreElements()</code></td></tr></tbody></table><hr><h2 id="四、组合操作符"><a href="#四、组合操作符" class="headerlink" title="四、组合操作符"></a>四、组合操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>concat(Publisher...)</code></td><td>顺序连接</td><td><code>Flux.concat(flux1, flux2)</code></td></tr><tr><td><code>concatWith(Publisher)</code></td><td>与另一个流连接</td><td><code>flux1.concatWith(flux2)</code></td></tr><tr><td><code>merge(Publisher...)</code></td><td>并行合并</td><td><code>Flux.merge(flux1, flux2)</code></td></tr><tr><td><code>mergeWith(Publisher)</code></td><td>与另一个流合并</td><td><code>flux1.mergeWith(flux2)</code></td></tr><tr><td><code>mergeSequential(Publisher...)</code></td><td>并行执行，顺序输出</td><td><code>Flux.mergeSequential(flux1, flux2)</code></td></tr><tr><td><code>zip(Publisher...)</code></td><td>一对一组合</td><td><code>Flux.zip(flux1, flux2)</code></td></tr><tr><td><code>zipWith(Publisher)</code></td><td>与另一个流组合</td><td><code>flux1.zipWith(flux2)</code></td></tr><tr><td><code>zipWith(Publisher, BiFunction)</code></td><td>组合并转换</td><td><code>flux1.zipWith(flux2, (a, b) -&gt; a + b)</code></td></tr><tr><td><code>combineLatest(Publisher...)</code></td><td>组合最新值</td><td><code>Flux.combineLatest(flux1, flux2, combiner)</code></td></tr><tr><td><code>startWith(T...)</code></td><td>在开头添加元素</td><td><code>flux.startWith(0)</code></td></tr><tr><td><code>and(Publisher)</code></td><td>等待两个都完成</td><td><code>mono1.and(mono2)</code></td></tr><tr><td><code>when(Publisher...)</code></td><td>等待所有完成</td><td><code>Mono.when(mono1, mono2)</code></td></tr><tr><td><code>then()</code></td><td>忽略元素，只关心完成</td><td><code>flux.then()</code></td></tr><tr><td><code>thenMany(Publisher)</code></td><td>完成后切换到另一个流</td><td><code>mono.thenMany(flux)</code></td></tr><tr><td><code>thenReturn(T)</code></td><td>完成后返回固定值</td><td><code>mono.thenReturn(&quot;done&quot;)</code></td></tr></tbody></table><h3 id="组合操作符对比"><a href="#组合操作符对比" class="headerlink" title="组合操作符对比"></a>组合操作符对比</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-symbol">concat:</span>  A完成 → <span class="hljs-keyword">B开始，顺序执行</span><br><span class="hljs-keyword"></span><span class="hljs-symbol">merge:</span>   A和<span class="hljs-keyword">B同时执行，谁快谁先输出</span><br><span class="hljs-keyword"></span><span class="hljs-symbol">zip:</span>     A和<span class="hljs-keyword">B一对一配对，(a1,b1), </span>(<span class="hljs-built_in">a2</span>,<span class="hljs-keyword">b2)...</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// zip 示例</span><br>Flux&lt;String&gt; names = Flux.just(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;李四&quot;</span>);<br>Flux&lt;Integer&gt; ages = Flux.just(<span class="hljs-number">25</span>, <span class="hljs-number">30</span>);<br><br>Flux.zip(names, ages, (name, age) -&gt; name + <span class="hljs-string">&quot;: &quot;</span> + age)<br>    .subscribe(System.out::println);<br><span class="hljs-comment">// 输出: 张三: 25, 李四: 30</span><br></code></pre></td></tr></table></figure><hr><h2 id="五、错误处理操作符"><a href="#五、错误处理操作符" class="headerlink" title="五、错误处理操作符"></a>五、错误处理操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>onErrorReturn(T)</code></td><td>错误时返回默认值</td><td><code>flux.onErrorReturn(defaultValue)</code></td></tr><tr><td><code>onErrorReturn(Predicate, T)</code></td><td>特定错误返回默认值</td><td><code>flux.onErrorReturn(e -&gt; e instanceof IOException, default)</code></td></tr><tr><td><code>onErrorResume(Function)</code></td><td>错误时切换到备用流</td><td><code>flux.onErrorResume(e -&gt; backupFlux)</code></td></tr><tr><td><code>onErrorMap(Function)</code></td><td>转换错误类型</td><td><code>flux.onErrorMap(e -&gt; new CustomException(e))</code></td></tr><tr><td><code>onErrorContinue(BiConsumer)</code></td><td>错误时跳过继续</td><td><code>flux.onErrorContinue((e, v) -&gt; log.error(e))</code></td></tr><tr><td><code>onErrorStop()</code></td><td>错误时停止</td><td><code>flux.onErrorStop()</code></td></tr><tr><td><code>doOnError(Consumer)</code></td><td>错误时执行副作用</td><td><code>flux.doOnError(e -&gt; log.error(e))</code></td></tr><tr><td><code>retry()</code></td><td>无限重试</td><td><code>flux.retry()</code></td></tr><tr><td><code>retry(long)</code></td><td>重试 n 次</td><td><code>flux.retry(3)</code></td></tr><tr><td><code>retryWhen(Retry)</code></td><td>自定义重试策略</td><td>见下方示例</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// retryWhen 示例</span><br>flux.retryWhen(Retry.backoff(<span class="hljs-number">3</span>, Duration.ofSeconds(<span class="hljs-number">1</span>))<br>    .maxBackoff(Duration.ofSeconds(<span class="hljs-number">10</span>))<br>    .filter(e -&gt; e <span class="hljs-keyword">instanceof</span> IOException)<br>    .onRetryExhaustedThrow((spec, signal) -&gt; signal.failure())<br>);<br><br><span class="hljs-comment">// 指数退避重试</span><br>flux.retryWhen(Retry.backoff(<span class="hljs-number">5</span>, Duration.ofMillis(<span class="hljs-number">100</span>)));<br><br><span class="hljs-comment">// 固定间隔重试</span><br>flux.retryWhen(Retry.fixedDelay(<span class="hljs-number">3</span>, Duration.ofSeconds(<span class="hljs-number">1</span>)));<br></code></pre></td></tr></table></figure><hr><h2 id="六、副作用操作符（doOn-系列）"><a href="#六、副作用操作符（doOn-系列）" class="headerlink" title="六、副作用操作符（doOn 系列）"></a>六、副作用操作符（doOn 系列）</h2><table><thead><tr><th>API</th><th>说明</th><th>触发时机</th></tr></thead><tbody><tr><td><code>doOnNext(Consumer)</code></td><td>每个元素</td><td>onNext 信号</td></tr><tr><td><code>doOnError(Consumer)</code></td><td>发生错误</td><td>onError 信号</td></tr><tr><td><code>doOnComplete(Runnable)</code></td><td>完成时</td><td>onComplete 信号</td></tr><tr><td><code>doOnSubscribe(Consumer)</code></td><td>订阅时</td><td>onSubscribe 信号</td></tr><tr><td><code>doOnRequest(LongConsumer)</code></td><td>请求数据时</td><td>request 信号</td></tr><tr><td><code>doOnCancel(Runnable)</code></td><td>取消时</td><td>cancel 信号</td></tr><tr><td><code>doOnTerminate(Runnable)</code></td><td>终止时（完成或错误）</td><td>onComplete 或 onError</td></tr><tr><td><code>doAfterTerminate(Runnable)</code></td><td>终止后</td><td>终止信号发送后</td></tr><tr><td><code>doOnEach(Consumer&lt;Signal&gt;)</code></td><td>每个信号</td><td>所有信号</td></tr><tr><td><code>doFirst(Runnable)</code></td><td>订阅前</td><td>订阅链建立前</td></tr><tr><td><code>doFinally(Consumer&lt;SignalType&gt;)</code></td><td>最终执行</td><td>任何终止情况</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 完整的生命周期监控</span><br>flux<br>    .doFirst(() -&gt; log.info(<span class="hljs-string">&quot;开始&quot;</span>))<br>    .doOnSubscribe(s -&gt; log.info(<span class="hljs-string">&quot;订阅&quot;</span>))<br>    .doOnRequest(n -&gt; log.info(<span class="hljs-string">&quot;请求: &quot;</span> + n))<br>    .doOnNext(v -&gt; log.info(<span class="hljs-string">&quot;收到: &quot;</span> + v))<br>    .doOnError(e -&gt; log.error(<span class="hljs-string">&quot;错误&quot;</span>, e))<br>    .doOnComplete(() -&gt; log.info(<span class="hljs-string">&quot;完成&quot;</span>))<br>    .doOnCancel(() -&gt; log.info(<span class="hljs-string">&quot;取消&quot;</span>))<br>    .doOnTerminate(() -&gt; log.info(<span class="hljs-string">&quot;终止&quot;</span>))<br>    .doAfterTerminate(() -&gt; log.info(<span class="hljs-string">&quot;终止后&quot;</span>))<br>    .doFinally(type -&gt; log.info(<span class="hljs-string">&quot;最终: &quot;</span> + type))<br>    .subscribe();<br></code></pre></td></tr></table></figure><hr><h2 id="七、调度器操作符"><a href="#七、调度器操作符" class="headerlink" title="七、调度器操作符"></a>七、调度器操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>subscribeOn(Scheduler)</code></td><td>指定订阅线程</td><td><code>flux.subscribeOn(Schedulers.boundedElastic())</code></td></tr><tr><td><code>publishOn(Scheduler)</code></td><td>指定发布线程</td><td><code>flux.publishOn(Schedulers.parallel())</code></td></tr></tbody></table><h3 id="调度器类型"><a href="#调度器类型" class="headerlink" title="调度器类型"></a>调度器类型</h3><table><thead><tr><th>Scheduler</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>Schedulers.immediate()</code></td><td>当前线程</td><td>测试、简单场景</td></tr><tr><td><code>Schedulers.single()</code></td><td>单线程</td><td>顺序执行</td></tr><tr><td><code>Schedulers.parallel()</code></td><td>并行线程池（CPU核心数）</td><td>CPU 密集型</td></tr><tr><td><code>Schedulers.boundedElastic()</code></td><td>弹性线程池（有上限）</td><td>I&#x2F;O 密集型、阻塞操作</td></tr><tr><td><code>Schedulers.fromExecutor(Executor)</code></td><td>自定义线程池</td><td>特殊需求</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// subscribeOn vs publishOn</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)<br>    .doOnNext(i -&gt; log.info(<span class="hljs-string">&quot;生成: &quot;</span> + i))  <span class="hljs-comment">// boundedElastic 线程</span><br>    .subscribeOn(Schedulers.boundedElastic())<br>    .publishOn(Schedulers.parallel())<br>    .doOnNext(i -&gt; log.info(<span class="hljs-string">&quot;处理: &quot;</span> + i))  <span class="hljs-comment">// parallel 线程</span><br>    .subscribe();<br></code></pre></td></tr></table></figure><hr><h2 id="八、缓冲与窗口操作符"><a href="#八、缓冲与窗口操作符" class="headerlink" title="八、缓冲与窗口操作符"></a>八、缓冲与窗口操作符</h2><h3 id="缓冲（收集为-List）"><a href="#缓冲（收集为-List）" class="headerlink" title="缓冲（收集为 List）"></a>缓冲（收集为 List）</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>buffer()</code></td><td>收集所有元素</td><td><code>flux.buffer()</code> → <code>Flux&lt;List&lt;T&gt;&gt;</code></td></tr><tr><td><code>buffer(int)</code></td><td>按数量缓冲</td><td><code>flux.buffer(10)</code></td></tr><tr><td><code>buffer(Duration)</code></td><td>按时间缓冲</td><td><code>flux.buffer(Duration.ofSeconds(1))</code></td></tr><tr><td><code>buffer(int, int)</code></td><td>滑动窗口缓冲</td><td><code>flux.buffer(3, 1)</code></td></tr><tr><td><code>bufferUntil(Predicate)</code></td><td>缓冲直到条件满足</td><td><code>flux.bufferUntil(i -&gt; i % 10 == 0)</code></td></tr><tr><td><code>bufferWhile(Predicate)</code></td><td>缓冲当条件满足时</td><td><code>flux.bufferWhile(i -&gt; i &lt; 10)</code></td></tr><tr><td><code>bufferTimeout(int, Duration)</code></td><td>数量或时间触发</td><td><code>flux.bufferTimeout(100, Duration.ofSeconds(1))</code></td></tr></tbody></table><h3 id="窗口（收集为-Flux）"><a href="#窗口（收集为-Flux）" class="headerlink" title="窗口（收集为 Flux）"></a>窗口（收集为 Flux）</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>window(int)</code></td><td>按数量分窗口</td><td><code>flux.window(10)</code> → <code>Flux&lt;Flux&lt;T&gt;&gt;</code></td></tr><tr><td><code>window(Duration)</code></td><td>按时间分窗口</td><td><code>flux.window(Duration.ofSeconds(1))</code></td></tr><tr><td><code>windowUntil(Predicate)</code></td><td>分窗口直到条件满足</td><td><code>flux.windowUntil(i -&gt; i % 10 == 0)</code></td></tr></tbody></table><h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>groupBy(Function)</code></td><td>按 key 分组</td><td><code>flux.groupBy(User::getType)</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// groupBy 示例</span><br>flux.groupBy(user -&gt; user.getType())<br>    .flatMap(group -&gt; group<br>        .collectList()<br>        .map(list -&gt; group.key() + <span class="hljs-string">&quot;: &quot;</span> + list.size())<br>    )<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><hr><h2 id="九、聚合操作符"><a href="#九、聚合操作符" class="headerlink" title="九、聚合操作符"></a>九、聚合操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>返回类型</th></tr></thead><tbody><tr><td><code>count()</code></td><td>计数</td><td><code>Mono&lt;Long&gt;</code></td></tr><tr><td><code>reduce(BiFunction)</code></td><td>归约</td><td><code>Mono&lt;T&gt;</code></td></tr><tr><td><code>reduce(T, BiFunction)</code></td><td>带初始值归约</td><td><code>Mono&lt;T&gt;</code></td></tr><tr><td><code>reduceWith(Supplier, BiFunction)</code></td><td>延迟初始值归约</td><td><code>Mono&lt;T&gt;</code></td></tr><tr><td><code>scan(BiFunction)</code></td><td>累积（发出中间结果）</td><td><code>Flux&lt;T&gt;</code></td></tr><tr><td><code>scan(T, BiFunction)</code></td><td>带初始值累积</td><td><code>Flux&lt;T&gt;</code></td></tr><tr><td><code>collect(Collector)</code></td><td>收集到集合</td><td><code>Mono&lt;R&gt;</code></td></tr><tr><td><code>collectList()</code></td><td>收集为 List</td><td><code>Mono&lt;List&lt;T&gt;&gt;</code></td></tr><tr><td><code>collectMap(Function)</code></td><td>收集为 Map</td><td><code>Mono&lt;Map&lt;K, T&gt;&gt;</code></td></tr><tr><td><code>collectMap(Function, Function)</code></td><td>收集为 Map（指定 value）</td><td><code>Mono&lt;Map&lt;K, V&gt;&gt;</code></td></tr><tr><td><code>collectMultimap(Function)</code></td><td>收集为 Multimap</td><td><code>Mono&lt;Map&lt;K, Collection&lt;T&gt;&gt;&gt;</code></td></tr><tr><td><code>collectSortedList()</code></td><td>收集为排序 List</td><td><code>Mono&lt;List&lt;T&gt;&gt;</code></td></tr><tr><td><code>all(Predicate)</code></td><td>是否全部满足</td><td><code>Mono&lt;Boolean&gt;</code></td></tr><tr><td><code>any(Predicate)</code></td><td>是否有满足的</td><td><code>Mono&lt;Boolean&gt;</code></td></tr><tr><td><code>hasElements()</code></td><td>是否有元素</td><td><code>Mono&lt;Boolean&gt;</code></td></tr><tr><td><code>hasElement(T)</code></td><td>是否包含元素</td><td><code>Mono&lt;Boolean&gt;</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// reduce 示例</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br>    .reduce((a, b) -&gt; a + b)<br>    .subscribe(System.out::println);  <span class="hljs-comment">// 15</span><br><br><span class="hljs-comment">// scan 示例（发出中间结果）</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br>    .scan((a, b) -&gt; a + b)<br>    .subscribe(System.out::println);  <span class="hljs-comment">// 1, 3, 6, 10, 15</span><br></code></pre></td></tr></table></figure><hr><h2 id="十、时间操作符"><a href="#十、时间操作符" class="headerlink" title="十、时间操作符"></a>十、时间操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>delayElements(Duration)</code></td><td>延迟每个元素</td><td><code>flux.delayElements(Duration.ofMillis(100))</code></td></tr><tr><td><code>delaySequence(Duration)</code></td><td>延迟整个序列</td><td><code>flux.delaySequence(Duration.ofSeconds(1))</code></td></tr><tr><td><code>delaySubscription(Duration)</code></td><td>延迟订阅</td><td><code>flux.delaySubscription(Duration.ofSeconds(1))</code></td></tr><tr><td><code>timeout(Duration)</code></td><td>超时</td><td><code>flux.timeout(Duration.ofSeconds(5))</code></td></tr><tr><td><code>timeout(Duration, Publisher)</code></td><td>超时后切换</td><td><code>flux.timeout(Duration.ofSeconds(5), backupFlux)</code></td></tr><tr><td><code>sample(Duration)</code></td><td>采样</td><td><code>flux.sample(Duration.ofSeconds(1))</code></td></tr><tr><td><code>sampleFirst(Duration)</code></td><td>采样第一个</td><td><code>flux.sampleFirst(Duration.ofSeconds(1))</code></td></tr><tr><td><code>throttleFirst(Duration)</code></td><td>节流（取第一个）</td><td><code>flux.throttleFirst(Duration.ofSeconds(1))</code></td></tr><tr><td><code>throttleLast(Duration)</code></td><td>节流（取最后一个）</td><td><code>flux.throttleLast(Duration.ofSeconds(1))</code></td></tr><tr><td><code>elapsed()</code></td><td>添加时间间隔</td><td><code>flux.elapsed()</code></td></tr><tr><td><code>timed()</code></td><td>添加时间信息</td><td><code>flux.timed()</code></td></tr></tbody></table><hr><h2 id="十一、背压操作符"><a href="#十一、背压操作符" class="headerlink" title="十一、背压操作符"></a>十一、背压操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>onBackpressureBuffer()</code></td><td>无限缓冲</td><td><code>flux.onBackpressureBuffer()</code></td></tr><tr><td><code>onBackpressureBuffer(int)</code></td><td>有限缓冲</td><td><code>flux.onBackpressureBuffer(100)</code></td></tr><tr><td><code>onBackpressureBuffer(int, Consumer)</code></td><td>缓冲满时回调</td><td><code>flux.onBackpressureBuffer(100, v -&gt; log.warn(&quot;溢出&quot;))</code></td></tr><tr><td><code>onBackpressureDrop()</code></td><td>丢弃</td><td><code>flux.onBackpressureDrop()</code></td></tr><tr><td><code>onBackpressureDrop(Consumer)</code></td><td>丢弃并回调</td><td><code>flux.onBackpressureDrop(v -&gt; log.warn(&quot;丢弃: &quot; + v))</code></td></tr><tr><td><code>onBackpressureLatest()</code></td><td>只保留最新</td><td><code>flux.onBackpressureLatest()</code></td></tr><tr><td><code>onBackpressureError()</code></td><td>抛出异常</td><td><code>flux.onBackpressureError()</code></td></tr><tr><td><code>limitRate(int)</code></td><td>限制请求速率</td><td><code>flux.limitRate(100)</code></td></tr><tr><td><code>limitRequest(long)</code></td><td>限制总请求数</td><td><code>flux.limitRequest(1000)</code></td></tr></tbody></table><hr><h2 id="十二、条件操作符"><a href="#十二、条件操作符" class="headerlink" title="十二、条件操作符"></a>十二、条件操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>defaultIfEmpty(T)</code></td><td>空时返回默认值</td><td><code>flux.defaultIfEmpty(defaultValue)</code></td></tr><tr><td><code>switchIfEmpty(Publisher)</code></td><td>空时切换到另一个流</td><td><code>flux.switchIfEmpty(backupFlux)</code></td></tr><tr><td><code>repeatWhen(Function)</code></td><td>条件重复</td><td><code>flux.repeatWhen(companion -&gt; companion.take(3))</code></td></tr><tr><td><code>repeat()</code></td><td>无限重复</td><td><code>flux.repeat()</code></td></tr><tr><td><code>repeat(long)</code></td><td>重复 n 次</td><td><code>flux.repeat(3)</code></td></tr></tbody></table><hr><h2 id="十三、调试操作符"><a href="#十三、调试操作符" class="headerlink" title="十三、调试操作符"></a>十三、调试操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>log()</code></td><td>打印所有信号</td><td><code>flux.log()</code></td></tr><tr><td><code>log(String)</code></td><td>带前缀打印</td><td><code>flux.log(&quot;MyFlux&quot;)</code></td></tr><tr><td><code>log(String, Level)</code></td><td>指定日志级别</td><td><code>flux.log(&quot;MyFlux&quot;, Level.FINE)</code></td></tr><tr><td><code>checkpoint()</code></td><td>添加检查点（调试用）</td><td><code>flux.checkpoint(&quot;after filter&quot;)</code></td></tr><tr><td><code>checkpoint(String)</code></td><td>带描述的检查点</td><td><code>flux.checkpoint(&quot;处理后&quot;)</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 调试示例</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>)<br>    .log(<span class="hljs-string">&quot;源数据&quot;</span>)<br>    .filter(i -&gt; i &gt; <span class="hljs-number">2</span>)<br>    .log(<span class="hljs-string">&quot;过滤后&quot;</span>)<br>    .map(i -&gt; i * <span class="hljs-number">2</span>)<br>    .log(<span class="hljs-string">&quot;转换后&quot;</span>)<br>    .subscribe();<br></code></pre></td></tr></table></figure><hr><h2 id="十四、上下文操作符"><a href="#十四、上下文操作符" class="headerlink" title="十四、上下文操作符"></a>十四、上下文操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>contextWrite(Context)</code></td><td>写入上下文</td><td><code>flux.contextWrite(Context.of(&quot;key&quot;, &quot;value&quot;))</code></td></tr><tr><td><code>contextWrite(Function)</code></td><td>修改上下文</td><td><code>flux.contextWrite(ctx -&gt; ctx.put(&quot;key&quot;, &quot;value&quot;))</code></td></tr><tr><td><code>deferContextual(Function)</code></td><td>读取上下文创建流</td><td>见下方示例</td></tr><tr><td><code>transformDeferredContextual(BiFunction)</code></td><td>转换时读取上下文</td><td>见下方示例</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Context 示例 - 传递请求 ID</span><br>Mono.deferContextual(ctx -&gt; &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">requestId</span> <span class="hljs-operator">=</span> ctx.get(<span class="hljs-string">&quot;requestId&quot;</span>);<br>    <span class="hljs-keyword">return</span> callService(requestId);<br>&#125;)<br>.contextWrite(Context.of(<span class="hljs-string">&quot;requestId&quot;</span>, UUID.randomUUID().toString()))<br>.subscribe();<br></code></pre></td></tr></table></figure><hr><h2 id="十五、Mono-特有操作符"><a href="#十五、Mono-特有操作符" class="headerlink" title="十五、Mono 特有操作符"></a>十五、Mono 特有操作符</h2><table><thead><tr><th>API</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>block()</code></td><td>阻塞获取结果</td><td><code>mono.block()</code></td></tr><tr><td><code>block(Duration)</code></td><td>带超时阻塞</td><td><code>mono.block(Duration.ofSeconds(5))</code></td></tr><tr><td><code>toFuture()</code></td><td>转为 CompletableFuture</td><td><code>mono.toFuture()</code></td></tr><tr><td><code>cache()</code></td><td>缓存结果</td><td><code>mono.cache()</code></td></tr><tr><td><code>cache(Duration)</code></td><td>带过期时间缓存</td><td><code>mono.cache(Duration.ofMinutes(5))</code></td></tr><tr><td><code>flux()</code></td><td>转为 Flux</td><td><code>mono.flux()</code></td></tr><tr><td><code>zipWhen(Function)</code></td><td>与依赖结果组合</td><td><code>mono.zipWhen(v -&gt; fetchRelated(v))</code></td></tr><tr><td><code>delayUntil(Function)</code></td><td>延迟直到另一个完成</td><td><code>mono.delayUntil(v -&gt; saveAsync(v))</code></td></tr></tbody></table><hr><h2 id="十六、Sinks（手动发送数据）"><a href="#十六、Sinks（手动发送数据）" class="headerlink" title="十六、Sinks（手动发送数据）"></a>十六、Sinks（手动发送数据）</h2><h3 id="Sinks-Many（多值）"><a href="#Sinks-Many（多值）" class="headerlink" title="Sinks.Many（多值）"></a>Sinks.Many（多值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 单播 - 只能有一个订阅者</span><br>Sinks.Many&lt;String&gt; unicast = Sinks.many().unicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 多播 - 多个订阅者</span><br>Sinks.Many&lt;String&gt; multicast = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 重放 - 新订阅者可收到历史数据</span><br>Sinks.Many&lt;String&gt; replay = Sinks.many().replay().all();<br>Sinks.Many&lt;String&gt; replayLimit = Sinks.many().replay().limit(<span class="hljs-number">10</span>);<br>Sinks.Many&lt;String&gt; replayLatest = Sinks.many().replay().latest();<br><br><span class="hljs-comment">// 发送数据</span><br>sink.tryEmitNext(<span class="hljs-string">&quot;data&quot;</span>);<br>sink.emitNext(<span class="hljs-string">&quot;data&quot;</span>, Sinks.EmitFailureHandler.FAIL_FAST);<br>sink.tryEmitComplete();<br>sink.tryEmitError(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>());<br><br><span class="hljs-comment">// 作为 Flux 使用</span><br>Flux&lt;String&gt; flux = sink.asFlux();<br></code></pre></td></tr></table></figure><h3 id="Sinks-One（单值）"><a href="#Sinks-One（单值）" class="headerlink" title="Sinks.One（单值）"></a>Sinks.One（单值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.One&lt;String&gt; one = Sinks.one();<br>one.tryEmitValue(<span class="hljs-string">&quot;result&quot;</span>);<br>Mono&lt;String&gt; mono = one.asMono();<br></code></pre></td></tr></table></figure><h3 id="Sinks-Empty（无值）"><a href="#Sinks-Empty（无值）" class="headerlink" title="Sinks.Empty（无值）"></a>Sinks.Empty（无值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Empty&lt;Void&gt; empty = Sinks.empty();<br>empty.tryEmitEmpty();<br>Mono&lt;Void&gt; mono = empty.asMono();<br></code></pre></td></tr></table></figure><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Project Reactor 实现</li><li>源码解析</li><li>WebFlux - Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>API</tag>
      
      <tag>操作符</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Project Reactor实现</title>
    <link href="/2026/01/10/Project%20Reactor%E5%AE%9E%E7%8E%B0/"/>
    <url>/2026/01/10/Project%20Reactor%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="Project-Reactor-实现"><a href="#Project-Reactor-实现" class="headerlink" title="Project Reactor 实现"></a>Project Reactor 实现</h1><h2 id="Project-Reactor-简介"><a href="#Project-Reactor-简介" class="headerlink" title="Project Reactor 简介"></a>Project Reactor 简介</h2><p>Project Reactor 是 <strong>Spring 官方的 Reactive Streams 实现</strong>，是 Spring WebFlux 的基础。</p><h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul><li><strong>完全非阻塞</strong>：基于 JDK 8 函数式 API</li><li><strong>背压支持</strong>：完整实现 Reactive Streams 规范</li><li><strong>丰富的操作符</strong>：提供 100+ 操作符</li><li><strong>与 Spring 深度集成</strong>：WebFlux、Spring Data R2DBC 等</li></ul><h2 id="Reactor-对-Reactive-Streams-的实现"><a href="#Reactor-对-Reactive-Streams-的实现" class="headerlink" title="Reactor 对 Reactive Streams 的实现"></a>Reactor 对 Reactive Streams 的实现</h2><h3 id="Publisher-的实现"><a href="#Publisher-的实现" class="headerlink" title="Publisher 的实现"></a>Publisher 的实现</h3><p>Reactor 提供了两个 Publisher 实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mono - 0或1个元素的 Publisher</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Mono</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Publisher</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// Flux - 0到N个元素的 Publisher  </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flux</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Publisher</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="为什么分成-Mono-和-Flux？"><a href="#为什么分成-Mono-和-Flux？" class="headerlink" title="为什么分成 Mono 和 Flux？"></a>为什么分成 Mono 和 Flux？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 语义更清晰</span><br>Mono&lt;User&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;      <span class="hljs-comment">// 明确：最多返回1个</span><br>Flux&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;              <span class="hljs-comment">// 明确：可能返回多个</span><br><br><span class="hljs-comment">// 对比原始 Publisher</span><br>Publisher&lt;User&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;  <span class="hljs-comment">// 不清楚：1个还是多个？</span><br></code></pre></td></tr></table></figure><h3 id="Subscriber-的实现"><a href="#Subscriber-的实现" class="headerlink" title="Subscriber 的实现"></a>Subscriber 的实现</h3><p>Reactor 提供了 <code>BaseSubscriber</code> 作为基础实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>    .subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnSubscribe</span><span class="hljs-params">(Subscription subscription)</span> &#123;<br>            <span class="hljs-comment">// 订阅时请求第一批数据</span><br>            request(<span class="hljs-number">3</span>);<br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnNext</span><span class="hljs-params">(Integer value)</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;收到: &quot;</span> + value);<br>            <span class="hljs-comment">// 每收到一个，再请求一个（控制背压）</span><br>            request(<span class="hljs-number">1</span>);<br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnComplete</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot;完成&quot;</span>);<br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnError</span><span class="hljs-params">(Throwable throwable)</span> &#123;<br>            System.err.println(<span class="hljs-string">&quot;错误: &quot;</span> + throwable);<br>        &#125;<br>    &#125;);<br></code></pre></td></tr></table></figure><h2 id="背压策略实现"><a href="#背压策略实现" class="headerlink" title="背压策略实现"></a>背压策略实现</h2><p>Reactor 提供了多种背压策略：</p><h3 id="1-request-控制（默认）"><a href="#1-request-控制（默认）" class="headerlink" title="1. request 控制（默认）"></a>1. request 控制（默认）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnSubscribe</span><span class="hljs-params">(Subscription s)</span> &#123;<br>            request(<span class="hljs-number">10</span>);  <span class="hljs-comment">// 只请求10个</span><br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnNext</span><span class="hljs-params">(Integer value)</span> &#123;<br>            <span class="hljs-comment">// 处理完一个再请求一个</span><br>            request(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="2-onBackpressureBuffer-缓冲"><a href="#2-onBackpressureBuffer-缓冲" class="headerlink" title="2. onBackpressureBuffer - 缓冲"></a>2. onBackpressureBuffer - 缓冲</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .onBackpressureBuffer(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 缓冲100个</span><br>    .subscribe(value -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 慢消费</span><br>        System.out.println(value);<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="3-onBackpressureDrop-丢弃"><a href="#3-onBackpressureDrop-丢弃" class="headerlink" title="3. onBackpressureDrop - 丢弃"></a>3. onBackpressureDrop - 丢弃</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .onBackpressureDrop(dropped -&gt; <br>        System.out.println(<span class="hljs-string">&quot;丢弃: &quot;</span> + dropped))<br>    .subscribe(value -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        System.out.println(value);<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="4-onBackpressureLatest-只保留最新"><a href="#4-onBackpressureLatest-只保留最新" class="headerlink" title="4. onBackpressureLatest - 只保留最新"></a>4. onBackpressureLatest - 只保留最新</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .onBackpressureLatest()  <span class="hljs-comment">// 只保留最新的</span><br>    .subscribe(value -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        System.out.println(value);<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="5-onBackpressureError-抛异常"><a href="#5-onBackpressureError-抛异常" class="headerlink" title="5. onBackpressureError - 抛异常"></a>5. onBackpressureError - 抛异常</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .onBackpressureError()  <span class="hljs-comment">// 背压时抛出异常</span><br>    .subscribe(value -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        System.out.println(value);<br>    &#125;);<br></code></pre></td></tr></table></figure><h2 id="Subscription-的实现"><a href="#Subscription-的实现" class="headerlink" title="Subscription 的实现"></a>Subscription 的实现</h2><p>Reactor 内部使用多种 Subscription 实现：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 查看实际的 Subscription 类型</span><br>Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>    .subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">hookOnSubscribe</span><span class="hljs-params">(Subscription subscription)</span> &#123;<br>            System.out.println(subscription.getClass());<br>            <span class="hljs-comment">// 输出: reactor.core.publisher.FluxRange$RangeSubscription</span><br>            request(<span class="hljs-number">1</span>);<br>        &#125;<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="常见的-Subscription-实现"><a href="#常见的-Subscription-实现" class="headerlink" title="常见的 Subscription 实现"></a>常见的 Subscription 实现</h3><table><thead><tr><th>类名</th><th>说明</th></tr></thead><tbody><tr><td><code>FluxRange$RangeSubscription</code></td><td>range() 操作的订阅</td></tr><tr><td><code>FluxMap$MapSubscriber</code></td><td>map() 操作的订阅</td></tr><tr><td><code>FluxFilter$FilterSubscriber</code></td><td>filter() 操作的订阅</td></tr><tr><td><code>MonoJust$MonoJustSubscription</code></td><td>Mono.just() 的订阅</td></tr></tbody></table><h2 id="Processor-的实现（已废弃）"><a href="#Processor-的实现（已废弃）" class="headerlink" title="Processor 的实现（已废弃）"></a>Processor 的实现（已废弃）</h2><p>Reactor 3.4 之前提供了 Processor 实现，现在推荐使用 <strong>Sinks</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 旧方式（已废弃）</span><br><span class="hljs-comment">// DirectProcessor&lt;String&gt; processor = DirectProcessor.create();</span><br><br><span class="hljs-comment">// 新方式：使用 Sinks</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 作为 Publisher</span><br>Flux&lt;String&gt; flux = sink.asFlux();<br><br><span class="hljs-comment">// 发送数据</span><br>sink.tryEmitNext(<span class="hljs-string">&quot;Hello&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;World&quot;</span>);<br>sink.tryEmitComplete();<br></code></pre></td></tr></table></figure><h3 id="Sinks-的类型"><a href="#Sinks-的类型" class="headerlink" title="Sinks 的类型"></a>Sinks 的类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 单播：只能有一个订阅者</span><br>Sinks.Many&lt;String&gt; unicast = Sinks.many().unicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 多播：多个订阅者共享</span><br>Sinks.Many&lt;String&gt; multicast = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 重放：新订阅者可以收到历史数据</span><br>Sinks.Many&lt;String&gt; replay = Sinks.many().replay().all();<br><br><span class="hljs-comment">// 单值</span><br>Sinks.One&lt;String&gt; one = Sinks.one();<br></code></pre></td></tr></table></figure><h2 id="操作符链的背压传递"><a href="#操作符链的背压传递" class="headerlink" title="操作符链的背压传递"></a>操作符链的背压传递</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)           <span class="hljs-comment">// 源 Publisher</span><br>    .map(i -&gt; i * <span class="hljs-number">2</span>)          <span class="hljs-comment">// 中间操作符</span><br>    .filter(i -&gt; i % <span class="hljs-number">3</span> == <span class="hljs-number">0</span>)  <span class="hljs-comment">// 中间操作符</span><br>    .take(<span class="hljs-number">10</span>)                 <span class="hljs-comment">// 中间操作符</span><br>    .subscribe(System.out::println);  <span class="hljs-comment">// 最终 Subscriber</span><br></code></pre></td></tr></table></figure><p>背压信号<strong>从下游向上游传递</strong>：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">Subscriber<span class="hljs-selector-class">.request</span>(<span class="hljs-number">10</span>)<br>    ↓<br>take 向上 <span class="hljs-built_in">request</span>(<span class="hljs-number">10</span>)<br>    ↓<br><span class="hljs-attribute">filter</span> 向上 <span class="hljs-built_in">request</span>(<span class="hljs-number">10</span>)  <span class="hljs-comment">// 可能请求更多，因为有过滤</span><br>    ↓<br>map 向上 <span class="hljs-built_in">request</span>(<span class="hljs-number">10</span>)<br>    ↓<br>range 开始生产数据<br></code></pre></td></tr></table></figure><h2 id="调试背压"><a href="#调试背压" class="headerlink" title="调试背压"></a>调试背压</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br>    .log()  <span class="hljs-comment">// 打印所有信号，包括 request</span><br>    .map(i -&gt; i * <span class="hljs-number">2</span>)<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><p>输出示例：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-built_in">INFO</span>  - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)<br><span class="hljs-built_in">INFO</span>  - | request(unbounded)<br><span class="hljs-built_in">INFO</span>  - | onNext(1)<br><span class="hljs-built_in">INFO</span>  - | onNext(2)<br><span class="hljs-built_in">..</span>.<br><span class="hljs-built_in">INFO</span>  - | onComplete()<br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：Reactive Streams 规范</li><li>下一篇：源码解析</li><li>WebFlux - Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>Flux</tag>
      
      <tag>Mono</tag>
      
      <tag>背压策略</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Sinks详解</title>
    <link href="/2026/01/10/Sinks%E8%AF%A6%E8%A7%A3/"/>
    <url>/2026/01/10/Sinks%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Sinks-详解"><a href="#Sinks-详解" class="headerlink" title="Sinks 详解"></a>Sinks 详解</h1><h2 id="什么是-Sinks"><a href="#什么是-Sinks" class="headerlink" title="什么是 Sinks"></a>什么是 Sinks</h2><p><strong>Sinks 是 Reactor 提供的”手动发送数据”的工具</strong>，让你可以在代码中主动 push 数据到响应式流中。</p><h3 id="核心问题：Mono-Flux-的局限"><a href="#核心问题：Mono-Flux-的局限" class="headerlink" title="核心问题：Mono&#x2F;Flux 的局限"></a>核心问题：Mono&#x2F;Flux 的局限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mono/Flux 通常是&quot;被动&quot;的 - 数据在创建时就确定了</span><br>Mono.just(<span class="hljs-string">&quot;hello&quot;</span>);           <span class="hljs-comment">// 数据已确定</span><br>Flux.fromIterable(list);      <span class="hljs-comment">// 数据已确定</span><br>Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>));  <span class="hljs-comment">// 数据按规则生成</span><br></code></pre></td></tr></table></figure><p><strong>但有些场景需要”主动”发送数据</strong>：</p><ul><li>接收外部事件（WebSocket、消息队列）</li><li>用户交互触发</li><li>异步回调结果</li><li>多个地方产生数据，汇聚到一个流</li></ul><h3 id="Sinks-的作用"><a href="#Sinks-的作用" class="headerlink" title="Sinks 的作用"></a>Sinks 的作用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Sinks 让你可以&quot;主动&quot;发送数据</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 在任何地方、任何时候发送数据</span><br>sink.tryEmitNext(<span class="hljs-string">&quot;消息1&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息2&quot;</span>);<br><br><span class="hljs-comment">// 订阅者可以收到这些数据</span><br>sink.asFlux().subscribe(System.out::println);<br></code></pre></td></tr></table></figure><hr><h2 id="Sinks-与-Mono-Flux-的关系"><a href="#Sinks-与-Mono-Flux-的关系" class="headerlink" title="Sinks 与 Mono&#x2F;Flux 的关系"></a>Sinks 与 Mono&#x2F;Flux 的关系</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">┌─────────────────────────────────────────────────────────────┐<br>│                        数据生产方式                          │<br>├─────────────────────────────────────────────────────────────┤<br>│                                                             │<br>│   Mono/Flux (被动)              Sinks (主动)                │<br>│   ─────────────────            ─────────────                │<br>│   数据在创建时确定              数据可以随时发送              │<br>│   <span class="hljs-built_in">just</span>(), <span class="hljs-built_in">fromIterable</span>()       <span class="hljs-built_in">tryEmitNext</span>()               │<br>│   <span class="hljs-built_in">interval</span>(), <span class="hljs-built_in">range</span>()          <span class="hljs-built_in">tryEmitComplete</span>()           │<br>│                                                             │<br>│                    ↓ 转换 ↓                                 │<br>│                                                             │<br>│              sink<span class="hljs-selector-class">.asFlux</span>() → Flux&lt;T&gt;                        │<br>│              sink<span class="hljs-selector-class">.asMono</span>() → Mono&lt;T&gt;                        │<br>│                                                             │<br>│   最终都是 Flux/Mono，订阅者无感知差异                        │<br>└─────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><p>本质：Sinks 是 Flux&#x2F;Mono 的数据源，它生产数据，Flux&#x2F;Mono 传递数据。</p><hr><h2 id="Sinks-的三种类型"><a href="#Sinks-的三种类型" class="headerlink" title="Sinks 的三种类型"></a>Sinks 的三种类型</h2><h3 id="1-Sinks-One-单值（对应-Mono）"><a href="#1-Sinks-One-单值（对应-Mono）" class="headerlink" title="1. Sinks.One - 单值（对应 Mono）"></a>1. Sinks.One - 单值（对应 Mono）</h3><p>只能发送 0 或 1 个值，然后完成。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.One&lt;String&gt; sink = Sinks.one();<br><br><span class="hljs-comment">// 发送一个值</span><br>sink.tryEmitValue(<span class="hljs-string">&quot;结果&quot;</span>);<br><br><span class="hljs-comment">// 转为 Mono</span><br>Mono&lt;String&gt; mono = sink.asMono();<br>mono.subscribe(System.out::println);  <span class="hljs-comment">// 输出: 结果</span><br></code></pre></td></tr></table></figure><p>使用场景：异步操作的单个结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 示例：封装异步回调</span><br><span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">fetchUserAsync</span><span class="hljs-params">(Long id)</span> &#123;<br>    Sinks.One&lt;User&gt; sink = Sinks.one();<br>    <br>    <span class="hljs-comment">// 假设这是一个回调式的 API</span><br>    asyncClient.getUser(id, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Callback</span>&lt;User&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(User user)</span> &#123;<br>            sink.tryEmitValue(user);  <span class="hljs-comment">// 成功时发送值</span><br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Exception e)</span> &#123;<br>            sink.tryEmitError(e);     <span class="hljs-comment">// 失败时发送错误</span><br>        &#125;<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> sink.asMono();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-Sinks-Empty-无值（对应-Mono）"><a href="#2-Sinks-Empty-无值（对应-Mono）" class="headerlink" title="2. Sinks.Empty - 无值（对应 Mono）"></a>2. Sinks.Empty - 无值（对应 Mono<Void>）</h3><p>只发送完成或错误信号，不发送值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Empty&lt;Void&gt; sink = Sinks.empty();<br><br><span class="hljs-comment">// 发送完成信号</span><br>sink.tryEmitEmpty();<br><br><span class="hljs-comment">// 转为 Mono&lt;Void&gt;</span><br>Mono&lt;Void&gt; mono = sink.asMono();<br>mono.subscribe(<br>    v -&gt; &#123;&#125;,<br>    e -&gt; &#123;&#125;,<br>    () -&gt; System.out.println(<span class="hljs-string">&quot;完成了&quot;</span>)  <span class="hljs-comment">// 输出: 完成了</span><br>);<br></code></pre></td></tr></table></figure><p>使用场景：只关心操作是否完成，不关心返回值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 示例：等待初始化完成</span><br><span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">waitForInit</span><span class="hljs-params">()</span> &#123;<br>    Sinks.Empty&lt;Void&gt; sink = Sinks.empty();<br>    <br>    initService.onReady(() -&gt; sink.tryEmitEmpty());<br>    <br>    <span class="hljs-keyword">return</span> sink.asMono();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-Sinks-Many-多值（对应-Flux）"><a href="#3-Sinks-Many-多值（对应-Flux）" class="headerlink" title="3. Sinks.Many - 多值（对应 Flux）"></a>3. Sinks.Many - 多值（对应 Flux）</h3><p>可以发送 0 到 N 个值，这是最常用的类型。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 发送多个值</span><br>sink.tryEmitNext(<span class="hljs-string">&quot;消息1&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息2&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息3&quot;</span>);<br>sink.tryEmitComplete();<br><br><span class="hljs-comment">// 转为 Flux</span><br>Flux&lt;String&gt; flux = sink.asFlux();<br>flux.subscribe(System.out::println);<br><span class="hljs-comment">// 输出: 消息1, 消息2, 消息3</span><br></code></pre></td></tr></table></figure><hr><h2 id="Sinks-Many-的三种模式"><a href="#Sinks-Many-的三种模式" class="headerlink" title="Sinks.Many 的三种模式"></a>Sinks.Many 的三种模式</h2><h3 id="1-Unicast（单播）-只能有一个订阅者"><a href="#1-Unicast（单播）-只能有一个订阅者" class="headerlink" title="1. Unicast（单播）- 只能有一个订阅者"></a>1. Unicast（单播）- 只能有一个订阅者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Many&lt;String&gt; sink = Sinks.many().unicast().onBackpressureBuffer();<br><br>Flux&lt;String&gt; flux = sink.asFlux();<br><br><span class="hljs-comment">// 第一个订阅者 </span><br>flux.subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;订阅者1: &quot;</span> + v));<br><br><span class="hljs-comment">// 第二个订阅者  会报错！</span><br>flux.subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;订阅者2: &quot;</span> + v));<br><span class="hljs-comment">// 抛出 IllegalStateException</span><br></code></pre></td></tr></table></figure><p>特点：</p><ul><li>只允许一个订阅者</li><li>内存效率高（不需要维护多个订阅者状态）</li><li>适合点对点通信</li></ul><h3 id="2-Multicast（多播）-多个订阅者共享"><a href="#2-Multicast（多播）-多个订阅者共享" class="headerlink" title="2. Multicast（多播）- 多个订阅者共享"></a>2. Multicast（多播）- 多个订阅者共享</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br>Flux&lt;String&gt; flux = sink.asFlux();<br><br><span class="hljs-comment">// 多个订阅者都可以收到数据 </span><br>flux.subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;订阅者1: &quot;</span> + v));<br>flux.subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;订阅者2: &quot;</span> + v));<br><br>sink.tryEmitNext(<span class="hljs-string">&quot;Hello&quot;</span>);<br><span class="hljs-comment">// 输出:</span><br><span class="hljs-comment">// 订阅者1: Hello</span><br><span class="hljs-comment">// 订阅者2: Hello</span><br></code></pre></td></tr></table></figure><p>特点：</p><ul><li>允许多个订阅者</li><li>热流：新订阅者只能收到订阅后的数据</li><li>适合广播场景</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 热流特性演示</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br>sink.tryEmitNext(<span class="hljs-string">&quot;消息1&quot;</span>);  <span class="hljs-comment">// 此时没有订阅者，消息丢失</span><br><br>Flux&lt;String&gt; flux = sink.asFlux();<br>flux.subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;收到: &quot;</span> + v));<br><br>sink.tryEmitNext(<span class="hljs-string">&quot;消息2&quot;</span>);  <span class="hljs-comment">// 订阅者收到</span><br><span class="hljs-comment">// 输出: 收到: 消息2</span><br></code></pre></td></tr></table></figure><h3 id="3-Replay（重放）-新订阅者可收到历史数据"><a href="#3-Replay（重放）-新订阅者可收到历史数据" class="headerlink" title="3. Replay（重放）- 新订阅者可收到历史数据"></a>3. Replay（重放）- 新订阅者可收到历史数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 重放所有历史数据</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().replay().all();<br><br>sink.tryEmitNext(<span class="hljs-string">&quot;消息1&quot;</span>);<br>sink.tryEmitNext(<span class="hljs-string">&quot;消息2&quot;</span>);<br><br><span class="hljs-comment">// 新订阅者可以收到之前的数据！</span><br>sink.asFlux().subscribe(v -&gt; System.out.println(<span class="hljs-string">&quot;收到: &quot;</span> + v));<br><span class="hljs-comment">// 输出:</span><br><span class="hljs-comment">// 收到: 消息1</span><br><span class="hljs-comment">// 收到: 消息2</span><br></code></pre></td></tr></table></figure><p>Replay 的变体：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 重放所有</span><br>Sinks.many().replay().all();<br><br><span class="hljs-comment">// 重放最近 N 条</span><br>Sinks.many().replay().limit(<span class="hljs-number">10</span>);<br><br><span class="hljs-comment">// 只重放最新一条</span><br>Sinks.many().replay().latest();<br><br><span class="hljs-comment">// 重放指定时间内的数据</span><br>Sinks.many().replay().limit(Duration.ofMinutes(<span class="hljs-number">5</span>));<br></code></pre></td></tr></table></figure><hr><h2 id="三种模式对比"><a href="#三种模式对比" class="headerlink" title="三种模式对比"></a>三种模式对比</h2><table><thead><tr><th>模式</th><th>订阅者数量</th><th>历史数据</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Unicast</strong></td><td>1个</td><td>无</td><td>点对点、队列消费</td></tr><tr><td><strong>Multicast</strong></td><td>多个</td><td>无（热流）</td><td>事件广播、实时推送</td></tr><tr><td><strong>Replay</strong></td><td>多个</td><td>有（可配置）</td><td>状态共享、缓存</td></tr></tbody></table><hr><h2 id="发送数据的方法"><a href="#发送数据的方法" class="headerlink" title="发送数据的方法"></a>发送数据的方法</h2><h3 id="tryEmitXxx-vs-emitXxx"><a href="#tryEmitXxx-vs-emitXxx" class="headerlink" title="tryEmitXxx vs emitXxx"></a>tryEmitXxx vs emitXxx</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 方式1: tryEmitXxx - 返回结果，不抛异常</span><br>Sinks.<span class="hljs-type">EmitResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> sink.tryEmitNext(<span class="hljs-string">&quot;data&quot;</span>);<br><span class="hljs-keyword">if</span> (result.isFailure()) &#123;<br>    <span class="hljs-comment">// 处理失败</span><br>    System.out.println(<span class="hljs-string">&quot;发送失败: &quot;</span> + result);<br>&#125;<br><br><span class="hljs-comment">// 方式2: emitXxx - 可自定义失败处理</span><br>sink.emitNext(<span class="hljs-string">&quot;data&quot;</span>, (signalType, emitResult) -&gt; &#123;<br>    <span class="hljs-comment">// 返回 true 表示重试，false 表示放弃</span><br>    <span class="hljs-keyword">return</span> emitResult == Sinks.EmitResult.FAIL_NON_SERIALIZED;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="EmitResult-的类型"><a href="#EmitResult-的类型" class="headerlink" title="EmitResult 的类型"></a>EmitResult 的类型</h3><table><thead><tr><th>结果</th><th>说明</th></tr></thead><tbody><tr><td><code>OK</code></td><td>发送成功</td></tr><tr><td><code>FAIL_TERMINATED</code></td><td>Sink 已终止</td></tr><tr><td><code>FAIL_OVERFLOW</code></td><td>背压溢出</td></tr><tr><td><code>FAIL_CANCELLED</code></td><td>已取消</td></tr><tr><td><code>FAIL_NON_SERIALIZED</code></td><td>并发冲突（多线程同时发送）</td></tr><tr><td><code>FAIL_ZERO_SUBSCRIBER</code></td><td>没有订阅者（unicast）</td></tr></tbody></table><h3 id="常用的-EmitFailureHandler"><a href="#常用的-EmitFailureHandler" class="headerlink" title="常用的 EmitFailureHandler"></a>常用的 EmitFailureHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 快速失败 - 失败就放弃</span><br>Sinks.EmitFailureHandler.FAIL_FAST<br><br><span class="hljs-comment">// 忙等待重试 - 适合并发场景</span><br>Sinks.EmitFailureHandler.busyLooping(Duration.ofMillis(<span class="hljs-number">100</span>))<br></code></pre></td></tr></table></figure><hr><h2 id="实战示例"><a href="#实战示例" class="headerlink" title="实战示例"></a>实战示例</h2><h3 id="示例1：WebSocket-消息推送"><a href="#示例1：WebSocket-消息推送" class="headerlink" title="示例1：WebSocket 消息推送"></a>示例1：WebSocket 消息推送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketHandler</span> &#123;<br>    <br>    <span class="hljs-comment">// 用于向所有连接的客户端广播消息</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sinks.Many&lt;String&gt; messageSink = <br>        Sinks.many().multicast().onBackpressureBuffer();<br>    <br>    <span class="hljs-comment">// 获取消息流，供 WebSocket 订阅</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getMessageStream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> messageSink.asFlux();<br>    &#125;<br>    <br>    <span class="hljs-comment">// 发送消息给所有客户端</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">broadcast</span><span class="hljs-params">(String message)</span> &#123;<br>        messageSink.tryEmitNext(message);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// WebSocket 配置</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> HandlerMapping <span class="hljs-title function_">webSocketMapping</span><span class="hljs-params">(WebSocketHandler handler)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleUrlHandlerMapping</span>(Map.of(<br>        <span class="hljs-string">&quot;/ws&quot;</span>, session -&gt; session.send(<br>            handler.getMessageStream()<br>                .map(session::textMessage)<br>        )<br>    ), -<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="示例2：事件总线"><a href="#示例2：事件总线" class="headerlink" title="示例2：事件总线"></a>示例2：事件总线</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sinks.Many&lt;Event&gt; eventSink = <br>        Sinks.many().multicast().onBackpressureBuffer();<br>    <br>    <span class="hljs-comment">// 发布事件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publish</span><span class="hljs-params">(Event event)</span> &#123;<br>        eventSink.tryEmitNext(event);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 订阅特定类型的事件</span><br>    <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Event</span>&gt; Flux&lt;T&gt; <span class="hljs-title function_">subscribe</span><span class="hljs-params">(Class&lt;T&gt; eventType)</span> &#123;<br>        <span class="hljs-keyword">return</span> eventSink.asFlux()<br>            .filter(eventType::isInstance)<br>            .cast(eventType);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 使用</span><br>eventBus.subscribe(UserCreatedEvent.class)<br>    .subscribe(event -&gt; System.out.println(<span class="hljs-string">&quot;用户创建: &quot;</span> + event.getUserId()));<br><br>eventBus.publish(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCreatedEvent</span>(<span class="hljs-number">123L</span>));<br></code></pre></td></tr></table></figure><h3 id="示例3：异步任务结果收集"><a href="#示例3：异步任务结果收集" class="headerlink" title="示例3：异步任务结果收集"></a>示例3：异步任务结果收集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Flux&lt;Result&gt; <span class="hljs-title function_">executeTasksAsync</span><span class="hljs-params">(List&lt;Task&gt; tasks)</span> &#123;<br>    Sinks.Many&lt;Result&gt; sink = Sinks.many().unicast().onBackpressureBuffer();<br>    <br>    <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(tasks.size());<br>    <br>    <span class="hljs-keyword">for</span> (Task task : tasks) &#123;<br>        CompletableFuture.runAsync(() -&gt; &#123;<br>            <span class="hljs-type">Result</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> task.execute();<br>            sink.tryEmitNext(result);<br>            <br>            <span class="hljs-keyword">if</span> (remaining.decrementAndGet() == <span class="hljs-number">0</span>) &#123;<br>                sink.tryEmitComplete();<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> sink.asFlux();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="示例4：缓存最新状态"><a href="#示例4：缓存最新状态" class="headerlink" title="示例4：缓存最新状态"></a>示例4：缓存最新状态</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StatusCache</span> &#123;<br>    <br>    <span class="hljs-comment">// 使用 replay().latest() 缓存最新状态</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sinks.Many&lt;SystemStatus&gt; statusSink = <br>        Sinks.many().replay().latest();<br>    <br>    <span class="hljs-comment">// 更新状态</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(SystemStatus status)</span> &#123;<br>        statusSink.tryEmitNext(status);<br>    &#125;<br>    <br>    <span class="hljs-comment">// 获取当前状态（新订阅者立即收到最新状态）</span><br>    <span class="hljs-keyword">public</span> Mono&lt;SystemStatus&gt; <span class="hljs-title function_">getCurrentStatus</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> statusSink.asFlux().next();<br>    &#125;<br>    <br>    <span class="hljs-comment">// 监听状态变化</span><br>    <span class="hljs-keyword">public</span> Flux&lt;SystemStatus&gt; <span class="hljs-title function_">watchStatus</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> statusSink.asFlux();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="Sinks-vs-旧版-Processor"><a href="#Sinks-vs-旧版-Processor" class="headerlink" title="Sinks vs 旧版 Processor"></a>Sinks vs 旧版 Processor</h2><p>Reactor 3.4 之前使用 <code>Processor</code>，现在已废弃：</p><table><thead><tr><th>旧版 Processor</th><th>新版 Sinks</th></tr></thead><tbody><tr><td><code>DirectProcessor</code></td><td><code>Sinks.many().multicast().directBestEffort()</code></td></tr><tr><td><code>UnicastProcessor</code></td><td><code>Sinks.many().unicast()</code></td></tr><tr><td><code>ReplayProcessor</code></td><td><code>Sinks.many().replay()</code></td></tr><tr><td><code>EmitterProcessor</code></td><td><code>Sinks.many().multicast()</code></td></tr></tbody></table><p>为什么废弃 Processor？</p><ul><li>Processor 同时是 Publisher 和 Subscriber，职责不清</li><li>线程安全问题难以处理</li><li>Sinks 提供更清晰的 API 和更好的线程安全保证</li></ul><hr><h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>Sinks 默认是线程安全的，但有性能开销。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 默认：线程安全</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 如果确定单线程使用，可以用 unsafe 版本提升性能</span><br>Sinks.Many&lt;String&gt; unsafeSink = Sinks.unsafe().many().multicast().onBackpressureBuffer();<br></code></pre></td></tr></table></figure><p><strong>注意</strong>：<code>unsafe</code> 版本在多线程下会出问题，只在确定单线程时使用。</p><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>Sinks 是什么</strong></td><td>手动发送数据到响应式流的工具</td></tr><tr><td><strong>与 Mono&#x2F;Flux 关系</strong></td><td>Sinks 是数据源，通过 <code>asFlux()</code>&#x2F;<code>asMono()</code> 转换</td></tr><tr><td><strong>Sinks.One</strong></td><td>发送 0-1 个值，对应 Mono</td></tr><tr><td><strong>Sinks.Empty</strong></td><td>只发送完成&#x2F;错误信号，对应 Mono<Void></td></tr><tr><td><strong>Sinks.Many</strong></td><td>发送 0-N 个值，对应 Flux</td></tr><tr><td><strong>Unicast</strong></td><td>单订阅者</td></tr><tr><td><strong>Multicast</strong></td><td>多订阅者，热流</td></tr><tr><td><strong>Replay</strong></td><td>多订阅者，可重放历史</td></tr></tbody></table><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Reactor API 参考</li><li>Project Reactor 实现</li><li>WebFlux 核心组件</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>Sinks</tag>
      
      <tag>热流</tag>
      
      <tag>多播</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Webflux简介</title>
    <link href="/2026/01/10/Webflux%E7%AE%80%E4%BB%8B/"/>
    <url>/2026/01/10/Webflux%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Webflux-简介"><a href="#Webflux-简介" class="headerlink" title="Webflux 简介"></a>Webflux 简介</h1><h2 id="什么是-Spring-WebFlux"><a href="#什么是-Spring-WebFlux" class="headerlink" title="什么是 Spring WebFlux"></a>什么是 Spring WebFlux</h2><p>Spring WebFlux 是 Spring Framework 5.0 引入的<strong>响应式 Web 框架</strong>，它是 Spring MVC 的替代方案，专为构建<strong>非阻塞、异步</strong>的 Web 应用程序而设计。</p><h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul><li><strong>非阻塞 I&#x2F;O</strong>：基于事件驱动模型，不会阻塞线程等待 I&#x2F;O 操作完成</li><li><strong>响应式编程</strong>：基于 Reactive Streams 规范，使用 Project Reactor 作为默认实现</li><li><strong>背压支持</strong>：支持背压（Backpressure）机制，防止生产者压垮消费者</li><li><strong>函数式编程</strong>：支持函数式端点定义，提供更灵活的路由方式</li></ul><h2 id="WebFlux-vs-Spring-MVC"><a href="#WebFlux-vs-Spring-MVC" class="headerlink" title="WebFlux vs Spring MVC"></a>WebFlux vs Spring MVC</h2><table><thead><tr><th>特性</th><th>Spring MVC</th><th>Spring WebFlux</th></tr></thead><tbody><tr><td>编程模型</td><td>命令式（Imperative）</td><td>响应式（Reactive）</td></tr><tr><td>线程模型</td><td>每请求一线程</td><td>事件循环（Event Loop）</td></tr><tr><td>I&#x2F;O 模型</td><td>阻塞 I&#x2F;O</td><td>非阻塞 I&#x2F;O</td></tr><tr><td>适用场景</td><td>传统 Web 应用</td><td>高并发、流式数据</td></tr><tr><td>Servlet 依赖</td><td>依赖 Servlet API</td><td>可选（支持 Netty）</td></tr><tr><td>数据库支持</td><td>JDBC（阻塞）</td><td>R2DBC（响应式）</td></tr></tbody></table><h2 id="何时使用-WebFlux"><a href="#何时使用-WebFlux" class="headerlink" title="何时使用 WebFlux"></a>何时使用 WebFlux</h2><h3 id="适合使用的场景"><a href="#适合使用的场景" class="headerlink" title="适合使用的场景"></a>适合使用的场景</h3><ol><li><strong>高并发应用</strong>：需要处理大量并发连接（如聊天应用、实时推送）</li><li><strong>流式数据处理</strong>：处理实时数据流（如股票行情、IoT 数据）</li><li><strong>微服务网关</strong>：作为 API 网关处理大量请求转发</li><li><strong>服务间调用密集</strong>：需要大量调用外部服务的应用</li></ol><h3 id="不适合的场景"><a href="#不适合的场景" class="headerlink" title="不适合的场景"></a>不适合的场景</h3><ol><li><strong>CPU 密集型任务</strong>：响应式编程对 CPU 密集型任务没有优势</li><li><strong>阻塞依赖</strong>：如果依赖的库是阻塞的（如传统 JDBC），则无法发挥优势</li><li><strong>团队不熟悉响应式编程</strong>：学习曲线较陡</li></ol><h2 id="技术栈对比"><a href="#技术栈对比" class="headerlink" title="技术栈对比"></a>技术栈对比</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">┌─────────────────────────────────────────────────────────┐<br>│                    Spring Boot                          │<br>├────────────────────────┬────────────────────────────────┤<br>│     Spring MVC         │        Spring WebFlux          │<br>├────────────────────────┼────────────────────────────────┤<br>│     Servlet API        │     Reactive Streams API       │<br>├────────────────────────┼────────────────────────────────┤<br>│  Tomcat<span class="hljs-regexp">/Jetty/</span>Undertow │      Netty<span class="hljs-regexp">/Undertow/</span>Servlet    │<br>└────────────────────────┴────────────────────────────────┘<br></code></pre></td></tr></table></figure><h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><h3 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/hello&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;String&gt; <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-string">&quot;Hello, WebFlux!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/users&quot;)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">getUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findAll();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>下一篇：响应式编程基础</li><li>Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>WebFlux</tag>
      
      <tag>入门</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>WebFlux核心组件</title>
    <link href="/2026/01/10/WebFlux%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/"/>
    <url>/2026/01/10/WebFlux%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="WebFlux-核心组件"><a href="#WebFlux-核心组件" class="headerlink" title="WebFlux 核心组件"></a>WebFlux 核心组件</h1><h2 id="注解式编程模型"><a href="#注解式编程模型" class="headerlink" title="注解式编程模型"></a>注解式编程模型</h2><p>WebFlux 支持与 Spring MVC 类似的注解式编程，使用 <code>@Controller</code> 和 <code>@RestController</code>。</p><h3 id="基本控制器"><a href="#基本控制器" class="headerlink" title="基本控制器"></a>基本控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/users&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userService = userService;<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findAll();<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findById(id);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.CREATED)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.save(user);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id, <span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.update(id, user);<br>    &#125;<br>    <br>    <span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.deleteById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="响应式返回类型"><a href="#响应式返回类型" class="headerlink" title="响应式返回类型"></a>响应式返回类型</h3><table><thead><tr><th>返回类型</th><th>说明</th></tr></thead><tbody><tr><td><code>Mono&lt;T&gt;</code></td><td>返回单个对象</td></tr><tr><td><code>Flux&lt;T&gt;</code></td><td>返回多个对象（流式）</td></tr><tr><td><code>Mono&lt;Void&gt;</code></td><td>无返回值</td></tr><tr><td><code>Mono&lt;ResponseEntity&lt;T&gt;&gt;</code></td><td>自定义响应</td></tr></tbody></table><h2 id="WebClient-响应式-HTTP-客户端"><a href="#WebClient-响应式-HTTP-客户端" class="headerlink" title="WebClient - 响应式 HTTP 客户端"></a>WebClient - 响应式 HTTP 客户端</h2><p><code>WebClient</code> 是 WebFlux 提供的非阻塞 HTTP 客户端，用于替代 <code>RestTemplate</code>。</p><h3 id="创建-WebClient"><a href="#创建-WebClient" class="headerlink" title="创建 WebClient"></a>创建 WebClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 基本创建</span><br><span class="hljs-type">WebClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> WebClient.create();<br><br><span class="hljs-comment">// 带基础 URL</span><br><span class="hljs-type">WebClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> WebClient.create(<span class="hljs-string">&quot;http://localhost:8080&quot;</span>);<br><br><span class="hljs-comment">// 使用 Builder 自定义</span><br><span class="hljs-type">WebClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> WebClient.builder()<br>    .baseUrl(<span class="hljs-string">&quot;http://localhost:8080&quot;</span>)<br>    .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)<br>    .defaultHeader(HttpHeaders.AUTHORIZATION, <span class="hljs-string">&quot;Bearer token&quot;</span>)<br>    .filter(ExchangeFilterFunction.ofRequestProcessor(<br>        request -&gt; &#123;<br>            log.info(<span class="hljs-string">&quot;Request: &#123;&#125; &#123;&#125;&quot;</span>, request.method(), request.url());<br>            <span class="hljs-keyword">return</span> Mono.just(request);<br>        &#125;<br>    ))<br>    .build();<br></code></pre></td></tr></table></figure><h3 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取单个对象</span><br>Mono&lt;User&gt; user = webClient.get()<br>    .uri(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)<br>    .retrieve()<br>    .bodyToMono(User.class);<br><br><span class="hljs-comment">// 获取列表</span><br>Flux&lt;User&gt; users = webClient.get()<br>    .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>    .retrieve()<br>    .bodyToFlux(User.class);<br><br><span class="hljs-comment">// 带查询参数</span><br>Flux&lt;User&gt; users = webClient.get()<br>    .uri(uriBuilder -&gt; uriBuilder<br>        .path(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>        .queryParam(<span class="hljs-string">&quot;page&quot;</span>, <span class="hljs-number">0</span>)<br>        .queryParam(<span class="hljs-string">&quot;size&quot;</span>, <span class="hljs-number">10</span>)<br>        .build())<br>    .retrieve()<br>    .bodyToFlux(User.class);<br></code></pre></td></tr></table></figure><h3 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono&lt;User&gt; createdUser = webClient.post()<br>    .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>    .contentType(MediaType.APPLICATION_JSON)<br>    .bodyValue(newUser)<br>    .retrieve()<br>    .bodyToMono(User.class);<br><br><span class="hljs-comment">// 使用 Mono 作为请求体</span><br>Mono&lt;User&gt; createdUser = webClient.post()<br>    .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>    .body(userMono, User.class)<br>    .retrieve()<br>    .bodyToMono(User.class);<br></code></pre></td></tr></table></figure><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono&lt;User&gt; user = webClient.get()<br>    .uri(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)<br>    .retrieve()<br>    .onStatus(HttpStatusCode::is4xxClientError, response -&gt; <br>        Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NotFoundException</span>(<span class="hljs-string">&quot;User not found&quot;</span>)))<br>    .onStatus(HttpStatusCode::is5xxServerError, response -&gt; <br>        Mono.error(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerException</span>(<span class="hljs-string">&quot;Server error&quot;</span>)))<br>    .bodyToMono(User.class);<br></code></pre></td></tr></table></figure><h3 id="使用-exchange-获取完整响应"><a href="#使用-exchange-获取完整响应" class="headerlink" title="使用 exchange() 获取完整响应"></a>使用 exchange() 获取完整响应</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono&lt;ResponseEntity&lt;User&gt;&gt; response = webClient.get()<br>    .uri(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)<br>    .exchangeToMono(clientResponse -&gt; &#123;<br>        <span class="hljs-keyword">if</span> (clientResponse.statusCode().is2xxSuccessful()) &#123;<br>            <span class="hljs-keyword">return</span> clientResponse.toEntity(User.class);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> clientResponse.createException().flatMap(Mono::error);<br>        &#125;<br>    &#125;);<br></code></pre></td></tr></table></figure><h2 id="ServerRequest-和-ServerResponse"><a href="#ServerRequest-和-ServerResponse" class="headerlink" title="ServerRequest 和 ServerResponse"></a>ServerRequest 和 ServerResponse</h2><p>这两个类用于函数式端点编程。</p><h3 id="ServerRequest"><a href="#ServerRequest" class="headerlink" title="ServerRequest"></a>ServerRequest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取路径变量</span><br><span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.pathVariable(<span class="hljs-string">&quot;id&quot;</span>);<br><br><span class="hljs-comment">// 获取查询参数</span><br>Optional&lt;String&gt; name = request.queryParam(<span class="hljs-string">&quot;name&quot;</span>);<br><br><span class="hljs-comment">// 获取请求头</span><br><span class="hljs-type">String</span> <span class="hljs-variable">contentType</span> <span class="hljs-operator">=</span> request.headers().contentType()<br>    .map(MediaType::toString)<br>    .orElse(<span class="hljs-string">&quot;unknown&quot;</span>);<br><br><span class="hljs-comment">// 获取请求体</span><br>Mono&lt;User&gt; user = request.bodyToMono(User.class);<br>Flux&lt;User&gt; users = request.bodyToFlux(User.class);<br></code></pre></td></tr></table></figure><h3 id="ServerResponse"><a href="#ServerResponse" class="headerlink" title="ServerResponse"></a>ServerResponse</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 成功响应</span><br>ServerResponse.ok()<br>    .contentType(MediaType.APPLICATION_JSON)<br>    .bodyValue(user);<br><br><span class="hljs-comment">// 返回 Mono</span><br>ServerResponse.ok().body(userMono, User.class);<br><br><span class="hljs-comment">// 返回 Flux</span><br>ServerResponse.ok().body(userFlux, User.class);<br><br><span class="hljs-comment">// 创建响应</span><br>ServerResponse.created(URI.create(<span class="hljs-string">&quot;/api/users/&quot;</span> + id))<br>    .bodyValue(user);<br><br><span class="hljs-comment">// 无内容响应</span><br>ServerResponse.noContent().build();<br><br><span class="hljs-comment">// 错误响应</span><br>ServerResponse.notFound().build();<br>ServerResponse.badRequest().bodyValue(<span class="hljs-string">&quot;Invalid request&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="使用-ExceptionHandler"><a href="#使用-ExceptionHandler" class="headerlink" title="使用 @ExceptionHandler"></a>使用 @ExceptionHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br>    <br>    <span class="hljs-meta">@ExceptionHandler(NotFoundException.class)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;ErrorResponse&gt; <span class="hljs-title function_">handleNotFound</span><span class="hljs-params">(NotFoundException ex)</span> &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(ex.getMessage()));<br>    &#125;<br>    <br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;ErrorResponse&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception ex)</span> &#123;<br>        <span class="hljs-keyword">return</span> Mono.just(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>(<span class="hljs-string">&quot;Internal server error&quot;</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用-WebExceptionHandler"><a href="#使用-WebExceptionHandler" class="headerlink" title="使用 WebExceptionHandler"></a>使用 WebExceptionHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Order(-2)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalWebExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebExceptionHandler</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerWebExchange exchange, Throwable ex)</span> &#123;<br>        <span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> NotFoundException) &#123;<br>            exchange.getResponse().setStatusCode(HttpStatus.NOT_FOUND);<br>            <span class="hljs-comment">// 写入响应体...</span><br>        &#125;<br>        <span class="hljs-keyword">return</span> Mono.error(ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="过滤器（WebFilter）"><a href="#过滤器（WebFilter）" class="headerlink" title="过滤器（WebFilter）"></a>过滤器（WebFilter）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebFilter</span> &#123;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>        <br>        <span class="hljs-keyword">return</span> chain.filter(exchange)<br>            .doFinally(signalType -&gt; &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;<br>                log.info(<span class="hljs-string">&quot;Request &#123;&#125; &#123;&#125; completed in &#123;&#125;ms&quot;</span>,<br>                    exchange.getRequest().getMethod(),<br>                    exchange.getRequest().getPath(),<br>                    duration);<br>            &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：Reactor核心API</li><li>下一篇：函数式端点</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>WebFlux</tag>
      
      <tag>Controller</tag>
      
      <tag>WebClient</tag>
      
      <tag>WebFilter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>函数式端点</title>
    <link href="/2026/01/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%AB%AF%E7%82%B9/"/>
    <url>/2026/01/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%AB%AF%E7%82%B9/</url>
    
    <content type="html"><![CDATA[<h1 id="函数式端点"><a href="#函数式端点" class="headerlink" title="函数式端点"></a>函数式端点</h1><h2 id="什么是函数式端点"><a href="#什么是函数式端点" class="headerlink" title="什么是函数式端点"></a>什么是函数式端点</h2><p>函数式端点（Functional Endpoints）是 WebFlux 提供的另一种编程模型，使用<strong>函数式风格</strong>定义路由和处理器，相比注解式更加灵活。</p><h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><ul><li><strong>HandlerFunction</strong>：处理请求的函数，类似于 <code>@RequestMapping</code> 方法</li><li><strong>RouterFunction</strong>：路由函数，将请求映射到 HandlerFunction</li></ul><h2 id="HandlerFunction"><a href="#HandlerFunction" class="headerlink" title="HandlerFunction"></a>HandlerFunction</h2><p><code>HandlerFunction&lt;T extends ServerResponse&gt;</code> 是一个函数式接口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FunctionalInterface</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HandlerFunction</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServerResponse</span>&gt; &#123;<br>    Mono&lt;T&gt; <span class="hljs-title function_">handle</span><span class="hljs-params">(ServerRequest request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="定义-Handler"><a href="#定义-Handler" class="headerlink" title="定义 Handler"></a>定义 Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHandler</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserHandler</span><span class="hljs-params">(UserService userService)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userService = userService;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> ServerResponse.ok()<br>            .contentType(MediaType.APPLICATION_JSON)<br>            .body(userService.findAll(), User.class);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.pathVariable(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-keyword">return</span> userService.findById(id)<br>            .flatMap(user -&gt; ServerResponse.ok()<br>                .contentType(MediaType.APPLICATION_JSON)<br>                .bodyValue(user))<br>            .switchIfEmpty(ServerResponse.notFound().build());<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> request.bodyToMono(User.class)<br>            .flatMap(userService::save)<br>            .flatMap(user -&gt; ServerResponse<br>                .created(URI.create(<span class="hljs-string">&quot;/api/users/&quot;</span> + user.getId()))<br>                .contentType(MediaType.APPLICATION_JSON)<br>                .bodyValue(user));<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.pathVariable(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-keyword">return</span> request.bodyToMono(User.class)<br>            .flatMap(user -&gt; userService.update(id, user))<br>            .flatMap(user -&gt; ServerResponse.ok()<br>                .contentType(MediaType.APPLICATION_JSON)<br>                .bodyValue(user))<br>            .switchIfEmpty(ServerResponse.notFound().build());<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.pathVariable(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-keyword">return</span> userService.deleteById(id)<br>            .then(ServerResponse.noContent().build());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RouterFunction"><a href="#RouterFunction" class="headerlink" title="RouterFunction"></a>RouterFunction</h2><p><code>RouterFunction&lt;T extends ServerResponse&gt;</code> 用于定义路由规则。</p><h3 id="基本路由定义"><a href="#基本路由定义" class="headerlink" title="基本路由定义"></a>基本路由定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RouterConfig</span> &#123;<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">userRoutes</span><span class="hljs-params">(UserHandler handler)</span> &#123;<br>        <span class="hljs-keyword">return</span> RouterFunctions.route()<br>            .GET(<span class="hljs-string">&quot;/api/users&quot;</span>, handler::getAllUsers)<br>            .GET(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)<br>            .POST(<span class="hljs-string">&quot;/api/users&quot;</span>, handler::createUser)<br>            .PUT(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::updateUser)<br>            .DELETE(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::deleteUser)<br>            .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用-nest-组织路由"><a href="#使用-nest-组织路由" class="headerlink" title="使用 nest 组织路由"></a>使用 nest 组织路由</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routes</span><span class="hljs-params">(UserHandler userHandler, </span><br><span class="hljs-params">                                              OrderHandler orderHandler)</span> &#123;<br>    <span class="hljs-keyword">return</span> RouterFunctions.route()<br>        .nest(path(<span class="hljs-string">&quot;/api/users&quot;</span>), builder -&gt; builder<br>            .GET(<span class="hljs-string">&quot;&quot;</span>, userHandler::getAllUsers)<br>            .GET(<span class="hljs-string">&quot;/&#123;id&#125;&quot;</span>, userHandler::getUserById)<br>            .POST(<span class="hljs-string">&quot;&quot;</span>, userHandler::createUser)<br>            .PUT(<span class="hljs-string">&quot;/&#123;id&#125;&quot;</span>, userHandler::updateUser)<br>            .DELETE(<span class="hljs-string">&quot;/&#123;id&#125;&quot;</span>, userHandler::deleteUser)<br>        )<br>        .nest(path(<span class="hljs-string">&quot;/api/orders&quot;</span>), builder -&gt; builder<br>            .GET(<span class="hljs-string">&quot;&quot;</span>, orderHandler::getAllOrders)<br>            .GET(<span class="hljs-string">&quot;/&#123;id&#125;&quot;</span>, orderHandler::getOrderById)<br>            .POST(<span class="hljs-string">&quot;&quot;</span>, orderHandler::createOrder)<br>        )<br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="添加过滤器"><a href="#添加过滤器" class="headerlink" title="添加过滤器"></a>添加过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routes</span><span class="hljs-params">(UserHandler handler)</span> &#123;<br>    <span class="hljs-keyword">return</span> RouterFunctions.route()<br>        .GET(<span class="hljs-string">&quot;/api/users&quot;</span>, handler::getAllUsers)<br>        .GET(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)<br>        .filter((request, next) -&gt; &#123;<br>            <span class="hljs-comment">// 前置处理</span><br>            log.info(<span class="hljs-string">&quot;Request: &#123;&#125; &#123;&#125;&quot;</span>, request.method(), request.path());<br>            <br>            <span class="hljs-keyword">return</span> next.handle(request)<br>                .doOnNext(response -&gt; &#123;<br>                    <span class="hljs-comment">// 后置处理</span><br>                    log.info(<span class="hljs-string">&quot;Response status: &#123;&#125;&quot;</span>, response.statusCode());<br>                &#125;);<br>        &#125;)<br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="条件路由"><a href="#条件路由" class="headerlink" title="条件路由"></a>条件路由</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routes</span><span class="hljs-params">(UserHandler handler)</span> &#123;<br>    <span class="hljs-keyword">return</span> RouterFunctions.route()<br>        <span class="hljs-comment">// 使用 RequestPredicate 进行条件匹配</span><br>        .route(GET(<span class="hljs-string">&quot;/api/users&quot;</span>).and(accept(MediaType.APPLICATION_JSON)), <br>               handler::getAllUsers)<br>        .route(GET(<span class="hljs-string">&quot;/api/users&quot;</span>).and(accept(MediaType.TEXT_EVENT_STREAM)), <br>               handler::streamUsers)<br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="RequestPredicate"><a href="#RequestPredicate" class="headerlink" title="RequestPredicate"></a>RequestPredicate</h2><p><code>RequestPredicate</code> 用于定义请求匹配条件。</p><h3 id="常用谓词"><a href="#常用谓词" class="headerlink" title="常用谓词"></a>常用谓词</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.springframework.web.reactive.function.server.RequestPredicates.*;<br><br><span class="hljs-comment">// HTTP 方法</span><br>GET(<span class="hljs-string">&quot;/path&quot;</span>)<br>POST(<span class="hljs-string">&quot;/path&quot;</span>)<br>PUT(<span class="hljs-string">&quot;/path&quot;</span>)<br>DELETE(<span class="hljs-string">&quot;/path&quot;</span>)<br><br><span class="hljs-comment">// 内容类型</span><br>accept(MediaType.APPLICATION_JSON)<br>contentType(MediaType.APPLICATION_JSON)<br><br><span class="hljs-comment">// 路径匹配</span><br>path(<span class="hljs-string">&quot;/api/**&quot;</span>)<br>pathExtension(<span class="hljs-string">&quot;json&quot;</span>)<br><br><span class="hljs-comment">// 查询参数</span><br>queryParam(<span class="hljs-string">&quot;name&quot;</span>, value -&gt; value.length() &gt; <span class="hljs-number">0</span>)<br><br><span class="hljs-comment">// 请求头</span><br>headers(headers -&gt; headers.header(<span class="hljs-string">&quot;X-Custom&quot;</span>).isPresent())<br><br><span class="hljs-comment">// 组合条件</span><br>GET(<span class="hljs-string">&quot;/api/users&quot;</span>).and(accept(MediaType.APPLICATION_JSON))<br>GET(<span class="hljs-string">&quot;/api/users&quot;</span>).or(GET(<span class="hljs-string">&quot;/users&quot;</span>))<br></code></pre></td></tr></table></figure><h2 id="请求验证"><a href="#请求验证" class="headerlink" title="请求验证"></a>请求验证</h2><h3 id="手动验证"><a href="#手动验证" class="headerlink" title="手动验证"></a>手动验证</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>    <span class="hljs-keyword">return</span> request.bodyToMono(User.class)<br>        .flatMap(user -&gt; &#123;<br>            <span class="hljs-comment">// 验证</span><br>            List&lt;String&gt; errors = validate(user);<br>            <span class="hljs-keyword">if</span> (!errors.isEmpty()) &#123;<br>                <span class="hljs-keyword">return</span> ServerResponse.badRequest()<br>                    .bodyValue(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationError</span>(errors));<br>            &#125;<br>            <span class="hljs-keyword">return</span> userService.save(user)<br>                .flatMap(saved -&gt; ServerResponse.created(<br>                    URI.create(<span class="hljs-string">&quot;/api/users/&quot;</span> + saved.getId()))<br>                    .bodyValue(saved));<br>        &#125;);<br>&#125;<br><br><span class="hljs-keyword">private</span> List&lt;String&gt; <span class="hljs-title function_">validate</span><span class="hljs-params">(User user)</span> &#123;<br>    List&lt;String&gt; errors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (user.getName() == <span class="hljs-literal">null</span> || user.getName().isBlank()) &#123;<br>        errors.add(<span class="hljs-string">&quot;Name is required&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (user.getEmail() == <span class="hljs-literal">null</span> || !user.getEmail().contains(<span class="hljs-string">&quot;@&quot;</span>)) &#123;<br>        errors.add(<span class="hljs-string">&quot;Valid email is required&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> errors;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用-Validator"><a href="#使用-Validator" class="headerlink" title="使用 Validator"></a>使用 Validator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHandler</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Validator validator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;ServerResponse&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(ServerRequest request)</span> &#123;<br>        <span class="hljs-keyword">return</span> request.bodyToMono(User.class)<br>            .flatMap(user -&gt; &#123;<br>                <span class="hljs-type">Errors</span> <span class="hljs-variable">errors</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanPropertyBindingResult</span>(user, <span class="hljs-string">&quot;user&quot;</span>);<br>                validator.validate(user, errors);<br>                <br>                <span class="hljs-keyword">if</span> (errors.hasErrors()) &#123;<br>                    <span class="hljs-keyword">return</span> ServerResponse.badRequest()<br>                        .bodyValue(errors.getAllErrors());<br>                &#125;<br>                <br>                <span class="hljs-keyword">return</span> userService.save(user)<br>                    .flatMap(saved -&gt; ServerResponse.created(<br>                        URI.create(<span class="hljs-string">&quot;/api/users/&quot;</span> + saved.getId()))<br>                        .bodyValue(saved));<br>            &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="hljs-title function_">routes</span><span class="hljs-params">(UserHandler handler)</span> &#123;<br>    <span class="hljs-keyword">return</span> RouterFunctions.route()<br>        .GET(<span class="hljs-string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)<br>        .onError(NotFoundException.class, (e, request) -&gt; <br>            ServerResponse.notFound().build())<br>        .onError(ValidationException.class, (e, request) -&gt; <br>            ServerResponse.badRequest().bodyValue(e.getMessage()))<br>        .onError(Exception.class, (e, request) -&gt; <br>            ServerResponse.status(HttpStatus.INTERNAL_SERVER_ERROR)<br>                .bodyValue(<span class="hljs-string">&quot;Internal server error&quot;</span>))<br>        .build();<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="函数式-vs-注解式"><a href="#函数式-vs-注解式" class="headerlink" title="函数式 vs 注解式"></a>函数式 vs 注解式</h2><table><thead><tr><th>特性</th><th>注解式</th><th>函数式</th></tr></thead><tbody><tr><td>代码风格</td><td>声明式</td><td>函数式</td></tr><tr><td>路由定义</td><td>分散在各个方法</td><td>集中在一处</td></tr><tr><td>灵活性</td><td>较低</td><td>较高</td></tr><tr><td>学习曲线</td><td>较低</td><td>较高</td></tr><tr><td>测试</td><td>需要 Spring 上下文</td><td>可以单元测试</td></tr><tr><td>适用场景</td><td>传统 CRUD</td><td>复杂路由逻辑</td></tr></tbody></table><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：WebFlux核心组件</li><li>下一篇：实战案例</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>WebFlux</tag>
      
      <tag>函数式编程</tag>
      
      <tag>RouterFunction</tag>
      
      <tag>HandlerFunction</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>响应式编程基础</title>
    <link href="/2026/01/10/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
    <url>/2026/01/10/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/</url>
    
    <content type="html"><![CDATA[<h1 id="响应式编程基础"><a href="#响应式编程基础" class="headerlink" title="响应式编程基础"></a>响应式编程基础</h1><h2 id="什么是响应式编程"><a href="#什么是响应式编程" class="headerlink" title="什么是响应式编程"></a>什么是响应式编程</h2><p>响应式编程（Reactive Programming）是一种<strong>面向数据流和变化传播</strong>的编程范式。它关注的是数据流的异步处理和事件驱动。</p><h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><ul><li><strong>数据流（Stream）</strong>：数据以流的形式传递，而非一次性返回</li><li><strong>异步（Asynchronous）</strong>：操作不会阻塞当前线程</li><li><strong>非阻塞（Non-blocking）</strong>：线程不会等待 I&#x2F;O 操作完成</li><li><strong>背压（Backpressure）</strong>：消费者可以控制生产者的数据发送速率</li></ul><h2 id="Reactive-Streams-规范"><a href="#Reactive-Streams-规范" class="headerlink" title="Reactive Streams 规范"></a>Reactive Streams 规范</h2><p>Reactive Streams 是 JVM 上响应式编程的标准规范，定义了四个核心接口：</p><h3 id="1-Publisher（发布者）"><a href="#1-Publisher（发布者）" class="headerlink" title="1. Publisher（发布者）"></a>1. Publisher（发布者）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Publisher</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(Subscriber&lt;? <span class="hljs-built_in">super</span> T&gt; s)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>数据的生产者</li><li>可以发布无限或有限数量的元素</li></ul><h3 id="2-Subscriber（订阅者）"><a href="#2-Subscriber（订阅者）" class="headerlink" title="2. Subscriber（订阅者）"></a>2. Subscriber（订阅者）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSubscribe</span><span class="hljs-params">(Subscription s)</span>;  <span class="hljs-comment">// 订阅成功时调用</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(T t)</span>;                   <span class="hljs-comment">// 接收到新元素时调用</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Throwable t)</span>;          <span class="hljs-comment">// 发生错误时调用</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onComplete</span><span class="hljs-params">()</span>;                  <span class="hljs-comment">// 数据流结束时调用</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>数据的消费者</li><li>通过回调方法接收数据和事件</li></ul><h3 id="3-Subscription（订阅关系）"><a href="#3-Subscription（订阅关系）" class="headerlink" title="3. Subscription（订阅关系）"></a>3. Subscription（订阅关系）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Subscription</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span>;  <span class="hljs-comment">// 请求 n 个元素</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">()</span>;         <span class="hljs-comment">// 取消订阅</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>表示 Publisher 和 Subscriber 之间的订阅关系</li><li><strong>背压的核心</strong>：通过 <code>request(n)</code> 控制数据流速</li></ul><h3 id="4-Processor（处理器）"><a href="#4-Processor（处理器）" class="headerlink" title="4. Processor（处理器）"></a>4. Processor（处理器）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Processor</span>&lt;T, R&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>既是订阅者又是发布者</li><li>用于数据转换和处理</li></ul><h2 id="数据流生命周期"><a href="#数据流生命周期" class="headerlink" title="数据流生命周期"></a>数据流生命周期</h2><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs isbl">┌──────────────┐     <span class="hljs-function"><span class="hljs-title">subscribe</span>()      ┌──────────────┐</span><br><span class="hljs-function">│   <span class="hljs-variable">Publisher</span>  │ ──────────────────▶  │  <span class="hljs-variable">Subscriber</span>  │</span><br><span class="hljs-function">└──────────────┘                      └──────────────┘</span><br><span class="hljs-function">       │                                     │</span><br><span class="hljs-function">       │         <span class="hljs-title">onSubscribe</span>(<span class="hljs-variable">subscription</span>)   │</span><br><span class="hljs-function">       │ ◀────────────────────────────────── │</span><br><span class="hljs-function">       │                                     │</span><br><span class="hljs-function">       │         <span class="hljs-title">request</span>(<span class="hljs-variable">n</span>)                  │</span><br><span class="hljs-function">       │ ◀────────────────────────────────── │</span><br><span class="hljs-function">       │                                     │</span><br><span class="hljs-function">       │         <span class="hljs-title">onNext</span>(<span class="hljs-variable">data</span>) × <span class="hljs-variable">n</span>            │</span><br><span class="hljs-function">       │ ──────────────────────────────────▶ │</span><br><span class="hljs-function">       │                                     │</span><br><span class="hljs-function">       │         <span class="hljs-title">onComplete</span>() / <span class="hljs-title">onError</span>()    │</span><br><span class="hljs-function">       │ ──────────────────────────────────▶ │</span><br><span class="hljs-function">       ▼                                     ▼</span><br></code></pre></td></tr></table></figure><h2 id="背压（Backpressure）"><a href="#背压（Backpressure）" class="headerlink" title="背压（Backpressure）"></a>背压（Backpressure）</h2><p>背压是响应式编程中的重要概念，用于解决<strong>生产者速度快于消费者</strong>的问题。</p><h3 id="背压策略"><a href="#背压策略" class="headerlink" title="背压策略"></a>背压策略</h3><table><thead><tr><th>策略</th><th>说明</th></tr></thead><tbody><tr><td><strong>Buffer</strong></td><td>缓存所有元素，可能导致内存溢出</td></tr><tr><td><strong>Drop</strong></td><td>丢弃无法处理的元素</td></tr><tr><td><strong>Latest</strong></td><td>只保留最新的元素</td></tr><tr><td><strong>Error</strong></td><td>抛出异常</td></tr></tbody></table><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>)<br>    .onBackpressureBuffer(<span class="hljs-number">100</span>)      <span class="hljs-comment">// 缓存100个元素</span><br>    .onBackpressureDrop()           <span class="hljs-comment">// 丢弃多余元素</span><br>    .onBackpressureLatest()         <span class="hljs-comment">// 只保留最新</span><br>    .subscribe(data -&gt; &#123;<br>        <span class="hljs-comment">// 处理数据</span><br>    &#125;);<br></code></pre></td></tr></table></figure><h2 id="响应式编程的优势"><a href="#响应式编程的优势" class="headerlink" title="响应式编程的优势"></a>响应式编程的优势</h2><ol><li><strong>资源利用率高</strong>：少量线程处理大量请求</li><li><strong>响应性好</strong>：不会因为某个操作阻塞整个系统</li><li><strong>弹性</strong>：更容易处理错误和故障</li><li><strong>可组合性</strong>：操作符可以灵活组合</li></ol><h2 id="响应式编程的挑战"><a href="#响应式编程的挑战" class="headerlink" title="响应式编程的挑战"></a>响应式编程的挑战</h2><ol><li><strong>调试困难</strong>：异步代码的堆栈跟踪不直观</li><li><strong>学习曲线</strong>：需要转变思维方式</li><li><strong>生态限制</strong>：需要整个调用链都是响应式的</li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：Webflux简介</li><li>下一篇：Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>WebFlux</tag>
      
      <tag>响应式编程</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>实战案例</title>
    <link href="/2026/01/10/%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/"/>
    <url>/2026/01/10/%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus">webflux-demo/<br>├── <span class="hljs-attribute">src</span>/main/java/com/example/demo/<br>│   ├── DemoApplication<span class="hljs-selector-class">.java</span><br>│   ├── config/<br>│   │   └── RouterConfig<span class="hljs-selector-class">.java</span><br>│   ├── controller/<br>│   │   └── UserController<span class="hljs-selector-class">.java</span><br>│   ├── handler/<br>│   │   └── UserHandler<span class="hljs-selector-class">.java</span><br>│   ├── model/<br>│   │   └── User<span class="hljs-selector-class">.java</span><br>│   ├── repository/<br>│   │   └── UserRepository<span class="hljs-selector-class">.java</span><br>│   └── service/<br>│       └── UserService<span class="hljs-selector-class">.java</span><br>├── <span class="hljs-attribute">src</span>/main/resources/<br>│   └── application<span class="hljs-selector-class">.yml</span><br>└── pom.xml<br></code></pre></td></tr></table></figure><h2 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 </span></span><br><span class="hljs-string"><span class="hljs-tag">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>webflux-demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- WebFlux --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- R2DBC (响应式数据库) --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- H2 数据库 (开发测试用) --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.r2dbc<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>r2dbc-h2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- Lombok --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <br>        <span class="hljs-comment">&lt;!-- 测试 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.projectreactor<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>reactor-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.model;<br><br><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<br><span class="hljs-keyword">import</span> lombok.Data;<br><span class="hljs-keyword">import</span> lombok.NoArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.data.annotation.Id;<br><span class="hljs-keyword">import</span> org.springframework.data.relational.core.mapping.Table;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Table(&quot;users&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <br>    <span class="hljs-meta">@Id</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String email;<br>    <span class="hljs-keyword">private</span> LocalDateTime createdAt;<br>    <span class="hljs-keyword">private</span> LocalDateTime updatedAt;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.repository;<br><br><span class="hljs-keyword">import</span> com.example.demo.model.User;<br><span class="hljs-keyword">import</span> org.springframework.data.r2dbc.repository.Query;<br><span class="hljs-keyword">import</span> org.springframework.data.repository.reactive.ReactiveCrudRepository;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReactiveCrudRepository</span>&lt;User, Long&gt; &#123;<br>    <br>    Mono&lt;User&gt; <span class="hljs-title function_">findByEmail</span><span class="hljs-params">(String email)</span>;<br>    <br>    Flux&lt;User&gt; <span class="hljs-title function_">findByNameContaining</span><span class="hljs-params">(String name)</span>;<br>    <br>    <span class="hljs-meta">@Query(&quot;SELECT * FROM users WHERE created_at &gt; :since&quot;)</span><br>    Flux&lt;User&gt; <span class="hljs-title function_">findRecentUsers</span><span class="hljs-params">(LocalDateTime since)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.service;<br><br><span class="hljs-keyword">import</span> com.example.demo.model.User;<br><span class="hljs-keyword">import</span> com.example.demo.repository.UserRepository;<br><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> java.time.LocalDateTime;<br><br><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;<br>    <br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findAll();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findById(id);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">findByEmail</span><span class="hljs-params">(String email)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findByEmail(email);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> &#123;<br>        user.setCreatedAt(LocalDateTime.now());<br>        user.setUpdatedAt(LocalDateTime.now());<br>        <span class="hljs-keyword">return</span> userRepository.save(user);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">update</span><span class="hljs-params">(Long id, User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.findById(id)<br>            .flatMap(existingUser -&gt; &#123;<br>                existingUser.setName(user.getName());<br>                existingUser.setEmail(user.getEmail());<br>                existingUser.setUpdatedAt(LocalDateTime.now());<br>                <span class="hljs-keyword">return</span> userRepository.save(existingUser);<br>            &#125;);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userRepository.deleteById(id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Controller（注解式）"><a href="#Controller（注解式）" class="headerlink" title="Controller（注解式）"></a>Controller（注解式）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.controller;<br><br><span class="hljs-keyword">import</span> com.example.demo.model.User;<br><span class="hljs-keyword">import</span> com.example.demo.service.UserService;<br><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;<br><span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-keyword">import</span> java.time.Duration;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/users&quot;)</span><br><span class="hljs-meta">@RequiredArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;<br>    <br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findAll();<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findById(id);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.CREATED)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.save(user);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.update(id, user);<br>    &#125;<br>    <br>    <span class="hljs-meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.deleteById(id);<br>    &#125;<br>    <br>    <span class="hljs-comment">// SSE 流式响应示例</span><br>    <span class="hljs-meta">@GetMapping(value = &quot;/stream&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">streamUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findAll()<br>            .delayElements(Duration.ofSeconds(<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># application.yml</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">r2dbc:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">r2dbc:h2:mem:///testdb</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">sa</span><br>    <span class="hljs-attr">password:</span><br>  <br>  <span class="hljs-attr">sql:</span><br>    <span class="hljs-attr">init:</span><br>      <span class="hljs-attr">mode:</span> <span class="hljs-string">always</span><br>      <span class="hljs-attr">schema-locations:</span> <span class="hljs-string">classpath:schema.sql</span><br><br><span class="hljs-attr">logging:</span><br>  <span class="hljs-attr">level:</span><br>    <span class="hljs-attr">org.springframework.r2dbc:</span> <span class="hljs-string">DEBUG</span><br></code></pre></td></tr></table></figure><h2 id="数据库初始化脚本"><a href="#数据库初始化脚本" class="headerlink" title="数据库初始化脚本"></a>数据库初始化脚本</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- schema.sql</span><br><span class="hljs-keyword">CREATE TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (<br>    id <span class="hljs-type">BIGINT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY KEY</span>,<br>    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT NULL</span>,<br>    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span> <span class="hljs-keyword">NOT NULL</span>,<br>    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,<br>    updated_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span><br>);<br><br><span class="hljs-keyword">INSERT INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;张三&#x27;</span>, <span class="hljs-string">&#x27;zhangsan@example.com&#x27;</span>);<br><span class="hljs-keyword">INSERT INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;李四&#x27;</span>, <span class="hljs-string">&#x27;lisi@example.com&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="WebClient-调用示例"><a href="#WebClient-调用示例" class="headerlink" title="WebClient 调用示例"></a>WebClient 调用示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.client;<br><br><span class="hljs-keyword">import</span> com.example.demo.model.User;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.web.reactive.function.client.WebClient;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Flux;<br><span class="hljs-keyword">import</span> reactor.core.publisher.Mono;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserClient</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WebClient webClient;<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserClient</span><span class="hljs-params">(WebClient.Builder builder)</span> &#123;<br>        <span class="hljs-built_in">this</span>.webClient = builder<br>            .baseUrl(<span class="hljs-string">&quot;http://localhost:8080/api&quot;</span>)<br>            .build();<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Flux&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> webClient.get()<br>            .uri(<span class="hljs-string">&quot;/users&quot;</span>)<br>            .retrieve()<br>            .bodyToFlux(User.class);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> webClient.get()<br>            .uri(<span class="hljs-string">&quot;/users/&#123;id&#125;&quot;</span>, id)<br>            .retrieve()<br>            .bodyToMono(User.class);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> &#123;<br>        <span class="hljs-keyword">return</span> webClient.post()<br>            .uri(<span class="hljs-string">&quot;/users&quot;</span>)<br>            .bodyValue(user)<br>            .retrieve()<br>            .bodyToMono(User.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> com.example.demo.model.User;<br><span class="hljs-keyword">import</span> com.example.demo.service.UserService;<br><span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.autoconfigure.web.reactive.AutoConfigureWebTestClient;<br><span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;<br><span class="hljs-keyword">import</span> org.springframework.http.MediaType;<br><span class="hljs-keyword">import</span> org.springframework.test.web.reactive.server.WebTestClient;<br><span class="hljs-keyword">import</span> reactor.test.StepVerifier;<br><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-meta">@AutoConfigureWebTestClient</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserControllerTest</span> &#123;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> WebTestClient webTestClient;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br>    <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> &#123;<br>        webTestClient.get()<br>            .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>            .accept(MediaType.APPLICATION_JSON)<br>            .exchange()<br>            .expectStatus().isOk()<br>            .expectBodyList(User.class)<br>            .hasSize(<span class="hljs-number">2</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUserById</span><span class="hljs-params">()</span> &#123;<br>        webTestClient.get()<br>            .uri(<span class="hljs-string">&quot;/api/users/1&quot;</span>)<br>            .accept(MediaType.APPLICATION_JSON)<br>            .exchange()<br>            .expectStatus().isOk()<br>            .expectBody()<br>            .jsonPath(<span class="hljs-string">&quot;$.name&quot;</span>).isEqualTo(<span class="hljs-string">&quot;张三&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">newUser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br>        newUser.setName(<span class="hljs-string">&quot;王五&quot;</span>);<br>        newUser.setEmail(<span class="hljs-string">&quot;wangwu@example.com&quot;</span>);<br>        <br>        webTestClient.post()<br>            .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>            .contentType(MediaType.APPLICATION_JSON)<br>            .bodyValue(newUser)<br>            .exchange()<br>            .expectStatus().isCreated()<br>            .expectBody()<br>            .jsonPath(<span class="hljs-string">&quot;$.name&quot;</span>).isEqualTo(<span class="hljs-string">&quot;王五&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testServiceWithStepVerifier</span><span class="hljs-params">()</span> &#123;<br>        StepVerifier.create(userService.findAll())<br>            .expectNextCount(<span class="hljs-number">2</span>)<br>            .verifyComplete();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h2><ol><li><strong>合理使用调度器</strong>：I&#x2F;O 操作使用 <code>boundedElastic</code>，CPU 密集型使用 <code>parallel</code></li><li><strong>避免阻塞调用</strong>：确保整个调用链都是非阻塞的</li><li><strong>使用连接池</strong>：配置合适的数据库连接池大小</li><li><strong>启用压缩</strong>：对响应数据启用 Gzip 压缩</li><li><strong>监控指标</strong>：集成 Micrometer 监控响应时间和吞吐量</li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：函数式端点</li><li>返回：Webflux简介</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>WebFlux</tag>
      
      <tag>实战</tag>
      
      <tag>R2DBC</tag>
      
      <tag>测试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>流合并与操作符链</title>
    <link href="/2026/01/10/%E6%B5%81%E5%90%88%E5%B9%B6%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%93%BE/"/>
    <url>/2026/01/10/%E6%B5%81%E5%90%88%E5%B9%B6%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="流合并与操作符链"><a href="#流合并与操作符链" class="headerlink" title="流合并与操作符链"></a>流合并与操作符链</h1><h2 id="水利系统比喻"><a href="#水利系统比喻" class="headerlink" title="水利系统比喻"></a>水利系统比喻</h2><p>在学习 Reactor 时，可以用水利系统来理解：</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs nix">┌──────────────────────────────────────────────────────────────┐<br>│                     Reactor 水利系统                          │<br>├──────────────────────────────────────────────────────────────┤<br>│                                                              │<br>│  水源类型：                                                   │<br>│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │<br>│  │ just()   │  │ interval │  │  HTTP    │  │  Sinks   │     │<br>│  │ 矿泉水瓶  │  │ 定时滴水  │  │ 外部水管  │  │ 你的水龙头│     │<br>│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘     │<br>│       │             │             │             │            │<br>│       └──────┬──────┴──────┬──────┴──────┬──────┘            │<br>│              │             │             │                   │<br>│              ▼             ▼             ▼                   │<br>│         ┌─────────────────────────────────────┐              │<br>│         │  merge <span class="hljs-symbol">/</span> concat <span class="hljs-symbol">/</span> zip (合并水管)     │              │<br>│         └─────────────────┬───────────────────┘              │<br>│                           │                                  │<br>│                           ▼                                  │<br>│         ┌─────────────────────────────────────┐              │<br>│         │  filter <span class="hljs-symbol">/</span> <span class="hljs-built_in">map</span> <span class="hljs-symbol">/</span> take (处理水管)      │              │<br>│         └─────────────────┬───────────────────┘              │<br>│                           │                                  │<br>│                           ▼                                  │<br>│         ┌─────────────────────────────────────┐              │<br>│         │         subscribe (水池)            │              │<br>│         └─────────────────────────────────────┘              │<br>│                                                              │<br>└──────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><table><thead><tr><th>概念</th><th>比喻</th><th>说明</th></tr></thead><tbody><tr><td><strong>Sinks</strong></td><td>水龙头</td><td>你控制开关，决定什么时候放水</td></tr><tr><td><strong>Flux</strong></td><td>水管</td><td>只负责传输，不管水从哪来、有多少</td></tr><tr><td><strong>操作符</strong></td><td>处理水管</td><td>filter&#x3D;过滤器，map&#x3D;转换器，take&#x3D;限流阀</td></tr><tr><td><strong>subscribe</strong></td><td>水池</td><td>接收最终的水</td></tr></tbody></table><hr><h2 id="一、操作符链（水管接水管）"><a href="#一、操作符链（水管接水管）" class="headerlink" title="一、操作符链（水管接水管）"></a>一、操作符链（水管接水管）</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>每个操作符都会创建一个新的 Flux，形成链式调用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)       <span class="hljs-comment">// 水源：1到10</span><br>    .filter(i -&gt; i &gt; <span class="hljs-number">5</span>)  <span class="hljs-comment">// 过滤：只留大于5的</span><br>    .map(i -&gt; i * <span class="hljs-number">2</span>)     <span class="hljs-comment">// 转换：每个乘2</span><br>    .take(<span class="hljs-number">3</span>)             <span class="hljs-comment">// 限流：只取3个</span><br>    .subscribe();        <span class="hljs-comment">// 水池：接收</span><br></code></pre></td></tr></table></figure><h3 id="数据流动过程"><a href="#数据流动过程" class="headerlink" title="数据流动过程"></a>数据流动过程</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐<br>│ range  │───▶│ <span class="hljs-attribute">filter</span> │───▶│  map   │───▶│  take  │───▶│ 订阅者 │<br>│<span class="hljs-number">1</span>,<span class="hljs-number">2</span>..<span class="hljs-selector-class">.10</span>│    │  &gt;<span class="hljs-number">5</span>    │    │  *<span class="hljs-number">2</span>    │    │  <span class="hljs-number">3</span>个   │    │        │<br>└────────┘    └────────┘    └────────┘    └────────┘    └────────┘<br>   <span class="hljs-number">10</span>个    →    <span class="hljs-number">5</span>个     →     <span class="hljs-number">5</span>个     →     <span class="hljs-number">3</span>个     →    收到<span class="hljs-number">3</span>个<br>  (<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>) (<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>)  (<span class="hljs-number">12</span>,<span class="hljs-number">14</span>,<span class="hljs-number">16</span>,<span class="hljs-number">18</span>,<span class="hljs-number">20</span>) (<span class="hljs-number">12</span>,<span class="hljs-number">14</span>,<span class="hljs-number">16</span>)<br></code></pre></td></tr></table></figure><h3 id="常用操作符分类"><a href="#常用操作符分类" class="headerlink" title="常用操作符分类"></a>常用操作符分类</h3><table><thead><tr><th>类型</th><th>操作符</th><th>作用</th></tr></thead><tbody><tr><td><strong>过滤</strong></td><td><code>filter</code>, <code>take</code>, <code>skip</code>, <code>distinct</code></td><td>筛选数据</td></tr><tr><td><strong>转换</strong></td><td><code>map</code>, <code>flatMap</code>, <code>concatMap</code></td><td>转换数据</td></tr><tr><td><strong>组合</strong></td><td><code>merge</code>, <code>concat</code>, <code>zip</code></td><td>合并多个流</td></tr><tr><td><strong>错误处理</strong></td><td><code>onErrorReturn</code>, <code>retry</code></td><td>处理异常</td></tr><tr><td><strong>副作用</strong></td><td><code>doOnNext</code>, <code>doOnError</code>, <code>doOnComplete</code></td><td>执行额外操作</td></tr></tbody></table><hr><h2 id="二、流合并（多个水龙头合并）"><a href="#二、流合并（多个水龙头合并）" class="headerlink" title="二、流合并（多个水龙头合并）"></a>二、流合并（多个水龙头合并）</h2><h3 id="1-merge-实时混合"><a href="#1-merge-实时混合" class="headerlink" title="1. merge - 实时混合"></a>1. merge - 实时混合</h3><p><strong>特点</strong>：谁有数据谁先输出，不保证顺序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;String&gt; flux1 = Flux.just(<span class="hljs-string">&quot;A1&quot;</span>, <span class="hljs-string">&quot;A2&quot;</span>).delayElements(Duration.ofMillis(<span class="hljs-number">100</span>));<br>Flux&lt;String&gt; flux2 = Flux.just(<span class="hljs-string">&quot;B1&quot;</span>, <span class="hljs-string">&quot;B2&quot;</span>).delayElements(Duration.ofMillis(<span class="hljs-number">80</span>));<br><br>Flux.merge(flux1, flux2).subscribe(System.out::println);<br><span class="hljs-comment">// 可能输出: B1, A1, B2, A2（谁快谁先）</span><br></code></pre></td></tr></table></figure><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">flux1 ──<span class="hljs-built_in">A1</span>────<span class="hljs-built_in">A2</span>────┐<br>                    ├──▶ merge ──▶ <span class="hljs-keyword">B1, </span><span class="hljs-built_in">A1</span>, <span class="hljs-keyword">B2, </span><span class="hljs-built_in">A2</span><br>flux2 ──<span class="hljs-keyword">B1──B2──────┘</span><br></code></pre></td></tr></table></figure><p><strong>适用场景</strong>：实时数据混合、不关心顺序</p><h3 id="2-concat-顺序连接"><a href="#2-concat-顺序连接" class="headerlink" title="2. concat - 顺序连接"></a>2. concat - 顺序连接</h3><p><strong>特点</strong>：第一个流完成后，才开始第二个流</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.concat(flux1, flux2).subscribe(System.out::println);<br><span class="hljs-comment">// 输出: A1, A2, B1, B2（先A全部，再B全部）</span><br></code></pre></td></tr></table></figure><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">flux1 ──<span class="hljs-built_in">A1</span>──<span class="hljs-built_in">A2</span>──┐<br>                ├──▶ concat ──▶ <span class="hljs-built_in">A1</span>, <span class="hljs-built_in">A2</span>, <span class="hljs-keyword">B1, </span><span class="hljs-keyword">B2</span><br><span class="hljs-keyword"></span>flux2 ──<span class="hljs-keyword">B1──B2──┘（等A完成再开始）</span><br></code></pre></td></tr></table></figure><p><strong>适用场景</strong>：需要保证顺序、分页加载</p><h3 id="3-zip-一对一配对"><a href="#3-zip-一对一配对" class="headerlink" title="3. zip - 一对一配对"></a>3. zip - 一对一配对</h3><p><strong>特点</strong>：从每个流各取一个元素，组合成一对</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;String&gt; names = Flux.just(<span class="hljs-string">&quot;张三&quot;</span>, <span class="hljs-string">&quot;李四&quot;</span>, <span class="hljs-string">&quot;王五&quot;</span>);<br>Flux&lt;Integer&gt; ages = Flux.just(<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">28</span>);<br><br>Flux.zip(names, ages, (name, age) -&gt; name + <span class="hljs-string">&quot;: &quot;</span> + age)<br>    .subscribe(System.out::println);<br><span class="hljs-comment">// 输出: 张三: 25, 李四: 30, 王五: 28</span><br></code></pre></td></tr></table></figure><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss">names ──张三────李四────王五────┐<br>                               ├──▶ zip ──▶ (张三:<span class="hljs-number">25</span>), (李四:<span class="hljs-number">30</span>), (王五:<span class="hljs-number">28</span>)<br>ages  ──<span class="hljs-number">25</span>──────<span class="hljs-number">30</span>──────<span class="hljs-number">28</span>─────┘<br></code></pre></td></tr></table></figure><p><strong>适用场景</strong>：数据配对、并行请求结果组合</p><h3 id="4-combineLatest-组合最新值"><a href="#4-combineLatest-组合最新值" class="headerlink" title="4. combineLatest - 组合最新值"></a>4. combineLatest - 组合最新值</h3><p><strong>特点</strong>：任一流有新值时，与其他流的最新值组合</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;String&gt; flux1 = Flux.interval(Duration.ofMillis(<span class="hljs-number">100</span>)).map(i -&gt; <span class="hljs-string">&quot;A&quot;</span> + i);<br>Flux&lt;String&gt; flux2 = Flux.interval(Duration.ofMillis(<span class="hljs-number">150</span>)).map(i -&gt; <span class="hljs-string">&quot;B&quot;</span> + i);<br><br>Flux.combineLatest(flux1, flux2, (a, b) -&gt; a + <span class="hljs-string">&quot;+&quot;</span> + b)<br>    .take(<span class="hljs-number">5</span>)<br>    .subscribe(System.out::println);<br><span class="hljs-comment">// 输出: A0+B0, A1+B0, A1+B1, A2+B1, A3+B1...</span><br></code></pre></td></tr></table></figure><p><strong>适用场景</strong>：实时数据组合、表单联动</p><h3 id="合并方式对比"><a href="#合并方式对比" class="headerlink" title="合并方式对比"></a>合并方式对比</h3><table><thead><tr><th>方式</th><th>执行顺序</th><th>输出顺序</th><th>适用场景</th></tr></thead><tbody><tr><td><code>merge</code></td><td>并行</td><td>谁快谁先</td><td>实时混合</td></tr><tr><td><code>concat</code></td><td>串行</td><td>按流顺序</td><td>顺序处理</td></tr><tr><td><code>zip</code></td><td>并行</td><td>配对输出</td><td>数据组合</td></tr><tr><td><code>combineLatest</code></td><td>并行</td><td>最新组合</td><td>实时联动</td></tr></tbody></table><hr><h2 id="三、实战：外部流-本地流合并"><a href="#三、实战：外部流-本地流合并" class="headerlink" title="三、实战：外部流 + 本地流合并"></a>三、实战：外部流 + 本地流合并</h2><h3 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h3><p>调用外部 API（如大模型），同时本地也能推送消息，两个流合并后返回给前端。</p><h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatService</span> &#123;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WebClient webClient;<br>    <br>    <span class="hljs-comment">// 系统通知的水龙头</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sinks.Many&lt;String&gt; notificationSink = <br>        Sinks.many().multicast().onBackpressureBuffer();<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取合并后的消息流</span><br><span class="hljs-comment">     * 用户既能收到大模型回复，也能收到系统通知</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">getChatStream</span><span class="hljs-params">(String prompt)</span> &#123;<br>        <span class="hljs-comment">// 1. 外部流：大模型回复</span><br>        Flux&lt;String&gt; llmResponse = webClient.post()<br>            .uri(<span class="hljs-string">&quot;/v1/chat/completions&quot;</span>)<br>            .bodyValue(buildRequest(prompt))<br>            .retrieve()<br>            .bodyToFlux(String.class)<br>            .map(<span class="hljs-built_in">this</span>::extractContent)<br>            .filter(Objects::nonNull);<br>        <br>        <span class="hljs-comment">// 2. 本地流：系统通知</span><br>        Flux&lt;String&gt; notifications = notificationSink.asFlux()<br>            .map(msg -&gt; <span class="hljs-string">&quot;[系统] &quot;</span> + msg);<br>        <br>        <span class="hljs-comment">// 3. 合并两个流</span><br>        <span class="hljs-keyword">return</span> Flux.merge(llmResponse, notifications);<br>    &#125;<br>    <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 发送系统通知（可以在任何地方调用）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendNotification</span><span class="hljs-params">(String message)</span> &#123;<br>        notificationSink.tryEmitNext(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h3><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs isbl">用户订阅 <span class="hljs-function"><span class="hljs-title">getChatStream</span>(<span class="hljs-string">&quot;你好&quot;</span>)</span><br>    │<br>    ├── 大模型: <span class="hljs-string">&quot;你&quot;</span><br>    ├── 大模型: <span class="hljs-string">&quot;好&quot;</span><br>    ├── 系统通知: <span class="hljs-string">&quot;[系统] 服务器将在5分钟后维护&quot;</span>  ← 随时插入<br>    ├── 大模型: <span class="hljs-string">&quot;，我是AI助手&quot;</span><br>    ├── 系统通知: <span class="hljs-string">&quot;[系统] 新功能上线&quot;</span>  ← 随时插入<br>    └── 大模型: <span class="hljs-string">&quot;...&quot;</span><br></code></pre></td></tr></table></figure><h3 id="图示"><a href="#图示" class="headerlink" title="图示"></a>图示</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────┐<br>│   外部 API      │<br>│  (大模型返回)    │──── llmResponse ─────┐<br>└─────────────────┘                       │<br>                                          ├──▶ Flux<span class="hljs-selector-class">.merge</span>() ──▶ 前端<br>┌─────────────────┐                       │<br>│   本地 Sinks    │                       │<br>│  (系统通知)      │──── notifications ───┘<br>└─────────────────┘<br>       ↑<br>  <span class="hljs-built_in">sendNotification</span>(&quot;消息&quot;)<br></code></pre></td></tr></table></figure><hr><h2 id="四、生产环境注意事项"><a href="#四、生产环境注意事项" class="headerlink" title="四、生产环境注意事项"></a>四、生产环境注意事项</h2><h3 id="1-背压处理"><a href="#1-背压处理" class="headerlink" title="1. 背压处理"></a>1. 背压处理</h3><p><strong>问题</strong>：上游产生数据太快，下游处理不过来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [错误] 可能导致内存溢出</span><br>Flux.interval(Duration.ofMillis(<span class="hljs-number">1</span>))  <span class="hljs-comment">// 每毫秒一个</span><br>    .subscribe(data -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 处理很慢</span><br>    &#125;);<br><br><span class="hljs-comment">// [正确] 添加背压策略</span><br>Flux.interval(Duration.ofMillis(<span class="hljs-number">1</span>))<br>    .onBackpressureDrop(dropped -&gt; log.warn(<span class="hljs-string">&quot;丢弃: &#123;&#125;&quot;</span>, dropped))<br>    .subscribe(data -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>    &#125;);<br></code></pre></td></tr></table></figure><p><strong>背压策略选择</strong>：</p><table><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>onBackpressureBuffer()</code></td><td>缓冲</td><td>数据不能丢，内存够用</td></tr><tr><td><code>onBackpressureBuffer(100)</code></td><td>有限缓冲</td><td>控制内存使用</td></tr><tr><td><code>onBackpressureDrop()</code></td><td>丢弃</td><td>实时数据，可以丢</td></tr><tr><td><code>onBackpressureLatest()</code></td><td>只保留最新</td><td>状态更新</td></tr><tr><td><code>onBackpressureError()</code></td><td>抛异常</td><td>不允许背压</td></tr></tbody></table><h3 id="2-错误处理"><a href="#2-错误处理" class="headerlink" title="2. 错误处理"></a>2. 错误处理</h3><p><strong>问题</strong>：一个流出错会导致整个合并流终止</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [错误] llmResponse 出错会导致整个流终止</span><br>Flux.merge(llmResponse, notifications);<br><br><span class="hljs-comment">// [正确] 单独处理每个流的错误</span><br>Flux&lt;String&gt; safeLlmResponse = llmResponse<br>    .onErrorResume(e -&gt; &#123;<br>        log.error(<span class="hljs-string">&quot;大模型调用失败&quot;</span>, e);<br>        <span class="hljs-keyword">return</span> Flux.just(<span class="hljs-string">&quot;[错误] 大模型暂时不可用&quot;</span>);<br>    &#125;);<br><br>Flux.merge(safeLlmResponse, notifications);<br></code></pre></td></tr></table></figure><p><strong>错误处理策略</strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 返回默认值</span><br>.onErrorReturn(<span class="hljs-string">&quot;默认值&quot;</span>)<br><br><span class="hljs-comment">// 切换到备用流</span><br>.onErrorResume(e -&gt; backupFlux)<br><br><span class="hljs-comment">// 重试</span><br>.retry(<span class="hljs-number">3</span>)<br>.retryWhen(Retry.backoff(<span class="hljs-number">3</span>, Duration.ofSeconds(<span class="hljs-number">1</span>)))<br><br><span class="hljs-comment">// 记录错误但继续</span><br>.onErrorContinue((e, data) -&gt; log.error(<span class="hljs-string">&quot;处理失败: &#123;&#125;&quot;</span>, data, e))<br></code></pre></td></tr></table></figure><h3 id="3-超时处理"><a href="#3-超时处理" class="headerlink" title="3. 超时处理"></a>3. 超时处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [错误] 外部 API 可能永远不返回</span><br>Flux&lt;String&gt; response = webClient.get().retrieve().bodyToFlux(String.class);<br><br><span class="hljs-comment">// [正确] 设置超时</span><br>Flux&lt;String&gt; response = webClient.get()<br>    .retrieve()<br>    .bodyToFlux(String.class)<br>    .timeout(Duration.ofSeconds(<span class="hljs-number">30</span>))<br>    .onErrorResume(TimeoutException.class, e -&gt; <br>        Flux.just(<span class="hljs-string">&quot;[超时] 请求超时，请重试&quot;</span>));<br></code></pre></td></tr></table></figure><h3 id="4-资源清理"><a href="#4-资源清理" class="headerlink" title="4. 资源清理"></a>4. 资源清理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [错误] Sinks 没有正确关闭</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><span class="hljs-comment">// 应用关闭时，sink 还在运行</span><br><br><span class="hljs-comment">// [正确] 在适当时机关闭</span><br><span class="hljs-meta">@PreDestroy</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> &#123;<br>    sink.tryEmitComplete();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-线程安全"><a href="#5-线程安全" class="headerlink" title="5. 线程安全"></a>5. 线程安全</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Sinks 默认是线程安全的</span><br>Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();<br><br><span class="hljs-comment">// 如果确定单线程，可以用 unsafe 版本提升性能</span><br>Sinks.Many&lt;String&gt; unsafeSink = Sinks.unsafe().many().multicast().onBackpressureBuffer();<br><span class="hljs-comment">// [注意] 多线程下使用 unsafe 会出问题！</span><br></code></pre></td></tr></table></figure><h3 id="6-避免阻塞"><a href="#6-避免阻塞" class="headerlink" title="6. 避免阻塞"></a>6. 避免阻塞</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [错误] 在响应式流中阻塞</span><br>flux.map(data -&gt; &#123;<br>    Thread.sleep(<span class="hljs-number">1000</span>);  <span class="hljs-comment">// 阻塞！</span><br>    <span class="hljs-keyword">return</span> process(data);<br>&#125;);<br><br><span class="hljs-comment">// [正确] 使用 boundedElastic 调度器处理阻塞操作</span><br>flux.flatMap(data -&gt; <br>    Mono.fromCallable(() -&gt; blockingProcess(data))<br>        .subscribeOn(Schedulers.boundedElastic())<br>);<br></code></pre></td></tr></table></figure><hr><h2 id="五、最佳实践"><a href="#五、最佳实践" class="headerlink" title="五、最佳实践"></a>五、最佳实践</h2><h3 id="1-操作符链设计"><a href="#1-操作符链设计" class="headerlink" title="1. 操作符链设计"></a>1. 操作符链设计</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [推荐] 清晰的操作符链</span><br><span class="hljs-keyword">return</span> webClient.get()<br>    .uri(<span class="hljs-string">&quot;/api/users&quot;</span>)<br>    .retrieve()<br>    .bodyToFlux(User.class)<br>    .filter(user -&gt; user.isActive())           <span class="hljs-comment">// 1. 先过滤</span><br>    .map(user -&gt; user.getName())               <span class="hljs-comment">// 2. 再转换</span><br>    .distinct()                                 <span class="hljs-comment">// 3. 去重</span><br>    .take(<span class="hljs-number">10</span>)                                   <span class="hljs-comment">// 4. 限制数量</span><br>    .timeout(Duration.ofSeconds(<span class="hljs-number">5</span>))            <span class="hljs-comment">// 5. 超时控制</span><br>    .onErrorResume(e -&gt; Flux.empty())          <span class="hljs-comment">// 6. 错误处理</span><br>    .doOnNext(name -&gt; log.debug(<span class="hljs-string">&quot;处理: &#123;&#125;&quot;</span>, name))  <span class="hljs-comment">// 7. 日志</span><br>    .subscribeOn(Schedulers.boundedElastic()); <span class="hljs-comment">// 8. 调度器</span><br></code></pre></td></tr></table></figure><h3 id="2-Sinks-使用规范"><a href="#2-Sinks-使用规范" class="headerlink" title="2. Sinks 使用规范"></a>2. Sinks 使用规范</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventBus</span> &#123;<br>    <br>    <span class="hljs-comment">// [推荐] 使用 multicast + onBackpressureBuffer</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Sinks.Many&lt;Event&gt; eventSink = <br>        Sinks.many().multicast().onBackpressureBuffer();<br>    <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publish</span><span class="hljs-params">(Event event)</span> &#123;<br>        <span class="hljs-comment">// [推荐] 检查发送结果</span><br>        Sinks.<span class="hljs-type">EmitResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> eventSink.tryEmitNext(event);<br>        <span class="hljs-keyword">if</span> (result.isFailure()) &#123;<br>            log.warn(<span class="hljs-string">&quot;事件发送失败: &#123;&#125;, 原因: &#123;&#125;&quot;</span>, event, result);<br>        &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> Flux&lt;Event&gt; <span class="hljs-title function_">subscribe</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> eventSink.asFlux();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-合并流的错误隔离"><a href="#3-合并流的错误隔离" class="headerlink" title="3. 合并流的错误隔离"></a>3. 合并流的错误隔离</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// [推荐] 每个流独立处理错误</span><br><span class="hljs-keyword">public</span> Flux&lt;Message&gt; <span class="hljs-title function_">getMergedStream</span><span class="hljs-params">()</span> &#123;<br>    Flux&lt;Message&gt; stream1 = getStream1()<br>        .onErrorResume(e -&gt; &#123;<br>            log.error(<span class="hljs-string">&quot;stream1 错误&quot;</span>, e);<br>            <span class="hljs-keyword">return</span> Flux.empty();<br>        &#125;);<br>    <br>    Flux&lt;Message&gt; stream2 = getStream2()<br>        .onErrorResume(e -&gt; &#123;<br>            log.error(<span class="hljs-string">&quot;stream2 错误&quot;</span>, e);<br>            <span class="hljs-keyword">return</span> Flux.empty();<br>        &#125;);<br>    <br>    <span class="hljs-keyword">return</span> Flux.merge(stream1, stream2);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="4-日志与监控"><a href="#4-日志与监控" class="headerlink" title="4. 日志与监控"></a>4. 日志与监控</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java">flux<br>    .doOnSubscribe(s -&gt; log.info(<span class="hljs-string">&quot;开始订阅&quot;</span>))<br>    .doOnNext(data -&gt; log.debug(<span class="hljs-string">&quot;处理数据: &#123;&#125;&quot;</span>, data))<br>    .doOnError(e -&gt; log.error(<span class="hljs-string">&quot;发生错误&quot;</span>, e))<br>    .doOnComplete(() -&gt; log.info(<span class="hljs-string">&quot;处理完成&quot;</span>))<br>    .doOnCancel(() -&gt; log.warn(<span class="hljs-string">&quot;订阅被取消&quot;</span>))<br>    .doFinally(signal -&gt; &#123;<br>        <span class="hljs-comment">// 记录指标</span><br>        metrics.recordStreamEnd(signal);<br>    &#125;);<br></code></pre></td></tr></table></figure><h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMergedStream</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 使用 StepVerifier 测试</span><br>    Flux&lt;String&gt; merged = Flux.merge(<br>        Flux.just(<span class="hljs-string">&quot;A&quot;</span>),<br>        Flux.just(<span class="hljs-string">&quot;B&quot;</span>)<br>    );<br>    <br>    StepVerifier.create(merged)<br>        .expectNextCount(<span class="hljs-number">2</span>)<br>        .verifyComplete();<br>&#125;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testWithVirtualTime</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 测试时间相关的流</span><br>    StepVerifier.withVirtualTime(() -&gt; <br>        Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>)).take(<span class="hljs-number">3</span>)<br>    )<br>    .thenAwait(Duration.ofSeconds(<span class="hljs-number">3</span>))<br>    .expectNext(<span class="hljs-number">0L</span>, <span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>)<br>    .verifyComplete();<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="六、常见问题"><a href="#六、常见问题" class="headerlink" title="六、常见问题"></a>六、常见问题</h2><h3 id="Q1-merge-和-concat-怎么选？"><a href="#Q1-merge-和-concat-怎么选？" class="headerlink" title="Q1: merge 和 concat 怎么选？"></a>Q1: merge 和 concat 怎么选？</h3><ul><li><strong>merge</strong>：需要实时混合，不关心顺序</li><li><strong>concat</strong>：需要保证顺序，一个完成再处理下一个</li></ul><h3 id="Q2-为什么我的-Sinks-发送的数据没人收到？"><a href="#Q2-为什么我的-Sinks-发送的数据没人收到？" class="headerlink" title="Q2: 为什么我的 Sinks 发送的数据没人收到？"></a>Q2: 为什么我的 Sinks 发送的数据没人收到？</h3><p>检查：</p><ol><li>是否有订阅者？（multicast 模式下，没订阅者数据会丢失）</li><li>是否在订阅之前就发送了？（热流特性）</li><li>考虑使用 <code>replay()</code> 模式</li></ol><h3 id="Q3-流合并后，一个出错整个都停了？"><a href="#Q3-流合并后，一个出错整个都停了？" class="headerlink" title="Q3: 流合并后，一个出错整个都停了？"></a>Q3: 流合并后，一个出错整个都停了？</h3><p>每个流单独添加错误处理：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.merge(<br>    stream1.onErrorResume(e -&gt; Flux.empty()),<br>    stream2.onErrorResume(e -&gt; Flux.empty())<br>);<br></code></pre></td></tr></table></figure><h3 id="Q4-内存一直涨？"><a href="#Q4-内存一直涨？" class="headerlink" title="Q4: 内存一直涨？"></a>Q4: 内存一直涨？</h3><p>检查：</p><ol><li>是否有无限流没有 <code>take()</code> 限制？</li><li>是否背压处理不当？添加 <code>onBackpressureXxx()</code></li><li>是否有流没有正确完成？检查 <code>tryEmitComplete()</code></li></ol><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Flux 是管道不是容器</li><li>Sinks 详解</li><li>Reactor API 参考</li><li>WebFlux - Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>操作符</tag>
      
      <tag>merge</tag>
      
      <tag>concat</tag>
      
      <tag>zip</tag>
      
      <tag>最佳实践</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ThreadLocal原理</title>
    <link href="/2026/01/10/ThreadLocal%E5%8E%9F%E7%90%86/"/>
    <url>/2026/01/10/ThreadLocal%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="ThreadLocal-原理"><a href="#ThreadLocal-原理" class="headerlink" title="ThreadLocal 原理"></a>ThreadLocal 原理</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>ThreadLocal</code> 提供<strong>线程本地变量</strong>，每个线程都有自己独立的变量副本，实现线程间数据隔离。</p><h2 id="核心数据结构"><a href="#核心数据结构" class="headerlink" title="核心数据结构"></a>核心数据结构</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">Thread<br>  └── ThreadLocalMap threadLocals<br>        └── Entry<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">table</span><br>              └── Entry(ThreadLocal&lt;?&gt; key, <span class="hljs-selector-tag">Object</span> value)<br></code></pre></td></tr></table></figure><table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td><code>Thread.threadLocals</code></td><td>每个线程持有的 ThreadLocalMap 实例</td></tr><tr><td><code>ThreadLocalMap</code></td><td>自定义哈希表，存储线程本地变量</td></tr><tr><td><code>Entry</code></td><td>继承 <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code> 的键值对</td></tr></tbody></table><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="1-set-方法"><a href="#1-set-方法" class="headerlink" title="1. set() 方法"></a>1. set() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(T value)</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);  <span class="hljs-comment">// 获取当前线程的 ThreadLocalMap</span><br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        map.set(<span class="hljs-built_in">this</span>, value);        <span class="hljs-comment">// this 是 ThreadLocal 实例作为 key</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        createMap(t, value);         <span class="hljs-comment">// 首次使用，创建 map</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-get-方法"><a href="#2-get-方法" class="headerlink" title="2. get() 方法"></a>2. get() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> T <span class="hljs-title function_">get</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">Thread</span> <span class="hljs-variable">t</span> <span class="hljs-operator">=</span> Thread.currentThread();<br>    <span class="hljs-type">ThreadLocalMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> getMap(t);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> map.getEntry(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> (T) e.value;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> setInitialValue();  <span class="hljs-comment">// 返回初始值</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-数据存储位置"><a href="#3-数据存储位置" class="headerlink" title="3. 数据存储位置"></a>3. 数据存储位置</h3><pre><code class=" mermaid">graph LR    A[ThreadLocal.get/set] --&gt; B[Thread.currentThread]    B --&gt; C[thread.threadLocals]    C --&gt; D[ThreadLocalMap]    D --&gt; E[Entry数组]    E --&gt; F[&quot;key=ThreadLocal实例&lt;br/&gt;value=线程本地值&quot;]</code></pre><h2 id="关键设计"><a href="#关键设计" class="headerlink" title="关键设计"></a>关键设计</h2><h3 id="Entry-使用弱引用"><a href="#Entry-使用弱引用" class="headerlink" title="Entry 使用弱引用"></a>Entry 使用弱引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Entry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;<br>    Object value;<br>    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;<br>        <span class="hljs-built_in">super</span>(k);  <span class="hljs-comment">// key 是弱引用</span><br>        value = v; <span class="hljs-comment">// value 是强引用</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>为什么 key 用弱引用？</strong> 👉Java引用类型详解 ^weak-ref-design</p><ul><li>当外部不再持有 ThreadLocal 引用时，GC 可以回收 ThreadLocal 对象</li><li>避免 ThreadLocal 对象本身的内存泄漏</li></ul><h3 id="哈希冲突处理"><a href="#哈希冲突处理" class="headerlink" title="哈希冲突处理"></a>哈希冲突处理</h3><p>ThreadLocalMap 使用<strong>线性探测法</strong>解决哈希冲突：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;<br>    Entry[] tab = table;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> tab.length;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> key.threadLocalHashCode &amp; (len - <span class="hljs-number">1</span>);  <span class="hljs-comment">// 计算下标</span><br>    <br>    <span class="hljs-comment">// 线性探测</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">Entry</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> tab[i]; e != <span class="hljs-literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;<br>        <span class="hljs-comment">// 找到相同 key 或空槽位</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="内存泄漏问题"><a href="#内存泄漏问题" class="headerlink" title="内存泄漏问题"></a>内存泄漏问题</h2><h3 id="泄漏场景"><a href="#泄漏场景" class="headerlink" title="泄漏场景"></a>泄漏场景</h3><table><thead><tr><th>条件</th><th>结果</th></tr></thead><tbody><tr><td>ThreadLocal 被回收（弱引用）</td><td>Entry.key &#x3D; null</td></tr><tr><td>线程仍存活（如线程池）</td><td>Entry.value 无法回收</td></tr></tbody></table><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p><strong>始终在使用后调用 <code>remove()</code></strong>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">ThreadLocal&lt;User&gt; userContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br><span class="hljs-keyword">try</span> &#123;<br>    userContext.set(currentUser);<br>    <span class="hljs-comment">// 业务逻辑</span><br>&#125; <span class="hljs-keyword">finally</span> &#123;<br>    userContext.remove();  <span class="hljs-comment">// 必须清理！</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h2><table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td>用户上下文</td><td>存储当前登录用户信息</td></tr><tr><td>数据库连接</td><td>保证同一线程使用同一连接</td></tr><tr><td>事务管理</td><td>Spring 的事务同步</td></tr><tr><td>日期格式化</td><td>SimpleDateFormat 线程安全使用</td></tr><tr><td>链路追踪</td><td>TraceId 在线程内传递</td></tr></tbody></table><h2 id="与同步机制对比"><a href="#与同步机制对比" class="headerlink" title="与同步机制对比"></a>与同步机制对比</h2><table><thead><tr><th>特性</th><th>ThreadLocal</th><th>synchronized&#x2F;Lock</th></tr></thead><tbody><tr><td>原理</td><td>空间换时间，每个线程一份副本</td><td>时间换空间，排队访问</td></tr><tr><td>性能</td><td>无竞争，性能高</td><td>有锁竞争开销</td></tr><tr><td>适用场景</td><td>线程独享数据</td><td>线程共享数据</td></tr></tbody></table><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li><strong>存储位置</strong>：数据存在每个线程的 <code>threadLocals</code> 字段中</li><li><strong>数据结构</strong>：ThreadLocalMap 是自定义哈希表，Entry 的 key 是弱引用</li><li><strong>核心思想</strong>：用空间换时间，避免同步开销</li><li><strong>注意事项</strong>：使用后必须调用 <code>remove()</code> 防止内存泄漏</li></ol>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>基础知识</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>ThreadLocal</tag>
      
      <tag>线程安全</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程池类型</title>
    <link href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%B1%BB%E5%9E%8B/"/>
    <url>/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%B1%BB%E5%9E%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="线程池类型"><a href="#线程池类型" class="headerlink" title="线程池类型"></a>线程池类型</h1><h2 id="Executors-工厂类"><a href="#Executors-工厂类" class="headerlink" title="Executors 工厂类"></a>Executors 工厂类</h2><p>Java 通过 <code>Executors</code> 工厂类提供了几种常用的线程池实现：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌─────────────────────────────────────────────────────────────────┐<br>│                        Executors                                │<br>├─────────────────────────────────────────────────────────────────┤<br>│  <span class="hljs-built_in">newFixedThreadPool</span>()      → 固定大小线程池                      │<br>│  <span class="hljs-built_in">newCachedThreadPool</span>()     → 缓存线程池                          │<br>│  <span class="hljs-built_in">newSingleThreadExecutor</span>() → 单线程池                            │<br>│  <span class="hljs-built_in">newScheduledThreadPool</span>()  → 定时任务线程池                      │<br>│  <span class="hljs-built_in">newWorkStealingPool</span>()     → 工作窃取线程池 (Java <span class="hljs-number">8</span>+)            │<br>└─────────────────────────────────────────────────────────────────┘<br></code></pre></td></tr></table></figure><hr><h2 id="1-FixedThreadPool（固定大小线程池）"><a href="#1-FixedThreadPool（固定大小线程池）" class="headerlink" title="1. FixedThreadPool（固定大小线程池）"></a>1. FixedThreadPool（固定大小线程池）</h2><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>核心线程数 &#x3D; 最大线程数 &#x3D; 固定值</li><li>使用<strong>无界队列</strong> <code>LinkedBlockingQueue</code></li><li>线程不会被回收</li></ul><h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newFixedThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> nThreads)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>        nThreads,                           <span class="hljs-comment">// corePoolSize</span><br>        nThreads,                           <span class="hljs-comment">// maximumPoolSize（相同）</span><br>        <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,          <span class="hljs-comment">// 不回收</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;() <span class="hljs-comment">// 无界队列</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>CPU 密集型任务</strong></td><td>线程数 &#x3D; CPU 核心数 + 1</td></tr><tr><td><strong>负载稳定的服务</strong></td><td>已知并发量，固定线程数</td></tr></tbody></table><h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 创建固定 4 个线程的线程池</span><br><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">4</span>);<br><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>    executor.submit(() -&gt; &#123;<br>        System.out.println(Thread.currentThread().getName() + <span class="hljs-string">&quot; 执行任务&quot;</span>);<br>    &#125;);<br>&#125;<br>executor.shutdown();<br></code></pre></td></tr></table></figure><h3 id="风险提示"><a href="#风险提示" class="headerlink" title="风险提示"></a>风险提示</h3><blockquote><p><strong>OOM 风险</strong>：使用无界队列，任务堆积可能导致内存溢出</p></blockquote><hr><h2 id="2-CachedThreadPool（缓存线程池）"><a href="#2-CachedThreadPool（缓存线程池）" class="headerlink" title="2. CachedThreadPool（缓存线程池）"></a>2. CachedThreadPool（缓存线程池）</h2><h3 id="特点-1"><a href="#特点-1" class="headerlink" title="特点"></a>特点</h3><ul><li>核心线程数 &#x3D; 0</li><li>最大线程数 &#x3D; <code>Integer.MAX_VALUE</code>（几乎无限）</li><li>使用 <code>SynchronousQueue</code>（不存储任务，直接传递）</li><li>空闲线程 60 秒后回收</li></ul><h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newCachedThreadPool</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>        <span class="hljs-number">0</span>,                                  <span class="hljs-comment">// corePoolSize = 0</span><br>        Integer.MAX_VALUE,                  <span class="hljs-comment">// maximumPoolSize = 无限</span><br>        <span class="hljs-number">60L</span>, TimeUnit.SECONDS,              <span class="hljs-comment">// 60秒回收</span><br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SynchronousQueue</span>&lt;Runnable&gt;()    <span class="hljs-comment">// 直接传递</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用场景-1"><a href="#使用场景-1" class="headerlink" title="使用场景"></a>使用场景</h3><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>短时异步任务</strong></td><td>执行时间短，任务量波动大</td></tr><tr><td><strong>IO 密集型任务</strong></td><td>大量等待，需要更多线程</td></tr></tbody></table><h3 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newCachedThreadPool();<br><br><span class="hljs-comment">// 模拟突发大量短任务</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>    executor.submit(() -&gt; &#123;<br>        System.out.println(Thread.currentThread().getName());<br>        <span class="hljs-keyword">try</span> &#123; Thread.sleep(<span class="hljs-number">100</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;&#125;<br>    &#125;);<br>&#125;<br>executor.shutdown();<br></code></pre></td></tr></table></figure><h3 id="风险提示-1"><a href="#风险提示-1" class="headerlink" title="风险提示"></a>风险提示</h3><blockquote><p><strong>线程爆炸</strong>：任务提交速度 &gt; 处理速度时，会创建大量线程，可能导致系统崩溃</p></blockquote><hr><h2 id="3-SingleThreadExecutor（单线程池）"><a href="#3-SingleThreadExecutor（单线程池）" class="headerlink" title="3. SingleThreadExecutor（单线程池）"></a>3. SingleThreadExecutor（单线程池）</h2><h3 id="特点-2"><a href="#特点-2" class="headerlink" title="特点"></a>特点</h3><ul><li>只有 1 个线程</li><li>使用无界队列</li><li>保证任务<strong>顺序执行</strong></li><li>线程异常终止后会创建新线程</li></ul><h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newSingleThreadExecutor</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalizableDelegatedExecutorService</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>            <span class="hljs-number">1</span>, <span class="hljs-number">1</span>,                               <span class="hljs-comment">// 只有1个线程</span><br>            <span class="hljs-number">0L</span>, TimeUnit.MILLISECONDS,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()<br>        )<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="使用场景-2"><a href="#使用场景-2" class="headerlink" title="使用场景"></a>使用场景</h3><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>顺序执行任务</strong></td><td>日志写入、消息处理</td></tr><tr><td><strong>单线程安全</strong></td><td>避免并发问题</td></tr></tbody></table><h3 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><br><span class="hljs-comment">// 任务按顺序执行</span><br>executor.submit(() -&gt; System.out.println(<span class="hljs-string">&quot;任务1&quot;</span>));<br>executor.submit(() -&gt; System.out.println(<span class="hljs-string">&quot;任务2&quot;</span>));<br>executor.submit(() -&gt; System.out.println(<span class="hljs-string">&quot;任务3&quot;</span>));<br><span class="hljs-comment">// 输出顺序一定是：任务1 → 任务2 → 任务3</span><br><br>executor.shutdown();<br></code></pre></td></tr></table></figure><h3 id="风险提示-2"><a href="#风险提示-2" class="headerlink" title="风险提示"></a>风险提示</h3><blockquote><p><strong>OOM 风险</strong>：同 FixedThreadPool，无界队列可能导致内存溢出</p></blockquote><hr><h2 id="4-ScheduledThreadPool（定时任务线程池）"><a href="#4-ScheduledThreadPool（定时任务线程池）" class="headerlink" title="4. ScheduledThreadPool（定时任务线程池）"></a>4. ScheduledThreadPool（定时任务线程池）</h2><h3 id="特点-3"><a href="#特点-3" class="headerlink" title="特点"></a>特点</h3><ul><li>支持<strong>定时执行</strong>和<strong>周期执行</strong></li><li>使用 <code>DelayedWorkQueue</code>（延迟队列）</li></ul><h3 id="源码分析-3"><a href="#源码分析-3" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ScheduledExecutorService <span class="hljs-title function_">newScheduledThreadPool</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScheduledThreadPoolExecutor</span>(corePoolSize);<br>&#125;<br><br><span class="hljs-comment">// ScheduledThreadPoolExecutor 继承自 ThreadPoolExecutor</span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ScheduledThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-type">int</span> corePoolSize)</span> &#123;<br>    <span class="hljs-built_in">super</span>(corePoolSize, Integer.MAX_VALUE,<br>          DEFAULT_KEEPALIVE_MILLIS, MILLISECONDS,<br>          <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayedWorkQueue</span>());<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h3><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>schedule()</code></td><td>延迟执行一次</td></tr><tr><td><code>scheduleAtFixedRate()</code></td><td>固定频率执行（不考虑任务耗时）</td></tr><tr><td><code>scheduleWithFixedDelay()</code></td><td>固定延迟执行（任务结束后延迟）</td></tr></tbody></table><h3 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">scheduler</span> <span class="hljs-operator">=</span> Executors.newScheduledThreadPool(<span class="hljs-number">2</span>);<br><br><span class="hljs-comment">// 1. 延迟 3 秒执行</span><br>scheduler.schedule(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;延迟3秒执行&quot;</span>);<br>&#125;, <span class="hljs-number">3</span>, TimeUnit.SECONDS);<br><br><span class="hljs-comment">// 2. 固定频率：每 2 秒执行一次（从上次开始时间算）</span><br>scheduler.scheduleAtFixedRate(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;固定频率执行: &quot;</span> + System.currentTimeMillis());<br>&#125;, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS);<br><br><span class="hljs-comment">// 3. 固定延迟：每次执行完后等 2 秒再执行</span><br>scheduler.scheduleWithFixedDelay(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;固定延迟执行&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123; Thread.sleep(<span class="hljs-number">1000</span>); &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;&#125;<br>&#125;, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, TimeUnit.SECONDS);<br></code></pre></td></tr></table></figure><h3 id="scheduleAtFixedRate-vs-scheduleWithFixedDelay"><a href="#scheduleAtFixedRate-vs-scheduleWithFixedDelay" class="headerlink" title="scheduleAtFixedRate vs scheduleWithFixedDelay"></a>scheduleAtFixedRate vs scheduleWithFixedDelay</h3><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">scheduleAtFixedRate (period=2s</span><span class="hljs-string">,</span> <span class="hljs-comment">任务耗时1s):</span><br><span class="hljs-comment">|</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|     |</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|     |</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|</span><br><span class="hljs-comment">0        1     2        3     4        5  (秒)</span><br><br><span class="hljs-comment">scheduleWithFixedDelay (delay=2s</span><span class="hljs-string">,</span> <span class="hljs-comment">任务耗时1s):</span><br><span class="hljs-comment">|</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|           |</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|           |</span><span class="hljs-literal">--</span><span class="hljs-comment">任务</span><span class="hljs-literal">--</span><span class="hljs-comment">|</span><br><span class="hljs-comment">0        1     2     3        4     5     6        7  (秒)</span><br>         <span class="hljs-comment">└──2s延迟──┘         └──2s延迟──┘</span><br></code></pre></td></tr></table></figure><hr><h2 id="5-WorkStealingPool（工作窃取线程池）"><a href="#5-WorkStealingPool（工作窃取线程池）" class="headerlink" title="5. WorkStealingPool（工作窃取线程池）"></a>5. WorkStealingPool（工作窃取线程池）</h2><h3 id="特点（Java-8-）"><a href="#特点（Java-8-）" class="headerlink" title="特点（Java 8+）"></a>特点（Java 8+）</h3><ul><li>基于 ForkJoinPool 实现 ^forkjoinpool</li><li>每个线程有自己的<strong>双端队列</strong></li><li>空闲线程会<strong>窃取</strong>其他线程队列的任务</li><li>默认线程数 &#x3D; CPU 核心数</li></ul><h3 id="源码分析-4"><a href="#源码分析-4" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutorService <span class="hljs-title function_">newWorkStealingPool</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ForkJoinPool</span>(<br>        Runtime.getRuntime().availableProcessors(),  <span class="hljs-comment">// CPU核心数</span><br>        ForkJoinPool.defaultForkJoinWorkerThreadFactory,<br>        <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span><br>    );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="工作窃取原理"><a href="#工作窃取原理" class="headerlink" title="工作窃取原理"></a>工作窃取原理</h3><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs inform7">线程1的队列:  <span class="hljs-comment">[任务A]</span> <span class="hljs-comment">[任务B]</span> <span class="hljs-comment">[任务C]</span> <span class="hljs-comment">[任务D]</span><br>                ↑ 从头部取任务执行<br>                <br>线程2的队列:  <span class="hljs-comment">[空]</span><br>                ↑ 自己队列空了，从线程1队列尾部窃取<br>                <br>结果: 线程2窃取任务D执行<br></code></pre></td></tr></table></figure><h3 id="使用场景-3"><a href="#使用场景-3" class="headerlink" title="使用场景"></a>使用场景</h3><table><thead><tr><th>场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>递归任务</strong></td><td>分治算法、树遍历</td></tr><tr><td><strong>并行计算</strong></td><td>大数据处理、并行流</td></tr></tbody></table><h3 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newWorkStealingPool();<br><br>List&lt;Callable&lt;Integer&gt;&gt; tasks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> i;<br>    tasks.add(() -&gt; &#123;<br>        Thread.sleep(<span class="hljs-number">100</span>);<br>        <span class="hljs-keyword">return</span> num * num;<br>    &#125;);<br>&#125;<br><br><span class="hljs-comment">// 并行执行所有任务</span><br>List&lt;Future&lt;Integer&gt;&gt; results = executor.invokeAll(tasks);<br></code></pre></td></tr></table></figure><hr><h2 id="线程池对比总结"><a href="#线程池对比总结" class="headerlink" title="线程池对比总结"></a>线程池对比总结</h2><table><thead><tr><th>类型</th><th>核心线程</th><th>最大线程</th><th>队列</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Fixed</strong></td><td>n</td><td>n</td><td>无界 LinkedBlockingQueue</td><td>CPU密集、负载稳定</td></tr><tr><td><strong>Cached</strong></td><td>0</td><td>MAX</td><td>SynchronousQueue</td><td>短任务、IO密集</td></tr><tr><td><strong>Single</strong></td><td>1</td><td>1</td><td>无界 LinkedBlockingQueue</td><td>顺序执行</td></tr><tr><td><strong>Scheduled</strong></td><td>n</td><td>MAX</td><td>DelayedWorkQueue</td><td>定时&#x2F;周期任务</td></tr><tr><td><strong>WorkStealing</strong></td><td>CPU核心数</td><td>-</td><td>双端队列</td><td>递归&#x2F;并行计算</td></tr></tbody></table><hr><h2 id="最佳实践：自定义线程池"><a href="#最佳实践：自定义线程池" class="headerlink" title="最佳实践：自定义线程池"></a>最佳实践：自定义线程池</h2><blockquote><p><strong>阿里巴巴 Java 开发手册</strong>：禁止使用 Executors 创建线程池，应通过 ThreadPoolExecutor 手动创建</p></blockquote><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><table><thead><tr><th>工厂方法</th><th>风险</th></tr></thead><tbody><tr><td>FixedThreadPool</td><td>无界队列可能 OOM</td></tr><tr><td>SingleThreadExecutor</td><td>无界队列可能 OOM</td></tr><tr><td>CachedThreadPool</td><td>最大线程数无限，可能创建过多线程</td></tr><tr><td>ScheduledThreadPool</td><td>最大线程数无限</td></tr></tbody></table><h3 id="推荐写法"><a href="#推荐写法" class="headerlink" title="推荐写法"></a>推荐写法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ✅ 推荐：手动创建线程池</span><br><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<br>    <span class="hljs-number">10</span>,                                     <span class="hljs-comment">// 核心线程数</span><br>    <span class="hljs-number">20</span>,                                     <span class="hljs-comment">// 最大线程数</span><br>    <span class="hljs-number">60L</span>, TimeUnit.SECONDS,                  <span class="hljs-comment">// 空闲存活时间</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>),          <span class="hljs-comment">// 有界队列</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryBuilder</span>()              <span class="hljs-comment">// 自定义线程名（Guava）</span><br>        .setNameFormat(<span class="hljs-string">&quot;业务线程-%d&quot;</span>)<br>        .build(),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy()  <span class="hljs-comment">// 拒绝策略</span><br>);<br></code></pre></td></tr></table></figure><h3 id="线程数设置建议"><a href="#线程数设置建议" class="headerlink" title="线程数设置建议"></a>线程数设置建议</h3><table><thead><tr><th>任务类型</th><th>线程数公式</th><th>说明</th></tr></thead><tbody><tr><td><strong>CPU 密集型</strong></td><td>N + 1</td><td>N &#x3D; CPU 核心数</td></tr><tr><td><strong>IO 密集型</strong></td><td>2N 或 N * (1 + W&#x2F;C)</td><td>W&#x3D;等待时间，C&#x3D;计算时间</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 获取 CPU 核心数</span><br><span class="hljs-type">int</span> <span class="hljs-variable">cpuCores</span> <span class="hljs-operator">=</span> Runtime.getRuntime().availableProcessors();<br></code></pre></td></tr></table></figure><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li><strong>上一篇</strong>：02-线程池原理</li><li><strong>下一篇</strong>：04-ForkJoinPool</li><li><strong>线程池简介</strong>：01-线程池简介</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>线程池</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>线程池</tag>
      
      <tag>Executors</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程池简介</title>
    <link href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AE%80%E4%BB%8B/"/>
    <url>/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="线程池简介"><a href="#线程池简介" class="headerlink" title="线程池简介"></a>线程池简介</h1><h2 id="什么是线程池"><a href="#什么是线程池" class="headerlink" title="什么是线程池"></a>什么是线程池</h2><p>线程池（Thread Pool）是一种<strong>线程复用</strong>的技术，预先创建一定数量的线程放入池中，当有任务需要执行时，从池中获取空闲线程来执行任务，任务完成后线程不销毁，而是返回池中等待下一个任务。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 最简单的线程池使用示例</span><br><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);<br>executor.submit(() -&gt; &#123;<br>    System.out.println(<span class="hljs-string">&quot;任务执行中...&quot;</span>);<br>&#125;);<br>executor.shutdown();<br></code></pre></td></tr></table></figure><hr><h2 id="为什么需要线程池"><a href="#为什么需要线程池" class="headerlink" title="为什么需要线程池"></a>为什么需要线程池</h2><h3 id="问题：直接创建线程的弊端"><a href="#问题：直接创建线程的弊端" class="headerlink" title="问题：直接创建线程的弊端"></a>问题：直接创建线程的弊端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 不推荐：每次任务都创建新线程</span><br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; doTask()).start();<br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th>问题</th><th>说明</th></tr></thead><tbody><tr><td>创建开销大</td><td>线程创建需要分配栈内存（默认1MB）、初始化 TCB 等</td></tr><tr><td>销毁开销大</td><td>线程销毁需要回收资源、GC 处理</td></tr><tr><td>资源耗尽</td><td>无限制创建线程可能导致 OOM 或系统崩溃</td></tr><tr><td>上下文切换</td><td>线程过多导致 CPU 频繁切换，性能下降</td></tr><tr><td>难以管理</td><td>无法统一监控、调度、限流</td></tr></tbody></table><h3 id="解决：线程池的优势"><a href="#解决：线程池的优势" class="headerlink" title="解决：线程池的优势"></a>解决：线程池的优势</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 推荐：使用线程池复用线程</span><br><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>    executor.submit(() -&gt; doTask());<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="线程池的核心优势"><a href="#线程池的核心优势" class="headerlink" title="线程池的核心优势"></a>线程池的核心优势</h2><table><thead><tr><th>优势</th><th>说明</th></tr></thead><tbody><tr><td><strong>降低资源消耗</strong></td><td>复用线程，避免频繁创建销毁的开销</td></tr><tr><td><strong>提高响应速度</strong></td><td>任务到达时无需等待线程创建，直接执行</td></tr><tr><td><strong>提高可管理性</strong></td><td>统一分配、调优、监控线程资源</td></tr><tr><td><strong>提供更多功能</strong></td><td>定时执行、周期执行、任务队列、拒绝策略等</td></tr></tbody></table><hr><h2 id="线程池核心接口"><a href="#线程池核心接口" class="headerlink" title="线程池核心接口"></a>线程池核心接口</h2><figure class="highlight isbl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs isbl">┌─────────────────────────────────────────────────────────┐<br>│                      <span class="hljs-variable">Executor</span>                           │<br>│                   (顶层接口)                             │<br>│              <span class="hljs-variable">void</span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-built_in">execute</span></span>(<span class="hljs-variable">Runnable</span>)                     │</span><br><span class="hljs-function">└─────────────────────┬───────────────────────────────────┘</span><br><span class="hljs-function">                      │</span><br><span class="hljs-function">                      ▼</span><br><span class="hljs-function">┌─────────────────────────────────────────────────────────┐</span><br><span class="hljs-function">│                  <span class="hljs-variable">ExecutorService</span>                        │</span><br><span class="hljs-function">│                 (扩展生命周期管理)                        │</span><br><span class="hljs-function">│     <span class="hljs-title">submit</span>() / <span class="hljs-title">shutdown</span>() / <span class="hljs-title">invokeAll</span>() / ...          │</span><br><span class="hljs-function">└─────────────────────┬───────────────────────────────────┘</span><br><span class="hljs-function">                      │</span><br><span class="hljs-function">                      ▼</span><br><span class="hljs-function">┌─────────────────────────────────────────────────────────┐</span><br><span class="hljs-function">│              <span class="hljs-variable">ThreadPoolExecutor</span>                         │</span><br><span class="hljs-function">│                (核心实现类)                              │</span><br><span class="hljs-function">│         <span class="hljs-number">7</span>大参数 / <span class="hljs-number">4</span>种拒绝策略 / <span class="hljs-number">5</span>种状态                   │</span><br><span class="hljs-function">└─────────────────────────────────────────────────────────┘</span><br></code></pre></td></tr></table></figure><hr><h2 id="快速入门示例"><a href="#快速入门示例" class="headerlink" title="快速入门示例"></a>快速入门示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.concurrent.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolDemo</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 1. 创建线程池</span><br>        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">3</span>);<br>        <br>        <span class="hljs-comment">// 2. 提交任务</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">taskId</span> <span class="hljs-operator">=</span> i;<br>            executor.submit(() -&gt; &#123;<br>                System.out.println(<span class="hljs-string">&quot;任务&quot;</span> + taskId + <span class="hljs-string">&quot; 由 &quot;</span> + <br>                    Thread.currentThread().getName() + <span class="hljs-string">&quot; 执行&quot;</span>);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(<span class="hljs-number">1000</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    Thread.currentThread().interrupt();<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <br>        <span class="hljs-comment">// 3. 关闭线程池</span><br>        executor.shutdown();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>输出示例：</strong></p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs subunit">任务1 由 pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span> 执行<br>任务2 由 pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-2</span> 执行<br>任务3 由 pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-3</span> 执行<br>任务4 由 pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-1</span> 执行  ← 线程复用<br>任务5 由 pool<span class="hljs-string">-1</span>-thread<span class="hljs-string">-2</span> 执行  ← 线程复用<br></code></pre></td></tr></table></figure><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li><strong>下一篇</strong>：02-线程池原理</li><li><strong>线程池类型</strong>：03-线程池类型</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>线程池</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>线程池</tag>
      
      <tag>ExecutorService</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程模型与Netty</title>
    <link href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%8ENetty/"/>
    <url>/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B8%8ENetty/</url>
    
    <content type="html"><![CDATA[<h1 id="线程模型与-Netty"><a href="#线程模型与-Netty" class="headerlink" title="线程模型与 Netty"></a>线程模型与 Netty</h1><h2 id="传统-Servlet-线程模型"><a href="#传统-Servlet-线程模型" class="headerlink" title="传统 Servlet 线程模型"></a>传统 Servlet 线程模型</h2><p>传统 Spring MVC 基于 Servlet 容器，采用<strong>每请求一线程</strong>模型：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css">请求<span class="hljs-number">1</span> ──→ 线程<span class="hljs-number">1</span> ──→ <span class="hljs-selector-attr">[接收请求 → 处理业务 → 等待DB → 返回响应]</span> ──→ 释放<br>请求<span class="hljs-number">2</span> ──→ 线程<span class="hljs-number">2</span> ──→ <span class="hljs-selector-attr">[接收请求 → 处理业务 → 等待DB → 返回响应]</span> ──→ 释放<br>请求<span class="hljs-number">3</span> ──→ 线程<span class="hljs-number">3</span> ──→ <span class="hljs-selector-attr">[接收请求 → 处理业务 → 等待DB → 返回响应]</span> ──→ 释放<br></code></pre></td></tr></table></figure><h3 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h3><ul><li>一个请求<strong>独占</strong>一个线程，从头到尾</li><li>线程在等待 I&#x2F;O（数据库、网络调用）时<strong>阻塞</strong>，什么都不做</li><li>高并发时需要大量线程（Tomcat 默认 200 个）</li><li>线程切换开销大，内存占用高（每线程约 1MB 栈空间）</li></ul><h2 id="WebFlux-事件循环模型"><a href="#WebFlux-事件循环模型" class="headerlink" title="WebFlux 事件循环模型"></a>WebFlux 事件循环模型</h2><p>WebFlux 基于 Netty，采用<strong>事件循环（Event Loop）</strong> 模型：</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mathematica">                 ┌─────────────────────────────────────┐<br>                 │         <span class="hljs-variable">Event</span> <span class="hljs-variable">Loop</span> 线程池           │<br>                 │     <span class="hljs-punctuation">(</span>少量线程，如 <span class="hljs-variable">CPU</span> 核心数<span class="hljs-punctuation">)</span>        │<br>                 └─────────────────────────────────────┘<br>                                 │<br>     ┌───────────────────────────┼───────────────────────────┐<br>     ↓                           ↓                           ↓<br>接收请求<span class="hljs-number">1</span>                    接收请求<span class="hljs-number">2</span>                    接收请求<span class="hljs-number">3</span><br>     │                           │                           │<br>     ↓                           ↓                           ↓<br>提交<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>任务                 提交<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>任务                 提交<span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span>任务<br><span class="hljs-punctuation">(</span>非阻塞返回<span class="hljs-punctuation">)</span>                <span class="hljs-punctuation">(</span>非阻塞返回<span class="hljs-punctuation">)</span>                <span class="hljs-punctuation">(</span>非阻塞返回<span class="hljs-punctuation">)</span><br>     │                           │                           │<br>     └───────────────────────────┼───────────────────────────┘<br>                                 ↓<br>                 ┌─────────────────────────────────────┐<br>                 │      <span class="hljs-built_in">I</span><span class="hljs-operator">/</span><span class="hljs-built_in">O</span> 完成后触发回调              │<br>                 │      <span class="hljs-variable">Event</span> <span class="hljs-variable">Loop</span> 继续处理            │<br>                 └─────────────────────────────────────┘<br></code></pre></td></tr></table></figure><h3 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h3><ul><li>线程<strong>不等待</strong> I&#x2F;O 完成，立即去处理其他请求</li><li>I&#x2F;O 完成后通过<strong>回调&#x2F;事件</strong>通知</li><li>少量线程就能处理大量并发连接</li></ul><h2 id="WebFlux-中的线程池"><a href="#WebFlux-中的线程池" class="headerlink" title="WebFlux 中的线程池"></a>WebFlux 中的线程池</h2><p>WebFlux 使用多个线程池，各司其职：</p><h3 id="1-Event-Loop-线程池"><a href="#1-Event-Loop-线程池" class="headerlink" title="1. Event Loop 线程池"></a>1. Event Loop 线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Netty 的 NioEventLoopGroup</span><br><span class="hljs-comment">// 线程数 = CPU 核心数</span><br></code></pre></td></tr></table></figure><ul><li>处理连接建立、读写事件</li><li><strong>绝对不能阻塞</strong>，否则影响所有请求</li></ul><h3 id="2-boundedElastic-线程池"><a href="#2-boundedElastic-线程池" class="headerlink" title="2. boundedElastic 线程池"></a>2. boundedElastic 线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono.fromCallable(() -&gt; blockingCall())<br>    .subscribeOn(Schedulers.boundedElastic())<br></code></pre></td></tr></table></figure><ul><li>处理<strong>必须阻塞</strong>的操作（如调用阻塞 API）</li><li>弹性伸缩，有上限保护</li><li>适合 I&#x2F;O 密集型阻塞操作</li></ul><h3 id="3-parallel-线程池"><a href="#3-parallel-线程池" class="headerlink" title="3. parallel 线程池"></a>3. parallel 线程池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br>    .parallel()<br>    .runOn(Schedulers.parallel())<br></code></pre></td></tr></table></figure><ul><li>线程数 &#x3D; CPU 核心数</li><li>适合 <strong>CPU 密集型</strong>任务</li></ul><h2 id="线程模型对比"><a href="#线程模型对比" class="headerlink" title="线程模型对比"></a>线程模型对比</h2><table><thead><tr><th>方面</th><th>传统 MVC</th><th>WebFlux</th></tr></thead><tbody><tr><td>线程数量</td><td>大量（默认 200+）</td><td>少量（CPU 核心数）</td></tr><tr><td>等待 I&#x2F;O 时</td><td>线程阻塞等待</td><td>线程去处理其他请求</td></tr><tr><td>线程利用率</td><td>低（大量时间在等待）</td><td>高（几乎不等待）</td></tr><tr><td>内存占用</td><td>高（每线程 ~1MB）</td><td>低</td></tr><tr><td>上下文切换</td><td>频繁</td><td>很少</td></tr><tr><td>编程模型</td><td>同步阻塞</td><td>异步非阻塞</td></tr></tbody></table><h2 id="WebFlux-与-Netty-的关系"><a href="#WebFlux-与-Netty-的关系" class="headerlink" title="WebFlux 与 Netty 的关系"></a>WebFlux 与 Netty 的关系</h2><h3 id="Netty-是什么"><a href="#Netty-是什么" class="headerlink" title="Netty 是什么"></a>Netty 是什么</h3><p>Netty 是一个<strong>高性能网络通信框架</strong>，提供：</p><ul><li>非阻塞 I&#x2F;O（NIO）</li><li>事件驱动模型</li><li>高效的内存管理</li><li>协议编解码支持</li></ul><h3 id="直接用-Netty"><a href="#直接用-Netty" class="headerlink" title="直接用 Netty"></a>直接用 Netty</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Netty 原生代码 - 处理一个简单的 HTTP 请求</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> &#123;<br>        <span class="hljs-keyword">if</span> (msg <span class="hljs-keyword">instanceof</span> HttpRequest) &#123;<br>            <span class="hljs-type">HttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> (HttpRequest) msg;<br>            <br>            <span class="hljs-comment">// 手动解析路径</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> request.uri();<br>            <br>            <span class="hljs-comment">// 手动构建响应</span><br>            <span class="hljs-type">FullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpResponse</span>(<br>                HttpVersion.HTTP_1_1, <br>                HttpResponseStatus.OK,<br>                Unpooled.copiedBuffer(<span class="hljs-string">&quot;Hello&quot;</span>, CharsetUtil.UTF_8)<br>            );<br>            response.headers().set(HttpHeaderNames.CONTENT_TYPE, <span class="hljs-string">&quot;text/plain&quot;</span>);<br>            response.headers().set(HttpHeaderNames.CONTENT_LENGTH, <br>                response.content().readableBytes());<br>            <br>            ctx.writeAndFlush(response);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>需要自己处理：路由、参数解析、JSON 序列化、异常处理、连接管理…</p><h3 id="用-WebFlux"><a href="#用-WebFlux" class="headerlink" title="用 WebFlux"></a>用 WebFlux</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> &#123;<br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/hello/&#123;name&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Mono&lt;User&gt; <span class="hljs-title function_">hello</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String name)</span> &#123;<br>        <span class="hljs-keyword">return</span> userService.findByName(name);  <span class="hljs-comment">// 自动 JSON 序列化</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="WebFlux-在-Netty-之上提供了什么"><a href="#WebFlux-在-Netty-之上提供了什么" class="headerlink" title="WebFlux 在 Netty 之上提供了什么"></a>WebFlux 在 Netty 之上提供了什么</h3><table><thead><tr><th>功能</th><th>Netty</th><th>WebFlux</th></tr></thead><tbody><tr><td>路由</td><td>手动解析 URI</td><td><code>@GetMapping</code>、<code>RouterFunction</code></td></tr><tr><td>参数绑定</td><td>手动解析</td><td><code>@PathVariable</code>、<code>@RequestBody</code></td></tr><tr><td>JSON 序列化</td><td>手动处理</td><td>自动（Jackson）</td></tr><tr><td>异常处理</td><td>手动 try-catch</td><td><code>@ExceptionHandler</code></td></tr><tr><td>依赖注入</td><td>无</td><td>Spring IoC</td></tr><tr><td>配置管理</td><td>无</td><td><code>application.yml</code></td></tr><tr><td>安全认证</td><td>手动实现</td><td>Spring Security</td></tr><tr><td>数据访问</td><td>手动实现</td><td>Spring Data R2DBC</td></tr><tr><td>测试支持</td><td>手动</td><td><code>WebTestClient</code></td></tr></tbody></table><h3 id="类比理解"><a href="#类比理解" class="headerlink" title="类比理解"></a>类比理解</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Netty</span>      ≈  TCP/HTTP 协议引擎（底层）<br>WebFlux    ≈  Web 开发框架（上层）<br><br>就像：<br>JDBC       ≈  数据库连接（底层）<br>MyBatis    ≈  ORM 框架（上层）<br></code></pre></td></tr></table></figure><p><strong>Netty 是引擎，WebFlux 是汽车。</strong> 你可以直接用引擎，但大多数人更愿意开汽车。</p><h2 id="什么时候直接用-Netty"><a href="#什么时候直接用-Netty" class="headerlink" title="什么时候直接用 Netty"></a>什么时候直接用 Netty</h2><ul><li>自定义协议（非 HTTP）</li><li>极致性能优化</li><li>不需要 Spring 生态</li><li>构建基础设施（如网关、代理服务器）</li></ul><h2 id="为什么-WebFlux-适合高并发"><a href="#为什么-WebFlux-适合高并发" class="headerlink" title="为什么 WebFlux 适合高并发"></a>为什么 WebFlux 适合高并发</h2><ol><li><strong>少量线程处理大量连接</strong>：不需要为每个连接分配线程</li><li><strong>线程不阻塞</strong>：I&#x2F;O 等待时去处理其他请求</li><li><strong>内存效率高</strong>：线程少，内存占用低</li><li><strong>无线程切换开销</strong>：事件驱动，不需要频繁切换</li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>Webflux简介</li><li>响应式编程基础</li><li>Reactor核心API</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Webflux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>WebFlux</tag>
      
      <tag>Netty</tag>
      
      <tag>线程模型</tag>
      
      <tag>EventLoop</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>源码解析</title>
    <link href="/2026/01/10/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/"/>
    <url>/2026/01/10/%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h1><h2 id="Mono-just-源码分析"><a href="#Mono-just-源码分析" class="headerlink" title="Mono.just() 源码分析"></a>Mono.just() 源码分析</h2><p>从最简单的 <code>Mono.just()</code> 开始：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Mono.just(<span class="hljs-string">&quot;Hello&quot;</span>)<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><h3 id="1-创建-Mono"><a href="#1-创建-Mono" class="headerlink" title="1. 创建 Mono"></a>1. 创建 Mono</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mono.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Mono&lt;T&gt; <span class="hljs-title function_">just</span><span class="hljs-params">(T data)</span> &#123;<br>    <span class="hljs-keyword">return</span> onAssembly(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MonoJust</span>&lt;&gt;(data));<br>&#125;<br><br><span class="hljs-comment">// MonoJust.java - 持有数据的 Mono</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonoJust</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Mono</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">final</span> T value;<br>    <br>    MonoJust(T value) &#123;<br>        <span class="hljs-built_in">this</span>.value = Objects.requireNonNull(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-订阅时发生了什么"><a href="#2-订阅时发生了什么" class="headerlink" title="2. 订阅时发生了什么"></a>2. 订阅时发生了什么</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Mono.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(Consumer&lt;? <span class="hljs-built_in">super</span> T&gt; consumer)</span> &#123;<br>    <span class="hljs-comment">// 创建 LambdaMonoSubscriber 包装 consumer</span><br>    subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaMonoSubscriber</span>&lt;&gt;(consumer, ...));<br>&#125;<br><br><span class="hljs-comment">// MonoJust.java</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(CoreSubscriber&lt;? <span class="hljs-built_in">super</span> T&gt; actual)</span> &#123;<br>    <span class="hljs-comment">// 直接调用 onSubscribe 和 onNext</span><br>    actual.onSubscribe(Operators.scalarSubscription(actual, value));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-数据传递"><a href="#3-数据传递" class="headerlink" title="3. 数据传递"></a>3. 数据传递</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Operators.java - ScalarSubscription</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScalarSubscription</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subscription</span> &#123;<br>    <span class="hljs-keyword">final</span> CoreSubscriber&lt;? <span class="hljs-built_in">super</span> T&gt; actual;<br>    <span class="hljs-keyword">final</span> T value;<br>    <span class="hljs-keyword">volatile</span> <span class="hljs-type">int</span> once;  <span class="hljs-comment">// 确保只发送一次</span><br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span> &#123;<br>        <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span> &amp;&amp; ONCE.compareAndSet(<span class="hljs-built_in">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>)) &#123;<br>            actual.onNext(value);    <span class="hljs-comment">// 发送数据</span><br>            actual.onComplete();      <span class="hljs-comment">// 完成</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>流程总结</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Mono<span class="hljs-selector-class">.just</span>(<span class="hljs-string">&quot;Hello&quot;</span>)<br>    ↓<br>new <span class="hljs-built_in">MonoJust</span>(<span class="hljs-string">&quot;Hello&quot;</span>)<br>    ↓<br><span class="hljs-function"><span class="hljs-title">subscribe</span><span class="hljs-params">(consumer)</span></span><br>    ↓<br><span class="hljs-function"><span class="hljs-title">onSubscribe</span><span class="hljs-params">(ScalarSubscription)</span></span><br>    ↓<br><span class="hljs-function"><span class="hljs-title">request</span><span class="hljs-params">(Long.MAX_VALUE)</span></span>  <span class="hljs-comment">// LambdaSubscriber 默认请求无限</span><br>    ↓<br><span class="hljs-function"><span class="hljs-title">onNext</span><span class="hljs-params">(<span class="hljs-string">&quot;Hello&quot;</span>)</span></span><br>    ↓<br><span class="hljs-function"><span class="hljs-title">onComplete</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></table></figure><h2 id="Flux-map-源码分析"><a href="#Flux-map-源码分析" class="headerlink" title="Flux.map() 源码分析"></a>Flux.map() 源码分析</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.just(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)<br>    .map(i -&gt; i * <span class="hljs-number">2</span>)<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><h3 id="1-创建-FluxMap"><a href="#1-创建-FluxMap" class="headerlink" title="1. 创建 FluxMap"></a>1. 创建 FluxMap</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Flux.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> &lt;V&gt; Flux&lt;V&gt; <span class="hljs-title function_">map</span><span class="hljs-params">(Function&lt;? <span class="hljs-built_in">super</span> T, ? extends V&gt; mapper)</span> &#123;<br>    <span class="hljs-keyword">return</span> onAssembly(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FluxMap</span>&lt;&gt;(<span class="hljs-built_in">this</span>, mapper));<br>&#125;<br><br><span class="hljs-comment">// FluxMap.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FluxMap</span>&lt;T, R&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FluxOperator</span>&lt;T, R&gt; &#123;<br>    <span class="hljs-keyword">final</span> Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">R</span>&gt; mapper;<br>    <br>    FluxMap(Flux&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt; source, Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">R</span>&gt; mapper) &#123;<br>        <span class="hljs-built_in">super</span>(source);<br>        <span class="hljs-built_in">this</span>.mapper = mapper;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-订阅时的包装"><a href="#2-订阅时的包装" class="headerlink" title="2. 订阅时的包装"></a>2. 订阅时的包装</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FluxMap.java</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribe</span><span class="hljs-params">(CoreSubscriber&lt;? <span class="hljs-built_in">super</span> R&gt; actual)</span> &#123;<br>    <span class="hljs-comment">// 用 MapSubscriber 包装下游订阅者</span><br>    source.subscribe(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MapSubscriber</span>&lt;&gt;(actual, mapper));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-数据转换"><a href="#3-数据转换" class="headerlink" title="3. 数据转换"></a>3. 数据转换</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FluxMap.java - MapSubscriber</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapSubscriber</span>&lt;T, R&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt;, Subscription &#123;<br>    <span class="hljs-keyword">final</span> CoreSubscriber&lt;? <span class="hljs-built_in">super</span> R&gt; actual;  <span class="hljs-comment">// 下游</span><br>    <span class="hljs-keyword">final</span> Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">R</span>&gt; mapper;<br>    Subscription s;  <span class="hljs-comment">// 上游的 Subscription</span><br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(T t)</span> &#123;<br>        <span class="hljs-type">R</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mapper.apply(t);  <span class="hljs-comment">// 转换数据</span><br>        actual.onNext(v);        <span class="hljs-comment">// 传给下游</span><br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span> &#123;<br>        s.request(n);  <span class="hljs-comment">// 背压信号向上传递</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>订阅链结构</strong>：</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">FluxArray</span> <span class="hljs-selector-attr">[1,2,3]</span><br>    ↓ <span class="hljs-selector-tag">subscribe</span><br><span class="hljs-selector-tag">MapSubscriber</span> (<span class="hljs-attribute">mapper</span>: i -&gt; i*<span class="hljs-number">2</span>)<br>    ↓ <span class="hljs-selector-tag">subscribe</span>  <br><span class="hljs-selector-tag">LambdaSubscriber</span> (<span class="hljs-attribute">consumer</span>: println)<br></code></pre></td></tr></table></figure><p><strong>数据流向</strong>：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">FluxArray<span class="hljs-selector-class">.onNext</span>(<span class="hljs-number">1</span>)<br>    ↓<br>MapSubscriber<span class="hljs-selector-class">.onNext</span>(<span class="hljs-number">1</span>) → mapper<span class="hljs-selector-class">.apply</span>(<span class="hljs-number">1</span>) = <span class="hljs-number">2</span><br>    ↓<br>LambdaSubscriber<span class="hljs-selector-class">.onNext</span>(<span class="hljs-number">2</span>) → <span class="hljs-built_in">println</span>(<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><h2 id="背压传递源码"><a href="#背压传递源码" class="headerlink" title="背压传递源码"></a>背压传递源码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">100</span>)<br>    .filter(i -&gt; i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)<br>    .take(<span class="hljs-number">5</span>)<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><h3 id="request-的传递"><a href="#request-的传递" class="headerlink" title="request 的传递"></a>request 的传递</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FluxTake.java - TakeSubscriber</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span> &#123;<br>    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 向上游请求，但不超过剩余需要的数量</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">toRequest</span> <span class="hljs-operator">=</span> Math.min(n, remaining);<br>        s.request(toRequest);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// FluxFilter.java - FilterSubscriber  </span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">request</span><span class="hljs-params">(<span class="hljs-type">long</span> n)</span> &#123;<br>    <span class="hljs-comment">// filter 可能需要请求更多，因为有些会被过滤掉</span><br>    s.request(n);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="完整的背压流程"><a href="#完整的背压流程" class="headerlink" title="完整的背压流程"></a>完整的背压流程</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">LambdaSubscriber<span class="hljs-selector-class">.request</span>(Long.MAX_VALUE)<br>    ↓<br>TakeSubscriber<span class="hljs-selector-class">.request</span>(Long.MAX_VALUE) <br>    → 实际请求 <span class="hljs-built_in">min</span>(MAX_VALUE, <span class="hljs-number">5</span>) = <span class="hljs-number">5</span><br>    ↓<br>FilterSubscriber<span class="hljs-selector-class">.request</span>(<span class="hljs-number">5</span>)<br>    → 直接传递（<span class="hljs-attribute">filter</span> 不知道会过滤多少）<br>    ↓<br>RangeSubscription<span class="hljs-selector-class">.request</span>(<span class="hljs-number">5</span>)<br>    → 开始生产 <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><h2 id="异步边界与调度器"><a href="#异步边界与调度器" class="headerlink" title="异步边界与调度器"></a>异步边界与调度器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)<br>    .publishOn(Schedulers.parallel())<br>    .map(i -&gt; i * <span class="hljs-number">2</span>)<br>    .subscribe(System.out::println);<br></code></pre></td></tr></table></figure><h3 id="publishOn-的实现"><a href="#publishOn-的实现" class="headerlink" title="publishOn 的实现"></a>publishOn 的实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// FluxPublishOn.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FluxPublishOn</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FluxOperator</span>&lt;T, T&gt; &#123;<br>    <span class="hljs-keyword">final</span> Scheduler scheduler;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> prefetch;  <span class="hljs-comment">// 预取数量</span><br>    <br>    <span class="hljs-comment">// PublishOnSubscriber 内部有队列</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PublishOnSubscriber</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Subscriber</span>&lt;T&gt;, Runnable &#123;<br>        <span class="hljs-keyword">final</span> Queue&lt;T&gt; queue;  <span class="hljs-comment">// 缓冲队列</span><br>        <span class="hljs-keyword">final</span> Worker worker;   <span class="hljs-comment">// 调度器工作线程</span><br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onNext</span><span class="hljs-params">(T t)</span> &#123;<br>            queue.offer(t);     <span class="hljs-comment">// 放入队列</span><br>            trySchedule();      <span class="hljs-comment">// 调度执行</span><br>        &#125;<br>        <br>        <span class="hljs-keyword">void</span> <span class="hljs-title function_">trySchedule</span><span class="hljs-params">()</span> &#123;<br>            worker.schedule(<span class="hljs-built_in">this</span>);  <span class="hljs-comment">// 在另一个线程执行 run()</span><br>        &#125;<br>        <br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-comment">// 在调度器线程中执行</span><br>            <span class="hljs-type">T</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> queue.poll();<br>            actual.onNext(v);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>线程切换点</strong>：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino">main 线程: range → publishOn 的 queue<br>    ↓ (线程切换)<br>parallel 线程: queue → map → subscribe<br></code></pre></td></tr></table></figure><h2 id="关键设计模式"><a href="#关键设计模式" class="headerlink" title="关键设计模式"></a>关键设计模式</h2><h3 id="1-装饰器模式"><a href="#1-装饰器模式" class="headerlink" title="1. 装饰器模式"></a>1. 装饰器模式</h3><p>每个操作符都是对上游的装饰：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Flux&lt;Integer&gt; source = Flux.range(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>);<br>Flux&lt;Integer&gt; mapped = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FluxMap</span>&lt;&gt;(source, i -&gt; i * <span class="hljs-number">2</span>);<br>Flux&lt;Integer&gt; filtered = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FluxFilter</span>&lt;&gt;(mapped, i -&gt; i &gt; <span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><h3 id="2-责任链模式"><a href="#2-责任链模式" class="headerlink" title="2. 责任链模式"></a>2. 责任链模式</h3><p>订阅时形成 Subscriber 链：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">source.subscribe(<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapSubscriber</span>(<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterSubscriber</span>(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaSubscriber</span>(consumer)<br>        )<br>    )<br>);<br></code></pre></td></tr></table></figure><h3 id="3-观察者模式"><a href="#3-观察者模式" class="headerlink" title="3. 观察者模式"></a>3. 观察者模式</h3><p>Publisher-Subscriber 本身就是观察者模式的变体。</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li>上一篇：Project Reactor 实现</li><li>Reactive Streams 规范</li><li>WebFlux - 线程模型与Netty</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>Spring</category>
      
      <category>Reactive Streams</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>Spring</tag>
      
      <tag>ReactiveStreams</tag>
      
      <tag>Reactor</tag>
      
      <tag>源码</tag>
      
      <tag>设计模式</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>线程池原理</title>
    <link href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86/"/>
    <url>/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="线程池原理"><a href="#线程池原理" class="headerlink" title="线程池原理"></a>线程池原理</h1><h2 id="核心参数（7大参数）"><a href="#核心参数（7大参数）" class="headerlink" title="核心参数（7大参数）"></a>核心参数（7大参数）</h2><p><code>ThreadPoolExecutor</code> 是线程池的核心实现类，其构造函数包含 7 个关键参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ThreadPoolExecutor</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-type">int</span> corePoolSize,           // 核心线程数</span><br><span class="hljs-params">    <span class="hljs-type">int</span> maximumPoolSize,        // 最大线程数</span><br><span class="hljs-params">    <span class="hljs-type">long</span> keepAliveTime,         // 空闲线程存活时间</span><br><span class="hljs-params">    TimeUnit unit,              // 时间单位</span><br><span class="hljs-params">    BlockingQueue&lt;Runnable&gt; workQueue,  // 任务队列</span><br><span class="hljs-params">    ThreadFactory threadFactory,        // 线程工厂</span><br><span class="hljs-params">    RejectedExecutionHandler handler    // 拒绝策略</span><br><span class="hljs-params">)</span><br></code></pre></td></tr></table></figure><h3 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h3><table><thead><tr><th>参数</th><th>说明</th><th>建议</th></tr></thead><tbody><tr><td><strong>corePoolSize</strong></td><td>核心线程数，即使空闲也不会被回收</td><td>CPU密集型：N+1，IO密集型：2N 👉详解</td></tr><tr><td><strong>maximumPoolSize</strong></td><td>线程池最大线程数</td><td>根据业务峰值设置</td></tr><tr><td><strong>keepAliveTime</strong></td><td>非核心线程空闲存活时间</td><td>一般 60s</td></tr><tr><td><strong>unit</strong></td><td>keepAliveTime 的时间单位</td><td>TimeUnit.SECONDS</td></tr><tr><td><strong>workQueue</strong></td><td>任务等待队列</td><td>有界队列更安全</td></tr><tr><td><strong>threadFactory</strong></td><td>创建线程的工厂，可自定义线程名</td><td>建议自定义便于排查</td></tr><tr><td><strong>handler</strong></td><td>队列满且线程数达到最大时的拒绝策略</td><td>根据业务选择</td></tr></tbody></table><hr><h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs gams">      ┌─────────────────┐<br>      │   提交任务       │<br>      └────────┬────────┘<br>               │<br>               ▼<br>┌──────────────────────────────┐<br>│  核心线程数 &lt; corePoolSize?   │<br>└──────────────┬───────────────┘<br>      <span class="hljs-keyword">YES</span> │          │ <span class="hljs-keyword">NO</span><br>          ▼          ▼<br>┌─────────────┐  ┌─────────────────┐<br>│ 创建核心线程 │  │ 任务队列未满?    │<br>│ 执行任务     │  └────────┬────────┘<br>└─────────────┘      <span class="hljs-keyword">YES</span> │     │ <span class="hljs-keyword">NO</span><br>                        ▼     ▼<br>                ┌─────────┐ ┌──────────────────┐<br>                │ 入队等待 │ │ 线程数 &lt; maxSize? │<br>                └─────────┘ └────────┬─────────┘<br>                              <span class="hljs-keyword">YES</span> │      │ <span class="hljs-keyword">NO</span><br>                                  ▼      ▼<br>                          ┌─────────┐ ┌─────────┐<br>                          │创建非核心│ │ 拒绝策略 │<br>                          │线程执行  │ └─────────┘<br>                          └─────────┘<br></code></pre></td></tr></table></figure><h3 id="流程总结"><a href="#流程总结" class="headerlink" title="流程总结"></a>流程总结</h3><ol><li><strong>核心线程优先</strong>：任务来了先看核心线程是否已满</li><li><strong>队列缓冲</strong>：核心线程满了，任务进入队列等待</li><li><strong>扩容线程</strong>：队列满了，创建非核心线程处理 👉详解 ^expand-thread</li><li><strong>拒绝任务</strong>：线程数达到最大且队列满，执行拒绝策略</li></ol><blockquote><p><strong>注意</strong>：不是先扩容线程再入队，而是<strong>先入队再扩容</strong>！</p></blockquote><hr><h2 id="任务队列类型"><a href="#任务队列类型" class="headerlink" title="任务队列类型"></a>任务队列类型</h2><table><thead><tr><th>队列类型</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>ArrayBlockingQueue</strong></td><td>有界数组队列，FIFO</td><td>控制资源消耗，推荐使用</td></tr><tr><td><strong>LinkedBlockingQueue</strong></td><td>可选有界链表队列，默认无界</td><td>任务量可控时使用</td></tr><tr><td><strong>SynchronousQueue</strong></td><td>不存储元素，直接传递</td><td>CachedThreadPool 使用</td></tr><tr><td><strong>PriorityBlockingQueue</strong></td><td>优先级队列，无界</td><td>需要任务优先级时</td></tr><tr><td><strong>DelayQueue</strong></td><td>延迟队列</td><td>定时任务场景</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 推荐：使用有界队列</span><br>BlockingQueue&lt;Runnable&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">100</span>);<br></code></pre></td></tr></table></figure><hr><h2 id="四种拒绝策略"><a href="#四种拒绝策略" class="headerlink" title="四种拒绝策略"></a>四种拒绝策略</h2><p>当任务无法被执行时（队列满 + 线程数达到最大），触发拒绝策略：</p><table><thead><tr><th>策略</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>AbortPolicy</strong></td><td>抛出 RejectedExecutionException</td><td>默认策略，快速失败</td></tr><tr><td><strong>CallerRunsPolicy</strong></td><td>由提交任务的线程执行</td><td>不丢弃任务，降级处理</td></tr><tr><td><strong>DiscardPolicy</strong></td><td>静默丢弃任务</td><td>允许丢失的场景</td></tr><tr><td><strong>DiscardOldestPolicy</strong></td><td>丢弃队列最老的任务，重新提交</td><td>新任务优先级更高</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 自定义拒绝策略示例</span><br><span class="hljs-type">RejectedExecutionHandler</span> <span class="hljs-variable">customHandler</span> <span class="hljs-operator">=</span> (r, executor) -&gt; &#123;<br>    <span class="hljs-comment">// 记录日志</span><br>    log.warn(<span class="hljs-string">&quot;任务被拒绝: &#123;&#125;&quot;</span>, r.toString());<br>    <span class="hljs-comment">// 可选：持久化到数据库/MQ，后续重试</span><br>    saveToDatabase(r);<br>&#125;;<br></code></pre></td></tr></table></figure><hr><h2 id="线程池状态（5种状态）"><a href="#线程池状态（5种状态）" class="headerlink" title="线程池状态（5种状态）"></a>线程池状态（5种状态）</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs scss">┌──────────┐<br>│ RUNNING  │ ← 初始状态，接收新任务，处理队列任务<br>└────┬─────┘<br>     │ <span class="hljs-built_in">shutdown</span>()<br>     ▼<br>┌──────────┐<br>│ SHUTDOWN │ ← 不接收新任务，继续处理队列任务<br>└────┬─────┘<br>     │ 队列为空 &amp;&amp; 工作线程为<span class="hljs-number">0</span><br>     ▼<br>┌──────────┐<br>│ TIDYING  │ ← 所有任务终止，工作线程为<span class="hljs-number">0</span><br>└────┬─────┘<br>     │ <span class="hljs-built_in">terminated</span>() 执行完成<br>     ▼<br>┌──────────────┐<br>│ TERMINATED   │ ← 线程池彻底终止<br>└──────────────┘<br><br>┌──────────┐<br>│ RUNNING  │<br>└────┬─────┘<br>     │ <span class="hljs-built_in">shutdownNow</span>()<br>     ▼<br>┌──────────┐<br>│   <span class="hljs-selector-tag">STOP</span>   │ ← 不接收新任务，中断正在执行的任务，清空队列<br>└────┬─────┘<br>     │ 工作线程为<span class="hljs-number">0</span><br>     ▼<br>┌──────────┐<br>│ TIDYING  │<br>└──────────┘<br></code></pre></td></tr></table></figure><h3 id="状态转换方法"><a href="#状态转换方法" class="headerlink" title="状态转换方法"></a>状态转换方法</h3><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>shutdown()</code></td><td>温和关闭，等待已提交任务完成</td></tr><tr><td><code>shutdownNow()</code></td><td>立即关闭，尝试中断执行中的任务，返回未执行的任务列表</td></tr><tr><td><code>awaitTermination()</code></td><td>阻塞等待线程池终止</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 优雅关闭线程池</span><br>executor.shutdown();<br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (!executor.awaitTermination(<span class="hljs-number">60</span>, TimeUnit.SECONDS)) &#123;<br>        executor.shutdownNow();<br>    &#125;<br>&#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>    executor.shutdownNow();<br>    Thread.currentThread().interrupt();<br>&#125;<br></code></pre></td></tr></table></figure><hr><h2 id="线程池监控"><a href="#线程池监控" class="headerlink" title="线程池监控"></a>线程池监控</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ThreadPoolExecutor</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br><span class="hljs-comment">// 监控指标</span><br>System.out.println(<span class="hljs-string">&quot;核心线程数: &quot;</span> + executor.getCorePoolSize());<br>System.out.println(<span class="hljs-string">&quot;最大线程数: &quot;</span> + executor.getMaximumPoolSize());<br>System.out.println(<span class="hljs-string">&quot;当前线程数: &quot;</span> + executor.getPoolSize());<br>System.out.println(<span class="hljs-string">&quot;活跃线程数: &quot;</span> + executor.getActiveCount());<br>System.out.println(<span class="hljs-string">&quot;队列任务数: &quot;</span> + executor.getQueue().size());<br>System.out.println(<span class="hljs-string">&quot;已完成任务: &quot;</span> + executor.getCompletedTaskCount());<br>System.out.println(<span class="hljs-string">&quot;总任务数: &quot;</span> + executor.getTaskCount());<br></code></pre></td></tr></table></figure><hr><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li><strong>上一篇</strong>：01-线程池简介</li><li><strong>下一篇</strong>：03-线程池类型</li></ul>]]></content>
    
    
    <categories>
      
      <category>Java</category>
      
      <category>并发编程</category>
      
      <category>线程池</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Java</tag>
      
      <tag>并发编程</tag>
      
      <tag>线程池</tag>
      
      <tag>ThreadPoolExecutor</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
