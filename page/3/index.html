<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zmmmmy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":"auto","version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一个来自于 AI+Obsidian 的知识库">
<meta property="og:type" content="website">
<meta property="og:title" content="Zmmmmy&#39;s Blog">
<meta property="og:url" content="https://zmmmmy.github.io/page/3/index.html">
<meta property="og:site_name" content="Zmmmmy&#39;s Blog">
<meta property="og:description" content="一个来自于 AI+Obsidian 的知识库">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ZhiMy">
<meta property="article:tag" content="技术博客">
<meta property="article:tag" content="编程">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zmmmmy.github.io/page/3/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zmmmmy's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zmmmmy's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">今天想和 AI 聊点什么？</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZhiMy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ZhiMy</p>
  <div class="site-description" itemprop="description">一个来自于 AI+Obsidian 的知识库</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Zmmmmy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zmmmmy" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/12/%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/12/%E5%A4%9A%E6%A8%A1%E5%9D%97%E9%A1%B9%E7%9B%AE%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">多模块项目设计</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-12 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-12T00:00:00+08:00">2026-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Maven/" itemprop="url" rel="index"><span itemprop="name">Maven</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Maven-多模块项目设计"><a href="#Maven-多模块项目设计" class="headerlink" title="Maven 多模块项目设计"></a>Maven 多模块项目设计</h1><h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p>Maven 多模块项目是一个<strong>父项目</strong>包含多个<strong>子模块</strong>的结构，通过统一的 POM 文件管理依赖版本、编译配置等，实现代码复用和项目解耦。</p>
<h3 id="为什么使用多模块？"><a href="#为什么使用多模块？" class="headerlink" title="为什么使用多模块？"></a>为什么使用多模块？</h3><table>
<thead>
<tr>
<th>优势</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>依赖管理</strong></td>
<td>统一管理版本号，避免版本冲突</td>
</tr>
<tr>
<td><strong>代码复用</strong></td>
<td>公共代码提取到独立模块</td>
</tr>
<tr>
<td><strong>模块解耦</strong></td>
<td>各模块职责清晰，便于维护</td>
</tr>
<tr>
<td><strong>构建优化</strong></td>
<td>支持增量构建，提高效率</td>
</tr>
<tr>
<td><strong>团队协作</strong></td>
<td>不同团队可独立开发不同模块</td>
</tr>
</tbody></table>
<hr>
<h2 id="典型的多模块结构"><a href="#典型的多模块结构" class="headerlink" title="典型的多模块结构"></a>典型的多模块结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">my-project/                    # 父项目</span><br><span class="line">├── pom.xml                    # 父 POM（聚合和依赖管理）</span><br><span class="line">├── my-common/                 # 公共模块</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/</span><br><span class="line">├── my-service/                # 业务服务模块</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/</span><br><span class="line">├── my-web/                    # Web 模块</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/</span><br><span class="line">└── my-app/                    # 应用启动模块</span><br><span class="line">    ├── pom.xml</span><br><span class="line">    └── src/</span><br></pre></td></tr></table></figure>

<h3 id="模块分类"><a href="#模块分类" class="headerlink" title="模块分类"></a>模块分类</h3><ul>
<li><strong>父模块</strong>：只包含 POM，不含源代码</li>
<li><strong>公共模块</strong>：提供通用工具、常量、基类等</li>
<li><strong>业务模块</strong>：核心业务逻辑</li>
<li><strong>Web&#x2F;API 模块</strong>：对外接口层</li>
<li><strong>启动模块</strong>：应用入口</li>
</ul>
<hr>
<h2 id="父-POM-配置"><a href="#父-POM-配置" class="headerlink" title="父 POM 配置"></a>父 POM 配置</h2><h3 id="1-聚合配置（Aggregation）"><a href="#1-聚合配置（Aggregation）" class="headerlink" title="1. 聚合配置（Aggregation）"></a>1. 聚合配置（Aggregation）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span>  <span class="comment">&lt;!-- 父模块必须是 pom --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 聚合子模块 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-web<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>my-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>作用</strong>：执行 <code>mvn clean install</code> 时，会自动构建所有子模块</p>
<h3 id="2-依赖管理（Dependency-Management）"><a href="#2-依赖管理（Dependency-Management）" class="headerlink" title="2. 依赖管理（Dependency Management）"></a>2. 依赖管理（Dependency Management）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 定义版本，子模块不需要指定版本 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>只声明版本，不引入依赖</li>
<li>子模块可选择是否使用</li>
<li>避免版本冲突</li>
</ul>
<h3 id="3-插件管理（Plugin-Management）"><a href="#3-插件管理（Plugin-Management）" class="headerlink" title="3. 插件管理（Plugin Management）"></a>3. 插件管理（Plugin Management）</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">pluginManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>11<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>11<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pluginManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="子模块-POM-配置"><a href="#子模块-POM-配置" class="headerlink" title="子模块 POM 配置"></a>子模块 POM 配置</h2><h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 继承父模块 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-project<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>&gt;</span>../pom.xml<span class="tag">&lt;/<span class="name">relativePath</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Common Module<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 依赖（版本从父 POM 继承） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不需要指定版本 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="模块间依赖"><a href="#模块间依赖" class="headerlink" title="模块间依赖"></a>模块间依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- my-service 模块依赖 my-common --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 版本从 dependencyManagement 继承 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="设计最佳实践"><a href="#设计最佳实践" class="headerlink" title="设计最佳实践"></a>设计最佳实践</h2><h3 id="1-模块职责划分"><a href="#1-模块职责划分" class="headerlink" title="1. 模块职责划分"></a>1. 模块职责划分</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">my-project/</span><br><span class="line">├── my-common/           # 工具类、常量、基类</span><br><span class="line">├── my-domain/           # 领域模型、实体</span><br><span class="line">├── my-repository/       # 数据访问层</span><br><span class="line">├── my-service/          # 业务逻辑层</span><br><span class="line">├── my-controller/       # 控制层</span><br><span class="line">└── my-app/              # 启动模块</span><br></pre></td></tr></table></figure>

<p><strong>依赖流向</strong>：<code>app → controller → service → repository → domain ← common</code></p>
<h3 id="2-版本管理策略"><a href="#2-版本管理策略" class="headerlink" title="2. 版本管理策略"></a>2. 版本管理策略</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 父 POM 中定义版本变量 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">project.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>11<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 子模块引用 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-避免循环依赖"><a href="#3-避免循环依赖" class="headerlink" title="3. 避免循环依赖"></a>3. 避免循环依赖</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❌ 错误：A → B → A</span><br><span class="line">✅ 正确：A → B → C（单向依赖）</span><br></pre></td></tr></table></figure>

<p><strong>检查命令</strong>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn dependency:tree</span><br></pre></td></tr></table></figure>

<h3 id="4-模块粒度控制"><a href="#4-模块粒度控制" class="headerlink" title="4. 模块粒度控制"></a>4. 模块粒度控制</h3><table>
<thead>
<tr>
<th>粒度</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>粗粒度</strong></td>
<td>构建快，管理简单</td>
<td>模块职责混乱</td>
</tr>
<tr>
<td><strong>细粒度</strong></td>
<td>职责清晰，复用性好</td>
<td>构建复杂，依赖管理困难</td>
</tr>
</tbody></table>
<p><strong>建议</strong>：根据团队规模和项目复杂度平衡</p>
<hr>
<h2 id="常用-Maven-命令"><a href="#常用-Maven-命令" class="headerlink" title="常用 Maven 命令"></a>常用 Maven 命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建所有模块</span></span><br><span class="line">mvn clean install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建特定模块</span></span><br><span class="line">mvn clean install -pl my-common</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建模块及其依赖</span></span><br><span class="line">mvn clean install -pl my-service -am</span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过测试</span></span><br><span class="line">mvn clean install -DskipTests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看依赖树</span></span><br><span class="line">mvn dependency:tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查循环依赖</span></span><br><span class="line">mvn dependency:tree | grep <span class="string">&quot;CIRCULAR&quot;</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战示例：电商系统"><a href="#实战示例：电商系统" class="headerlink" title="实战示例：电商系统"></a>实战示例：电商系统</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ecommerce-platform/</span><br><span class="line">├── pom.xml                    # 父 POM</span><br><span class="line">├── ecommerce-common/          # 通用工具、常量</span><br><span class="line">├── ecommerce-domain/          # 领域模型</span><br><span class="line">├── ecommerce-repository/      # 数据访问</span><br><span class="line">├── ecommerce-service/         # 业务逻辑</span><br><span class="line">├── ecommerce-api/             # REST API</span><br><span class="line">└── ecommerce-app/             # Spring Boot 启动类</span><br></pre></td></tr></table></figure>

<h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ecommerce-app</span><br><span class="line">  ├── ecommerce-api</span><br><span class="line">  │   ├── ecommerce-service</span><br><span class="line">  │   │   ├── ecommerce-repository</span><br><span class="line">  │   │   │   └── ecommerce-domain</span><br><span class="line">  │   │   └── ecommerce-common</span><br><span class="line">  │   └── ecommerce-common</span><br><span class="line">  └── ...</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="Q1-子模块如何访问其他子模块的资源？"><a href="#Q1-子模块如何访问其他子模块的资源？" class="headerlink" title="Q1: 子模块如何访问其他子模块的资源？"></a>Q1: 子模块如何访问其他子模块的资源？</h3><p><strong>A</strong>: 通过依赖声明，不要直接引用文件路径</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ✅ 正确 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>my-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- ❌ 错误 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 不要使用相对路径 --&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="Q2-如何只构建某个模块？"><a href="#Q2-如何只构建某个模块？" class="headerlink" title="Q2: 如何只构建某个模块？"></a>Q2: 如何只构建某个模块？</h3><p><strong>A</strong>: 使用 <code>-pl</code> 参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean install -pl my-service</span><br></pre></td></tr></table></figure>

<h3 id="Q3-子模块版本与父模块不同可以吗？"><a href="#Q3-子模块版本与父模块不同可以吗？" class="headerlink" title="Q3: 子模块版本与父模块不同可以吗？"></a>Q3: 子模块版本与父模块不同可以吗？</h3><p><strong>A</strong>: 不建议。应该保持一致，使用 <code>${project.version}</code></p>
<h3 id="Q4-如何处理模块间的版本冲突？"><a href="#Q4-如何处理模块间的版本冲突？" class="headerlink" title="Q4: 如何处理模块间的版本冲突？"></a>Q4: 如何处理模块间的版本冲突？</h3><p><strong>A</strong>: 在父 POM 的 <code>dependencyManagement</code> 中统一定义</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>要点</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>聚合</strong></td>
<td>父 POM 通过 <code>&lt;modules&gt;</code> 统一构建</td>
</tr>
<tr>
<td><strong>继承</strong></td>
<td>子模块通过 <code>&lt;parent&gt;</code> 继承配置</td>
</tr>
<tr>
<td><strong>依赖管理</strong></td>
<td>使用 <code>&lt;dependencyManagement&gt;</code> 统一版本</td>
</tr>
<tr>
<td><strong>模块划分</strong></td>
<td>按职责清晰划分，避免循环依赖</td>
</tr>
<tr>
<td><strong>版本策略</strong></td>
<td>统一版本号，便于维护和发布</td>
</tr>
</tbody></table>
<hr>
<h2 id="框架类型项目设计（SPI-模式）"><a href="#框架类型项目设计（SPI-模式）" class="headerlink" title="框架类型项目设计（SPI 模式）"></a>框架类型项目设计（SPI 模式）</h2><p>框架类型项目与普通业务系统不同，需要支持<strong>可插拔</strong>和<strong>扩展性</strong>。典型场景：</p>
<ul>
<li>RAG 系统：多种向量数据库（ES、PG、Neo4j、Milvus）</li>
<li>ORM 框架：多种数据库方言（MySQL、PostgreSQL、Oracle）</li>
<li>消息队列：多种实现（Kafka、RabbitMQ、RocketMQ）</li>
</ul>
<h3 id="核心设计思想"><a href="#核心设计思想" class="headerlink" title="核心设计思想"></a>核心设计思想</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      用户应用层                              │</span><br><span class="line">│                  (只依赖 API + 需要的实现)                    │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">                              ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                    rag-core (核心模块)                       │</span><br><span class="line">│              定义接口 + 默认实现 + SPI 加载机制               │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">          ┌───────────────────┼───────────────────┐</span><br><span class="line">          ▼                   ▼                   ▼</span><br><span class="line">┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐</span><br><span class="line">│  rag-store-es   │ │  rag-store-pg   │ │ rag-store-neo4j │</span><br><span class="line">│   (ES 实现)      │ │  (PgVector)     │ │   (Neo4j 实现)   │</span><br><span class="line">└─────────────────┘ └─────────────────┘ └─────────────────┘</span><br></pre></td></tr></table></figure>

<p><strong>关键原则</strong>：</p>
<ul>
<li><strong>依赖倒置</strong>：核心模块定义接口，实现模块依赖核心</li>
<li><strong>按需引入</strong>：用户只引入需要的实现模块</li>
<li><strong>SPI 发现</strong>：运行时自动发现并加载实现</li>
</ul>
<hr>
<h3 id="实战示例：RAG-系统模块结构"><a href="#实战示例：RAG-系统模块结构" class="headerlink" title="实战示例：RAG 系统模块结构"></a>实战示例：RAG 系统模块结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">rag-framework/</span><br><span class="line">├── pom.xml                        # 父 POM</span><br><span class="line">│</span><br><span class="line">├── rag-core/                      # 核心模块</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/main/java/</span><br><span class="line">│       └── com/example/rag/</span><br><span class="line">│           ├── api/               # 核心接口定义</span><br><span class="line">│           │   ├── VectorStore.java</span><br><span class="line">│           │   └── DocumentSplitter.java</span><br><span class="line">│           ├── spi/               # SPI 加载机制</span><br><span class="line">│           │   └── SpiLoader.java</span><br><span class="line">│           └── model/             # 领域模型</span><br><span class="line">│               └── Document.java</span><br><span class="line">│</span><br><span class="line">├── rag-store-elasticsearch/       # ES 实现</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/main/</span><br><span class="line">│       ├── java/.../ElasticsearchVectorStore.java</span><br><span class="line">│       └── resources/META-INF/services/</span><br><span class="line">│           └── com.example.rag.api.VectorStore</span><br><span class="line">│</span><br><span class="line">├── rag-store-pgvector/            # PgVector 实现</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/main/</span><br><span class="line">│       ├── java/.../PgVectorStore.java</span><br><span class="line">│       └── resources/META-INF/services/</span><br><span class="line">│           └── com.example.rag.api.VectorStore</span><br><span class="line">│</span><br><span class="line">├── rag-store-neo4j/               # Neo4j 实现</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag-splitter-fixed/            # 固定长度切片</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag-splitter-sentence/         # 按句子切片</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag-splitter-semantic/         # 语义切片</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">└── rag-spring-boot-starter/       # Spring Boot 自动配置</span><br><span class="line">    └── ...</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="核心模块设计（rag-core）"><a href="#核心模块设计（rag-core）" class="headerlink" title="核心模块设计（rag-core）"></a>核心模块设计（rag-core）</h3><h4 id="1-定义-SPI-接口"><a href="#1-定义-SPI-接口" class="headerlink" title="1. 定义 SPI 接口"></a>1. 定义 SPI 接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// VectorStore.java - 向量存储接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">VectorStore</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** SPI 扩展点标识 */</span></span><br><span class="line">    String <span class="title function_">getType</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">store</span><span class="params">(List&lt;Document&gt; documents)</span>;</span><br><span class="line">    </span><br><span class="line">    List&lt;Document&gt; <span class="title function_">search</span><span class="params">(String query, <span class="type">int</span> topK)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DocumentSplitter.java - 文档切片接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DocumentSplitter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    String <span class="title function_">getType</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    List&lt;Document&gt; <span class="title function_">split</span><span class="params">(Document document)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-SPI-加载器"><a href="#2-SPI-加载器" class="headerlink" title="2. SPI 加载器"></a>2. SPI 加载器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpiLoader</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Map&lt;String, Object&gt;&gt; CACHE = </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">load</span><span class="params">(Class&lt;T&gt; clazz, String type)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; implementations = CACHE.computeIfAbsent(</span><br><span class="line">            clazz, </span><br><span class="line">            k -&gt; loadImplementations(clazz)</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        <span class="type">T</span> <span class="variable">impl</span> <span class="operator">=</span> (T) implementations.get(type);</span><br><span class="line">        <span class="keyword">if</span> (impl == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                <span class="string">&quot;No implementation found for type: &quot;</span> + type</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> impl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; Map&lt;String, Object&gt; <span class="title function_">loadImplementations</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        ServiceLoader&lt;T&gt; loader = ServiceLoader.load(clazz);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (T impl : loader) &#123;</span><br><span class="line">            <span class="comment">// 假设接口有 getType() 方法</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> getType(impl);</span><br><span class="line">            map.put(type, impl);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-核心模块-POM"><a href="#3-核心模块-POM" class="headerlink" title="3. 核心模块 POM"></a>3. 核心模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-core/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>RAG Core<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只放最基础的依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="实现模块设计"><a href="#实现模块设计" class="headerlink" title="实现模块设计"></a>实现模块设计</h3><h4 id="1-ES-实现模块"><a href="#1-ES-实现模块" class="headerlink" title="1. ES 实现模块"></a>1. ES 实现模块</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ElasticsearchVectorStore.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ElasticsearchVectorStore</span> <span class="keyword">implements</span> <span class="title class_">VectorStore</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;elasticsearch&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">store</span><span class="params">(List&lt;Document&gt; documents)</span> &#123;</span><br><span class="line">        <span class="comment">// ES 特定实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Document&gt; <span class="title function_">search</span><span class="params">(String query, <span class="type">int</span> topK)</span> &#123;</span><br><span class="line">        <span class="comment">// ES 特定实现</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-SPI-配置文件"><a href="#2-SPI-配置文件" class="headerlink" title="2. SPI 配置文件"></a>2. SPI 配置文件</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># src/main/resources/META-INF/services/com.example.rag.api.VectorStore</span><br><span class="line">com.example.rag.store.es.ElasticsearchVectorStore</span><br></pre></td></tr></table></figure>

<h4 id="3-实现模块-POM"><a href="#3-实现模块-POM" class="headerlink" title="3. 实现模块 POM"></a>3. 实现模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-store-elasticsearch/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖核心模块 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- ES 特定依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>co.elastic.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="用户使用方式"><a href="#用户使用方式" class="headerlink" title="用户使用方式"></a>用户使用方式</h3><h4 id="按需引入"><a href="#按需引入" class="headerlink" title="按需引入"></a>按需引入</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 用户项目 pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 核心（必需） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 只引入需要的实现 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-pgvector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-splitter-semantic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="代码使用"><a href="#代码使用" class="headerlink" title="代码使用"></a>代码使用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过 SPI 自动加载</span></span><br><span class="line"><span class="type">VectorStore</span> <span class="variable">store</span> <span class="operator">=</span> SpiLoader.load(VectorStore.class, <span class="string">&quot;pgvector&quot;</span>);</span><br><span class="line"><span class="type">DocumentSplitter</span> <span class="variable">splitter</span> <span class="operator">=</span> SpiLoader.load(DocumentSplitter.class, <span class="string">&quot;semantic&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或通过配置文件指定</span></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;rag.store.type&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String storeType;</span><br><span class="line"></span><br><span class="line"><span class="type">VectorStore</span> <span class="variable">store</span> <span class="operator">=</span> SpiLoader.load(VectorStore.class, storeType);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="依赖关系图"><a href="#依赖关系图" class="headerlink" title="依赖关系图"></a>依赖关系图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户项目</span><br><span class="line">    │</span><br><span class="line">    ├── rag-core (必需)</span><br><span class="line">    │</span><br><span class="line">    ├── rag-store-xxx (选一个)</span><br><span class="line">    │   └── rag-core</span><br><span class="line">    │</span><br><span class="line">    └── rag-splitter-xxx (选一个)</span><br><span class="line">        └── rag-core</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>用户<strong>不需要</strong>同时引入所有实现</li>
<li>运行时通过 SPI 自动发现引入的实现</li>
<li>新增实现只需要添加新模块，不修改核心代码</li>
</ul>
<hr>
<h3 id="Spring-Boot-Starter-封装"><a href="#Spring-Boot-Starter-封装" class="headerlink" title="Spring Boot Starter 封装"></a>Spring Boot Starter 封装</h3><p>为了更好的集成体验，可以提供 Starter：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-spring-boot-starter/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RagAutoConfiguration.java</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(RagProperties.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagAutoConfiguration</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> VectorStore <span class="title function_">vectorStore</span><span class="params">(RagProperties props)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SpiLoader.load(VectorStore.class, props.getStore().getType());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> DocumentSplitter <span class="title function_">documentSplitter</span><span class="params">(RagProperties props)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SpiLoader.load(DocumentSplitter.class, props.getSplitter().getType());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户配置 application.yml</span></span><br><span class="line"><span class="attr">rag:</span></span><br><span class="line">  <span class="attr">store:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">pgvector</span></span><br><span class="line">  <span class="attr">splitter:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">semantic</span></span><br><span class="line">    <span class="attr">chunk-size:</span> <span class="number">500</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="框架设计对比"><a href="#框架设计对比" class="headerlink" title="框架设计对比"></a>框架设计对比</h3><table>
<thead>
<tr>
<th>设计模式</th>
<th>适用场景</th>
<th>典型框架</th>
</tr>
</thead>
<tbody><tr>
<td><strong>SPI + 多实现模块</strong></td>
<td>同一接口多种实现</td>
<td>JDBC、SLF4J</td>
</tr>
<tr>
<td><strong>策略模式</strong></td>
<td>算法&#x2F;行为可替换</td>
<td>切片方式、嵌入模型</td>
</tr>
<tr>
<td><strong>模板方法</strong></td>
<td>固定流程可扩展步骤</td>
<td>Spring Template</td>
</tr>
<tr>
<td><strong>工厂模式</strong></td>
<td>对象创建解耦</td>
<td>各种 Factory</td>
</tr>
</tbody></table>
<hr>
<h3 id="扩展性设计要点"><a href="#扩展性设计要点" class="headerlink" title="扩展性设计要点"></a>扩展性设计要点</h3><ol>
<li><strong>接口隔离</strong>：核心接口放在独立模块，无第三方依赖</li>
<li><strong>可选依赖</strong>：使用 <code>&lt;optional&gt;true&lt;/optional&gt;</code> 避免传递依赖</li>
<li><strong>默认实现</strong>：核心模块提供简单默认实现</li>
<li><strong>配置驱动</strong>：通过配置切换实现，而非代码修改</li>
<li><strong>版本兼容</strong>：接口变更需考虑向后兼容</li>
</ol>
<hr>
<h2 id="完整框架结构（含应用层）"><a href="#完整框架结构（含应用层）" class="headerlink" title="完整框架结构（含应用层）"></a>完整框架结构（含应用层）</h2><p>实际项目中，除了可插拔的底层模块，还需要<strong>应用层</strong>来组合这些模块并对外提供服务。</p>
<h3 id="完整模块结构"><a href="#完整模块结构" class="headerlink" title="完整模块结构"></a>完整模块结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rag-framework/</span><br><span class="line">├── pom.xml                        # 父 POM</span><br><span class="line">│</span><br><span class="line">│  ===== 框架层（可独立发布给第三方使用）=====</span><br><span class="line">│</span><br><span class="line">├── rag-core/                      # 核心接口 + SPI</span><br><span class="line">│   └── 无外部依赖，纯接口定义</span><br><span class="line">│</span><br><span class="line">├── rag-stores/                    # 向量存储实现（聚合模块）</span><br><span class="line">│   ├── pom.xml                    # packaging=pom，聚合子模块</span><br><span class="line">│   ├── rag-store-core/            # 🔑 抽象层：基类 + 公共工具</span><br><span class="line">│   ├── rag-store-elasticsearch/   # 继承抽象层</span><br><span class="line">│   ├── rag-store-pgvector/</span><br><span class="line">│   └── rag-store-neo4j/</span><br><span class="line">│</span><br><span class="line">├── rag-splitters/                 # 切片策略实现（聚合模块）</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── rag-splitter-core/         # 🔑 抽象层</span><br><span class="line">│   ├── rag-splitter-fixed/</span><br><span class="line">│   ├── rag-splitter-sentence/</span><br><span class="line">│   └── rag-splitter-semantic/</span><br><span class="line">│</span><br><span class="line">├── rag-embeddings/                # 嵌入模型实现（聚合模块）</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   ├── rag-embedding-core/        # 🔑 抽象层</span><br><span class="line">│   ├── rag-embedding-openai/</span><br><span class="line">│   └── rag-embedding-local/</span><br><span class="line">│</span><br><span class="line">├── rag-spring-boot-starter/       # Spring Boot 自动配置</span><br><span class="line">│</span><br><span class="line">│  ===== 应用层（组合模块，对外提供服务）=====</span><br><span class="line">│</span><br><span class="line">├── rag-service/                   # 业务服务层</span><br><span class="line">├── rag-api/                       # Controller 层（REST API）</span><br><span class="line">└── rag-server/                    # 启动模块</span><br></pre></td></tr></table></figure>

<h3 id="抽象层设计（rag-store-core）"><a href="#抽象层设计（rag-store-core）" class="headerlink" title="抽象层设计（rag-store-core）"></a>抽象层设计（rag-store-core）</h3><p>抽象层的职责：</p>
<ul>
<li><strong>抽象基类</strong>：实现公共逻辑，子类只需实现差异部分</li>
<li><strong>工具类</strong>：连接池管理、序列化、重试机制等</li>
<li><strong>配置基类</strong>：公共配置项</li>
</ul>
<h4 id="依赖关系-1"><a href="#依赖关系-1" class="headerlink" title="依赖关系"></a>依赖关系</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rag-store-elasticsearch</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">rag-store-core (抽象层)</span><br><span class="line">        │</span><br><span class="line">        ▼</span><br><span class="line">   rag-core (接口)</span><br></pre></td></tr></table></figure>

<h4 id="抽象层代码示例"><a href="#抽象层代码示例" class="headerlink" title="抽象层代码示例"></a>抽象层代码示例</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rag-store-core 模块</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * VectorStore 抽象基类</span></span><br><span class="line"><span class="comment"> * 实现公共逻辑，子类只需关注特定数据库操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractVectorStore</span> <span class="keyword">implements</span> <span class="title class_">VectorStore</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> VectorStoreConfig config;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractVectorStore</span><span class="params">(VectorStoreConfig config)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">store</span><span class="params">(List&lt;Document&gt; documents)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 公共逻辑：参数校验</span></span><br><span class="line">        validateDocuments(documents);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 公共逻辑：批量处理</span></span><br><span class="line">        List&lt;List&lt;Document&gt;&gt; batches = partition(documents, config.getBatchSize());</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (List&lt;Document&gt; batch : batches) &#123;</span><br><span class="line">            <span class="comment">// 3. 调用子类实现的具体存储逻辑</span></span><br><span class="line">            doStore(batch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Document&gt; <span class="title function_">search</span><span class="params">(String query, <span class="type">int</span> topK)</span> &#123;</span><br><span class="line">        <span class="comment">// 公共逻辑：参数校验</span></span><br><span class="line">        <span class="keyword">if</span> (topK &lt;= <span class="number">0</span> || topK &gt; config.getMaxTopK()) &#123;</span><br><span class="line">            topK = config.getDefaultTopK();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用子类实现</span></span><br><span class="line">        <span class="keyword">return</span> doSearch(query, topK);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===== 子类必须实现的抽象方法 =====</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 具体的存储实现 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">doStore</span><span class="params">(List&lt;Document&gt; documents)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 具体的搜索实现 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Document&gt; <span class="title function_">doSearch</span><span class="params">(String query, <span class="type">int</span> topK)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ===== 公共工具方法 =====</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">validateDocuments</span><span class="params">(List&lt;Document&gt; docs)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (docs == <span class="literal">null</span> || docs.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Documents cannot be empty&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; List&lt;List&lt;T&gt;&gt; <span class="title function_">partition</span><span class="params">(List&lt;T&gt; list, <span class="type">int</span> size)</span> &#123;</span><br><span class="line">        <span class="comment">// 分批工具方法</span></span><br><span class="line">        List&lt;List&lt;T&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i += size) &#123;</span><br><span class="line">            result.add(list.subList(i, Math.min(i + size, list.size())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 公共配置基类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VectorStoreConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">batchSize</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">defaultTopK</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">maxTopK</span> <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">connectTimeout</span> <span class="operator">=</span> <span class="number">5000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">readTimeout</span> <span class="operator">=</span> <span class="number">30000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="具体实现（继承抽象层）"><a href="#具体实现（继承抽象层）" class="headerlink" title="具体实现（继承抽象层）"></a>具体实现（继承抽象层）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rag-store-pgvector 模块</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PgVectorStore</span> <span class="keyword">extends</span> <span class="title class_">AbstractVectorStore</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PgVectorStore</span><span class="params">(PgVectorConfig config, JdbcTemplate jdbcTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(config);  <span class="comment">// 调用父类构造器</span></span><br><span class="line">        <span class="built_in">this</span>.jdbcTemplate = jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;pgvector&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doStore</span><span class="params">(List&lt;Document&gt; documents)</span> &#123;</span><br><span class="line">        <span class="comment">// 只需实现 PgVector 特定的存储逻辑</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;INSERT INTO documents (content, embedding) VALUES (?, ?::vector)&quot;</span>;</span><br><span class="line">        jdbcTemplate.batchUpdate(sql, documents, documents.size(), </span><br><span class="line">            (ps, doc) -&gt; &#123;</span><br><span class="line">                ps.setString(<span class="number">1</span>, doc.getContent());</span><br><span class="line">                ps.setArray(<span class="number">2</span>, toSqlArray(doc.getEmbedding()));</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> List&lt;Document&gt; <span class="title function_">doSearch</span><span class="params">(String query, <span class="type">int</span> topK)</span> &#123;</span><br><span class="line">        <span class="comment">// 只需实现 PgVector 特定的搜索逻辑</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            SELECT content, 1 - (embedding &lt;=&gt; ?::vector) as score</span></span><br><span class="line"><span class="string">            FROM documents</span></span><br><span class="line"><span class="string">            ORDER BY embedding &lt;=&gt; ?::vector</span></span><br><span class="line"><span class="string">            LIMIT ?</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(sql, documentRowMapper, queryVector, queryVector, topK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承公共配置，添加特定配置</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PgVectorConfig</span> <span class="keyword">extends</span> <span class="title class_">VectorStoreConfig</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">tableName</span> <span class="operator">=</span> <span class="string">&quot;documents&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">dimension</span> <span class="operator">=</span> <span class="number">1536</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">indexType</span> <span class="operator">=</span> <span class="string">&quot;ivfflat&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="聚合模块-POM-示例"><a href="#聚合模块-POM-示例" class="headerlink" title="聚合模块 POM 示例"></a>聚合模块 POM 示例</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-stores/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-stores<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>RAG Vector Stores<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-store-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span>        <span class="comment">&lt;!-- 抽象层优先构建 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-store-elasticsearch<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-store-pgvector<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-store-neo4j<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-stores/rag-store-core/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-stores<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只依赖核心接口 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-stores/rag-store-pgvector/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-stores<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-pgvector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖抽象层（会传递 rag-core） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- PgVector 特定依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.pgvector<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pgvector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="父-POM-聚合配置"><a href="#父-POM-聚合配置" class="headerlink" title="父 POM 聚合配置"></a>父 POM 聚合配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 根 pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-stores<span class="tag">&lt;/<span class="name">module</span>&gt;</span>       <span class="comment">&lt;!-- 聚合目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-splitters<span class="tag">&lt;/<span class="name">module</span>&gt;</span>    <span class="comment">&lt;!-- 聚合目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-embeddings<span class="tag">&lt;/<span class="name">module</span>&gt;</span>   <span class="comment">&lt;!-- 聚合目录 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-spring-boot-starter<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-service<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-api<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag-server<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="模块依赖全景图"><a href="#模块依赖全景图" class="headerlink" title="模块依赖全景图"></a>模块依赖全景图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">         ┌─────────────────────────────────┐</span><br><span class="line">         │         rag-server              │</span><br><span class="line">         │   (启动类 + 配置 + 打包)         │</span><br><span class="line">         └─────────────────────────────────┘</span><br><span class="line">                         │</span><br><span class="line">         ┌───────────────┼───────────────┐</span><br><span class="line">         ▼               ▼               ▼</span><br><span class="line">┌──────────────┐  ┌──────────────┐  ┌──────────────┐</span><br><span class="line">│   rag-api    │  │rag-store-pg  │  │rag-splitter- │</span><br><span class="line">│ (Controller) │  │  (选择的实现) │  │  semantic    │</span><br><span class="line">└──────────────┘  └──────────────┘  └──────────────┘</span><br><span class="line">         │               │               │</span><br><span class="line">         ▼               ▼               ▼</span><br><span class="line">┌──────────────┐        │               │</span><br><span class="line">│ rag-service  │        │               │</span><br><span class="line">│  (业务逻辑)   │◄───────┴───────────────┘</span><br><span class="line">└──────────────┘</span><br><span class="line">         │</span><br><span class="line">         ▼</span><br><span class="line">┌──────────────┐</span><br><span class="line">│   rag-core   │</span><br><span class="line">│  (核心接口)   │</span><br><span class="line">└──────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Service-层设计（rag-service）"><a href="#Service-层设计（rag-service）" class="headerlink" title="Service 层设计（rag-service）"></a>Service 层设计（rag-service）</h3><p>Service 层负责<strong>组合</strong>底层组件，实现具体业务逻辑。</p>
<h4 id="模块-POM"><a href="#模块-POM" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-service/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖核心模块 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Spring 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Service-实现"><a href="#Service-实现" class="headerlink" title="Service 实现"></a>Service 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RagService.java - 组合底层组件</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VectorStore vectorStore;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DocumentSplitter splitter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EmbeddingModel embeddingModel;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通过构造器注入（具体实现由 Starter 自动配置）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RagService</span><span class="params">(VectorStore vectorStore, </span></span><br><span class="line"><span class="params">                      DocumentSplitter splitter,</span></span><br><span class="line"><span class="params">                      EmbeddingModel embeddingModel)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.vectorStore = vectorStore;</span><br><span class="line">        <span class="built_in">this</span>.splitter = splitter;</span><br><span class="line">        <span class="built_in">this</span>.embeddingModel = embeddingModel;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档入库流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ingest</span><span class="params">(Document document)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 切片</span></span><br><span class="line">        List&lt;Document&gt; chunks = splitter.split(document);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 生成向量</span></span><br><span class="line">        <span class="keyword">for</span> (Document chunk : chunks) &#123;</span><br><span class="line">            <span class="type">float</span>[] embedding = embeddingModel.embed(chunk.getContent());</span><br><span class="line">            chunk.setEmbedding(embedding);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 存储</span></span><br><span class="line">        vectorStore.store(chunks);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Document&gt; <span class="title function_">retrieve</span><span class="params">(String query, <span class="type">int</span> topK)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> vectorStore.search(query, topK);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RAG 完整流程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">chat</span><span class="params">(String question)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 检索相关文档</span></span><br><span class="line">        List&lt;Document&gt; contexts = retrieve(question, <span class="number">5</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 构建 Prompt</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">prompt</span> <span class="operator">=</span> buildPrompt(question, contexts);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 调用 LLM（这里可以再抽象一个 LLM 接口）</span></span><br><span class="line">        <span class="keyword">return</span> llmClient.generate(prompt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="Controller-层设计（rag-api）"><a href="#Controller-层设计（rag-api）" class="headerlink" title="Controller 层设计（rag-api）"></a>Controller 层设计（rag-api）</h3><p>Controller 层负责<strong>对外暴露 HTTP 接口</strong>。</p>
<h4 id="模块-POM-1"><a href="#模块-POM-1" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-api/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 依赖 service 层 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-service<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Web 依赖 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="Controller-实现"><a href="#Controller-实现" class="headerlink" title="Controller 实现"></a>Controller 实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RagController.java</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/rag&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RagService ragService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RagController</span><span class="params">(RagService ragService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.ragService = ragService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文档入库</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/ingest&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title function_">ingest</span><span class="params">(<span class="meta">@RequestBody</span> IngestRequest request)</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>(request.getContent(), request.getMetadata());</span><br><span class="line">        ragService.ingest(doc);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok().build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检索</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/retrieve&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;DocumentVO&gt;&gt; <span class="title function_">retrieve</span><span class="params">(</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam</span> String query,</span></span><br><span class="line"><span class="params">            <span class="meta">@RequestParam(defaultValue = &quot;5&quot;)</span> <span class="type">int</span> topK)</span> &#123;</span><br><span class="line">        List&lt;Document&gt; docs = ragService.retrieve(query, topK);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(DocumentVO.from(docs));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 问答</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/chat&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;ChatResponse&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestBody</span> ChatRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">answer</span> <span class="operator">=</span> ragService.chat(request.getQuestion());</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(<span class="keyword">new</span> <span class="title class_">ChatResponse</span>(answer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DTO-定义"><a href="#DTO-定义" class="headerlink" title="DTO 定义"></a>DTO 定义</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 请求/响应对象放在 api 模块</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">IngestRequest</span><span class="params">(String content, Map&lt;String, Object&gt; metadata)</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">ChatRequest</span><span class="params">(String question)</span> &#123;&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">record</span> <span class="title class_">ChatResponse</span><span class="params">(String answer)</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="启动模块设计（rag-server）"><a href="#启动模块设计（rag-server）" class="headerlink" title="启动模块设计（rag-server）"></a>启动模块设计（rag-server）</h3><p>启动模块负责<strong>选择具体实现 + 打包部署</strong>。</p>
<h4 id="模块-POM-2"><a href="#模块-POM-2" class="headerlink" title="模块 POM"></a>模块 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag-server/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- API 层（包含 Controller） --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 自动配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- ===== 选择具体实现 ===== --&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 向量存储：选择 PgVector --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-store-pgvector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 切片方式：选择语义切片 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag-splitter-semantic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 打包成可执行 JAR --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RagServerApplication.java</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RagServerApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(RagServerApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rag:</span></span><br><span class="line">  <span class="attr">store:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">pgvector</span></span><br><span class="line">    <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:postgresql://localhost:5432/rag</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">secret</span></span><br><span class="line">  <span class="attr">splitter:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">semantic</span></span><br><span class="line">    <span class="attr">chunk-size:</span> <span class="number">500</span></span><br><span class="line">    <span class="attr">overlap:</span> <span class="number">50</span></span><br><span class="line">  <span class="attr">embedding:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">openai</span></span><br><span class="line">    <span class="attr">api-key:</span> <span class="string">$&#123;OPENAI_API_KEY&#125;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="多种部署方式"><a href="#多种部署方式" class="headerlink" title="多种部署方式"></a>多种部署方式</h3><p>通过不同的 server 模块，可以灵活组合：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rag-server-pg/          # PgVector + 语义切片</span><br><span class="line">├── pom.xml             # 引入 pgvector + semantic</span><br><span class="line">└── application.yml</span><br><span class="line"></span><br><span class="line">rag-server-es/          # ES + 固定切片</span><br><span class="line">├── pom.xml             # 引入 elasticsearch + fixed</span><br><span class="line">└── application.yml</span><br><span class="line"></span><br><span class="line">rag-server-all/         # 全部实现（通过配置切换）</span><br><span class="line">├── pom.xml             # 引入所有实现</span><br><span class="line">└── application.yml     # 配置指定使用哪个</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="模块职责总结"><a href="#模块职责总结" class="headerlink" title="模块职责总结"></a>模块职责总结</h3><table>
<thead>
<tr>
<th>模块</th>
<th>职责</th>
<th>依赖</th>
</tr>
</thead>
<tbody><tr>
<td><strong>rag-core</strong></td>
<td>核心接口定义</td>
<td>无</td>
</tr>
<tr>
<td><strong>rag-store-xxx</strong></td>
<td>向量存储实现</td>
<td>core</td>
</tr>
<tr>
<td><strong>rag-splitter-xxx</strong></td>
<td>切片策略实现</td>
<td>core</td>
</tr>
<tr>
<td><strong>rag-spring-boot-starter</strong></td>
<td>自动配置</td>
<td>core</td>
</tr>
<tr>
<td><strong>rag-service</strong></td>
<td>业务逻辑，组合组件</td>
<td>core</td>
</tr>
<tr>
<td><strong>rag-api</strong></td>
<td>REST Controller</td>
<td>service</td>
</tr>
<tr>
<td><strong>rag-server</strong></td>
<td>启动模块，选择实现</td>
<td>api + starter + 具体实现</td>
</tr>
</tbody></table>
<h3 id="框架使用者-vs-框架开发者"><a href="#框架使用者-vs-框架开发者" class="headerlink" title="框架使用者 vs 框架开发者"></a>框架使用者 vs 框架开发者</h3><table>
<thead>
<tr>
<th>角色</th>
<th>使用模块</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>框架使用者</strong></td>
<td>core + starter + 实现模块</td>
<td>集成到自己项目</td>
</tr>
<tr>
<td><strong>框架开发者</strong></td>
<td>全部模块</td>
<td>开发和维护框架</td>
</tr>
<tr>
<td><strong>独立部署</strong></td>
<td>server</td>
<td>直接运行服务</td>
</tr>
</tbody></table>
<hr>
<h2 id="简化三层结构（推荐）"><a href="#简化三层结构（推荐）" class="headerlink" title="简化三层结构（推荐）"></a>简化三层结构（推荐）</h2><p>对于中小型项目，可以采用更简洁的三层结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rag4j/</span><br><span class="line">├── pom.xml                       # 父 POM</span><br><span class="line">├── rag4j-framework/              # 框架层 - 核心抽象与通用能力</span><br><span class="line">├── rag4j-project/                # 实现层 - 具体技术实现</span><br><span class="line">├── rag4j-app/                    # 应用层 - Web服务入口</span><br><span class="line">└── test/                         # 测试模块</span><br></pre></td></tr></table></figure>

<h3 id="各层详细结构"><a href="#各层详细结构" class="headerlink" title="各层详细结构"></a>各层详细结构</h3><h4 id="1-框架层（rag4j-framework）"><a href="#1-框架层（rag4j-framework）" class="headerlink" title="1. 框架层（rag4j-framework）"></a>1. 框架层（rag4j-framework）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rag4j-framework/</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src/main/java/com/example/rag4j/framework/</span><br><span class="line">    │</span><br><span class="line">    ├── core/                     # 核心接口定义</span><br><span class="line">    │   ├── VectorStore.java</span><br><span class="line">    │   ├── DocumentSplitter.java</span><br><span class="line">    │   ├── EmbeddingModel.java</span><br><span class="line">    │   └── Document.java</span><br><span class="line">    │</span><br><span class="line">    ├── store/                    # 向量存储抽象</span><br><span class="line">    │   ├── AbstractVectorStore.java</span><br><span class="line">    │   └── VectorStoreConfig.java</span><br><span class="line">    │</span><br><span class="line">    ├── splitter/                 # 切片器抽象</span><br><span class="line">    │   ├── AbstractSplitter.java</span><br><span class="line">    │   └── SplitterConfig.java</span><br><span class="line">    │</span><br><span class="line">    ├── embedding/                # 嵌入模型抽象</span><br><span class="line">    │   └── AbstractEmbeddingModel.java</span><br><span class="line">    │</span><br><span class="line">    ├── spi/                      # SPI 加载机制</span><br><span class="line">    │   └── SpiLoader.java</span><br><span class="line">    │</span><br><span class="line">    └── util/                     # 通用工具</span><br><span class="line">        ├── RetryUtil.java</span><br><span class="line">        └── BatchUtil.java</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：纯抽象，无第三方依赖（或最小依赖）</p>
<h4 id="2-实现层（rag4j-project）"><a href="#2-实现层（rag4j-project）" class="headerlink" title="2. 实现层（rag4j-project）"></a>2. 实现层（rag4j-project）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rag4j-project/</span><br><span class="line">├── pom.xml                       # 聚合模块</span><br><span class="line">│</span><br><span class="line">├── rag4j-store-pgvector/         # PgVector 实现</span><br><span class="line">│   ├── pom.xml</span><br><span class="line">│   └── src/.../PgVectorStore.java</span><br><span class="line">│</span><br><span class="line">├── rag4j-store-elasticsearch/    # ES 实现</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag4j-store-neo4j/            # Neo4j 实现</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag4j-splitter-fixed/         # 固定切片</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag4j-splitter-semantic/      # 语义切片</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">├── rag4j-embedding-openai/       # OpenAI 嵌入</span><br><span class="line">│   └── ...</span><br><span class="line">│</span><br><span class="line">└── rag4j-spring-boot-starter/    # Spring Boot 自动配置</span><br><span class="line">    └── ...</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：每个实现独立模块，按需引入</p>
<h4 id="3-应用层（rag4j-app）"><a href="#3-应用层（rag4j-app）" class="headerlink" title="3. 应用层（rag4j-app）"></a>3. 应用层（rag4j-app）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rag4j-app/</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src/main/</span><br><span class="line">    ├── java/com/example/rag4j/app/</span><br><span class="line">    │   ├── Rag4jApplication.java     # 启动类</span><br><span class="line">    │   ├── config/                   # 配置类</span><br><span class="line">    │   │   └── Rag4jConfig.java</span><br><span class="line">    │   ├── service/                  # 业务服务</span><br><span class="line">    │   │   └── RagService.java</span><br><span class="line">    │   ├── controller/               # REST API</span><br><span class="line">    │   │   └── RagController.java</span><br><span class="line">    │   └── dto/                      # 请求/响应对象</span><br><span class="line">    │       ├── ChatRequest.java</span><br><span class="line">    │       └── ChatResponse.java</span><br><span class="line">    └── resources/</span><br><span class="line">        └── application.yml</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：组合框架层和实现层，对外提供服务</p>
<hr>
<h3 id="依赖关系-2"><a href="#依赖关系-2" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                      rag4j-app                               │</span><br><span class="line">│            (Controller + Service + 启动配置)                  │</span><br><span class="line">│                                                              │</span><br><span class="line">│   依赖: framework + 选择的实现模块 + starter                   │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br><span class="line">                              │</span><br><span class="line">          ┌───────────────────┼───────────────────┐</span><br><span class="line">          ▼                   ▼                   ▼</span><br><span class="line">┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐</span><br><span class="line">│ rag4j-store-pg  │ │rag4j-splitter-  │ │ rag4j-embedding │</span><br><span class="line">│                 │ │   semantic      │ │    -openai      │</span><br><span class="line">└─────────────────┘ └─────────────────┘ └─────────────────┘</span><br><span class="line">          │                   │                   │</span><br><span class="line">          └───────────────────┼───────────────────┘</span><br><span class="line">                              ▼</span><br><span class="line">              ┌───────────────────────────┐</span><br><span class="line">              │      rag4j-framework      │</span><br><span class="line">              │   (接口 + 抽象类 + SPI)    │</span><br><span class="line">              └───────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="POM-配置示例"><a href="#POM-配置示例" class="headerlink" title="POM 配置示例"></a>POM 配置示例</h3><h4 id="父-POM"><a href="#父-POM" class="headerlink" title="父 POM"></a>父 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag4j/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag4j-framework<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag4j-project<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>rag4j-app<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>test<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 内部模块版本管理 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 其他模块... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="应用层-POM"><a href="#应用层-POM" class="headerlink" title="应用层 POM"></a>应用层 POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- rag4j-app/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-app<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 框架层 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-framework<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 选择具体实现 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-store-pgvector<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-splitter-semantic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-embedding-openai<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 自动配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rag4j-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Spring Boot --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="两种结构对比"><a href="#两种结构对比" class="headerlink" title="两种结构对比"></a>两种结构对比</h3><table>
<thead>
<tr>
<th>对比项</th>
<th>细粒度结构</th>
<th>三层简化结构</th>
</tr>
</thead>
<tbody><tr>
<td><strong>模块数量</strong></td>
<td>多（10+）</td>
<td>少（3-4 + 实现）</td>
</tr>
<tr>
<td><strong>适用规模</strong></td>
<td>大型框架</td>
<td>中小型项目</td>
</tr>
<tr>
<td><strong>灵活性</strong></td>
<td>高</td>
<td>适中</td>
</tr>
<tr>
<td><strong>维护成本</strong></td>
<td>高</td>
<td>低</td>
</tr>
<tr>
<td><strong>学习曲线</strong></td>
<td>陡</td>
<td>平缓</td>
</tr>
<tr>
<td><strong>典型案例</strong></td>
<td>Spring Framework</td>
<td>业务系统</td>
</tr>
</tbody></table>
<p><strong>建议</strong>：</p>
<ul>
<li><strong>对外发布的框架</strong> → 细粒度结构，方便用户按需引入</li>
<li><strong>内部项目&#x2F;业务系统</strong> → 三层简化结构，开发效率高</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/12/%E5%B1%9E%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%81%8D%E5%8E%86%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/12/%E5%B1%9E%E6%80%A7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E9%81%8D%E5%8E%86%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">属性数据结构遍历详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-12 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-12T00:00:00+08:00">2026-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="属性数据结构遍历详解"><a href="#属性数据结构遍历详解" class="headerlink" title="属性数据结构遍历详解"></a>属性数据结构遍历详解</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>属性数据结构</strong> 是指具有特定属性或特征的数据结构，如有序性、层级性、连通性等。遍历是访问数据结构中所有元素的基本操作，不同的数据结构有不同的遍历策略。</p>
<blockquote>
<p><strong>💡 提示: 核心思想</strong><br>遍历的本质是：<strong>按照数据结构的特性，用合适的方式访问每个元素一次，且仅一次</strong>。</p>
</blockquote>
<hr>
<h2 id="一、数组遍历"><a href="#一、数组遍历" class="headerlink" title="一、数组遍历"></a>一、数组遍历</h2><h3 id="1-1-基本特性"><a href="#1-1-基本特性" class="headerlink" title="1.1 基本特性"></a>1.1 基本特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储方式</strong></td>
<td>连续内存，随机访问</td>
</tr>
<tr>
<td><strong>访问复杂度</strong></td>
<td>O(1)</td>
</tr>
<tr>
<td><strong>遍历复杂度</strong></td>
<td>O(n)</td>
</tr>
<tr>
<td><strong>属性</strong></td>
<td>有序、固定大小、可重复</td>
</tr>
</tbody></table>
<h3 id="1-2-遍历思路"><a href="#1-2-遍历思路" class="headerlink" title="1.2 遍历思路"></a>1.2 遍历思路</h3><p>数组遍历的核心思路是<strong>线性扫描</strong>：从第一个元素开始，依次访问每个元素，直到最后一个元素。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 初始化指针/索引 i = 0</span><br><span class="line">2. 检查 i &lt; 数组长度</span><br><span class="line">3. 访问 array[i]</span><br><span class="line">4. i++</span><br><span class="line">5. 回到步骤2</span><br></pre></td></tr></table></figure>

<h3 id="1-3-实现方式"><a href="#1-3-实现方式" class="headerlink" title="1.3 实现方式"></a>1.3 实现方式</h3><h4 id="方式1：传统-for-循环（最直接）"><a href="#方式1：传统-for-循环（最直接）" class="headerlink" title="方式1：传统 for 循环（最直接）"></a>方式1：传统 for 循环（最直接）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要索引值，需要提前知道数组大小</span></span><br><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    System.out.println(arr[i]);  <span class="comment">// 访问元素</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>显式控制索引，可以随意访问任何位置</li>
<li>适合需要索引的场景（如修改元素、计算位置等）</li>
</ul>
<h4 id="方式2：增强-for-循环（简洁）"><a href="#方式2：增强-for-循环（简洁）" class="headerlink" title="方式2：增强 for 循环（简洁）"></a>方式2：增强 for 循环（简洁）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：只需要元素值，不需要索引</span></span><br><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : arr) &#123;</span><br><span class="line">    System.out.println(num);  <span class="comment">// 访问元素</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>隐藏索引细节，代码更简洁</li>
<li>本质上还是顺序访问</li>
<li>不能修改数组元素（对基本类型）</li>
</ul>
<h4 id="方式3：迭代器遍历（通用）"><a href="#方式3：迭代器遍历（通用）" class="headerlink" title="方式3：迭代器遍历（通用）"></a>方式3：迭代器遍历（通用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要在遍历中删除元素</span></span><br><span class="line">List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">num</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">3</span>) &#123;</span><br><span class="line">        iterator.remove();  <span class="comment">// 安全删除</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>迭代器维护遍历状态</li>
<li>支持在遍历中安全删除</li>
<li>适合集合框架</li>
</ul>
<h4 id="方式4：流式遍历（函数式）"><a href="#方式4：流式遍历（函数式）" class="headerlink" title="方式4：流式遍历（函数式）"></a>方式4：流式遍历（函数式）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要函数式编程风格</span></span><br><span class="line"><span class="type">int</span>[] arr = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line"></span><br><span class="line">Arrays.stream(arr)</span><br><span class="line">    .forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者带索引</span></span><br><span class="line">IntStream.range(<span class="number">0</span>, arr.length)</span><br><span class="line">    .forEach(i -&gt; System.out.println(arr[i]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>声明式编程，表达意图清晰</li>
<li>支持链式操作和函数组合</li>
<li>可能有额外开销</li>
</ul>
<h3 id="1-4-二维数组遍历"><a href="#1-4-二维数组遍历" class="headerlink" title="1.4 二维数组遍历"></a>1.4 二维数组遍历</h3><h4 id="按行遍历（最常用）"><a href="#按行遍历（最常用）" class="headerlink" title="按行遍历（最常用）"></a>按行遍历（最常用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[][] matrix = &#123;</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;,</span><br><span class="line">    &#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>&#125;,</span><br><span class="line">    &#123;<span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 思路：外层循环遍历行，内层循环遍历列</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; matrix.length; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; matrix[i].length; j++) &#123;</span><br><span class="line">        System.out.println(matrix[i][j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问顺序：1 2 3 4 5 6 7 8 9</span></span><br><span class="line"><span class="comment">// 时间复杂度：O(m*n)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>外层控制行，内层控制列</li>
<li>按行优先顺序访问（cache 友好）</li>
<li>适合大多数矩阵操作</li>
</ul>
<h4 id="按列遍历"><a href="#按列遍历" class="headerlink" title="按列遍历"></a>按列遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 思路：外层循环遍历列，内层循环遍历行</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; matrix[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; matrix.length; i++) &#123;</span><br><span class="line">        System.out.println(matrix[i][j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问顺序：1 4 7 2 5 8 3 6 9</span></span><br><span class="line"><span class="comment">// 时间复杂度：O(m*n)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>适合需要按列处理的场景</li>
<li>可能导致 cache miss（不如按行遍历高效）</li>
</ul>
<h4 id="对角线遍历"><a href="#对角线遍历" class="headerlink" title="对角线遍历"></a>对角线遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 思路：按对角线方向遍历</span></span><br><span class="line"><span class="comment">// 第一条对角线：(0,0)</span></span><br><span class="line"><span class="comment">// 第二条对角线：(0,1), (1,0)</span></span><br><span class="line"><span class="comment">// 第三条对角线：(0,2), (1,1), (2,0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">diag</span> <span class="operator">=</span> <span class="number">0</span>; diag &lt; matrix.length + matrix[<span class="number">0</span>].length - <span class="number">1</span>; diag++) &#123;</span><br><span class="line">    <span class="comment">// 对于第 diag 条对角线</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">startRow</span> <span class="operator">=</span> Math.max(<span class="number">0</span>, diag - matrix[<span class="number">0</span>].length + <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">endRow</span> <span class="operator">=</span> Math.min(diag, matrix.length - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> startRow; i &lt;= endRow; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> diag - i;</span><br><span class="line">        System.out.println(matrix[i][j]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 访问顺序：1 2 4 3 5 7 6 8 9</span></span><br><span class="line"><span class="comment">// 时间复杂度：O(m*n)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>对角线编号：i + j &#x3D; diag</li>
<li>需要计算每条对角线的起点和终点</li>
<li>适合特定的矩阵问题</li>
</ul>
<h3 id="1-5-遍历变种"><a href="#1-5-遍历变种" class="headerlink" title="1.5 遍历变种"></a>1.5 遍历变种</h3><h4 id="反向遍历"><a href="#反向遍历" class="headerlink" title="反向遍历"></a>反向遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从后往前遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> arr.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    System.out.println(arr[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适用场景：</span></span><br><span class="line"><span class="comment">// 1. 需要从后往前处理</span></span><br><span class="line"><span class="comment">// 2. 删除元素时避免索引混乱</span></span><br></pre></td></tr></table></figure>

<h4 id="跳跃遍历"><a href="#跳跃遍历" class="headerlink" title="跳跃遍历"></a>跳跃遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每隔 k 个元素访问一个</span></span><br><span class="line"><span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i += k) &#123;</span><br><span class="line">    System.out.println(arr[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 适用场景：</span></span><br><span class="line"><span class="comment">// 1. 采样</span></span><br><span class="line"><span class="comment">// 2. 步长遍历</span></span><br></pre></td></tr></table></figure>

<h4 id="条件遍历"><a href="#条件遍历" class="headerlink" title="条件遍历"></a>条件遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只遍历满足条件的元素</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (arr[i] &gt; <span class="number">5</span>) &#123;</span><br><span class="line">        System.out.println(arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或使用流</span></span><br><span class="line">Arrays.stream(arr)</span><br><span class="line">    .filter(x -&gt; x &gt; <span class="number">5</span>)</span><br><span class="line">    .forEach(System.out::println);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、链表遍历"><a href="#二、链表遍历" class="headerlink" title="二、链表遍历"></a>二、链表遍历</h2><h3 id="2-1-基本特性"><a href="#2-1-基本特性" class="headerlink" title="2.1 基本特性"></a>2.1 基本特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储方式</strong></td>
<td>离散内存，通过指针连接</td>
</tr>
<tr>
<td><strong>访问复杂度</strong></td>
<td>O(n)</td>
</tr>
<tr>
<td><strong>遍历复杂度</strong></td>
<td>O(n)</td>
</tr>
<tr>
<td><strong>属性</strong></td>
<td>有序、动态大小、可重复</td>
</tr>
</tbody></table>
<h3 id="2-2-链表节点定义"><a href="#2-2-链表节点定义" class="headerlink" title="2.2 链表节点定义"></a>2.2 链表节点定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;           <span class="comment">// 数据</span></span><br><span class="line">    ListNode next;     <span class="comment">// 指向下一个节点</span></span><br><span class="line">    </span><br><span class="line">    ListNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">        <span class="built_in">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-遍历思路"><a href="#2-3-遍历思路" class="headerlink" title="2.3 遍历思路"></a>2.3 遍历思路</h3><p>链表遍历的核心思路是<strong>指针跟踪</strong>：从头节点开始，通过 next 指针逐个访问每个节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 初始化指针 current = head</span><br><span class="line">2. 检查 current != null</span><br><span class="line">3. 访问 current.val</span><br><span class="line">4. current = current.next</span><br><span class="line">5. 回到步骤2</span><br></pre></td></tr></table></figure>

<h3 id="2-4-实现方式"><a href="#2-4-实现方式" class="headerlink" title="2.4 实现方式"></a>2.4 实现方式</h3><h4 id="方式1：while-循环（最常用）"><a href="#方式1：while-循环（最常用）" class="headerlink" title="方式1：while 循环（最常用）"></a>方式1：while 循环（最常用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要逐个访问节点</span></span><br><span class="line"><span class="type">ListNode</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">1</span>);</span><br><span class="line">head.next = <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">2</span>);</span><br><span class="line">head.next.next = <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">    System.out.println(current.val);  <span class="comment">// 访问节点</span></span><br><span class="line">    current = current.next;            <span class="comment">// 移动指针</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>最直接的遍历方式</li>
<li>通过 null 检查确定遍历结束</li>
<li>不修改链表结构</li>
</ul>
<h4 id="方式2：递归遍历"><a href="#方式2：递归遍历" class="headerlink" title="方式2：递归遍历"></a>方式2：递归遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要递归处理或反向遍历</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">traverse</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;  <span class="comment">// 递归终止条件</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 前序处理</span></span><br><span class="line">    traverse(node.next);               <span class="comment">// 递归访问下一个</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">traverse(head);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(n)（递归栈）</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>递归天然适合链表结构</li>
<li>空间复杂度较高（栈深度）</li>
<li>适合需要反向处理的场景</li>
</ul>
<h4 id="方式3：反向遍历（递归）"><a href="#方式3：反向遍历（递归）" class="headerlink" title="方式3：反向遍历（递归）"></a>方式3：反向遍历（递归）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要从后往前访问</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">reverseTraverse</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    reverseTraverse(node.next);        <span class="comment">// 先递归到末尾</span></span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 后序处理（反向）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">reverseTraverse(head);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：3 2 1（如果链表是 1-&gt;2-&gt;3）</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>利用递归栈实现反向遍历</li>
<li>不需要额外的反向链表</li>
<li>空间复杂度 O(n)</li>
</ul>
<h4 id="方式4：快慢指针遍历"><a href="#方式4：快慢指针遍历" class="headerlink" title="方式4：快慢指针遍历"></a>方式4：快慢指针遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：需要找到中点、检测环等</span></span><br><span class="line"><span class="type">ListNode</span> <span class="variable">slow</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="type">ListNode</span> <span class="variable">fast</span> <span class="operator">=</span> head;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 思路：slow 每次走一步，fast 每次走两步</span></span><br><span class="line"><span class="keyword">while</span> (fast != <span class="literal">null</span> &amp;&amp; fast.next != <span class="literal">null</span>) &#123;</span><br><span class="line">    slow = slow.next;</span><br><span class="line">    fast = fast.next.next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// slow 现在指向中点</span></span><br><span class="line">System.out.println(<span class="string">&quot;中点值：&quot;</span> + slow.val);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>快指针速度是慢指针的两倍</li>
<li>当快指针到达末尾时，慢指针在中点</li>
<li>适合检测环、找中点等</li>
</ul>
<h4 id="方式5：迭代器遍历"><a href="#方式5：迭代器遍历" class="headerlink" title="方式5：迭代器遍历"></a>方式5：迭代器遍历</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：使用集合框架</span></span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    System.out.println(iterator.next());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>隐藏指针细节</li>
<li>支持在遍历中删除</li>
<li>更安全的遍历方式</li>
</ul>
<h3 id="2-5-双向链表遍历"><a href="#2-5-双向链表遍历" class="headerlink" title="2.5 双向链表遍历"></a>2.5 双向链表遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DoublyListNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    DoublyListNode prev;  <span class="comment">// 前驱指针</span></span><br><span class="line">    DoublyListNode next;  <span class="comment">// 后继指针</span></span><br><span class="line">    </span><br><span class="line">    DoublyListNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正向遍历</span></span><br><span class="line"><span class="type">DoublyListNode</span> <span class="variable">current</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">    System.out.println(current.val);</span><br><span class="line">    current = current.next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 反向遍历（利用 prev 指针）</span></span><br><span class="line">current = tail;</span><br><span class="line"><span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">    System.out.println(current.val);</span><br><span class="line">    current = current.prev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>双向链表支持双向遍历</li>
<li>反向遍历不需要递归</li>
<li>适合需要双向访问的场景</li>
</ul>
<hr>
<h2 id="三、树的遍历"><a href="#三、树的遍历" class="headerlink" title="三、树的遍历"></a>三、树的遍历</h2><h3 id="3-1-基本特性"><a href="#3-1-基本特性" class="headerlink" title="3.1 基本特性"></a>3.1 基本特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储方式</strong></td>
<td>层级结构，父子关系</td>
</tr>
<tr>
<td><strong>访问复杂度</strong></td>
<td>O(n)</td>
</tr>
<tr>
<td><strong>遍历复杂度</strong></td>
<td>O(n)</td>
</tr>
<tr>
<td><strong>属性</strong></td>
<td>有序、非线性、无环</td>
</tr>
</tbody></table>
<h3 id="3-2-树节点定义"><a href="#3-2-树节点定义" class="headerlink" title="3.2 树节点定义"></a>3.2 树节点定义</h3><h4 id="二叉树节点"><a href="#二叉树节点" class="headerlink" title="二叉树节点"></a>二叉树节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TreeNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;              <span class="comment">// 数据</span></span><br><span class="line">    TreeNode left;        <span class="comment">// 左子树</span></span><br><span class="line">    TreeNode right;       <span class="comment">// 右子树</span></span><br><span class="line">    </span><br><span class="line">    TreeNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">        <span class="built_in">this</span>.left = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.right = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多叉树节点"><a href="#多叉树节点" class="headerlink" title="多叉树节点"></a>多叉树节点</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">NaryTreeNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;                          <span class="comment">// 数据</span></span><br><span class="line">    List&lt;NaryTreeNode&gt; children;      <span class="comment">// 子节点列表</span></span><br><span class="line">    </span><br><span class="line">    NaryTreeNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">        <span class="built_in">this</span>.children = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>每个节点可以有任意数量的子节点</li>
<li>适合表示文件系统、组织结构等</li>
<li>遍历逻辑更通用</li>
</ul>
<h3 id="3-3-深度优先遍历（DFS）"><a href="#3-3-深度优先遍历（DFS）" class="headerlink" title="3.3 深度优先遍历（DFS）"></a>3.3 深度优先遍历（DFS）</h3><h4 id="前序遍历（Pre-order）"><a href="#前序遍历（Pre-order）" class="headerlink" title="前序遍历（Pre-order）"></a>前序遍历（Pre-order）</h4><p><strong>遍历顺序</strong>：根 → 左子树 → 右子树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 访问当前节点</span><br><span class="line">2. 递归遍历左子树</span><br><span class="line">3. 递归遍历右子树</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 1. 访问根</span></span><br><span class="line">    preorder(node.left);               <span class="comment">// 2. 遍历左子树</span></span><br><span class="line">    preorder(node.right);              <span class="comment">// 3. 遍历右子树</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树：</span></span><br><span class="line"><span class="comment">//       1</span></span><br><span class="line"><span class="comment">//      / \</span></span><br><span class="line"><span class="comment">//     2   3</span></span><br><span class="line"><span class="comment">// 输出：1 2 3</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>最先访问根节点</li>
<li>适合需要先处理父节点的场景</li>
<li>如：复制树、序列化树</li>
</ul>
<p><strong>迭代实现</strong>（使用栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">preorderIterative</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    stack.push(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">node</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">        System.out.println(node.val);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注意：先压右子树，后压左子树</span></span><br><span class="line">        <span class="comment">// 这样弹出时左子树先出</span></span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.push(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.push(node.left);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(h)，h 是树的高度</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>栈模拟递归调用</li>
<li>压栈顺序很关键（右先压，左后压）</li>
<li>避免递归栈溢出</li>
</ul>
<h4 id="中序遍历（In-order）"><a href="#中序遍历（In-order）" class="headerlink" title="中序遍历（In-order）"></a>中序遍历（In-order）</h4><p><strong>遍历顺序</strong>：左子树 → 根 → 右子树</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 递归遍历左子树</span><br><span class="line">2. 访问当前节点</span><br><span class="line">3. 递归遍历右子树</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">inorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    inorder(node.left);                <span class="comment">// 1. 遍历左子树</span></span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 2. 访问根</span></span><br><span class="line">    inorder(node.right);               <span class="comment">// 3. 遍历右子树</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树：</span></span><br><span class="line"><span class="comment">//       2</span></span><br><span class="line"><span class="comment">//      / \</span></span><br><span class="line"><span class="comment">//     1   3</span></span><br><span class="line"><span class="comment">// 输出：1 2 3</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>对于二叉搜索树，中序遍历得到有序序列</li>
<li>适合需要有序处理的场景</li>
<li>最常用的遍历方式</li>
</ul>
<p><strong>迭代实现</strong>（使用栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">inorderIterative</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="type">TreeNode</span> <span class="variable">current</span> <span class="operator">=</span> root;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">null</span> || !stack.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 1. 一直向左走，压栈所有左节点</span></span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.push(current);</span><br><span class="line">            current = current.left;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 左子树遍历完，弹出栈顶（根）</span></span><br><span class="line">        current = stack.pop();</span><br><span class="line">        System.out.println(current.val);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 遍历右子树</span></span><br><span class="line">        current = current.right;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(h)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>关键：先一直向左，直到 null</li>
<li>然后处理栈顶，再向右</li>
<li>比前序遍历更复杂</li>
</ul>
<h4 id="后序遍历（Post-order）"><a href="#后序遍历（Post-order）" class="headerlink" title="后序遍历（Post-order）"></a>后序遍历（Post-order）</h4><p><strong>遍历顺序</strong>：左子树 → 右子树 → 根</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 递归遍历左子树</span><br><span class="line">2. 递归遍历右子树</span><br><span class="line">3. 访问当前节点</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">postorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    postorder(node.left);              <span class="comment">// 1. 遍历左子树</span></span><br><span class="line">    postorder(node.right);             <span class="comment">// 2. 遍历右子树</span></span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 3. 访问根</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树：</span></span><br><span class="line"><span class="comment">//       3</span></span><br><span class="line"><span class="comment">//      / \</span></span><br><span class="line"><span class="comment">//     1   2</span></span><br><span class="line"><span class="comment">// 输出：1 2 3</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>最后访问根节点</li>
<li>适合需要先处理子节点的场景</li>
<li>如：删除树、计算树的高度</li>
</ul>
<p><strong>迭代实现</strong>（使用两个栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">postorderIterative</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Stack&lt;TreeNode&gt; stack1 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    Stack&lt;TreeNode&gt; stack2 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    stack1.push(root);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第一次遍历：根 → 右 → 左（反向的后序）</span></span><br><span class="line">    <span class="keyword">while</span> (!stack1.isEmpty()) &#123;</span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">node</span> <span class="operator">=</span> stack1.pop();</span><br><span class="line">        stack2.push(node);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack1.push(node.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack1.push(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第二次遍历：弹出 stack2（得到正确的后序）</span></span><br><span class="line">    <span class="keyword">while</span> (!stack2.isEmpty()) &#123;</span><br><span class="line">        System.out.println(stack2.pop().val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(n)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>使用两个栈实现</li>
<li>第一个栈生成反向后序</li>
<li>第二个栈反转得到正确顺序</li>
</ul>
<h3 id="3-4-多叉树遍历"><a href="#3-4-多叉树遍历" class="headerlink" title="3.4 多叉树遍历"></a>3.4 多叉树遍历</h3><h4 id="多叉树前序遍历"><a href="#多叉树前序遍历" class="headerlink" title="多叉树前序遍历"></a>多叉树前序遍历</h4><p><strong>遍历顺序</strong>：根 → 所有子节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">preorderNary</span><span class="params">(NaryTreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 1. 访问根</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 遍历所有子节点</span></span><br><span class="line">    <span class="keyword">for</span> (NaryTreeNode child : node.children) &#123;</span><br><span class="line">        preorderNary(child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树：</span></span><br><span class="line"><span class="comment">//         1</span></span><br><span class="line"><span class="comment">//      /  |  \</span></span><br><span class="line"><span class="comment">//     2   3   4</span></span><br><span class="line"><span class="comment">//    / \</span></span><br><span class="line"><span class="comment">//   5   6</span></span><br><span class="line"><span class="comment">// 输出：1 2 5 6 3 4</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>与二叉树前序类似，先访问根</li>
<li>遍历所有子节点而不是只有左右</li>
<li>时间复杂度 O(n)，空间复杂度 O(h)</li>
</ul>
<p><strong>迭代实现</strong>（使用栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">preorderNaryIterative</span><span class="params">(NaryTreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Stack&lt;NaryTreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    stack.push(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">NaryTreeNode</span> <span class="variable">node</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">        System.out.println(node.val);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 关键：反向压栈子节点，保证正确的访问顺序</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> node.children.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            stack.push(node.children.get(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(h)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>反向压栈是关键（从最后一个子节点开始）</li>
<li>这样弹出时，第一个子节点先出</li>
<li>保证了正确的前序遍历顺序</li>
</ul>
<h4 id="多叉树后序遍历"><a href="#多叉树后序遍历" class="headerlink" title="多叉树后序遍历"></a>多叉树后序遍历</h4><p><strong>遍历顺序</strong>：所有子节点 → 根</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">postorderNary</span><span class="params">(NaryTreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 遍历所有子节点</span></span><br><span class="line">    <span class="keyword">for</span> (NaryTreeNode child : node.children) &#123;</span><br><span class="line">        postorderNary(child);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    System.out.println(node.val);      <span class="comment">// 2. 访问根</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树同上</span></span><br><span class="line"><span class="comment">// 输出：5 6 2 3 4 1</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>先处理所有子节点，最后处理根</li>
<li>适合需要先处理子树的场景（如删除树）</li>
<li>时间复杂度 O(n)，空间复杂度 O(h)</li>
</ul>
<p><strong>迭代实现</strong>（使用两个栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">postorderNaryIterative</span><span class="params">(NaryTreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Stack&lt;NaryTreeNode&gt; stack1 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    Stack&lt;NaryTreeNode&gt; stack2 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    stack1.push(root);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第一次遍历：生成反向的后序</span></span><br><span class="line">    <span class="keyword">while</span> (!stack1.isEmpty()) &#123;</span><br><span class="line">        <span class="type">NaryTreeNode</span> <span class="variable">node</span> <span class="operator">=</span> stack1.pop();</span><br><span class="line">        stack2.push(node);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 正向压栈子节点</span></span><br><span class="line">        <span class="keyword">for</span> (NaryTreeNode child : node.children) &#123;</span><br><span class="line">            stack1.push(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 第二次遍历：弹出 stack2</span></span><br><span class="line">    <span class="keyword">while</span> (!stack2.isEmpty()) &#123;</span><br><span class="line">        System.out.println(stack2.pop().val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(n)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>与二叉树后序类似，使用两个栈</li>
<li>第一个栈生成反向后序</li>
<li>第二个栈反转得到正确顺序</li>
</ul>
<h4 id="多叉树层序遍历"><a href="#多叉树层序遍历" class="headerlink" title="多叉树层序遍历"></a>多叉树层序遍历</h4><p><strong>遍历顺序</strong>：按层从上到下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">levelorderNary</span><span class="params">(NaryTreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Queue&lt;NaryTreeNode&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="type">NaryTreeNode</span> <span class="variable">node</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">        System.out.println(node.val);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将所有子节点加入队列</span></span><br><span class="line">        <span class="keyword">for</span> (NaryTreeNode child : node.children) &#123;</span><br><span class="line">            queue.add(child);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：1 2 3 4 5 6</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>队列保证层序访问</li>
<li>遍历所有子节点而不是只有左右</li>
<li>时间复杂度 O(n)，空间复杂度 O(w)</li>
</ul>
<h4 id="分层遍历（返回每层的列表）"><a href="#分层遍历（返回每层的列表）" class="headerlink" title="分层遍历（返回每层的列表）"></a>分层遍历（返回每层的列表）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; <span class="title function_">levelorderNaryList</span><span class="params">(NaryTreeNode root)</span> &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span> result;</span><br><span class="line">    </span><br><span class="line">    Queue&lt;NaryTreeNode&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">levelSize</span> <span class="operator">=</span> queue.size();  <span class="comment">// 记录当前层的节点数</span></span><br><span class="line">        List&lt;Integer&gt; currentLevel = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理当前层的所有节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; levelSize; i++) &#123;</span><br><span class="line">            <span class="type">NaryTreeNode</span> <span class="variable">node</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">            currentLevel.add(node.val);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 将所有子节点加入队列</span></span><br><span class="line">            <span class="keyword">for</span> (NaryTreeNode child : node.children) &#123;</span><br><span class="line">                queue.add(child);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        result.add(currentLevel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：[[1], [2, 3, 4], [5, 6]]</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>关键：记录每层的节点数</li>
<li>在处理当前层时，只处理 levelSize 个节点</li>
<li>这样可以清晰地分离各层</li>
</ul>
<h3 id="3-5-多叉树-vs-二叉树对比"><a href="#3-5-多叉树-vs-二叉树对比" class="headerlink" title="3.5 多叉树 vs 二叉树对比"></a>3.5 多叉树 vs 二叉树对比</h3><table>
<thead>
<tr>
<th>维度</th>
<th>二叉树</th>
<th>多叉树</th>
</tr>
</thead>
<tbody><tr>
<td><strong>子节点数</strong></td>
<td>最多 2 个</td>
<td>任意个</td>
</tr>
<tr>
<td><strong>前序遍历</strong></td>
<td>根→左→右</td>
<td>根→所有子</td>
</tr>
<tr>
<td><strong>后序遍历</strong></td>
<td>左→右→根</td>
<td>所有子→根</td>
</tr>
<tr>
<td><strong>中序遍历</strong></td>
<td>左→根→右</td>
<td>不适用</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>搜索树、堆</td>
<td>文件系统、组织结构</td>
</tr>
<tr>
<td><strong>实现复杂度</strong></td>
<td>简单</td>
<td>稍复杂（循环遍历子节点）</td>
</tr>
</tbody></table>
<hr>
<h3 id="3-6-广度优先遍历（BFS）"><a href="#3-6-广度优先遍历（BFS）" class="headerlink" title="3.6 广度优先遍历（BFS）"></a>3.6 广度优先遍历（BFS）</h3><h4 id="层序遍历（Level-order）"><a href="#层序遍历（Level-order）" class="headerlink" title="层序遍历（Level-order）"></a>层序遍历（Level-order）</h4><p><strong>遍历顺序</strong>：按层从上到下，同层从左到右</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">思路流程：</span><br><span class="line">1. 初始化队列，放入根节点</span><br><span class="line">2. 队列不为空时：</span><br><span class="line">   a. 弹出队列前端节点</span><br><span class="line">   b. 访问该节点</span><br><span class="line">   c. 将其子节点加入队列</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用队列实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">levelorder</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">node</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">        System.out.println(node.val);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            queue.add(node.left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            queue.add(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例树：</span></span><br><span class="line"><span class="comment">//       1</span></span><br><span class="line"><span class="comment">//      / \</span></span><br><span class="line"><span class="comment">//     2   3</span></span><br><span class="line"><span class="comment">//    / \</span></span><br><span class="line"><span class="comment">//   4   5</span></span><br><span class="line"><span class="comment">// 输出：1 2 3 4 5</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>队列保证了层序访问</li>
<li>先进先出的特性很关键</li>
<li>适合需要按层处理的场景</li>
</ul>
<h4 id="分层遍历（返回每层的列表）-1"><a href="#分层遍历（返回每层的列表）-1" class="headerlink" title="分层遍历（返回每层的列表）"></a>分层遍历（返回每层的列表）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">List&lt;List&lt;Integer&gt;&gt; <span class="title function_">levelOrderList</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    List&lt;List&lt;Integer&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span> result;</span><br><span class="line">    </span><br><span class="line">    Queue&lt;TreeNode&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    queue.add(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">levelSize</span> <span class="operator">=</span> queue.size();  <span class="comment">// 关键：记录当前层的节点数</span></span><br><span class="line">        List&lt;Integer&gt; currentLevel = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理当前层的所有节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; levelSize; i++) &#123;</span><br><span class="line">            <span class="type">TreeNode</span> <span class="variable">node</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">            currentLevel.add(node.val);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">                queue.add(node.left);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">                queue.add(node.right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        result.add(currentLevel);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：[[1], [2, 3], [4, 5]]</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>关键：记录每层的节点数</li>
<li>在处理当前层时，只处理 levelSize 个节点</li>
<li>这样可以清晰地分离各层</li>
</ul>
<h3 id="3-5-DFS-vs-BFS-对比"><a href="#3-5-DFS-vs-BFS-对比" class="headerlink" title="3.5 DFS vs BFS 对比"></a>3.5 DFS vs BFS 对比</h3><table>
<thead>
<tr>
<th>维度</th>
<th>DFS（递归&#x2F;栈）</th>
<th>BFS（队列）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>实现</strong></td>
<td>递归或栈</td>
<td>队列</td>
</tr>
<tr>
<td><strong>空间复杂度</strong></td>
<td>O(h)（高度）</td>
<td>O(w)（最大宽度）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>路径问题、深度问题</td>
<td>最短路径、层级问题</td>
</tr>
<tr>
<td><strong>遍历顺序</strong></td>
<td>深度优先</td>
<td>广度优先</td>
</tr>
</tbody></table>
<hr>
<h2 id="四、图的遍历"><a href="#四、图的遍历" class="headerlink" title="四、图的遍历"></a>四、图的遍历</h2><h3 id="4-1-基本特性"><a href="#4-1-基本特性" class="headerlink" title="4.1 基本特性"></a>4.1 基本特性</h3><table>
<thead>
<tr>
<th>特性</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>存储方式</strong></td>
<td>邻接表或邻接矩阵</td>
</tr>
<tr>
<td><strong>访问复杂度</strong></td>
<td>O(V+E)</td>
</tr>
<tr>
<td><strong>遍历复杂度</strong></td>
<td>O(V+E)</td>
</tr>
<tr>
<td><strong>属性</strong></td>
<td>可能有环、可能不连通</td>
</tr>
</tbody></table>
<h3 id="4-2-图的表示"><a href="#4-2-图的表示" class="headerlink" title="4.2 图的表示"></a>4.2 图的表示</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 邻接表表示</span></span><br><span class="line">Map&lt;Integer, List&lt;Integer&gt;&gt; graph = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">graph.put(<span class="number">1</span>, Arrays.asList(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">graph.put(<span class="number">2</span>, Arrays.asList(<span class="number">1</span>, <span class="number">4</span>));</span><br><span class="line">graph.put(<span class="number">3</span>, Arrays.asList(<span class="number">1</span>));</span><br><span class="line">graph.put(<span class="number">4</span>, Arrays.asList(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 邻接矩阵表示</span></span><br><span class="line"><span class="type">int</span>[][] adjMatrix = &#123;</span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>&#125;,  <span class="comment">// 节点 0 的邻接</span></span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;,  <span class="comment">// 节点 1 的邻接</span></span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;,  <span class="comment">// 节点 2 的邻接</span></span><br><span class="line">    &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>&#125;   <span class="comment">// 节点 3 的邻接</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="4-3-深度优先遍历（DFS）"><a href="#4-3-深度优先遍历（DFS）" class="headerlink" title="4.3 深度优先遍历（DFS）"></a>4.3 深度优先遍历（DFS）</h3><p><strong>思路</strong>：从起点开始，沿着一条路径尽可能深地探索，直到无法继续，然后回溯。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归实现</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> node, Map&lt;Integer, List&lt;Integer&gt;&gt; graph, Set&lt;Integer&gt; visited)</span> &#123;</span><br><span class="line">    visited.add(node);</span><br><span class="line">    System.out.println(node);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> neighbor : graph.getOrDefault(node, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!visited.contains(neighbor)) &#123;</span><br><span class="line">            dfs(neighbor, graph, visited);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line">Set&lt;Integer&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">dfs(<span class="number">1</span>, graph, visited);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(V+E)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(V)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>使用 visited 集合防止重复访问（处理环）</li>
<li>递归自然地实现了深度优先</li>
<li>适合检测环、拓扑排序等</li>
</ul>
<p><strong>迭代实现</strong>（使用栈）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">dfsIterative</span><span class="params">(<span class="type">int</span> start, Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;</span><br><span class="line">    Set&lt;Integer&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    stack.push(start);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">node</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (visited.contains(node)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        visited.add(node);</span><br><span class="line">        System.out.println(node);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 压栈所有未访问的邻接节点</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> neighbor : graph.getOrDefault(node, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!visited.contains(neighbor)) &#123;</span><br><span class="line">                stack.push(neighbor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(V+E)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(V)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>栈模拟递归</li>
<li>需要检查是否已访问</li>
<li>避免重复处理</li>
</ul>
<h3 id="4-4-广度优先遍历（BFS）"><a href="#4-4-广度优先遍历（BFS）" class="headerlink" title="4.4 广度优先遍历（BFS）"></a>4.4 广度优先遍历（BFS）</h3><p><strong>思路</strong>：从起点开始，逐层探索所有邻接节点，然后探索下一层。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">bfs</span><span class="params">(<span class="type">int</span> start, Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;</span><br><span class="line">    Set&lt;Integer&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    Queue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    queue.add(start);</span><br><span class="line">    visited.add(start);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!queue.isEmpty()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">node</span> <span class="operator">=</span> queue.poll();</span><br><span class="line">        System.out.println(node);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> neighbor : graph.getOrDefault(node, <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!visited.contains(neighbor)) &#123;</span><br><span class="line">                visited.add(neighbor);</span><br><span class="line">                queue.add(neighbor);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(V+E)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(V)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>队列保证了广度优先</li>
<li>访问时就标记，避免重复加入队列</li>
<li>适合最短路径问题</li>
</ul>
<h3 id="4-5-DFS-vs-BFS-对比"><a href="#4-5-DFS-vs-BFS-对比" class="headerlink" title="4.5 DFS vs BFS 对比"></a>4.5 DFS vs BFS 对比</h3><table>
<thead>
<tr>
<th>维度</th>
<th>DFS</th>
<th>BFS</th>
</tr>
</thead>
<tbody><tr>
<td><strong>数据结构</strong></td>
<td>栈</td>
<td>队列</td>
</tr>
<tr>
<td><strong>空间复杂度</strong></td>
<td>O(V)</td>
<td>O(V)</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>连通性、环检测、拓扑排序</td>
<td>最短路径、分层</td>
</tr>
<tr>
<td><strong>遍历顺序</strong></td>
<td>深度优先</td>
<td>广度优先</td>
</tr>
</tbody></table>
<hr>
<h2 id="五、特殊数据结构遍历"><a href="#五、特殊数据结构遍历" class="headerlink" title="五、特殊数据结构遍历"></a>五、特殊数据结构遍历</h2><h3 id="5-1-二叉搜索树（BST）遍历"><a href="#5-1-二叉搜索树（BST）遍历" class="headerlink" title="5.1 二叉搜索树（BST）遍历"></a>5.1 二叉搜索树（BST）遍历</h3><p><strong>特性</strong>：左子树 &lt; 根 &lt; 右子树</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 中序遍历得到有序序列</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">inorderBST</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    inorderBST(node.left);</span><br><span class="line">    System.out.println(node.val);  <span class="comment">// 输出有序</span></span><br><span class="line">    inorderBST(node.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：</span></span><br><span class="line"><span class="comment">//       5</span></span><br><span class="line"><span class="comment">//      / \</span></span><br><span class="line"><span class="comment">//     3   7</span></span><br><span class="line"><span class="comment">//    / \ / \</span></span><br><span class="line"><span class="comment">//   2  4 6  8</span></span><br><span class="line"><span class="comment">// 中序输出：2 3 4 5 6 7 8</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>中序遍历的特殊应用</li>
<li>利用 BST 的有序性</li>
<li>时间复杂度 O(n)</li>
</ul>
<h3 id="5-2-堆的遍历"><a href="#5-2-堆的遍历" class="headerlink" title="5.2 堆的遍历"></a>5.2 堆的遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 堆通常用数组表示</span></span><br><span class="line"><span class="type">int</span>[] heap = &#123;<span class="number">10</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 按数组顺序遍历（层序）</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; heap.length; i++) &#123;</span><br><span class="line">    System.out.println(heap[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节点关系：</span></span><br><span class="line"><span class="comment">// 节点 i 的左子节点：2*i + 1</span></span><br><span class="line"><span class="comment">// 节点 i 的右子节点：2*i + 2</span></span><br><span class="line"><span class="comment">// 节点 i 的父节点：(i-1)/2</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>堆用数组表示，按层序存储</li>
<li>遍历就是按数组顺序访问</li>
<li>时间复杂度 O(n)</li>
</ul>
<h3 id="5-3-哈希表遍历"><a href="#5-3-哈希表遍历" class="headerlink" title="5.3 哈希表遍历"></a>5.3 哈希表遍历</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Integer&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>);</span><br><span class="line">map.put(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>);</span><br><span class="line">map.put(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1：遍历 key</span></span><br><span class="line"><span class="keyword">for</span> (String key : map.keySet()) &#123;</span><br><span class="line">    System.out.println(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：遍历 value</span></span><br><span class="line"><span class="keyword">for</span> (Integer value : map.values()) &#123;</span><br><span class="line">    System.out.println(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3：遍历 entry（最高效）</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    System.out.println(entry.getKey() + <span class="string">&quot;: &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式4：迭代器</span></span><br><span class="line">Iterator&lt;Map.Entry&lt;String, Integer&gt;&gt; iterator = map.entrySet().iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Map.Entry&lt;String, Integer&gt; entry = iterator.next();</span><br><span class="line">    System.out.println(entry.getKey() + <span class="string">&quot;: &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 时间复杂度：O(n)</span></span><br><span class="line"><span class="comment">// 空间复杂度：O(1)</span></span><br></pre></td></tr></table></figure>

<p><strong>思路分析</strong>：</p>
<ul>
<li>遍历 entry 最高效（避免重复查询）</li>
<li>哈希表无序，遍历顺序不确定</li>
<li>遍历中删除需要用迭代器</li>
</ul>
<hr>
<h2 id="六、遍历的通用思路总结"><a href="#六、遍历的通用思路总结" class="headerlink" title="六、遍历的通用思路总结"></a>六、遍历的通用思路总结</h2><h3 id="6-1-遍历的三个核心要素"><a href="#6-1-遍历的三个核心要素" class="headerlink" title="6.1 遍历的三个核心要素"></a>6.1 遍历的三个核心要素</h3><table>
<thead>
<tr>
<th>要素</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>访问顺序</strong></td>
<td>按什么顺序访问元素</td>
<td>前序、中序、后序、层序</td>
</tr>
<tr>
<td><strong>状态管理</strong></td>
<td>如何跟踪已访问的元素</td>
<td>visited 集合、指针位置</td>
</tr>
<tr>
<td><strong>终止条件</strong></td>
<td>何时停止遍历</td>
<td>null、队列为空、visited 完全</td>
</tr>
</tbody></table>
<h3 id="6-2-选择遍历方式的决策树"><a href="#6-2-选择遍历方式的决策树" class="headerlink" title="6.2 选择遍历方式的决策树"></a>6.2 选择遍历方式的决策树</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">需要遍历数据结构</span><br><span class="line">    ↓</span><br><span class="line">是否需要特定顺序？</span><br><span class="line">    ├─ 是 → 选择对应的遍历方式</span><br><span class="line">    │       ├─ 前序：先处理父节点</span><br><span class="line">    │       ├─ 中序：有序处理（BST）</span><br><span class="line">    │       ├─ 后序：先处理子节点</span><br><span class="line">    │       └─ 层序：按层处理</span><br><span class="line">    │</span><br><span class="line">    └─ 否 → 选择最简单的方式</span><br><span class="line">            ├─ 线性结构 → for 循环</span><br><span class="line">            ├─ 树 → DFS 或 BFS</span><br><span class="line">            └─ 图 → DFS 或 BFS</span><br></pre></td></tr></table></figure>

<h3 id="6-3-递归-vs-迭代"><a href="#6-3-递归-vs-迭代" class="headerlink" title="6.3 递归 vs 迭代"></a>6.3 递归 vs 迭代</h3><table>
<thead>
<tr>
<th>维度</th>
<th>递归</th>
<th>迭代</th>
</tr>
</thead>
<tbody><tr>
<td><strong>代码简洁性</strong></td>
<td>简洁</td>
<td>复杂</td>
</tr>
<tr>
<td><strong>空间复杂度</strong></td>
<td>O(h)（栈）</td>
<td>O(h)（栈）</td>
</tr>
<tr>
<td><strong>栈溢出风险</strong></td>
<td>高（深度大）</td>
<td>低</td>
</tr>
<tr>
<td><strong>理解难度</strong></td>
<td>容易</td>
<td>较难</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>略低（函数调用）</td>
<td>略高</td>
</tr>
</tbody></table>
<hr>
<h2 id="七、常见遍历问题"><a href="#七、常见遍历问题" class="headerlink" title="七、常见遍历问题"></a>七、常见遍历问题</h2><h3 id="7-1-如何在遍历中删除元素？"><a href="#7-1-如何在遍历中删除元素？" class="headerlink" title="7.1 如何在遍历中删除元素？"></a>7.1 如何在遍历中删除元素？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误方式：直接删除</span></span><br><span class="line">List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list.get(i) == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i);  <span class="comment">// 会导致索引混乱</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确方式1：使用迭代器</span></span><br><span class="line">Iterator&lt;Integer&gt; iterator = list.iterator();</span><br><span class="line"><span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (iterator.next() == <span class="number">3</span>) &#123;</span><br><span class="line">        iterator.remove();  <span class="comment">// 安全删除</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确方式2：反向遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> list.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list.get(i) == <span class="number">3</span>) &#123;</span><br><span class="line">        list.remove(i);  <span class="comment">// 不影响后续索引</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确方式3：收集要删除的元素</span></span><br><span class="line">List&lt;Integer&gt; toRemove = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> num : list) &#123;</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">3</span>) &#123;</span><br><span class="line">        toRemove.add(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">list.removeAll(toRemove);</span><br></pre></td></tr></table></figure>

<h3 id="7-2-如何处理环形结构？"><a href="#7-2-如何处理环形结构？" class="headerlink" title="7.2 如何处理环形结构？"></a>7.2 如何处理环形结构？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：链表中可能有环</span></span><br><span class="line"><span class="comment">// 解决：使用 visited 集合或快慢指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1：visited 集合</span></span><br><span class="line">Set&lt;ListNode&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line"><span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (visited.contains(current)) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;检测到环&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    visited.add(current);</span><br><span class="line">    current = current.next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：快慢指针（Floyd 算法）</span></span><br><span class="line"><span class="type">ListNode</span> <span class="variable">slow</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="type">ListNode</span> <span class="variable">fast</span> <span class="operator">=</span> head;</span><br><span class="line"><span class="keyword">while</span> (fast != <span class="literal">null</span> &amp;&amp; fast.next != <span class="literal">null</span>) &#123;</span><br><span class="line">    slow = slow.next;</span><br><span class="line">    fast = fast.next.next;</span><br><span class="line">    <span class="keyword">if</span> (slow == fast) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;检测到环&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-3-如何处理不连通的图？"><a href="#7-3-如何处理不连通的图？" class="headerlink" title="7.3 如何处理不连通的图？"></a>7.3 如何处理不连通的图？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：图可能有多个连通分量</span></span><br><span class="line"><span class="comment">// 解决：对每个未访问的节点进行 DFS/BFS</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">traverseAllComponents</span><span class="params">(Map&lt;Integer, List&lt;Integer&gt;&gt; graph)</span> &#123;</span><br><span class="line">    Set&lt;Integer&gt; visited = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> node : graph.keySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!visited.contains(node)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;--- 新的连通分量 ---&quot;</span>);</span><br><span class="line">            dfs(node, graph, visited);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、性能对比总结"><a href="#八、性能对比总结" class="headerlink" title="八、性能对比总结"></a>八、性能对比总结</h2><table>
<thead>
<tr>
<th>数据结构</th>
<th>遍历方式</th>
<th>时间复杂度</th>
<th>空间复杂度</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>数组</td>
<td>for 循环</td>
<td>O(n)</td>
<td>O(1)</td>
<td>顺序访问</td>
</tr>
<tr>
<td>链表</td>
<td>while 循环</td>
<td>O(n)</td>
<td>O(1)</td>
<td>顺序访问</td>
</tr>
<tr>
<td>树</td>
<td>DFS（递归）</td>
<td>O(n)</td>
<td>O(h)</td>
<td>深度优先</td>
</tr>
<tr>
<td>树</td>
<td>BFS（队列）</td>
<td>O(n)</td>
<td>O(w)</td>
<td>广度优先</td>
</tr>
<tr>
<td>图</td>
<td>DFS</td>
<td>O(V+E)</td>
<td>O(V)</td>
<td>连通性检测</td>
</tr>
<tr>
<td>图</td>
<td>BFS</td>
<td>O(V+E)</td>
<td>O(V)</td>
<td>最短路径</td>
</tr>
<tr>
<td>哈希表</td>
<td>entry 遍历</td>
<td>O(n)</td>
<td>O(1)</td>
<td>键值对访问</td>
</tr>
</tbody></table>
<hr>
<h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul>
<li>数组操作详解</li>
<li>链表操作详解</li>
<li>树的操作详解</li>
<li>图的操作详解</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/12/%E9%80%92%E5%BD%92%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/12/%E9%80%92%E5%BD%92%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">递归详解与应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-12 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-12T00:00:00+08:00">2026-01-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="递归详解与应用"><a href="#递归详解与应用" class="headerlink" title="递归详解与应用"></a>递归详解与应用</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><strong>递归</strong> 是一种编程技巧，函数调用自身来解决问题。递归的核心思想是：<strong>将大问题分解为相同的小问题，直到问题足够小可以直接求解</strong>。</p>
<blockquote>
<p><strong>💡 提示: 核心思想</strong><br>递归 &#x3D; 自我调用 + 终止条件 + 问题分解</p>
</blockquote>
<hr>
<h2 id="一、递归的三个要素"><a href="#一、递归的三个要素" class="headerlink" title="一、递归的三个要素"></a>一、递归的三个要素</h2><h3 id="1-1-递归的本质"><a href="#1-1-递归的本质" class="headerlink" title="1.1 递归的本质"></a>1.1 递归的本质</h3><p>递归就是<strong>函数调用自己</strong>，但每次调用都在处理一个更小的问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">大问题</span><br><span class="line">  ↓</span><br><span class="line">分解为更小的问题 + 调用自己</span><br><span class="line">  ↓</span><br><span class="line">继续分解</span><br><span class="line">  ↓</span><br><span class="line">直到问题足够小</span><br><span class="line">  ↓</span><br><span class="line">直接求解（返回结果）</span><br><span class="line">  ↓</span><br><span class="line">逐层返回结果</span><br></pre></td></tr></table></figure>

<h3 id="1-2-递归的三个必要条件"><a href="#1-2-递归的三个必要条件" class="headerlink" title="1.2 递归的三个必要条件"></a>1.2 递归的三个必要条件</h3><table>
<thead>
<tr>
<th>条件</th>
<th>说明</th>
<th>重要性</th>
</tr>
</thead>
<tbody><tr>
<td><strong>递归关系</strong></td>
<td>函数调用自身</td>
<td>必须</td>
</tr>
<tr>
<td><strong>终止条件</strong></td>
<td>何时停止递归</td>
<td><strong>必须</strong>（没有会无限循环）</td>
</tr>
<tr>
<td><strong>问题分解</strong></td>
<td>如何将大问题分解为小问题</td>
<td>必须</td>
</tr>
</tbody></table>
<h3 id="1-3-递归的通用模板"><a href="#1-3-递归的通用模板" class="headerlink" title="1.3 递归的通用模板"></a>1.3 递归的通用模板</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归函数的标准模板</span></span><br><span class="line">返回值类型 recursiveFunction(参数) &#123;</span><br><span class="line">    <span class="comment">// 1. 终止条件（基础情况）</span></span><br><span class="line">    <span class="keyword">if</span> (终止条件) &#123;</span><br><span class="line">        <span class="keyword">return</span> 基础情况的结果;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 递归关系（递归情况）</span></span><br><span class="line">    <span class="comment">// 调用自身处理更小的问题</span></span><br><span class="line">    返回值 = recursiveFunction(更小的参数);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 处理结果</span></span><br><span class="line">    <span class="keyword">return</span> 处理后的结果;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、递归的执行过程"><a href="#二、递归的执行过程" class="headerlink" title="二、递归的执行过程"></a>二、递归的执行过程</h2><h3 id="2-1-递归栈的概念"><a href="#2-1-递归栈的概念" class="headerlink" title="2.1 递归栈的概念"></a>2.1 递归栈的概念</h3><p>当函数调用自己时，每次调用都会在<strong>栈</strong>上创建一个新的函数执行环境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">递归调用过程：</span><br><span class="line">recursion(5)</span><br><span class="line">  ↓ 调用</span><br><span class="line">recursion(4)</span><br><span class="line">  ↓ 调用</span><br><span class="line">recursion(3)</span><br><span class="line">  ↓ 调用</span><br><span class="line">recursion(2)</span><br><span class="line">  ↓ 调用</span><br><span class="line">recursion(1)</span><br><span class="line">  ↓ 到达终止条件</span><br><span class="line">return 1</span><br><span class="line">  ↑ 返回</span><br><span class="line">return 2 * 1 = 2</span><br><span class="line">  ↑ 返回</span><br><span class="line">return 3 * 2 = 6</span><br><span class="line">  ↑ 返回</span><br><span class="line">return 4 * 6 = 24</span><br><span class="line">  ↑ 返回</span><br><span class="line">return 5 * 24 = 120</span><br></pre></td></tr></table></figure>

<h3 id="2-2-递归栈的内存占用"><a href="#2-2-递归栈的内存占用" class="headerlink" title="2.2 递归栈的内存占用"></a>2.2 递归栈的内存占用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">栈内存：</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│ recursion(1)    │ ← 最后入栈</span><br><span class="line">│ 局部变量: n=1   │</span><br><span class="line">├─────────────────┤</span><br><span class="line">│ recursion(2)    │</span><br><span class="line">│ 局部变量: n=2   │</span><br><span class="line">├─────────────────┤</span><br><span class="line">│ recursion(3)    │</span><br><span class="line">│ 局部变量: n=3   │</span><br><span class="line">├─────────────────┤</span><br><span class="line">│ recursion(4)    │</span><br><span class="line">│ 局部变量: n=4   │</span><br><span class="line">├─────────────────┤</span><br><span class="line">│ recursion(5)    │ ← 最先入栈</span><br><span class="line">│ 局部变量: n=5   │</span><br><span class="line">└─────────────────┘</span><br><span class="line"></span><br><span class="line">递归深度 = 5</span><br><span class="line">栈空间 = 5 × 每个函数的空间</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>每次递归调用都会占用栈空间</li>
<li>递归深度越深，占用的栈空间越多</li>
<li>栈空间有限，过深的递归会导致栈溢出</li>
</ul>
<hr>
<h2 id="三、递归的实际例子"><a href="#三、递归的实际例子" class="headerlink" title="三、递归的实际例子"></a>三、递归的实际例子</h2><h3 id="3-1-例子1：计算阶乘"><a href="#3-1-例子1：计算阶乘" class="headerlink" title="3.1 例子1：计算阶乘"></a>3.1 例子1：计算阶乘</h3><h4 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5! = 5 × 4!</span><br><span class="line">4! = 4 × 3!</span><br><span class="line">3! = 3 × 2!</span><br><span class="line">2! = 2 × 1!</span><br><span class="line">1! = 1（基础情况）</span><br></pre></td></tr></table></figure>

<p><strong>递归关系</strong>：<code>n! = n × (n-1)!</code><br><strong>终止条件</strong>：<code>n == 1</code></p>
<h4 id="递归实现"><a href="#递归实现" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 递归方式</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">factorial</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 终止条件</span></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  <span class="comment">// 基础情况</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 递归关系</span></span><br><span class="line">    <span class="comment">// 调用自身处理更小的问题</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> n * factorial(n - <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 返回结果</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> factorial(<span class="number">5</span>);  <span class="comment">// 返回 120</span></span><br></pre></td></tr></table></figure>

<h4 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">factorial(5)</span><br><span class="line">  ↓ 5 != 1，继续递归</span><br><span class="line">  ↓ 计算 5 * factorial(4)</span><br><span class="line">    ↓ factorial(4)</span><br><span class="line">    ↓ 4 != 1，继续递归</span><br><span class="line">    ↓ 计算 4 * factorial(3)</span><br><span class="line">      ↓ factorial(3)</span><br><span class="line">      ↓ 3 != 1，继续递归</span><br><span class="line">      ↓ 计算 3 * factorial(2)</span><br><span class="line">        ↓ factorial(2)</span><br><span class="line">        ↓ 2 != 1，继续递归</span><br><span class="line">        ↓ 计算 2 * factorial(1)</span><br><span class="line">          ↓ factorial(1)</span><br><span class="line">          ↓ 1 == 1，到达终止条件</span><br><span class="line">          ↓ return 1</span><br><span class="line">        ↓ return 2 * 1 = 2</span><br><span class="line">      ↓ return 3 * 2 = 6</span><br><span class="line">    ↓ return 4 * 6 = 24</span><br><span class="line">  ↓ return 5 * 24 = 120</span><br></pre></td></tr></table></figure>

<p><strong>时间复杂度</strong>：O(n)<br><strong>空间复杂度</strong>：O(n)（递归栈深度）</p>
<h3 id="3-2-例子2：链表遍历（树遍历的基础）"><a href="#3-2-例子2：链表遍历（树遍历的基础）" class="headerlink" title="3.2 例子2：链表遍历（树遍历的基础）"></a>3.2 例子2：链表遍历（树遍历的基础）</h3><h4 id="问题分析-1"><a href="#问题分析-1" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">链表：1 → 2 → 3 → null</span><br><span class="line"></span><br><span class="line">遍历思路：</span><br><span class="line">- 访问当前节点</span><br><span class="line">- 递归遍历下一个节点</span><br><span class="line">- 终止条件：节点为 null</span><br></pre></td></tr></table></figure>

<h4 id="递归实现-1"><a href="#递归实现-1" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ListNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    ListNode next;</span><br><span class="line">    </span><br><span class="line">    ListNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 递归遍历链表</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">traverse</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 终止条件</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;  <span class="comment">// 到达链表末尾</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 处理当前节点</span></span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 递归处理下一个节点</span></span><br><span class="line">    traverse(node.next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="type">ListNode</span> <span class="variable">head</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">1</span>);</span><br><span class="line">head.next = <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">2</span>);</span><br><span class="line">head.next.next = <span class="keyword">new</span> <span class="title class_">ListNode</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">traverse(head);  <span class="comment">// 输出：1 2 3</span></span><br></pre></td></tr></table></figure>

<h4 id="执行过程-1"><a href="#执行过程-1" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">traverse(node1)  // node1.val = 1</span><br><span class="line">  ↓ node1 != null</span><br><span class="line">  ↓ 打印 1</span><br><span class="line">  ↓ 调用 traverse(node2)</span><br><span class="line">    ↓ traverse(node2)  // node2.val = 2</span><br><span class="line">    ↓ node2 != null</span><br><span class="line">    ↓ 打印 2</span><br><span class="line">    ↓ 调用 traverse(node3)</span><br><span class="line">      ↓ traverse(node3)  // node3.val = 3</span><br><span class="line">      ↓ node3 != null</span><br><span class="line">      ↓ 打印 3</span><br><span class="line">      ↓ 调用 traverse(null)</span><br><span class="line">        ↓ traverse(null)</span><br><span class="line">        ↓ null == null，到达终止条件</span><br><span class="line">        ↓ return</span><br><span class="line">      ↓ return</span><br><span class="line">    ↓ return</span><br><span class="line">  ↓ return</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>每次递归都处理一个节点</li>
<li>通过 <code>node.next</code> 将问题分解为更小的问题</li>
<li>当 <code>node == null</code> 时停止递归</li>
</ul>
<h3 id="3-3-例子3：二叉树前序遍历"><a href="#3-3-例子3：二叉树前序遍历" class="headerlink" title="3.3 例子3：二叉树前序遍历"></a>3.3 例子3：二叉树前序遍历</h3><h4 id="问题分析-2"><a href="#问题分析-2" class="headerlink" title="问题分析"></a>问题分析</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">树结构：</span><br><span class="line">      1</span><br><span class="line">     / \</span><br><span class="line">    2   3</span><br><span class="line"></span><br><span class="line">前序遍历：根 → 左子树 → 右子树</span><br><span class="line">输出：1 2 3</span><br><span class="line"></span><br><span class="line">递归思路：</span><br><span class="line">1. 访问根节点</span><br><span class="line">2. 递归遍历左子树</span><br><span class="line">3. 递归遍历右子树</span><br></pre></td></tr></table></figure>

<h4 id="递归实现-2"><a href="#递归实现-2" class="headerlink" title="递归实现"></a>递归实现</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TreeNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    TreeNode left;</span><br><span class="line">    TreeNode right;</span><br><span class="line">    </span><br><span class="line">    TreeNode(<span class="type">int</span> val) &#123;</span><br><span class="line">        <span class="built_in">this</span>.val = val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 前序遍历</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 终止条件</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 处理根节点</span></span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 递归处理左子树</span></span><br><span class="line">    preorder(node.left);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 4. 递归处理右子树</span></span><br><span class="line">    preorder(node.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用</span></span><br><span class="line"><span class="type">TreeNode</span> <span class="variable">root</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">1</span>);</span><br><span class="line">root.left = <span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">2</span>);</span><br><span class="line">root.right = <span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">preorder(root);  <span class="comment">// 输出：1 2 3</span></span><br></pre></td></tr></table></figure>

<h4 id="执行过程-2"><a href="#执行过程-2" class="headerlink" title="执行过程"></a>执行过程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">preorder(node1)  // node1.val = 1</span><br><span class="line">  ↓ node1 != null</span><br><span class="line">  ↓ 打印 1</span><br><span class="line">  ↓ 调用 preorder(node2)  // 处理左子树</span><br><span class="line">    ↓ preorder(node2)  // node2.val = 2</span><br><span class="line">    ↓ node2 != null</span><br><span class="line">    ↓ 打印 2</span><br><span class="line">    ↓ 调用 preorder(null)  // 左子树为 null</span><br><span class="line">      ↓ return</span><br><span class="line">    ↓ 调用 preorder(null)  // 右子树为 null</span><br><span class="line">      ↓ return</span><br><span class="line">    ↓ return</span><br><span class="line">  ↓ 调用 preorder(node3)  // 处理右子树</span><br><span class="line">    ↓ preorder(node3)  // node3.val = 3</span><br><span class="line">    ↓ node3 != null</span><br><span class="line">    ↓ 打印 3</span><br><span class="line">    ↓ 调用 preorder(null)  // 左子树为 null</span><br><span class="line">      ↓ return</span><br><span class="line">    ↓ 调用 preorder(null)  // 右子树为 null</span><br><span class="line">      ↓ return</span><br><span class="line">    ↓ return</span><br><span class="line">  ↓ return</span><br></pre></td></tr></table></figure>

<p><strong>关键点</strong>：</p>
<ul>
<li>递归处理三个部分：根、左子树、右子树</li>
<li>每个递归调用都是独立的，处理一个子树</li>
<li>通过 <code>node == null</code> 判断是否继续递归</li>
</ul>
<hr>
<h2 id="四、递归的三个关键概念"><a href="#四、递归的三个关键概念" class="headerlink" title="四、递归的三个关键概念"></a>四、递归的三个关键概念</h2><h3 id="4-1-递归的”信任”"><a href="#4-1-递归的”信任”" class="headerlink" title="4.1 递归的”信任”"></a>4.1 递归的”信任”</h3><p><strong>关键思想</strong>：不要试图追踪整个递归过程，而是<strong>相信递归函数能正确处理更小的问题</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误的思维方式</span></span><br><span class="line"><span class="comment">// 试图追踪整个递归过程</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    preorder(node.left);   <span class="comment">// 我需要知道这里发生了什么...</span></span><br><span class="line">    preorder(node.right);  <span class="comment">// 还有这里...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确的思维方式</span></span><br><span class="line"><span class="comment">// 相信递归函数能正确处理子树</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 处理当前节点</span></span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 相信 preorder 能正确处理左子树</span></span><br><span class="line">    preorder(node.left);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 相信 preorder 能正确处理右子树</span></span><br><span class="line">    preorder(node.right);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键</strong>：</p>
<ul>
<li>不要试图在脑子里模拟整个递归过程</li>
<li>只需要确保：终止条件正确 + 递归关系正确</li>
<li>相信递归函数能处理更小的问题</li>
</ul>
<h3 id="4-2-递归的”分治”"><a href="#4-2-递归的”分治”" class="headerlink" title="4.2 递归的”分治”"></a>4.2 递归的”分治”</h3><p><strong>分治思想</strong>：将大问题分解为相同的小问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">大问题：遍历整个树</span><br><span class="line">  ↓ 分解</span><br><span class="line">小问题1：处理根节点</span><br><span class="line">小问题2：遍历左子树（与大问题相同，但规模更小）</span><br><span class="line">小问题3：遍历右子树（与大问题相同，但规模更小）</span><br><span class="line">  ↓ 递归处理小问题</span><br><span class="line">  ↓ 合并结果</span><br><span class="line">完成</span><br></pre></td></tr></table></figure>

<p><strong>关键</strong>：</p>
<ul>
<li>每次递归都在处理一个更小的问题</li>
<li>问题的结构相同，只是规模不同</li>
<li>最终会到达基础情况（终止条件）</li>
</ul>
<h3 id="4-3-递归的”回溯”"><a href="#4-3-递归的”回溯”" class="headerlink" title="4.3 递归的”回溯”"></a>4.3 递归的”回溯”</h3><p><strong>回溯思想</strong>：递归会自动回溯，逐层返回结果。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">递归下降：</span><br><span class="line">level 1 → level 2 → level 3 → ... → 基础情况</span><br><span class="line">                                      ↓</span><br><span class="line">回溯上升：</span><br><span class="line">level 1 ← level 2 ← level 3 ← ... ← 返回结果</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 后序遍历（回溯的典型应用）</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">postorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    postorder(node.left);   <span class="comment">// 先处理左子树</span></span><br><span class="line">    postorder(node.right);  <span class="comment">// 再处理右子树</span></span><br><span class="line">    System.out.println(node.val);  <span class="comment">// 最后处理根节点（回溯时）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行过程：</span></span><br><span class="line"><span class="comment">// 1. 递归下降到叶子节点</span></span><br><span class="line"><span class="comment">// 2. 回溯时处理节点（后序）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、递归-vs-迭代"><a href="#五、递归-vs-迭代" class="headerlink" title="五、递归 vs 迭代"></a>五、递归 vs 迭代</h2><h3 id="5-1-对比表"><a href="#5-1-对比表" class="headerlink" title="5.1 对比表"></a>5.1 对比表</h3><table>
<thead>
<tr>
<th>维度</th>
<th>递归</th>
<th>迭代</th>
</tr>
</thead>
<tbody><tr>
<td><strong>代码简洁性</strong></td>
<td>简洁、易读</td>
<td>复杂、需要手动管理状态</td>
</tr>
<tr>
<td><strong>空间复杂度</strong></td>
<td>O(h)（递归栈）</td>
<td>O(1)（通常）</td>
</tr>
<tr>
<td><strong>时间复杂度</strong></td>
<td>相同</td>
<td>相同</td>
</tr>
<tr>
<td><strong>栈溢出风险</strong></td>
<td>高（深度大时）</td>
<td>无</td>
</tr>
<tr>
<td><strong>理解难度</strong></td>
<td>需要理解递归思想</td>
<td>相对直观</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>略低（函数调用开销）</td>
<td>略高</td>
</tr>
</tbody></table>
<h3 id="5-2-递归-vs-迭代：链表遍历"><a href="#5-2-递归-vs-迭代：链表遍历" class="headerlink" title="5.2 递归 vs 迭代：链表遍历"></a>5.2 递归 vs 迭代：链表遍历</h3><h4 id="递归方式"><a href="#递归方式" class="headerlink" title="递归方式"></a>递归方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">traverse</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    traverse(node.next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优点：简洁、易读</span></span><br><span class="line"><span class="comment">// 缺点：占用栈空间，链表很长时可能栈溢出</span></span><br></pre></td></tr></table></figure>

<h4 id="迭代方式"><a href="#迭代方式" class="headerlink" title="迭代方式"></a>迭代方式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">traverse</span><span class="params">(ListNode node)</span> &#123;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">current</span> <span class="operator">=</span> node;</span><br><span class="line">    <span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">        System.out.println(current.val);</span><br><span class="line">        current = current.next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优点：不占用额外栈空间，效率高</span></span><br><span class="line"><span class="comment">// 缺点：需要手动管理指针</span></span><br></pre></td></tr></table></figure>

<h3 id="5-3-递归-vs-迭代：树遍历"><a href="#5-3-递归-vs-迭代：树遍历" class="headerlink" title="5.3 递归 vs 迭代：树遍历"></a>5.3 递归 vs 迭代：树遍历</h3><h4 id="递归方式（前序）"><a href="#递归方式（前序）" class="headerlink" title="递归方式（前序）"></a>递归方式（前序）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(node.val);</span><br><span class="line">    preorder(node.left);</span><br><span class="line">    preorder(node.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代码简洁，逻辑清晰</span></span><br></pre></td></tr></table></figure>

<h4 id="迭代方式（前序）"><a href="#迭代方式（前序）" class="headerlink" title="迭代方式（前序）"></a>迭代方式（前序）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">preorderIterative</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    stack.push(root);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">TreeNode</span> <span class="variable">node</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">        System.out.println(node.val);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (node.right != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.push(node.right);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (node.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            stack.push(node.left);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 需要手动管理栈，逻辑复杂</span></span><br></pre></td></tr></table></figure>

<p><strong>关键观察</strong>：</p>
<ul>
<li>递归本质上是利用系统栈</li>
<li>迭代是手动管理栈</li>
<li>递归简洁，迭代高效</li>
</ul>
<hr>
<h2 id="六、递归的常见陷阱"><a href="#六、递归的常见陷阱" class="headerlink" title="六、递归的常见陷阱"></a>六、递归的常见陷阱</h2><h3 id="6-1-陷阱1：没有终止条件"><a href="#6-1-陷阱1：没有终止条件" class="headerlink" title="6.1 陷阱1：没有终止条件"></a>6.1 陷阱1：没有终止条件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：无限递归</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n + <span class="number">1</span>);  <span class="comment">// 永远不会停止</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：有终止条件</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">10</span>) <span class="keyword">return</span>;  <span class="comment">// 终止条件</span></span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-陷阱2：终止条件永远不会到达"><a href="#6-2-陷阱2：终止条件永远不会到达" class="headerlink" title="6.2 陷阱2：终止条件永远不会到达"></a>6.2 陷阱2：终止条件永远不会到达</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：终止条件错误</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n - <span class="number">2</span>);  <span class="comment">// 如果 n 是奇数，永远不会等于 0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：终止条件正确</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) <span class="keyword">return</span>;  <span class="comment">// 包含所有停止情况</span></span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n - <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-陷阱3：问题没有真正分解"><a href="#6-3-陷阱3：问题没有真正分解" class="headerlink" title="6.3 陷阱3：问题没有真正分解"></a>6.3 陷阱3：问题没有真正分解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：问题没有变小</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n);  <span class="comment">// 问题大小没变，无限递归</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：问题逐步变小</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    System.out.println(n);</span><br><span class="line">    recursion(n - <span class="number">1</span>);  <span class="comment">// 问题逐步变小</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-陷阱4：栈溢出"><a href="#6-4-陷阱4：栈溢出" class="headerlink" title="6.4 陷阱4：栈溢出"></a>6.4 陷阱4：栈溢出</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 危险：递归深度太大</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line">    recursion(n - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">recursion(<span class="number">100000</span>);  <span class="comment">// 栈溢出！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 解决：使用迭代或增加栈大小</span></span><br><span class="line"><span class="comment">// 方式1：使用迭代</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">100000</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="comment">// 处理</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：增加栈大小（JVM 参数）</span></span><br><span class="line"><span class="comment">// java -Xss10m MyProgram</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、递归的应用场景"><a href="#七、递归的应用场景" class="headerlink" title="七、递归的应用场景"></a>七、递归的应用场景</h2><h3 id="7-1-适合用递归的场景"><a href="#7-1-适合用递归的场景" class="headerlink" title="7.1 适合用递归的场景"></a>7.1 适合用递归的场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>原因</th>
<th>例子</th>
</tr>
</thead>
<tbody><tr>
<td><strong>树&#x2F;图遍历</strong></td>
<td>天然的递归结构</td>
<td>前序、中序、后序遍历</td>
</tr>
<tr>
<td><strong>分治算法</strong></td>
<td>问题可分解</td>
<td>快速排序、归并排序</td>
</tr>
<tr>
<td><strong>回溯算法</strong></td>
<td>需要尝试所有可能</td>
<td>N 皇后、组合问题</td>
</tr>
<tr>
<td><strong>动态规划</strong></td>
<td>有重叠子问题</td>
<td>斐波那契数列</td>
</tr>
</tbody></table>
<h3 id="7-2-不适合用递归的场景"><a href="#7-2-不适合用递归的场景" class="headerlink" title="7.2 不适合用递归的场景"></a>7.2 不适合用递归的场景</h3><table>
<thead>
<tr>
<th>场景</th>
<th>原因</th>
<th>替代方案</th>
</tr>
</thead>
<tbody><tr>
<td><strong>线性遍历</strong></td>
<td>迭代更高效</td>
<td>使用 while 循环</td>
</tr>
<tr>
<td><strong>深度很大</strong></td>
<td>容易栈溢出</td>
<td>使用迭代或增加栈大小</td>
</tr>
<tr>
<td><strong>性能关键</strong></td>
<td>函数调用开销大</td>
<td>使用迭代</td>
</tr>
</tbody></table>
<hr>
<h2 id="八、递归的调试技巧"><a href="#八、递归的调试技巧" class="headerlink" title="八、递归的调试技巧"></a>八、递归的调试技巧</h2><h3 id="8-1-打印递归栈"><a href="#8-1-打印递归栈" class="headerlink" title="8.1 打印递归栈"></a>8.1 打印递归栈</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">preorder</span><span class="params">(TreeNode node, <span class="type">int</span> depth)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印缩进表示深度</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">indent</span> <span class="operator">=</span> <span class="string">&quot;  &quot;</span>.repeat(depth);</span><br><span class="line">    System.out.println(indent + <span class="string">&quot;进入: &quot;</span> + node.val);</span><br><span class="line">    </span><br><span class="line">    preorder(node.left, depth + <span class="number">1</span>);</span><br><span class="line">    preorder(node.right, depth + <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    System.out.println(indent + <span class="string">&quot;返回: &quot;</span> + node.val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="comment">// 进入: 1</span></span><br><span class="line"><span class="comment">//   进入: 2</span></span><br><span class="line"><span class="comment">//   返回: 2</span></span><br><span class="line"><span class="comment">//   进入: 3</span></span><br><span class="line"><span class="comment">//   返回: 3</span></span><br><span class="line"><span class="comment">// 返回: 1</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-验证终止条件"><a href="#8-2-验证终止条件" class="headerlink" title="8.2 验证终止条件"></a>8.2 验证终止条件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// 添加日志验证终止条件</span></span><br><span class="line">    System.out.println(<span class="string">&quot;递归调用: n = &quot;</span> + n);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;到达终止条件&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    recursion(n - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="8-3-检查问题分解"><a href="#8-3-检查问题分解" class="headerlink" title="8.3 检查问题分解"></a>8.3 检查问题分解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">recursion</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;处理问题大小: &quot;</span> + n);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 验证问题确实在变小</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextSize</span> <span class="operator">=</span> n - <span class="number">1</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;下一个问题大小: &quot;</span> + nextSize);</span><br><span class="line">    </span><br><span class="line">    recursion(nextSize);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、递归思维的培养"><a href="#九、递归思维的培养" class="headerlink" title="九、递归思维的培养"></a>九、递归思维的培养</h2><h3 id="9-1-三步法"><a href="#9-1-三步法" class="headerlink" title="9.1 三步法"></a>9.1 三步法</h3><p><strong>第1步</strong>：明确递归的三个要素</p>
<ul>
<li>终止条件是什么？</li>
<li>递归关系是什么？</li>
<li>如何分解问题？</li>
</ul>
<p><strong>第2步</strong>：相信递归</p>
<ul>
<li>不要试图追踪整个过程</li>
<li>只需确保逻辑正确</li>
<li>相信递归能处理更小的问题</li>
</ul>
<p><strong>第3步</strong>：验证</p>
<ul>
<li>测试基础情况</li>
<li>测试简单情况（n&#x3D;1, 2, 3）</li>
<li>测试复杂情况</li>
</ul>
<h3 id="9-2-练习建议"><a href="#9-2-练习建议" class="headerlink" title="9.2 练习建议"></a>9.2 练习建议</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从简单到复杂</span></span><br><span class="line"><span class="number">1.</span> 阶乘：factorial(n)</span><br><span class="line"><span class="number">2.</span> 斐波那契：fib(n)</span><br><span class="line"><span class="number">3.</span> 链表遍历：traverse(node)</span><br><span class="line"><span class="number">4.</span> 树遍历：preorder(node)</span><br><span class="line"><span class="number">5.</span> 二分查找：binarySearch(arr, target)</span><br><span class="line"><span class="number">6.</span> 快速排序：quickSort(arr)</span><br><span class="line"><span class="number">7.</span> 回溯：permutation(arr)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关笔记"><a href="#相关笔记" class="headerlink" title="相关笔记"></a>相关笔记</h2><ul>
<li>属性数据结构遍历详解</li>
<li>链表操作详解</li>
<li>树的操作详解</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Java%E5%BC%95%E7%94%A8%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">Java引用类型</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Java-引用类型"><a href="#Java-引用类型" class="headerlink" title="Java 引用类型"></a>Java 引用类型</h1><blockquote>
<p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 ThreadLocal原理-弱引用设计</p>
</blockquote>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java 从 JDK 1.2 开始提供了四种引用类型，用于更灵活地控制对象的生命周期和垃圾回收行为。</p>
<h2 id="四种引用类型"><a href="#四种引用类型" class="headerlink" title="四种引用类型"></a>四种引用类型</h2><table>
<thead>
<tr>
<th>引用类型</th>
<th>类</th>
<th>GC 回收时机</th>
<th>是否可获取对象</th>
</tr>
</thead>
<tbody><tr>
<td><strong>强引用</strong></td>
<td>直接引用</td>
<td>永不回收（除非不可达）</td>
<td>是</td>
</tr>
<tr>
<td><strong>软引用</strong></td>
<td><code>SoftReference</code></td>
<td>内存不足时回收</td>
<td>是（未回收前）</td>
</tr>
<tr>
<td><strong>弱引用</strong></td>
<td><code>WeakReference</code></td>
<td>下次 GC 时回收</td>
<td>是（未回收前）</td>
</tr>
<tr>
<td><strong>虚引用</strong></td>
<td><code>PhantomReference</code></td>
<td>随时可能回收</td>
<td>否</td>
</tr>
</tbody></table>
<p>^ref-types</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[引用强度] --&gt; B[强引用 Strong]</span><br><span class="line">    B --&gt; C[软引用 Soft]</span><br><span class="line">    C --&gt; D[弱引用 Weak]</span><br><span class="line">    D --&gt; E[虚引用 Phantom]</span><br><span class="line">    </span><br><span class="line">    style B fill:#ff6b6b</span><br><span class="line">    style C fill:#feca57</span><br><span class="line">    style D fill:#48dbfb</span><br><span class="line">    style E fill:#c8d6e5</span><br></pre></td></tr></table></figure>

<h2 id="详细说明"><a href="#详细说明" class="headerlink" title="详细说明"></a>详细说明</h2><h3 id="1-强引用（Strong-Reference）"><a href="#1-强引用（Strong-Reference）" class="headerlink" title="1. 强引用（Strong Reference）"></a>1. 强引用（Strong Reference）</h3><p>最常见的引用类型，只要强引用存在，对象就不会被 GC 回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();  <span class="comment">// 强引用</span></span><br><span class="line">obj = <span class="literal">null</span>;                 <span class="comment">// 断开引用后才可能被回收</span></span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：</p>
<ul>
<li>默认的引用类型</li>
<li>即使 OOM 也不会回收强引用对象</li>
<li>需要手动置 null 才能让 GC 回收</li>
</ul>
<h3 id="2-软引用（Soft-Reference）"><a href="#2-软引用（Soft-Reference）" class="headerlink" title="2. 软引用（Soft Reference）"></a>2. 软引用（Soft Reference）</h3><p>内存充足时不会回收，内存不足时会被回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SoftReference&lt;<span class="type">byte</span>[]&gt; softRef = <span class="keyword">new</span> <span class="title class_">SoftReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>]);</span><br><span class="line"></span><br><span class="line"><span class="type">byte</span>[] data = softRef.get();  <span class="comment">// 获取对象，可能为 null</span></span><br><span class="line"><span class="keyword">if</span> (data == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 对象已被回收，需要重新创建</span></span><br><span class="line">    data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span> * <span class="number">1024</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>应用场景</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>缓存</strong></td>
<td>图片缓存、网页缓存</td>
</tr>
<tr>
<td><strong>内存敏感数据</strong></td>
<td>可重建的大对象</td>
</tr>
</tbody></table>
<h3 id="3-弱引用（Weak-Reference）"><a href="#3-弱引用（Weak-Reference）" class="headerlink" title="3. 弱引用（Weak Reference）"></a>3. 弱引用（Weak Reference）</h3><p>只要发生 GC，无论内存是否充足，都会被回收。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> weakRef.get();  <span class="comment">// 可能返回 null</span></span><br><span class="line"><span class="keyword">if</span> (obj == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 对象已被 GC 回收</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>弱引用解决的问题</strong>：</p>
<blockquote>
<p><strong>⚠️ 重要: 核心价值</strong><br>弱引用允许对象在没有其他强引用时被 GC 回收，<strong>避免内存泄漏</strong>。</p>
</blockquote>
<p>以 ThreadLocal 为例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocalMap.Entry 的 key 使用弱引用</span><br><span class="line"></span><br><span class="line">场景：ThreadLocal 变量不再使用</span><br><span class="line">├── 如果 key 是强引用 → ThreadLocal 对象无法回收 → 内存泄漏</span><br><span class="line">└── 如果 key 是弱引用 → ThreadLocal 对象可被 GC 回收 → 避免泄漏</span><br></pre></td></tr></table></figure>

<p><strong>应用场景</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ThreadLocalMap</strong></td>
<td>Entry 的 key 使用弱引用</td>
</tr>
<tr>
<td><strong>WeakHashMap</strong></td>
<td>key 被回收后自动移除 entry</td>
</tr>
<tr>
<td><strong>监听器&#x2F;回调</strong></td>
<td>避免因注册监听器导致对象无法回收</td>
</tr>
</tbody></table>
<h3 id="4-虚引用（Phantom-Reference）"><a href="#4-虚引用（Phantom-Reference）" class="headerlink" title="4. 虚引用（Phantom Reference）"></a>4. 虚引用（Phantom Reference）</h3><p>最弱的引用，无法通过虚引用获取对象，主要用于跟踪对象被回收的状态。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">PhantomReference&lt;Object&gt; phantomRef = <span class="keyword">new</span> <span class="title class_">PhantomReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>(), queue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// get() 永远返回 null</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> phantomRef.get();  <span class="comment">// null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对象被回收后，虚引用会被放入队列</span></span><br><span class="line">Reference&lt;?&gt; ref = queue.poll();</span><br><span class="line"><span class="keyword">if</span> (ref != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 对象已被回收，执行清理操作</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>应用场景</strong>：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>资源清理</strong></td>
<td>替代 finalize() 进行资源释放</td>
</tr>
<tr>
<td><strong>堆外内存管理</strong></td>
<td>DirectByteBuffer 的 Cleaner 机制</td>
</tr>
<tr>
<td><strong>对象回收监控</strong></td>
<td>跟踪对象何时被 GC 回收</td>
</tr>
</tbody></table>
<h2 id="引用队列（ReferenceQueue）"><a href="#引用队列（ReferenceQueue）" class="headerlink" title="引用队列（ReferenceQueue）"></a>引用队列（ReferenceQueue）</h2><p>软引用、弱引用、虚引用都可以关联引用队列，当对象被回收时，引用对象会被放入队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">ReferenceQueue</span>&lt;&gt;();</span><br><span class="line">WeakReference&lt;Object&gt; weakRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Object</span>(), queue);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GC 后检查队列</span></span><br><span class="line">System.gc();</span><br><span class="line">Reference&lt;?&gt; ref = queue.poll();</span><br><span class="line"><span class="keyword">if</span> (ref == weakRef) &#123;</span><br><span class="line">    <span class="comment">// 弱引用指向的对象已被回收</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h2><table>
<thead>
<tr>
<th>特性</th>
<th>强引用</th>
<th>软引用</th>
<th>弱引用</th>
<th>虚引用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>回收时机</strong></td>
<td>不可达时</td>
<td>内存不足时</td>
<td>GC 时</td>
<td>随时</td>
</tr>
<tr>
<td><strong>get() 返回</strong></td>
<td>对象</td>
<td>对象&#x2F;null</td>
<td>对象&#x2F;null</td>
<td>null</td>
</tr>
<tr>
<td><strong>典型用途</strong></td>
<td>普通对象</td>
<td>缓存</td>
<td>避免内存泄漏</td>
<td>回收跟踪</td>
</tr>
<tr>
<td><strong>是否需要队列</strong></td>
<td>-</td>
<td>可选</td>
<td>可选</td>
<td>必须</td>
</tr>
</tbody></table>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Java&#x2F;并发编程&#x2F;基础知识&#x2F;ThreadLocal原理 - 衍生来源，弱引用的典型应用</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Flux%E6%98%AF%E7%AE%A1%E9%81%93%E4%B8%8D%E6%98%AF%E5%AE%B9%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Flux%E6%98%AF%E7%AE%A1%E9%81%93%E4%B8%8D%E6%98%AF%E5%AE%B9%E5%99%A8/" class="post-title-link" itemprop="url">Flux是管道不是容器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flux-是管道，不是容器"><a href="#Flux-是管道，不是容器" class="headerlink" title="Flux 是管道，不是容器"></a>Flux 是管道，不是容器</h1><h2 id="常见误解"><a href="#常见误解" class="headerlink" title="常见误解"></a>常见误解</h2><p>很多人初学 Reactor 时会有这样的误解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误理解：Flux 就像 List，是装数据的容器</span></span><br><span class="line">List&lt;String&gt; list = Arrays.asList(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);  <span class="comment">// 3个元素，确定的</span></span><br><span class="line">Flux&lt;String&gt; flux = Flux.just(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>);      <span class="comment">// 也是3个元素，确定的？</span></span><br></pre></td></tr></table></figure>

<p>这种理解在简单场景下没问题，但会导致无法理解复杂场景。</p>
<hr>
<h2 id="正确理解：Flux-是数据管道"><a href="#正确理解：Flux-是数据管道" class="headerlink" title="正确理解：Flux 是数据管道"></a>正确理解：Flux 是数据管道</h2><h3 id="管道-vs-容器"><a href="#管道-vs-容器" class="headerlink" title="管道 vs 容器"></a>管道 vs 容器</h3><table>
<thead>
<tr>
<th>概念</th>
<th>容器（List）</th>
<th>管道（Flux）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>数据存储</strong></td>
<td>数据存在内存中</td>
<td>数据流经管道</td>
</tr>
<tr>
<td><strong>数据时机</strong></td>
<td>创建时就有</td>
<td>订阅后才开始流动</td>
</tr>
<tr>
<td><strong>数据来源</strong></td>
<td>已知、固定</td>
<td>可以是任何源头</td>
</tr>
<tr>
<td><strong>数据数量</strong></td>
<td>确定的</td>
<td>可能不确定</td>
</tr>
<tr>
<td><strong>生命周期</strong></td>
<td>一直存在</td>
<td>流完就结束</td>
</tr>
</tbody></table>
<h3 id="形象比喻"><a href="#形象比喻" class="headerlink" title="形象比喻"></a>形象比喻</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">容器（List）像一个水桶：</span><br><span class="line">┌─────────┐</span><br><span class="line">│  水水水  │  ← 水已经在桶里了</span><br><span class="line">│  水水水  │</span><br><span class="line">└─────────┘</span><br><span class="line"></span><br><span class="line">管道（Flux）像一根水管：</span><br><span class="line">                    ┌─────────┐</span><br><span class="line">水源 ════════════════│  水管   │════════════════▶ 出水口</span><br><span class="line">（上游）              └─────────┘                 （下游）</span><br><span class="line">                         ↑</span><br><span class="line">                    水流经这里</span><br><span class="line">                    但不存储在这里</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实际案例：调用大模型-API"><a href="#实际案例：调用大模型-API" class="headerlink" title="实际案例：调用大模型 API"></a>实际案例：调用大模型 API</h2><h3 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h3><p>调用 OpenAI&#x2F;Claude 等大模型 API，返回流式响应：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;String&gt; response = webClient.post()</span><br><span class="line">    .uri(<span class="string">&quot;https://api.openai.com/v1/chat/completions&quot;</span>)</span><br><span class="line">    .header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">    .bodyValue(Map.of(</span><br><span class="line">        <span class="string">&quot;model&quot;</span>, <span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">        <span class="string">&quot;messages&quot;</span>, List.of(Map.of(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>, <span class="string">&quot;你好&quot;</span>)),</span><br><span class="line">        <span class="string">&quot;stream&quot;</span>, <span class="literal">true</span></span><br><span class="line">    ))</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToFlux(String.class);</span><br></pre></td></tr></table></figure>

<h3 id="问题：Flux-里有多少数据？"><a href="#问题：Flux-里有多少数据？" class="headerlink" title="问题：Flux 里有多少数据？"></a>问题：Flux 里有多少数据？</h3><p><strong>答案：不知道，也不需要知道！</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个 Flux 创建时，大模型还没开始回复</span></span><br><span class="line"><span class="comment">// 数据量完全取决于大模型要说多少话</span></span><br><span class="line">Flux&lt;String&gt; response = callLLM(<span class="string">&quot;请介绍一下自己&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可能返回 10 个 chunk，也可能返回 100 个</span></span><br><span class="line"><span class="comment">// Flux 不关心，它只负责把数据从上游传到下游</span></span><br></pre></td></tr></table></figure>

<h3 id="数据流动过程"><a href="#数据流动过程" class="headerlink" title="数据流动过程"></a>数据流动过程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        时间线                                    │</span><br><span class="line">├─────────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T0: 创建 Flux                                                  │</span><br><span class="line">│      Flux&lt;String&gt; flux = callLLM(prompt);                       │</span><br><span class="line">│      此时：管道已建立，但没有数据流动                              │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T1: 订阅 Flux                                                  │</span><br><span class="line">│      flux.subscribe(chunk -&gt; print(chunk));                     │</span><br><span class="line">│      此时：向上游发送请求，开始等待数据                            │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T2: 大模型开始回复                                              │</span><br><span class="line">│      上游发送 onNext(&quot;你&quot;)                                       │</span><br><span class="line">│      下游收到 &quot;你&quot;，打印                                         │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T3: 大模型继续回复                                              │</span><br><span class="line">│      上游发送 onNext(&quot;好&quot;)                                       │</span><br><span class="line">│      下游收到 &quot;好&quot;，打印                                         │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T4: 大模型继续回复                                              │</span><br><span class="line">│      上游发送 onNext(&quot;，我是AI助手&quot;)                             │</span><br><span class="line">│      下游收到，打印                                              │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  T5: 大模型回复完毕                                              │</span><br><span class="line">│      上游发送 onComplete()                                       │</span><br><span class="line">│      下游知道流结束了                                            │</span><br><span class="line">│                                                                 │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/chat&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestParam</span> String prompt)</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1. 创建 Flux（此时没有数据）</span></span><br><span class="line">    Flux&lt;String&gt; response = webClient.post()</span><br><span class="line">        .uri(<span class="string">&quot;/v1/chat/completions&quot;</span>)</span><br><span class="line">        .bodyValue(buildRequest(prompt))</span><br><span class="line">        .retrieve()</span><br><span class="line">        .bodyToFlux(ChatResponse.class)</span><br><span class="line">        .map(r -&gt; r.getChoices().get(<span class="number">0</span>).getDelta().getContent())</span><br><span class="line">        .filter(Objects::nonNull);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 返回 Flux（Spring WebFlux 会自动订阅并流式返回给前端）</span></span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 前端会逐字收到大模型的回复</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Flux-的数据来源"><a href="#Flux-的数据来源" class="headerlink" title="Flux 的数据来源"></a>Flux 的数据来源</h2><p>Flux 的数据可以来自各种源头：</p>
<h3 id="1-静态数据（确定的）"><a href="#1-静态数据（确定的）" class="headerlink" title="1. 静态数据（确定的）"></a>1. 静态数据（确定的）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据在创建时就确定了</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">Flux.fromIterable(list);</span><br><span class="line">Flux.fromArray(array);</span><br></pre></td></tr></table></figure>

<h3 id="2-生成规则（按规则产生）"><a href="#2-生成规则（按规则产生）" class="headerlink" title="2. 生成规则（按规则产生）"></a>2. 生成规则（按规则产生）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 按规则生成，数量可能无限</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>);                    <span class="comment">// 1到100</span></span><br><span class="line">Flux.interval(Duration.ofSeconds(<span class="number">1</span>));  <span class="comment">// 每秒一个，无限</span></span><br></pre></td></tr></table></figure>

<h3 id="3-外部数据源（不确定的）"><a href="#3-外部数据源（不确定的）" class="headerlink" title="3. 外部数据源（不确定的）"></a>3. 外部数据源（不确定的）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据来自外部，数量不确定</span></span><br><span class="line">Flux&lt;String&gt; httpResponse = webClient.get().retrieve().bodyToFlux(String.class);</span><br><span class="line">Flux&lt;Message&gt; kafkaMessages = kafkaReceiver.receive();</span><br><span class="line">Flux&lt;String&gt; websocketMessages = session.receive().map(WebSocketMessage::getPayloadAsText);</span><br><span class="line">Flux&lt;String&gt; fileLines = Flux.using(</span><br><span class="line">    () -&gt; Files.lines(path),</span><br><span class="line">    Flux::fromStream,</span><br><span class="line">    Stream::close</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="4-手动推送（Sinks）"><a href="#4-手动推送（Sinks）" class="headerlink" title="4. 手动推送（Sinks）"></a>4. 手动推送（Sinks）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 你自己决定什么时候发送什么数据</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息1&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息2&quot;</span>);</span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Flux-怎么知道数据结束？"><a href="#Flux-怎么知道数据结束？" class="headerlink" title="Flux 怎么知道数据结束？"></a>Flux 怎么知道数据结束？</h2><h3 id="三种终止信号"><a href="#三种终止信号" class="headerlink" title="三种终止信号"></a>三种终止信号</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flux.subscribe(</span><br><span class="line">    data -&gt; &#123; &#125;,           <span class="comment">// onNext: 收到数据</span></span><br><span class="line">    error -&gt; &#123; &#125;,          <span class="comment">// onError: 发生错误，流终止</span></span><br><span class="line">    () -&gt; &#123; &#125;              <span class="comment">// onComplete: 正常完成，流终止</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="谁发送终止信号？"><a href="#谁发送终止信号？" class="headerlink" title="谁发送终止信号？"></a>谁发送终止信号？</h3><p><strong>上游（生产者）决定何时结束</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例1：静态数据 - 发完就结束</span></span><br><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"><span class="comment">// 内部：onNext(1), onNext(2), onNext(3), onComplete()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例2：HTTP 响应 - 服务端关闭连接时结束</span></span><br><span class="line">webClient.get().retrieve().bodyToFlux(String.class);</span><br><span class="line"><span class="comment">// 内部：onNext(chunk1), onNext(chunk2), ..., onComplete()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例3：无限流 - 永不结束（除非出错或取消）</span></span><br><span class="line">Flux.interval(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"><span class="comment">// 内部：onNext(0), onNext(1), onNext(2), ... (永远继续)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例4：手动控制 - 你决定何时结束</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().unicast().onBackpressureBuffer();</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">sink.tryEmitComplete();  <span class="comment">// 你决定结束</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="对比：什么时候用-Flux，什么时候用-Sinks"><a href="#对比：什么时候用-Flux，什么时候用-Sinks" class="headerlink" title="对比：什么时候用 Flux，什么时候用 Sinks"></a>对比：什么时候用 Flux，什么时候用 Sinks</h2><h3 id="你是消费者-→-用-Flux"><a href="#你是消费者-→-用-Flux" class="headerlink" title="你是消费者 → 用 Flux"></a>你是消费者 → 用 Flux</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：调用别人的 API，接收数据</span></span><br><span class="line">Flux&lt;String&gt; response = callExternalAPI();</span><br><span class="line">response.subscribe(data -&gt; process(data));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景：从数据库查询</span></span><br><span class="line">Flux&lt;User&gt; users = userRepository.findAll();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景：读取文件</span></span><br><span class="line">Flux&lt;String&gt; lines = readFileLines(path);</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：数据由别人产生，你只需要接收和处理。</p>
<h3 id="你是生产者-→-用-Sinks"><a href="#你是生产者-→-用-Sinks" class="headerlink" title="你是生产者 → 用 Sinks"></a>你是生产者 → 用 Sinks</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：WebSocket 服务端，主动推送消息</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在某个事件触发时发送数据</span></span><br><span class="line"><span class="meta">@EventListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUserLogin</span><span class="params">(UserLoginEvent event)</span> &#123;</span><br><span class="line">    sink.tryEmitNext(<span class="string">&quot;用户 &quot;</span> + event.getUsername() + <span class="string">&quot; 登录了&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端订阅这个流</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getNotifications</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sink.asFlux();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点</strong>：数据由你产生，你需要主动推送。</p>
<h3 id="对比表"><a href="#对比表" class="headerlink" title="对比表"></a>对比表</h3><table>
<thead>
<tr>
<th>场景</th>
<th>角色</th>
<th>使用</th>
<th>数据来源</th>
</tr>
</thead>
<tbody><tr>
<td>调用 HTTP API</td>
<td>消费者</td>
<td>Flux</td>
<td>服务端返回</td>
</tr>
<tr>
<td>查询数据库</td>
<td>消费者</td>
<td>Flux</td>
<td>数据库返回</td>
</tr>
<tr>
<td>读取消息队列</td>
<td>消费者</td>
<td>Flux</td>
<td>队列推送</td>
</tr>
<tr>
<td>WebSocket 推送</td>
<td>生产者</td>
<td>Sinks</td>
<td>你主动发送</td>
</tr>
<tr>
<td>事件广播</td>
<td>生产者</td>
<td>Sinks</td>
<td>你主动发送</td>
</tr>
<tr>
<td>封装回调 API</td>
<td>生产者</td>
<td>Sinks</td>
<td>回调触发时发送</td>
</tr>
</tbody></table>
<hr>
<h2 id="深入理解：懒加载与订阅"><a href="#深入理解：懒加载与订阅" class="headerlink" title="深入理解：懒加载与订阅"></a>深入理解：懒加载与订阅</h2><h3 id="Flux-是懒加载的"><a href="#Flux-是懒加载的" class="headerlink" title="Flux 是懒加载的"></a>Flux 是懒加载的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这行代码执行时，并没有真正调用 API</span></span><br><span class="line">Flux&lt;String&gt; flux = webClient.get().uri(<span class="string">&quot;/api&quot;</span>).retrieve().bodyToFlux(String.class);</span><br><span class="line">System.out.println(<span class="string">&quot;Flux 创建完成&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只有订阅时，才真正发起请求</span></span><br><span class="line">flux.subscribe(data -&gt; System.out.println(<span class="string">&quot;收到: &quot;</span> + data));</span><br><span class="line">System.out.println(<span class="string">&quot;订阅完成&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出顺序：</span></span><br><span class="line"><span class="comment">// Flux 创建完成</span></span><br><span class="line"><span class="comment">// 订阅完成</span></span><br><span class="line"><span class="comment">// 收到: xxx（异步，稍后输出）</span></span><br></pre></td></tr></table></figure>

<h3 id="每次订阅都是独立的"><a href="#每次订阅都是独立的" class="headerlink" title="每次订阅都是独立的"></a>每次订阅都是独立的</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;String&gt; flux = webClient.get().uri(<span class="string">&quot;/api/random&quot;</span>).retrieve().bodyToFlux(String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一次订阅 - 发起第一次请求</span></span><br><span class="line">flux.subscribe(data -&gt; System.out.println(<span class="string">&quot;订阅1: &quot;</span> + data));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二次订阅 - 发起第二次请求（独立的）</span></span><br><span class="line">flux.subscribe(data -&gt; System.out.println(<span class="string">&quot;订阅2: &quot;</span> + data));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 两次订阅可能收到不同的数据！</span></span><br></pre></td></tr></table></figure>

<h3 id="冷流-vs-热流"><a href="#冷流-vs-热流" class="headerlink" title="冷流 vs 热流"></a>冷流 vs 热流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 冷流：每个订阅者都从头开始</span></span><br><span class="line">Flux&lt;Integer&gt; cold = Flux.range(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">cold.subscribe(i -&gt; System.out.println(<span class="string">&quot;A: &quot;</span> + i));  <span class="comment">// A: 1, 2, 3</span></span><br><span class="line">cold.subscribe(i -&gt; System.out.println(<span class="string">&quot;B: &quot;</span> + i));  <span class="comment">// B: 1, 2, 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 热流：订阅者共享数据流</span></span><br><span class="line">Sinks.Many&lt;Integer&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">Flux&lt;Integer&gt; hot = sink.asFlux();</span><br><span class="line"></span><br><span class="line">hot.subscribe(i -&gt; System.out.println(<span class="string">&quot;A: &quot;</span> + i));</span><br><span class="line">sink.tryEmitNext(<span class="number">1</span>);  <span class="comment">// A: 1</span></span><br><span class="line">hot.subscribe(i -&gt; System.out.println(<span class="string">&quot;B: &quot;</span> + i));</span><br><span class="line">sink.tryEmitNext(<span class="number">2</span>);  <span class="comment">// A: 2, B: 2（B 没收到 1）</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战：大模型流式调用完整示例"><a href="#实战：大模型流式调用完整示例" class="headerlink" title="实战：大模型流式调用完整示例"></a>实战：大模型流式调用完整示例</h2><h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/chat&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">chat</span><span class="params">(<span class="meta">@RequestParam</span> String prompt)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.post()</span><br><span class="line">            .uri(<span class="string">&quot;https://api.openai.com/v1/chat/completions&quot;</span>)</span><br><span class="line">            .header(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer &quot;</span> + apiKey)</span><br><span class="line">            .bodyValue(Map.of(</span><br><span class="line">                <span class="string">&quot;model&quot;</span>, <span class="string">&quot;gpt-4&quot;</span>,</span><br><span class="line">                <span class="string">&quot;messages&quot;</span>, List.of(Map.of(<span class="string">&quot;role&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="string">&quot;content&quot;</span>, prompt)),</span><br><span class="line">                <span class="string">&quot;stream&quot;</span>, <span class="literal">true</span></span><br><span class="line">            ))</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToFlux(String.class)</span><br><span class="line">            .filter(line -&gt; !line.equals(<span class="string">&quot;[DONE]&quot;</span>))</span><br><span class="line">            .map(<span class="built_in">this</span>::extractContent)</span><br><span class="line">            .filter(Objects::nonNull)</span><br><span class="line">            .doOnNext(chunk -&gt; log.debug(<span class="string">&quot;发送: &#123;&#125;&quot;</span>, chunk))</span><br><span class="line">            .doOnComplete(() -&gt; log.info(<span class="string">&quot;流式响应完成&quot;</span>))</span><br><span class="line">            .doOnError(e -&gt; log.error(<span class="string">&quot;流式响应错误&quot;</span>, e));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractContent</span><span class="params">(String line)</span> &#123;</span><br><span class="line">        <span class="comment">// 解析 SSE 数据，提取内容</span></span><br><span class="line">        <span class="comment">// data: &#123;&quot;choices&quot;:[&#123;&quot;delta&quot;:&#123;&quot;content&quot;:&quot;你好&quot;&#125;&#125;]&#125;</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">JsonNode</span> <span class="variable">node</span> <span class="operator">=</span> objectMapper.readTree(line.substring(<span class="number">6</span>));</span><br><span class="line">            <span class="keyword">return</span> node.at(<span class="string">&quot;/choices/0/delta/content&quot;</span>).asText(<span class="literal">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端接收"><a href="#前端接收" class="headerlink" title="前端接收"></a>前端接收</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 EventSource 接收 SSE</span></span><br><span class="line"><span class="keyword">const</span> eventSource = <span class="keyword">new</span> <span class="title class_">EventSource</span>(<span class="string">&#x27;/api/chat?prompt=你好&#x27;</span>);</span><br><span class="line"></span><br><span class="line">eventSource.<span class="property">onmessage</span> = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 逐字显示</span></span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;response&#x27;</span>).<span class="property">textContent</span> += event.<span class="property">data</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">eventSource.<span class="property">onerror</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    eventSource.<span class="title function_">close</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者使用 fetch</span></span><br><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;/api/chat?prompt=你好&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> reader = response.<span class="property">body</span>.<span class="title function_">getReader</span>();</span><br><span class="line"><span class="keyword">const</span> decoder = <span class="keyword">new</span> <span class="title class_">TextDecoder</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; done, value &#125; = <span class="keyword">await</span> reader.<span class="title function_">read</span>();</span><br><span class="line">    <span class="keyword">if</span> (done) <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">const</span> chunk = decoder.<span class="title function_">decode</span>(value);</span><br><span class="line">    <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;response&#x27;</span>).<span class="property">textContent</span> += chunk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Flux 是管道</strong></td>
<td>数据流经管道，不存储在管道中</td>
</tr>
<tr>
<td><strong>数据何时确定</strong></td>
<td>取决于上游，可能创建时确定，也可能运行时才知道</td>
</tr>
<tr>
<td><strong>数据数量</strong></td>
<td>由上游决定，下游不需要提前知道</td>
</tr>
<tr>
<td><strong>流何时结束</strong></td>
<td>上游发送 <code>onComplete()</code> 或 <code>onError()</code></td>
</tr>
<tr>
<td><strong>懒加载</strong></td>
<td>创建 Flux 不执行，订阅时才执行</td>
</tr>
<tr>
<td><strong>Sinks 的作用</strong></td>
<td>让你成为上游，主动推送数据</td>
</tr>
</tbody></table>
<p><strong>核心理解</strong>：</p>
<ul>
<li>Flux 不是”装了多少数据”，而是”数据从哪来、往哪去”</li>
<li>你不需要知道 Flux 里有多少数据，只需要处理流过来的每一个数据</li>
<li>这就是响应式编程的核心思想：<strong>对数据流做出响应</strong></li>
</ul>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Sinks 详解</li>
<li>Project Reactor 实现</li>
<li>WebFlux - Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/ForkJoinPool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/ForkJoinPool/" class="post-title-link" itemprop="url">ForkJoinPool</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" itemprop="url" rel="index"><span itemprop="name">线程池</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h1><blockquote>
<p><strong>ℹ️ 信息: 衍生来源</strong><br>本笔记衍生自 线程池类型-WorkStealingPool</p>
</blockquote>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>ForkJoinPool</code> 是 Java 7 引入的特殊线程池，专为<strong>分治算法</strong>和<strong>并行计算</strong>设计。它是 <code>ExecutorService</code> 的实现，但采用了完全不同的任务调度策略。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        ForkJoinPool                            │</span><br><span class="line">├────────────────────────────────────────────────────────────────┤</span><br><span class="line">│  核心思想: Fork（拆分） + Join（合并）                          │</span><br><span class="line">│  调度策略: Work-Stealing（工作窃取）                            │</span><br><span class="line">│  适用场景: 递归任务、并行计算、分治算法                          │</span><br><span class="line">└────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="Fork-与-Join"><a href="#Fork-与-Join" class="headerlink" title="Fork 与 Join"></a>Fork 与 Join</h3><table>
<thead>
<tr>
<th>操作</th>
<th>说明</th>
<th>方法</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Fork</strong></td>
<td>将大任务拆分成小任务，异步执行</td>
<td><code>task.fork()</code></td>
</tr>
<tr>
<td><strong>Join</strong></td>
<td>等待子任务完成，获取结果</td>
<td><code>task.join()</code></td>
</tr>
</tbody></table>
<h3 id="分治思想图解"><a href="#分治思想图解" class="headerlink" title="分治思想图解"></a>分治思想图解</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">            ┌─────────────┐</span><br><span class="line">            │   大任务    │</span><br><span class="line">            └──────┬──────┘</span><br><span class="line">                   │ fork</span><br><span class="line">      ┌────────────┼────────────┐</span><br><span class="line">      ▼            ▼            ▼</span><br><span class="line">┌─────────┐  ┌─────────┐  ┌─────────┐</span><br><span class="line">│ 子任务1 │  │ 子任务2 │  │ 子任务3 │</span><br><span class="line">└────┬────┘  └────┬────┘  └────┬────┘</span><br><span class="line">     │            │            │</span><br><span class="line">     ▼            ▼            ▼</span><br><span class="line">┌─────────┐  ┌─────────┐  ┌─────────┐</span><br><span class="line">│ 结果1   │  │ 结果2   │  │ 结果3   │</span><br><span class="line">└────┬────┘  └────┬────┘  └────┬────┘</span><br><span class="line">     │            │            │</span><br><span class="line">     └────────────┼────────────┘</span><br><span class="line">                  │ join</span><br><span class="line">            ┌─────┴─────┐</span><br><span class="line">            │  合并结果  │</span><br><span class="line">            └───────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="工作窃取算法（Work-Stealing）"><a href="#工作窃取算法（Work-Stealing）" class="headerlink" title="工作窃取算法（Work-Stealing）"></a>工作窃取算法（Work-Stealing）</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>每个工作线程维护一个<strong>双端队列（Deque）</strong>：</p>
<ul>
<li><strong>自己的任务</strong>：从队列<strong>头部</strong>取（LIFO）</li>
<li><strong>窃取他人任务</strong>：从队列<strong>尾部</strong>取（FIFO）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     ForkJoinPool                                │</span><br><span class="line">│                                                                 │</span><br><span class="line">│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │</span><br><span class="line">│  │  Worker-1   │    │  Worker-2   │    │  Worker-3   │         │</span><br><span class="line">│  ├─────────────┤    ├─────────────┤    ├─────────────┤         │</span><br><span class="line">│  │ 头 [T1]     │    │ 头 [T4]     │    │ 头 [空闲]   │         │</span><br><span class="line">│  │    [T2]     │    │    [T5]     │    │             │         │</span><br><span class="line">│  │    [T3]     │    │             │    │             │         │</span><br><span class="line">│  │ 尾          │    │ 尾          │    │ 尾    ↑     │         │</span><br><span class="line">│  └─────────────┘    └─────────────┘    └──────┼──────┘         │</span><br><span class="line">│         │                  │                  │                │</span><br><span class="line">│         │                  └──────────────────┘                │</span><br><span class="line">│         │                    Worker-3 从 Worker-2 尾部窃取 T5   │</span><br><span class="line">└─────────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h3 id="为什么从尾部窃取？"><a href="#为什么从尾部窃取？" class="headerlink" title="为什么从尾部窃取？"></a>为什么从尾部窃取？</h3><table>
<thead>
<tr>
<th>原因</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>减少竞争</strong></td>
<td>工作线程从头部取，窃取从尾部，避免锁争用</td>
</tr>
<tr>
<td><strong>任务特性</strong></td>
<td>尾部通常是较大的任务（刚 fork 出来的），窃取后可继续拆分</td>
</tr>
<tr>
<td><strong>局部性</strong></td>
<td>头部任务是最近提交的，缓存友好</td>
</tr>
</tbody></table>
<hr>
<h2 id="核心类结构"><a href="#核心类结构" class="headerlink" title="核心类结构"></a>核心类结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌───────────────────────────────────────┐</span><br><span class="line">│          ForkJoinTask&lt;V&gt;              │  抽象基类</span><br><span class="line">│  ├── fork()    异步执行               │</span><br><span class="line">│  ├── join()    等待结果               │</span><br><span class="line">│  └── invoke()  同步执行               │</span><br><span class="line">└───────────────┬───────────────────────┘</span><br><span class="line">                │</span><br><span class="line">        ┌───────┴───────┐</span><br><span class="line">        ▼               ▼</span><br><span class="line">┌───────────────┐ ┌─────────────────┐</span><br><span class="line">│RecursiveTask  │ │ RecursiveAction │</span><br><span class="line">│   &lt;V&gt;         │ │                 │</span><br><span class="line">├───────────────┤ ├─────────────────┤</span><br><span class="line">│ 有返回值      │ │ 无返回值        │</span><br><span class="line">│ compute()→V   │ │ compute()→void  │</span><br><span class="line">└───────────────┘ └─────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><h3 id="1-RecursiveTask：有返回值（数组求和）"><a href="#1-RecursiveTask：有返回值（数组求和）" class="headerlink" title="1. RecursiveTask：有返回值（数组求和）"></a>1. RecursiveTask：有返回值（数组求和）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SumTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Long&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">1000</span>;  <span class="comment">// 阈值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span>[] array;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SumTask</span><span class="params">(<span class="type">long</span>[] array, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.array = array;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">length</span> <span class="operator">=</span> end - start;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 任务足够小，直接计算</span></span><br><span class="line">        <span class="keyword">if</span> (length &lt;= THRESHOLD) &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt; end; i++) &#123;</span><br><span class="line">                sum += array[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 拆分任务</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> start + length / <span class="number">2</span>;</span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">leftTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, start, mid);</span><br><span class="line">        <span class="type">SumTask</span> <span class="variable">rightTask</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, mid, end);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 异步执行左半部分</span></span><br><span class="line">        leftTask.fork();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 同步执行右半部分（当前线程）</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">rightResult</span> <span class="operator">=</span> rightTask.compute();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待左半部分完成并合并结果</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">leftResult</span> <span class="operator">=</span> leftTask.join();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> leftResult + rightResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">long</span>[] array = <span class="keyword">new</span> <span class="title class_">long</span>[<span class="number">10000000</span>];</span><br><span class="line">    Arrays.fill(array, <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> ForkJoinPool.commonPool();</span><br><span class="line">    <span class="type">SumTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, <span class="number">0</span>, array.length);</span><br><span class="line">    </span><br><span class="line">    <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> pool.invoke(task);  <span class="comment">// 同步执行</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Sum: &quot;</span> + result);  <span class="comment">// 输出: Sum: 10000000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-RecursiveAction：无返回值（并行排序）"><a href="#2-RecursiveAction：无返回值（并行排序）" class="headerlink" title="2. RecursiveAction：无返回值（并行排序）"></a>2. RecursiveAction：无返回值（并行排序）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParallelMergeSort</span> <span class="keyword">extends</span> <span class="title class_">RecursiveAction</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span>[] array;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParallelMergeSort</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.array = array;</span><br><span class="line">        <span class="built_in">this</span>.start = start;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (end - start &lt;= THRESHOLD) &#123;</span><br><span class="line">            <span class="comment">// 小数组直接用 Arrays.sort</span></span><br><span class="line">            Arrays.sort(array, start, end);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (start + end) / <span class="number">2</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 并行排序两半</span></span><br><span class="line">        <span class="type">ParallelMergeSort</span> <span class="variable">left</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParallelMergeSort</span>(array, start, mid);</span><br><span class="line">        <span class="type">ParallelMergeSort</span> <span class="variable">right</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParallelMergeSort</span>(array, mid, end);</span><br><span class="line">        </span><br><span class="line">        invokeAll(left, right);  <span class="comment">// 并行执行两个任务</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 合并已排序的两半</span></span><br><span class="line">        merge(array, start, mid, end);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">merge</span><span class="params">(<span class="type">int</span>[] array, <span class="type">int</span> start, <span class="type">int</span> mid, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="comment">// 合并逻辑...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="ForkJoinPool-创建方式"><a href="#ForkJoinPool-创建方式" class="headerlink" title="ForkJoinPool 创建方式"></a>ForkJoinPool 创建方式</h2><h3 id="1-公共池（推荐）"><a href="#1-公共池（推荐）" class="headerlink" title="1. 公共池（推荐）"></a>1. 公共池（推荐）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取公共池（JVM 共享，线程数 = CPU核心数 - 1）</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">commonPool</span> <span class="operator">=</span> ForkJoinPool.commonPool();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接使用</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> commonPool.invoke(task);</span><br></pre></td></tr></table></figure>

<h3 id="2-自定义池"><a href="#2-自定义池" class="headerlink" title="2. 自定义池"></a>2. 自定义池</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义线程数</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">customPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 完整构造函数</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(</span><br><span class="line">    <span class="number">4</span>,                                    <span class="comment">// 并行度</span></span><br><span class="line">    ForkJoinPool.defaultForkJoinWorkerThreadFactory,  <span class="comment">// 线程工厂</span></span><br><span class="line">    <span class="literal">null</span>,                                 <span class="comment">// 异常处理器</span></span><br><span class="line">    <span class="literal">true</span>                                  <span class="comment">// asyncMode（true=FIFO，false=LIFO）</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="3-通过-Executors-工厂"><a href="#3-通过-Executors-工厂" class="headerlink" title="3. 通过 Executors 工厂"></a>3. 通过 Executors 工厂</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java 8+ WorkStealingPool 底层就是 ForkJoinPool</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newWorkStealingPool();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="提交任务的方式"><a href="#提交任务的方式" class="headerlink" title="提交任务的方式"></a>提交任务的方式</h2><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td><code>invoke(task)</code></td>
<td>同步执行，阻塞直到完成</td>
<td>任务结果</td>
</tr>
<tr>
<td><code>execute(task)</code></td>
<td>异步执行，不等待结果</td>
<td>void</td>
</tr>
<tr>
<td><code>submit(task)</code></td>
<td>异步执行，返回 Future</td>
<td><code>ForkJoinTask&lt;V&gt;</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> ForkJoinPool.commonPool();</span><br><span class="line"><span class="type">SumTask</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SumTask</span>(array, <span class="number">0</span>, array.length);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1：同步</span></span><br><span class="line"><span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> pool.invoke(task);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2：异步提交</span></span><br><span class="line">ForkJoinTask&lt;Long&gt; future = pool.submit(task);</span><br><span class="line"><span class="type">Long</span> <span class="variable">result</span> <span class="operator">=</span> future.get();  <span class="comment">// 阻塞等待</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式3：异步执行（不关心结果）</span></span><br><span class="line">pool.execute(task);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="与普通线程池对比"><a href="#与普通线程池对比" class="headerlink" title="与普通线程池对比"></a>与普通线程池对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>ThreadPoolExecutor</th>
<th>ForkJoinPool</th>
</tr>
</thead>
<tbody><tr>
<td><strong>任务队列</strong></td>
<td>共享队列（单一）</td>
<td>每线程独立双端队列</td>
</tr>
<tr>
<td><strong>调度策略</strong></td>
<td>先进先出</td>
<td>工作窃取</td>
</tr>
<tr>
<td><strong>适用任务</strong></td>
<td>独立任务</td>
<td>可拆分的递归任务</td>
</tr>
<tr>
<td><strong>负载均衡</strong></td>
<td>依赖队列调度</td>
<td>工作窃取自动均衡</td>
</tr>
<tr>
<td><strong>CPU 利用</strong></td>
<td>可能有线程空闲</td>
<td>更高效（减少空闲）</td>
</tr>
<tr>
<td><strong>任务粒度</strong></td>
<td>任意</td>
<td>适合可拆分任务</td>
</tr>
</tbody></table>
<hr>
<h2 id="实际应用场景"><a href="#实际应用场景" class="headerlink" title="实际应用场景"></a>实际应用场景</h2><h3 id="1-Java-8-并行流"><a href="#1-Java-8-并行流" class="headerlink" title="1. Java 8 并行流"></a>1. Java 8 并行流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parallelStream() 底层使用 ForkJoinPool.commonPool()</span></span><br><span class="line">List&lt;Integer&gt; numbers = Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> numbers.parallelStream()</span><br><span class="line">                 .mapToInt(Integer::intValue)</span><br><span class="line">                 .sum();</span><br></pre></td></tr></table></figure>

<h3 id="2-CompletableFuture-默认执行器"><a href="#2-CompletableFuture-默认执行器" class="headerlink" title="2. CompletableFuture 默认执行器"></a>2. CompletableFuture 默认执行器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认使用 ForkJoinPool.commonPool()</span></span><br><span class="line">CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-大数据处理"><a href="#3-大数据处理" class="headerlink" title="3. 大数据处理"></a>3. 大数据处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 并行处理大量数据</span></span><br><span class="line">Arrays.parallelSort(largeArray);</span><br><span class="line">Arrays.parallelSetAll(array, i -&gt; i * <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="1-阈值设置"><a href="#1-阈值设置" class="headerlink" title="1. 阈值设置"></a>1. 阈值设置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 阈值太小：拆分开销 &gt; 并行收益</span></span><br><span class="line"><span class="comment">// 阈值太大：无法充分利用多核</span></span><br><span class="line"><span class="comment">// 经验值：根据任务复杂度和数据量测试确定</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THRESHOLD</span> <span class="operator">=</span> <span class="number">1000</span>;  <span class="comment">// 需要根据实际情况调整</span></span><br></pre></td></tr></table></figure>

<h3 id="2-避免阻塞操作"><a href="#2-避免阻塞操作" class="headerlink" title="2. 避免阻塞操作"></a>2. 避免阻塞操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ❌ 错误：在 ForkJoinPool 中执行阻塞 IO</span></span><br><span class="line"><span class="keyword">protected</span> Long <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 不要在这里做 IO 操作！</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">data</span> <span class="operator">=</span> httpClient.get(url);  <span class="comment">// 阻塞，浪费线程</span></span><br><span class="line">    <span class="keyword">return</span> process(data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ✅ 正确：ForkJoinPool 只用于 CPU 计算</span></span><br><span class="line"><span class="comment">// IO 操作使用其他线程池</span></span><br></pre></td></tr></table></figure>

<h3 id="3-公共池的风险"><a href="#3-公共池的风险" class="headerlink" title="3. 公共池的风险"></a>3. 公共池的风险</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 所有并行流共享 commonPool</span></span><br><span class="line"><span class="comment">// 如果某个任务阻塞，会影响其他任务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 解决方案：为关键任务创建独立的 ForkJoinPool</span></span><br><span class="line"><span class="type">ForkJoinPool</span> <span class="variable">customPool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">8</span>);</span><br><span class="line">customPool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 独立执行，不影响 commonPool</span></span><br><span class="line">    myParallelStream.forEach(...);</span><br><span class="line">&#125;).get();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><strong>上一篇</strong>：03-线程池类型</li>
<li><strong>线程池原理</strong>：02-线程池原理</li>
<li><strong>线程池简介</strong>：01-线程池简介</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Project%20Reactor%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Project%20Reactor%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">Project Reactor实现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Project-Reactor-实现"><a href="#Project-Reactor-实现" class="headerlink" title="Project Reactor 实现"></a>Project Reactor 实现</h1><h2 id="Project-Reactor-简介"><a href="#Project-Reactor-简介" class="headerlink" title="Project Reactor 简介"></a>Project Reactor 简介</h2><p>Project Reactor 是 <strong>Spring 官方的 Reactive Streams 实现</strong>，是 Spring WebFlux 的基础。</p>
<h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul>
<li><strong>完全非阻塞</strong>：基于 JDK 8 函数式 API</li>
<li><strong>背压支持</strong>：完整实现 Reactive Streams 规范</li>
<li><strong>丰富的操作符</strong>：提供 100+ 操作符</li>
<li><strong>与 Spring 深度集成</strong>：WebFlux、Spring Data R2DBC 等</li>
</ul>
<h2 id="Reactor-对-Reactive-Streams-的实现"><a href="#Reactor-对-Reactive-Streams-的实现" class="headerlink" title="Reactor 对 Reactive Streams 的实现"></a>Reactor 对 Reactive Streams 的实现</h2><h3 id="Publisher-的实现"><a href="#Publisher-的实现" class="headerlink" title="Publisher 的实现"></a>Publisher 的实现</h3><p>Reactor 提供了两个 Publisher 实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mono - 0或1个元素的 Publisher</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Mono</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flux - 0到N个元素的 Publisher  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Flux</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="为什么分成-Mono-和-Flux？"><a href="#为什么分成-Mono-和-Flux？" class="headerlink" title="为什么分成 Mono 和 Flux？"></a>为什么分成 Mono 和 Flux？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 语义更清晰</span></span><br><span class="line">Mono&lt;User&gt; <span class="title function_">findById</span><span class="params">(Long id)</span>;      <span class="comment">// 明确：最多返回1个</span></span><br><span class="line">Flux&lt;User&gt; <span class="title function_">findAll</span><span class="params">()</span>;              <span class="comment">// 明确：可能返回多个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 对比原始 Publisher</span></span><br><span class="line">Publisher&lt;User&gt; <span class="title function_">findById</span><span class="params">(Long id)</span>;  <span class="comment">// 不清楚：1个还是多个？</span></span><br></pre></td></tr></table></figure>

<h3 id="Subscriber-的实现"><a href="#Subscriber-的实现" class="headerlink" title="Subscriber 的实现"></a>Subscriber 的实现</h3><p>Reactor 提供了 <code>BaseSubscriber</code> 作为基础实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .subscribe(<span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">            <span class="comment">// 订阅时请求第一批数据</span></span><br><span class="line">            request(<span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;收到: &quot;</span> + value);</span><br><span class="line">            <span class="comment">// 每收到一个，再请求一个（控制背压）</span></span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnComplete</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;完成&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;错误: &quot;</span> + throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="背压策略实现"><a href="#背压策略实现" class="headerlink" title="背压策略实现"></a>背压策略实现</h2><p>Reactor 提供了多种背压策略：</p>
<h3 id="1-request-控制（默认）"><a href="#1-request-控制（默认）" class="headerlink" title="1. request 控制（默认）"></a>1. request 控制（默认）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .subscribe(<span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription s)</span> &#123;</span><br><span class="line">            request(<span class="number">10</span>);  <span class="comment">// 只请求10个</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnNext</span><span class="params">(Integer value)</span> &#123;</span><br><span class="line">            <span class="comment">// 处理完一个再请求一个</span></span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="2-onBackpressureBuffer-缓冲"><a href="#2-onBackpressureBuffer-缓冲" class="headerlink" title="2. onBackpressureBuffer - 缓冲"></a>2. onBackpressureBuffer - 缓冲</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureBuffer(<span class="number">100</span>)  <span class="comment">// 缓冲100个</span></span><br><span class="line">    .subscribe(value -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  <span class="comment">// 慢消费</span></span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="3-onBackpressureDrop-丢弃"><a href="#3-onBackpressureDrop-丢弃" class="headerlink" title="3. onBackpressureDrop - 丢弃"></a>3. onBackpressureDrop - 丢弃</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureDrop(dropped -&gt; </span><br><span class="line">        System.out.println(<span class="string">&quot;丢弃: &quot;</span> + dropped))</span><br><span class="line">    .subscribe(value -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="4-onBackpressureLatest-只保留最新"><a href="#4-onBackpressureLatest-只保留最新" class="headerlink" title="4. onBackpressureLatest - 只保留最新"></a>4. onBackpressureLatest - 只保留最新</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureLatest()  <span class="comment">// 只保留最新的</span></span><br><span class="line">    .subscribe(value -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="5-onBackpressureError-抛异常"><a href="#5-onBackpressureError-抛异常" class="headerlink" title="5. onBackpressureError - 抛异常"></a>5. onBackpressureError - 抛异常</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureError()  <span class="comment">// 背压时抛出异常</span></span><br><span class="line">    .subscribe(value -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        System.out.println(value);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Subscription-的实现"><a href="#Subscription-的实现" class="headerlink" title="Subscription 的实现"></a>Subscription 的实现</h2><p>Reactor 内部使用多种 Subscription 实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看实际的 Subscription 类型</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .subscribe(<span class="keyword">new</span> <span class="title class_">BaseSubscriber</span>&lt;Integer&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">hookOnSubscribe</span><span class="params">(Subscription subscription)</span> &#123;</span><br><span class="line">            System.out.println(subscription.getClass());</span><br><span class="line">            <span class="comment">// 输出: reactor.core.publisher.FluxRange$RangeSubscription</span></span><br><span class="line">            request(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="常见的-Subscription-实现"><a href="#常见的-Subscription-实现" class="headerlink" title="常见的 Subscription 实现"></a>常见的 Subscription 实现</h3><table>
<thead>
<tr>
<th>类名</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>FluxRange$RangeSubscription</code></td>
<td>range() 操作的订阅</td>
</tr>
<tr>
<td><code>FluxMap$MapSubscriber</code></td>
<td>map() 操作的订阅</td>
</tr>
<tr>
<td><code>FluxFilter$FilterSubscriber</code></td>
<td>filter() 操作的订阅</td>
</tr>
<tr>
<td><code>MonoJust$MonoJustSubscription</code></td>
<td>Mono.just() 的订阅</td>
</tr>
</tbody></table>
<h2 id="Processor-的实现（已废弃）"><a href="#Processor-的实现（已废弃）" class="headerlink" title="Processor 的实现（已废弃）"></a>Processor 的实现（已废弃）</h2><p>Reactor 3.4 之前提供了 Processor 实现，现在推荐使用 <strong>Sinks</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 旧方式（已废弃）</span></span><br><span class="line"><span class="comment">// DirectProcessor&lt;String&gt; processor = DirectProcessor.create();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新方式：使用 Sinks</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为 Publisher</span></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据</span></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;World&quot;</span>);</span><br><span class="line">sink.tryEmitComplete();</span><br></pre></td></tr></table></figure>

<h3 id="Sinks-的类型"><a href="#Sinks-的类型" class="headerlink" title="Sinks 的类型"></a>Sinks 的类型</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单播：只能有一个订阅者</span></span><br><span class="line">Sinks.Many&lt;String&gt; unicast = Sinks.many().unicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多播：多个订阅者共享</span></span><br><span class="line">Sinks.Many&lt;String&gt; multicast = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重放：新订阅者可以收到历史数据</span></span><br><span class="line">Sinks.Many&lt;String&gt; replay = Sinks.many().replay().all();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单值</span></span><br><span class="line">Sinks.One&lt;String&gt; one = Sinks.one();</span><br></pre></td></tr></table></figure>

<h2 id="操作符链的背压传递"><a href="#操作符链的背压传递" class="headerlink" title="操作符链的背压传递"></a>操作符链的背压传递</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)           <span class="comment">// 源 Publisher</span></span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)          <span class="comment">// 中间操作符</span></span><br><span class="line">    .filter(i -&gt; i % <span class="number">3</span> == <span class="number">0</span>)  <span class="comment">// 中间操作符</span></span><br><span class="line">    .take(<span class="number">10</span>)                 <span class="comment">// 中间操作符</span></span><br><span class="line">    .subscribe(System.out::println);  <span class="comment">// 最终 Subscriber</span></span><br></pre></td></tr></table></figure>

<p>背压信号<strong>从下游向上游传递</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Subscriber.request(10)</span><br><span class="line">    ↓</span><br><span class="line">take 向上 request(10)</span><br><span class="line">    ↓</span><br><span class="line">filter 向上 request(10)  // 可能请求更多，因为有过滤</span><br><span class="line">    ↓</span><br><span class="line">map 向上 request(10)</span><br><span class="line">    ↓</span><br><span class="line">range 开始生产数据</span><br></pre></td></tr></table></figure>

<h2 id="调试背压"><a href="#调试背压" class="headerlink" title="调试背压"></a>调试背压</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .log()  <span class="comment">// 打印所有信号，包括 request</span></span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>

<p>输出示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INFO  - | onSubscribe([Synchronous Fuseable] FluxRange.RangeSubscription)</span><br><span class="line">INFO  - | request(unbounded)</span><br><span class="line">INFO  - | onNext(1)</span><br><span class="line">INFO  - | onNext(2)</span><br><span class="line">...</span><br><span class="line">INFO  - | onComplete()</span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：Reactive Streams 规范</li>
<li>下一篇：源码解析</li>
<li>WebFlux - Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Reactive%20Streams%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Reactive%20Streams%E8%A7%84%E8%8C%83/" class="post-title-link" itemprop="url">Reactive Streams规范</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Reactive-Streams-规范"><a href="#Reactive-Streams-规范" class="headerlink" title="Reactive Streams 规范"></a>Reactive Streams 规范</h1><h2 id="什么是-Reactive-Streams"><a href="#什么是-Reactive-Streams" class="headerlink" title="什么是 Reactive Streams"></a>什么是 Reactive Streams</h2><p>Reactive Streams 是 JVM 上<strong>响应式编程的标准规范</strong>，定义了异步流处理的接口和协议。</p>
<ul>
<li><strong>发起者</strong>：Netflix、Pivotal、Lightbend、Twitter 等公司联合制定</li>
<li><strong>目标</strong>：解决异步数据流处理中的背压问题</li>
<li><strong>Java 9</strong>：已纳入 JDK，位于 <code>java.util.concurrent.Flow</code></li>
</ul>
<h2 id="四个核心接口"><a href="#四个核心接口" class="headerlink" title="四个核心接口"></a>四个核心接口</h2><p>Reactive Streams 只定义了 4 个接口，非常简洁：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 发布者 - 数据的生产者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 订阅者 - 数据的消费者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscriber</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Subscription s)</span>;  <span class="comment">// 订阅成功</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span>;                   <span class="comment">// 接收数据</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span>;          <span class="comment">// 发生错误</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span>;                  <span class="comment">// 数据流结束</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 订阅关系 - 连接发布者和订阅者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscription</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span>;  <span class="comment">// 请求 n 个数据（背压核心）</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;         <span class="comment">// 取消订阅</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. 处理器 - 既是订阅者又是发布者</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T, R&gt; <span class="keyword">extends</span> <span class="title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="交互流程"><a href="#交互流程" class="headerlink" title="交互流程"></a>交互流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐                      ┌──────────────┐</span><br><span class="line">│   Publisher  │                      │  Subscriber  │</span><br><span class="line">└──────────────┘                      └──────────────┘</span><br><span class="line">       │                                     │</span><br><span class="line">       │  1. subscribe(subscriber)           │</span><br><span class="line">       │ ──────────────────────────────────▶ │</span><br><span class="line">       │                                     │</span><br><span class="line">       │  2. onSubscribe(subscription)       │</span><br><span class="line">       │ ◀────────────────────────────────── │</span><br><span class="line">       │                                     │</span><br><span class="line">       │  3. request(n) 请求n个数据          │</span><br><span class="line">       │ ◀────────────────────────────────── │</span><br><span class="line">       │                                     │</span><br><span class="line">       │  4. onNext(data) 发送数据（最多n个）│</span><br><span class="line">       │ ──────────────────────────────────▶ │</span><br><span class="line">       │         ... 重复 3-4 ...            │</span><br><span class="line">       │                                     │</span><br><span class="line">       │  5. onComplete() 或 onError()       │</span><br><span class="line">       │ ──────────────────────────────────▶ │</span><br><span class="line">       ▼                                     ▼</span><br></pre></td></tr></table></figure>

<h2 id="背压（Backpressure）"><a href="#背压（Backpressure）" class="headerlink" title="背压（Backpressure）"></a>背压（Backpressure）</h2><p>背压是 Reactive Streams 的<strong>核心特性</strong>，解决生产者速度快于消费者的问题。</p>
<h3 id="没有背压的问题"><a href="#没有背压的问题" class="headerlink" title="没有背压的问题"></a>没有背压的问题</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">生产者：1000条/秒  ──────▶  消费者：100条/秒</span><br><span class="line">                              ↓</span><br><span class="line">                         内存溢出！</span><br></pre></td></tr></table></figure>

<h3 id="有背压的解决方案"><a href="#有背压的解决方案" class="headerlink" title="有背压的解决方案"></a>有背压的解决方案</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消费者控制速度</span></span><br><span class="line">subscription.request(<span class="number">10</span>);  <span class="comment">// 我只要10条</span></span><br><span class="line"><span class="comment">// 生产者最多发10条，然后等待下一次 request</span></span><br></pre></td></tr></table></figure>

<h3 id="背压协议规则"><a href="#背压协议规则" class="headerlink" title="背压协议规则"></a>背压协议规则</h3><ol>
<li><strong>Subscriber 主动请求</strong>：通过 <code>request(n)</code> 告诉 Publisher 需要多少数据</li>
<li><strong>Publisher 遵守约定</strong>：最多发送 n 个数据，不能超发</li>
<li><strong>累积请求</strong>：多次 <code>request()</code> 的数量会累加</li>
<li><strong>无限请求</strong>：<code>request(Long.MAX_VALUE)</code> 表示不限制</li>
</ol>
<h2 id="规范的实现"><a href="#规范的实现" class="headerlink" title="规范的实现"></a>规范的实现</h2><table>
<thead>
<tr>
<th>实现</th>
<th>说明</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Project Reactor</strong></td>
<td>Spring 默认实现</td>
<td>Spring WebFlux</td>
</tr>
<tr>
<td><strong>RxJava</strong></td>
<td>Netflix 开源</td>
<td>Android、通用</td>
</tr>
<tr>
<td><strong>Akka Streams</strong></td>
<td>Lightbend 开源</td>
<td>Scala 生态</td>
</tr>
<tr>
<td><strong>Java 9 Flow</strong></td>
<td>JDK 内置</td>
<td>标准库</td>
</tr>
</tbody></table>
<p>Spring 生态使用的是 <strong>Project Reactor</strong>，下一篇详细介绍。</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下一篇：Project Reactor 实现</li>
<li>WebFlux - 响应式编程基础</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Reactor%20API%E5%8F%82%E8%80%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Reactor%20API%E5%8F%82%E8%80%83/" class="post-title-link" itemprop="url">Reactor API参考</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Reactor-API-参考"><a href="#Reactor-API-参考" class="headerlink" title="Reactor API 参考"></a>Reactor API 参考</h1><p>Project Reactor 提供了丰富的操作符，本文按功能分类整理。</p>
<hr>
<h2 id="一、创建操作符"><a href="#一、创建操作符" class="headerlink" title="一、创建操作符"></a>一、创建操作符</h2><h3 id="Mono-创建"><a href="#Mono-创建" class="headerlink" title="Mono 创建"></a>Mono 创建</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>Mono.just(T)</code></td>
<td>创建包含单个值的 Mono</td>
<td><code>Mono.just(&quot;hello&quot;)</code></td>
</tr>
<tr>
<td><code>Mono.empty()</code></td>
<td>创建空的 Mono</td>
<td><code>Mono.empty()</code></td>
</tr>
<tr>
<td><code>Mono.error(Throwable)</code></td>
<td>创建错误 Mono</td>
<td><code>Mono.error(new RuntimeException())</code></td>
</tr>
<tr>
<td><code>Mono.never()</code></td>
<td>永不发出信号的 Mono</td>
<td><code>Mono.never()</code></td>
</tr>
<tr>
<td><code>Mono.defer(Supplier)</code></td>
<td>延迟创建，每次订阅都执行</td>
<td><code>Mono.defer(() -&gt; Mono.just(getValue()))</code></td>
</tr>
<tr>
<td><code>Mono.fromCallable(Callable)</code></td>
<td>从 Callable 创建</td>
<td><code>Mono.fromCallable(() -&gt; compute())</code></td>
</tr>
<tr>
<td><code>Mono.fromSupplier(Supplier)</code></td>
<td>从 Supplier 创建</td>
<td><code>Mono.fromSupplier(() -&gt; getValue())</code></td>
</tr>
<tr>
<td><code>Mono.fromFuture(CompletableFuture)</code></td>
<td>从 Future 创建</td>
<td><code>Mono.fromFuture(future)</code></td>
</tr>
<tr>
<td><code>Mono.fromRunnable(Runnable)</code></td>
<td>从 Runnable 创建（无返回值）</td>
<td><code>Mono.fromRunnable(() -&gt; doSomething())</code></td>
</tr>
<tr>
<td><code>Mono.delay(Duration)</code></td>
<td>延迟后发出 0L</td>
<td><code>Mono.delay(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>Mono.create(Consumer&lt;MonoSink&gt;)</code></td>
<td>编程式创建</td>
<td>见下方示例</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mono.create 示例</span></span><br><span class="line">Mono.create(sink -&gt; &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> doAsyncWork();</span><br><span class="line">    <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">        sink.success(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sink.error(<span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;失败&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Flux-创建"><a href="#Flux-创建" class="headerlink" title="Flux 创建"></a>Flux 创建</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>Flux.just(T...)</code></td>
<td>从多个值创建</td>
<td><code>Flux.just(1, 2, 3)</code></td>
</tr>
<tr>
<td><code>Flux.fromIterable(Iterable)</code></td>
<td>从集合创建</td>
<td><code>Flux.fromIterable(list)</code></td>
</tr>
<tr>
<td><code>Flux.fromArray(T[])</code></td>
<td>从数组创建</td>
<td><code>Flux.fromArray(array)</code></td>
</tr>
<tr>
<td><code>Flux.fromStream(Stream)</code></td>
<td>从 Stream 创建</td>
<td><code>Flux.fromStream(stream)</code></td>
</tr>
<tr>
<td><code>Flux.range(int, int)</code></td>
<td>创建整数序列</td>
<td><code>Flux.range(1, 10)</code></td>
</tr>
<tr>
<td><code>Flux.interval(Duration)</code></td>
<td>定时发出递增数字</td>
<td><code>Flux.interval(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>Flux.empty()</code></td>
<td>创建空 Flux</td>
<td><code>Flux.empty()</code></td>
</tr>
<tr>
<td><code>Flux.error(Throwable)</code></td>
<td>创建错误 Flux</td>
<td><code>Flux.error(new Exception())</code></td>
</tr>
<tr>
<td><code>Flux.never()</code></td>
<td>永不发出信号</td>
<td><code>Flux.never()</code></td>
</tr>
<tr>
<td><code>Flux.defer(Supplier)</code></td>
<td>延迟创建</td>
<td><code>Flux.defer(() -&gt; Flux.just(getData()))</code></td>
</tr>
<tr>
<td><code>Flux.generate(Consumer)</code></td>
<td>同步生成（一次一个）</td>
<td>见下方示例</td>
</tr>
<tr>
<td><code>Flux.create(Consumer)</code></td>
<td>异步生成（可多个）</td>
<td>见下方示例</td>
</tr>
<tr>
<td><code>Flux.push(Consumer)</code></td>
<td>单线程异步生成</td>
<td>类似 create</td>
</tr>
<tr>
<td><code>Flux.using(Callable, Function, Consumer)</code></td>
<td>资源管理</td>
<td>见下方示例</td>
</tr>
<tr>
<td><code>Flux.concat(Publisher...)</code></td>
<td>顺序连接多个流</td>
<td><code>Flux.concat(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>Flux.merge(Publisher...)</code></td>
<td>并行合并多个流</td>
<td><code>Flux.merge(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>Flux.zip(Publisher...)</code></td>
<td>组合多个流</td>
<td><code>Flux.zip(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>Flux.combineLatest(Publisher...)</code></td>
<td>组合最新值</td>
<td>见下方示例</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Flux.generate 示例 - 同步生成</span></span><br><span class="line">Flux.generate(</span><br><span class="line">    () -&gt; <span class="number">0</span>,  <span class="comment">// 初始状态</span></span><br><span class="line">    (state, sink) -&gt; &#123;</span><br><span class="line">        sink.next(<span class="string">&quot;值: &quot;</span> + state);</span><br><span class="line">        <span class="keyword">if</span> (state == <span class="number">10</span>) sink.complete();</span><br><span class="line">        <span class="keyword">return</span> state + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flux.create 示例 - 异步生成</span></span><br><span class="line">Flux.create(sink -&gt; &#123;</span><br><span class="line">    eventSource.onData(data -&gt; sink.next(data));</span><br><span class="line">    eventSource.onError(e -&gt; sink.error(e));</span><br><span class="line">    eventSource.onComplete(() -&gt; sink.complete());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Flux.using 示例 - 资源管理</span></span><br><span class="line">Flux.using(</span><br><span class="line">    () -&gt; <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;file.txt&quot;</span>),  <span class="comment">// 创建资源</span></span><br><span class="line">    inputStream -&gt; Flux.just(readData(inputStream)),  <span class="comment">// 使用资源</span></span><br><span class="line">    inputStream -&gt; inputStream.close()  <span class="comment">// 关闭资源</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="二、转换操作符"><a href="#二、转换操作符" class="headerlink" title="二、转换操作符"></a>二、转换操作符</h2><h3 id="基本转换"><a href="#基本转换" class="headerlink" title="基本转换"></a>基本转换</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>map(Function)</code></td>
<td>同步转换每个元素</td>
<td><code>flux.map(i -&gt; i * 2)</code></td>
</tr>
<tr>
<td><code>flatMap(Function)</code></td>
<td>异步转换，结果合并（无序）</td>
<td><code>flux.flatMap(id -&gt; fetchUser(id))</code></td>
</tr>
<tr>
<td><code>flatMapSequential(Function)</code></td>
<td>异步转换，保持顺序</td>
<td><code>flux.flatMapSequential(id -&gt; fetchUser(id))</code></td>
</tr>
<tr>
<td><code>concatMap(Function)</code></td>
<td>异步转换，顺序执行</td>
<td><code>flux.concatMap(id -&gt; fetchUser(id))</code></td>
</tr>
<tr>
<td><code>switchMap(Function)</code></td>
<td>切换到新流，取消旧流</td>
<td><code>flux.switchMap(id -&gt; fetchUser(id))</code></td>
</tr>
<tr>
<td><code>cast(Class)</code></td>
<td>类型转换</td>
<td><code>flux.cast(String.class)</code></td>
</tr>
<tr>
<td><code>ofType(Class)</code></td>
<td>过滤并转换类型</td>
<td><code>flux.ofType(String.class)</code></td>
</tr>
<tr>
<td><code>index()</code></td>
<td>添加索引</td>
<td><code>flux.index()</code> → <code>Tuple2&lt;Long, T&gt;</code></td>
</tr>
<tr>
<td><code>timestamp()</code></td>
<td>添加时间戳</td>
<td><code>flux.timestamp()</code> → <code>Tuple2&lt;Long, T&gt;</code></td>
</tr>
<tr>
<td><code>elapsed()</code></td>
<td>添加时间间隔</td>
<td><code>flux.elapsed()</code></td>
</tr>
</tbody></table>
<h3 id="flatMap-变体对比"><a href="#flatMap-变体对比" class="headerlink" title="flatMap 变体对比"></a>flatMap 变体对比</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flatMap:           并行执行，结果无序</span><br><span class="line">flatMapSequential: 并行执行，结果有序</span><br><span class="line">concatMap:         顺序执行，结果有序</span><br><span class="line">switchMap:         切换新流，取消旧流</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flatMap vs concatMap</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .flatMap(i -&gt; Mono.just(i).delayElement(Duration.ofMillis(<span class="number">100</span> - i * <span class="number">30</span>)))</span><br><span class="line">    .subscribe(System.out::println);  <span class="comment">// 可能输出: 3, 2, 1</span></span><br><span class="line"></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .concatMap(i -&gt; Mono.just(i).delayElement(Duration.ofMillis(<span class="number">100</span>)))</span><br><span class="line">    .subscribe(System.out::println);  <span class="comment">// 输出: 1, 2, 3</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三、过滤操作符"><a href="#三、过滤操作符" class="headerlink" title="三、过滤操作符"></a>三、过滤操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>filter(Predicate)</code></td>
<td>过滤元素</td>
<td><code>flux.filter(i -&gt; i &gt; 5)</code></td>
</tr>
<tr>
<td><code>filterWhen(Function)</code></td>
<td>异步过滤</td>
<td><code>flux.filterWhen(i -&gt; checkAsync(i))</code></td>
</tr>
<tr>
<td><code>distinct()</code></td>
<td>去重</td>
<td><code>flux.distinct()</code></td>
</tr>
<tr>
<td><code>distinctUntilChanged()</code></td>
<td>连续去重</td>
<td><code>flux.distinctUntilChanged()</code></td>
</tr>
<tr>
<td><code>take(long)</code></td>
<td>取前 n 个</td>
<td><code>flux.take(5)</code></td>
</tr>
<tr>
<td><code>takeLast(int)</code></td>
<td>取最后 n 个</td>
<td><code>flux.takeLast(3)</code></td>
</tr>
<tr>
<td><code>takeUntil(Predicate)</code></td>
<td>取直到条件满足</td>
<td><code>flux.takeUntil(i -&gt; i &gt; 10)</code></td>
</tr>
<tr>
<td><code>takeWhile(Predicate)</code></td>
<td>取当条件满足时</td>
<td><code>flux.takeWhile(i -&gt; i &lt; 10)</code></td>
</tr>
<tr>
<td><code>skip(long)</code></td>
<td>跳过前 n 个</td>
<td><code>flux.skip(5)</code></td>
</tr>
<tr>
<td><code>skipLast(int)</code></td>
<td>跳过最后 n 个</td>
<td><code>flux.skipLast(3)</code></td>
</tr>
<tr>
<td><code>skipUntil(Predicate)</code></td>
<td>跳过直到条件满足</td>
<td><code>flux.skipUntil(i -&gt; i &gt; 5)</code></td>
</tr>
<tr>
<td><code>skipWhile(Predicate)</code></td>
<td>跳过当条件满足时</td>
<td><code>flux.skipWhile(i -&gt; i &lt; 5)</code></td>
</tr>
<tr>
<td><code>first()</code></td>
<td>取第一个（已废弃）</td>
<td>使用 <code>next()</code></td>
</tr>
<tr>
<td><code>next()</code></td>
<td>取第一个，返回 Mono</td>
<td><code>flux.next()</code></td>
</tr>
<tr>
<td><code>last()</code></td>
<td>取最后一个</td>
<td><code>flux.last()</code></td>
</tr>
<tr>
<td><code>last(T)</code></td>
<td>取最后一个，有默认值</td>
<td><code>flux.last(defaultValue)</code></td>
</tr>
<tr>
<td><code>single()</code></td>
<td>期望只有一个元素</td>
<td><code>flux.single()</code></td>
</tr>
<tr>
<td><code>singleOrEmpty()</code></td>
<td>期望 0 或 1 个元素</td>
<td><code>flux.singleOrEmpty()</code></td>
</tr>
<tr>
<td><code>elementAt(int)</code></td>
<td>取指定位置元素</td>
<td><code>flux.elementAt(5)</code></td>
</tr>
<tr>
<td><code>ignoreElements()</code></td>
<td>忽略所有元素</td>
<td><code>flux.ignoreElements()</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="四、组合操作符"><a href="#四、组合操作符" class="headerlink" title="四、组合操作符"></a>四、组合操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>concat(Publisher...)</code></td>
<td>顺序连接</td>
<td><code>Flux.concat(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>concatWith(Publisher)</code></td>
<td>与另一个流连接</td>
<td><code>flux1.concatWith(flux2)</code></td>
</tr>
<tr>
<td><code>merge(Publisher...)</code></td>
<td>并行合并</td>
<td><code>Flux.merge(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>mergeWith(Publisher)</code></td>
<td>与另一个流合并</td>
<td><code>flux1.mergeWith(flux2)</code></td>
</tr>
<tr>
<td><code>mergeSequential(Publisher...)</code></td>
<td>并行执行，顺序输出</td>
<td><code>Flux.mergeSequential(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>zip(Publisher...)</code></td>
<td>一对一组合</td>
<td><code>Flux.zip(flux1, flux2)</code></td>
</tr>
<tr>
<td><code>zipWith(Publisher)</code></td>
<td>与另一个流组合</td>
<td><code>flux1.zipWith(flux2)</code></td>
</tr>
<tr>
<td><code>zipWith(Publisher, BiFunction)</code></td>
<td>组合并转换</td>
<td><code>flux1.zipWith(flux2, (a, b) -&gt; a + b)</code></td>
</tr>
<tr>
<td><code>combineLatest(Publisher...)</code></td>
<td>组合最新值</td>
<td><code>Flux.combineLatest(flux1, flux2, combiner)</code></td>
</tr>
<tr>
<td><code>startWith(T...)</code></td>
<td>在开头添加元素</td>
<td><code>flux.startWith(0)</code></td>
</tr>
<tr>
<td><code>and(Publisher)</code></td>
<td>等待两个都完成</td>
<td><code>mono1.and(mono2)</code></td>
</tr>
<tr>
<td><code>when(Publisher...)</code></td>
<td>等待所有完成</td>
<td><code>Mono.when(mono1, mono2)</code></td>
</tr>
<tr>
<td><code>then()</code></td>
<td>忽略元素，只关心完成</td>
<td><code>flux.then()</code></td>
</tr>
<tr>
<td><code>thenMany(Publisher)</code></td>
<td>完成后切换到另一个流</td>
<td><code>mono.thenMany(flux)</code></td>
</tr>
<tr>
<td><code>thenReturn(T)</code></td>
<td>完成后返回固定值</td>
<td><code>mono.thenReturn(&quot;done&quot;)</code></td>
</tr>
</tbody></table>
<h3 id="组合操作符对比"><a href="#组合操作符对比" class="headerlink" title="组合操作符对比"></a>组合操作符对比</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">concat:  A完成 → B开始，顺序执行</span><br><span class="line">merge:   A和B同时执行，谁快谁先输出</span><br><span class="line">zip:     A和B一对一配对，(a1,b1), (a2,b2)...</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zip 示例</span></span><br><span class="line">Flux&lt;String&gt; names = Flux.just(<span class="string">&quot;张三&quot;</span>, <span class="string">&quot;李四&quot;</span>);</span><br><span class="line">Flux&lt;Integer&gt; ages = Flux.just(<span class="number">25</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">Flux.zip(names, ages, (name, age) -&gt; name + <span class="string">&quot;: &quot;</span> + age)</span><br><span class="line">    .subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 输出: 张三: 25, 李四: 30</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、错误处理操作符"><a href="#五、错误处理操作符" class="headerlink" title="五、错误处理操作符"></a>五、错误处理操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>onErrorReturn(T)</code></td>
<td>错误时返回默认值</td>
<td><code>flux.onErrorReturn(defaultValue)</code></td>
</tr>
<tr>
<td><code>onErrorReturn(Predicate, T)</code></td>
<td>特定错误返回默认值</td>
<td><code>flux.onErrorReturn(e -&gt; e instanceof IOException, default)</code></td>
</tr>
<tr>
<td><code>onErrorResume(Function)</code></td>
<td>错误时切换到备用流</td>
<td><code>flux.onErrorResume(e -&gt; backupFlux)</code></td>
</tr>
<tr>
<td><code>onErrorMap(Function)</code></td>
<td>转换错误类型</td>
<td><code>flux.onErrorMap(e -&gt; new CustomException(e))</code></td>
</tr>
<tr>
<td><code>onErrorContinue(BiConsumer)</code></td>
<td>错误时跳过继续</td>
<td><code>flux.onErrorContinue((e, v) -&gt; log.error(e))</code></td>
</tr>
<tr>
<td><code>onErrorStop()</code></td>
<td>错误时停止</td>
<td><code>flux.onErrorStop()</code></td>
</tr>
<tr>
<td><code>doOnError(Consumer)</code></td>
<td>错误时执行副作用</td>
<td><code>flux.doOnError(e -&gt; log.error(e))</code></td>
</tr>
<tr>
<td><code>retry()</code></td>
<td>无限重试</td>
<td><code>flux.retry()</code></td>
</tr>
<tr>
<td><code>retry(long)</code></td>
<td>重试 n 次</td>
<td><code>flux.retry(3)</code></td>
</tr>
<tr>
<td><code>retryWhen(Retry)</code></td>
<td>自定义重试策略</td>
<td>见下方示例</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// retryWhen 示例</span></span><br><span class="line">flux.retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>))</span><br><span class="line">    .maxBackoff(Duration.ofSeconds(<span class="number">10</span>))</span><br><span class="line">    .filter(e -&gt; e <span class="keyword">instanceof</span> IOException)</span><br><span class="line">    .onRetryExhaustedThrow((spec, signal) -&gt; signal.failure())</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指数退避重试</span></span><br><span class="line">flux.retryWhen(Retry.backoff(<span class="number">5</span>, Duration.ofMillis(<span class="number">100</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 固定间隔重试</span></span><br><span class="line">flux.retryWhen(Retry.fixedDelay(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>)));</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、副作用操作符（doOn-系列）"><a href="#六、副作用操作符（doOn-系列）" class="headerlink" title="六、副作用操作符（doOn 系列）"></a>六、副作用操作符（doOn 系列）</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>触发时机</th>
</tr>
</thead>
<tbody><tr>
<td><code>doOnNext(Consumer)</code></td>
<td>每个元素</td>
<td>onNext 信号</td>
</tr>
<tr>
<td><code>doOnError(Consumer)</code></td>
<td>发生错误</td>
<td>onError 信号</td>
</tr>
<tr>
<td><code>doOnComplete(Runnable)</code></td>
<td>完成时</td>
<td>onComplete 信号</td>
</tr>
<tr>
<td><code>doOnSubscribe(Consumer)</code></td>
<td>订阅时</td>
<td>onSubscribe 信号</td>
</tr>
<tr>
<td><code>doOnRequest(LongConsumer)</code></td>
<td>请求数据时</td>
<td>request 信号</td>
</tr>
<tr>
<td><code>doOnCancel(Runnable)</code></td>
<td>取消时</td>
<td>cancel 信号</td>
</tr>
<tr>
<td><code>doOnTerminate(Runnable)</code></td>
<td>终止时（完成或错误）</td>
<td>onComplete 或 onError</td>
</tr>
<tr>
<td><code>doAfterTerminate(Runnable)</code></td>
<td>终止后</td>
<td>终止信号发送后</td>
</tr>
<tr>
<td><code>doOnEach(Consumer&lt;Signal&gt;)</code></td>
<td>每个信号</td>
<td>所有信号</td>
</tr>
<tr>
<td><code>doFirst(Runnable)</code></td>
<td>订阅前</td>
<td>订阅链建立前</td>
</tr>
<tr>
<td><code>doFinally(Consumer&lt;SignalType&gt;)</code></td>
<td>最终执行</td>
<td>任何终止情况</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完整的生命周期监控</span></span><br><span class="line">flux</span><br><span class="line">    .doFirst(() -&gt; log.info(<span class="string">&quot;开始&quot;</span>))</span><br><span class="line">    .doOnSubscribe(s -&gt; log.info(<span class="string">&quot;订阅&quot;</span>))</span><br><span class="line">    .doOnRequest(n -&gt; log.info(<span class="string">&quot;请求: &quot;</span> + n))</span><br><span class="line">    .doOnNext(v -&gt; log.info(<span class="string">&quot;收到: &quot;</span> + v))</span><br><span class="line">    .doOnError(e -&gt; log.error(<span class="string">&quot;错误&quot;</span>, e))</span><br><span class="line">    .doOnComplete(() -&gt; log.info(<span class="string">&quot;完成&quot;</span>))</span><br><span class="line">    .doOnCancel(() -&gt; log.info(<span class="string">&quot;取消&quot;</span>))</span><br><span class="line">    .doOnTerminate(() -&gt; log.info(<span class="string">&quot;终止&quot;</span>))</span><br><span class="line">    .doAfterTerminate(() -&gt; log.info(<span class="string">&quot;终止后&quot;</span>))</span><br><span class="line">    .doFinally(type -&gt; log.info(<span class="string">&quot;最终: &quot;</span> + type))</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="七、调度器操作符"><a href="#七、调度器操作符" class="headerlink" title="七、调度器操作符"></a>七、调度器操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>subscribeOn(Scheduler)</code></td>
<td>指定订阅线程</td>
<td><code>flux.subscribeOn(Schedulers.boundedElastic())</code></td>
</tr>
<tr>
<td><code>publishOn(Scheduler)</code></td>
<td>指定发布线程</td>
<td><code>flux.publishOn(Schedulers.parallel())</code></td>
</tr>
</tbody></table>
<h3 id="调度器类型"><a href="#调度器类型" class="headerlink" title="调度器类型"></a>调度器类型</h3><table>
<thead>
<tr>
<th>Scheduler</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>Schedulers.immediate()</code></td>
<td>当前线程</td>
<td>测试、简单场景</td>
</tr>
<tr>
<td><code>Schedulers.single()</code></td>
<td>单线程</td>
<td>顺序执行</td>
</tr>
<tr>
<td><code>Schedulers.parallel()</code></td>
<td>并行线程池（CPU核心数）</td>
<td>CPU 密集型</td>
</tr>
<tr>
<td><code>Schedulers.boundedElastic()</code></td>
<td>弹性线程池（有上限）</td>
<td>I&#x2F;O 密集型、阻塞操作</td>
</tr>
<tr>
<td><code>Schedulers.fromExecutor(Executor)</code></td>
<td>自定义线程池</td>
<td>特殊需求</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// subscribeOn vs publishOn</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line">    .doOnNext(i -&gt; log.info(<span class="string">&quot;生成: &quot;</span> + i))  <span class="comment">// boundedElastic 线程</span></span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">    .publishOn(Schedulers.parallel())</span><br><span class="line">    .doOnNext(i -&gt; log.info(<span class="string">&quot;处理: &quot;</span> + i))  <span class="comment">// parallel 线程</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="八、缓冲与窗口操作符"><a href="#八、缓冲与窗口操作符" class="headerlink" title="八、缓冲与窗口操作符"></a>八、缓冲与窗口操作符</h2><h3 id="缓冲（收集为-List）"><a href="#缓冲（收集为-List）" class="headerlink" title="缓冲（收集为 List）"></a>缓冲（收集为 List）</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>buffer()</code></td>
<td>收集所有元素</td>
<td><code>flux.buffer()</code> → <code>Flux&lt;List&lt;T&gt;&gt;</code></td>
</tr>
<tr>
<td><code>buffer(int)</code></td>
<td>按数量缓冲</td>
<td><code>flux.buffer(10)</code></td>
</tr>
<tr>
<td><code>buffer(Duration)</code></td>
<td>按时间缓冲</td>
<td><code>flux.buffer(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>buffer(int, int)</code></td>
<td>滑动窗口缓冲</td>
<td><code>flux.buffer(3, 1)</code></td>
</tr>
<tr>
<td><code>bufferUntil(Predicate)</code></td>
<td>缓冲直到条件满足</td>
<td><code>flux.bufferUntil(i -&gt; i % 10 == 0)</code></td>
</tr>
<tr>
<td><code>bufferWhile(Predicate)</code></td>
<td>缓冲当条件满足时</td>
<td><code>flux.bufferWhile(i -&gt; i &lt; 10)</code></td>
</tr>
<tr>
<td><code>bufferTimeout(int, Duration)</code></td>
<td>数量或时间触发</td>
<td><code>flux.bufferTimeout(100, Duration.ofSeconds(1))</code></td>
</tr>
</tbody></table>
<h3 id="窗口（收集为-Flux）"><a href="#窗口（收集为-Flux）" class="headerlink" title="窗口（收集为 Flux）"></a>窗口（收集为 Flux）</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>window(int)</code></td>
<td>按数量分窗口</td>
<td><code>flux.window(10)</code> → <code>Flux&lt;Flux&lt;T&gt;&gt;</code></td>
</tr>
<tr>
<td><code>window(Duration)</code></td>
<td>按时间分窗口</td>
<td><code>flux.window(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>windowUntil(Predicate)</code></td>
<td>分窗口直到条件满足</td>
<td><code>flux.windowUntil(i -&gt; i % 10 == 0)</code></td>
</tr>
</tbody></table>
<h3 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h3><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>groupBy(Function)</code></td>
<td>按 key 分组</td>
<td><code>flux.groupBy(User::getType)</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// groupBy 示例</span></span><br><span class="line">flux.groupBy(user -&gt; user.getType())</span><br><span class="line">    .flatMap(group -&gt; group</span><br><span class="line">        .collectList()</span><br><span class="line">        .map(list -&gt; group.key() + <span class="string">&quot;: &quot;</span> + list.size())</span><br><span class="line">    )</span><br><span class="line">    .subscribe(System.out::println);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="九、聚合操作符"><a href="#九、聚合操作符" class="headerlink" title="九、聚合操作符"></a>九、聚合操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>返回类型</th>
</tr>
</thead>
<tbody><tr>
<td><code>count()</code></td>
<td>计数</td>
<td><code>Mono&lt;Long&gt;</code></td>
</tr>
<tr>
<td><code>reduce(BiFunction)</code></td>
<td>归约</td>
<td><code>Mono&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>reduce(T, BiFunction)</code></td>
<td>带初始值归约</td>
<td><code>Mono&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>reduceWith(Supplier, BiFunction)</code></td>
<td>延迟初始值归约</td>
<td><code>Mono&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>scan(BiFunction)</code></td>
<td>累积（发出中间结果）</td>
<td><code>Flux&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>scan(T, BiFunction)</code></td>
<td>带初始值累积</td>
<td><code>Flux&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>collect(Collector)</code></td>
<td>收集到集合</td>
<td><code>Mono&lt;R&gt;</code></td>
</tr>
<tr>
<td><code>collectList()</code></td>
<td>收集为 List</td>
<td><code>Mono&lt;List&lt;T&gt;&gt;</code></td>
</tr>
<tr>
<td><code>collectMap(Function)</code></td>
<td>收集为 Map</td>
<td><code>Mono&lt;Map&lt;K, T&gt;&gt;</code></td>
</tr>
<tr>
<td><code>collectMap(Function, Function)</code></td>
<td>收集为 Map（指定 value）</td>
<td><code>Mono&lt;Map&lt;K, V&gt;&gt;</code></td>
</tr>
<tr>
<td><code>collectMultimap(Function)</code></td>
<td>收集为 Multimap</td>
<td><code>Mono&lt;Map&lt;K, Collection&lt;T&gt;&gt;&gt;</code></td>
</tr>
<tr>
<td><code>collectSortedList()</code></td>
<td>收集为排序 List</td>
<td><code>Mono&lt;List&lt;T&gt;&gt;</code></td>
</tr>
<tr>
<td><code>all(Predicate)</code></td>
<td>是否全部满足</td>
<td><code>Mono&lt;Boolean&gt;</code></td>
</tr>
<tr>
<td><code>any(Predicate)</code></td>
<td>是否有满足的</td>
<td><code>Mono&lt;Boolean&gt;</code></td>
</tr>
<tr>
<td><code>hasElements()</code></td>
<td>是否有元素</td>
<td><code>Mono&lt;Boolean&gt;</code></td>
</tr>
<tr>
<td><code>hasElement(T)</code></td>
<td>是否包含元素</td>
<td><code>Mono&lt;Boolean&gt;</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reduce 示例</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .reduce((a, b) -&gt; a + b)</span><br><span class="line">    .subscribe(System.out::println);  <span class="comment">// 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// scan 示例（发出中间结果）</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .scan((a, b) -&gt; a + b)</span><br><span class="line">    .subscribe(System.out::println);  <span class="comment">// 1, 3, 6, 10, 15</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十、时间操作符"><a href="#十、时间操作符" class="headerlink" title="十、时间操作符"></a>十、时间操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>delayElements(Duration)</code></td>
<td>延迟每个元素</td>
<td><code>flux.delayElements(Duration.ofMillis(100))</code></td>
</tr>
<tr>
<td><code>delaySequence(Duration)</code></td>
<td>延迟整个序列</td>
<td><code>flux.delaySequence(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>delaySubscription(Duration)</code></td>
<td>延迟订阅</td>
<td><code>flux.delaySubscription(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>timeout(Duration)</code></td>
<td>超时</td>
<td><code>flux.timeout(Duration.ofSeconds(5))</code></td>
</tr>
<tr>
<td><code>timeout(Duration, Publisher)</code></td>
<td>超时后切换</td>
<td><code>flux.timeout(Duration.ofSeconds(5), backupFlux)</code></td>
</tr>
<tr>
<td><code>sample(Duration)</code></td>
<td>采样</td>
<td><code>flux.sample(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>sampleFirst(Duration)</code></td>
<td>采样第一个</td>
<td><code>flux.sampleFirst(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>throttleFirst(Duration)</code></td>
<td>节流（取第一个）</td>
<td><code>flux.throttleFirst(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>throttleLast(Duration)</code></td>
<td>节流（取最后一个）</td>
<td><code>flux.throttleLast(Duration.ofSeconds(1))</code></td>
</tr>
<tr>
<td><code>elapsed()</code></td>
<td>添加时间间隔</td>
<td><code>flux.elapsed()</code></td>
</tr>
<tr>
<td><code>timed()</code></td>
<td>添加时间信息</td>
<td><code>flux.timed()</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="十一、背压操作符"><a href="#十一、背压操作符" class="headerlink" title="十一、背压操作符"></a>十一、背压操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>onBackpressureBuffer()</code></td>
<td>无限缓冲</td>
<td><code>flux.onBackpressureBuffer()</code></td>
</tr>
<tr>
<td><code>onBackpressureBuffer(int)</code></td>
<td>有限缓冲</td>
<td><code>flux.onBackpressureBuffer(100)</code></td>
</tr>
<tr>
<td><code>onBackpressureBuffer(int, Consumer)</code></td>
<td>缓冲满时回调</td>
<td><code>flux.onBackpressureBuffer(100, v -&gt; log.warn(&quot;溢出&quot;))</code></td>
</tr>
<tr>
<td><code>onBackpressureDrop()</code></td>
<td>丢弃</td>
<td><code>flux.onBackpressureDrop()</code></td>
</tr>
<tr>
<td><code>onBackpressureDrop(Consumer)</code></td>
<td>丢弃并回调</td>
<td><code>flux.onBackpressureDrop(v -&gt; log.warn(&quot;丢弃: &quot; + v))</code></td>
</tr>
<tr>
<td><code>onBackpressureLatest()</code></td>
<td>只保留最新</td>
<td><code>flux.onBackpressureLatest()</code></td>
</tr>
<tr>
<td><code>onBackpressureError()</code></td>
<td>抛出异常</td>
<td><code>flux.onBackpressureError()</code></td>
</tr>
<tr>
<td><code>limitRate(int)</code></td>
<td>限制请求速率</td>
<td><code>flux.limitRate(100)</code></td>
</tr>
<tr>
<td><code>limitRequest(long)</code></td>
<td>限制总请求数</td>
<td><code>flux.limitRequest(1000)</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="十二、条件操作符"><a href="#十二、条件操作符" class="headerlink" title="十二、条件操作符"></a>十二、条件操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>defaultIfEmpty(T)</code></td>
<td>空时返回默认值</td>
<td><code>flux.defaultIfEmpty(defaultValue)</code></td>
</tr>
<tr>
<td><code>switchIfEmpty(Publisher)</code></td>
<td>空时切换到另一个流</td>
<td><code>flux.switchIfEmpty(backupFlux)</code></td>
</tr>
<tr>
<td><code>repeatWhen(Function)</code></td>
<td>条件重复</td>
<td><code>flux.repeatWhen(companion -&gt; companion.take(3))</code></td>
</tr>
<tr>
<td><code>repeat()</code></td>
<td>无限重复</td>
<td><code>flux.repeat()</code></td>
</tr>
<tr>
<td><code>repeat(long)</code></td>
<td>重复 n 次</td>
<td><code>flux.repeat(3)</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="十三、调试操作符"><a href="#十三、调试操作符" class="headerlink" title="十三、调试操作符"></a>十三、调试操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>log()</code></td>
<td>打印所有信号</td>
<td><code>flux.log()</code></td>
</tr>
<tr>
<td><code>log(String)</code></td>
<td>带前缀打印</td>
<td><code>flux.log(&quot;MyFlux&quot;)</code></td>
</tr>
<tr>
<td><code>log(String, Level)</code></td>
<td>指定日志级别</td>
<td><code>flux.log(&quot;MyFlux&quot;, Level.FINE)</code></td>
</tr>
<tr>
<td><code>checkpoint()</code></td>
<td>添加检查点（调试用）</td>
<td><code>flux.checkpoint(&quot;after filter&quot;)</code></td>
</tr>
<tr>
<td><code>checkpoint(String)</code></td>
<td>带描述的检查点</td>
<td><code>flux.checkpoint(&quot;处理后&quot;)</code></td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调试示例</span></span><br><span class="line">Flux.range(<span class="number">1</span>, <span class="number">5</span>)</span><br><span class="line">    .log(<span class="string">&quot;源数据&quot;</span>)</span><br><span class="line">    .filter(i -&gt; i &gt; <span class="number">2</span>)</span><br><span class="line">    .log(<span class="string">&quot;过滤后&quot;</span>)</span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)</span><br><span class="line">    .log(<span class="string">&quot;转换后&quot;</span>)</span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十四、上下文操作符"><a href="#十四、上下文操作符" class="headerlink" title="十四、上下文操作符"></a>十四、上下文操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>contextWrite(Context)</code></td>
<td>写入上下文</td>
<td><code>flux.contextWrite(Context.of(&quot;key&quot;, &quot;value&quot;))</code></td>
</tr>
<tr>
<td><code>contextWrite(Function)</code></td>
<td>修改上下文</td>
<td><code>flux.contextWrite(ctx -&gt; ctx.put(&quot;key&quot;, &quot;value&quot;))</code></td>
</tr>
<tr>
<td><code>deferContextual(Function)</code></td>
<td>读取上下文创建流</td>
<td>见下方示例</td>
</tr>
<tr>
<td><code>transformDeferredContextual(BiFunction)</code></td>
<td>转换时读取上下文</td>
<td>见下方示例</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Context 示例 - 传递请求 ID</span></span><br><span class="line">Mono.deferContextual(ctx -&gt; &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestId</span> <span class="operator">=</span> ctx.get(<span class="string">&quot;requestId&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> callService(requestId);</span><br><span class="line">&#125;)</span><br><span class="line">.contextWrite(Context.of(<span class="string">&quot;requestId&quot;</span>, UUID.randomUUID().toString()))</span><br><span class="line">.subscribe();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="十五、Mono-特有操作符"><a href="#十五、Mono-特有操作符" class="headerlink" title="十五、Mono 特有操作符"></a>十五、Mono 特有操作符</h2><table>
<thead>
<tr>
<th>API</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>block()</code></td>
<td>阻塞获取结果</td>
<td><code>mono.block()</code></td>
</tr>
<tr>
<td><code>block(Duration)</code></td>
<td>带超时阻塞</td>
<td><code>mono.block(Duration.ofSeconds(5))</code></td>
</tr>
<tr>
<td><code>toFuture()</code></td>
<td>转为 CompletableFuture</td>
<td><code>mono.toFuture()</code></td>
</tr>
<tr>
<td><code>cache()</code></td>
<td>缓存结果</td>
<td><code>mono.cache()</code></td>
</tr>
<tr>
<td><code>cache(Duration)</code></td>
<td>带过期时间缓存</td>
<td><code>mono.cache(Duration.ofMinutes(5))</code></td>
</tr>
<tr>
<td><code>flux()</code></td>
<td>转为 Flux</td>
<td><code>mono.flux()</code></td>
</tr>
<tr>
<td><code>zipWhen(Function)</code></td>
<td>与依赖结果组合</td>
<td><code>mono.zipWhen(v -&gt; fetchRelated(v))</code></td>
</tr>
<tr>
<td><code>delayUntil(Function)</code></td>
<td>延迟直到另一个完成</td>
<td><code>mono.delayUntil(v -&gt; saveAsync(v))</code></td>
</tr>
</tbody></table>
<hr>
<h2 id="十六、Sinks（手动发送数据）"><a href="#十六、Sinks（手动发送数据）" class="headerlink" title="十六、Sinks（手动发送数据）"></a>十六、Sinks（手动发送数据）</h2><h3 id="Sinks-Many（多值）"><a href="#Sinks-Many（多值）" class="headerlink" title="Sinks.Many（多值）"></a>Sinks.Many（多值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单播 - 只能有一个订阅者</span></span><br><span class="line">Sinks.Many&lt;String&gt; unicast = Sinks.many().unicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多播 - 多个订阅者</span></span><br><span class="line">Sinks.Many&lt;String&gt; multicast = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重放 - 新订阅者可收到历史数据</span></span><br><span class="line">Sinks.Many&lt;String&gt; replay = Sinks.many().replay().all();</span><br><span class="line">Sinks.Many&lt;String&gt; replayLimit = Sinks.many().replay().limit(<span class="number">10</span>);</span><br><span class="line">Sinks.Many&lt;String&gt; replayLatest = Sinks.many().replay().latest();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送数据</span></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">sink.emitNext(<span class="string">&quot;data&quot;</span>, Sinks.EmitFailureHandler.FAIL_FAST);</span><br><span class="line">sink.tryEmitComplete();</span><br><span class="line">sink.tryEmitError(<span class="keyword">new</span> <span class="title class_">Exception</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 作为 Flux 使用</span></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br></pre></td></tr></table></figure>

<h3 id="Sinks-One（单值）"><a href="#Sinks-One（单值）" class="headerlink" title="Sinks.One（单值）"></a>Sinks.One（单值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sinks.One&lt;String&gt; one = Sinks.one();</span><br><span class="line">one.tryEmitValue(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">Mono&lt;String&gt; mono = one.asMono();</span><br></pre></td></tr></table></figure>

<h3 id="Sinks-Empty（无值）"><a href="#Sinks-Empty（无值）" class="headerlink" title="Sinks.Empty（无值）"></a>Sinks.Empty（无值）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Empty&lt;Void&gt; empty = Sinks.empty();</span><br><span class="line">empty.tryEmitEmpty();</span><br><span class="line">Mono&lt;Void&gt; mono = empty.asMono();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Project Reactor 实现</li>
<li>源码解析</li>
<li>WebFlux - Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Reactor%E6%A0%B8%E5%BF%83API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Reactor%E6%A0%B8%E5%BF%83API/" class="post-title-link" itemprop="url">Reactor核心API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Reactor-核心-API"><a href="#Reactor-核心-API" class="headerlink" title="Reactor 核心 API"></a>Reactor 核心 API</h1><h2 id="什么是-Project-Reactor"><a href="#什么是-Project-Reactor" class="headerlink" title="什么是 Project Reactor"></a>什么是 Project Reactor</h2><p>Project Reactor 是 Spring WebFlux 默认使用的响应式库，它实现了 Reactive Streams 规范，提供了两个核心类型：<strong>Mono</strong> 和 <strong>Flux</strong>。</p>
<h2 id="Mono-单值容器"><a href="#Mono-单值容器" class="headerlink" title="Mono - 单值容器"></a>Mono - 单值容器</h2><p><code>Mono&lt;T&gt;</code> 表示<strong>0个或1个</strong>元素的异步序列。</p>
<h3 id="创建-Mono"><a href="#创建-Mono" class="headerlink" title="创建 Mono"></a>创建 Mono</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建包含值的 Mono</span></span><br><span class="line">Mono&lt;String&gt; mono1 = Mono.just(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建空的 Mono</span></span><br><span class="line">Mono&lt;String&gt; mono2 = Mono.empty();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建错误的 Mono</span></span><br><span class="line">Mono&lt;String&gt; mono3 = Mono.error(<span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Error&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 延迟创建</span></span><br><span class="line">Mono&lt;String&gt; mono4 = Mono.fromSupplier(() -&gt; <span class="string">&quot;Lazy Value&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 Callable 创建</span></span><br><span class="line">Mono&lt;String&gt; mono5 = Mono.fromCallable(() -&gt; blockingCall());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 Future 创建</span></span><br><span class="line">Mono&lt;String&gt; mono6 = Mono.fromFuture(completableFuture);</span><br></pre></td></tr></table></figure>

<h3 id="Mono-常用操作"><a href="#Mono-常用操作" class="headerlink" title="Mono 常用操作"></a>Mono 常用操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Mono.just(<span class="string">&quot;Hello&quot;</span>)</span><br><span class="line">    .map(s -&gt; s + <span class="string">&quot; World&quot;</span>)           <span class="comment">// 转换</span></span><br><span class="line">    .flatMap(s -&gt; anotherMono(s))     <span class="comment">// 异步转换</span></span><br><span class="line">    .filter(s -&gt; s.length() &gt; <span class="number">5</span>)      <span class="comment">// 过滤</span></span><br><span class="line">    .defaultIfEmpty(<span class="string">&quot;Default&quot;</span>)         <span class="comment">// 默认值</span></span><br><span class="line">    .switchIfEmpty(anotherMono)        <span class="comment">// 空时切换</span></span><br><span class="line">    .doOnNext(s -&gt; log.info(s))        <span class="comment">// 副作用</span></span><br><span class="line">    .doOnError(e -&gt; log.error(e))      <span class="comment">// 错误处理</span></span><br><span class="line">    .subscribe();                       <span class="comment">// 订阅触发执行</span></span><br></pre></td></tr></table></figure>

<h2 id="Flux-多值容器"><a href="#Flux-多值容器" class="headerlink" title="Flux - 多值容器"></a>Flux - 多值容器</h2><p><code>Flux&lt;T&gt;</code> 表示<strong>0到N个</strong>元素的异步序列。</p>
<h3 id="创建-Flux"><a href="#创建-Flux" class="headerlink" title="创建 Flux"></a>创建 Flux</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从多个值创建</span></span><br><span class="line">Flux&lt;String&gt; flux1 = Flux.just(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从数组创建</span></span><br><span class="line">Flux&lt;String&gt; flux2 = Flux.fromArray(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从集合创建</span></span><br><span class="line">Flux&lt;String&gt; flux3 = Flux.fromIterable(Arrays.asList(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建范围</span></span><br><span class="line">Flux&lt;Integer&gt; flux4 = Flux.range(<span class="number">1</span>, <span class="number">10</span>);  <span class="comment">// 1到10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建空 Flux</span></span><br><span class="line">Flux&lt;String&gt; flux5 = Flux.empty();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定时发射</span></span><br><span class="line">Flux&lt;Long&gt; flux6 = Flux.interval(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从 Stream 创建</span></span><br><span class="line">Flux&lt;String&gt; flux7 = Flux.fromStream(Stream.of(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;B&quot;</span>, <span class="string">&quot;C&quot;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Flux-常用操作"><a href="#Flux-常用操作" class="headerlink" title="Flux 常用操作"></a>Flux 常用操作</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)                   <span class="comment">// 转换每个元素</span></span><br><span class="line">    .filter(i -&gt; i &gt; <span class="number">5</span>)                <span class="comment">// 过滤</span></span><br><span class="line">    .take(<span class="number">5</span>)                           <span class="comment">// 只取前5个</span></span><br><span class="line">    .skip(<span class="number">2</span>)                           <span class="comment">// 跳过前2个</span></span><br><span class="line">    .distinct()                        <span class="comment">// 去重</span></span><br><span class="line">    .sort()                            <span class="comment">// 排序</span></span><br><span class="line">    .collectList()                     <span class="comment">// 收集为 Mono&lt;List&gt;</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<h2 id="核心操作符分类"><a href="#核心操作符分类" class="headerlink" title="核心操作符分类"></a>核心操作符分类</h2><h3 id="转换操作符"><a href="#转换操作符" class="headerlink" title="转换操作符"></a>转换操作符</h3><table>
<thead>
<tr>
<th>操作符</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>map</code></td>
<td>同步转换</td>
<td><code>flux.map(i -&gt; i * 2)</code></td>
</tr>
<tr>
<td><code>flatMap</code></td>
<td>异步转换（不保序）</td>
<td><code>flux.flatMap(i -&gt; getMono(i))</code></td>
</tr>
<tr>
<td><code>flatMapSequential</code></td>
<td>异步转换（保序）</td>
<td><code>flux.flatMapSequential(...)</code></td>
</tr>
<tr>
<td><code>concatMap</code></td>
<td>顺序异步转换</td>
<td><code>flux.concatMap(...)</code></td>
</tr>
<tr>
<td><code>switchMap</code></td>
<td>切换到新流</td>
<td><code>flux.switchMap(...)</code></td>
</tr>
</tbody></table>
<h3 id="过滤操作符"><a href="#过滤操作符" class="headerlink" title="过滤操作符"></a>过滤操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">100</span>)</span><br><span class="line">    .filter(i -&gt; i % <span class="number">2</span> == <span class="number">0</span>)      <span class="comment">// 过滤偶数</span></span><br><span class="line">    .take(<span class="number">10</span>)                      <span class="comment">// 取前10个</span></span><br><span class="line">    .takeLast(<span class="number">5</span>)                   <span class="comment">// 取后5个</span></span><br><span class="line">    .takeWhile(i -&gt; i &lt; <span class="number">50</span>)        <span class="comment">// 满足条件时取</span></span><br><span class="line">    .skip(<span class="number">5</span>)                       <span class="comment">// 跳过前5个</span></span><br><span class="line">    .skipWhile(i -&gt; i &lt; <span class="number">10</span>)        <span class="comment">// 满足条件时跳过</span></span><br><span class="line">    .distinct()                    <span class="comment">// 去重</span></span><br><span class="line">    .distinctUntilChanged()        <span class="comment">// 相邻去重</span></span><br><span class="line">    .elementAt(<span class="number">5</span>)                  <span class="comment">// 取第5个元素</span></span><br><span class="line">    .single()                      <span class="comment">// 确保只有一个元素</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<h3 id="组合操作符"><a href="#组合操作符" class="headerlink" title="组合操作符"></a>组合操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 合并多个 Flux（交错）</span></span><br><span class="line">Flux.merge(flux1, flux2, flux3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 连接多个 Flux（顺序）</span></span><br><span class="line">Flux.concat(flux1, flux2, flux3);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配对组合</span></span><br><span class="line">Flux.zip(flux1, flux2, (a, b) -&gt; a + b);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并最新值</span></span><br><span class="line">Flux.combineLatest(flux1, flux2, (a, b) -&gt; a + b);</span><br></pre></td></tr></table></figure>

<h3 id="错误处理操作符"><a href="#错误处理操作符" class="headerlink" title="错误处理操作符"></a>错误处理操作符</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Flux.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line">    .map(i -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">2</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">    &#125;)</span><br><span class="line">    .onErrorReturn(-<span class="number">1</span>)                    <span class="comment">// 错误时返回默认值</span></span><br><span class="line">    .onErrorResume(e -&gt; Flux.just(<span class="number">0</span>))     <span class="comment">// 错误时切换到备用流</span></span><br><span class="line">    .onErrorMap(e -&gt; <span class="keyword">new</span> <span class="title class_">CustomException</span>()) <span class="comment">// 转换异常</span></span><br><span class="line">    .retry(<span class="number">3</span>)                              <span class="comment">// 重试3次</span></span><br><span class="line">    .retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>))) <span class="comment">// 退避重试</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<h2 id="调度器（Scheduler）"><a href="#调度器（Scheduler）" class="headerlink" title="调度器（Scheduler）"></a>调度器（Scheduler）</h2><p>调度器用于控制操作在哪个线程上执行。</p>
<h3 id="常用调度器"><a href="#常用调度器" class="headerlink" title="常用调度器"></a>常用调度器</h3><table>
<thead>
<tr>
<th>调度器</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>Schedulers.immediate()</code></td>
<td>当前线程</td>
<td>默认</td>
</tr>
<tr>
<td><code>Schedulers.single()</code></td>
<td>单一线程</td>
<td>顺序执行</td>
</tr>
<tr>
<td><code>Schedulers.parallel()</code></td>
<td>并行线程池</td>
<td>CPU 密集型</td>
</tr>
<tr>
<td><code>Schedulers.boundedElastic()</code></td>
<td>弹性线程池</td>
<td>I&#x2F;O 密集型</td>
</tr>
</tbody></table>
<h3 id="切换线程"><a href="#切换线程" class="headerlink" title="切换线程"></a>切换线程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">    .publishOn(Schedulers.parallel())    <span class="comment">// 后续操作在 parallel 线程</span></span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)</span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic()) <span class="comment">// 订阅在 elastic 线程</span></span><br><span class="line">    .subscribe();</span><br></pre></td></tr></table></figure>

<ul>
<li><strong><code>subscribeOn</code></strong>：影响订阅和数据源的执行线程</li>
<li><strong><code>publishOn</code></strong>：影响后续操作符的执行线程</li>
</ul>
<h2 id="冷流与热流"><a href="#冷流与热流" class="headerlink" title="冷流与热流"></a>冷流与热流</h2><h3 id="冷流（Cold）"><a href="#冷流（Cold）" class="headerlink" title="冷流（Cold）"></a>冷流（Cold）</h3><ul>
<li>每个订阅者都会从头开始接收数据</li>
<li>数据是惰性生成的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Integer&gt; cold = Flux.range(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">cold.subscribe(i -&gt; System.out.println(<span class="string">&quot;Subscriber 1: &quot;</span> + i));</span><br><span class="line">cold.subscribe(i -&gt; System.out.println(<span class="string">&quot;Subscriber 2: &quot;</span> + i));</span><br><span class="line"><span class="comment">// 两个订阅者都会收到 1, 2, 3, 4, 5</span></span><br></pre></td></tr></table></figure>

<h3 id="热流（Hot）"><a href="#热流（Hot）" class="headerlink" title="热流（Hot）"></a>热流（Hot）</h3><ul>
<li>所有订阅者共享同一个数据流</li>
<li>订阅后只能收到之后发出的数据</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;Integer&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">Flux&lt;Integer&gt; hot = sink.asFlux();</span><br><span class="line"></span><br><span class="line">hot.subscribe(i -&gt; System.out.println(<span class="string">&quot;Subscriber 1: &quot;</span> + i));</span><br><span class="line">sink.tryEmitNext(<span class="number">1</span>);</span><br><span class="line">sink.tryEmitNext(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">hot.subscribe(i -&gt; System.out.println(<span class="string">&quot;Subscriber 2: &quot;</span> + i));</span><br><span class="line">sink.tryEmitNext(<span class="number">3</span>);</span><br><span class="line"><span class="comment">// Subscriber 1 收到: 1, 2, 3</span></span><br><span class="line"><span class="comment">// Subscriber 2 收到: 3</span></span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：响应式编程基础</li>
<li>下一篇：WebFlux核心组件</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZhiMy</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<style>
.theme-toggle {
  position: fixed;
  right: 20px;
  bottom: 100px;
  z-index: 9999;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.3s ease;
  background: var(--content-bg-color);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.theme-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
.theme-toggle .icon-sun,
.theme-toggle .icon-moon {
  position: absolute;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
[data-theme="dark"] .theme-toggle .icon-sun {
  opacity: 1;
  transform: rotate(0deg);
}
[data-theme="dark"] .theme-toggle .icon-moon {
  opacity: 0;
  transform: rotate(-90deg);
}
[data-theme="light"] .theme-toggle .icon-sun {
  opacity: 0;
  transform: rotate(90deg);
}
[data-theme="light"] .theme-toggle .icon-moon {
  opacity: 1;
  transform: rotate(0deg);
}
/* 默认状态（跟随系统） */
.theme-toggle .icon-sun {
  opacity: 0;
}
.theme-toggle .icon-moon {
  opacity: 1;
}
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) .theme-toggle .icon-sun {
    opacity: 1;
    transform: rotate(0deg);
  }
  :root:not([data-theme="light"]) .theme-toggle .icon-moon {
    opacity: 0;
    transform: rotate(-90deg);
  }
}
</style>

<button class="theme-toggle" id="theme-toggle" aria-label="切换明暗模式">
  <span class="icon-sun">☀️</span>
  <span class="icon-moon">🌙</span>
</button>

<script>
(function() {
  const toggle = document.getElementById('theme-toggle');
  const root = document.documentElement;

  // 获取保存的主题或系统偏好
  function getPreferredTheme() {
    const saved = localStorage.getItem('theme');
    if (saved) return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  // 应用主题
  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    root.style.colorScheme = theme;
  }

  // 初始化
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme) {
    applyTheme(currentTheme);
  }

  // 切换主题
  toggle.addEventListener('click', function() {
    const current = root.getAttribute('data-theme') || getPreferredTheme();
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });

  // 监听系统主题变化（仅在用户未手动设置时生效）
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });
})();
</script>

</body>
</html>
