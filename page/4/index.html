<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zmmmmy.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":"auto","version":"8.27.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一个来自于 AI+Obsidian 的知识库">
<meta property="og:type" content="website">
<meta property="og:title" content="Zmmmmy&#39;s Blog">
<meta property="og:url" content="https://zmmmmy.github.io/page/4/index.html">
<meta property="og:site_name" content="Zmmmmy&#39;s Blog">
<meta property="og:description" content="一个来自于 AI+Obsidian 的知识库">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="ZhiMy">
<meta property="article:tag" content="技术博客">
<meta property="article:tag" content="编程">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zmmmmy.github.io/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Zmmmmy's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script><script src="/js/bookmark.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Zmmmmy's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">今天想和 AI 聊点什么？</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ZhiMy"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ZhiMy</p>
  <div class="site-description" itemprop="description">一个来自于 AI+Obsidian 的知识库</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">43</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/Zmmmmy" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Zmmmmy" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Sinks%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Sinks%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Sinks详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Sinks-详解"><a href="#Sinks-详解" class="headerlink" title="Sinks 详解"></a>Sinks 详解</h1><h2 id="什么是-Sinks"><a href="#什么是-Sinks" class="headerlink" title="什么是 Sinks"></a>什么是 Sinks</h2><p><strong>Sinks 是 Reactor 提供的”手动发送数据”的工具</strong>，让你可以在代码中主动 push 数据到响应式流中。</p>
<h3 id="核心问题：Mono-Flux-的局限"><a href="#核心问题：Mono-Flux-的局限" class="headerlink" title="核心问题：Mono&#x2F;Flux 的局限"></a>核心问题：Mono&#x2F;Flux 的局限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mono/Flux 通常是&quot;被动&quot;的 - 数据在创建时就确定了</span></span><br><span class="line">Mono.just(<span class="string">&quot;hello&quot;</span>);           <span class="comment">// 数据已确定</span></span><br><span class="line">Flux.fromIterable(list);      <span class="comment">// 数据已确定</span></span><br><span class="line">Flux.interval(Duration.ofSeconds(<span class="number">1</span>));  <span class="comment">// 数据按规则生成</span></span><br></pre></td></tr></table></figure>

<p><strong>但有些场景需要”主动”发送数据</strong>：</p>
<ul>
<li>接收外部事件（WebSocket、消息队列）</li>
<li>用户交互触发</li>
<li>异步回调结果</li>
<li>多个地方产生数据，汇聚到一个流</li>
</ul>
<h3 id="Sinks-的作用"><a href="#Sinks-的作用" class="headerlink" title="Sinks 的作用"></a>Sinks 的作用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sinks 让你可以&quot;主动&quot;发送数据</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在任何地方、任何时候发送数据</span></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息1&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅者可以收到这些数据</span></span><br><span class="line">sink.asFlux().subscribe(System.out::println);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sinks-与-Mono-Flux-的关系"><a href="#Sinks-与-Mono-Flux-的关系" class="headerlink" title="Sinks 与 Mono&#x2F;Flux 的关系"></a>Sinks 与 Mono&#x2F;Flux 的关系</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────────┐</span><br><span class="line">│                        数据生产方式                          │</span><br><span class="line">├─────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                             │</span><br><span class="line">│   Mono/Flux (被动)              Sinks (主动)                │</span><br><span class="line">│   ─────────────────            ─────────────                │</span><br><span class="line">│   数据在创建时确定              数据可以随时发送              │</span><br><span class="line">│   just(), fromIterable()       tryEmitNext()               │</span><br><span class="line">│   interval(), range()          tryEmitComplete()           │</span><br><span class="line">│                                                             │</span><br><span class="line">│                    ↓ 转换 ↓                                 │</span><br><span class="line">│                                                             │</span><br><span class="line">│              sink.asFlux() → Flux&lt;T&gt;                        │</span><br><span class="line">│              sink.asMono() → Mono&lt;T&gt;                        │</span><br><span class="line">│                                                             │</span><br><span class="line">│   最终都是 Flux/Mono，订阅者无感知差异                        │</span><br><span class="line">└─────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>本质：Sinks 是 Flux&#x2F;Mono 的数据源，它生产数据，Flux&#x2F;Mono 传递数据。</p>
<hr>
<h2 id="Sinks-的三种类型"><a href="#Sinks-的三种类型" class="headerlink" title="Sinks 的三种类型"></a>Sinks 的三种类型</h2><h3 id="1-Sinks-One-单值（对应-Mono）"><a href="#1-Sinks-One-单值（对应-Mono）" class="headerlink" title="1. Sinks.One - 单值（对应 Mono）"></a>1. Sinks.One - 单值（对应 Mono）</h3><p>只能发送 0 或 1 个值，然后完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Sinks.One&lt;String&gt; sink = Sinks.one();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送一个值</span></span><br><span class="line">sink.tryEmitValue(<span class="string">&quot;结果&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为 Mono</span></span><br><span class="line">Mono&lt;String&gt; mono = sink.asMono();</span><br><span class="line">mono.subscribe(System.out::println);  <span class="comment">// 输出: 结果</span></span><br></pre></td></tr></table></figure>

<p>使用场景：异步操作的单个结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：封装异步回调</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">fetchUserAsync</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    Sinks.One&lt;User&gt; sink = Sinks.one();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 假设这是一个回调式的 API</span></span><br><span class="line">    asyncClient.getUser(id, <span class="keyword">new</span> <span class="title class_">Callback</span>&lt;User&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onSuccess</span><span class="params">(User user)</span> &#123;</span><br><span class="line">            sink.tryEmitValue(user);  <span class="comment">// 成功时发送值</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception e)</span> &#123;</span><br><span class="line">            sink.tryEmitError(e);     <span class="comment">// 失败时发送错误</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sink.asMono();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-Sinks-Empty-无值（对应-Mono）"><a href="#2-Sinks-Empty-无值（对应-Mono）" class="headerlink" title="2. Sinks.Empty - 无值（对应 Mono）"></a>2. Sinks.Empty - 无值（对应 Mono<Void>）</h3><p>只发送完成或错误信号，不发送值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Empty&lt;Void&gt; sink = Sinks.empty();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送完成信号</span></span><br><span class="line">sink.tryEmitEmpty();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为 Mono&lt;Void&gt;</span></span><br><span class="line">Mono&lt;Void&gt; mono = sink.asMono();</span><br><span class="line">mono.subscribe(</span><br><span class="line">    v -&gt; &#123;&#125;,</span><br><span class="line">    e -&gt; &#123;&#125;,</span><br><span class="line">    () -&gt; System.out.println(<span class="string">&quot;完成了&quot;</span>)  <span class="comment">// 输出: 完成了</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>使用场景：只关心操作是否完成，不关心返回值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：等待初始化完成</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">waitForInit</span><span class="params">()</span> &#123;</span><br><span class="line">    Sinks.Empty&lt;Void&gt; sink = Sinks.empty();</span><br><span class="line">    </span><br><span class="line">    initService.onReady(() -&gt; sink.tryEmitEmpty());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sink.asMono();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-Sinks-Many-多值（对应-Flux）"><a href="#3-Sinks-Many-多值（对应-Flux）" class="headerlink" title="3. Sinks.Many - 多值（对应 Flux）"></a>3. Sinks.Many - 多值（对应 Flux）</h3><p>可以发送 0 到 N 个值，这是最常用的类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送多个值</span></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息1&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息2&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息3&quot;</span>);</span><br><span class="line">sink.tryEmitComplete();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 转为 Flux</span></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br><span class="line">flux.subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 输出: 消息1, 消息2, 消息3</span></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sinks-Many-的三种模式"><a href="#Sinks-Many-的三种模式" class="headerlink" title="Sinks.Many 的三种模式"></a>Sinks.Many 的三种模式</h2><h3 id="1-Unicast（单播）-只能有一个订阅者"><a href="#1-Unicast（单播）-只能有一个订阅者" class="headerlink" title="1. Unicast（单播）- 只能有一个订阅者"></a>1. Unicast（单播）- 只能有一个订阅者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().unicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第一个订阅者 </span></span><br><span class="line">flux.subscribe(v -&gt; System.out.println(<span class="string">&quot;订阅者1: &quot;</span> + v));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二个订阅者  会报错！</span></span><br><span class="line">flux.subscribe(v -&gt; System.out.println(<span class="string">&quot;订阅者2: &quot;</span> + v));</span><br><span class="line"><span class="comment">// 抛出 IllegalStateException</span></span><br></pre></td></tr></table></figure>

<p>特点：</p>
<ul>
<li>只允许一个订阅者</li>
<li>内存效率高（不需要维护多个订阅者状态）</li>
<li>适合点对点通信</li>
</ul>
<h3 id="2-Multicast（多播）-多个订阅者共享"><a href="#2-Multicast（多播）-多个订阅者共享" class="headerlink" title="2. Multicast（多播）- 多个订阅者共享"></a>2. Multicast（多播）- 多个订阅者共享</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个订阅者都可以收到数据 </span></span><br><span class="line">flux.subscribe(v -&gt; System.out.println(<span class="string">&quot;订阅者1: &quot;</span> + v));</span><br><span class="line">flux.subscribe(v -&gt; System.out.println(<span class="string">&quot;订阅者2: &quot;</span> + v));</span><br><span class="line"></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;Hello&quot;</span>);</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// 订阅者1: Hello</span></span><br><span class="line"><span class="comment">// 订阅者2: Hello</span></span><br></pre></td></tr></table></figure>

<p>特点：</p>
<ul>
<li>允许多个订阅者</li>
<li>热流：新订阅者只能收到订阅后的数据</li>
<li>适合广播场景</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 热流特性演示</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息1&quot;</span>);  <span class="comment">// 此时没有订阅者，消息丢失</span></span><br><span class="line"></span><br><span class="line">Flux&lt;String&gt; flux = sink.asFlux();</span><br><span class="line">flux.subscribe(v -&gt; System.out.println(<span class="string">&quot;收到: &quot;</span> + v));</span><br><span class="line"></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息2&quot;</span>);  <span class="comment">// 订阅者收到</span></span><br><span class="line"><span class="comment">// 输出: 收到: 消息2</span></span><br></pre></td></tr></table></figure>

<h3 id="3-Replay（重放）-新订阅者可收到历史数据"><a href="#3-Replay（重放）-新订阅者可收到历史数据" class="headerlink" title="3. Replay（重放）- 新订阅者可收到历史数据"></a>3. Replay（重放）- 新订阅者可收到历史数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重放所有历史数据</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().replay().all();</span><br><span class="line"></span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息1&quot;</span>);</span><br><span class="line">sink.tryEmitNext(<span class="string">&quot;消息2&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新订阅者可以收到之前的数据！</span></span><br><span class="line">sink.asFlux().subscribe(v -&gt; System.out.println(<span class="string">&quot;收到: &quot;</span> + v));</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// 收到: 消息1</span></span><br><span class="line"><span class="comment">// 收到: 消息2</span></span><br></pre></td></tr></table></figure>

<p>Replay 的变体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重放所有</span></span><br><span class="line">Sinks.many().replay().all();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重放最近 N 条</span></span><br><span class="line">Sinks.many().replay().limit(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 只重放最新一条</span></span><br><span class="line">Sinks.many().replay().latest();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重放指定时间内的数据</span></span><br><span class="line">Sinks.many().replay().limit(Duration.ofMinutes(<span class="number">5</span>));</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="三种模式对比"><a href="#三种模式对比" class="headerlink" title="三种模式对比"></a>三种模式对比</h2><table>
<thead>
<tr>
<th>模式</th>
<th>订阅者数量</th>
<th>历史数据</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Unicast</strong></td>
<td>1个</td>
<td>无</td>
<td>点对点、队列消费</td>
</tr>
<tr>
<td><strong>Multicast</strong></td>
<td>多个</td>
<td>无（热流）</td>
<td>事件广播、实时推送</td>
</tr>
<tr>
<td><strong>Replay</strong></td>
<td>多个</td>
<td>有（可配置）</td>
<td>状态共享、缓存</td>
</tr>
</tbody></table>
<hr>
<h2 id="发送数据的方法"><a href="#发送数据的方法" class="headerlink" title="发送数据的方法"></a>发送数据的方法</h2><h3 id="tryEmitXxx-vs-emitXxx"><a href="#tryEmitXxx-vs-emitXxx" class="headerlink" title="tryEmitXxx vs emitXxx"></a>tryEmitXxx vs emitXxx</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式1: tryEmitXxx - 返回结果，不抛异常</span></span><br><span class="line">Sinks.<span class="type">EmitResult</span> <span class="variable">result</span> <span class="operator">=</span> sink.tryEmitNext(<span class="string">&quot;data&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (result.isFailure()) &#123;</span><br><span class="line">    <span class="comment">// 处理失败</span></span><br><span class="line">    System.out.println(<span class="string">&quot;发送失败: &quot;</span> + result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式2: emitXxx - 可自定义失败处理</span></span><br><span class="line">sink.emitNext(<span class="string">&quot;data&quot;</span>, (signalType, emitResult) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 返回 true 表示重试，false 表示放弃</span></span><br><span class="line">    <span class="keyword">return</span> emitResult == Sinks.EmitResult.FAIL_NON_SERIALIZED;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="EmitResult-的类型"><a href="#EmitResult-的类型" class="headerlink" title="EmitResult 的类型"></a>EmitResult 的类型</h3><table>
<thead>
<tr>
<th>结果</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>OK</code></td>
<td>发送成功</td>
</tr>
<tr>
<td><code>FAIL_TERMINATED</code></td>
<td>Sink 已终止</td>
</tr>
<tr>
<td><code>FAIL_OVERFLOW</code></td>
<td>背压溢出</td>
</tr>
<tr>
<td><code>FAIL_CANCELLED</code></td>
<td>已取消</td>
</tr>
<tr>
<td><code>FAIL_NON_SERIALIZED</code></td>
<td>并发冲突（多线程同时发送）</td>
</tr>
<tr>
<td><code>FAIL_ZERO_SUBSCRIBER</code></td>
<td>没有订阅者（unicast）</td>
</tr>
</tbody></table>
<h3 id="常用的-EmitFailureHandler"><a href="#常用的-EmitFailureHandler" class="headerlink" title="常用的 EmitFailureHandler"></a>常用的 EmitFailureHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 快速失败 - 失败就放弃</span></span><br><span class="line">Sinks.EmitFailureHandler.FAIL_FAST</span><br><span class="line"></span><br><span class="line"><span class="comment">// 忙等待重试 - 适合并发场景</span></span><br><span class="line">Sinks.EmitFailureHandler.busyLooping(Duration.ofMillis(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="实战示例"><a href="#实战示例" class="headerlink" title="实战示例"></a>实战示例</h2><h3 id="示例1：WebSocket-消息推送"><a href="#示例1：WebSocket-消息推送" class="headerlink" title="示例1：WebSocket 消息推送"></a>示例1：WebSocket 消息推送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用于向所有连接的客户端广播消息</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;String&gt; messageSink = </span><br><span class="line">        Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取消息流，供 WebSocket 订阅</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getMessageStream</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> messageSink.asFlux();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送消息给所有客户端</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">broadcast</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        messageSink.tryEmitNext(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WebSocket 配置</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> HandlerMapping <span class="title function_">webSocketMapping</span><span class="params">(WebSocketHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleUrlHandlerMapping</span>(Map.of(</span><br><span class="line">        <span class="string">&quot;/ws&quot;</span>, session -&gt; session.send(</span><br><span class="line">            handler.getMessageStream()</span><br><span class="line">                .map(session::textMessage)</span><br><span class="line">        )</span><br><span class="line">    ), -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例2：事件总线"><a href="#示例2：事件总线" class="headerlink" title="示例2：事件总线"></a>示例2：事件总线</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBus</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;Event&gt; eventSink = </span><br><span class="line">        Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发布事件</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        eventSink.tryEmitNext(event);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 订阅特定类型的事件</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Event</span>&gt; Flux&lt;T&gt; <span class="title function_">subscribe</span><span class="params">(Class&lt;T&gt; eventType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> eventSink.asFlux()</span><br><span class="line">            .filter(eventType::isInstance)</span><br><span class="line">            .cast(eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line">eventBus.subscribe(UserCreatedEvent.class)</span><br><span class="line">    .subscribe(event -&gt; System.out.println(<span class="string">&quot;用户创建: &quot;</span> + event.getUserId()));</span><br><span class="line"></span><br><span class="line">eventBus.publish(<span class="keyword">new</span> <span class="title class_">UserCreatedEvent</span>(<span class="number">123L</span>));</span><br></pre></td></tr></table></figure>

<h3 id="示例3：异步任务结果收集"><a href="#示例3：异步任务结果收集" class="headerlink" title="示例3：异步任务结果收集"></a>示例3：异步任务结果收集</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Flux&lt;Result&gt; <span class="title function_">executeTasksAsync</span><span class="params">(List&lt;Task&gt; tasks)</span> &#123;</span><br><span class="line">    Sinks.Many&lt;Result&gt; sink = Sinks.many().unicast().onBackpressureBuffer();</span><br><span class="line">    </span><br><span class="line">    <span class="type">AtomicInteger</span> <span class="variable">remaining</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(tasks.size());</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Task task : tasks) &#123;</span><br><span class="line">        CompletableFuture.runAsync(() -&gt; &#123;</span><br><span class="line">            <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> task.execute();</span><br><span class="line">            sink.tryEmitNext(result);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (remaining.decrementAndGet() == <span class="number">0</span>) &#123;</span><br><span class="line">                sink.tryEmitComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> sink.asFlux();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例4：缓存最新状态"><a href="#示例4：缓存最新状态" class="headerlink" title="示例4：缓存最新状态"></a>示例4：缓存最新状态</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StatusCache</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 使用 replay().latest() 缓存最新状态</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;SystemStatus&gt; statusSink = </span><br><span class="line">        Sinks.many().replay().latest();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新状态</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateStatus</span><span class="params">(SystemStatus status)</span> &#123;</span><br><span class="line">        statusSink.tryEmitNext(status);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前状态（新订阅者立即收到最新状态）</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;SystemStatus&gt; <span class="title function_">getCurrentStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> statusSink.asFlux().next();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听状态变化</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;SystemStatus&gt; <span class="title function_">watchStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> statusSink.asFlux();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Sinks-vs-旧版-Processor"><a href="#Sinks-vs-旧版-Processor" class="headerlink" title="Sinks vs 旧版 Processor"></a>Sinks vs 旧版 Processor</h2><p>Reactor 3.4 之前使用 <code>Processor</code>，现在已废弃：</p>
<table>
<thead>
<tr>
<th>旧版 Processor</th>
<th>新版 Sinks</th>
</tr>
</thead>
<tbody><tr>
<td><code>DirectProcessor</code></td>
<td><code>Sinks.many().multicast().directBestEffort()</code></td>
</tr>
<tr>
<td><code>UnicastProcessor</code></td>
<td><code>Sinks.many().unicast()</code></td>
</tr>
<tr>
<td><code>ReplayProcessor</code></td>
<td><code>Sinks.many().replay()</code></td>
</tr>
<tr>
<td><code>EmitterProcessor</code></td>
<td><code>Sinks.many().multicast()</code></td>
</tr>
</tbody></table>
<p>为什么废弃 Processor？</p>
<ul>
<li>Processor 同时是 Publisher 和 Subscriber，职责不清</li>
<li>线程安全问题难以处理</li>
<li>Sinks 提供更清晰的 API 和更好的线程安全保证</li>
</ul>
<hr>
<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>Sinks 默认是线程安全的，但有性能开销。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认：线程安全</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果确定单线程使用，可以用 unsafe 版本提升性能</span></span><br><span class="line">Sinks.Many&lt;String&gt; unsafeSink = Sinks.unsafe().many().multicast().onBackpressureBuffer();</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：<code>unsafe</code> 版本在多线程下会出问题，只在确定单线程时使用。</p>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>概念</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Sinks 是什么</strong></td>
<td>手动发送数据到响应式流的工具</td>
</tr>
<tr>
<td><strong>与 Mono&#x2F;Flux 关系</strong></td>
<td>Sinks 是数据源，通过 <code>asFlux()</code>&#x2F;<code>asMono()</code> 转换</td>
</tr>
<tr>
<td><strong>Sinks.One</strong></td>
<td>发送 0-1 个值，对应 Mono</td>
</tr>
<tr>
<td><strong>Sinks.Empty</strong></td>
<td>只发送完成&#x2F;错误信号，对应 Mono<Void></td>
</tr>
<tr>
<td><strong>Sinks.Many</strong></td>
<td>发送 0-N 个值，对应 Flux</td>
</tr>
<tr>
<td><strong>Unicast</strong></td>
<td>单订阅者</td>
</tr>
<tr>
<td><strong>Multicast</strong></td>
<td>多订阅者，热流</td>
</tr>
<tr>
<td><strong>Replay</strong></td>
<td>多订阅者，可重放历史</td>
</tr>
</tbody></table>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Reactor API 参考</li>
<li>Project Reactor 实现</li>
<li>WebFlux 核心组件</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/Webflux%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/Webflux%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">Webflux简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Webflux-简介"><a href="#Webflux-简介" class="headerlink" title="Webflux 简介"></a>Webflux 简介</h1><h2 id="什么是-Spring-WebFlux"><a href="#什么是-Spring-WebFlux" class="headerlink" title="什么是 Spring WebFlux"></a>什么是 Spring WebFlux</h2><p>Spring WebFlux 是 Spring Framework 5.0 引入的<strong>响应式 Web 框架</strong>，它是 Spring MVC 的替代方案，专为构建<strong>非阻塞、异步</strong>的 Web 应用程序而设计。</p>
<h3 id="核心特点"><a href="#核心特点" class="headerlink" title="核心特点"></a>核心特点</h3><ul>
<li><strong>非阻塞 I&#x2F;O</strong>：基于事件驱动模型，不会阻塞线程等待 I&#x2F;O 操作完成</li>
<li><strong>响应式编程</strong>：基于 Reactive Streams 规范，使用 Project Reactor 作为默认实现</li>
<li><strong>背压支持</strong>：支持背压（Backpressure）机制，防止生产者压垮消费者</li>
<li><strong>函数式编程</strong>：支持函数式端点定义，提供更灵活的路由方式</li>
</ul>
<h2 id="WebFlux-vs-Spring-MVC"><a href="#WebFlux-vs-Spring-MVC" class="headerlink" title="WebFlux vs Spring MVC"></a>WebFlux vs Spring MVC</h2><table>
<thead>
<tr>
<th>特性</th>
<th>Spring MVC</th>
<th>Spring WebFlux</th>
</tr>
</thead>
<tbody><tr>
<td>编程模型</td>
<td>命令式（Imperative）</td>
<td>响应式（Reactive）</td>
</tr>
<tr>
<td>线程模型</td>
<td>每请求一线程</td>
<td>事件循环（Event Loop）</td>
</tr>
<tr>
<td>I&#x2F;O 模型</td>
<td>阻塞 I&#x2F;O</td>
<td>非阻塞 I&#x2F;O</td>
</tr>
<tr>
<td>适用场景</td>
<td>传统 Web 应用</td>
<td>高并发、流式数据</td>
</tr>
<tr>
<td>Servlet 依赖</td>
<td>依赖 Servlet API</td>
<td>可选（支持 Netty）</td>
</tr>
<tr>
<td>数据库支持</td>
<td>JDBC（阻塞）</td>
<td>R2DBC（响应式）</td>
</tr>
</tbody></table>
<h2 id="何时使用-WebFlux"><a href="#何时使用-WebFlux" class="headerlink" title="何时使用 WebFlux"></a>何时使用 WebFlux</h2><h3 id="适合使用的场景"><a href="#适合使用的场景" class="headerlink" title="适合使用的场景"></a>适合使用的场景</h3><ol>
<li><strong>高并发应用</strong>：需要处理大量并发连接（如聊天应用、实时推送）</li>
<li><strong>流式数据处理</strong>：处理实时数据流（如股票行情、IoT 数据）</li>
<li><strong>微服务网关</strong>：作为 API 网关处理大量请求转发</li>
<li><strong>服务间调用密集</strong>：需要大量调用外部服务的应用</li>
</ol>
<h3 id="不适合的场景"><a href="#不适合的场景" class="headerlink" title="不适合的场景"></a>不适合的场景</h3><ol>
<li><strong>CPU 密集型任务</strong>：响应式编程对 CPU 密集型任务没有优势</li>
<li><strong>阻塞依赖</strong>：如果依赖的库是阻塞的（如传统 JDBC），则无法发挥优势</li>
<li><strong>团队不熟悉响应式编程</strong>：学习曲线较陡</li>
</ol>
<h2 id="技术栈对比"><a href="#技术栈对比" class="headerlink" title="技术栈对比"></a>技术栈对比</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                    Spring Boot                          │</span><br><span class="line">├────────────────────────┬────────────────────────────────┤</span><br><span class="line">│     Spring MVC         │        Spring WebFlux          │</span><br><span class="line">├────────────────────────┼────────────────────────────────┤</span><br><span class="line">│     Servlet API        │     Reactive Streams API       │</span><br><span class="line">├────────────────────────┼────────────────────────────────┤</span><br><span class="line">│  Tomcat/Jetty/Undertow │      Netty/Undertow/Servlet    │</span><br><span class="line">└────────────────────────┴────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><h3 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;Hello, WebFlux!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/users&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">getUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>下一篇：响应式编程基础</li>
<li>Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/ThreadLocal%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/ThreadLocal%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">ThreadLocal原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" itemprop="url" rel="index"><span itemprop="name">基础知识</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="ThreadLocal-原理"><a href="#ThreadLocal-原理" class="headerlink" title="ThreadLocal 原理"></a>ThreadLocal 原理</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p><code>ThreadLocal</code> 提供<strong>线程本地变量</strong>，每个线程都有自己独立的变量副本，实现线程间数据隔离。</p>
<h2 id="核心数据结构"><a href="#核心数据结构" class="headerlink" title="核心数据结构"></a>核心数据结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread</span><br><span class="line">  └── ThreadLocalMap threadLocals</span><br><span class="line">        └── Entry[] table</span><br><span class="line">              └── Entry(ThreadLocal&lt;?&gt; key, Object value)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>组件</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Thread.threadLocals</code></td>
<td>每个线程持有的 ThreadLocalMap 实例</td>
</tr>
<tr>
<td><code>ThreadLocalMap</code></td>
<td>自定义哈希表，存储线程本地变量</td>
</tr>
<tr>
<td><code>Entry</code></td>
<td>继承 <code>WeakReference&lt;ThreadLocal&lt;?&gt;&gt;</code> 的键值对</td>
</tr>
</tbody></table>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><h3 id="1-set-方法"><a href="#1-set-方法" class="headerlink" title="1. set() 方法"></a>1. set() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);  <span class="comment">// 获取当前线程的 ThreadLocalMap</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        map.set(<span class="built_in">this</span>, value);        <span class="comment">// this 是 ThreadLocal 实例作为 key</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        createMap(t, value);         <span class="comment">// 首次使用，创建 map</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-get-方法"><a href="#2-get-方法" class="headerlink" title="2. get() 方法"></a>2. get() 方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) e.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();  <span class="comment">// 返回初始值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-数据存储位置"><a href="#3-数据存储位置" class="headerlink" title="3. 数据存储位置"></a>3. 数据存储位置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[ThreadLocal.get/set] --&gt; B[Thread.currentThread]</span><br><span class="line">    B --&gt; C[thread.threadLocals]</span><br><span class="line">    C --&gt; D[ThreadLocalMap]</span><br><span class="line">    D --&gt; E[Entry数组]</span><br><span class="line">    E --&gt; F[&quot;key=ThreadLocal实例&lt;br/&gt;value=线程本地值&quot;]</span><br></pre></td></tr></table></figure>

<h2 id="关键设计"><a href="#关键设计" class="headerlink" title="关键设计"></a>关键设计</h2><h3 id="Entry-使用弱引用"><a href="#Entry-使用弱引用" class="headerlink" title="Entry 使用弱引用"></a>Entry 使用弱引用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    Object value;</span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="built_in">super</span>(k);  <span class="comment">// key 是弱引用</span></span><br><span class="line">        value = v; <span class="comment">// value 是强引用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>为什么 key 用弱引用？</strong> 👉Java引用类型详解 ^weak-ref-design</p>
<ul>
<li>当外部不再持有 ThreadLocal 引用时，GC 可以回收 ThreadLocal 对象</li>
<li>避免 ThreadLocal 对象本身的内存泄漏</li>
</ul>
<h3 id="哈希冲突处理"><a href="#哈希冲突处理" class="headerlink" title="哈希冲突处理"></a>哈希冲突处理</h3><p>ThreadLocalMap 使用<strong>线性探测法</strong>解决哈希冲突：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len - <span class="number">1</span>);  <span class="comment">// 计算下标</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 线性探测</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// 找到相同 key 或空槽位</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="内存泄漏问题"><a href="#内存泄漏问题" class="headerlink" title="内存泄漏问题"></a>内存泄漏问题</h2><h3 id="泄漏场景"><a href="#泄漏场景" class="headerlink" title="泄漏场景"></a>泄漏场景</h3><table>
<thead>
<tr>
<th>条件</th>
<th>结果</th>
</tr>
</thead>
<tbody><tr>
<td>ThreadLocal 被回收（弱引用）</td>
<td>Entry.key &#x3D; null</td>
</tr>
<tr>
<td>线程仍存活（如线程池）</td>
<td>Entry.value 无法回收</td>
</tr>
</tbody></table>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p><strong>始终在使用后调用 <code>remove()</code></strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal&lt;User&gt; userContext = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    userContext.set(currentUser);</span><br><span class="line">    <span class="comment">// 业务逻辑</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    userContext.remove();  <span class="comment">// 必须清理！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h2><table>
<thead>
<tr>
<th>场景</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>用户上下文</td>
<td>存储当前登录用户信息</td>
</tr>
<tr>
<td>数据库连接</td>
<td>保证同一线程使用同一连接</td>
</tr>
<tr>
<td>事务管理</td>
<td>Spring 的事务同步</td>
</tr>
<tr>
<td>日期格式化</td>
<td>SimpleDateFormat 线程安全使用</td>
</tr>
<tr>
<td>链路追踪</td>
<td>TraceId 在线程内传递</td>
</tr>
</tbody></table>
<h2 id="与同步机制对比"><a href="#与同步机制对比" class="headerlink" title="与同步机制对比"></a>与同步机制对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>ThreadLocal</th>
<th>synchronized&#x2F;Lock</th>
</tr>
</thead>
<tbody><tr>
<td>原理</td>
<td>空间换时间，每个线程一份副本</td>
<td>时间换空间，排队访问</td>
</tr>
<tr>
<td>性能</td>
<td>无竞争，性能高</td>
<td>有锁竞争开销</td>
</tr>
<tr>
<td>适用场景</td>
<td>线程独享数据</td>
<td>线程共享数据</td>
</tr>
</tbody></table>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li><strong>存储位置</strong>：数据存在每个线程的 <code>threadLocals</code> 字段中</li>
<li><strong>数据结构</strong>：ThreadLocalMap 是自定义哈希表，Entry 的 key 是弱引用</li>
<li><strong>核心思想</strong>：用空间换时间，避免同步开销</li>
<li><strong>注意事项</strong>：使用后必须调用 <code>remove()</code> 防止内存泄漏</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/WebFlux%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/WebFlux%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">WebFlux核心组件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="WebFlux-核心组件"><a href="#WebFlux-核心组件" class="headerlink" title="WebFlux 核心组件"></a>WebFlux 核心组件</h1><h2 id="注解式编程模型"><a href="#注解式编程模型" class="headerlink" title="注解式编程模型"></a>注解式编程模型</h2><p>WebFlux 支持与 Spring MVC 类似的注解式编程，使用 <code>@Controller</code> 和 <code>@RestController</code>。</p>
<h3 id="基本控制器"><a href="#基本控制器" class="headerlink" title="基本控制器"></a>基本控制器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserController</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">updateUser</span><span class="params">(<span class="meta">@PathVariable</span> String id, <span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.update(id, user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="响应式返回类型"><a href="#响应式返回类型" class="headerlink" title="响应式返回类型"></a>响应式返回类型</h3><table>
<thead>
<tr>
<th>返回类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Mono&lt;T&gt;</code></td>
<td>返回单个对象</td>
</tr>
<tr>
<td><code>Flux&lt;T&gt;</code></td>
<td>返回多个对象（流式）</td>
</tr>
<tr>
<td><code>Mono&lt;Void&gt;</code></td>
<td>无返回值</td>
</tr>
<tr>
<td><code>Mono&lt;ResponseEntity&lt;T&gt;&gt;</code></td>
<td>自定义响应</td>
</tr>
</tbody></table>
<h2 id="WebClient-响应式-HTTP-客户端"><a href="#WebClient-响应式-HTTP-客户端" class="headerlink" title="WebClient - 响应式 HTTP 客户端"></a>WebClient - 响应式 HTTP 客户端</h2><p><code>WebClient</code> 是 WebFlux 提供的非阻塞 HTTP 客户端，用于替代 <code>RestTemplate</code>。</p>
<h3 id="创建-WebClient"><a href="#创建-WebClient" class="headerlink" title="创建 WebClient"></a>创建 WebClient</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本创建</span></span><br><span class="line"><span class="type">WebClient</span> <span class="variable">client</span> <span class="operator">=</span> WebClient.create();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带基础 URL</span></span><br><span class="line"><span class="type">WebClient</span> <span class="variable">client</span> <span class="operator">=</span> WebClient.create(<span class="string">&quot;http://localhost:8080&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Builder 自定义</span></span><br><span class="line"><span class="type">WebClient</span> <span class="variable">client</span> <span class="operator">=</span> WebClient.builder()</span><br><span class="line">    .baseUrl(<span class="string">&quot;http://localhost:8080&quot;</span>)</span><br><span class="line">    .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)</span><br><span class="line">    .defaultHeader(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer token&quot;</span>)</span><br><span class="line">    .filter(ExchangeFilterFunction.ofRequestProcessor(</span><br><span class="line">        request -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Request: &#123;&#125; &#123;&#125;&quot;</span>, request.method(), request.url());</span><br><span class="line">            <span class="keyword">return</span> Mono.just(request);</span><br><span class="line">        &#125;</span><br><span class="line">    ))</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<h3 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取单个对象</span></span><br><span class="line">Mono&lt;User&gt; user = webClient.get()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToMono(User.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取列表</span></span><br><span class="line">Flux&lt;User&gt; users = webClient.get()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToFlux(User.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带查询参数</span></span><br><span class="line">Flux&lt;User&gt; users = webClient.get()</span><br><span class="line">    .uri(uriBuilder -&gt; uriBuilder</span><br><span class="line">        .path(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">        .queryParam(<span class="string">&quot;page&quot;</span>, <span class="number">0</span>)</span><br><span class="line">        .queryParam(<span class="string">&quot;size&quot;</span>, <span class="number">10</span>)</span><br><span class="line">        .build())</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToFlux(User.class);</span><br></pre></td></tr></table></figure>

<h3 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;User&gt; createdUser = webClient.post()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">    .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">    .bodyValue(newUser)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToMono(User.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 Mono 作为请求体</span></span><br><span class="line">Mono&lt;User&gt; createdUser = webClient.post()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">    .body(userMono, User.class)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToMono(User.class);</span><br></pre></td></tr></table></figure>

<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;User&gt; user = webClient.get()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .onStatus(HttpStatusCode::is4xxClientError, response -&gt; </span><br><span class="line">        Mono.error(<span class="keyword">new</span> <span class="title class_">NotFoundException</span>(<span class="string">&quot;User not found&quot;</span>)))</span><br><span class="line">    .onStatus(HttpStatusCode::is5xxServerError, response -&gt; </span><br><span class="line">        Mono.error(<span class="keyword">new</span> <span class="title class_">ServerException</span>(<span class="string">&quot;Server error&quot;</span>)))</span><br><span class="line">    .bodyToMono(User.class);</span><br></pre></td></tr></table></figure>

<h3 id="使用-exchange-获取完整响应"><a href="#使用-exchange-获取完整响应" class="headerlink" title="使用 exchange() 获取完整响应"></a>使用 exchange() 获取完整响应</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;ResponseEntity&lt;User&gt;&gt; response = webClient.get()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, userId)</span><br><span class="line">    .exchangeToMono(clientResponse -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (clientResponse.statusCode().is2xxSuccessful()) &#123;</span><br><span class="line">            <span class="keyword">return</span> clientResponse.toEntity(User.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> clientResponse.createException().flatMap(Mono::error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="ServerRequest-和-ServerResponse"><a href="#ServerRequest-和-ServerResponse" class="headerlink" title="ServerRequest 和 ServerResponse"></a>ServerRequest 和 ServerResponse</h2><p>这两个类用于函数式端点编程。</p>
<h3 id="ServerRequest"><a href="#ServerRequest" class="headerlink" title="ServerRequest"></a>ServerRequest</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取路径变量</span></span><br><span class="line"><span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取查询参数</span></span><br><span class="line">Optional&lt;String&gt; name = request.queryParam(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求头</span></span><br><span class="line"><span class="type">String</span> <span class="variable">contentType</span> <span class="operator">=</span> request.headers().contentType()</span><br><span class="line">    .map(MediaType::toString)</span><br><span class="line">    .orElse(<span class="string">&quot;unknown&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取请求体</span></span><br><span class="line">Mono&lt;User&gt; user = request.bodyToMono(User.class);</span><br><span class="line">Flux&lt;User&gt; users = request.bodyToFlux(User.class);</span><br></pre></td></tr></table></figure>

<h3 id="ServerResponse"><a href="#ServerResponse" class="headerlink" title="ServerResponse"></a>ServerResponse</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 成功响应</span></span><br><span class="line">ServerResponse.ok()</span><br><span class="line">    .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">    .bodyValue(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回 Mono</span></span><br><span class="line">ServerResponse.ok().body(userMono, User.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回 Flux</span></span><br><span class="line">ServerResponse.ok().body(userFlux, User.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建响应</span></span><br><span class="line">ServerResponse.created(URI.create(<span class="string">&quot;/api/users/&quot;</span> + id))</span><br><span class="line">    .bodyValue(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无内容响应</span></span><br><span class="line">ServerResponse.noContent().build();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误响应</span></span><br><span class="line">ServerResponse.notFound().build();</span><br><span class="line">ServerResponse.badRequest().bodyValue(<span class="string">&quot;Invalid request&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="使用-ExceptionHandler"><a href="#使用-ExceptionHandler" class="headerlink" title="使用 @ExceptionHandler"></a>使用 @ExceptionHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(NotFoundException.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NOT_FOUND)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ErrorResponse&gt; <span class="title function_">handleNotFound</span><span class="params">(NotFoundException ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(ex.getMessage()));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ErrorResponse&gt; <span class="title function_">handleException</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="keyword">new</span> <span class="title class_">ErrorResponse</span>(<span class="string">&quot;Internal server error&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-WebExceptionHandler"><a href="#使用-WebExceptionHandler" class="headerlink" title="使用 WebExceptionHandler"></a>使用 WebExceptionHandler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(-2)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GlobalWebExceptionHandler</span> <span class="keyword">implements</span> <span class="title class_">WebExceptionHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">handle</span><span class="params">(ServerWebExchange exchange, Throwable ex)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> NotFoundException) &#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_FOUND);</span><br><span class="line">            <span class="comment">// 写入响应体...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Mono.error(ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="过滤器（WebFilter）"><a href="#过滤器（WebFilter）" class="headerlink" title="过滤器（WebFilter）"></a>过滤器（WebFilter）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggingFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">startTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange)</span><br><span class="line">            .doFinally(signalType -&gt; &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">duration</span> <span class="operator">=</span> System.currentTimeMillis() - startTime;</span><br><span class="line">                log.info(<span class="string">&quot;Request &#123;&#125; &#123;&#125; completed in &#123;&#125;ms&quot;</span>,</span><br><span class="line">                    exchange.getRequest().getMethod(),</span><br><span class="line">                    exchange.getRequest().getPath(),</span><br><span class="line">                    duration);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：Reactor核心API</li>
<li>下一篇：函数式端点</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%AB%AF%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%AB%AF%E7%82%B9/" class="post-title-link" itemprop="url">函数式端点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="函数式端点"><a href="#函数式端点" class="headerlink" title="函数式端点"></a>函数式端点</h1><h2 id="什么是函数式端点"><a href="#什么是函数式端点" class="headerlink" title="什么是函数式端点"></a>什么是函数式端点</h2><p>函数式端点（Functional Endpoints）是 WebFlux 提供的另一种编程模型，使用<strong>函数式风格</strong>定义路由和处理器，相比注解式更加灵活。</p>
<h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><ul>
<li><strong>HandlerFunction</strong>：处理请求的函数，类似于 <code>@RequestMapping</code> 方法</li>
<li><strong>RouterFunction</strong>：路由函数，将请求映射到 HandlerFunction</li>
</ul>
<h2 id="HandlerFunction"><a href="#HandlerFunction" class="headerlink" title="HandlerFunction"></a>HandlerFunction</h2><p><code>HandlerFunction&lt;T extends ServerResponse&gt;</code> 是一个函数式接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerFunction</span>&lt;T <span class="keyword">extends</span> <span class="title class_">ServerResponse</span>&gt; &#123;</span><br><span class="line">    Mono&lt;T&gt; <span class="title function_">handle</span><span class="params">(ServerRequest request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="定义-Handler"><a href="#定义-Handler" class="headerlink" title="定义 Handler"></a>定义 Handler</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserHandler</span><span class="params">(UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">getAllUsers</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok()</span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">            .body(userService.findAll(), User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">getUserById</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userService.findById(id)</span><br><span class="line">            .flatMap(user -&gt; ServerResponse.ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .bodyValue(user))</span><br><span class="line">            .switchIfEmpty(ServerResponse.notFound().build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">createUser</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request.bodyToMono(User.class)</span><br><span class="line">            .flatMap(userService::save)</span><br><span class="line">            .flatMap(user -&gt; ServerResponse</span><br><span class="line">                .created(URI.create(<span class="string">&quot;/api/users/&quot;</span> + user.getId()))</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .bodyValue(user));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">updateUser</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> request.bodyToMono(User.class)</span><br><span class="line">            .flatMap(user -&gt; userService.update(id, user))</span><br><span class="line">            .flatMap(user -&gt; ServerResponse.ok()</span><br><span class="line">                .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">                .bodyValue(user))</span><br><span class="line">            .switchIfEmpty(ServerResponse.notFound().build());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">deleteUser</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> userService.deleteById(id)</span><br><span class="line">            .then(ServerResponse.noContent().build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RouterFunction"><a href="#RouterFunction" class="headerlink" title="RouterFunction"></a>RouterFunction</h2><p><code>RouterFunction&lt;T extends ServerResponse&gt;</code> 用于定义路由规则。</p>
<h3 id="基本路由定义"><a href="#基本路由定义" class="headerlink" title="基本路由定义"></a>基本路由定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouterConfig</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">userRoutes</span><span class="params">(UserHandler handler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions.route()</span><br><span class="line">            .GET(<span class="string">&quot;/api/users&quot;</span>, handler::getAllUsers)</span><br><span class="line">            .GET(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)</span><br><span class="line">            .POST(<span class="string">&quot;/api/users&quot;</span>, handler::createUser)</span><br><span class="line">            .PUT(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::updateUser)</span><br><span class="line">            .DELETE(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::deleteUser)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-nest-组织路由"><a href="#使用-nest-组织路由" class="headerlink" title="使用 nest 组织路由"></a>使用 nest 组织路由</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">routes</span><span class="params">(UserHandler userHandler, </span></span><br><span class="line"><span class="params">                                              OrderHandler orderHandler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route()</span><br><span class="line">        .nest(path(<span class="string">&quot;/api/users&quot;</span>), builder -&gt; builder</span><br><span class="line">            .GET(<span class="string">&quot;&quot;</span>, userHandler::getAllUsers)</span><br><span class="line">            .GET(<span class="string">&quot;/&#123;id&#125;&quot;</span>, userHandler::getUserById)</span><br><span class="line">            .POST(<span class="string">&quot;&quot;</span>, userHandler::createUser)</span><br><span class="line">            .PUT(<span class="string">&quot;/&#123;id&#125;&quot;</span>, userHandler::updateUser)</span><br><span class="line">            .DELETE(<span class="string">&quot;/&#123;id&#125;&quot;</span>, userHandler::deleteUser)</span><br><span class="line">        )</span><br><span class="line">        .nest(path(<span class="string">&quot;/api/orders&quot;</span>), builder -&gt; builder</span><br><span class="line">            .GET(<span class="string">&quot;&quot;</span>, orderHandler::getAllOrders)</span><br><span class="line">            .GET(<span class="string">&quot;/&#123;id&#125;&quot;</span>, orderHandler::getOrderById)</span><br><span class="line">            .POST(<span class="string">&quot;&quot;</span>, orderHandler::createOrder)</span><br><span class="line">        )</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加过滤器"><a href="#添加过滤器" class="headerlink" title="添加过滤器"></a>添加过滤器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">routes</span><span class="params">(UserHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route()</span><br><span class="line">        .GET(<span class="string">&quot;/api/users&quot;</span>, handler::getAllUsers)</span><br><span class="line">        .GET(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)</span><br><span class="line">        .filter((request, next) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 前置处理</span></span><br><span class="line">            log.info(<span class="string">&quot;Request: &#123;&#125; &#123;&#125;&quot;</span>, request.method(), request.path());</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> next.handle(request)</span><br><span class="line">                .doOnNext(response -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 后置处理</span></span><br><span class="line">                    log.info(<span class="string">&quot;Response status: &#123;&#125;&quot;</span>, response.statusCode());</span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="条件路由"><a href="#条件路由" class="headerlink" title="条件路由"></a>条件路由</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">routes</span><span class="params">(UserHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route()</span><br><span class="line">        <span class="comment">// 使用 RequestPredicate 进行条件匹配</span></span><br><span class="line">        .route(GET(<span class="string">&quot;/api/users&quot;</span>).and(accept(MediaType.APPLICATION_JSON)), </span><br><span class="line">               handler::getAllUsers)</span><br><span class="line">        .route(GET(<span class="string">&quot;/api/users&quot;</span>).and(accept(MediaType.TEXT_EVENT_STREAM)), </span><br><span class="line">               handler::streamUsers)</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RequestPredicate"><a href="#RequestPredicate" class="headerlink" title="RequestPredicate"></a>RequestPredicate</h2><p><code>RequestPredicate</code> 用于定义请求匹配条件。</p>
<h3 id="常用谓词"><a href="#常用谓词" class="headerlink" title="常用谓词"></a>常用谓词</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.web.reactive.function.server.RequestPredicates.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HTTP 方法</span></span><br><span class="line">GET(<span class="string">&quot;/path&quot;</span>)</span><br><span class="line">POST(<span class="string">&quot;/path&quot;</span>)</span><br><span class="line">PUT(<span class="string">&quot;/path&quot;</span>)</span><br><span class="line">DELETE(<span class="string">&quot;/path&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 内容类型</span></span><br><span class="line">accept(MediaType.APPLICATION_JSON)</span><br><span class="line">contentType(MediaType.APPLICATION_JSON)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 路径匹配</span></span><br><span class="line">path(<span class="string">&quot;/api/**&quot;</span>)</span><br><span class="line">pathExtension(<span class="string">&quot;json&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询参数</span></span><br><span class="line">queryParam(<span class="string">&quot;name&quot;</span>, value -&gt; value.length() &gt; <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 请求头</span></span><br><span class="line">headers(headers -&gt; headers.header(<span class="string">&quot;X-Custom&quot;</span>).isPresent())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 组合条件</span></span><br><span class="line">GET(<span class="string">&quot;/api/users&quot;</span>).and(accept(MediaType.APPLICATION_JSON))</span><br><span class="line">GET(<span class="string">&quot;/api/users&quot;</span>).or(GET(<span class="string">&quot;/users&quot;</span>))</span><br></pre></td></tr></table></figure>

<h2 id="请求验证"><a href="#请求验证" class="headerlink" title="请求验证"></a>请求验证</h2><h3 id="手动验证"><a href="#手动验证" class="headerlink" title="手动验证"></a>手动验证</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">createUser</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> request.bodyToMono(User.class)</span><br><span class="line">        .flatMap(user -&gt; &#123;</span><br><span class="line">            <span class="comment">// 验证</span></span><br><span class="line">            List&lt;String&gt; errors = validate(user);</span><br><span class="line">            <span class="keyword">if</span> (!errors.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">return</span> ServerResponse.badRequest()</span><br><span class="line">                    .bodyValue(<span class="keyword">new</span> <span class="title class_">ValidationError</span>(errors));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> userService.save(user)</span><br><span class="line">                .flatMap(saved -&gt; ServerResponse.created(</span><br><span class="line">                    URI.create(<span class="string">&quot;/api/users/&quot;</span> + saved.getId()))</span><br><span class="line">                    .bodyValue(saved));</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">validate</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    List&lt;String&gt; errors = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (user.getName() == <span class="literal">null</span> || user.getName().isBlank()) &#123;</span><br><span class="line">        errors.add(<span class="string">&quot;Name is required&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (user.getEmail() == <span class="literal">null</span> || !user.getEmail().contains(<span class="string">&quot;@&quot;</span>)) &#123;</span><br><span class="line">        errors.add(<span class="string">&quot;Valid email is required&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> errors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Validator"><a href="#使用-Validator" class="headerlink" title="使用 Validator"></a>使用 Validator</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserHandler</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Validator validator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">createUser</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request.bodyToMono(User.class)</span><br><span class="line">            .flatMap(user -&gt; &#123;</span><br><span class="line">                <span class="type">Errors</span> <span class="variable">errors</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanPropertyBindingResult</span>(user, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">                validator.validate(user, errors);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (errors.hasErrors()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> ServerResponse.badRequest()</span><br><span class="line">                        .bodyValue(errors.getAllErrors());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">return</span> userService.save(user)</span><br><span class="line">                    .flatMap(saved -&gt; ServerResponse.created(</span><br><span class="line">                        URI.create(<span class="string">&quot;/api/users/&quot;</span> + saved.getId()))</span><br><span class="line">                        .bodyValue(saved));</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">routes</span><span class="params">(UserHandler handler)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions.route()</span><br><span class="line">        .GET(<span class="string">&quot;/api/users/&#123;id&#125;&quot;</span>, handler::getUserById)</span><br><span class="line">        .onError(NotFoundException.class, (e, request) -&gt; </span><br><span class="line">            ServerResponse.notFound().build())</span><br><span class="line">        .onError(ValidationException.class, (e, request) -&gt; </span><br><span class="line">            ServerResponse.badRequest().bodyValue(e.getMessage()))</span><br><span class="line">        .onError(Exception.class, (e, request) -&gt; </span><br><span class="line">            ServerResponse.status(HttpStatus.INTERNAL_SERVER_ERROR)</span><br><span class="line">                .bodyValue(<span class="string">&quot;Internal server error&quot;</span>))</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数式-vs-注解式"><a href="#函数式-vs-注解式" class="headerlink" title="函数式 vs 注解式"></a>函数式 vs 注解式</h2><table>
<thead>
<tr>
<th>特性</th>
<th>注解式</th>
<th>函数式</th>
</tr>
</thead>
<tbody><tr>
<td>代码风格</td>
<td>声明式</td>
<td>函数式</td>
</tr>
<tr>
<td>路由定义</td>
<td>分散在各个方法</td>
<td>集中在一处</td>
</tr>
<tr>
<td>灵活性</td>
<td>较低</td>
<td>较高</td>
</tr>
<tr>
<td>学习曲线</td>
<td>较低</td>
<td>较高</td>
</tr>
<tr>
<td>测试</td>
<td>需要 Spring 上下文</td>
<td>可以单元测试</td>
</tr>
<tr>
<td>适用场景</td>
<td>传统 CRUD</td>
<td>复杂路由逻辑</td>
</tr>
</tbody></table>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：WebFlux核心组件</li>
<li>下一篇：实战案例</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E5%93%8D%E5%BA%94%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">响应式编程基础</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="响应式编程基础"><a href="#响应式编程基础" class="headerlink" title="响应式编程基础"></a>响应式编程基础</h1><h2 id="什么是响应式编程"><a href="#什么是响应式编程" class="headerlink" title="什么是响应式编程"></a>什么是响应式编程</h2><p>响应式编程（Reactive Programming）是一种<strong>面向数据流和变化传播</strong>的编程范式。它关注的是数据流的异步处理和事件驱动。</p>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><ul>
<li><strong>数据流（Stream）</strong>：数据以流的形式传递，而非一次性返回</li>
<li><strong>异步（Asynchronous）</strong>：操作不会阻塞当前线程</li>
<li><strong>非阻塞（Non-blocking）</strong>：线程不会等待 I&#x2F;O 操作完成</li>
<li><strong>背压（Backpressure）</strong>：消费者可以控制生产者的数据发送速率</li>
</ul>
<h2 id="Reactive-Streams-规范"><a href="#Reactive-Streams-规范" class="headerlink" title="Reactive Streams 规范"></a>Reactive Streams 规范</h2><p>Reactive Streams 是 JVM 上响应式编程的标准规范，定义了四个核心接口：</p>
<h3 id="1-Publisher（发布者）"><a href="#1-Publisher（发布者）" class="headerlink" title="1. Publisher（发布者）"></a>1. Publisher（发布者）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Publisher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">subscribe</span><span class="params">(Subscriber&lt;? <span class="built_in">super</span> T&gt; s)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数据的生产者</li>
<li>可以发布无限或有限数量的元素</li>
</ul>
<h3 id="2-Subscriber（订阅者）"><a href="#2-Subscriber（订阅者）" class="headerlink" title="2. Subscriber（订阅者）"></a>2. Subscriber（订阅者）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscriber</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onSubscribe</span><span class="params">(Subscription s)</span>;  <span class="comment">// 订阅成功时调用</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(T t)</span>;                   <span class="comment">// 接收到新元素时调用</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span>;          <span class="comment">// 发生错误时调用</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span>;                  <span class="comment">// 数据流结束时调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数据的消费者</li>
<li>通过回调方法接收数据和事件</li>
</ul>
<h3 id="3-Subscription（订阅关系）"><a href="#3-Subscription（订阅关系）" class="headerlink" title="3. Subscription（订阅关系）"></a>3. Subscription（订阅关系）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subscription</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">request</span><span class="params">(<span class="type">long</span> n)</span>;  <span class="comment">// 请求 n 个元素</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span>;         <span class="comment">// 取消订阅</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>表示 Publisher 和 Subscriber 之间的订阅关系</li>
<li><strong>背压的核心</strong>：通过 <code>request(n)</code> 控制数据流速</li>
</ul>
<h3 id="4-Processor（处理器）"><a href="#4-Processor（处理器）" class="headerlink" title="4. Processor（处理器）"></a>4. Processor（处理器）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Processor</span>&lt;T, R&gt; <span class="keyword">extends</span> <span class="title class_">Subscriber</span>&lt;T&gt;, Publisher&lt;R&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>既是订阅者又是发布者</li>
<li>用于数据转换和处理</li>
</ul>
<h2 id="数据流生命周期"><a href="#数据流生命周期" class="headerlink" title="数据流生命周期"></a>数据流生命周期</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────┐     subscribe()      ┌──────────────┐</span><br><span class="line">│   Publisher  │ ──────────────────▶  │  Subscriber  │</span><br><span class="line">└──────────────┘                      └──────────────┘</span><br><span class="line">       │                                     │</span><br><span class="line">       │         onSubscribe(subscription)   │</span><br><span class="line">       │ ◀────────────────────────────────── │</span><br><span class="line">       │                                     │</span><br><span class="line">       │         request(n)                  │</span><br><span class="line">       │ ◀────────────────────────────────── │</span><br><span class="line">       │                                     │</span><br><span class="line">       │         onNext(data) × n            │</span><br><span class="line">       │ ──────────────────────────────────▶ │</span><br><span class="line">       │                                     │</span><br><span class="line">       │         onComplete() / onError()    │</span><br><span class="line">       │ ──────────────────────────────────▶ │</span><br><span class="line">       ▼                                     ▼</span><br></pre></td></tr></table></figure>

<h2 id="背压（Backpressure）"><a href="#背压（Backpressure）" class="headerlink" title="背压（Backpressure）"></a>背压（Backpressure）</h2><p>背压是响应式编程中的重要概念，用于解决<strong>生产者速度快于消费者</strong>的问题。</p>
<h3 id="背压策略"><a href="#背压策略" class="headerlink" title="背压策略"></a>背压策略</h3><table>
<thead>
<tr>
<th>策略</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Buffer</strong></td>
<td>缓存所有元素，可能导致内存溢出</td>
</tr>
<tr>
<td><strong>Drop</strong></td>
<td>丢弃无法处理的元素</td>
</tr>
<tr>
<td><strong>Latest</strong></td>
<td>只保留最新的元素</td>
</tr>
<tr>
<td><strong>Error</strong></td>
<td>抛出异常</td>
</tr>
</tbody></table>
<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">1000</span>)</span><br><span class="line">    .onBackpressureBuffer(<span class="number">100</span>)      <span class="comment">// 缓存100个元素</span></span><br><span class="line">    .onBackpressureDrop()           <span class="comment">// 丢弃多余元素</span></span><br><span class="line">    .onBackpressureLatest()         <span class="comment">// 只保留最新</span></span><br><span class="line">    .subscribe(data -&gt; &#123;</span><br><span class="line">        <span class="comment">// 处理数据</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h2 id="响应式编程的优势"><a href="#响应式编程的优势" class="headerlink" title="响应式编程的优势"></a>响应式编程的优势</h2><ol>
<li><strong>资源利用率高</strong>：少量线程处理大量请求</li>
<li><strong>响应性好</strong>：不会因为某个操作阻塞整个系统</li>
<li><strong>弹性</strong>：更容易处理错误和故障</li>
<li><strong>可组合性</strong>：操作符可以灵活组合</li>
</ol>
<h2 id="响应式编程的挑战"><a href="#响应式编程的挑战" class="headerlink" title="响应式编程的挑战"></a>响应式编程的挑战</h2><ol>
<li><strong>调试困难</strong>：异步代码的堆栈跟踪不直观</li>
<li><strong>学习曲线</strong>：需要转变思维方式</li>
<li><strong>生态限制</strong>：需要整个调用链都是响应式的</li>
</ol>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：Webflux简介</li>
<li>下一篇：Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B/" class="post-title-link" itemprop="url">实战案例</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Webflux/" itemprop="url" rel="index"><span itemprop="name">Webflux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">webflux-demo/</span><br><span class="line">├── src/main/java/com/example/demo/</span><br><span class="line">│   ├── DemoApplication.java</span><br><span class="line">│   ├── config/</span><br><span class="line">│   │   └── RouterConfig.java</span><br><span class="line">│   ├── controller/</span><br><span class="line">│   │   └── UserController.java</span><br><span class="line">│   ├── handler/</span><br><span class="line">│   │   └── UserHandler.java</span><br><span class="line">│   ├── model/</span><br><span class="line">│   │   └── User.java</span><br><span class="line">│   ├── repository/</span><br><span class="line">│   │   └── UserRepository.java</span><br><span class="line">│   └── service/</span><br><span class="line">│       └── UserService.java</span><br><span class="line">├── src/main/resources/</span><br><span class="line">│   └── application.yml</span><br><span class="line">└── pom.xml</span><br></pre></td></tr></table></figure>

<h2 id="Maven-依赖"><a href="#Maven-依赖" class="headerlink" title="Maven 依赖"></a>Maven 依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 </span></span></span><br><span class="line"><span class="string"><span class="tag">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webflux-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- WebFlux --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- R2DBC (响应式数据库) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- H2 数据库 (开发测试用) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.r2dbc<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- Lombok --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">&lt;!-- 测试 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.annotation.Id;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.relational.core.mapping.Table;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Table(&quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime updatedAt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Repository"><a href="#Repository" class="headerlink" title="Repository"></a>Repository</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.r2dbc.repository.Query;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.repository.reactive.ReactiveCrudRepository;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserRepository</span> <span class="keyword">extends</span> <span class="title class_">ReactiveCrudRepository</span>&lt;User, Long&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    Mono&lt;User&gt; <span class="title function_">findByEmail</span><span class="params">(String email)</span>;</span><br><span class="line">    </span><br><span class="line">    Flux&lt;User&gt; <span class="title function_">findByNameContaining</span><span class="params">(String name)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Query(&quot;SELECT * FROM users WHERE created_at &gt; :since&quot;)</span></span><br><span class="line">    Flux&lt;User&gt; <span class="title function_">findRecentUsers</span><span class="params">(LocalDateTime since)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.repository.UserRepository;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserRepository userRepository;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">findById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">findByEmail</span><span class="params">(String email)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findByEmail(email);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">save</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        user.setCreatedAt(LocalDateTime.now());</span><br><span class="line">        user.setUpdatedAt(LocalDateTime.now());</span><br><span class="line">        <span class="keyword">return</span> userRepository.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">update</span><span class="params">(Long id, User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.findById(id)</span><br><span class="line">            .flatMap(existingUser -&gt; &#123;</span><br><span class="line">                existingUser.setName(user.getName());</span><br><span class="line">                existingUser.setEmail(user.getEmail());</span><br><span class="line">                existingUser.setUpdatedAt(LocalDateTime.now());</span><br><span class="line">                <span class="keyword">return</span> userRepository.save(existingUser);</span><br><span class="line">            &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userRepository.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Controller（注解式）"><a href="#Controller（注解式）" class="headerlink" title="Controller（注解式）"></a>Controller（注解式）</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> lombok.RequiredArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/users&quot;)</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.CREATED)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">createUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.save(user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PutMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">updateUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id, <span class="meta">@RequestBody</span> User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.update(id, user);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.NO_CONTENT)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// SSE 流式响应示例</span></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/stream&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">streamUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userService.findAll()</span><br><span class="line">            .delayElements(Duration.ofSeconds(<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># application.yml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">r2dbc:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">r2dbc:h2:mem:///testdb</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">sa</span></span><br><span class="line">    <span class="attr">password:</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">sql:</span></span><br><span class="line">    <span class="attr">init:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">always</span></span><br><span class="line">      <span class="attr">schema-locations:</span> <span class="string">classpath:schema.sql</span></span><br><span class="line"></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">org.springframework.r2dbc:</span> <span class="string">DEBUG</span></span><br></pre></td></tr></table></figure>

<h2 id="数据库初始化脚本"><a href="#数据库初始化脚本" class="headerlink" title="数据库初始化脚本"></a>数据库初始化脚本</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- schema.sql</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> users (</span><br><span class="line">    id <span class="type">BIGINT</span> AUTO_INCREMENT <span class="keyword">PRIMARY KEY</span>,</span><br><span class="line">    name <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">NOT NULL</span>,</span><br><span class="line">    email <span class="type">VARCHAR</span>(<span class="number">100</span>) <span class="keyword">UNIQUE</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">    created_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    updated_at <span class="type">TIMESTAMP</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;张三&#x27;</span>, <span class="string">&#x27;zhangsan@example.com&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> users (name, email) <span class="keyword">VALUES</span> (<span class="string">&#x27;李四&#x27;</span>, <span class="string">&#x27;lisi@example.com&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="WebClient-调用示例"><a href="#WebClient-调用示例" class="headerlink" title="WebClient 调用示例"></a>WebClient 调用示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.client.WebClient;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Flux;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClient</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserClient</span><span class="params">(WebClient.Builder builder)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.webClient = builder</span><br><span class="line">            .baseUrl(<span class="string">&quot;http://localhost:8080/api&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;User&gt; <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">            .uri(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToFlux(User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">getUserById</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.get()</span><br><span class="line">            .uri(<span class="string">&quot;/users/&#123;id&#125;&quot;</span>, id)</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToMono(User.class);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">createUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webClient.post()</span><br><span class="line">            .uri(<span class="string">&quot;/users&quot;</span>)</span><br><span class="line">            .bodyValue(user)</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToMono(User.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.demo.model.User;</span><br><span class="line"><span class="keyword">import</span> com.example.demo.service.UserService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.autoconfigure.web.reactive.AutoConfigureWebTestClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.web.reactive.server.WebTestClient;</span><br><span class="line"><span class="keyword">import</span> reactor.test.StepVerifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@AutoConfigureWebTestClient</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserControllerTest</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> WebTestClient webTestClient;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">getAllUsers</span><span class="params">()</span> &#123;</span><br><span class="line">        webTestClient.get()</span><br><span class="line">            .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">            .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">            .exchange()</span><br><span class="line">            .expectStatus().isOk()</span><br><span class="line">            .expectBodyList(User.class)</span><br><span class="line">            .hasSize(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">getUserById</span><span class="params">()</span> &#123;</span><br><span class="line">        webTestClient.get()</span><br><span class="line">            .uri(<span class="string">&quot;/api/users/1&quot;</span>)</span><br><span class="line">            .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">            .exchange()</span><br><span class="line">            .expectStatus().isOk()</span><br><span class="line">            .expectBody()</span><br><span class="line">            .jsonPath(<span class="string">&quot;$.name&quot;</span>).isEqualTo(<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">newUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        newUser.setName(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">        newUser.setEmail(<span class="string">&quot;wangwu@example.com&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        webTestClient.post()</span><br><span class="line">            .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">            .bodyValue(newUser)</span><br><span class="line">            .exchange()</span><br><span class="line">            .expectStatus().isCreated()</span><br><span class="line">            .expectBody()</span><br><span class="line">            .jsonPath(<span class="string">&quot;$.name&quot;</span>).isEqualTo(<span class="string">&quot;王五&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testServiceWithStepVerifier</span><span class="params">()</span> &#123;</span><br><span class="line">        StepVerifier.create(userService.findAll())</span><br><span class="line">            .expectNextCount(<span class="number">2</span>)</span><br><span class="line">            .verifyComplete();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="性能优化建议"><a href="#性能优化建议" class="headerlink" title="性能优化建议"></a>性能优化建议</h2><ol>
<li><strong>合理使用调度器</strong>：I&#x2F;O 操作使用 <code>boundedElastic</code>，CPU 密集型使用 <code>parallel</code></li>
<li><strong>避免阻塞调用</strong>：确保整个调用链都是非阻塞的</li>
<li><strong>使用连接池</strong>：配置合适的数据库连接池大小</li>
<li><strong>启用压缩</strong>：对响应数据启用 Gzip 压缩</li>
<li><strong>监控指标</strong>：集成 Micrometer 监控响应时间和吞吐量</li>
</ol>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>上一篇：函数式端点</li>
<li>返回：Webflux简介</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E6%B5%81%E5%90%88%E5%B9%B6%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%93%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E6%B5%81%E5%90%88%E5%B9%B6%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%AC%A6%E9%93%BE/" class="post-title-link" itemprop="url">流合并与操作符链</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/Spring/Reactive-Streams/" itemprop="url" rel="index"><span itemprop="name">Reactive Streams</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="流合并与操作符链"><a href="#流合并与操作符链" class="headerlink" title="流合并与操作符链"></a>流合并与操作符链</h1><h2 id="水利系统比喻"><a href="#水利系统比喻" class="headerlink" title="水利系统比喻"></a>水利系统比喻</h2><p>在学习 Reactor 时，可以用水利系统来理解：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──────────────────────────────────────────────────────────────┐</span><br><span class="line">│                     Reactor 水利系统                          │</span><br><span class="line">├──────────────────────────────────────────────────────────────┤</span><br><span class="line">│                                                              │</span><br><span class="line">│  水源类型：                                                   │</span><br><span class="line">│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │</span><br><span class="line">│  │ just()   │  │ interval │  │  HTTP    │  │  Sinks   │     │</span><br><span class="line">│  │ 矿泉水瓶  │  │ 定时滴水  │  │ 外部水管  │  │ 你的水龙头│     │</span><br><span class="line">│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘     │</span><br><span class="line">│       │             │             │             │            │</span><br><span class="line">│       └──────┬──────┴──────┬──────┴──────┬──────┘            │</span><br><span class="line">│              │             │             │                   │</span><br><span class="line">│              ▼             ▼             ▼                   │</span><br><span class="line">│         ┌─────────────────────────────────────┐              │</span><br><span class="line">│         │  merge / concat / zip (合并水管)     │              │</span><br><span class="line">│         └─────────────────┬───────────────────┘              │</span><br><span class="line">│                           │                                  │</span><br><span class="line">│                           ▼                                  │</span><br><span class="line">│         ┌─────────────────────────────────────┐              │</span><br><span class="line">│         │  filter / map / take (处理水管)      │              │</span><br><span class="line">│         └─────────────────┬───────────────────┘              │</span><br><span class="line">│                           │                                  │</span><br><span class="line">│                           ▼                                  │</span><br><span class="line">│         ┌─────────────────────────────────────┐              │</span><br><span class="line">│         │         subscribe (水池)            │              │</span><br><span class="line">│         └─────────────────────────────────────┘              │</span><br><span class="line">│                                                              │</span><br><span class="line">└──────────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>概念</th>
<th>比喻</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Sinks</strong></td>
<td>水龙头</td>
<td>你控制开关，决定什么时候放水</td>
</tr>
<tr>
<td><strong>Flux</strong></td>
<td>水管</td>
<td>只负责传输，不管水从哪来、有多少</td>
</tr>
<tr>
<td><strong>操作符</strong></td>
<td>处理水管</td>
<td>filter&#x3D;过滤器，map&#x3D;转换器，take&#x3D;限流阀</td>
</tr>
<tr>
<td><strong>subscribe</strong></td>
<td>水池</td>
<td>接收最终的水</td>
</tr>
</tbody></table>
<hr>
<h2 id="一、操作符链（水管接水管）"><a href="#一、操作符链（水管接水管）" class="headerlink" title="一、操作符链（水管接水管）"></a>一、操作符链（水管接水管）</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>每个操作符都会创建一个新的 Flux，形成链式调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux.range(<span class="number">1</span>, <span class="number">10</span>)       <span class="comment">// 水源：1到10</span></span><br><span class="line">    .filter(i -&gt; i &gt; <span class="number">5</span>)  <span class="comment">// 过滤：只留大于5的</span></span><br><span class="line">    .map(i -&gt; i * <span class="number">2</span>)     <span class="comment">// 转换：每个乘2</span></span><br><span class="line">    .take(<span class="number">3</span>)             <span class="comment">// 限流：只取3个</span></span><br><span class="line">    .subscribe();        <span class="comment">// 水池：接收</span></span><br></pre></td></tr></table></figure>

<h3 id="数据流动过程"><a href="#数据流动过程" class="headerlink" title="数据流动过程"></a>数据流动过程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐</span><br><span class="line">│ range  │───▶│ filter │───▶│  map   │───▶│  take  │───▶│ 订阅者 │</span><br><span class="line">│1,2...10│    │  &gt;5    │    │  *2    │    │  3个   │    │        │</span><br><span class="line">└────────┘    └────────┘    └────────┘    └────────┘    └────────┘</span><br><span class="line">   10个    →    5个     →     5个     →     3个     →    收到3个</span><br><span class="line">  (6,7,8,9,10) (6,7,8,9,10)  (12,14,16,18,20) (12,14,16)</span><br></pre></td></tr></table></figure>

<h3 id="常用操作符分类"><a href="#常用操作符分类" class="headerlink" title="常用操作符分类"></a>常用操作符分类</h3><table>
<thead>
<tr>
<th>类型</th>
<th>操作符</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>过滤</strong></td>
<td><code>filter</code>, <code>take</code>, <code>skip</code>, <code>distinct</code></td>
<td>筛选数据</td>
</tr>
<tr>
<td><strong>转换</strong></td>
<td><code>map</code>, <code>flatMap</code>, <code>concatMap</code></td>
<td>转换数据</td>
</tr>
<tr>
<td><strong>组合</strong></td>
<td><code>merge</code>, <code>concat</code>, <code>zip</code></td>
<td>合并多个流</td>
</tr>
<tr>
<td><strong>错误处理</strong></td>
<td><code>onErrorReturn</code>, <code>retry</code></td>
<td>处理异常</td>
</tr>
<tr>
<td><strong>副作用</strong></td>
<td><code>doOnNext</code>, <code>doOnError</code>, <code>doOnComplete</code></td>
<td>执行额外操作</td>
</tr>
</tbody></table>
<hr>
<h2 id="二、流合并（多个水龙头合并）"><a href="#二、流合并（多个水龙头合并）" class="headerlink" title="二、流合并（多个水龙头合并）"></a>二、流合并（多个水龙头合并）</h2><h3 id="1-merge-实时混合"><a href="#1-merge-实时混合" class="headerlink" title="1. merge - 实时混合"></a>1. merge - 实时混合</h3><p><strong>特点</strong>：谁有数据谁先输出，不保证顺序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;String&gt; flux1 = Flux.just(<span class="string">&quot;A1&quot;</span>, <span class="string">&quot;A2&quot;</span>).delayElements(Duration.ofMillis(<span class="number">100</span>));</span><br><span class="line">Flux&lt;String&gt; flux2 = Flux.just(<span class="string">&quot;B1&quot;</span>, <span class="string">&quot;B2&quot;</span>).delayElements(Duration.ofMillis(<span class="number">80</span>));</span><br><span class="line"></span><br><span class="line">Flux.merge(flux1, flux2).subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 可能输出: B1, A1, B2, A2（谁快谁先）</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flux1 ──A1────A2────┐</span><br><span class="line">                    ├──▶ merge ──▶ B1, A1, B2, A2</span><br><span class="line">flux2 ──B1──B2──────┘</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：实时数据混合、不关心顺序</p>
<h3 id="2-concat-顺序连接"><a href="#2-concat-顺序连接" class="headerlink" title="2. concat - 顺序连接"></a>2. concat - 顺序连接</h3><p><strong>特点</strong>：第一个流完成后，才开始第二个流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Flux.concat(flux1, flux2).subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 输出: A1, A2, B1, B2（先A全部，再B全部）</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flux1 ──A1──A2──┐</span><br><span class="line">                ├──▶ concat ──▶ A1, A2, B1, B2</span><br><span class="line">flux2 ──B1──B2──┘（等A完成再开始）</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：需要保证顺序、分页加载</p>
<h3 id="3-zip-一对一配对"><a href="#3-zip-一对一配对" class="headerlink" title="3. zip - 一对一配对"></a>3. zip - 一对一配对</h3><p><strong>特点</strong>：从每个流各取一个元素，组合成一对</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;String&gt; names = Flux.just(<span class="string">&quot;张三&quot;</span>, <span class="string">&quot;李四&quot;</span>, <span class="string">&quot;王五&quot;</span>);</span><br><span class="line">Flux&lt;Integer&gt; ages = Flux.just(<span class="number">25</span>, <span class="number">30</span>, <span class="number">28</span>);</span><br><span class="line"></span><br><span class="line">Flux.zip(names, ages, (name, age) -&gt; name + <span class="string">&quot;: &quot;</span> + age)</span><br><span class="line">    .subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 输出: 张三: 25, 李四: 30, 王五: 28</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">names ──张三────李四────王五────┐</span><br><span class="line">                               ├──▶ zip ──▶ (张三:25), (李四:30), (王五:28)</span><br><span class="line">ages  ──25──────30──────28─────┘</span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：数据配对、并行请求结果组合</p>
<h3 id="4-combineLatest-组合最新值"><a href="#4-combineLatest-组合最新值" class="headerlink" title="4. combineLatest - 组合最新值"></a>4. combineLatest - 组合最新值</h3><p><strong>特点</strong>：任一流有新值时，与其他流的最新值组合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;String&gt; flux1 = Flux.interval(Duration.ofMillis(<span class="number">100</span>)).map(i -&gt; <span class="string">&quot;A&quot;</span> + i);</span><br><span class="line">Flux&lt;String&gt; flux2 = Flux.interval(Duration.ofMillis(<span class="number">150</span>)).map(i -&gt; <span class="string">&quot;B&quot;</span> + i);</span><br><span class="line"></span><br><span class="line">Flux.combineLatest(flux1, flux2, (a, b) -&gt; a + <span class="string">&quot;+&quot;</span> + b)</span><br><span class="line">    .take(<span class="number">5</span>)</span><br><span class="line">    .subscribe(System.out::println);</span><br><span class="line"><span class="comment">// 输出: A0+B0, A1+B0, A1+B1, A2+B1, A3+B1...</span></span><br></pre></td></tr></table></figure>

<p><strong>适用场景</strong>：实时数据组合、表单联动</p>
<h3 id="合并方式对比"><a href="#合并方式对比" class="headerlink" title="合并方式对比"></a>合并方式对比</h3><table>
<thead>
<tr>
<th>方式</th>
<th>执行顺序</th>
<th>输出顺序</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>merge</code></td>
<td>并行</td>
<td>谁快谁先</td>
<td>实时混合</td>
</tr>
<tr>
<td><code>concat</code></td>
<td>串行</td>
<td>按流顺序</td>
<td>顺序处理</td>
</tr>
<tr>
<td><code>zip</code></td>
<td>并行</td>
<td>配对输出</td>
<td>数据组合</td>
</tr>
<tr>
<td><code>combineLatest</code></td>
<td>并行</td>
<td>最新组合</td>
<td>实时联动</td>
</tr>
</tbody></table>
<hr>
<h2 id="三、实战：外部流-本地流合并"><a href="#三、实战：外部流-本地流合并" class="headerlink" title="三、实战：外部流 + 本地流合并"></a>三、实战：外部流 + 本地流合并</h2><h3 id="场景描述"><a href="#场景描述" class="headerlink" title="场景描述"></a>场景描述</h3><p>调用外部 API（如大模型），同时本地也能推送消息，两个流合并后返回给前端。</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChatService</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebClient webClient;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 系统通知的水龙头</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;String&gt; notificationSink = </span><br><span class="line">        Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取合并后的消息流</span></span><br><span class="line"><span class="comment">     * 用户既能收到大模型回复，也能收到系统通知</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;String&gt; <span class="title function_">getChatStream</span><span class="params">(String prompt)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 外部流：大模型回复</span></span><br><span class="line">        Flux&lt;String&gt; llmResponse = webClient.post()</span><br><span class="line">            .uri(<span class="string">&quot;/v1/chat/completions&quot;</span>)</span><br><span class="line">            .bodyValue(buildRequest(prompt))</span><br><span class="line">            .retrieve()</span><br><span class="line">            .bodyToFlux(String.class)</span><br><span class="line">            .map(<span class="built_in">this</span>::extractContent)</span><br><span class="line">            .filter(Objects::nonNull);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 本地流：系统通知</span></span><br><span class="line">        Flux&lt;String&gt; notifications = notificationSink.asFlux()</span><br><span class="line">            .map(msg -&gt; <span class="string">&quot;[系统] &quot;</span> + msg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 合并两个流</span></span><br><span class="line">        <span class="keyword">return</span> Flux.merge(llmResponse, notifications);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送系统通知（可以在任何地方调用）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendNotification</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        notificationSink.tryEmitNext(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="效果演示"><a href="#效果演示" class="headerlink" title="效果演示"></a>效果演示</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">用户订阅 getChatStream(&quot;你好&quot;)</span><br><span class="line">    │</span><br><span class="line">    ├── 大模型: &quot;你&quot;</span><br><span class="line">    ├── 大模型: &quot;好&quot;</span><br><span class="line">    ├── 系统通知: &quot;[系统] 服务器将在5分钟后维护&quot;  ← 随时插入</span><br><span class="line">    ├── 大模型: &quot;，我是AI助手&quot;</span><br><span class="line">    ├── 系统通知: &quot;[系统] 新功能上线&quot;  ← 随时插入</span><br><span class="line">    └── 大模型: &quot;...&quot;</span><br></pre></td></tr></table></figure>

<h3 id="图示"><a href="#图示" class="headerlink" title="图示"></a>图示</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┐</span><br><span class="line">│   外部 API      │</span><br><span class="line">│  (大模型返回)    │──── llmResponse ─────┐</span><br><span class="line">└─────────────────┘                       │</span><br><span class="line">                                          ├──▶ Flux.merge() ──▶ 前端</span><br><span class="line">┌─────────────────┐                       │</span><br><span class="line">│   本地 Sinks    │                       │</span><br><span class="line">│  (系统通知)      │──── notifications ───┘</span><br><span class="line">└─────────────────┘</span><br><span class="line">       ↑</span><br><span class="line">  sendNotification(&quot;消息&quot;)</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四、生产环境注意事项"><a href="#四、生产环境注意事项" class="headerlink" title="四、生产环境注意事项"></a>四、生产环境注意事项</h2><h3 id="1-背压处理"><a href="#1-背压处理" class="headerlink" title="1. 背压处理"></a>1. 背压处理</h3><p><strong>问题</strong>：上游产生数据太快，下游处理不过来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [错误] 可能导致内存溢出</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">1</span>))  <span class="comment">// 每毫秒一个</span></span><br><span class="line">    .subscribe(data -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);  <span class="comment">// 处理很慢</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [正确] 添加背压策略</span></span><br><span class="line">Flux.interval(Duration.ofMillis(<span class="number">1</span>))</span><br><span class="line">    .onBackpressureDrop(dropped -&gt; log.warn(<span class="string">&quot;丢弃: &#123;&#125;&quot;</span>, dropped))</span><br><span class="line">    .subscribe(data -&gt; &#123;</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p><strong>背压策略选择</strong>：</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>说明</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><code>onBackpressureBuffer()</code></td>
<td>缓冲</td>
<td>数据不能丢，内存够用</td>
</tr>
<tr>
<td><code>onBackpressureBuffer(100)</code></td>
<td>有限缓冲</td>
<td>控制内存使用</td>
</tr>
<tr>
<td><code>onBackpressureDrop()</code></td>
<td>丢弃</td>
<td>实时数据，可以丢</td>
</tr>
<tr>
<td><code>onBackpressureLatest()</code></td>
<td>只保留最新</td>
<td>状态更新</td>
</tr>
<tr>
<td><code>onBackpressureError()</code></td>
<td>抛异常</td>
<td>不允许背压</td>
</tr>
</tbody></table>
<h3 id="2-错误处理"><a href="#2-错误处理" class="headerlink" title="2. 错误处理"></a>2. 错误处理</h3><p><strong>问题</strong>：一个流出错会导致整个合并流终止</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [错误] llmResponse 出错会导致整个流终止</span></span><br><span class="line">Flux.merge(llmResponse, notifications);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [正确] 单独处理每个流的错误</span></span><br><span class="line">Flux&lt;String&gt; safeLlmResponse = llmResponse</span><br><span class="line">    .onErrorResume(e -&gt; &#123;</span><br><span class="line">        log.error(<span class="string">&quot;大模型调用失败&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> Flux.just(<span class="string">&quot;[错误] 大模型暂时不可用&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">Flux.merge(safeLlmResponse, notifications);</span><br></pre></td></tr></table></figure>

<p><strong>错误处理策略</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回默认值</span></span><br><span class="line">.onErrorReturn(<span class="string">&quot;默认值&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 切换到备用流</span></span><br><span class="line">.onErrorResume(e -&gt; backupFlux)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重试</span></span><br><span class="line">.retry(<span class="number">3</span>)</span><br><span class="line">.retryWhen(Retry.backoff(<span class="number">3</span>, Duration.ofSeconds(<span class="number">1</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 记录错误但继续</span></span><br><span class="line">.onErrorContinue((e, data) -&gt; log.error(<span class="string">&quot;处理失败: &#123;&#125;&quot;</span>, data, e))</span><br></pre></td></tr></table></figure>

<h3 id="3-超时处理"><a href="#3-超时处理" class="headerlink" title="3. 超时处理"></a>3. 超时处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [错误] 外部 API 可能永远不返回</span></span><br><span class="line">Flux&lt;String&gt; response = webClient.get().retrieve().bodyToFlux(String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [正确] 设置超时</span></span><br><span class="line">Flux&lt;String&gt; response = webClient.get()</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToFlux(String.class)</span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">30</span>))</span><br><span class="line">    .onErrorResume(TimeoutException.class, e -&gt; </span><br><span class="line">        Flux.just(<span class="string">&quot;[超时] 请求超时，请重试&quot;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="4-资源清理"><a href="#4-资源清理" class="headerlink" title="4. 资源清理"></a>4. 资源清理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [错误] Sinks 没有正确关闭</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"><span class="comment">// 应用关闭时，sink 还在运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// [正确] 在适当时机关闭</span></span><br><span class="line"><span class="meta">@PreDestroy</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cleanup</span><span class="params">()</span> &#123;</span><br><span class="line">    sink.tryEmitComplete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-线程安全"><a href="#5-线程安全" class="headerlink" title="5. 线程安全"></a>5. 线程安全</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sinks 默认是线程安全的</span></span><br><span class="line">Sinks.Many&lt;String&gt; sink = Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果确定单线程，可以用 unsafe 版本提升性能</span></span><br><span class="line">Sinks.Many&lt;String&gt; unsafeSink = Sinks.unsafe().many().multicast().onBackpressureBuffer();</span><br><span class="line"><span class="comment">// [注意] 多线程下使用 unsafe 会出问题！</span></span><br></pre></td></tr></table></figure>

<h3 id="6-避免阻塞"><a href="#6-避免阻塞" class="headerlink" title="6. 避免阻塞"></a>6. 避免阻塞</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [错误] 在响应式流中阻塞</span></span><br><span class="line">flux.map(data -&gt; &#123;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);  <span class="comment">// 阻塞！</span></span><br><span class="line">    <span class="keyword">return</span> process(data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// [正确] 使用 boundedElastic 调度器处理阻塞操作</span></span><br><span class="line">flux.flatMap(data -&gt; </span><br><span class="line">    Mono.fromCallable(() -&gt; blockingProcess(data))</span><br><span class="line">        .subscribeOn(Schedulers.boundedElastic())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="五、最佳实践"><a href="#五、最佳实践" class="headerlink" title="五、最佳实践"></a>五、最佳实践</h2><h3 id="1-操作符链设计"><a href="#1-操作符链设计" class="headerlink" title="1. 操作符链设计"></a>1. 操作符链设计</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [推荐] 清晰的操作符链</span></span><br><span class="line"><span class="keyword">return</span> webClient.get()</span><br><span class="line">    .uri(<span class="string">&quot;/api/users&quot;</span>)</span><br><span class="line">    .retrieve()</span><br><span class="line">    .bodyToFlux(User.class)</span><br><span class="line">    .filter(user -&gt; user.isActive())           <span class="comment">// 1. 先过滤</span></span><br><span class="line">    .map(user -&gt; user.getName())               <span class="comment">// 2. 再转换</span></span><br><span class="line">    .distinct()                                 <span class="comment">// 3. 去重</span></span><br><span class="line">    .take(<span class="number">10</span>)                                   <span class="comment">// 4. 限制数量</span></span><br><span class="line">    .timeout(Duration.ofSeconds(<span class="number">5</span>))            <span class="comment">// 5. 超时控制</span></span><br><span class="line">    .onErrorResume(e -&gt; Flux.empty())          <span class="comment">// 6. 错误处理</span></span><br><span class="line">    .doOnNext(name -&gt; log.debug(<span class="string">&quot;处理: &#123;&#125;&quot;</span>, name))  <span class="comment">// 7. 日志</span></span><br><span class="line">    .subscribeOn(Schedulers.boundedElastic()); <span class="comment">// 8. 调度器</span></span><br></pre></td></tr></table></figure>

<h3 id="2-Sinks-使用规范"><a href="#2-Sinks-使用规范" class="headerlink" title="2. Sinks 使用规范"></a>2. Sinks 使用规范</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EventBus</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// [推荐] 使用 multicast + onBackpressureBuffer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sinks.Many&lt;Event&gt; eventSink = </span><br><span class="line">        Sinks.many().multicast().onBackpressureBuffer();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publish</span><span class="params">(Event event)</span> &#123;</span><br><span class="line">        <span class="comment">// [推荐] 检查发送结果</span></span><br><span class="line">        Sinks.<span class="type">EmitResult</span> <span class="variable">result</span> <span class="operator">=</span> eventSink.tryEmitNext(event);</span><br><span class="line">        <span class="keyword">if</span> (result.isFailure()) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;事件发送失败: &#123;&#125;, 原因: &#123;&#125;&quot;</span>, event, result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Event&gt; <span class="title function_">subscribe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> eventSink.asFlux();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-合并流的错误隔离"><a href="#3-合并流的错误隔离" class="headerlink" title="3. 合并流的错误隔离"></a>3. 合并流的错误隔离</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [推荐] 每个流独立处理错误</span></span><br><span class="line"><span class="keyword">public</span> Flux&lt;Message&gt; <span class="title function_">getMergedStream</span><span class="params">()</span> &#123;</span><br><span class="line">    Flux&lt;Message&gt; stream1 = getStream1()</span><br><span class="line">        .onErrorResume(e -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;stream1 错误&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> Flux.empty();</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    Flux&lt;Message&gt; stream2 = getStream2()</span><br><span class="line">        .onErrorResume(e -&gt; &#123;</span><br><span class="line">            log.error(<span class="string">&quot;stream2 错误&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> Flux.empty();</span><br><span class="line">        &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Flux.merge(stream1, stream2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-日志与监控"><a href="#4-日志与监控" class="headerlink" title="4. 日志与监控"></a>4. 日志与监控</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flux</span><br><span class="line">    .doOnSubscribe(s -&gt; log.info(<span class="string">&quot;开始订阅&quot;</span>))</span><br><span class="line">    .doOnNext(data -&gt; log.debug(<span class="string">&quot;处理数据: &#123;&#125;&quot;</span>, data))</span><br><span class="line">    .doOnError(e -&gt; log.error(<span class="string">&quot;发生错误&quot;</span>, e))</span><br><span class="line">    .doOnComplete(() -&gt; log.info(<span class="string">&quot;处理完成&quot;</span>))</span><br><span class="line">    .doOnCancel(() -&gt; log.warn(<span class="string">&quot;订阅被取消&quot;</span>))</span><br><span class="line">    .doFinally(signal -&gt; &#123;</span><br><span class="line">        <span class="comment">// 记录指标</span></span><br><span class="line">        metrics.recordStreamEnd(signal);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testMergedStream</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 使用 StepVerifier 测试</span></span><br><span class="line">    Flux&lt;String&gt; merged = Flux.merge(</span><br><span class="line">        Flux.just(<span class="string">&quot;A&quot;</span>),</span><br><span class="line">        Flux.just(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    StepVerifier.create(merged)</span><br><span class="line">        .expectNextCount(<span class="number">2</span>)</span><br><span class="line">        .verifyComplete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testWithVirtualTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 测试时间相关的流</span></span><br><span class="line">    StepVerifier.withVirtualTime(() -&gt; </span><br><span class="line">        Flux.interval(Duration.ofSeconds(<span class="number">1</span>)).take(<span class="number">3</span>)</span><br><span class="line">    )</span><br><span class="line">    .thenAwait(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">    .expectNext(<span class="number">0L</span>, <span class="number">1L</span>, <span class="number">2L</span>)</span><br><span class="line">    .verifyComplete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="六、常见问题"><a href="#六、常见问题" class="headerlink" title="六、常见问题"></a>六、常见问题</h2><h3 id="Q1-merge-和-concat-怎么选？"><a href="#Q1-merge-和-concat-怎么选？" class="headerlink" title="Q1: merge 和 concat 怎么选？"></a>Q1: merge 和 concat 怎么选？</h3><ul>
<li><strong>merge</strong>：需要实时混合，不关心顺序</li>
<li><strong>concat</strong>：需要保证顺序，一个完成再处理下一个</li>
</ul>
<h3 id="Q2-为什么我的-Sinks-发送的数据没人收到？"><a href="#Q2-为什么我的-Sinks-发送的数据没人收到？" class="headerlink" title="Q2: 为什么我的 Sinks 发送的数据没人收到？"></a>Q2: 为什么我的 Sinks 发送的数据没人收到？</h3><p>检查：</p>
<ol>
<li>是否有订阅者？（multicast 模式下，没订阅者数据会丢失）</li>
<li>是否在订阅之前就发送了？（热流特性）</li>
<li>考虑使用 <code>replay()</code> 模式</li>
</ol>
<h3 id="Q3-流合并后，一个出错整个都停了？"><a href="#Q3-流合并后，一个出错整个都停了？" class="headerlink" title="Q3: 流合并后，一个出错整个都停了？"></a>Q3: 流合并后，一个出错整个都停了？</h3><p>每个流单独添加错误处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flux.merge(</span><br><span class="line">    stream1.onErrorResume(e -&gt; Flux.empty()),</span><br><span class="line">    stream2.onErrorResume(e -&gt; Flux.empty())</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="Q4-内存一直涨？"><a href="#Q4-内存一直涨？" class="headerlink" title="Q4: 内存一直涨？"></a>Q4: 内存一直涨？</h3><p>检查：</p>
<ol>
<li>是否有无限流没有 <code>take()</code> 限制？</li>
<li>是否背压处理不当？添加 <code>onBackpressureXxx()</code></li>
<li>是否有流没有正确完成？检查 <code>tryEmitComplete()</code></li>
</ol>
<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li>Flux 是管道不是容器</li>
<li>Sinks 详解</li>
<li>Reactor API 参考</li>
<li>WebFlux - Reactor核心API</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">线程池原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" itemprop="url" rel="index"><span itemprop="name">线程池</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="线程池原理"><a href="#线程池原理" class="headerlink" title="线程池原理"></a>线程池原理</h1><h2 id="核心参数（7大参数）"><a href="#核心参数（7大参数）" class="headerlink" title="核心参数（7大参数）"></a>核心参数（7大参数）</h2><p><code>ThreadPoolExecutor</code> 是线程池的核心实现类，其构造函数包含 7 个关键参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="type">int</span> corePoolSize,           // 核心线程数</span></span><br><span class="line"><span class="params">    <span class="type">int</span> maximumPoolSize,        // 最大线程数</span></span><br><span class="line"><span class="params">    <span class="type">long</span> keepAliveTime,         // 空闲线程存活时间</span></span><br><span class="line"><span class="params">    TimeUnit unit,              // 时间单位</span></span><br><span class="line"><span class="params">    BlockingQueue&lt;Runnable&gt; workQueue,  // 任务队列</span></span><br><span class="line"><span class="params">    ThreadFactory threadFactory,        // 线程工厂</span></span><br><span class="line"><span class="params">    RejectedExecutionHandler handler    // 拒绝策略</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>

<h3 id="参数详解"><a href="#参数详解" class="headerlink" title="参数详解"></a>参数详解</h3><table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
<th>建议</th>
</tr>
</thead>
<tbody><tr>
<td><strong>corePoolSize</strong></td>
<td>核心线程数，即使空闲也不会被回收</td>
<td>CPU密集型：N+1，IO密集型：2N 👉详解</td>
</tr>
<tr>
<td><strong>maximumPoolSize</strong></td>
<td>线程池最大线程数</td>
<td>根据业务峰值设置</td>
</tr>
<tr>
<td><strong>keepAliveTime</strong></td>
<td>非核心线程空闲存活时间</td>
<td>一般 60s</td>
</tr>
<tr>
<td><strong>unit</strong></td>
<td>keepAliveTime 的时间单位</td>
<td>TimeUnit.SECONDS</td>
</tr>
<tr>
<td><strong>workQueue</strong></td>
<td>任务等待队列</td>
<td>有界队列更安全</td>
</tr>
<tr>
<td><strong>threadFactory</strong></td>
<td>创建线程的工厂，可自定义线程名</td>
<td>建议自定义便于排查</td>
</tr>
<tr>
<td><strong>handler</strong></td>
<td>队列满且线程数达到最大时的拒绝策略</td>
<td>根据业务选择</td>
</tr>
</tbody></table>
<hr>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">      ┌─────────────────┐</span><br><span class="line">      │   提交任务       │</span><br><span class="line">      └────────┬────────┘</span><br><span class="line">               │</span><br><span class="line">               ▼</span><br><span class="line">┌──────────────────────────────┐</span><br><span class="line">│  核心线程数 &lt; corePoolSize?   │</span><br><span class="line">└──────────────┬───────────────┘</span><br><span class="line">      YES │          │ NO</span><br><span class="line">          ▼          ▼</span><br><span class="line">┌─────────────┐  ┌─────────────────┐</span><br><span class="line">│ 创建核心线程 │  │ 任务队列未满?    │</span><br><span class="line">│ 执行任务     │  └────────┬────────┘</span><br><span class="line">└─────────────┘      YES │     │ NO</span><br><span class="line">                        ▼     ▼</span><br><span class="line">                ┌─────────┐ ┌──────────────────┐</span><br><span class="line">                │ 入队等待 │ │ 线程数 &lt; maxSize? │</span><br><span class="line">                └─────────┘ └────────┬─────────┘</span><br><span class="line">                              YES │      │ NO</span><br><span class="line">                                  ▼      ▼</span><br><span class="line">                          ┌─────────┐ ┌─────────┐</span><br><span class="line">                          │创建非核心│ │ 拒绝策略 │</span><br><span class="line">                          │线程执行  │ └─────────┘</span><br><span class="line">                          └─────────┘</span><br></pre></td></tr></table></figure>

<h3 id="流程总结"><a href="#流程总结" class="headerlink" title="流程总结"></a>流程总结</h3><ol>
<li><strong>核心线程优先</strong>：任务来了先看核心线程是否已满</li>
<li><strong>队列缓冲</strong>：核心线程满了，任务进入队列等待</li>
<li><strong>扩容线程</strong>：队列满了，创建非核心线程处理 👉详解 ^expand-thread</li>
<li><strong>拒绝任务</strong>：线程数达到最大且队列满，执行拒绝策略</li>
</ol>
<blockquote>
<p><strong>注意</strong>：不是先扩容线程再入队，而是<strong>先入队再扩容</strong>！</p>
</blockquote>
<hr>
<h2 id="任务队列类型"><a href="#任务队列类型" class="headerlink" title="任务队列类型"></a>任务队列类型</h2><table>
<thead>
<tr>
<th>队列类型</th>
<th>特点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ArrayBlockingQueue</strong></td>
<td>有界数组队列，FIFO</td>
<td>控制资源消耗，推荐使用</td>
</tr>
<tr>
<td><strong>LinkedBlockingQueue</strong></td>
<td>可选有界链表队列，默认无界</td>
<td>任务量可控时使用</td>
</tr>
<tr>
<td><strong>SynchronousQueue</strong></td>
<td>不存储元素，直接传递</td>
<td>CachedThreadPool 使用</td>
</tr>
<tr>
<td><strong>PriorityBlockingQueue</strong></td>
<td>优先级队列，无界</td>
<td>需要任务优先级时</td>
</tr>
<tr>
<td><strong>DelayQueue</strong></td>
<td>延迟队列</td>
<td>定时任务场景</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐：使用有界队列</span></span><br><span class="line">BlockingQueue&lt;Runnable&gt; queue = <span class="keyword">new</span> <span class="title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="number">100</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="四种拒绝策略"><a href="#四种拒绝策略" class="headerlink" title="四种拒绝策略"></a>四种拒绝策略</h2><p>当任务无法被执行时（队列满 + 线程数达到最大），触发拒绝策略：</p>
<table>
<thead>
<tr>
<th>策略</th>
<th>行为</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td><strong>AbortPolicy</strong></td>
<td>抛出 RejectedExecutionException</td>
<td>默认策略，快速失败</td>
</tr>
<tr>
<td><strong>CallerRunsPolicy</strong></td>
<td>由提交任务的线程执行</td>
<td>不丢弃任务，降级处理</td>
</tr>
<tr>
<td><strong>DiscardPolicy</strong></td>
<td>静默丢弃任务</td>
<td>允许丢失的场景</td>
</tr>
<tr>
<td><strong>DiscardOldestPolicy</strong></td>
<td>丢弃队列最老的任务，重新提交</td>
<td>新任务优先级更高</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义拒绝策略示例</span></span><br><span class="line"><span class="type">RejectedExecutionHandler</span> <span class="variable">customHandler</span> <span class="operator">=</span> (r, executor) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 记录日志</span></span><br><span class="line">    log.warn(<span class="string">&quot;任务被拒绝: &#123;&#125;&quot;</span>, r.toString());</span><br><span class="line">    <span class="comment">// 可选：持久化到数据库/MQ，后续重试</span></span><br><span class="line">    saveToDatabase(r);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="线程池状态（5种状态）"><a href="#线程池状态（5种状态）" class="headerlink" title="线程池状态（5种状态）"></a>线程池状态（5种状态）</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">┌──────────┐</span><br><span class="line">│ RUNNING  │ ← 初始状态，接收新任务，处理队列任务</span><br><span class="line">└────┬─────┘</span><br><span class="line">     │ shutdown()</span><br><span class="line">     ▼</span><br><span class="line">┌──────────┐</span><br><span class="line">│ SHUTDOWN │ ← 不接收新任务，继续处理队列任务</span><br><span class="line">└────┬─────┘</span><br><span class="line">     │ 队列为空 &amp;&amp; 工作线程为0</span><br><span class="line">     ▼</span><br><span class="line">┌──────────┐</span><br><span class="line">│ TIDYING  │ ← 所有任务终止，工作线程为0</span><br><span class="line">└────┬─────┘</span><br><span class="line">     │ terminated() 执行完成</span><br><span class="line">     ▼</span><br><span class="line">┌──────────────┐</span><br><span class="line">│ TERMINATED   │ ← 线程池彻底终止</span><br><span class="line">└──────────────┘</span><br><span class="line"></span><br><span class="line">┌──────────┐</span><br><span class="line">│ RUNNING  │</span><br><span class="line">└────┬─────┘</span><br><span class="line">     │ shutdownNow()</span><br><span class="line">     ▼</span><br><span class="line">┌──────────┐</span><br><span class="line">│   STOP   │ ← 不接收新任务，中断正在执行的任务，清空队列</span><br><span class="line">└────┬─────┘</span><br><span class="line">     │ 工作线程为0</span><br><span class="line">     ▼</span><br><span class="line">┌──────────┐</span><br><span class="line">│ TIDYING  │</span><br><span class="line">└──────────┘</span><br></pre></td></tr></table></figure>

<h3 id="状态转换方法"><a href="#状态转换方法" class="headerlink" title="状态转换方法"></a>状态转换方法</h3><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>shutdown()</code></td>
<td>温和关闭，等待已提交任务完成</td>
</tr>
<tr>
<td><code>shutdownNow()</code></td>
<td>立即关闭，尝试中断执行中的任务，返回未执行的任务列表</td>
</tr>
<tr>
<td><code>awaitTermination()</code></td>
<td>阻塞等待线程池终止</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优雅关闭线程池</span></span><br><span class="line">executor.shutdown();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!executor.awaitTermination(<span class="number">60</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">        executor.shutdownNow();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    executor.shutdownNow();</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="线程池监控"><a href="#线程池监控" class="headerlink" title="线程池监控"></a>线程池监控</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ThreadPoolExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> (ThreadPoolExecutor) Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监控指标</span></span><br><span class="line">System.out.println(<span class="string">&quot;核心线程数: &quot;</span> + executor.getCorePoolSize());</span><br><span class="line">System.out.println(<span class="string">&quot;最大线程数: &quot;</span> + executor.getMaximumPoolSize());</span><br><span class="line">System.out.println(<span class="string">&quot;当前线程数: &quot;</span> + executor.getPoolSize());</span><br><span class="line">System.out.println(<span class="string">&quot;活跃线程数: &quot;</span> + executor.getActiveCount());</span><br><span class="line">System.out.println(<span class="string">&quot;队列任务数: &quot;</span> + executor.getQueue().size());</span><br><span class="line">System.out.println(<span class="string">&quot;已完成任务: &quot;</span> + executor.getCompletedTaskCount());</span><br><span class="line">System.out.println(<span class="string">&quot;总任务数: &quot;</span> + executor.getTaskCount());</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><strong>上一篇</strong>：01-线程池简介</li>
<li><strong>下一篇</strong>：03-线程池类型</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zmmmmy.github.io/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AE%80%E4%BB%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ZhiMy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zmmmmy's Blog">
      <meta itemprop="description" content="一个来自于 AI+Obsidian 的知识库">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Zmmmmy's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2026/01/10/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%AE%80%E4%BB%8B/" class="post-title-link" itemprop="url">线程池简介</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2026-01-10 00:00:00" itemprop="dateCreated datePublished" datetime="2026-01-10T00:00:00+08:00">2026-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2026-01-22 15:44:14" itemprop="dateModified" datetime="2026-01-22T15:44:14+08:00">2026-01-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">并发编程</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" itemprop="url" rel="index"><span itemprop="name">线程池</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="线程池简介"><a href="#线程池简介" class="headerlink" title="线程池简介"></a>线程池简介</h1><h2 id="什么是线程池"><a href="#什么是线程池" class="headerlink" title="什么是线程池"></a>什么是线程池</h2><p>线程池（Thread Pool）是一种<strong>线程复用</strong>的技术，预先创建一定数量的线程放入池中，当有任务需要执行时，从池中获取空闲线程来执行任务，任务完成后线程不销毁，而是返回池中等待下一个任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最简单的线程池使用示例</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">5</span>);</span><br><span class="line">executor.submit(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;任务执行中...&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">executor.shutdown();</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="为什么需要线程池"><a href="#为什么需要线程池" class="headerlink" title="为什么需要线程池"></a>为什么需要线程池</h2><h3 id="问题：直接创建线程的弊端"><a href="#问题：直接创建线程的弊端" class="headerlink" title="问题：直接创建线程的弊端"></a>问题：直接创建线程的弊端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不推荐：每次任务都创建新线程</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; doTask()).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>问题</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>创建开销大</td>
<td>线程创建需要分配栈内存（默认1MB）、初始化 TCB 等</td>
</tr>
<tr>
<td>销毁开销大</td>
<td>线程销毁需要回收资源、GC 处理</td>
</tr>
<tr>
<td>资源耗尽</td>
<td>无限制创建线程可能导致 OOM 或系统崩溃</td>
</tr>
<tr>
<td>上下文切换</td>
<td>线程过多导致 CPU 频繁切换，性能下降</td>
</tr>
<tr>
<td>难以管理</td>
<td>无法统一监控、调度、限流</td>
</tr>
</tbody></table>
<h3 id="解决：线程池的优势"><a href="#解决：线程池的优势" class="headerlink" title="解决：线程池的优势"></a>解决：线程池的优势</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 推荐：使用线程池复用线程</span></span><br><span class="line"><span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">    executor.submit(() -&gt; doTask());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="线程池的核心优势"><a href="#线程池的核心优势" class="headerlink" title="线程池的核心优势"></a>线程池的核心优势</h2><table>
<thead>
<tr>
<th>优势</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>降低资源消耗</strong></td>
<td>复用线程，避免频繁创建销毁的开销</td>
</tr>
<tr>
<td><strong>提高响应速度</strong></td>
<td>任务到达时无需等待线程创建，直接执行</td>
</tr>
<tr>
<td><strong>提高可管理性</strong></td>
<td>统一分配、调优、监控线程资源</td>
</tr>
<tr>
<td><strong>提供更多功能</strong></td>
<td>定时执行、周期执行、任务队列、拒绝策略等</td>
</tr>
</tbody></table>
<hr>
<h2 id="线程池核心接口"><a href="#线程池核心接口" class="headerlink" title="线程池核心接口"></a>线程池核心接口</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                      Executor                           │</span><br><span class="line">│                   (顶层接口)                             │</span><br><span class="line">│              void execute(Runnable)                     │</span><br><span class="line">└─────────────────────┬───────────────────────────────────┘</span><br><span class="line">                      │</span><br><span class="line">                      ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│                  ExecutorService                        │</span><br><span class="line">│                 (扩展生命周期管理)                        │</span><br><span class="line">│     submit() / shutdown() / invokeAll() / ...          │</span><br><span class="line">└─────────────────────┬───────────────────────────────────┘</span><br><span class="line">                      │</span><br><span class="line">                      ▼</span><br><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│              ThreadPoolExecutor                         │</span><br><span class="line">│                (核心实现类)                              │</span><br><span class="line">│         7大参数 / 4种拒绝策略 / 5种状态                   │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="快速入门示例"><a href="#快速入门示例" class="headerlink" title="快速入门示例"></a>快速入门示例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建线程池</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">3</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 提交任务</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">int</span> <span class="variable">taskId</span> <span class="operator">=</span> i;</span><br><span class="line">            executor.submit(() -&gt; &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;任务&quot;</span> + taskId + <span class="string">&quot; 由 &quot;</span> + </span><br><span class="line">                    Thread.currentThread().getName() + <span class="string">&quot; 执行&quot;</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 关闭线程池</span></span><br><span class="line">        executor.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>输出示例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">任务1 由 pool-1-thread-1 执行</span><br><span class="line">任务2 由 pool-1-thread-2 执行</span><br><span class="line">任务3 由 pool-1-thread-3 执行</span><br><span class="line">任务4 由 pool-1-thread-1 执行  ← 线程复用</span><br><span class="line">任务5 由 pool-1-thread-2 执行  ← 线程复用</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul>
<li><strong>下一篇</strong>：02-线程池原理</li>
<li><strong>线程池类型</strong>：03-线程池类型</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">ZhiMy</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

<style>
.theme-toggle {
  position: fixed;
  right: 20px;
  bottom: 100px;
  z-index: 9999;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  transition: all 0.3s ease;
  background: var(--content-bg-color);
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}
.theme-toggle:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}
.theme-toggle .icon-sun,
.theme-toggle .icon-moon {
  position: absolute;
  transition: opacity 0.3s ease, transform 0.3s ease;
}
[data-theme="dark"] .theme-toggle .icon-sun {
  opacity: 1;
  transform: rotate(0deg);
}
[data-theme="dark"] .theme-toggle .icon-moon {
  opacity: 0;
  transform: rotate(-90deg);
}
[data-theme="light"] .theme-toggle .icon-sun {
  opacity: 0;
  transform: rotate(90deg);
}
[data-theme="light"] .theme-toggle .icon-moon {
  opacity: 1;
  transform: rotate(0deg);
}
/* 默认状态（跟随系统） */
.theme-toggle .icon-sun {
  opacity: 0;
}
.theme-toggle .icon-moon {
  opacity: 1;
}
@media (prefers-color-scheme: dark) {
  :root:not([data-theme="light"]) .theme-toggle .icon-sun {
    opacity: 1;
    transform: rotate(0deg);
  }
  :root:not([data-theme="light"]) .theme-toggle .icon-moon {
    opacity: 0;
    transform: rotate(-90deg);
  }
}
</style>

<button class="theme-toggle" id="theme-toggle" aria-label="切换明暗模式">
  <span class="icon-sun">☀️</span>
  <span class="icon-moon">🌙</span>
</button>

<script>
(function() {
  const toggle = document.getElementById('theme-toggle');
  const root = document.documentElement;

  // 获取保存的主题或系统偏好
  function getPreferredTheme() {
    const saved = localStorage.getItem('theme');
    if (saved) return saved;
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  // 应用主题
  function applyTheme(theme) {
    root.setAttribute('data-theme', theme);
    root.style.colorScheme = theme;
  }

  // 初始化
  const currentTheme = localStorage.getItem('theme');
  if (currentTheme) {
    applyTheme(currentTheme);
  }

  // 切换主题
  toggle.addEventListener('click', function() {
    const current = root.getAttribute('data-theme') || getPreferredTheme();
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem('theme', next);
  });

  // 监听系统主题变化（仅在用户未手动设置时生效）
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!localStorage.getItem('theme')) {
      applyTheme(e.matches ? 'dark' : 'light');
    }
  });
})();
</script>

</body>
</html>
